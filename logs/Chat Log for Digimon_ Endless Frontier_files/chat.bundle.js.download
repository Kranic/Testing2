/******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/******/ 	var __webpack_modules__ = ({

/***/ "./setupDarkMode.js":
/*!**************************!*\
  !*** ./setupDarkMode.js ***!
  \**************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "setupDarkMode": () => (/* binding */ setupDarkMode),
/* harmony export */   "createDarkModeCSS": () => (/* binding */ createDarkModeCSS)
/* harmony export */ });
// Dark Mode Stylesheet
function createDarkModeCSS() {
	const css = document.createElement('link');
	css.rel = 'stylesheet';
	css.href = '/assets/editorDarkMode.css';
	css.id = 'theme-link';
	return css;
}

// Dark Mode switch
const darkModeToggle = document.querySelector('#dark-mode-switch');
const darkModeLocalStorageValue = window.localStorage.getItem('colorTheme');
function getDarkModeToggleState() {
	return darkModeToggle.checked;
}

/**
 * Send color theme choice to Google Analytics
 */
function reportColorTheme() {
	ga('send', {
		hitType: 'event',
		eventCategory: 'VTT',
		eventAction: getDarkModeToggleState() ? 'Dark' : 'Light',
		eventLabel: 'UI-Theme',
	});
}

function fireSprigEvent() {
	try {
		Sprig('track', 'Dark Mode');
	} catch (err) {
		window.DD_RUM?.addError(err);
	}
}

function createShepherdTour() {
	// Popup messaging
	const darkModetour = new Shepherd.Tour({
		defaultStepOptions: {
			cancelIcon: {
				enabled: true,
			},
			classes: 'roll20-darkmode-step',
		},
	});
	darkModetour.addStep({
		title: i18n('dark_mode_popup_title'),
		text: i18n('dark_mode_popup_desc'),
		attachTo: {
			element: '.dark-mode-switch',
			on: 'right',
		},
		buttons: [
			{
				action() {
					const theme = getDarkModeToggleState() ? 'dark' : 'light';
					window.localStorage.setItem('colorTheme', theme);
					return this.cancel();
				},
				classes: 'shepherd-button-secondary',
				text: 'Dismiss',
			},
		],
		popperOptions: {
			modifiers: [{ name: 'offset', options: { offset: [0, 20] } }],
		},
		id: 'darkModeModal',
	});

	return darkModetour;
}

// Initializes the localStorage value and enables the switch
function setupDarkMode() {
	if (localStorage.getItem('colorTheme') === null) {
		createShepherdTour().start();
	}
	// If there is a value in local storage then use that
	if (darkModeLocalStorageValue) {
		darkModeToggle.checked = darkModeLocalStorageValue === 'dark';
	} else { // otherwise, use a media query to check the browser preference
		const darkModePreferred = window.matchMedia('(prefers-color-scheme: dark)').matches;
		darkModeToggle.checked = darkModePreferred;
	}

	if (getDarkModeToggleState()) {
		document.body.append(createDarkModeCSS());
		document.querySelector('.dark-mode-switch .tooltiptext').innerHTML = i18n('dark_mode_disable');
	}

	darkModeToggle.disabled = false;

	// If the user manually toggles the switch, then save their preference to local storage
	darkModeToggle.addEventListener('change', () => {
		const theme = getDarkModeToggleState() ? 'dark' : 'light';
		window.localStorage.setItem('colorTheme', theme);

		const themeCSS = document.querySelector('#theme-link');
		if (themeCSS) {
			if (themeCSS.getAttribute('href') === '') {
				themeCSS.href = '/assets/editorDarkMode.css';
			} else {
				themeCSS.href = '';
			}
		} else {
			document.body.append(createDarkModeCSS());
		}

		if (theme === 'dark') {
			document.querySelector('.dark-mode-switch .tooltiptext').innerHTML = i18n('dark_mode_disable');
			if($('iframe')){
				$('iframe').contents().find('body').attr('class','sheet-darkmode');
				$('#textchat').addClass('sheet-darkmode');
				$('#textchat [class^="sheet-rolltemplate-"]').addClass('sheet-rolltemplate-darkmode');
			}

		} else {
			document.querySelector('.dark-mode-switch .tooltiptext').innerHTML = i18n('dark_mode_enable');
			if($('iframe')){
				$('iframe').contents().find('body').attr('class','');
				$('#textchat').removeClass('sheet-darkmode');
				$('#textchat .sheet-rolltemplate-darkmode').removeClass('sheet-rolltemplate-darkmode');
			}
		}
	});

	reportColorTheme();
	if (getDarkModeToggleState()) {
		fireSprigEvent();
	}
}




/***/ }),

/***/ "./util/Matrix.js":
/*!************************!*\
  !*** ./util/Matrix.js ***!
  \************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "default": () => (/* binding */ Matrix)
/* harmony export */ });
/* harmony import */ var _math__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./math */ "./util/math.js");


class Matrix {
	/**
	 * @constructs
	 * @param {Array<number>} amounts - Factor to scale by in each direction.
	 * @returns {Matrix} Scaling matrix
	 */
	static scale(amounts) {
		const len = amounts.length;
		const m = Matrix.identity(len);
		for(let i = 0; i < len; ++i) {
			m.data[i * len + i] = amounts[i];
		}
		return m;
	}

	/**
	 * @constructs
	 * @param {Array<number>} amounts - Factor to translate by in each direction.
	 * @returns {Matrix} Translation matrix
	 */
	static translate(amounts) {
		const len = amounts.length + 1;
		const m = Matrix.identity(len);
		for(let i = 1; i < len; ++i) {
			m.data[i * len - 1] = amounts[i - 1];
		}
		return m;
	}

	/**
	 * @constructs
	 * @param {number} radians - Amount by which to rotate
	 * @param {number} [final_dimensionality = 2] - The dimension of the final matrix
	 * @returns {Matrix} Rotation matrix
	 */
	static rotate2D(radians, final_dimensionality = 2) {
		const sin = Math.sin(radians), cos = Math.cos(radians);
		const out = this.identity(final_dimensionality);
		out.data[0] = cos;
		out.data[1] = -sin;
		out.data[final_dimensionality] = sin;
		out.data[final_dimensionality + 1] = cos;
		return out;
	}

	/**
	 * @constructs
	 * @param {number} size - Dimension of the matrix in both directions.
	 * @returns {Matrix} Identity matrix
	 */
	static identity(size) {
		const data = new Array(size * size).fill(0);
		for(let i = 0; i < size; ++i) {
			data[i * size + i] = 1;
		}
		return new Matrix(data, size, size);
	}

	/**
	 * @constructs
	 * @param {Array<Number>} data - Elements of the matrix, in row-major order.
	 * @param {Number} m - Number of rows.
	 * @param {Number} n - Number of columns.
	 */
	constructor(data, m, n) {
		this.m = this.rows = m;
		this.n = this.cols = n;
		this.data = Object.assign([], data);
	}

	/**
	 * @returns {Matrix} A clone of this Matrix.
	 */
	clone() {
		return new this.constructor(this.data, this.m, this.n);
	}

	/**
	 * @return {Array<Array<Number>>} List of rows.
	 */
	getRows() {
		let r = new Array(this.rows);
		let i = 0;
		while(i < this.cols) {
			r[i] = this.data.slice(i * this.cols, ++i * this.cols);
		}
		return r;
	}

	/**
	 * @return {Array<Array<Number>>} List of columns
	 */
	getCols(){
		let r = new Array(this.cols);
		for(let i = 0; i < this.cols; ++i) {
			r[i] = new Array(this.rows);
			for(let j = 0; j < this.rows; ++j) {
				r[i][j] = this.data[j * this.cols + i];
			}
		}
		return r;
	}

	/**
	 * @return {Matrix} Transposed copy of this matrix.
	 */
	transpose() {
		return new Matrix(_.flatten(this.getCols()), this.cols, this.rows);
	}

	/**
	 * Multiply this matrix with another matrix or vector.
	 * @param {(Matrix | Array<Number>)} mat - Matrix or vector with which to multiply.
	 * @return {(Matrix | Array<Number>)} Result matrix or vector.
	 */
	mul(mat) {
		if(this.cols === mat.rows) { // mat is another matrix
			let self = this.getRows();
			let other = mat.getCols();
			let r = new Array(this.rows * mat.cols);
			for(let i = 0; i < this.rows; ++i) {
				for(let j = 0; j < mat.cols; ++j) {
					r[i * mat.cols + j] = (0,_math__WEBPACK_IMPORTED_MODULE_0__.dot)(self[i], other[j]);
				}
			}
			return new Matrix(r, mat.cols, this.rows);
		}
		else if(this.cols === mat.length) { // mat is a vector
			let self = this.getRows();
			let r = new Array(this.rows);
			for(let i = 0; i < this.rows; ++i) {
				r[i] = (0,_math__WEBPACK_IMPORTED_MODULE_0__.dot)(self[i], mat);
			}
			return r;
		}
		else if(this.rows === mat.length) { // mat is a vector
			let self = this.getCols();
			let r = new Array(this.cols);
			for(let i = 0; i < this.cols; ++i) {
				r[i] = (0,_math__WEBPACK_IMPORTED_MODULE_0__.dot)(self[i], mat);
			}
			return r;
		}
		else {
			return NaN;
		}
	}

	/**
	 * Create a new matrix of a different size which maintains the data from this Matrix.
	 * @param {number} m - Number of rows
	 * @param {number} n - Number of columns
	 * @returns The new Matrix
	 */
	resize(m, n) {			
		let new_data = this.getRows();
		new_data.splice(m, this.m - m, ...new Array(Math.max(m - this.m, 0)).fill(null));
		new_data = _.chain(new_data)
			.map(r => r === null ? new Array(n).fill(0) : r)
			.each(r => r.splice(n, r.length - n, ...new Array(Math.max(n - r.length, 0)).fill(0)))
			.value();

		return new this.constructor(new_data, m, n);
	}

	/**
	 * @returns {Float32Array} The values of this matrix in row-major order converted to a Float32Array.
	 */
	toFloat32Array() {
		return new Float32Array(this.data);
	}
}

/***/ }),

/***/ "./util/Observable.js":
/*!****************************!*\
  !*** ./util/Observable.js ***!
  \****************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "default": () => (/* binding */ Observable)
/* harmony export */ });
/**
 * @classdesc A class which can be listened to for events.
 */
class Observable {
	/**
	 * @constructor
	 */
	constructor() {
		this.observers = new Map();
	}

	/**
	 * Add an event listener
	 * @param {*} event - The event for which to listen
	 * @param {Function} callback - What to do when the event fires
	 * @returns {Symbol} A reference for detaching this observer
	 */
	on(event, callback) {
		const ref = Symbol();
		let eventMap = this.observers.get(event);

		if (!eventMap) {
			eventMap = new Map();
			this.observers.set(event, eventMap);
		}
		eventMap.set(ref, callback);
		return ref;
	}

	/**
	 * Remove an event listener
	 * @param {*} event - The event which the listener is observing
	 * @param {Symbol} ref - The Symbol returned from on()
	 */
	off(event, ref) {
		const eventMap = this.observers.get(event);
		if (eventMap) {
			return eventMap.delete(ref);
		}
		return false;
	}

	/**
	 * Clear all observers from the specified events.
	 * If no events are given, then all observers are cleared from all events.
	 * @param {Iterable<any>} [events] - Events from which observers should be cleared
	 */
	clearEventObservers(events = null) {
		if (events === null) {
			this.observers = new Map();
		} else {
			for (const e of events) {
				this.observers.delete(e);
			}
		}
	}

	/**
	 * Trigger an event
	 * @param {*} event - Which event?
	 * @param  {...any} args - Argument list to be passed to observers
	 */
	trigger(event, ...args) {
		let iterable;
		try {
			iterable = this.observers.get(event).values();
		} catch (e) {
			return;
		}

		for (const callback of iterable) {
			callback(...args);
		}
	}
}


/***/ }),

/***/ "./util/Rectangle.js":
/*!***************************!*\
  !*** ./util/Rectangle.js ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "default": () => (/* binding */ Rectangle)
/* harmony export */ });
/* harmony import */ var _math__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./math */ "./util/math.js");
/* harmony import */ var _Matrix__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./Matrix */ "./util/Matrix.js");



class Rectangle {
	/**
	 * @constructs
	 * @param {Number} x - X coordinate of midpoint.
	 * @param {Number} y - Y coordinate of midpoint.
	 * @param {Number} w - Width of rectangle.
	 * @param {Number} h - Height of rectangle.
	 * @param {Number} theta - Angle of rotation, in radians.
	 */
	constructor(x, y, w, h, theta) {
		this.midpoint = [x, y];
		this.width = w;
		this.height = h;
		this.theta = theta % (Math.PI * 2);

		// Set points to be an offset from the midpoint, in case we need to rotate them
		const half_h = h * 0.5, half_w = w * 0.5;
		this.points = [
			[-half_w, -half_h], // Top-left
			[-half_w, half_h], // Bottom-left
			[half_w, half_h], // Bottom-right
			[half_w, -half_h] // Top-right
		];

		if(this.theta !== 0) {
			const sin = Math.sin(theta), cos = Math.cos(theta);

			this.rotation = new _Matrix__WEBPACK_IMPORTED_MODULE_1__["default"]([cos, -sin, sin, cos], 2, 2);
			this.rotation_inverse = this.rotation.transpose();
			this.points = _.map(this.points, p => this.rotation.mul(p));
		}

		// Move points to their absolute positions
		this.points = _.map(this.points, p => (0,_math__WEBPACK_IMPORTED_MODULE_0__.add)(p, this.midpoint));
	}

	/**
	 * Expand or contract this Rectangle by a given amount in each given direction in local space.
	 * @param {object} magnitudes
	 * @param {number} [magnitudes.left] -x
	 * @param {number} [magnitudes.right] +x
	 * @param {number} [magnitudes.up] -y
	 * @param {number} [magnitudes.down] +y
	 * @return {Rectangle} this
	 * @chainable
	 */
	resize(magnitudes) {
		const left = magnitudes.left || 0, right = magnitudes.right || 0;
		const up = magnitudes.up || 0, down = magnitudes.down || 0;
		let vectors = [
			[-left, 0],
			[right, 0],
			[0, -up],
			[0, down]
		];

		if(this.rotation) {
			vectors = _.map(vectors, v => this.rotation.mul(v));
		}

		this.points[0] = (0,_math__WEBPACK_IMPORTED_MODULE_0__.add)(this.points[0], vectors[0], vectors[2]);
		this.points[1] = (0,_math__WEBPACK_IMPORTED_MODULE_0__.add)(this.points[1], vectors[0], vectors[3]);
		this.points[2] = (0,_math__WEBPACK_IMPORTED_MODULE_0__.add)(this.points[2], vectors[1], vectors[3]);
		this.points[3] = (0,_math__WEBPACK_IMPORTED_MODULE_0__.add)(this.points[3], vectors[1], vectors[2]);

		this.width += left + right;
		this.height += up + down;
		this.midpoint = (0,_math__WEBPACK_IMPORTED_MODULE_0__.div)((0,_math__WEBPACK_IMPORTED_MODULE_0__.sub)(this.points[2], this.points[0]), 2);

		return this;
	}

	/**
	 * Translate this Rectangle by the given vector.
	 * @param {Array<number>} vector - 2 dimensional vector to translate by.
	 * @returns {Rectangle} this
	 * @chainable
	 */
	translate(vector) {
		this.midpoint = (0,_math__WEBPACK_IMPORTED_MODULE_0__.add)(this.midpoint, vector);
		this.points = _.map(this.points, p => (0,_math__WEBPACK_IMPORTED_MODULE_0__.add)(p, vector));
		return this;
	}

	/**
	 * Scale this Rectangle by the given vector in local space.
	 * @param {Array<number>} vector - 2 dimensional vector to scale by.
	 * @returns {Rectangle} this
	 * @chainable
	 */
	scale(vector) {
		const matrix = _Matrix__WEBPACK_IMPORTED_MODULE_1__["default"].scale(vector);
		this.points = _.map(this.points, p =>
			// Translate to origin, scale, translate back
			(0,_math__WEBPACK_IMPORTED_MODULE_0__.add)(
				matrix.mul(
					(0,_math__WEBPACK_IMPORTED_MODULE_0__.sub)(p, this.midpoint)
				),
				this.midpoint
			)
		);
		return this;
	}

	/**
	 * Use Separating Axis Theorem to test intersection.
	 * @param {Rectangle} rect - The rectangle with which to test intersection.
	 * @return {boolean} Whether the two rectangles intersect.
	 */
	rectangleIntersection(rect) {
		// Parallel normals are functionally identical for this algorithm, so only need 2 vectors.
		const get2Normals = (r) => {
			let normals = [
				[1, 0],
				[0, 1]
			];
			if(r.rotation) {
				return _.map(normals, n => r.rotation.mul(n));
			}
			return normals;
		};
		// Get the min and max of the shape projected upon this axis.
		const projectShape = (points, axis) => {
			let min = Number.POSITIVE_INFINITY, max = Number.NEGATIVE_INFINITY;
			for(const p of points) {
				const d = (0,_math__WEBPACK_IMPORTED_MODULE_0__.dot)(p, axis);
				min = Math.min(min, d);
				max = Math.max(max, d);
			}
			return { min: min, max: max };
		}

		const normals = [...get2Normals(this), ...get2Normals(rect)];
		let intersection = true;

		// We know that these shapes intersect if none of the normals are separating axes.
		for(const n of normals) {
			const mine = projectShape(this.points, n), other = projectShape(rect.points, n);
			if(mine.max < other.min || other.max < mine.min){
				// Found a separating axis; no intersection.
				intersection = false;
				break;
			}
		}
		return intersection;
	}
}


/***/ }),

/***/ "./util/math.js":
/*!**********************!*\
  !*** ./util/math.js ***!
  \**********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "add": () => (/* binding */ add),
/* harmony export */   "sub": () => (/* binding */ sub),
/* harmony export */   "mul": () => (/* binding */ mul),
/* harmony export */   "div": () => (/* binding */ div),
/* harmony export */   "dot": () => (/* binding */ dot),
/* harmony export */   "cross": () => (/* binding */ cross),
/* harmony export */   "line_line_intersection": () => (/* binding */ line_line_intersection),
/* harmony export */   "line_segment_intersection": () => (/* binding */ line_segment_intersection),
/* harmony export */   "between": () => (/* binding */ between),
/* harmony export */   "lerp": () => (/* binding */ lerp),
/* harmony export */   "slerp": () => (/* binding */ slerp),
/* harmony export */   "clamp": () => (/* binding */ clamp),
/* harmony export */   "degrees": () => (/* binding */ degrees),
/* harmony export */   "radians": () => (/* binding */ radians),
/* harmony export */   "normalize": () => (/* binding */ normalize),
/* harmony export */   "magnitude": () => (/* binding */ magnitude),
/* harmony export */   "magnitude2": () => (/* binding */ magnitude2)
/* harmony export */ });
/**
 * Add a vector with vectors / scalars
 * @param {Array<number>} vector
 * @param {...(Array<number> | number)} args - Vectors or scalars
 * @returns {Array<number>} Vector result of addition
 */
function add(vector) { // variadic
	const accumulator = _.clone(vector);
	for(let i = 1; i < arguments.length; ++i) {
		if(arguments[i].length) { // vector arg
			for(let j = 0; j < accumulator.length; ++j) {
				accumulator[j] += arguments[i][j];
			}
		}
		else { // scalar arg
			for(let j = 0; j < accumulator.length; ++j) {
				accumulator[j] += arguments[i];
			}
		}
	}
	return accumulator;
}

/**
 * Subtract a vector with vectors / scalars
 * @param {Array<number>} vector
 * @param {...(Array<number> | number)} args - Scalars or vectors
 * @returns {Array<number>} Vector result of subtraction
 */
function sub(vector) { // variadic
	const accumulator = _.clone(vector);
	for(let i = 1; i < arguments.length; ++i) {
		if(arguments[i].length) { // vector arg
			for(let j = 0; j < accumulator.length; ++j) {
				accumulator[j] -= arguments[i][j];
			}
		}
		else { // scalar arg
			for(let j = 0; j < accumulator.length; ++j) {
				accumulator[j] -= arguments[i];
			}
		}

	}
	return accumulator;
}

/**
 * Vector / scalar multiplication
 * @param {Array<number>} vector
 * @param {...number} args - Scalars
 * @returns {Array<number>} Vector result of multiplication
 */
function mul(vector){ // variadic
	const accumulator = _.clone(vector);
	for(let i = 1; i < arguments.length; ++i) {
		for(let j = 0; j < accumulator.length; ++j) {
			accumulator[j] *= arguments[i];
		}
	}
	return accumulator;
}

/**
 * Vector / scalar division
 * @param {Array<number>} vector
 * @param {...number} args - Scalars
 * @returns {Array<number>} Vector result of division
 */
function div(vector){ // variadic
	const accumulator = _.clone(vector);
	for(let i = 1; i < arguments.length; ++i) {
		for(let j = 0; j < accumulator.length; ++j) {
			accumulator[j] /= arguments[i];
		}
	}
	return accumulator;
}

/**
 * Compute the dot product between two vectors.
 * @param {Array<number>} a - First vector
 * @param {Array<number>} b - Second vector
 * @returns {number | NaN} Scalar result of dot product
 */
function dot(a, b) {
	if(!a.length || a.length !== b.length) {
		return NaN;
	}
	let accumulator = 0;
	for(let i = 0; i < a.length; ++i) {
		accumulator += a[i] * b[i];
	}
	return accumulator;
}

/**
 * Compute the cross product between two vector3s
 * 
 * @param {Array<number>} a - First vector3
 * @param {Array<number>} b - Second vector3
 * 
 * @returns {Array<number>} Cross product result
 */
function cross(a, b) {
	const result = new Array(3);
	result[0] = a[1] * b[2] - a[2] * b[1];
	result[1] = a[2] * b[0] - a[0] * b[2];
	result[2] = a[0] * b[1] - a[1] * b[0];
	return result;
}

/**
 * Intersection test between two lines.
 * @param {Array<Array<number>>} l1 - First line
 * @param {Array<Array<number>>} l2 - Second line
 * @return {Array<Array<number>> | NaN} Intersection point, or NaN if the lines are parallel
 */
function line_line_intersection (l1, l2) { // each line is defined by two points
	let determinant2x2 = (a, b, c, d) => a * d - b * c;
	let p1 = { x: l1[0][0], y: l1[0][1] };
	let p2 = { x: l1[1][0], y: l1[1][1] };
	let p3 = { x: l2[0][0], y: l2[0][1] };
	let p4 = { x: l2[1][0], y: l2[1][1] };

	let denominator = determinant2x2(p1.x - p2.x, p1.y - p2.y, p3.x - p4.x, p3.y - p4.y);

	if(denominator === 0) {
		return NaN;
	}
	else {
		let a = determinant2x2(p1.x, p1.y, p2.x, p2.y);
		let c = determinant2x2(p3.x, p3.y, p4.x, p4.y);

		return [
			determinant2x2(a, p1.x - p2.x, c, p3.x - p4.x) / denominator,
			determinant2x2(a, p1.y - p2.y, c, p3.y - p4.y) / denominator
		];
	}
}

/**
 * Intersection test between two line segments on an XY Coordinate Plane.
 * @param {Array<Array<number>>} l1 - First line
 * @param {Array<Array<number>>} l2 - Second line
 * @return {boolean} True if lines intersect, fase otherwise
 */
function line_segment_intersection(l1, l2) { // each line is defined by two points
	// Check if the intersection point is within a rectangle defined by the line's endpoints
	const pointWithinRectangle = (line, point) => {
		let top = Math.floor(Math.min(line[0][1], line[1][1])); // floor/ceil these values to prevent floating point errors
		let bottom = Math.ceil(Math.max(line[0][1], line[1][1]));
		let left = Math.floor(Math.min(line[0][0], line[1][0]));
		let right = Math.ceil(Math.max(line[0][0], line[1][0]));
		return (between(left, right, point[0]) && between(top, bottom, point[1]));
	};

	const intersection = line_line_intersection(l1, l2);

	if(typeof intersection !== "object") { // since the intersection returns NaN if parallel, make sure the result returned is an array
		return false;
	}

	return (pointWithinRectangle(l1, intersection) && pointWithinRectangle(l2, intersection)); // If the point is within the bounding box of both lines, it intersects them
}

/**
 * Check if a number n3 is between two numbers n1 and n2.
 * @param {number} n1 - First number
 * @param {number} n2 - Second number
 * @param {number} n3 - Third number (the one we're checking against the other two)
 * @param {boolean} inclusive - Optional. If set to false, comparison will be > / < rather than >= / <=
 * @return {boolean} True if n3 is between n1 and n2, false otherwise
 */
function between(n1, n2, n3, inclusive = true) {
	const max = Math.max(n1, n2);
	const min = Math.min(n1, n2);

	if(inclusive) {
		return ((n3 <= max) && (n3 >= min));
	} else {
		return ((n3 < max) && (n3 > min));
	}
}

/**
 * Linear interpolation. a and b must both either be scalars or vectors of equal length.
 * @param {number | Array<number>} a - First vector / scalar
 * @param {number | Array<number>} b - Second vector / scalar
 * @param {number} t - Interpolation factor
 * @return {number | Array<number>} Interpolated scalar / vector
 */
function lerp(a, b, t) {
	if(a.length !== b.length) {
		return NaN;
	}
	if(a.length) { // a and b are vectors
		return add(a, mul(sub(b, a), t));
	}
	else { // a and b are scalars
		return a + t * (b - a);
	}
}

/**
 * Spherical linear interpolation
 * @param {Array<number>} a - First vector
 * @param {Array<number>} b - Second vector
 * @param {number} t - Interpolation factor (usually [0, 1])
 * @returns {Array<number>} Vector result
 */
function slerp(a, b, t) {
	if(!a.length > 1 || a.length !== b.length) {
		return NaN;
	}
	const clamped = clamp(dot(normalize(a), normalize(b)), -1, 1);
	const omega = Math.acos(clamped);
	const sin_omega = Math.sin(omega);
	return add(mul(a, Math.sin((1 - t) * omega) / sin_omega), mul(b, Math.sin(t * omega) / sin_omega));
}

/**
 * Clamp a value to a range bounded by min and max (inclusive).
 * @param {number} v - Number to be clamped
 * @param {number} min - Minimum value
 * @param {number} max - Maximum value
 * @return {number} Clamped value
 */
function clamp(v, min, max) {
	return Math.max(min, Math.min(v, max));
}

/**
 * Convert from radians to degrees.
 * @param {number} radians
 * @returns {number} Degrees
 */
function degrees(radians) {
	return radians / Math.PI * 180;
}

/**
 * Convert from degrees to radians.
 * @param {number} degrees
 * @return {number} Radians
 */
function radians(degrees) {
	return degrees / 180 * Math.PI;
}

/**
 * @param {Array<number>} v - Vector
 * @returns {Array<number>} A normalized copy of the vector.
 */
function normalize(v) {
	const mag2 = magnitude2(v);
	return div(v, mag2 === 0 ? Infinity : Math.sqrt(mag2));
}

/**
 * Get the magnitude of this vector. Relatively slow.
 * @param {Array<number>} v - Vector
 * @returns {number} Magnitude
 */
function magnitude(v) {
	return Math.sqrt(dot(v, v));
}

/**
 * Get the squared magnitude of this vector. This is significantly faster than calling magnitude
 * @param {Array<number>} v - Vector
 * @returns {number} Squared magnitude.
 */
function magnitude2(v) {
	return dot(v, v);
}




/***/ }),

/***/ "./util/textchatUtils.js":
/*!*******************************!*\
  !*** ./util/textchatUtils.js ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "formatDiceForSheetworkers": () => (/* binding */ formatDiceForSheetworkers),
/* harmony export */   "getIndexesFromRollString": () => (/* binding */ getIndexesFromRollString),
/* harmony export */   "parseRollData": () => (/* binding */ parseRollData),
/* harmony export */   "createRollPromise": () => (/* binding */ createRollPromise),
/* harmony export */   "addComputedResults": () => (/* binding */ addComputedResults)
/* harmony export */ });
/**
 * Takes an array of rolls from the dice server,
 * simplifies each roll into the format used by sheetworkers
 * @param {Object[]} inlinerolls - An array of rolls from the roll server
 * @returns {Object[]} An array of rolls formatted for use by sheetworkers
 */
const formatDiceForSheetworkers = (inlinerolls) => {
	const rolls = [];

	_.each(inlinerolls, (roll) => {
		// result: the total value of the roll computed by the roll server
		// expression: the original expression for this roll (i.e. '1d20+4')
		// dice: an array of integers for the actual result of each die
		// rolls: additional information about each individual roll, includeing:
		// - dice: number of dice rolled (the '2' in '2d6')
		// - sides: number of sides for this set of dice (the '6' in '2d6')
		// - results: an array of integers for the actual result of each die in this particular roll
		const thisroll = {
			result: roll.results.total,
			dice: [],
			expression: roll.expression,
			rolls: [],
		};
		// Loop through each roll
		_.each(roll.results.rolls, (dice) => {
			// Construct an array of results from this roll
			const rollResults = _.pluck(dice.results, 'v');
			// Add that to our array of all dice results
			thisroll.dice = thisroll.dice.concat(rollResults);
			// Make sure this is actually a roll and not a mathematical operation
			if (rollResults.length > 0 && dice.sides && dice.dice) {
				// If this is actually a roll, add more information to our rolls array
				thisroll.rolls.push({
					sides: dice.sides,
					dice: dice.dice,
					results: rollResults,
				});
			}
		});
		rolls.push(thisroll);
	});

	return rolls;
};

/**
 * Given a roll string with named rolls, returns an object to match roll
 * names with the corresponding index for the location of that roll
 * in the inlinerolls array
 * @param {string} rollString - A roll string from a character sheet,
 * with rolls already replaced with indices
 * @returns {Object} Keys are names of rolls, values are the index
 * location of that roll corresponding to the inlinerolls array
 */
const getIndexesFromRollString = (rollString) => {
	const rollRegex = /{{([\s\S]*?}?)}}/gi;
	const results = {};
	const matches = rollString.match(rollRegex);

	if (!matches) return {};

	matches.forEach((roll) => {
		// valid matches will look like "{{roll1=$[[1]]}}"
		// Attempt to match the roll name on the left side of the string
		const name = roll.match(/{{(.*)=/);
		// Attempt to match the roll index on the right side of the string
		const index = roll.match(/\$\[\[(.*)\]\]/);
		// If both match, use the capture group from each match
		// eslint-disable-next-line prefer-destructuring
		if (name && index) results[name[1]] = index[1];
	});
	return results;
};

/**
 * Takes the array of inlinerolls from the chat operation object, formats them into the simplified
 * sheetworker roll format, and returns them in an object with the roll names as they keys
 * @param {ChatOperation} chatOp - Chat operation object of the roll to be modified
 * @returns {Object} Keys are names of rolls, values are formated roll results
 */
const parseRollData = (chatOp) => {
	const results = {};
	// Get the array of formatted dice rolls
	const rollArray = formatDiceForSheetworkers(chatOp.inlinerolls);
	// Get an object to match elements in that array to the roll name
	const namesWithIndexes = getIndexesFromRollString(chatOp.content);
	// eslint-disable-next-line guard-for-in
	for (const name in namesWithIndexes) {
		results[name] = rollArray[namesWithIndexes[name]];
	}
	return results;
};

/**
 * Adds a new promise to pendingRollPromises that can be resolved via
 * the finishRoll sheetworker function
 * @param {Object} pendingRollPromises - Our object for organizing all pendingRollPromises
 * @param {string} promiseId - The unique id for this promise
 * @returns {Object} An object containing the promise, resolve function, and the promise id
 */
const createRollPromise = (pendingRollPromises, promiseId) => {
	// Keeps track of roll promises, so that they can be resolved later
	// When the sheetworker calls the finish roll function
	const result = {
		// Flag to determine if we need to reject the promise after the timeout
		resolved: false,
		promiseId,
	};
	result.promise = new Promise((resolve, reject) => {
		// Save a reference to the resolve function so that it can be resolved externally
		result.resolve = resolve;

		// After 5 seconds, if we haven't gotten a response from the sheetworker,
		// Reject this promise and display our error message
		setTimeout(() => {
			if (!result.resolved) reject();
			// Clean up, we're done with this promise
			// eslint-disable-next-line no-param-reassign
			delete pendingRollPromises[promiseId];
		}, 5000);
	});

	// eslint-disable-next-line no-param-reassign
	pendingRollPromises[promiseId] = result;

	return pendingRollPromises[promiseId];
};

/**
 * Adds computed results from sheetworker to actual results from roll server
 * @param {ChatOperation} chatOp - Chat operation object of the roll to be modified
 * @param {Object} computedResults - Keys are names of rolls,
 * Values are the corresponding computed string value
 * @param {Function} stripTags - The strip tags sanitization function from d20.utils
 */
const addComputedResults = (chatOp, computedResults, stripTags) => {
	const rollIndexes = getIndexesFromRollString(chatOp.content);
	// eslint-disable-next-line guard-for-in
	for (const roll in rollIndexes) {
		const index = rollIndexes[roll];
		if (chatOp.inlinerolls[index] && computedResults[roll] !== undefined) {
			// Adding the computed result as a new field to the inline roll
			// As long as we don't change the 'results' field, the roll
			// will still be correctly signed
			// Stringify the result and send it through the sanitization function,
			// To make sure there isn't any disallowed js/html
			// eslint-disable-next-line no-param-reassign
			chatOp.inlinerolls[index].computed = stripTags(`${computedResults[roll]}`);
		}
	}
};




/***/ })

/******/ 	});
/************************************************************************/
/******/ 	// The module cache
/******/ 	var __webpack_module_cache__ = {};
/******/ 	
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/ 		// Check if module is in cache
/******/ 		var cachedModule = __webpack_module_cache__[moduleId];
/******/ 		if (cachedModule !== undefined) {
/******/ 			return cachedModule.exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = __webpack_module_cache__[moduleId] = {
/******/ 			// no module.id needed
/******/ 			// no module.loaded needed
/******/ 			exports: {}
/******/ 		};
/******/ 	
/******/ 		// Execute the module function
/******/ 		__webpack_modules__[moduleId](module, module.exports, __webpack_require__);
/******/ 	
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/ 	
/************************************************************************/
/******/ 	/* webpack/runtime/define property getters */
/******/ 	(() => {
/******/ 		// define getter functions for harmony exports
/******/ 		__webpack_require__.d = (exports, definition) => {
/******/ 			for(var key in definition) {
/******/ 				if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {
/******/ 					Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });
/******/ 				}
/******/ 			}
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/hasOwnProperty shorthand */
/******/ 	(() => {
/******/ 		__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/make namespace object */
/******/ 	(() => {
/******/ 		// define __esModule on exports
/******/ 		__webpack_require__.r = (exports) => {
/******/ 			if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 				Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 			}
/******/ 			Object.defineProperty(exports, '__esModule', { value: true });
/******/ 		};
/******/ 	})();
/******/ 	
/************************************************************************/
var __webpack_exports__ = {};
// This entry need to be wrapped in an IIFE because it need to be isolated against other modules in the chunk.
(() => {
/*!**************************!*\
  !*** ./chat.compiled.js ***!
  \**************************/
__webpack_require__.r(__webpack_exports__);
/* harmony import */ var _util_Observable__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./util/Observable */ "./util/Observable.js");
/* harmony import */ var _util_math__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./util/math */ "./util/math.js");
/* harmony import */ var _util_Matrix__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./util/Matrix */ "./util/Matrix.js");
/* harmony import */ var _util_Rectangle__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./util/Rectangle */ "./util/Rectangle.js");
/* harmony import */ var _util_textchatUtils__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./util/textchatUtils */ "./util/textchatUtils.js");
/* harmony import */ var _setupDarkMode__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./setupDarkMode */ "./setupDarkMode.js");
/* eslint-disable no-undef */





d20.utils = {
	SVG: {},
	stattracker: {},
	_hex_color_regex: /^#[0-9a-f]{6}$/i,
	_video_url_regex: /[\w\-]+\.webm/i,
	isVideo: url => d20.utils._video_url_regex.test(url),

	/**
	 * Capturing groups: 1: "dead", 2: hex color, 3: number to overlay
	 * @constant
	 * @private
	 */
	_status_regex: /^(?:(dead)|([^@]+)(?:@(\d))?)$/,

	/**
	 * @typedef StatusHash
	 * @type {object}
	 * @property {?string} dead - "dead" if the status type is dead.
	 * @property {?string} color - If the status is for a color, then this will be its hex code.
	 * @property {?number} icon - If the status is for an icon, then this will be its sheet index.
	 * @property {?string} number - String containing a single digit to be overlayed on top of the status icon/color.
	 */
	/**
	 * Get information about what this status name means.
	 * @param {string} status
	 * @return {StatusHash} Rendering data for this status.
	 */
	parseStatus: status => {
		const results = d20.utils._status_regex.exec(status);
		const status_hash = {
			dead: (results && results[1]) || null, // results[1] if defined, else null
			icon: null,
			color: null,
			number: (results && results[3]) || null // results[3] if defined, else null
		};
		if (results && results[2] && results[2] !== 'dead') {
			if (_.keys(d20.token_editor.colorMarkers).includes(results[2])) {
				status_hash.color = d20.token_editor.colorMarkers[results[2]];
			} else {
				const image = _.find(token_marker_array, (marker) => { return marker.tag === results[2] });
				if (!image) return false;
				status_hash.icon = image.id;
			}
		}
		return results && status_hash;
	},

	getCorrectStatusName: status => {
		try {
			const results = d20.utils._status_regex.exec(status);
			if (_.keys(d20.token_editor.colorMarkers).includes(results[2])) {
				return status;
			}

			const tokenMarkerId = results[2] ? parseInt(_.last(results[2].split('::'))) : results[0];
			const marker = _.find(token_marker_array, (marker) => { return marker.id === tokenMarkerId });
			if (marker) {
				let correctName = marker.tag;
				if (results[3]) {
					correctName += `@${results[3]}`;
				}
				return correctName;
			}
			return status;
		} catch (e) {
			console.error(e);
			return status;
		}
	},
	Observable: _util_Observable__WEBPACK_IMPORTED_MODULE_0__["default"],
};

window["d20ext"] = window["d20ext"] || {};
window["d20ext"]["utils"] = d20.utils;

String.prototype.tranSub = function() {
	var oArguments = arguments;
	return this.replace(/{{[0-9]+}}/g, function(s) {
		return oArguments[parseInt(s.substring(2, s.length - 2))];
	});
};

d20.math = {
	..._util_math__WEBPACK_IMPORTED_MODULE_1__,
	Matrix: _util_Matrix__WEBPACK_IMPORTED_MODULE_2__["default"],
	Rectangle: _util_Rectangle__WEBPACK_IMPORTED_MODULE_3__["default"],
};

(function() {
	if (typeof JS_TRANSLATIONS !== 'undefined') {
		i18n.translator.add({
			values: JS_TRANSLATIONS
		});
	}
	var i18nOutputJSON = {};
	d20.utils.htmlTranslator = function($html, doDynamic) {
		if ($html === '') return '';
		if (typeof doDynamic === 'undefined') doDynamic = false;

		var returnType = 'jQuery';
		// creates jQuery obj if not already, but returns the type it's given
		if (typeof $html === 'string') {
			returnType = 'string';
			$html = $($html);
		}
		else if (!($html instanceof jQuery)) {
			returnType = 'html';
			$html = $($html);
		}
		var attributes = '[data-i18n],[data-i18n-placeholder],[data-i18n-title],[data-i18n-alt],[data-i18n-aria-label],[data-i18n-label]';
		if (doDynamic) attributes += ',[data-i18n-dynamic]';
		var listValidator = function(listValue) {
			var errorMessage = [];
			if (listValue === 'error') errorMessage.push('Missing list key.');
			if (listValue === '') errorMessage.push('Empty list entry.');

			if (errorMessage.length > 0) {
				return errorMessage.join(' ');
			}
			return false;
		};
		$html.find(attributes).each(function() {
			var $this = $(this);
			var options = ['-placeholder', '-title', '-alt', '-aria-label', '-label', ''];
			if (doDynamic) options.push('-dynamic');

			$.each(options, function() {
				try {
					if (typeof $this.attr('data-i18n' + this) === 'undefined') return;

					var i18nAttr = this !== '' ? this.substr(1) : false;
					var isDynamic = (doDynamic && i18nAttr === 'dynamic');
					var i18nKey = isDynamic ? $this.text() : $this.attr('data-i18n' + this);

					var i18nVars = ($this.attr('data-i18n-vars') || '').split('|');
					// if it is the text of an element we can highlight the text as a missing key with the extra span style, if it's attribute's text that won't work
					var i18nError = (i18nAttr ? '[' + i18nKey + ']' : '<span style="color: red;">[' + i18nKey + ']</span>');
					var i18nText = i18n(i18nKey, i18nError);

					i18nOutputJSON[i18nKey] = (i18nAttr ? $this.attr(i18nAttr) : $this.html());
					i18nText = (i18nVars.length === 0 ? i18nText : i18nText.replace(/{{([0-9]+)}}/g, function(x, $1) {
						// if the var is not defined, keep the match as-is. So it stays out of the way of roll templates as much as possible.
						return i18nVars[$1] ? i18nVars[$1] : '{{' + $1 + '}}';
					}));

					if (!i18nAttr || isDynamic) {
						$this.html(i18nText);
						// You cannot have both data-i18n and data-i18n-dynamic, they are at the end of the list, if either one runs we break out of the loop
						return false;
					}
					else {
						$this.attr(i18nAttr, i18nText);
					}
				}
				catch (e) {
					console.log('Translation Error:', e);
					console.log($this);
				}
			});
		});
		$html.find('[data-i18n-list]').each(function() {
			var $this = $(this);
			var i18nKey = $this.attr('data-i18n-list');
			var listValue = i18n(i18nKey, 'error');
			var listError = listValidator(listValue);

			if (listError) {
				$this.attr('data-i18n-error', listError);
				return;
			}

			var newListOrder = $.map(listValue.split(','), function(number) {
				return $.trim(number);
			});
			var listMax = $this.find('[data-i18n-list-item]').length;
			var $newList = $this.clone();
			var listError = false;

			if ($this.find('[data-i18n-list-item-num]').length > 0) {
				$.each(newListOrder, function(key, number) {
					if ($this.find('[data-i18n-list-item="' + newListOrder[key] + '"]').length === 0) {
						$this.attr('data-i18n-error', 'List does not contain the key: ' + newListOrder[key] + '.');
						listError = true;
						return;
					}
					$newList.find('[data-i18n-list-item-num="' + (key + 1) + '"]').replaceWith($this.find('[data-i18n-list-item="' + number + '"]').clone().removeAttr('data-i18n-list-item-num'));
				});
			}
			else {
				$newList.find('[data-i18n-list-item]').each(function(key) {
					if ($this.find('[data-i18n-list-item="' + newListOrder[key] + '"]').length === 0) {
						$this.attr('data-i18n-error', 'List does not contain the key: ' + newListOrder[key] + '.');
						listError = true;
						return;
					}
					$(this).replaceWith($this.find('[data-i18n-list-item="' + newListOrder[key] + '"]').clone().removeAttr('data-i18n-list-item'));
				});
			}
			if (!listError) {
				$this.replaceWith($newList);
			}
		});
		window.i18nOutput = JSON.stringify(i18nOutputJSON);
		switch (returnType) {
			case 'string':
				return $html.prop('outerHTML');
			case 'html':
				return $html[0];
			default:
				return $html;
		}
	};

	d20.utils.handleURL = function(e) {
		if ($(this).hasClass("lightly")) return;

		if ($(this).parents(".note-editable").length > 0) return;

		var url = $(this).attr("href");
		if (typeof url === "undefined") return false;

		if (url.indexOf("journal.roll20.net") !== -1 || url.indexOf("wiki.roll20.net") !== -1) {
			var type = url.split("/")[3];
			var id = url.split("/")[4];
			var item = d20.Campaign[type + "s"].get(id);
			if (item) {
				var injournals = item.get("inplayerjournals").split(",");
				if (window.is_gm || _.indexOf(injournals, "all") !== -1 || (window.currentPlayer && _.indexOf(injournals, window.currentPlayer.id) !== -1)) {
					if (type == "character" && item.attribs && item.abilities) {
						const charobj = item;
						const charAttribPromises = [];
						if (!charobj?.attribs?.backboneFirebase) {
							charobj.attribs.backboneFirebase = new BackboneFirebase(charobj.attribs);
							charAttribPromises.push(charobj.attribs.backboneFirebase.reference.once('value'));
						}
						if (!charobj?.abilities?.backboneFirebase) {
							charobj.abilities.backboneFirebase = new BackboneFirebase(charobj.abilities);
							charAttribPromises.push(charobj.abilities.backboneFirebase.reference.once('value'));
						}
						Promise.all(charAttribPromises).then(() => {
							item.view.showDialog();
						})
					} else {
						item.view.showDialog();
					}
				}
			}
			$("#existing" + type + "s").find("tr[data-" + type + "id=" + id + "]").trigger("click");

			return false;
		}

		var compendiumURLRegex = /(?:(?:http(?:s?):\/\/(?:app\.)?roll20(?:staging)?\.(?:net|local:5000)\/|^\/?)compendium\/)([^\/]+)\/([^\/#?]+)/i
		var compendiumMatch = url.match(compendiumURLRegex);

		if (compendiumMatch) {
			d20.utils.openCompendiumPage(compendiumMatch[1], compendiumMatch[2]);

			e.stopPropagation();
			e.preventDefault();
			return;
		}

		if (url.indexOf("javascript:") !== -1) {
			return false;
		}

		//Allow us to link to API commands in the format [Button Text](!command)
		if (url.substring(0, 1) === "`") {
			d20.textchat.doChatInput(url.substring(1), 'link_click');
			return false;
		}
		if (url.substring(0, 1) === "!") {
			//API command.
			d20.textchat.doChatInput(url, 'api_link_click');
			//var oldtext = $(this).text();
			//var $othis = $(this);
			//$(this).text("Executed: " + url);
			//setTimeout(function() {
			//  $othis.text(oldtext);
			//}, 1000);
			return false;
		}

		if (url.substring(0, 1) === "~") {
			d20.textchat.doChatInput("%{" + url.substring(1, url.length) + "}", 'link_click');
			return false;
		}

		if (url === undefined || $(this).attr("rel") !== "external" && (url.indexOf("javascript:") !== -1 || url.indexOf("://") === -1)) {
			return;
		}

		e.stopPropagation();
		e.preventDefault();

		var dialog = $('<div class="dialog dialog-danger">' + url + '<br /><br />This link will open up a new window (or tab) to an external site. Just close the new window/tab to return to the editor.</div>');
		dialog.dialog({
			modal: true,
			title: "Confirm External Link",
			buttons: {
				"Continue": function() {
					$(this).dialog("destroy").remove();
					window.open(url);
				},
				"Cancel": function() {
					$(this).dialog("destroy").remove();
				}
			},
			beforeClose: function() {
				$(this).dialog("destroy").remove();
			}
		});
	};

	d20.utils.openCompendiumPage = function(compendiumBookName, compendiumPageName, compendiumPageUniqueName) {
		if (typeof compendiumPageUniqueName === "undefined") compendiumPageUniqueName = null;
		var addressName = compendiumPageName;
		var anchorName = "";
		if(compendiumPageUniqueName) {
			var split = compendiumPageUniqueName.split("#");
			addressName = split[0];
			anchorName = split[1] ? "#" + split[1] : "";
		}
		var maxwidth = 750;
		var maxheight = 800;
		var minheight = $(window).height() - 100;
		if (minheight > maxheight) {
			minheight = maxheight;
		}
		var minwidth = $(window).width() - 50;
		if (minwidth > maxwidth) {
			minwidth = maxwidth;
		}
		var $tempdialog = $("<div class='compendiumpopup'><iframe src=\"" + d20.compendium.compendiumBase + "compendium/" + compendiumBookName + "/" + addressName + "?sharedCompendium=" + campaign_id + anchorName + "\" style='width: 100%; height: calc(100% - 5px);' frameborder='0'></iframe></div>");
		$tempdialog.dialog({
			modal: false,
			title: "<button class='showpopout btn pictos' style='margin-right: 15px;'>|</button>" + compendiumPageName.split(":")[0],
			beforeClose: function() {
				$tempdialog.dialog("destroy").remove();
			},
			width: minwidth + 40,
			height: minheight,
			zIndex: 11000
		});

		var showCompendiumPopout = function() {
			var $prevdialog = $tempdialog;
			var winwidth = 900;
			var winheight = 750;

			winwidth = $prevdialog.width();
			winheight = $prevdialog.height();
			$prevdialog.dialog("close"); //this will totally remove the previous inframe and everything, but we can still re-append it as long as we have a reference to it

			var compendiumChildWindow = window.open("/editor/popout", "Popout" + (compendiumPageUniqueName || compendiumPageName), "menubar=0,location=0,toolbar=0,status=0,scrollbars=1,width=" + winwidth + ",height=" + winheight);
			window.allChildWindows.push(compendiumChildWindow);

			compendiumChildWindow.onload = function() {
				$prevdialog.appendTo(compendiumChildWindow.document.getElementById("containerdiv"));
				$prevdialog.show();
				compendiumChildWindow.document.title = compendiumPageName;
			}
			compendiumChildWindow.onbeforeunload = function() {
				window.allChildWindows = _.without(window.allChildWindows, othis.childWindow)
				compendiumChildWindow = null;
				$prevdialog.html("");
				$prevdialog = null;
			};
		}

		$tempdialog.parent().on("click", ".showpopout", function() {
			showCompendiumPopout();
		});
	};

	d20.utils.playerZoneHeight = function() {
		var initial = $("#playerzone .player").height() + 65;
		if ($("#macrobar").is(":visible")) {
			initial += $("#macrobar").height();
		}
		return initial;
	};

	d20.utils.addImageProxy = (url) => {
		const match = url.toString();
		const noproxy = ['https://s3.amazonaws.com/files.d20.io', 'http://imgsrv.roll20.net', 'https://imgsrv.roll20.net', imgsrv_url, 'https://app.roll20.net', 'https://storage.googleapis.com/char-sheet-app-images-6e101411'];

		for (let i = 0; i < noproxy.length; i++) {
			if (match.substring(0, noproxy[i].length) === noproxy[i]) {
				return match;
			}
		}

		if (/^https?:\/\//.test(match)) {
			return `${imgsrv_url}?src=${escape(match)}`;
		}

		return '';
	};

	d20.utils.strip_tags = function(input, allowed, ignoreadvanced) {
		// Strips HTML and PHP tags from a string
		if (!ignoreadvanced && allowed !== undefined) {
			input = html_sanitize(
				input,
				function(url, objindex, objsecondindx, objinfo) {
					var match = url.toString();

					if (objinfo && objinfo.XML_TAG === "a") {
						return match;
					}

					const noproxy = ["https://s3.amazonaws.com/files.d20.io", "http://imgsrv.roll20.net", "https://imgsrv.roll20.net", imgsrv_url, "https://app.roll20.net", "https://storage.googleapis.com/char-sheet-app-images-6e101411"];

					for(let i=0; i<noproxy.length; i++){
						if(match.substring(0, noproxy[i].length) === noproxy[i]) {
							return match;
						}
					};
					if (/^https?:\/\//.test(match)) {
						return imgsrv_url + "/?src=" + escape(match);
					}
					else {
						return "";
					}
				},
				function(groupid) {
					var classes = groupid.split(" ");
					_.each(classes, function(id, idx) {
						if (id.substring(0, 11) === "userscript-" || id.substring(0, 6) === "sheet-") {
							classes[idx] = id;
						}
						else {
							classes[idx] = "userscript-" + id;
						}
					});
					return classes.join(" ");
				}
			);
			//input = html_sanitize(input, function urlX(url) { if(/^https?:\/\//.test(url)) { return url } }, function idX(id) { return "userscript-" + id });
		}
		allowed = (((allowed || "") + "").toLowerCase().match(/<[a-z][a-z0-9]*>/g) || []).join(''); // making sure the allowed arg is a string containing only tags in lowercase (<a><b><c>)
		var tags = /<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,
			commentsAndPhpTags = /<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;
		return input.replace(commentsAndPhpTags, '').replace(tags, function($0, $1) {
			return allowed.indexOf('<' + $1.toLowerCase() + '>') > -1 ? $0 : '';
		});
		//return input;
	};

	d20.utils.timeout = (ms) => {
		return new Promise(resolve => setTimeout(resolve, ms));
	};

	d20.utils.i18n = (key) => {
		return i18n(key);
	};

	d20.utils.htmlAllowed = "<code><span><div><label><a><br><br /><p><b><i><del><strike><u><img><video><audio><param><blockquote><mark><cite><small><ul><ol><li><hr><dl><dt><dd><sup><sub><big><pre><code><figure><figcaption><strong><em><table><tr><td><th><tbody><thead><tfoot><caption><h1><h2><h3><h4><h5><h6>";

	d20.utils.handleHTMLInput = function(input) {
		return escape(d20.utils.strip_tags(d20.utils.autoLink(input), d20.utils.htmlAllowed));
	};

	d20.utils.handleHTMLOutput = function(input, autolink) {
		return d20.utils.strip_tags(unescape(input), d20.utils.htmlAllowed);
	};

	d20.utils.showOverQuota = function() {
		var $dialog = $("<div><p>We're sorry, but it looks like you've uploaded more than your allotted quota of storage space on Roll20. You can increase your quota by <a href='/account/supporter/?quotainapp' target='_blank'>becoming a Plus user</a> (or upgrading your Plus account if you already have one), or by <a href='http://help.roll20.net/sidebar-art-library/' target='_blank'>deleting items from your Art Library</a>.</div>");
		$dialog.dialog({
			modal: true,
			title: "Quota Exceeded",
			buttons: {
				"Upgrade Account": function() {
					window.open("/account/supporter/?quotainapp");
					$dialog.dialog("destroy");
				},
				"No Thanks": function() {
					$dialog.dialog('destroy');
				}
			},
			beforeClose: function() {
				$dialog.dialog("destroy");
			}
		});
	};

	d20.utils.showBadConvert = function() {
		var $dialog = $("<div><p>There was an error trying to convert the PDF. Be sure you didn't specify an invalid page number. It's also possible the PDF is corrupted or isn't supported by our conversion software.</div>");
		$dialog.dialog({
			modal: true,
			title: "PDF Conversion Error",
			buttons: {
				"Drat!": function() {
					$dialog.dialog('destroy');
				}
			},
			beforeClose: function() {
				$dialog.dialog("destroy");
			}
		});
	};

	d20.utils.setupAvatar = function($el, othis) {
		$el.bind("uploadcomplete", function(e, response) {
			e.stopPropagation();
			if (response == "overquota") {
				d20.utils.showOverQuota();
				return false;
			}

			// var json = JSON.parse(response);
			// if(!json) {
			//     $el.find(".status").html("<div class='alert alert-danger'>Error uploading file. Pleaes try again.</div>");
			//     return;
			// }

			othis.updateModel();
			const responseImageURL =  response.base.replace('/original.', '/med.') + (response.base.indexOf('?') === -1 ? '?' + Math.floor(new Date().getTime() / 1000) : '');
			if ($el.hasClass('card_back')){
				othis.model.save({
					card_back: responseImageURL
				});
			} else if ($el.hasClass('avatar')){
				othis.model.save({
					avatar: responseImageURL
				});
			}
		});

		$el.dndUploader({
			url: "/image_library/newupload",
			method: "POST",
			allowMultiple: false
		});

		$el.bind("removeimage", function() {
			othis.updateModel();
			if ($el.hasClass('card_back')){
				othis.model.save({
					card_back: ""
				});
			} else if ($el.hasClass('avatar')){
				othis.model.save({
					avatar: ""
				});
			}
		});

		//Fixes https://github.com/Roll20/Collab/issues/4
		$el.on("click", ".remove", function() {
			$el.trigger("removeimage");
		})

		$el.droppable({
			drop: function(e, ui) {
				e.originalEvent.dropHandled = true;

				//$this.find(".bar").css("width", "100%");
				$el.trigger("uploadcomplete", [{
					base: ui.draggable.attr("data-fullsizeurl")
				}, true]);

				e.preventDefault();
				e.stopPropagation();
			},
			hoverClass: "drop-highlight",
			tolerance: "touch",
			greedy: true,
			accept: ".resultimage, .library-item"
		});
	};

	d20.utils.summernoteInit = function() {
		let $textarea = $(this);
		let $loader = $("<div class=\"loader\"></div>");
		let showCodeView = $textarea.hasClass("code-view");
		let inAppEditor = $textarea.hasClass("in-app-editor");
		let callbacks = {};
		let toolbar = [
			["style", ["style"]],
			["font", ["bold", "italic", "underline", "strikethrough", "clear"]],
			["size", ["superscript", "subscript"]],
			["para", ["ol", "ul", "paragraph"]]
		];
		if (!inAppEditor) {
			toolbar.push(["insert", ["table", "link", "picture", "hr"]]);
			callbacks = {
				onImageUpload: function(files) {
					let $summernote = $(this);
					$loader.show();
					for (let i = 0; i < files.length; i++) {
						let name = files[i].name.split(".")[0];
						let data = new FormData();
						data.append("file", files[i]);
						$.ajax({
							data: data,
							dataType: "JSON",
							type: "POST",
							url: "/forum/upload",
							cache: false,
							contentType: false,
							processData: false,
							success: function(response) {
								if (typeof response.error !== "undefined") {
									alert(response.error);
									$loader.hide();
								}
								else {
									$summernote.summernote("insertImage", response["filelink"], name)
										.done(function() {
											$loader.hide();
										});
								}
							},
							error: function(jqXHR, textStatus, errorThrown) {
								alert("There was an error uploading your image. This was probably caused by either connection issues, or the file being too large.");
								$loader.hide();
							}
						});
					}
				},
				onImageUploadError: function(one, two, three) {
					console.error("Image Upload Error");
				}
			}
		}
		else {
			toolbar.push(["insert", ["link", "unlink"]]);
			toolbar.push(["hr", ["hr"]]);
			toolbar.push(["color", ["color"]]);
			toolbar.push(["tableAdd", ["table", "tableHeaders", "addRowUp", "addRowDown", "addColLeft", "addColRight"]]);
			toolbar.push(["tableDelete", ["deleteRow", "deleteCol", "deleteTable"]]);
		}
		if (showCodeView) {
			toolbar.push(["code", ["codeview"]])
		}
		let summernoteDefaults = {
			toolbar: toolbar,
			disableDragAndDrop: inAppEditor,
			callbacks: callbacks,
			maxHeight: 300,
			dialogsInBody: inAppEditor,
			onCreateLink: function (linkURL) {
				// If the URL is a special case, replace the : with html-escaped :
				if (linkURL[0] === "`" || linkURL[0] === "!" || linkURL[0] === "~") {
					linkURL = linkURL.replace(/:/g, "&#58;");
				}
				return linkURL;
			}
		}
		if (inAppEditor) {
			summernoteDefaults["popover"] = {
				table: [],
				link: []
			};
		}
		else {
			summernoteDefaults["popover"] = {
				table: [
					['add', ['tableHeaders', 'addRowDown', 'addRowUp', 'addColLeft', 'addColRight']],
					['delete', ['deleteRow', 'deleteCol', 'deleteTable']]
				]
			}
		}

		$textarea.summernote(summernoteDefaults);
		$loader.hide();
		$textarea.siblings(".note-editor").append($loader);
	};

	d20.utils.makeContentEditable = function($container, content, includeCodeView) {
		let $content = $(content);
		$container.html("<textarea class='summernote" + (includeCodeView ? " code-view" : "") + "'></textarea>");
		$container.find("textarea.summernote").each(d20.utils.summernoteInit);
		$container.find("textarea.summernote").summernote("focus");
		$content.find(".lightly").each(function() {
			let $imgWrapper = $(this);
			let $img = $($imgWrapper.html());
			$imgWrapper.after($img);
			$imgWrapper.remove();
		});
		$container.find(".note-editable").html($content.html());
		$container.find("textarea.summernote").trigger("summernote.change");
	};

	d20.utils.addCSSRules = function(rules) {
		// make a new stylesheet
		var ns = document.createElement('style');
		document.getElementsByTagName('head')[0].appendChild(ns);

		// Safari does not see the new stylesheet unless you append something.
		// However!  IE will blow chunks, so ... filter it thusly:
		if (!window.createPopup) {
			ns.appendChild(document.createTextNode(''));
		}
		var s = document.styleSheets[document.styleSheets.length - 1];
		// some rules to apply

		// loop through and insert
		for (let selector in rules) {
			if (s.insertRule) {
				// it's an IE browser
				try {
					s.insertRule(selector + rules[selector], s.cssRules.length);
				}
				catch (e) {}
			}
			else {
				// it's a W3C browser
				try {
					s.addRule(selector, rules[selector]);
				}
				catch (e) {
					console.log("Error addding rule!");
					console.log(e);
				}
			}
		}
	};

	d20.utils.defaultDiceTokens = {
		//"d4": ["https://s3.amazonaws.com/files.d20.io/images/747303/YxmOG16zPFiSrW-lEdmpTg/thumb.png?1362453271", "https://s3.amazonaws.com/files.d20.io/images/747301/kMSch19zUnLoGoySwF9Ykw/thumb.png?1362453271", "https://s3.amazonaws.com/files.d20.io/images/747302/ENrfFRhP2pDdneKgT6Jgxg/thumb.png?1362453271", "https://s3.amazonaws.com/files.d20.io/images/747304/aZ8KB0ptksJcgRQx8gMS2w/thumb.png?1362453271"],
		//"d20": ["https://s3.amazonaws.com/files.d20.io/images/747271/vPvYG84j2tSSpZ48D3eNqQ/thumb.png?1362453151", "https://s3.amazonaws.com/files.d20.io/images/747272/6BPnNW3PBEhPclkb-xIQ9w/thumb.png?1362453151", "https://s3.amazonaws.com/files.d20.io/images/747274/MzYLKWK5SVhbdvJ8napIzQ/thumb.png?1362453151", "https://s3.amazonaws.com/files.d20.io/images/747273/K0Lx76PSDaAQdNjWmoXang/thumb.png?1362453151", "https://s3.amazonaws.com/files.d20.io/images/747276/Q72SEogE5fqO6v6aMCBUPw/thumb.png?1362453152", "https://s3.amazonaws.com/files.d20.io/images/747275/aRwPAppIFt7HPM5C6y0lQQ/thumb.png?1362453152", "https://s3.amazonaws.com/files.d20.io/images/747277/beOPJkwPA4PRV4QLq7byOg/thumb.png?1362453152", "https://s3.amazonaws.com/files.d20.io/images/747278/5j5CigYBAP3DG-cNrHQ_FQ/thumb.png?1362453152", "https://s3.amazonaws.com/files.d20.io/images/747282/RWTJJTPcxOvZNQGCaBiQcg/thumb.png?1362453153", "https://s3.amazonaws.com/files.d20.io/images/747280/J5X-7rRBuaOVzKCXgJWYnQ/thumb.png?1362453153", "https://s3.amazonaws.com/files.d20.io/images/747281/_bVtu7w2FZoYJ95iANudJg/thumb.png?1362453153", "https://s3.amazonaws.com/files.d20.io/images/747279/H4wLbu2fcIqjXaBNR8F0ZQ/thumb.png?1362453153", "https://s3.amazonaws.com/files.d20.io/images/747284/FzVdwcAZVuCyzHGlEQuSEg/thumb.png?1362453154", "https://s3.amazonaws.com/files.d20.io/images/747283/mSSjECWXrGoUpWWpRrWpGw/thumb.png?1362453154", "https://s3.amazonaws.com/files.d20.io/images/747288/a8LXJpE19UPpMTQ8Zw6q-w/thumb.png?1362453155", "https://s3.amazonaws.com/files.d20.io/images/747285/t1hwT9c3lrDYxqItfXYmGw/thumb.png?1362453154", "https://s3.amazonaws.com/files.d20.io/images/747287/wr35rz8yLjQkyiQKBKRR9A/thumb.png?1362453155", "https://s3.amazonaws.com/files.d20.io/images/747290/d3_6X1wnx1M_qe3wpBXu8Q/thumb.png?1362453156", "https://s3.amazonaws.com/files.d20.io/images/747291/0uDnSVP2vb51jgcjqe3KAA/thumb.png?1362453158", "https://s3.amazonaws.com/files.d20.io/images/747289/juvZAZ00F_AETQb4g4lV3w/thumb.png?1362453155"]
		"d4": ["https://s3.amazonaws.com/files.d20.io/images/779542/DEYaBdP8w9B1CUSK26im0A/thumb.png?1363050056", "https://s3.amazonaws.com/files.d20.io/images/779540/P7yKde5fyGZCB1ud70UOzA/thumb.png?1363050056", "https://s3.amazonaws.com/files.d20.io/images/779539/AO4m-45bGw5yOcnZXUAn9g/thumb.png?1363050056", "https://s3.amazonaws.com/files.d20.io/images/779541/oWA-hmBAHNAijceHr8k-3A/thumb.png?1363050056"],
		"d6": ["https://s3.amazonaws.com/files.d20.io/images/779533/-gS85HUaXIvmE5SjGpoH4w/thumb.png?1363049998", "https://s3.amazonaws.com/files.d20.io/images/779535/vkc_PT4z-d_ON1MvfHaCiA/thumb.png?1363049999", "https://s3.amazonaws.com/files.d20.io/images/779534/mHDadFirie4L12_ii-HYqQ/thumb.png?1363049998", "https://s3.amazonaws.com/files.d20.io/images/779531/nXqp2BhdwVsQn7cDR3cMlg/thumb.png?1363049998", "https://s3.amazonaws.com/files.d20.io/images/779532/nQD5_IXYLWN7YCjnd5zugA/thumb.png?1363049998", "https://s3.amazonaws.com/files.d20.io/images/779536/ttiwwiWE2PVkhD2d7fV3GA/thumb.png?1363049999"],
		"d8": ["https://s3.amazonaws.com/files.d20.io/images/779514/GPCh5vqdSwvt_ANka3yhaw/thumb.png?1363049802", "https://s3.amazonaws.com/files.d20.io/images/779517/nnuf1Pe2Fq70BIs9FGI7mQ/thumb.png?1363049802", "https://s3.amazonaws.com/files.d20.io/images/779516/WnwuwT7yb5VM3-KiJY3GOg/thumb.png?1363049802", "https://s3.amazonaws.com/files.d20.io/images/779515/Gx21buVd6d6onPsALrGFWQ/thumb.png?1363049802", "https://s3.amazonaws.com/files.d20.io/images/779518/4LqfUGiX8sBXrX9b5gUnLw/thumb.png?1363049803", "https://s3.amazonaws.com/files.d20.io/images/779519/YOR5Wav0-3-L1fm4vD-LFQ/thumb.png?1363049803", "https://s3.amazonaws.com/files.d20.io/images/779522/dGFXXsEJz0EPA8dRpZvOzA/thumb.png?1363049804", "https://s3.amazonaws.com/files.d20.io/images/779521/QXm6GcIhK6zTdMvJZVS8Og/thumb.png?1363049804"],
		"d10": ["https://s3.amazonaws.com/files.d20.io/images/779498/fjup5Fz4iV-TFKxV9z1Qtg/thumb.png?1363049717", "https://s3.amazonaws.com/files.d20.io/images/779500/ug7m7g1rII05ZFzyTrkRmw/thumb.png?1363049717", "https://s3.amazonaws.com/files.d20.io/images/779499/QNZR5kGieM1x00yQvSYYbg/thumb.png?1363049717", "https://s3.amazonaws.com/files.d20.io/images/779497/tkz2552-MqV8a_woAD8S4A/thumb.png?1363049717", "https://s3.amazonaws.com/files.d20.io/images/779501/xKjqIxXzibpcx3Lp7UH6qg/thumb.png?1363049718", "https://s3.amazonaws.com/files.d20.io/images/779502/Bpc1QATzO293LvGS3neBsQ/thumb.png?1363049718", "https://s3.amazonaws.com/files.d20.io/images/779504/Bpw24T8na0nJNFdTKZX5aw/thumb.png?1363049718", "https://s3.amazonaws.com/files.d20.io/images/779503/ukQbc7uDKfl62ng2EO6h6g/thumb.png?1363049719", "https://s3.amazonaws.com/files.d20.io/images/779505/23948Y6_O0Bc0RuIve3BbA/thumb.png?1363049719", "https://s3.amazonaws.com/files.d20.io/images/779506/VhwbFVDm2KOte5h2p97n7w/thumb.png?1363049719"],
		"d12": ["https://s3.amazonaws.com/files.d20.io/images/779476/FRkaR6XvyzUuZb0ZB7ysCA/thumb.png?1363049489", "https://s3.amazonaws.com/files.d20.io/images/779474/UyTKDHxf-fU1zC3w6udl0w/thumb.png?1363049489", "https://s3.amazonaws.com/files.d20.io/images/779475/kUK2UmBaD2No00Gp4Q_OCQ/thumb.png?1363049489", "https://s3.amazonaws.com/files.d20.io/images/779477/OVnJDjAkMPLk29hjpFjUvw/thumb.png?1363049489", "https://s3.amazonaws.com/files.d20.io/images/779478/2la9taZk_vqdKItYZ6JEfA/thumb.png?1363049490", "https://s3.amazonaws.com/files.d20.io/images/779479/fa8f9OVIBt79oETji8C8Lg/thumb.png?1363049490", "https://s3.amazonaws.com/files.d20.io/images/779480/CTuw9Yiijq24ra3G9YMuPA/thumb.png?1363049490", "https://s3.amazonaws.com/files.d20.io/images/779481/d4onnc7NOAbNG5JbiL9mbg/thumb.png?1363049491", "https://s3.amazonaws.com/files.d20.io/images/779482/Oy2dTkB3-NlxiMsTRj78nw/thumb.png?1363049491", "https://s3.amazonaws.com/files.d20.io/images/779483/mO_KU8nlO7GDQKc2J_aNeg/thumb.png?1363049491", "https://s3.amazonaws.com/files.d20.io/images/779484/3MYG5dYJhiKXsRZtSUpHZw/thumb.png?1363049491", "https://s3.amazonaws.com/files.d20.io/images/779485/VxA3umVDmYrH5A_VBecUIQ/thumb.png?1363049492"],
		"d20": ["https://s3.amazonaws.com/files.d20.io/images/779445/OfLXGnbkNr2qKg1Qqk4cPg/thumb.png?1363049314", "https://s3.amazonaws.com/files.d20.io/images/779447/br4TdShbuMIZ-D-lyeXsKA/thumb.png?1363049315", "https://s3.amazonaws.com/files.d20.io/images/779454/2ARsJLoP4tExbCWrRaaxQg/thumb.png?1363049318", "https://s3.amazonaws.com/files.d20.io/images/779444/3pryVOKRxMCBisEHpH3LWg/thumb.png?1363049314", "https://s3.amazonaws.com/files.d20.io/images/779446/Yk4sSF3eWfnpeJd4DQpV2A/thumb.png?1363049314", "https://s3.amazonaws.com/files.d20.io/images/779450/tdvjVviFHhM_KxjFRQomhA/thumb.png?1363049316", "https://s3.amazonaws.com/files.d20.io/images/779456/twbHlPq0CFjFCpAyS59CTQ/thumb.png?1363049319", "https://s3.amazonaws.com/files.d20.io/images/779449/PPHDirZfEowhjBHxQdxJiw/thumb.png?1363049315", "https://s3.amazonaws.com/files.d20.io/images/779448/1SpNrrunpHwrNbsKcqpCzQ/thumb.png?1363049315", "https://s3.amazonaws.com/files.d20.io/images/779458/VsueBYqaDlvp9BjlXl9wMQ/thumb.png?1363049320", "https://s3.amazonaws.com/files.d20.io/images/779451/nWqhH9iMimUAJh_9jOFEog/thumb.png?1363049316", "https://s3.amazonaws.com/files.d20.io/images/779452/TvksvU6AZm2wmpEQ2HkBlQ/thumb.png?1363049317", "https://s3.amazonaws.com/files.d20.io/images/779459/L4pwmqIbQk0TfaCMExrYxQ/thumb.png?1363049320", "https://s3.amazonaws.com/files.d20.io/images/779453/MDmeMWOQ_lARfvFoT1n3KQ/thumb.png?1363049317", "https://s3.amazonaws.com/files.d20.io/images/779460/my8VEGyYcJIHZN2uXP6QXQ/thumb.png?1363049321", "https://s3.amazonaws.com/files.d20.io/images/779455/nuz5AefdQSB6H4mvUXoqhw/thumb.png?1363049318", "https://s3.amazonaws.com/files.d20.io/images/779457/kQBunq7iXGmHNqZQCa5MCA/thumb.png?1363049319", "https://s3.amazonaws.com/files.d20.io/images/779463/6n_z7Gwd7eacm3-HC-f-mg/thumb.png?1363049322", "https://s3.amazonaws.com/files.d20.io/images/779462/aVz3qCe2QM2nWhn3BoT9rg/thumb.png?1363049321", "https://s3.amazonaws.com/files.d20.io/images/779461/4PuFJYddJWJjj4uL5S3mxQ/thumb.png?1363049321"]
	}

	for (var ddt in d20.utils.defaultDiceTokens) {
		d20.utils.defaultDiceTokens[ddt] = _.map(d20.utils.defaultDiceTokens[ddt], function(item) {
			return escape(item + "");
		})
	}

	d20.utils.hexToRgb = function(h) {
		h[4] || (h = h.replace(/./g, '$&$&').slice(1));
		return ['0x' + h[1] + h[2] | 0, '0x' + h[3] + h[4] | 0, '0x' + h[5] + h[6] | 0]
	};

	var linkCache = {};

	var _refreshLinkCache = function() {
		var possibilities = {};
		d20.Campaign.characters.each(function(character) {
			var injournals = character.get("inplayerjournals").split(",");
			if (window.is_gm || _.indexOf(injournals, "all") !== -1 || (window.currentPlayer && _.indexOf(injournals, window.currentPlayer.id) !== -1)) {
				possibilities[character.get("name").toLowerCase()] = {
					type: "character",
					id: character.id
				};
			}
		});

		d20.Campaign.handouts.each(function(handout) {
			var injournals = handout.get("inplayerjournals").split(",");
			if (window.is_gm || _.indexOf(injournals, "all") !== -1 || (window.currentPlayer && _.indexOf(injournals, window.currentPlayer.id) !== -1)) {
				possibilities[handout.get("name").toLowerCase()] = {
					type: "handout",
					id: handout.id
				};
			}
		});
		linkCache = possibilities;
	};

	d20.utils.refreshLinkCache = _.debounce(_refreshLinkCache, 100);

	d20.utils.autoLink = function(text) {
		var linkreg = /\[[^\]]+\]/g
		text = text.replace(linkreg, function(match) {
			match = match.substring(1, match.length - 1);
			var foundmatch = linkCache[match.toLowerCase()];
			if (foundmatch) {
				return "<a href='http://journal.roll20.net/" + foundmatch.type + "/" + foundmatch.id + "'>" + match + "</a>";
			}
			else {
				return "[" + match + "]";
			}
		});
		return text;
	};

	var $notifier = $("#textchat-notifier");

	var currentTextchatNotificationPermanent = false;

	d20.utils.textchatNotify = function(msg, permanent) {

		if (currentTextchatNotificationPermanent === true && permanent !== true) return; //ignore non-permanent messages

		if (msg === false) {
			$notifier.hide();
		}
		else {
			$notifier.show().text(msg);
		}

		if (permanent === true) {
			if (msg !== false) currentTextchatNotificationPermanent = true;
			else currentTextchatNotificationPermanent = false;
		}
	}

	d20.utils.getParentsUntil = function(elem, parent, selector) {

		var parents = [];
		// if ( parent ) {
		//     var parentType = parent.charAt(0);
		// }
		if (selector) {
			var selectorType = selector.charAt(0);
		}

		// Get matches
		for (; elem && elem !== document; elem = elem.parentNode) {

			// Check if parent has been reached
			// if ( parent ) {

			//     // If parent is a class
			//     if ( parentType === '.' ) {
			//         if ( elem.classList.contains( parent.substr(1) ) ) {
			//             break;
			//         }
			//     }

			//     // If parent is an ID
			//     if ( parentType === '#' ) {
			//         if ( elem.id === parent.substr(1) ) {
			//             break;
			//         }
			//     }

			//     // If parent is a data attribute
			//     if ( parentType === '[' ) {
			//         if ( elem.hasAttribute( parent.substr(1, parent.length - 1) ) ) {
			//             break;
			//         }
			//     }

			//     // If parent is a tag
			//     if ( elem.tagName.toLowerCase() === parent ) {
			//         break;
			//     }

			// }

			if (parent) {
				if (parent === elem) {
					break;
				}
			}

			if (selector) {

				// If selector is a class
				if (selectorType === '.') {
					if (elem.classList.contains(selector.substr(1))) {
						parents.push(elem);
					}
				}

				// If selector is an ID
				if (selectorType === '#') {
					if (elem.id === selector.substr(1)) {
						parents.push(elem);
					}
				}

				// If selector is a data attribute
				if (selectorType === '[') {
					if (elem.hasAttribute(selector.substr(1, selector.length - 1))) {
						parents.push(elem);
					}
				}

				// If selector is a tag
				if (elem.tagName.toLowerCase() === selector) {
					parents.push(elem);
				}

			}
			else {
				parents.push(elem);
			}

		}

		return parents;

	};

})();

window.ucfirst = function(string) {
	return string.charAt(0).toUpperCase() + string.slice(1);
};

/*!
 Author: Stephen Korecky
 Website: http://stephenkorecky.com
 Plugin Website: http://github.com/skorecky/Add-Clear
 Version: 2.0.5
 The MIT License (MIT)
 Copyright (c) 2015 Stephen Korecky
 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:
 The above copyright notice and this permission notice shall be included in all
 copies or substantial portions of the Software.
 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 SOFTWARE.
*/

;
(function($, window, document, undefined) {

	// Create the defaults once
	var pluginName = "addClear",
		defaults = {
			closeSymbol: "&#10006;",
			color: "#CCC",
			top: -1,
			right: 8,
			returnFocus: true,
			showOnLoad: false,
			onClear: null,
			hideOnBlur: false,
			tabbable: true
		};

	// The actual plugin constructor
	function Plugin(element, options) {
		this.element = element;

		this.options = $.extend({}, defaults, options);

		this._defaults = defaults;
		this._name = pluginName;

		this.init();
	}

	Plugin.prototype = {

		init: function() {
			var $this = $(this.element),
				$clearButton,
				me = this,
				options = this.options;

			$this.wrap("<span style='position:relative;' class='add-clear-span'></span>");
			var tabIndex = options.tabbable ? "" : " tabindex='-1'";
			$clearButton = $("<a href='#clear' style='display: none;'" + tabIndex + ">" + options.closeSymbol + "</a>");
			$this.after($clearButton);
			$this.next().css({
				color: options.color,
				'text-decoration': 'none',
				display: 'none',
				'line-height': 1,
				overflow: 'hidden',
				position: 'absolute',
				right: options.right,
				top: options.top
			}, this);

			if ($this.val().length >= 1 && options.showOnLoad === true) {
				$clearButton.css({
					display: 'block'
				});
			}

			$this.focus(function() {
				if ($(this).val().length >= 1) {
					$clearButton.css({
						display: 'block'
					});
				}
			});

			$this.blur(function(e) {
				if (options.hideOnBlur) {
					setTimeout(function() {
						var relatedTarget = e.relatedTarget || e.explicitOriginalTarget || document.activeElement;
						if (relatedTarget !== $clearButton[0]) {
							$clearButton.css({
								display: 'none'
							});
						}
					}, 0);
				}
			});

			var handleUserInput = function() {
				if ($(this).val().length >= 1) {
					$clearButton.css({
						display: 'block'
					});
				}
				else {
					$clearButton.css({
						display: 'none'
					});
				}
			};

			var handleInput = function() {
				$this.off('keyup', handleUserInput);
				$this.off('cut', handleUserInput);
				handleInput = handleUserInput;
				handleUserInput.call(this);
			};

			$this.on('keyup', handleUserInput);

			$this.on('cut', function() {
				var self = this;
				setTimeout(function() {
					handleUserInput.call(self);
				}, 0);
			});

			$this.on('input', function() {
				handleInput.call(this);
			});

			if (options.hideOnBlur) {
				$clearButton.blur(function() {
					$clearButton.css({
						display: 'none'
					});
				});
			}

			$clearButton.click(function(e) {
				var $input = $(me.element);
				$input.val("").trigger("keyup");
				$(this).css({
					display: 'none'
				});
				if (options.returnFocus === true) {
					$input.focus();
				}
				if (options.onClear) {
					options.onClear($input);
				}
				e.preventDefault();
			});
		}

	};

	$.fn[pluginName] = function(options) {
		return this.each(function() {
			if (!$.data(this, "plugin_" + pluginName)) {
				$.data(this, "plugin_" + pluginName,
					new Plugin(this, options));
			}
		});
	};

})(jQuery, window, document);
d20.journal = d20.journal || {};
d20.compendium = d20.compendium || {};

d20.journal.charsheetLoadResolve = null;
d20.journal.charsheetLoadReject = null;
d20.journal.charsheetLoadPromise = new Promise((resolve, reject) => {
	d20.journal.charsheetLoadResolve = resolve;
	d20.journal.charsheetLoadReject = reject;
});

d20.journal.sandboxLoadResolve = null;
d20.journal.sandboxLoadReject = null;
d20.journal.sandboxLoadPromise = new Promise((resolve, reject) => {
	d20.journal.sandboxLoadResolve = resolve;
	d20.journal.sandboxLoadReject = reject;
});

d20.compendium.compendiumLoadResolve = null;
d20.compendium.compendiumLoadReject = null;
d20.compendium.compendiumLoadPromise = new Promise((resolve, reject) => {
	d20.compendium.compendiumLoadResolve = resolve;
	d20.compendium.compendiumLoadReject = reject;
});
d20.journal.usingFallback = false;

class CharsheetFallbackError extends Error {
	constructor(...params) {
		super(...params);

		if (Error.captureStackTrace) {
			Error.captureStackTrace(this, CharsheetFallbackError);
		}

		this.name = 'CharsheetFallbackError';
	}
}

const getErrorMessage = (error) => {
	try {
		return `Charsheet Fallback: Code: ${error.status}; Status: ${error.statusText}`;
	} catch (e) {
		return 'Charsheet Fallback: Unkown Error';
	}
};

const getTimingForRetries = (retries) => {
	switch (retries) {
		case 1:
			return { timeout: 15000, delay: 2000 };
		case 2:
			return { timeout: 30000, delay: 5000 };
		default:
			return { timeout: 5000, delay: 100 };
	}
};

function getCharsheetData(props = []) {
	return new Promise((resolve, reject) => {
		let retries = 0;

		const sendRequest = () => {
			const { timeout, delay } = getTimingForRetries(retries);

			$.ajax({
				url: `${CHARSHEET_URL}/graphql`,
				type: 'POST',
				data: { query: `{characterSheet(shortname: "${CHARSHEET_NAME}", campaignId: ${campaign_id}){${props.join()}}}` },
				timeout,
				error: (error) => {
					if (retries < 2) {
						retries += 1;
						setTimeout(sendRequest, delay);
					} else {
						reject(error);
						if (!d20.journal.usingFallback) {
							d20.journal.usingFallback = true;
							throw new CharsheetFallbackError(getErrorMessage(error));
						}
					}
				},
				success: (result) => {
					if (result.errors) reject(result.errors);

					if (result.data && result.data.characterSheet) {
						resolve(result.data.characterSheet);
					} else {
						reject();
					}
				},
			});
		};

		if (CHARSHEET_NAME === 'custom') {
			// For now, always use the fallback for a custom sheet
			reject('CUSTOM');
		} else {
			sendRequest();
		}
	});
}

function getCharsheetDataFallback() {
	const url = CHARSHEET_NAME === 'custom' ? `/editor/customcharsheetdata/${campaign_id}` : `/editor/charsheetdata/${campaign_id}`;

	return new Promise((resolve, reject) => {
		let retries = 0;

		const sendRequest = () => {
			$.ajax({
				url,
				type: 'GET',
				error: (error) => {
					if (retries < 2) {
						retries += 1;
						sendRequest();
					} else {
						reject(error);
					}
				},
				success: (result) => {
					const parsedResult = JSON.parse(result);
					resolve(parsedResult);
				},
			});
		};

		sendRequest();
	});
}

d20.journal.loadCustomCharsheet = async () => {
	await d20.journal.charsheetFetchPromise;

	let $layoutfrag = $(`<div class='root'>${d20.journal.customSheets.layouthtml}</div>`);
	$layoutfrag = d20.utils.htmlTranslator($layoutfrag);

	d20.journal.customSheets.availableRolls = {};
	d20.journal.customSheets.availableActions = {};
	d20.journal.customSheets.availableAttributes = {};
	d20.journal.customSheets.reservedAttributes = {};
	d20.journal.customSheets.tokenActions = [];
	d20.journal.customSheets.attrDeps = {};

	d20.journal.customSheets.eventListeners = [];

	const attrregex = /@{[^}]+}/g;

	d20.journal.updateSheetDeps = function (attrname, attrval) {
		const includedAttributes = attrval.match(attrregex);

		if (!includedAttributes) return true;

		for (let jj = 0; jj < includedAttributes.length; jj++) {
			const includedAttrName = includedAttributes[jj].substring(2, includedAttributes[jj].length - 1).toLowerCase();
			if (!d20.journal.customSheets.attrDeps[includedAttrName]) d20.journal.customSheets.attrDeps[includedAttrName] = [];
			if (d20.journal.customSheets.attrDeps[includedAttrName].indexOf(attrname.toLowerCase()) === -1) {
				d20.journal.customSheets.attrDeps[includedAttrName].push(attrname.toLowerCase());
			}
		}
	};

	$layoutfrag.find('button[type=roll]').each(function () {
		// Assume it starts with + strip out "roll_" in the "name" attribute
		const $thisel = $(this);
		const _$fieldset = $thisel.parents('fieldset');
		const _rollprefix = (_$fieldset.length > 0 ? `${_$fieldset.attr('class')}_` : '');

		if ($thisel.attr('name') !== undefined) {
			const _rollname = _rollprefix + $thisel.attr('name').substring(5, $thisel.attr('name').length).toLowerCase();
			d20.journal.customSheets.availableRolls[_rollname] = $thisel.val().split('\\n').join('\n');
			if ($thisel.hasClass('tokenaction')) {
				d20.journal.customSheets.tokenActions.push(_rollname);
			}
		}

		$thisel.addClass('btn');
	});

	// Get a list of action buttons, so we can use them in macros
	$layoutfrag.find('button[type=action]').each(function () {
		const $thisel = $(this);
		const fieldset = $thisel.parents('fieldset');
		// Prefix with repeating section name, if in one
		const rollprefix = (fieldset.length > 0 ? `${fieldset.attr('class')}_` : '');

		if ($thisel.attr('name') !== undefined) {
			const buttonName = $thisel.attr('name').replace(/^act_/, '');
			const rollName = (rollprefix + buttonName).toLowerCase();
			d20.journal.customSheets.availableActions[rollName] = buttonName;
		}
	});

	d20.journal.customSheets.tokenActions = _.sortBy(
		d20.journal.customSheets.tokenActions, (actionname) => actionname
	);

	const check_default = function (_attrname, $thisel, default_value) {
		if (!d20.journal.customSheets.availableAttributes[_attrname] || (d20.journal.customSheets.availableAttributes[_attrname] && $thisel.val() && $thisel.val() != default_value)) {
			return true;
		}
		return false;
	};

	$layoutfrag.find('*[name^="attr_"]').each(function () {
		const $thisel = $(this);

		const _$fset = $thisel.parents('fieldset');
		let _prefix = '';
		if (_$fset.length > 0) {
			const classlist = _$fset[0].classList;
			let groupname;
			_.each(classlist, (val) => {
				if (val.substring(0, 10) === 'repeating_') {
					groupname = val.toLowerCase().replace("'", '&quot;');
					return false;
				}
			});
			if (groupname) _prefix = `${groupname}_`;
		}

		const _attrname = _prefix + $thisel.attr('name').substring(5, $thisel.attr('name').length).toLowerCase();

		if (this.tagName.toLowerCase() === 'input' && $thisel.attr('type') === 'checkbox' && $thisel.val() !== undefined && check_default(_attrname, $thisel, undefined)) {
			if ($thisel.prop('checked')) {
				d20.journal.customSheets.availableAttributes[_attrname] = $thisel.val() || '';
			} else {
				d20.journal.customSheets.availableAttributes[_attrname] = '0';
			}
		} else if (this.tagName.toLowerCase() === 'input' && $thisel.attr('type') === 'radio' && $thisel.val() !== undefined && check_default(_attrname, $thisel, undefined)) {
			if ($thisel.prop('checked')) {
				d20.journal.customSheets.availableAttributes[_attrname] = $thisel.val() || '';
			}
		} else if ($thisel.prop('disabled')) {
			if (!this.attributes.value) {
				console.log('SHEET ERROR: Specified a disabled input without a valid formula in the value attribute.');
				return true;
			}
			d20.journal.customSheets.availableAttributes[_attrname] = this.attributes.value.nodeValue || '';
			d20.journal.updateSheetDeps(_attrname, d20.journal.customSheets.availableAttributes[_attrname]);
			$thisel.attr('data-formula', this.attributes.value.nodeValue);
			d20.journal.customSheets.reservedAttributes[_attrname] = true;
		} else if (this.tagName.toLowerCase() === 'span') {
			// if it already has a value, keeps the value, otherwise it is set to undefined
			d20.journal.customSheets.availableAttributes[_attrname] = d20.journal.customSheets.availableAttributes[_attrname];
		} else if (check_default(_attrname, $thisel, '')) {
			d20.journal.customSheets.availableAttributes[_attrname] = $thisel.val() || '';
		}

		// Check for dynamic dependencies
		if (!$thisel.prop('disabled') && typeof $thisel.val() === 'string' && $thisel.val().indexOf('@{') !== -1) {
			d20.journal.updateSheetDeps(_attrname, $thisel.val());
		}
	});

	d20.journal.customSheets.layouthtml = $layoutfrag.html();

	const head = document.head || document.getElementsByTagName('head')[0];

	if (d20.journal.customSheets.iframeCss) {
		d20.journal.customSheets.iframeStyleEl = d20.journal.makeCssElement(d20.journal.customSheets.iframeCss);
	}

	d20.journal.customSheets.styleel = d20.journal.makeCssElement(d20.journal.customSheets.css);
	$('style[title=charsheet]').remove();
	head.appendChild(d20.journal.customSheets.styleel);

	d20.journal.charsheetLoadResolve();
};

d20.journal.makeCssElement = (css) => {
	const style = document.createElement('style');

	style.type = 'text/css';
	style.title = 'charsheet';
	if (style.styleSheet) {
		style.styleSheet.cssText = css;
	} else {
		style.appendChild(document.createTextNode(css));
	}
	return style;
};

const htmlSanitizeLegacy = (dirtyHtml) => {
	let allowed = '<br><input><textarea><div><span><label><hr><img><b><i><strong><em><h1><h2><h3><h4><h5><h6><p><hr><table><tr><td><tbody><thead><th><tfoot><select><option><fieldset><button><ul><li><ol><caption>';
	// Remove anything in <mobile> tags
	let input = dirtyHtml.replace(/<mobile\s*>[\s\S]*?<\/mobile\s*>|<\/*web\s*>|<\/*mobile\s*>/g, '');
	// Strips HTML and PHP tags from a string
	if (allowed !== undefined) {
		input = html_sanitize(
			input,
			(url) => {
				const match = url.toString();
				const noproxy = ['https://s3.amazonaws.com/files.d20.io', 'http://imgsrv.roll20.net', 'https://imgsrv.roll20.net', imgsrv_url, 'https://app.roll20.net', 'https://storage.googleapis.com/char-sheet-app-images-6e101411'];

				for (let i = 0; i < noproxy.length; i++) {
					if (match.substring(0, noproxy[i].length) === noproxy[i]) {
						return match;
					}
				}
				if (/^https?:\/\//.test(match)) {
					return `${imgsrv_url}?src=${escape(match)}`;
				}

				return '';
			},
			(groupid) => {
				const classes = groupid.split(' ');
				_.each(classes, (id, idx) => {
					if (id.substring(0, 5) === 'attr_' || id.substring(0, 6) === 'sheet-' || id.substring(0, 10) === 'repeating_' || id.substring(0, 5) === 'roll_' || id.substring(0, 4) === 'act_' || id === 'tokenaction' || id.substring(0, 5) === 'comp_') {
						classes[idx] = id;
					} else {
						classes[idx] = `sheet-${id}`;
					}
				});
				return classes.join(' ');
			},
		);
	}
	allowed = ((`${allowed || ''}`).toLowerCase().match(/<[a-z][a-z0-9]*>/g) || []).join(''); // making sure the allowed arg is a string containing only tags in lowercase (<a><b><c>)
	const tags = /<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;
	const commentsAndPhpTags = /<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;
	return input.replace(commentsAndPhpTags, '').replace(tags, ($0, $1) => (allowed.indexOf(`<${$1.toLowerCase()}>`) > -1 ? $0 : ''));
};

const htmlSanitize = (dirtyHtml, legacy = false) => {
	const tags = ['a', 'abbr', 'address', 'article', 'aside', 'b', 'bdi', 'bdo', 'blockquote', 'br', 'button', 'caption',
		'cite', 'code', 'col', 'colgroup', 'data', 'datalist', 'dd', 'details', 'dfn', 'div', 'dl', 'dt', 'em', 'fieldset', 'figcaption',
		'figure', 'footer', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'header', 'hgroup', 'hr', 'i', 'img', 'input', 'kbd',
		'label', 'li', 'main', 'main', 'mark', 'nav', 'ol', 'option', 'p', 'pre', 'q', 'rb', 'rp', 'rt', 'rtc', 'ruby',
		's', 'samp', 'section', 'select', 'small', 'span', 'strong', 'sub', 'summary', 'sup', 'table', 'tbody', 'td', 'textarea',
		'tfoot', 'th', 'thead', 'time', 'tr', 'u', 'ul', 'var', 'wbr'];
	let attributes = ['abbr', 'accept', 'accesskey', 'align', 'alt', 'aria-*', 'autocomplete', 'axis', 'bgcolor', 'border',
		'cellpadding', 'cellspacing', 'char', 'charoff', 'checked', 'class', 'clear', 'color', 'cols', 'colspan', 'compact',
		'controls', 'coords', 'data-*', 'datetime', 'default', 'dir', 'disabled', 'draggable', 'enctype', 'face', 'for',
		'frame', 'frameborder', 'height', 'hidden', 'high', 'href', 'hreflang', 'hspace', 'inert', 'inputmode', 'ismap', 'itemprop',
		'itemscope', 'kind', 'label', 'lang', 'list', 'loading', 'loop', 'low', 'marginheight', 'marginwidth', 'max', 'maxlength',
		'method', 'min', 'multiple', 'muted', 'name', 'nohref', 'noshade', 'novalidate', 'nowrap', 'open', 'placeholder',
		'preload', 'radiogroup', 'readonly', 'required', 'reversed', 'role', 'rows', 'rowspan', 'rules', 'scope', 'selected',
		'shape', 'size', 'span', 'spellcheck', 'src', 'srclang', 'start', 'step', 'style', 'summary', 'tabindex', 'title',
		'translate', 'type', 'valign', 'value', 'vspace', 'width', 'wrap'];

	if (!legacy) attributes = attributes.concat('id');

	// Remove anything in <mobile> tags
	const input = dirtyHtml.replace(/<mobile\s*>[\s\S]*?<\/mobile\s*>|<\/*web\s*>|<\/*mobile\s*>/g, '');

	const cleanedHtml = Window.sanitizeHtml(
		input,
		{
			allowedAttributes: {
				'*': attributes,
			},
			allowedTags: tags,
			transformTags: {
				'*': (tagName, attribs) => {
					const newAttribs = attribs;
					if (legacy && attribs.class) {
						const classes = attribs.class.split(' ');
						classes.forEach((klass, i) => {
							if (klass.substring(0, 6) === 'sheet-' || klass === 'tokenaction' || ['attr', 'repeating', 'roll', 'act', 'comp'].includes(klass.split('_')[0])) {
								classes[i] = klass;
							} else {
								classes[i] = `sheet-${klass}`;
							}
						});
						newAttribs.class = classes.join(' ');
					}

					if (attribs.src) {
						newAttribs.src = d20.utils.addImageProxy(attribs.src);
					}

					if (attribs.href) {
						if (attribs.href.substring(0, 1) !== '#') {
							newAttribs.href = '#';
						}
					}

					return {
						tagName,
						attribs: newAttribs,
					};
				},
			},
			parser: {
				xmlMode: true,
				decodeEntities: false,
			},
		},
	);

	return cleanedHtml;
};

d20.journal.setLegacySanitization = (legacy) => {
	d20.journal.legacySanitization = legacy;
	d20.journal.htmlFilterFunc = legacy ? htmlSanitizeLegacy : htmlSanitize;
};

d20.journal.cssFilterFunc = function (inputCss, allowed) {
	let input = inputCss.replace(/\/\*\s*start mobile\s*\*\/[\S\s]*?\/\*\s*end mobile\s*\*\//gi, ''); // remove mobile css
	input = input.replace(/\/\*[^*]+\*\//g, ''); // remove all css comments

	// Look for selectors, make sure that they start with .char-sheet
	const font_imports = input.match(/(@import url\(['|"].+['|"]\);*)/ig) || [];
	input = input.replace(/(@import url\(['|"].+['|"]\);*)/ig, '');

	input = input.replace(/([^{]+){[^}]*}/ig, (match, selectors) => {
		selectors = $.trim(selectors);
		const sarray = selectors.split(',');
		let finalselector = '';
		for (let i = 0; i < sarray.length; i++) {
			sarray[i] = $.trim(sarray[i]);
			if (sarray[i].substring(0, 1) === '#') {
				sarray[i] = sarray[i].replace('#', '.');
			}
			if (sarray[i].match(/^\.lang-[a-z]{2}( .*)?$/)) {
				sarray[i] = `.charsheet${sarray[i]}`;
			} else if (!sarray[i].match(/^\.charsheet(\.lang-[a-z]{2})?( .*)?$/) && sarray[i] !== '@font-face' && sarray[i].substring(0, 20) !== '.sheet-rolltemplate-' && sarray[i].substring(0, 36) !== '.withoutavatars .sheet-rolltemplate-' && sarray[i].substring(0, 8) !== '@import ') {
				sarray[i] = `.charsheet ${sarray[i]}`;
			}
		}
		finalselector = sarray.join(',');
		match = match.replace(selectors, finalselector);
		return match;
	});

	const evil = [
		/(\bdata:\b|eval|cookie|\bwindow\b|\bparent\b|\bthis\b)/i, // suspicious javascript-type words
		/behaviou?r|expression|moz-binding|@charset|javascript|vbscript|[\<]|\\\w/i,
		/@import (?!url\(['"]https:\/\/fonts\.googleapis\.com\/css\?family=)/i,
		/// [\<>]/, // back slash, html tags,
		/[\x7f-\xff]/, // high bytes -- suspect
		/[\x00-\x08\x0B\x0C\x0E-\x1F]/, // low bytes -- suspect
		/&\#/, // bad charset
	];

	for (let i = 0; i < evil.length; i++) {
		if (input.match(evil[i])) {
			console.log(input.match(evil[i]));
			console.error('Potential CSS security violation; character sheet template styling thrown out.');
			input = '';
		}
	}

	font_imports.forEach((fontImport) => {
		if (fontImport.includes('fonts.googleapis.com')) {
			input = `${fontImport} ${input}`;
		}
	});

	input = input.replace(/url[\s]*\([^\)]+\)/ig, (match) => {
		match = match.replace(/\s/gi, ''); // replace all whitespace.
		match = match.replace('url(', '');
		const ps = match.split(')');
		match = ps[ps.length - 2]; // everything before last parentheses
		match = match.replace(/'/ig, '');
		match = match.replace(/"/ig, ''); // remove all quotes/apostrophes
		// At this point it should just be the URL.
		const noproxy = ['https://s3.amazonaws.com/files.d20.io', 'http://imgsrv.roll20.net', 'https://imgsrv.roll20.net', imgsrv_url, 'https://app.roll20.net' , 'https://storage.googleapis.com/char-sheet-app-images-6e101411'];

		for (let i = 0; i < noproxy.length; i++) {
			if (match.substring(0, noproxy[i].length) === noproxy[i]) {
				return `url("${match}")`;
			}
		}
		if (/^https?:\/\//.test(match)) {
			return `url('${imgsrv_url}/?src=${escape($.trim(match))}')`;
		}

		return '';
	});

	allowed = ((`${allowed || ''}`).toLowerCase().match(/<[a-z][a-z0-9]*>/g) || []).join(''); // making sure the allowed arg is a string containing only tags in lowercase (<a><b><c>)
	const tags = /<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;
	const commentsAndPhpTags = /<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;
	return input.replace(commentsAndPhpTags, '').replace(tags, ($0, $1) => (allowed.indexOf(`<${$1.toLowerCase()}>`) > -1 ? $0 : ''));
};

d20.journal.loadSheetFromFallback = (customcharsheet_html, customcharsheet_css) => {
	d20.journal.customSheets.rollTemplates = {};
	d20.journal.customSheets.charmancerTemplates = {};
	d20.journal.customSheets.charmancerRepeating = {};
	d20.journal.customSheets.workerScripts = [];

	let decodedhtml = BASE64.decode(customcharsheet_html);
	const decodedCss = BASE64.decode(customcharsheet_css).replace(/\/\*\s*?start mobile\s*?\*\/[\s\S]*?\/\*\s*?end mobile\s*?\*\//gim, '');

	const rolltemplateregex = /(<rolltemplate [^>]+>)([\s\S]*?)(<\/rolltemplate>)/ig;
	const rolltempclassregex = /(class=\"sheet-rolltemplate-)([^\"]+)(\">)/i;

	decodedhtml = decodedhtml.replace(rolltemplateregex, function (match) {
		const classmatches = rolltempclassregex.exec(match);
		if (classmatches && classmatches.length > 3) {
			const myid = classmatches[2];
			let templateInnerHtml = arguments[2];
			templateInnerHtml = d20.journal.htmlFilterFunc(templateInnerHtml, true);
			d20.journal.customSheets.rollTemplates[myid] = templateInnerHtml;
		}

		return '';
	});

	const charmancertemplateregex = /(<charmancer [^>]+>)([\s\S]*?)(<\/charmancer>)/ig;
	const charmancertempclassregex = /(class=\"sheet-(charmancer|repeating)-)([^\"]+)(\">)/i;

	decodedhtml = decodedhtml.replace(charmancertemplateregex, function (match) {
		const classmatches = charmancertempclassregex.exec(match);
		if (classmatches && classmatches.length > 4) {
			const myid = classmatches[3];
			let templateInnerHtml = arguments[2];
			templateInnerHtml = d20.journal.htmlFilterFunc(templateInnerHtml);
			if (classmatches[2].toLowerCase() == 'charmancer') {
				d20.journal.customSheets.charmancerTemplates[myid] = templateInnerHtml;
			} else {
				d20.journal.customSheets.charmancerRepeating[myid.split(' ')[0]] = templateInnerHtml;
			}
		}

		return '';
	});

	const scriptjsregex = /(<script [^>]+>)([\s\S]*?)(<\/script>)/ig;
	const workerjstyperegex = /(type=[\"|']text\/worker[\"|']>)/i;

	decodedhtml = decodedhtml.replace(scriptjsregex, function (match) {
		const workermatches = workerjstyperegex.exec(match);
		if (workermatches && workermatches[0].indexOf('text/worker') !== -1) {
			d20.journal.customSheets.workerScripts.push(arguments[2]);
			return '';
		}

		return match;
	});

	d20.journal.customSheets.layouthtml = d20.journal.htmlFilterFunc(decodedhtml);

	d20.journal.customSheets.css = d20.journal.cssFilterFunc(decodedCss);

	if (!d20.journal.legacySanitization) d20.journal.customSheets.iframeCss = decodedCss;
};

const loadBlankSheet = () => {
	d20.journal.useCustomSheets = false;
	d20.journal.customSheets.translation = { values: {}, lang: LANGUAGE };
	i18n.translator.add(d20.journal.customSheets.translation);

	d20.journal.setLegacySanitization(false);
	d20.journal.customSheets.sheetSettings = {};
	d20.journal.customSheets.rollTemplates = {};
	d20.journal.customSheets.charmancerTemplates = {};
	d20.journal.customSheets.charmancerRepeating = {};
	d20.journal.customSheets.workerScripts = [];
	d20.journal.customSheets.layouthtml = '';
	d20.journal.customSheets.css = '';
	d20.journal.customSheets.iframeCss = '';

	d20.journal.customSheets.availableRolls = {};
	d20.journal.customSheets.availableActions = {};
	d20.journal.customSheets.availableAttributes = {};
	d20.journal.customSheets.reservedAttributes = {};
	d20.journal.customSheets.tokenActions = [];
	d20.journal.customSheets.attrDeps = {};

	d20.journal.customSheets.eventListeners = [];

	d20.compendium.shortName = COMPENDIUM_OVERRIDE ? COMPENDIUM_OVERRIDE : '';
};

async function getAllCharsheetData() {
	d20.journal.useCustomSheets = true;
	d20.journal.customSheets = {
		sheetSettings: {},
		rollTemplates: {},
		charmancerTemplates: {},
		charmancerRepeating: {},
		workerScripts: [],
		layouthtml: '',
		css: '',
		iframeCss: '',

		availableRolls: {},
		availableActions: {},
		availableAttributes: {},
		reservedAttributes: {},
		tokenActions: [],
		attrDeps: {},

		eventListeners: [],
	};

	return new Promise((resolve) => {
		if (CHARSHEET_NAME === 'none') {
			loadBlankSheet();
			resolve();
		} else {
			Promise.all([
				getCharsheetData(['css(sanitized: true)', 'html', 'rolltemplates', 'mancertemplates', 'userOptions']),
				getCharsheetData(['sheetworkers', 'legacySanitization', `translation(language: "${LANGUAGE}")`, 'iframeCss', 'compendium']),
			]).then((results) => {
				const charsheetData = {
					...results[0],
					...results[1],
				};
				d20.journal.setLegacySanitization(charsheetData.legacySanitization);

				d20.journal.customSheets.translation = { values: charsheetData.translation, lang: LANGUAGE };
				i18n.translator.add(d20.journal.customSheets.translation);

				d20.journal.customSheets.sheetSettings = charsheetData.userOptions;

				d20.journal.customSheets.rollTemplates = charsheetData.rolltemplates;
				d20.journal.customSheets.charmancerTemplates = charsheetData.mancertemplates.charmancer;
				d20.journal.customSheets.charmancerRepeating = charsheetData.mancertemplates.repeating;
				d20.journal.customSheets.workerScripts = charsheetData.sheetworkers;
				d20.journal.customSheets.layouthtml = charsheetData.html;
				d20.journal.customSheets.css = charsheetData.css;
				d20.journal.customSheets.iframeCss = charsheetData.iframeCss;

				d20.compendium.shortName = COMPENDIUM_OVERRIDE ? COMPENDIUM_OVERRIDE : charsheetData.compendium;

				resolve();
			}).catch((error) => {
				if (error !== 'CUSTOM') {
					// Don't need to warn if we're falling back for a custom sheet
					console.warn('Failure contacting character sheet service, using fallback.');
				}

				getCharsheetDataFallback().then((result) => {
					d20.journal.setLegacySanitization(result.legacy_sanitization);

					if (sheetSandboxGame) {
						d20.journal.customcharsheet_html = result.html;
						d20.journal.customcharsheet_css = result.css;
						d20.journal.customcharsheet_translation = result.translation;
					}

					d20.journal.customSheets.translation = JSON.parse(BASE64.decode(result.translation));
					i18n.translator.add(d20.journal.customSheets.translation);

					d20.journal.customSheets.sheetSettings = result.sheet_options;

					d20.compendium.shortName = COMPENDIUM_OVERRIDE ? COMPENDIUM_OVERRIDE : result.compendium;

					d20.journal.loadSheetFromFallback(result.html, result.css);

					resolve();
				}).catch((innerError) => {
					// If the fallback fails, load a blank sheet.
					console.error('Unable to load character sheet data.');
					if (innerError) console.error(innerError);

					loadBlankSheet();

					resolve();
				});
			});
		}
	});
}

d20.journal.charsheetFetchPromise = getAllCharsheetData();

d20.DicePEG = (function(){
  /*
   * Generated by PEG.js 0.7.0.
   *
   * http://pegjs.majda.cz/
   */
  
  function quote(s) {
    /*
     * ECMA-262, 5th ed., 7.8.4: All characters may appear literally in a
     * string literal except for the closing quote character, backslash,
     * carriage return, line separator, paragraph separator, and line feed.
     * Any character may appear in the form of an escape sequence.
     *
     * For portability, we also escape escape all control and non-ASCII
     * characters. Note that "\0" and "\v" escape sequences are not used
     * because JSHint does not like the first and IE the second.
     */
     return '"' + s
      .replace(/\\/g, '\\\\')  // backslash
      .replace(/"/g, '\\"')    // closing quote character
      .replace(/\x08/g, '\\b') // backspace
      .replace(/\t/g, '\\t')   // horizontal tab
      .replace(/\n/g, '\\n')   // line feed
      .replace(/\f/g, '\\f')   // form feed
      .replace(/\r/g, '\\r')   // carriage return
      .replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g, escape)
      + '"';
  }
  
  var result = {
    /*
     * Parses the input with a generated parser. If the parsing is successfull,
     * returns a value explicitly or implicitly specified by the grammar from
     * which the parser was generated (see |PEG.buildParser|). If the parsing is
     * unsuccessful, throws |PEG.parser.SyntaxError| describing the error.
     */
    parse: function(input, startRule) {
      var parseFunctions = {
        "start": parse_start,
        "rollExpression": parse_rollExpression,
        "rollExpressionPrimary": parse_rollExpressionPrimary,
        "validRollSuffix": parse_validRollSuffix,
        "rollGroup": parse_rollGroup,
        "rollGroupExpression": parse_rollGroupExpression,
        "labelAwareRollOperator": parse_labelAwareRollOperator,
        "rollOperator": parse_rollOperator,
        "fullRoll": parse_fullRoll,
        "coreRoll": parse_coreRoll,
        "numberOfDice": parse_numberOfDice,
        "numberOfSides": parse_numberOfSides,
        "groupMods": parse_groupMods,
        "rollMods": parse_rollMods,
        "explodingMod": parse_explodingMod,
        "compoundingMod": parse_compoundingMod,
        "penetratingMod": parse_penetratingMod,
        "keepMod": parse_keepMod,
        "dropMod": parse_dropMod,
        "customCritMod": parse_customCritMod,
        "customFumbleMod": parse_customFumbleMod,
        "rerollMod": parse_rerollMod,
        "rerollOnceMod": parse_rerollOnceMod,
        "sortMod": parse_sortMod,
        "floorMod": parse_floorMod,
        "multipleMod": parse_multipleMod,
        "successMod": parse_successMod,
        "matchMod": parse_matchMod,
        "matchTotalMod": parse_matchTotalMod,
        "matchThreshold": parse_matchThreshold,
        "comparisonPoint": parse_comparisonPoint,
        "comparison": parse_comparison,
        "mathExpression": parse_mathExpression,
        "mathExpressionPrimary": parse_mathExpressionPrimary,
        "inlineLabelWithSpace": parse_inlineLabelWithSpace,
        "inlineLabel": parse_inlineLabel,
        "operator": parse_operator,
        "number": parse_number,
        "integer": parse_integer,
        "signedInteger": parse_signedInteger,
        "float": parse_float,
        "exponent": parse_exponent,
        "_": parse__,
        "__": parse___
      };
      
      if (startRule !== undefined) {
        if (parseFunctions[startRule] === undefined) {
          throw new Error("Invalid rule name: " + quote(startRule) + ".");
        }
      } else {
        startRule = "start";
      }
      
      var pos = 0;
      var reportFailures = 0;
      var rightmostFailuresPos = 0;
      var rightmostFailuresExpected = [];
      
      function padLeft(input, padding, length) {
        var result = input;
        
        var padLength = length - input.length;
        for (var i = 0; i < padLength; i++) {
          result = padding + result;
        }
        
        return result;
      }
      
      function escape(ch) {
        var charCode = ch.charCodeAt(0);
        var escapeChar;
        var length;
        
        if (charCode <= 0xFF) {
          escapeChar = 'x';
          length = 2;
        } else {
          escapeChar = 'u';
          length = 4;
        }
        
        return '\\' + escapeChar + padLeft(charCode.toString(16).toUpperCase(), '0', length);
      }
      
      function matchFailed(failure) {
        if (pos < rightmostFailuresPos) {
          return;
        }
        
        if (pos > rightmostFailuresPos) {
          rightmostFailuresPos = pos;
          rightmostFailuresExpected = [];
        }
        
        rightmostFailuresExpected.push(failure);
      }
      
      function parse_start() {
        var result0, result1, result2;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        result0 = parse_rollExpression();
        if (result0 !== null) {
          result1 = [];
          if (input.length > pos) {
            result2 = input.charAt(pos);
            pos++;
          } else {
            result2 = null;
            if (reportFailures === 0) {
              matchFailed("any character");
            }
          }
          while (result2 !== null) {
            result1.push(result2);
            if (input.length > pos) {
              result2 = input.charAt(pos);
              pos++;
            } else {
              result2 = null;
              if (reportFailures === 0) {
                matchFailed("any character");
              }
            }
          }
          if (result1 !== null) {
            result0 = [result0, result1];
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, re, com) {
            if (!Array.isArray(re)) {
              re = [re];
            }
        
            //If a comment exists append it to the end of the roll expression
            if (com !== "") {
              com = com.join("");
              if (com.trim().length > 0) {
                re.push(new Comment(com));
              }
            }
        
            return re;
          })(pos0, result0[0], result0[1]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_rollExpression() {
        var result0, result1, result2;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        result0 = parse_rollExpressionPrimary();
        if (result0 !== null) {
          result1 = parse_labelAwareRollOperator();
          if (result1 !== null) {
            result2 = parse_rollExpression();
            if (result2 !== null) {
              result0 = [result0, result1, result2];
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, left, oper, right) {
            var result = left;
            result = mergeExpressions(result, oper);
            result = mergeExpressions(result, right);
            return result;
          })(pos0, result0[0], result0[1], result0[2]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        if (result0 === null) {
          pos0 = pos;
          pos1 = pos;
          result0 = parse_rollExpressionPrimary();
          if (result0 !== null) {
            result1 = parse_inlineLabelWithSpace();
            if (result1 !== null) {
              result0 = [result0, result1];
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
          if (result0 !== null) {
            result0 = (function(offset, rep, lbl) {
              return mergeExpressions(rep, lbl);
            })(pos0, result0[0], result0[1]);
          }
          if (result0 === null) {
            pos = pos0;
          }
          if (result0 === null) {
            pos0 = pos;
            pos1 = pos;
            result0 = parse_inlineLabelWithSpace();
            if (result0 !== null) {
              result1 = parse_rollExpression();
              if (result1 !== null) {
                result0 = [result0, result1];
              } else {
                result0 = null;
                pos = pos1;
              }
            } else {
              result0 = null;
              pos = pos1;
            }
            if (result0 !== null) {
              result0 = (function(offset, lbl, re) {
                return mergeExpressions(lbl, re);
              })(pos0, result0[0], result0[1]);
            }
            if (result0 === null) {
              pos = pos0;
            }
            if (result0 === null) {
              pos0 = pos;
              result0 = parse_rollExpressionPrimary();
              if (result0 !== null) {
                result0 = (function(offset, rep) {
                  if (!Array.isArray(rep)) {
                    rep = [rep];
                  }
                  return rep;
                })(pos0, result0);
              }
              if (result0 === null) {
                pos = pos0;
              }
            }
          }
        }
        return result0;
      }
      
      function parse_rollExpressionPrimary() {
        var result0, result1, result2, result3, result4;
        var pos0, pos1, pos2;
        
        pos0 = pos;
        pos1 = pos;
        result0 = parse_fullRoll();
        if (result0 !== null) {
          pos2 = pos;
          reportFailures++;
          result1 = parse_validRollSuffix();
          reportFailures--;
          if (result1 !== null) {
            result1 = "";
            pos = pos2;
          } else {
            result1 = null;
          }
          if (result1 !== null) {
            result0 = [result0, result1];
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, fr) {
            return fr;
          })(pos0, result0[0]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        if (result0 === null) {
          pos0 = pos;
          pos1 = pos;
          result0 = parse_rollGroup();
          if (result0 !== null) {
            pos2 = pos;
            reportFailures++;
            result1 = parse_validRollSuffix();
            reportFailures--;
            if (result1 !== null) {
              result1 = "";
              pos = pos2;
            } else {
              result1 = null;
            }
            if (result1 !== null) {
              result0 = [result0, result1];
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
          if (result0 !== null) {
            result0 = (function(offset, rg) {
              return rg;
            })(pos0, result0[0]);
          }
          if (result0 === null) {
            pos = pos0;
          }
          if (result0 === null) {
            pos0 = pos;
            result0 = parse_number();
            if (result0 !== null) {
              result0 = (function(offset, num) {
                return new MathExpression(num);
              })(pos0, result0);
            }
            if (result0 === null) {
              pos = pos0;
            }
            if (result0 === null) {
              pos0 = pos;
              pos1 = pos;
              if (input.substr(pos, 6) === "floor(") {
                result0 = "floor(";
                pos += 6;
              } else {
                result0 = null;
                if (reportFailures === 0) {
                  matchFailed("\"floor(\"");
                }
              }
              if (result0 !== null) {
                result1 = parse__();
                if (result1 !== null) {
                  result2 = parse_rollExpression();
                  if (result2 !== null) {
                    result3 = parse__();
                    if (result3 !== null) {
                      if (input.charCodeAt(pos) === 41) {
                        result4 = ")";
                        pos++;
                      } else {
                        result4 = null;
                        if (reportFailures === 0) {
                          matchFailed("\")\"");
                        }
                      }
                      if (result4 !== null) {
                        result0 = [result0, result1, result2, result3, result4];
                      } else {
                        result0 = null;
                        pos = pos1;
                      }
                    } else {
                      result0 = null;
                      pos = pos1;
                    }
                  } else {
                    result0 = null;
                    pos = pos1;
                  }
                } else {
                  result0 = null;
                  pos = pos1;
                }
              } else {
                result0 = null;
                pos = pos1;
              }
              if (result0 !== null) {
                result0 = (function(offset, rexp) {
              
                  return mergeExpressions("floor(", mergeExpressions(rexp, ")"));
                })(pos0, result0[2]);
              }
              if (result0 === null) {
                pos = pos0;
              }
              if (result0 === null) {
                pos0 = pos;
                pos1 = pos;
                if (input.substr(pos, 5) === "ceil(") {
                  result0 = "ceil(";
                  pos += 5;
                } else {
                  result0 = null;
                  if (reportFailures === 0) {
                    matchFailed("\"ceil(\"");
                  }
                }
                if (result0 !== null) {
                  result1 = parse__();
                  if (result1 !== null) {
                    result2 = parse_rollExpression();
                    if (result2 !== null) {
                      result3 = parse__();
                      if (result3 !== null) {
                        if (input.charCodeAt(pos) === 41) {
                          result4 = ")";
                          pos++;
                        } else {
                          result4 = null;
                          if (reportFailures === 0) {
                            matchFailed("\")\"");
                          }
                        }
                        if (result4 !== null) {
                          result0 = [result0, result1, result2, result3, result4];
                        } else {
                          result0 = null;
                          pos = pos1;
                        }
                      } else {
                        result0 = null;
                        pos = pos1;
                      }
                    } else {
                      result0 = null;
                      pos = pos1;
                    }
                  } else {
                    result0 = null;
                    pos = pos1;
                  }
                } else {
                  result0 = null;
                  pos = pos1;
                }
                if (result0 !== null) {
                  result0 = (function(offset, rexp) {
                
                    return mergeExpressions("ceil(", mergeExpressions(rexp, ")"));
                  })(pos0, result0[2]);
                }
                if (result0 === null) {
                  pos = pos0;
                }
                if (result0 === null) {
                  pos0 = pos;
                  pos1 = pos;
                  if (input.substr(pos, 6) === "round(") {
                    result0 = "round(";
                    pos += 6;
                  } else {
                    result0 = null;
                    if (reportFailures === 0) {
                      matchFailed("\"round(\"");
                    }
                  }
                  if (result0 !== null) {
                    result1 = parse__();
                    if (result1 !== null) {
                      result2 = parse_rollExpression();
                      if (result2 !== null) {
                        result3 = parse__();
                        if (result3 !== null) {
                          if (input.charCodeAt(pos) === 41) {
                            result4 = ")";
                            pos++;
                          } else {
                            result4 = null;
                            if (reportFailures === 0) {
                              matchFailed("\")\"");
                            }
                          }
                          if (result4 !== null) {
                            result0 = [result0, result1, result2, result3, result4];
                          } else {
                            result0 = null;
                            pos = pos1;
                          }
                        } else {
                          result0 = null;
                          pos = pos1;
                        }
                      } else {
                        result0 = null;
                        pos = pos1;
                      }
                    } else {
                      result0 = null;
                      pos = pos1;
                    }
                  } else {
                    result0 = null;
                    pos = pos1;
                  }
                  if (result0 !== null) {
                    result0 = (function(offset, rexp) {
                  
                      return mergeExpressions("round(", mergeExpressions(rexp, ")"));
                    })(pos0, result0[2]);
                  }
                  if (result0 === null) {
                    pos = pos0;
                  }
                  if (result0 === null) {
                    pos0 = pos;
                    pos1 = pos;
                    if (input.substr(pos, 4) === "abs(") {
                      result0 = "abs(";
                      pos += 4;
                    } else {
                      result0 = null;
                      if (reportFailures === 0) {
                        matchFailed("\"abs(\"");
                      }
                    }
                    if (result0 !== null) {
                      result1 = parse__();
                      if (result1 !== null) {
                        result2 = parse_rollExpression();
                        if (result2 !== null) {
                          result3 = parse__();
                          if (result3 !== null) {
                            if (input.charCodeAt(pos) === 41) {
                              result4 = ")";
                              pos++;
                            } else {
                              result4 = null;
                              if (reportFailures === 0) {
                                matchFailed("\")\"");
                              }
                            }
                            if (result4 !== null) {
                              result0 = [result0, result1, result2, result3, result4];
                            } else {
                              result0 = null;
                              pos = pos1;
                            }
                          } else {
                            result0 = null;
                            pos = pos1;
                          }
                        } else {
                          result0 = null;
                          pos = pos1;
                        }
                      } else {
                        result0 = null;
                        pos = pos1;
                      }
                    } else {
                      result0 = null;
                      pos = pos1;
                    }
                    if (result0 !== null) {
                      result0 = (function(offset, rexp) {
                    
                        return mergeExpressions("abs(", mergeExpressions(rexp, ")"));
                      })(pos0, result0[2]);
                    }
                    if (result0 === null) {
                      pos = pos0;
                    }
                    if (result0 === null) {
                      pos0 = pos;
                      pos1 = pos;
                      if (input.charCodeAt(pos) === 40) {
                        result0 = "(";
                        pos++;
                      } else {
                        result0 = null;
                        if (reportFailures === 0) {
                          matchFailed("\"(\"");
                        }
                      }
                      if (result0 !== null) {
                        result1 = parse__();
                        if (result1 !== null) {
                          result2 = parse_rollExpression();
                          if (result2 !== null) {
                            result3 = parse__();
                            if (result3 !== null) {
                              if (input.charCodeAt(pos) === 41) {
                                result4 = ")";
                                pos++;
                              } else {
                                result4 = null;
                                if (reportFailures === 0) {
                                  matchFailed("\")\"");
                                }
                              }
                              if (result4 !== null) {
                                result0 = [result0, result1, result2, result3, result4];
                              } else {
                                result0 = null;
                                pos = pos1;
                              }
                            } else {
                              result0 = null;
                              pos = pos1;
                            }
                          } else {
                            result0 = null;
                            pos = pos1;
                          }
                        } else {
                          result0 = null;
                          pos = pos1;
                        }
                      } else {
                        result0 = null;
                        pos = pos1;
                      }
                      if (result0 !== null) {
                        result0 = (function(offset, rexp) {
                      
                          return mergeExpressions("(", mergeExpressions(rexp, ")"));
                        })(pos0, result0[2]);
                      }
                      if (result0 === null) {
                        pos = pos0;
                      }
                    }
                  }
                }
              }
            }
          }
        }
        return result0;
      }
      
      function parse_validRollSuffix() {
        var result0;
        var pos0;
        
        result0 = parse___();
        if (result0 === null) {
          result0 = parse_inlineLabelWithSpace();
          if (result0 === null) {
            if (input.charCodeAt(pos) === 125) {
              result0 = "}";
              pos++;
            } else {
              result0 = null;
              if (reportFailures === 0) {
                matchFailed("\"}\"");
              }
            }
            if (result0 === null) {
              if (input.charCodeAt(pos) === 44) {
                result0 = ",";
                pos++;
              } else {
                result0 = null;
                if (reportFailures === 0) {
                  matchFailed("\",\"");
                }
              }
              if (result0 === null) {
                if (input.charCodeAt(pos) === 41) {
                  result0 = ")";
                  pos++;
                } else {
                  result0 = null;
                  if (reportFailures === 0) {
                    matchFailed("\")\"");
                  }
                }
                if (result0 === null) {
                  pos0 = pos;
                  reportFailures++;
                  result0 = parse_operator();
                  reportFailures--;
                  if (result0 !== null) {
                    result0 = "";
                    pos = pos0;
                  } else {
                    result0 = null;
                  }
                  if (result0 === null) {
                    pos0 = pos;
                    reportFailures++;
                    if (input.length > pos) {
                      result0 = input.charAt(pos);
                      pos++;
                    } else {
                      result0 = null;
                      if (reportFailures === 0) {
                        matchFailed("any character");
                      }
                    }
                    reportFailures--;
                    if (result0 === null) {
                      result0 = "";
                    } else {
                      result0 = null;
                      pos = pos0;
                    }
                  }
                }
              }
            }
          }
        }
        return result0;
      }
      
      function parse_rollGroup() {
        var result0, result1, result2, result3, result4, result5;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        if (input.charCodeAt(pos) === 123) {
          result0 = "{";
          pos++;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("\"{\"");
          }
        }
        if (result0 !== null) {
          result1 = parse__();
          if (result1 !== null) {
            result2 = parse_rollGroupExpression();
            if (result2 !== null) {
              result3 = parse__();
              if (result3 !== null) {
                if (input.charCodeAt(pos) === 125) {
                  result4 = "}";
                  pos++;
                } else {
                  result4 = null;
                  if (reportFailures === 0) {
                    matchFailed("\"}\"");
                  }
                }
                if (result4 !== null) {
                  result5 = parse_groupMods();
                  result5 = result5 !== null ? result5 : "";
                  if (result5 !== null) {
                    result0 = [result0, result1, result2, result3, result4, result5];
                  } else {
                    result0 = null;
                    pos = pos1;
                  }
                } else {
                  result0 = null;
                  pos = pos1;
                }
              } else {
                result0 = null;
                pos = pos1;
              }
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, rolls, mod) {
            return new GroupExpression(rolls, mod);
          })(pos0, result0[2], result0[5]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_rollGroupExpression() {
        var result0, result1, result2, result3, result4;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        result0 = parse_rollExpression();
        if (result0 === null) {
          result0 = parse_rollGroup();
        }
        if (result0 !== null) {
          result1 = parse__();
          if (result1 !== null) {
            if (input.charCodeAt(pos) === 44) {
              result2 = ",";
              pos++;
            } else {
              result2 = null;
              if (reportFailures === 0) {
                matchFailed("\",\"");
              }
            }
            if (result2 !== null) {
              result3 = parse__();
              if (result3 !== null) {
                result4 = parse_rollGroupExpression();
                if (result4 !== null) {
                  result0 = [result0, result1, result2, result3, result4];
                } else {
                  result0 = null;
                  pos = pos1;
                }
              } else {
                result0 = null;
                pos = pos1;
              }
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, left, right) {
            if (!Array.isArray(left)) {
              left = [left];
            }
            if (right !== "") {
              return [left].concat(right);
            }
        
            return left;
          })(pos0, result0[0], result0[4]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        if (result0 === null) {
          pos0 = pos;
          result0 = parse_rollExpression();
          if (result0 === null) {
            result0 = parse_rollGroup();
          }
          if (result0 !== null) {
            result0 = (function(offset, left) { 
              return [left];
            })(pos0, result0);
          }
          if (result0 === null) {
            pos = pos0;
          }
        }
        return result0;
      }
      
      function parse_labelAwareRollOperator() {
        var result0, result1, result2;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        result0 = parse_rollOperator();
        if (result0 !== null) {
          result1 = [];
          result2 = parse_rollOperator();
          if (result2 === null) {
            result2 = parse_inlineLabelWithSpace();
          }
          while (result2 !== null) {
            result1.push(result2);
            result2 = parse_rollOperator();
            if (result2 === null) {
              result2 = parse_inlineLabelWithSpace();
            }
          }
          if (result1 !== null) {
            result0 = [result0, result1];
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, oper, addl) {
            var result = oper;
            for (var i = 0; i < addl.length; i++) {
              result = mergeExpressions(result, addl[i]);
            }
            return result;
          })(pos0, result0[0], result0[1]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        if (result0 === null) {
          pos0 = pos;
          pos1 = pos;
          result0 = parse_inlineLabelWithSpace();
          if (result0 !== null) {
            result1 = parse_labelAwareRollOperator();
            if (result1 !== null) {
              result0 = [result0, result1];
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
          if (result0 !== null) {
            result0 = (function(offset, lbl, oper) {
              return mergeExpressions(lbl, oper);
           })(pos0, result0[0], result0[1]);
          }
          if (result0 === null) {
            pos = pos0;
          }
        }
        return result0;
      }
      
      function parse_rollOperator() {
        var result0, result1, result2, result3, result4, result5, result6;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        result0 = parse__();
        if (result0 !== null) {
          result1 = parse_operator();
          if (result1 !== null) {
            result2 = parse__();
            if (result2 !== null) {
              result3 = parse_mathExpressionPrimary();
              if (result3 !== null) {
                result4 = parse__();
                if (result4 !== null) {
                  result5 = parse_rollOperator();
                  if (result5 !== null) {
                    result6 = parse__();
                    if (result6 !== null) {
                      result0 = [result0, result1, result2, result3, result4, result5, result6];
                    } else {
                      result0 = null;
                      pos = pos1;
                    }
                  } else {
                    result0 = null;
                    pos = pos1;
                  }
                } else {
                  result0 = null;
                  pos = pos1;
                }
              } else {
                result0 = null;
                pos = pos1;
              }
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, left, num, right) {
            return left + num + right;
          })(pos0, result0[1], result0[3], result0[5]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        if (result0 === null) {
          pos0 = pos;
          pos1 = pos;
          result0 = parse__();
          if (result0 !== null) {
            result1 = parse_operator();
            if (result1 !== null) {
              result2 = parse__();
              if (result2 !== null) {
                result0 = [result0, result1, result2];
              } else {
                result0 = null;
                pos = pos1;
              }
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
          if (result0 !== null) {
            result0 = (function(offset, oper) {
              return oper;
            })(pos0, result0[1]);
          }
          if (result0 === null) {
            pos = pos0;
          }
        }
        return result0;
      }
      
      function parse_fullRoll() {
        var result0, result1, result2;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        result0 = parse_coreRoll();
        if (result0 !== null) {
          result1 = parse_rollMods();
          result1 = result1 !== null ? result1 : "";
          if (result1 !== null) {
            result0 = [result0, result1];
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, roll, mod) {
            if (mod !== "") {
              roll.mods = mod;
            }
        
            return roll;
          })(pos0, result0[0], result0[1]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        if (result0 === null) {
          pos0 = pos;
          pos1 = pos;
          result0 = parse_numberOfDice();
          if (result0 !== null) {
            if (input.substr(pos, 1).toLowerCase() === "t") {
              result1 = input.substr(pos, 1);
              pos++;
            } else {
              result1 = null;
              if (reportFailures === 0) {
                matchFailed("\"t\"");
              }
            }
            if (result1 !== null) {
              result2 = parse_inlineLabel();
              if (result2 !== null) {
                result0 = [result0, result1, result2];
              } else {
                result0 = null;
                pos = pos1;
              }
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
          if (result0 !== null) {
            result0 = (function(offset, count, table) {
              return new TableRollExpression(count, table.text);
            })(pos0, result0[0], result0[2]);
          }
          if (result0 === null) {
            pos = pos0;
          }
        }
        return result0;
      }
      
      function parse_coreRoll() {
        var result0, result1, result2;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        result0 = parse_numberOfDice();
        if (result0 !== null) {
          if (input.substr(pos, 1).toLowerCase() === "d") {
            result1 = input.substr(pos, 1);
            pos++;
          } else {
            result1 = null;
            if (reportFailures === 0) {
              matchFailed("\"d\"");
            }
          }
          if (result1 !== null) {
            if (input.substr(pos, 1).toLowerCase() === "f") {
              result2 = input.substr(pos, 1);
              pos++;
            } else {
              result2 = null;
              if (reportFailures === 0) {
                matchFailed("\"f\"");
              }
            }
            if (result2 !== null) {
              result0 = [result0, result1, result2];
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, count) {
            return new FateRollExpression(count);
          })(pos0, result0[0]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        if (result0 === null) {
          pos0 = pos;
          pos1 = pos;
          result0 = parse_numberOfDice();
          if (result0 !== null) {
            if (input.substr(pos, 1).toLowerCase() === "d") {
              result1 = input.substr(pos, 1);
              pos++;
            } else {
              result1 = null;
              if (reportFailures === 0) {
                matchFailed("\"d\"");
              }
            }
            if (result1 !== null) {
              result2 = parse_numberOfSides();
              if (result2 !== null) {
                result0 = [result0, result1, result2];
              } else {
                result0 = null;
                pos = pos1;
              }
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
          if (result0 !== null) {
            result0 = (function(offset, count, sides) {
              return new RollExpression(count, sides);
            })(pos0, result0[0], result0[2]);
          }
          if (result0 === null) {
            pos = pos0;
          }
        }
        return result0;
      }
      
      function parse_numberOfDice() {
        var result0, result1, result2, result3, result4;
        var pos0, pos1;
        
        result0 = parse_integer();
        if (result0 === null) {
          pos0 = pos;
          pos1 = pos;
          if (input.charCodeAt(pos) === 40) {
            result0 = "(";
            pos++;
          } else {
            result0 = null;
            if (reportFailures === 0) {
              matchFailed("\"(\"");
            }
          }
          if (result0 !== null) {
            result1 = parse__();
            if (result1 !== null) {
              result2 = parse_mathExpression();
              if (result2 !== null) {
                result3 = parse__();
                if (result3 !== null) {
                  if (input.charCodeAt(pos) === 41) {
                    result4 = ")";
                    pos++;
                  } else {
                    result4 = null;
                    if (reportFailures === 0) {
                      matchFailed("\")\"");
                    }
                  }
                  if (result4 !== null) {
                    result0 = [result0, result1, result2, result3, result4];
                  } else {
                    result0 = null;
                    pos = pos1;
                  }
                } else {
                  result0 = null;
                  pos = pos1;
                }
              } else {
                result0 = null;
                pos = pos1;
              }
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
          if (result0 !== null) {
            result0 = (function(offset, expr) {
              return Math.round(eval("(" + expr + ")"));
            })(pos0, result0[2]);
          }
          if (result0 === null) {
            pos = pos0;
          }
          if (result0 === null) {
            pos0 = pos;
            result0 = "";
            if (result0 !== null) {
              result0 = (function(offset) { return 1; })(pos0);
            }
            if (result0 === null) {
              pos = pos0;
            }
          }
        }
        return result0;
      }
      
      function parse_numberOfSides() {
        var result0, result1, result2, result3, result4;
        var pos0, pos1;
        
        result0 = parse_integer();
        if (result0 === null) {
          pos0 = pos;
          pos1 = pos;
          if (input.charCodeAt(pos) === 40) {
            result0 = "(";
            pos++;
          } else {
            result0 = null;
            if (reportFailures === 0) {
              matchFailed("\"(\"");
            }
          }
          if (result0 !== null) {
            result1 = parse__();
            if (result1 !== null) {
              result2 = parse_mathExpression();
              if (result2 !== null) {
                result3 = parse__();
                if (result3 !== null) {
                  if (input.charCodeAt(pos) === 41) {
                    result4 = ")";
                    pos++;
                  } else {
                    result4 = null;
                    if (reportFailures === 0) {
                      matchFailed("\")\"");
                    }
                  }
                  if (result4 !== null) {
                    result0 = [result0, result1, result2, result3, result4];
                  } else {
                    result0 = null;
                    pos = pos1;
                  }
                } else {
                  result0 = null;
                  pos = pos1;
                }
              } else {
                result0 = null;
                pos = pos1;
              }
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
          if (result0 !== null) {
            result0 = (function(offset, expr) {
              return Math.round(eval("(" + expr + ")"));
            })(pos0, result0[2]);
          }
          if (result0 === null) {
            pos = pos0;
          }
          if (result0 === null) {
            pos0 = pos;
            if (input.substr(pos, 1).toLowerCase() === "f") {
              result0 = input.substr(pos, 1);
              pos++;
            } else {
              result0 = null;
              if (reportFailures === 0) {
                matchFailed("\"f\"");
              }
            }
            if (result0 !== null) {
              result0 = (function(offset) { return "F"; })(pos0);
            }
            if (result0 === null) {
              pos = pos0;
            }
          }
        }
        return result0;
      }
      
      function parse_groupMods() {
        var result0, result1, result2;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        result0 = parse_keepMod();
        if (result0 === null) {
          result0 = parse_dropMod();
          if (result0 === null) {
            result0 = parse_multipleMod();
            if (result0 === null) {
              result0 = parse_matchTotalMod();
              if (result0 === null) {
                result0 = parse_matchMod();
                if (result0 === null) {
                  result0 = parse_successMod();
                }
              }
            }
          }
        }
        if (result0 !== null) {
          result1 = [];
          result2 = parse_groupMods();
          while (result2 !== null) {
            result1.push(result2);
            result2 = parse_groupMods();
          }
          if (result1 !== null) {
            result0 = [result0, result1];
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, head, tail) {
            return processMods(head, tail);
          })(pos0, result0[0], result0[1]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_rollMods() {
        var result0, result1, result2;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        result0 = parse_compoundingMod();
        if (result0 === null) {
          result0 = parse_penetratingMod();
          if (result0 === null) {
            result0 = parse_explodingMod();
            if (result0 === null) {
              result0 = parse_keepMod();
              if (result0 === null) {
                result0 = parse_dropMod();
                if (result0 === null) {
                  result0 = parse_rerollOnceMod();
                  if (result0 === null) {
                    result0 = parse_rerollMod();
                    if (result0 === null) {
                      result0 = parse_customCritMod();
                      if (result0 === null) {
                        result0 = parse_customFumbleMod();
                        if (result0 === null) {
                          result0 = parse_sortMod();
                          if (result0 === null) {
                            result0 = parse_matchTotalMod();
                            if (result0 === null) {
                              result0 = parse_matchMod();
                              if (result0 === null) {
                                result0 = parse_successMod();
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
        if (result0 !== null) {
          result1 = [];
          result2 = parse_rollMods();
          while (result2 !== null) {
            result1.push(result2);
            result2 = parse_rollMods();
          }
          if (result1 !== null) {
            result0 = [result0, result1];
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, head, tail) {
            return processMods(head, tail);
          })(pos0, result0[0], result0[1]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_explodingMod() {
        var result0, result1;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        if (input.charCodeAt(pos) === 33) {
          result0 = "!";
          pos++;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("\"!\"");
          }
        }
        if (result0 !== null) {
          result1 = parse_comparisonPoint();
          result1 = result1 !== null ? result1 : "";
          if (result1 !== null) {
            result0 = [result0, result1];
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, cp) {
            return { 
              exploding: cp
            };
          })(pos0, result0[1]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_compoundingMod() {
        var result0, result1;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        if (input.substr(pos, 2) === "!!") {
          result0 = "!!";
          pos += 2;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("\"!!\"");
          }
        }
        if (result0 !== null) {
          result1 = parse_comparisonPoint();
          result1 = result1 !== null ? result1 : "";
          if (result1 !== null) {
            result0 = [result0, result1];
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, cp) {
            return { 
              compounding: cp
            };
          })(pos0, result0[1]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_penetratingMod() {
        var result0, result1, result2;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        if (input.charCodeAt(pos) === 33) {
          result0 = "!";
          pos++;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("\"!\"");
          }
        }
        if (result0 !== null) {
          if (input.substr(pos, 1).toLowerCase() === "p") {
            result1 = input.substr(pos, 1);
            pos++;
          } else {
            result1 = null;
            if (reportFailures === 0) {
              matchFailed("\"p\"");
            }
          }
          if (result1 !== null) {
            result2 = parse_comparisonPoint();
            result2 = result2 !== null ? result2 : "";
            if (result2 !== null) {
              result0 = [result0, result1, result2];
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, cp) {
            return { 
              penetrating: cp
            };
          })(pos0, result0[2]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_keepMod() {
        var result0, result1, result2;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        if (input.substr(pos, 1).toLowerCase() === "k") {
          result0 = input.substr(pos, 1);
          pos++;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("\"k\"");
          }
        }
        if (result0 !== null) {
          if (/^['h'|'l']/i.test(input.charAt(pos))) {
            result1 = input.charAt(pos);
            pos++;
          } else {
            result1 = null;
            if (reportFailures === 0) {
              matchFailed("['h'|'l']i");
            }
          }
          result1 = result1 !== null ? result1 : "";
          if (result1 !== null) {
            result2 = parse_integer();
            if (result2 !== null) {
              result0 = [result0, result1, result2];
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, hl, count) {
            return { 
              keep: {
                end: (hl.toLowerCase() || 'h'),
                count:count
              }
            };
          })(pos0, result0[1], result0[2]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_dropMod() {
        var result0, result1, result2;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        if (input.substr(pos, 1).toLowerCase() === "d") {
          result0 = input.substr(pos, 1);
          pos++;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("\"d\"");
          }
        }
        if (result0 !== null) {
          if (/^['h'|'l']/i.test(input.charAt(pos))) {
            result1 = input.charAt(pos);
            pos++;
          } else {
            result1 = null;
            if (reportFailures === 0) {
              matchFailed("['h'|'l']i");
            }
          }
          result1 = result1 !== null ? result1 : "";
          if (result1 !== null) {
            result2 = parse_integer();
            if (result2 !== null) {
              result0 = [result0, result1, result2];
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, hl, count) {
            return { 
              drop: {
                end: (hl.toLowerCase() || 'l'),
                count:count
              }
            };
          })(pos0, result0[1], result0[2]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_customCritMod() {
        var result0, result1, result2;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        if (input.substr(pos, 2).toLowerCase() === "cs") {
          result0 = input.substr(pos, 2);
          pos += 2;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("\"cs\"");
          }
        }
        if (result0 !== null) {
          result1 = parse_comparisonPoint();
          result1 = result1 !== null ? result1 : "";
          if (result1 !== null) {
            result2 = parse_customCritMod();
            result2 = result2 !== null ? result2 : "";
            if (result2 !== null) {
              result0 = [result0, result1, result2];
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, cp, tail) {
            var result = {
              customCrit: (cp !== "" ? [cp] : [{}])
            };
        
            if (tail !== "") {
              result.customCrit = result.customCrit.concat(tail.customCrit);
            }
        
            return result;
          })(pos0, result0[1], result0[2]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_customFumbleMod() {
        var result0, result1, result2;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        if (input.substr(pos, 2).toLowerCase() === "cf") {
          result0 = input.substr(pos, 2);
          pos += 2;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("\"cf\"");
          }
        }
        if (result0 !== null) {
          result1 = parse_comparisonPoint();
          result1 = result1 !== null ? result1 : "";
          if (result1 !== null) {
            result2 = parse_customFumbleMod();
            result2 = result2 !== null ? result2 : "";
            if (result2 !== null) {
              result0 = [result0, result1, result2];
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, cp, tail) {
            var result = {
              customFumble: (cp !== "" ? [cp] : [{}])
            };
        
            if (tail !== "") {
              result.customFumble = result.customFumble.concat(tail.customFumble);
            }
        
            return result;
          })(pos0, result0[1], result0[2]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_rerollMod() {
        var result0, result1, result2;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        if (input.substr(pos, 1).toLowerCase() === "r") {
          result0 = input.substr(pos, 1);
          pos++;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("\"r\"");
          }
        }
        if (result0 !== null) {
          result1 = parse_comparisonPoint();
          result1 = result1 !== null ? result1 : "";
          if (result1 !== null) {
            result2 = parse_rerollMod();
            result2 = result2 !== null ? result2 : "";
            if (result2 !== null) {
              result0 = [result0, result1, result2];
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, cp, tail) {
            var result = {
              reroll: (cp !== "" ? [cp] : [{}])
            };
        
            if (tail !== "") {
                result.reroll = result.reroll.concat(tail.reroll);
            }
        
            return result;
          })(pos0, result0[1], result0[2]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_rerollOnceMod() {
        var result0, result1, result2;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        if (input.substr(pos, 2).toLowerCase() === "ro") {
          result0 = input.substr(pos, 2);
          pos += 2;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("\"ro\"");
          }
        }
        if (result0 !== null) {
          result1 = parse_comparisonPoint();
          result1 = result1 !== null ? result1 : "";
          if (result1 !== null) {
            result2 = parse_rerollMod();
            result2 = result2 !== null ? result2 : "";
            if (result2 !== null) {
              result0 = [result0, result1, result2];
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, cp, tail) {
            var result = {
              reroll: (cp !== "" ? [cp] : [{}])
            };
        
            if (tail !== "") {
                result.reroll = result.reroll.concat(tail.reroll);
            }
        
            if(result.reroll && result.reroll[0]) result.reroll[0].maxrerolls = 1;
        
            return result;
          })(pos0, result0[1], result0[2]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_sortMod() {
        var result0, result1;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        if (input.substr(pos, 1).toLowerCase() === "s") {
          result0 = input.substr(pos, 1);
          pos++;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("\"s\"");
          }
        }
        if (result0 !== null) {
          if (/^['a'|'d']/i.test(input.charAt(pos))) {
            result1 = input.charAt(pos);
            pos++;
          } else {
            result1 = null;
            if (reportFailures === 0) {
              matchFailed("['a'|'d']i");
            }
          }
          result1 = result1 !== null ? result1 : "";
          if (result1 !== null) {
            result0 = [result0, result1];
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, order) {
            return { 
              sort: {
                order: (order.toLowerCase() || 'a')
              }
            };
          })(pos0, result0[1]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_floorMod() {
        var result0;
        var pos0;
        
        pos0 = pos;
        if (input.substr(pos, 3) === "flr") {
          result0 = "flr";
          pos += 3;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("\"flr\"");
          }
        }
        if (result0 !== null) {
          result0 = (function(offset) {
            return {
              round: {
                type: "floor"
              }
            };
          })(pos0);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_multipleMod() {
        var result0, result1;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        if (input.substr(pos, 1).toLowerCase() === "x") {
          result0 = input.substr(pos, 1);
          pos++;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("\"x\"");
          }
        }
        if (result0 !== null) {
          result1 = parse_integer();
          if (result1 !== null) {
            result0 = [result0, result1];
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, times) {
            return { 
              multiple: {
                times: times
              }
            };
          })(pos0, result0[1]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_successMod() {
        var result0, result1, result2;
        var pos0, pos1, pos2;
        
        pos0 = pos;
        pos1 = pos;
        result0 = parse_comparisonPoint();
        if (result0 !== null) {
          pos2 = pos;
          if (input.substr(pos, 1).toLowerCase() === "f") {
            result1 = input.substr(pos, 1);
            pos++;
          } else {
            result1 = null;
            if (reportFailures === 0) {
              matchFailed("\"f\"");
            }
          }
          if (result1 !== null) {
            result2 = parse_comparisonPoint();
            if (result2 !== null) {
              result1 = [result1, result2];
            } else {
              result1 = null;
              pos = pos2;
            }
          } else {
            result1 = null;
            pos = pos2;
          }
          result1 = result1 !== null ? result1 : "";
          if (result1 !== null) {
            result0 = [result0, result1];
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, cp, failure) {
            var result = { 
              success: cp
            };
        
            if (failure !== "") {
              result["failure"] = failure[1];
            }
        
            return result;
          })(pos0, result0[0], result0[1]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_matchMod() {
        var result0, result1, result2;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        if (input.charCodeAt(pos) === 109) {
          result0 = "m";
          pos++;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("\"m\"");
          }
        }
        if (result0 !== null) {
          result1 = parse_matchThreshold();
          if (result1 !== null) {
            result2 = parse_comparisonPoint();
            result2 = result2 !== null ? result2 : "";
            if (result2 !== null) {
              result0 = [result0, result1, result2];
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, mt, cp) {
            var result = {
              match: (cp !== "" ? cp : {})
            };
            result.match["threshold"] = mt;
        
            return result;
          })(pos0, result0[1], result0[2]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_matchTotalMod() {
        var result0, result1, result2;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        if (input.substr(pos, 2) === "mt") {
          result0 = "mt";
          pos += 2;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("\"mt\"");
          }
        }
        if (result0 !== null) {
          result1 = parse_matchThreshold();
          if (result1 !== null) {
            result2 = parse_comparisonPoint();
            result2 = result2 !== null ? result2 : "";
            if (result2 !== null) {
              result0 = [result0, result1, result2];
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, mt, cp) {
            var result = {
              match: (cp !== "" ? cp : {})
            };
            result.match["threshold"] = mt;
            result.match["total"] = true;
        
            return result;
          })(pos0, result0[1], result0[2]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_matchThreshold() {
        var result0, result1;
        var pos0;
        
        pos0 = pos;
        result0 = [];
        if (/^[0-9]/.test(input.charAt(pos))) {
          result1 = input.charAt(pos);
          pos++;
        } else {
          result1 = null;
          if (reportFailures === 0) {
            matchFailed("[0-9]");
          }
        }
        while (result1 !== null) {
          result0.push(result1);
          if (/^[0-9]/.test(input.charAt(pos))) {
            result1 = input.charAt(pos);
            pos++;
          } else {
            result1 = null;
            if (reportFailures === 0) {
              matchFailed("[0-9]");
            }
          }
        }
        if (result0 !== null) {
          result0 = (function(offset, num) { 
            var result = num && num != [] && parseInt(num.join(""), 10) > 2 ? parseInt(num.join(""), 10) : 2;
            return result
          })(pos0, result0);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_comparisonPoint() {
        var result0, result1;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        result0 = parse_comparison();
        result0 = result0 !== null ? result0 : "";
        if (result0 !== null) {
          result1 = parse_integer();
          if (result1 !== null) {
            result0 = [result0, result1];
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, comp, point) {
            return {
              comp:(comp == "" ? "=" : comp) + "=", 
              point:point
            };
          })(pos0, result0[0], result0[1]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_comparison() {
        var result0;
        
        if (/^[>|<|=]/.test(input.charAt(pos))) {
          result0 = input.charAt(pos);
          pos++;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("[>|<|=]");
          }
        }
        return result0;
      }
      
      function parse_mathExpression() {
        var result0, result1, result2, result3, result4, result5, result6;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        result0 = parse__();
        if (result0 !== null) {
          result1 = parse_mathExpressionPrimary();
          if (result1 !== null) {
            result2 = parse__();
            if (result2 !== null) {
              result3 = parse_operator();
              if (result3 !== null) {
                result4 = parse__();
                if (result4 !== null) {
                  result5 = parse_mathExpression();
                  if (result5 !== null) {
                    result6 = parse__();
                    if (result6 !== null) {
                      result0 = [result0, result1, result2, result3, result4, result5, result6];
                    } else {
                      result0 = null;
                      pos = pos1;
                    }
                  } else {
                    result0 = null;
                    pos = pos1;
                  }
                } else {
                  result0 = null;
                  pos = pos1;
                }
              } else {
                result0 = null;
                pos = pos1;
              }
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, left, oper, right) {
            return left + oper + right;
          })(pos0, result0[1], result0[3], result0[5]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        if (result0 === null) {
          pos0 = pos;
          pos1 = pos;
          result0 = parse__();
          if (result0 !== null) {
            result1 = parse_mathExpressionPrimary();
            if (result1 !== null) {
              result2 = parse__();
              if (result2 !== null) {
                result0 = [result0, result1, result2];
              } else {
                result0 = null;
                pos = pos1;
              }
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
          if (result0 !== null) {
            result0 = (function(offset, expr) {
              return expr;
            })(pos0, result0[1]);
          }
          if (result0 === null) {
            pos = pos0;
          }
        }
        return result0;
      }
      
      function parse_mathExpressionPrimary() {
        var result0, result1, result2, result3, result4;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        result0 = parse__();
        if (result0 !== null) {
          result1 = parse_number();
          if (result1 !== null) {
            result2 = parse__();
            if (result2 !== null) {
              result0 = [result0, result1, result2];
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, num) {
            return num;
          })(pos0, result0[1]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        if (result0 === null) {
          pos0 = pos;
          pos1 = pos;
          if (input.charCodeAt(pos) === 40) {
            result0 = "(";
            pos++;
          } else {
            result0 = null;
            if (reportFailures === 0) {
              matchFailed("\"(\"");
            }
          }
          if (result0 !== null) {
            result1 = parse__();
            if (result1 !== null) {
              result2 = parse_mathExpression();
              if (result2 !== null) {
                result3 = parse__();
                if (result3 !== null) {
                  if (input.charCodeAt(pos) === 41) {
                    result4 = ")";
                    pos++;
                  } else {
                    result4 = null;
                    if (reportFailures === 0) {
                      matchFailed("\")\"");
                    }
                  }
                  if (result4 !== null) {
                    result0 = [result0, result1, result2, result3, result4];
                  } else {
                    result0 = null;
                    pos = pos1;
                  }
                } else {
                  result0 = null;
                  pos = pos1;
                }
              } else {
                result0 = null;
                pos = pos1;
              }
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
          if (result0 !== null) {
            result0 = (function(offset, expr) {
              return "(" + expr + ")";
            })(pos0, result0[2]);
          }
          if (result0 === null) {
            pos = pos0;
          }
        }
        return result0;
      }
      
      function parse_inlineLabelWithSpace() {
        var result0, result1, result2;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        result0 = parse__();
        if (result0 !== null) {
          result1 = parse_inlineLabel();
          if (result1 !== null) {
            result2 = parse__();
            if (result2 !== null) {
              result0 = [result0, result1, result2];
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, lbl) { 
            return lbl;
          })(pos0, result0[1]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_inlineLabel() {
        var result0, result1, result2;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        if (input.charCodeAt(pos) === 91) {
          result0 = "[";
          pos++;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("\"[\"");
          }
        }
        if (result0 !== null) {
          result1 = [];
          if (/^[^\]]/.test(input.charAt(pos))) {
            result2 = input.charAt(pos);
            pos++;
          } else {
            result2 = null;
            if (reportFailures === 0) {
              matchFailed("[^\\]]");
            }
          }
          while (result2 !== null) {
            result1.push(result2);
            if (/^[^\]]/.test(input.charAt(pos))) {
              result2 = input.charAt(pos);
              pos++;
            } else {
              result2 = null;
              if (reportFailures === 0) {
                matchFailed("[^\\]]");
              }
            }
          }
          if (result1 !== null) {
            if (input.charCodeAt(pos) === 93) {
              result2 = "]";
              pos++;
            } else {
              result2 = null;
              if (reportFailures === 0) {
                matchFailed("\"]\"");
              }
            }
            if (result2 !== null) {
              result0 = [result0, result1, result2];
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, text) {
            return new Label(text.join(""));
          })(pos0, result0[1]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_operator() {
        var result0;
        
        if (/^[+|\-|*|\/|%]/.test(input.charAt(pos))) {
          result0 = input.charAt(pos);
          pos++;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("[+|\\-|*|\\/|%]");
          }
        }
        return result0;
      }
      
      function parse_number() {
        var result0;
        
        result0 = parse_exponent();
        if (result0 === null) {
          result0 = parse_float();
          if (result0 === null) {
            result0 = parse_signedInteger();
          }
        }
        return result0;
      }
      
      function parse_integer() {
        var result0, result1;
        var pos0;
        
        pos0 = pos;
        if (/^[0-9]/.test(input.charAt(pos))) {
          result1 = input.charAt(pos);
          pos++;
        } else {
          result1 = null;
          if (reportFailures === 0) {
            matchFailed("[0-9]");
          }
        }
        if (result1 !== null) {
          result0 = [];
          while (result1 !== null) {
            result0.push(result1);
            if (/^[0-9]/.test(input.charAt(pos))) {
              result1 = input.charAt(pos);
              pos++;
            } else {
              result1 = null;
              if (reportFailures === 0) {
                matchFailed("[0-9]");
              }
            }
          }
        } else {
          result0 = null;
        }
        if (result0 !== null) {
          result0 = (function(offset, digits) { 
            return parseInt(digits.join(""), 10);
          })(pos0, result0);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_signedInteger() {
        var result0, result1;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        if (/^[+|\-]/.test(input.charAt(pos))) {
          result0 = input.charAt(pos);
          pos++;
        } else {
          result0 = null;
          if (reportFailures === 0) {
            matchFailed("[+|\\-]");
          }
        }
        result0 = result0 !== null ? result0 : "";
        if (result0 !== null) {
          result1 = parse_integer();
          if (result1 !== null) {
            result0 = [result0, result1];
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, sign, int) {
           return sign == "-" ? -1 * int : int;
         })(pos0, result0[0], result0[1]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_float() {
        var result0, result1, result2, result3;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        result0 = parse_signedInteger();
        result0 = result0 !== null ? result0 : "";
        if (result0 !== null) {
          if (input.charCodeAt(pos) === 46) {
            result1 = ".";
            pos++;
          } else {
            result1 = null;
            if (reportFailures === 0) {
              matchFailed("\".\"");
            }
          }
          if (result1 !== null) {
            if (/^[0-9]/.test(input.charAt(pos))) {
              result3 = input.charAt(pos);
              pos++;
            } else {
              result3 = null;
              if (reportFailures === 0) {
                matchFailed("[0-9]");
              }
            }
            if (result3 !== null) {
              result2 = [];
              while (result3 !== null) {
                result2.push(result3);
                if (/^[0-9]/.test(input.charAt(pos))) {
                  result3 = input.charAt(pos);
                  pos++;
                } else {
                  result3 = null;
                  if (reportFailures === 0) {
                    matchFailed("[0-9]");
                  }
                }
              }
            } else {
              result2 = null;
            }
            if (result2 !== null) {
              result0 = [result0, result1, result2];
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, int, dec) {
            //Check for -0 for stuff like -0.5 starting an expression.
            if(int === 0 && (1/int < 0)) return (-1.0 * parseFloat(int + "." + dec.join("")));
            else return parseFloat(int + "." + dec.join(""));
          })(pos0, result0[0], result0[2]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse_exponent() {
        var result0, result1, result2, result3, result4;
        var pos0, pos1;
        
        pos0 = pos;
        pos1 = pos;
        result0 = parse_signedInteger();
        result0 = result0 !== null ? result0 : "";
        if (result0 !== null) {
          if (input.charCodeAt(pos) === 46) {
            result1 = ".";
            pos++;
          } else {
            result1 = null;
            if (reportFailures === 0) {
              matchFailed("\".\"");
            }
          }
          if (result1 !== null) {
            result2 = parse_integer();
            if (result2 !== null) {
              if (input.charCodeAt(pos) === 101) {
                result3 = "e";
                pos++;
              } else {
                result3 = null;
                if (reportFailures === 0) {
                  matchFailed("\"e\"");
                }
              }
              if (result3 !== null) {
                result4 = parse_signedInteger();
                if (result4 !== null) {
                  result0 = [result0, result1, result2, result3, result4];
                } else {
                  result0 = null;
                  pos = pos1;
                }
              } else {
                result0 = null;
                pos = pos1;
              }
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
        } else {
          result0 = null;
          pos = pos1;
        }
        if (result0 !== null) {
          result0 = (function(offset, int, dec, exp) { 
            return parseFloat(int + "." + dec + "e" + exp);
          })(pos0, result0[0], result0[2], result0[4]);
        }
        if (result0 === null) {
          pos = pos0;
        }
        if (result0 === null) {
          pos0 = pos;
          pos1 = pos;
          result0 = parse_signedInteger();
          if (result0 !== null) {
            if (input.charCodeAt(pos) === 101) {
              result1 = "e";
              pos++;
            } else {
              result1 = null;
              if (reportFailures === 0) {
                matchFailed("\"e\"");
              }
            }
            if (result1 !== null) {
              result2 = parse_signedInteger();
              if (result2 !== null) {
                result0 = [result0, result1, result2];
              } else {
                result0 = null;
                pos = pos1;
              }
            } else {
              result0 = null;
              pos = pos1;
            }
          } else {
            result0 = null;
            pos = pos1;
          }
          if (result0 !== null) {
            result0 = (function(offset, int, exp) { 
              return parseFloat(int + "e" + exp);
            })(pos0, result0[0], result0[2]);
          }
          if (result0 === null) {
            pos = pos0;
          }
        }
        return result0;
      }
      
      function parse__() {
        var result0, result1;
        var pos0;
        
        pos0 = pos;
        result0 = [];
        if (/^[ |\t]/.test(input.charAt(pos))) {
          result1 = input.charAt(pos);
          pos++;
        } else {
          result1 = null;
          if (reportFailures === 0) {
            matchFailed("[ |\\t]");
          }
        }
        while (result1 !== null) {
          result0.push(result1);
          if (/^[ |\t]/.test(input.charAt(pos))) {
            result1 = input.charAt(pos);
            pos++;
          } else {
            result1 = null;
            if (reportFailures === 0) {
              matchFailed("[ |\\t]");
            }
          }
        }
        if (result0 !== null) {
          result0 = (function(offset, space) {
            return space.join("");
          })(pos0, result0);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      function parse___() {
        var result0, result1;
        var pos0;
        
        pos0 = pos;
        if (/^[ |\t]/.test(input.charAt(pos))) {
          result1 = input.charAt(pos);
          pos++;
        } else {
          result1 = null;
          if (reportFailures === 0) {
            matchFailed("[ |\\t]");
          }
        }
        if (result1 !== null) {
          result0 = [];
          while (result1 !== null) {
            result0.push(result1);
            if (/^[ |\t]/.test(input.charAt(pos))) {
              result1 = input.charAt(pos);
              pos++;
            } else {
              result1 = null;
              if (reportFailures === 0) {
                matchFailed("[ |\\t]");
              }
            }
          }
        } else {
          result0 = null;
        }
        if (result0 !== null) {
          result0 = (function(offset, space) {
            return space.join("");
          })(pos0, result0);
        }
        if (result0 === null) {
          pos = pos0;
        }
        return result0;
      }
      
      
      function cleanupExpected(expected) {
        expected.sort();
        
        var lastExpected = null;
        var cleanExpected = [];
        for (var i = 0; i < expected.length; i++) {
          if (expected[i] !== lastExpected) {
            cleanExpected.push(expected[i]);
            lastExpected = expected[i];
          }
        }
        return cleanExpected;
      }
      
      function computeErrorPosition() {
        /*
         * The first idea was to use |String.split| to break the input up to the
         * error position along newlines and derive the line and column from
         * there. However IE's |split| implementation is so broken that it was
         * enough to prevent it.
         */
        
        var line = 1;
        var column = 1;
        var seenCR = false;
        
        for (var i = 0; i < Math.max(pos, rightmostFailuresPos); i++) {
          var ch = input.charAt(i);
          if (ch === "\n") {
            if (!seenCR) { line++; }
            column = 1;
            seenCR = false;
          } else if (ch === "\r" || ch === "\u2028" || ch === "\u2029") {
            line++;
            column = 1;
            seenCR = true;
          } else {
            column++;
            seenCR = false;
          }
        }
        
        return { line: line, column: column };
      }
      
      
        //Setup TYPE_* variables in the d20 namespace so that at runtime the same constants
        // are used by all scripts
        var d20 = (typeof window !== 'undefined' && window.d20 !== undefined) ? window.d20 : {};
        if (d20.dice == undefined) {
          d20.dice = d20.dice || {};
          d20.dice.TYPE_MATH_EXPR = "M";
          d20.dice.TYPE_ROLL_EXPR = "R";
          d20.dice.TYPE_GROUP_EXPR = "G";
          d20.dice.TYPE_LABEL = "L";
          d20.dice.TYPE_COMMENT = "C";
          d20.dice.TYPE_VALIDATED_ROLLS = "V";
        }
        
        function log(d) {
           console.log(d);
        }
        
        /**
         * Creates a new math expression
         * 
         * @param expr Base expression, defaults to ""
         */
        function MathExpression(expr) {
           this.type = d20.dice.TYPE_MATH_EXPR;
           this.expr = (expr != undefined ? expr : "");
        };
        
        /**
         * Creates a new roll expression
         * 
         * @param dice Number of dice to roll
         * @param sides Number of sides on the dice
         */
        function RollExpression(dice, sides) {
          this.type = d20.dice.TYPE_ROLL_EXPR;
          this.dice = dice;
          this.sides = sides;
          this.mods = {};
        };
      
        /**
         * Creates a new fate roll expression
         */
        function FateRollExpression(dice, table) {
          this.type = d20.dice.TYPE_ROLL_EXPR;
          this.dice = dice;
          this.fate = true;
          this.mods = {};
        };
      
        /**
         * Creates a new table roll expression
         */
        function TableRollExpression(dice, table) {
          this.type = d20.dice.TYPE_ROLL_EXPR;
          this.dice = dice;
          this.table = table;
          this.mods = {};
        };
      
        /**
         * Creates a new group expression
         * 
         * @param rolls The array of rolls that are members of the group
         */
        function GroupExpression(rolls, mods) {
          this.type = d20.dice.TYPE_GROUP_EXPR;
          this.rolls = rolls;
          this.mods = (mods || {});
        }
      
        /**
         * Creates a new label
         * 
         * @param text content of the label
         */
        function Label(text) {
          this.type = d20.dice.TYPE_LABEL;
          this.text = text;
        }
      
        /**
         * Creates a new comment
         * 
         * @param text content of the comment
         */
        function Comment(text) {
          this.type = d20.dice.TYPE_COMMENT;
          this.text = text;
        }
        
        /**
         * Merge two expressions or arrays of expressions. For both arguments strings,
         * single expressions, and arrays of expressions are all valid.
         * 
         * String arguments are converted into MathExpressions
         * Adjacent MathExpressions are merged into a single MathExpression
         * 
         * @returns array of expressions
         */
        function mergeExpressions(left, right) {
           //If left is a string convert to MathExpression
           if (typeof left == "string") {
              if (left.length == 0) {
                return right;
              }
              left = new MathExpression(left);
           }
           //If right is a string convert to MathExpression
           if (typeof right == "string") {
              if (right.length == 0) {
                return left;
              }
              right = new MathExpression(right);
           }
      
           //If both left and right are arrays merge into a single array
           if (Array.isArray(left) && Array.isArray(right)) {
             //If end of left and start of right are both math expressions
             if (left[left.length-1].type == d20.dice.TYPE_MATH_EXPR && right[0].type == d20.dice.TYPE_MATH_EXPR) {
               //Remove the end of the left
               var leftMath = left.pop();
               //Merge the end of the left to the start of the right
               right[0].expr = leftMath.expr + right[0].expr;
             }
             
             //Merge the two arrays
             return left.concat(right);
           }
           //Left is an array, right is an object
           else if (Array.isArray(left)) {
             //End of the left and right are math expressions, append right onto the end of left
             if (left[left.length-1].type == d20.dice.TYPE_MATH_EXPR && right.type == d20.dice.TYPE_MATH_EXPR) {
               left[left.length-1].expr += right.expr;
             }
             //End of the left is not a math expression, append right to the left array
             else {
               left.push(right);
             }
             
             return left;
           }
           //Right is an array, left is an object
           else if (Array.isArray(right)) {
             //Start of the right and left are math expressions, prepend left onto the start of right
             if (right[0].type == d20.dice.TYPE_MATH_EXPR && left.type == d20.dice.TYPE_MATH_EXPR) {
               right[0].expr = left.expr + right[0].expr;
             }
             //Start of the right is not a math expression, prepend left to the right array
             else {
               right.unshift(left);
             }
             
             return right;
           }
           //If both left and right are single math expressions append right to left
           //and return left
           else if (left.type == d20.dice.TYPE_MATH_EXPR && right.type == d20.dice.TYPE_MATH_EXPR) {
             left.expr += right.expr;
             return left;
           }
           
           //Left and Right are not arrays
           return [left, right];
        }
        
        /**
         * Process roll/group mods into a single object
         * @returns The complete object
         */
        function processMods(head, tail) {
          var result = head;
          if (tail.length > 0) {
            for (var attrname in tail[0]) {
              if (result[attrname] != undefined) {
                throw {message:"'" + attrname + "' roll modifier can only be specified once"};
              }
              result[attrname] = tail[0][attrname];
            }
          }
          return result;
        };
      
      
      var result = parseFunctions[startRule]();
      
      /*
       * The parser is now in one of the following three states:
       *
       * 1. The parser successfully parsed the whole input.
       *
       *    - |result !== null|
       *    - |pos === input.length|
       *    - |rightmostFailuresExpected| may or may not contain something
       *
       * 2. The parser successfully parsed only a part of the input.
       *
       *    - |result !== null|
       *    - |pos < input.length|
       *    - |rightmostFailuresExpected| may or may not contain something
       *
       * 3. The parser did not successfully parse any part of the input.
       *
       *   - |result === null|
       *   - |pos === 0|
       *   - |rightmostFailuresExpected| contains at least one failure
       *
       * All code following this comment (including called functions) must
       * handle these states.
       */
      if (result === null || pos !== input.length) {
        var offset = Math.max(pos, rightmostFailuresPos);
        var found = offset < input.length ? input.charAt(offset) : null;
        var errorPosition = computeErrorPosition();
        
        throw new this.SyntaxError(
          cleanupExpected(rightmostFailuresExpected),
          found,
          offset,
          errorPosition.line,
          errorPosition.column
        );
      }
      
      return result;
    },
    
    /* Returns the parser source code. */
    toSource: function() { return this._source; }
  };
  
  /* Thrown when a parser encounters a syntax error. */
  
  result.SyntaxError = function(expected, found, offset, line, column) {
    function buildMessage(expected, found) {
      var expectedHumanized, foundHumanized;
      
      switch (expected.length) {
        case 0:
          expectedHumanized = "end of input";
          break;
        case 1:
          expectedHumanized = expected[0];
          break;
        default:
          expectedHumanized = expected.slice(0, expected.length - 1).join(", ")
            + " or "
            + expected[expected.length - 1];
      }
      
      foundHumanized = found ? quote(found) : "end of input";
      
      return "Expected " + expectedHumanized + " but " + foundHumanized + " found.";
    }
    
    this.name = "SyntaxError";
    this.expected = expected;
    this.found = found;
    this.message = buildMessage(expected, found);
    this.offset = offset;
    this.line = line;
    this.column = column;
  };
  
  result.SyntaxError.prototype = Error.prototype;
  
  return result;
})();

d20.dice_formatter = {};
d20ext["dice_formatter"] = d20.dice_formatter;

(function() {

	var showCritAnimation = function() {

		return;

		if(d20.textchat.chatstartingup) return;

		$("#critanimation").addClass("critted");
		$("#maincanvas").addClass("critted");
		setTimeout(function() {
			$("#critanimation").removeClass("critted");
			$("#maincanvas").removeClass("critted");
		}, 2000);
	}
	
	var formatRolls = function(rolls) {

		var formula = "";

		for(var i=0; i < rolls.length; i++) {

			if(rolls[i].type === d20.dice.TYPE_GROUP_EXPR) {
				formula += "{<div class='parsegroup'>"
				for(var gi=0; gi < rolls[i].rolls.length; gi++) {
					formula += "<div class='parsegroupitem ";
					if(rolls[i].results && rolls[i].results[gi].d) {
						formula += "dropped";
					}
					formula += "'>";
					formula += formatRolls(rolls[i].rolls[gi]);
					if(gi + 1 < rolls[i].rolls.length) {
						formula += " + "
					}
					formula += "</div>";
				}
				formula += "</div>}";
			}

			if(rolls[i].type === d20.dice.TYPE_ROLL_EXPR) {
				formula += "<div class='dicegrouping' data-groupindex='"+i+"' "

				//Is the next one a label? if so add a title
				if(rolls[i+1] && rolls[i+1].type == d20.dice.TYPE_LABEL) {
					formula += "title='"+rolls[i+1].text.replace(/'/g, "&apos;")+"'"
				}

				formula += ">";
				formula += "(";
				for (var r = 0; r < rolls[i].results.length; r++) {
					formula += "<div data-origindex='"+r+"' class='diceroll "

					if(rolls[i].results.length > 50) {
						formula += "withouticons ";
					}

					if(rolls[i].fate) {
						formula += "d6";
					}
					else if(!rolls[i].table) {
						formula += "d" + rolls[i].sides;
					}

					if(rolls[i].results[r].d === true) {
						formula += " dropped ";
					}

					var didCrit = false;
					var didFumble = false;
					var didMatch = false;

					if(rolls[i].mods && rolls[i].mods.customCrit) {
						//Check each to see if we critted.
						_.each(rolls[i].mods.customCrit, function(csdef) {
							if(csdef.comp === "<=") {
								if(rolls[i].results[r].v <= csdef.point) didCrit = true;
							}
							else if(csdef.comp === ">=") {
								if(rolls[i].results[r].v >= csdef.point) didCrit = true;
							}
							else if(csdef.comp === "==") {
								if(rolls[i].results[r].v === csdef.point) didCrit = true;
							}
						});
					}
					else if(rolls[i].results[r].v === rolls[i].sides) {
						didCrit = true;
					}

					if(didCrit) {
						formula += " critsuccess ";
						showCritAnimation();
					}

					if(rolls[i].mods && rolls[i].mods.customFumble) {
						//Check each to see if we critted.
						_.each(rolls[i].mods.customFumble, function(csdef) {
							if(csdef.comp === "<=") {
								if(rolls[i].results[r].v <= csdef.point) didFumble = true;
							}
							else if(csdef.comp === ">=") {
								if(rolls[i].results[r].v >= csdef.point) didFumble = true;
							}
							else if(csdef.comp === "==") {
								if(rolls[i].results[r].v === csdef.point) didFumble = true;
							}
						});
					}
					else if(rolls[i].results[r].v === 1 && rolls[i].fate !== true) {
						didFumble = true;
					}

					if(didFumble) {
						formula += " critfail ";
					}

					if(rolls[i].mods && rolls[i].mods.match && rolls[i].mods.match.matches[rolls[i].results[r].v]) {
						didMatch = true;
					}

					if(didMatch) {
						formula += " match-" + rolls[i].mods.match.matches[rolls[i].results[r].v] + "";
					}

					formula += "'>";

					if(didMatch) {
						formula += "<div class='matchbar' style='border-color:" + rolls[i].mods.match.matches[rolls[i].results[r].v] + "'></div>";
					}

					formula += "<div class='dicon'><div class='didroll'>"; 
					if (rolls[i].fate === true) {
						switch(rolls[i].results[r].v) {
							case 1: 
								formula += "+";
								break;
							case 0: 
								formula += "0";
								break;
							case -1:
								formula += "-";
								break;
						}
					}
					else if(rolls[i].results[r].tableItem) {
						if(rolls[i].results[r].tableItem.avatar && rolls[i].results[r].tableItem.avatar !== "") {
							const avatar = rolls[i].results[r].tableItem.avatar.replace("/med.webm", "/thumb.webm");
							const title = d20ext.utils.strip_tags(rolls[i].results[r].tableItem.name).replace(/'/g, "&apos;");
							
							formula += d20.utils.isVideo(avatar) ?
								`<video src="${avatar}" title="${title}" muted autoplay loop />` :
								`<img src="${avatar}" title="${title}" />`;
						}
						else {
							formula += d20ext.utils.strip_tags(rolls[i].results[r].tableItem.name);
						}
					}
					else {
						formula += rolls[i].results[r].v;
					}

					formula += "</div><div class='backing'></div></div>";

					if (rolls[i].fate !== true && r + 1 < rolls[i].results.length) {
						formula += "+";
					}

					formula += "</div>";
				}
				formula += ")";
				formula += "</div>";
			}

			else if(rolls[i].type === d20.dice.TYPE_MATH_EXPR) {
				formula += rolls[i].expr;
			}

		}

		return formula;
	};

	var textOnlyFormatRolls = function(rolls) {

		var formula = "";

		for(var i=0; i < rolls.length; i++) {

			if(rolls[i].type === d20.dice.TYPE_GROUP_EXPR) {
				formula += "{"
				for(var gi=0; gi < rolls[i].rolls.length; gi++) {
					formula += textOnlyFormatRolls(rolls[i].rolls[gi]);
					if(gi + 1 < rolls[i].rolls.length) {
						formula += "+"
					}
				}
				formula += "}";
			}

			if(rolls[i].type === d20.dice.TYPE_ROLL_EXPR) {
				var rl = rolls[i].results !== undefined ? rolls[i].results.length : 0;
				formula += "(";
				for (var r = 0; r < rl; r++) {
					if (rolls[i].fate === true) {
						switch(rolls[i].results[r].v) {
							case 1: 
								formula += "+";
								break;
							case 0: 
								formula += "0";
								break;
							case -1:
								formula += "-";
								break;
						}
					}
					else if(rolls[i].results[r].tableItem) {
						formula += d20ext.utils.strip_tags(rolls[i].results[r].tableItem.name);
					}
					else {
						formula += rolls[i].results[r].v;
					}

					if (rolls[i].fate !== true && r + 1 < rolls[i].results.length) {
						formula += "+";
					}
				}
				formula += ")";
			}

			else if(rolls[i].type === d20.dice.TYPE_MATH_EXPR) {
				formula += rolls[i].expr;
			}

		}

		return formula;

	};

	var basicHTMLFormatRolls = function(rolls) {

		if(!rolls) return;

		var formula = "";

		for(var i=0; i < rolls.length; i++) {
			if(rolls[i].type === d20.dice.TYPE_GROUP_EXPR) {
				formula += "{"
				for(var gi=0; gi < rolls[i].rolls.length; gi++) {
					formula += basicHTMLFormatRolls(rolls[i].rolls[gi]);
					if(gi + 1 < rolls[i].rolls.length) {
						formula += "+"
					}
				}
				formula += "}";
			}

			if(rolls[i].type === d20.dice.TYPE_ROLL_EXPR) {
				var rl = rolls[i].results !== undefined ? rolls[i].results.length : 0;
				var matches = rolls[i].mods && rolls[i].mods.match && rolls[i].mods.match.matches ? rolls[i].mods.match.matches : [];
				formula += "(";
				for (var r = 0; r < rl; r++) {

					formula += "<span class='basicdiceroll";

					if(rolls[i].results[r].d) {
						formula += " dropped";
					}
					else {
						var didCrit = false;
						var didFumble = false;
						if(rolls[i].mods && rolls[i].mods.customCrit) {
							//Check each to see if we critted.
							_.each(rolls[i].mods.customCrit, function(csdef) {
								if(csdef.comp === "<=") {
									if(rolls[i].results[r].v <= csdef.point) didCrit = true;
								}
								else if(csdef.comp === ">=") {
									if(rolls[i].results[r].v >= csdef.point) didCrit = true;
								}
								else if(csdef.comp === "==") {
									if(rolls[i].results[r].v === csdef.point) didCrit = true;
								}
							});
						}
						else if(rolls[i].results[r].v === rolls[i].sides) {
							didCrit = true;
						}

						if(didCrit) {
							formula += " critsuccess ";
						}

						if(rolls[i].mods && rolls[i].mods.customFumble) {
							//Check each to see if we critted.
							_.each(rolls[i].mods.customFumble, function(csdef) {
								if(csdef.comp === "<=") {
									if(rolls[i].results[r].v <= csdef.point) didFumble = true;
								}
								else if(csdef.comp === ">=") {
									if(rolls[i].results[r].v >= csdef.point) didFumble = true;
								}
								else if(csdef.comp === "==") {
									if(rolls[i].results[r].v === csdef.point) didFumble = true;
								}
							});
						}
						else if(rolls[i].results[r].v === 1 && rolls[i].fate !== true) {
							didFumble = true;
						}

						if(didFumble) {
							formula += " critfail ";
						}
					}

					if(matches != [] && matches[rolls[i].results[r].v]) {
						formula += "' style='color: " + matches[rolls[i].results[r].v] + "'";
					}

					formula += "'>";

					if (rolls[i].fate === true) {
						switch(rolls[i].results[r].v) {
							case 1: 
								formula += "+";
								break;
							case 0: 
								formula += "0";
								break;
							case -1:
								formula += "-";
								break;
						}
					}
					else if(rolls[i].results[r].tableItem) {
						formula += d20ext.utils.strip_tags(rolls[i].results[r].tableItem.name);
					}
					else {
						formula += rolls[i].results[r].v;
					}

					formula += "</span>";

					if (rolls[i].fate !== true && r + 1 < rolls[i].results.length) {
						formula += "+";
					}
				}
				formula += ")";
			}

			else if(rolls[i].type === d20.dice.TYPE_MATH_EXPR) {
				formula += rolls[i].expr;
			}

		}

		return formula;

	};

	d20.dice_formatter.checkForCrits = function(rolls, crittype) {

		if(!rolls) return false;

		var didCrit = false;
		var didFumble = false;

		for(var i=0; i < rolls.length; i++) {

			if(rolls[i].type === d20.dice.TYPE_GROUP_EXPR) {
				for(var gi=0; gi < rolls[i].rolls.length; gi++) {
					if(d20.dice_formatter.checkForCrits(rolls[i].rolls[gi], crittype) === true) {
						if(crittype === "crit") 
							didCrit = true;
						else 
							didFumble = true;
					}
				}
			}

			if(rolls[i].type === d20.dice.TYPE_ROLL_EXPR) {
				var rl = rolls[i].results !== undefined ? rolls[i].results.length : 0;
				for (var r = 0; r < rl; r++) {
					// Skip dropped dice so they can't trigger WasCrit or WasFumble
					if(rolls[i].results[r].d === true) continue;

					if(rolls[i].mods && rolls[i].mods.customCrit) {
						//Check each to see if we critted.
						_.each(rolls[i].mods.customCrit, function(csdef) {
							if(csdef.comp === "<=") {
								if(rolls[i].results[r].v <= csdef.point) didCrit = true;
							}
							else if(csdef.comp === ">=") {
								if(rolls[i].results[r].v >= csdef.point) didCrit = true;
							}
							else if(csdef.comp === "==") {
								if(rolls[i].results[r].v === csdef.point) didCrit = true;
							}
						});
					}
					else if(rolls[i].results[r].v === rolls[i].sides) {
						didCrit = true;
					}

					if(rolls[i].mods && rolls[i].mods.customFumble) {
						//Check each to see if we critted.
						_.each(rolls[i].mods.customFumble, function(csdef) {
							if(csdef.comp === "<=") {
								if(rolls[i].results[r].v <= csdef.point) didFumble = true;
							}
							else if(csdef.comp === ">=") {
								if(rolls[i].results[r].v >= csdef.point) didFumble = true;
							}
							else if(csdef.comp === "==") {
								if(rolls[i].results[r].v === csdef.point) didFumble = true;
							}
						});
					}
					else if(rolls[i].results[r].v === 1 && rolls[i].fate !== true) {
						didFumble = true;
					}
				}
			}
		}

		return (crittype === "crit" ? didCrit : didFumble);
	}

	d20.dice_formatter.getHtmlForResult = function(resultObj) {
		var formula = formatRolls(resultObj.rolls);
		var total = resultObj.total;

		if(resultObj.resultType === d20.dice.ROLL_TYPE_SUCCESS) {
			total = total === 1 ? total + " Success" : total + " Successes";
		}
		else if(resultObj.resultType === d20.dice.ROLL_TYPE_MATCH) {
			total = total === 1 ? total + " Match" : total + " Matches";
		}

		return {
			formula: formula,
			total: total
		}
	};

	d20.dice_formatter.replaceInlineRolls = function(textcontent, op, allowedTags) {
		// textcontent = d20.utils.strip_tags(textcontent.replace("<","&lt;"), allowedTags);
		textcontent = d20.utils.strip_tags(textcontent, allowedTags);
		if(!op.inlinerolls) return textcontent;
		textcontent = textcontent.replace(/\$\[\[[0-9]+(\.computed)?\]\]/g, function(inlinematch) {
			const strippedMatch = inlinematch.replace(/[\$\[\[\]\]]/g, '');
			// Check whether we're looking for the computed value
			const computed = strippedMatch.substr(-9) === '.computed' ? true : false;
			var inlinerollindex = strippedMatch.split('.')[0];
			var inlineroll = op.inlinerolls[parseInt(inlinerollindex, 10)];
			if(!inlineroll || !inlineroll.results) {
				return "INVALID INLINE ROLL!";
			}

			inlineroll.expression = inlineroll.expression.replace("<","&lt;");
			var mytitle = "Rolling " + d20.utils.strip_tags(inlineroll.expression, allowedTags) + " = ";

			if(inlineroll.signature && d20.textchat.verifyRoll(inlineroll.rollid, inlineroll.results, inlineroll.signature)) {
				mytitle = "<img src='/images/quantumrollwhite.png' class='inlineqroll'> " + mytitle;
			}

			mytitle += basicHTMLFormatRolls(inlineroll.results.rolls);

			// Use the computed result if requested
			// Note that if a computed value isn't present, the total will be used
			var mytotal = computed && inlineroll.computed !== undefined ? inlineroll.computed :inlineroll.results.total;
			try {
				if(mytotal == 0 && inlineroll.results.rolls[0].results[0].tableItem) mytotal = d20ext.utils.strip_tags(inlineroll.results.rolls[0].results[0].tableItem.name);
			}
			catch(e) {
				//discard
			}

			var myhtml = "<span class='inlinerollresult showtip tipsy-n-right";
			var hascrit = mytitle.indexOf("critsuccess") !== -1;
			var hasfail = mytitle.indexOf("critfail") !== -1;

			if(hascrit && hasfail) {
				myhtml += " importantroll";
			}
			else if(hascrit) {
				myhtml += " fullcrit";
			}
			else if(hasfail) {
				myhtml += " fullfail";
			}

			myhtml += "' title='"+mytitle.replace(/'/g, "&quot;")+"'>" + mytotal + "</span>";

			return myhtml;

		});

		return textcontent;
	};

	/**
	* Associate format markers with CSS classes
	*/
	var rollFormats = {
		"@": "critsuccess",
		"#": "critfail",
		"_": "dropped"
	};

	/**
	* Determines all nessted formatting rules 
	*/
	var getAllFormats = function(roll, formats) {
		for (var formatType in rollFormats) {
			var pattern = new RegExp("\\{" + formatType + "(.+?)" + formatType + "\\}", "g");
			var match;
			if ((match = pattern.exec(roll)) != null) {
				formats.push( rollFormats[formatType] );
				return getAllFormats(match[1], formats);
			}
		}

		return roll;
	}

	/**
	* Formats a dice roll string into HTML
	*/
	d20.dice_formatter.oldformat = function(rollResult) {
		if(rollResult === undefined) {
			return "";
		}
		return rollResult.replace(/\{([@#_])(.+?)\1\}/g, function(roll, formatType, value) {
			var formats = [ rollFormats[formatType] ];
			var value = getAllFormats(value, formats);

			return "<span class='" + formats.sort().join(" ") + "'>" + value + "</span>";
		});
	}
	
})();

d20.dice_engine = function(seed) {
	d20.dice = d20.dice || {};
	d20.dice.TYPE_MATH_EXPR = "M";
	d20.dice.TYPE_ROLL_EXPR = "R";
	d20.dice.TYPE_GROUP_EXPR = "G";
	d20.dice.TYPE_LABEL = "L";
	d20.dice.TYPE_COMMENT = "C";
	d20.dice.TYPE_VALIDATED_ROLLS = "V";
	d20.dice.ROLL_TYPE_MATCH = "match";
	d20.dice.ROLL_TYPE_SUCCESS = "success";
	d20.dice.ROLL_TYPE_TABLE = "table";
	d20.dice.ROLL_TYPE_SUM = "sum";
	d20.dice.MATCH_COLORS = ["#ee0086","#ff9c00","#688de8","#a6f900","#a909e1","#ff6a00","#07afde","#eefe00"];

	if (d20.getTableElementCount == undefined) {
		d20.getTableElementCount = function(name) {
			log("Using fallback getTableElementCount(" + name + ")");
			return name.length;
		};
		d20.getTableElementValue = function(name, index) {
			log("Using fallback getTableElementValue(" + name + ", " + index + ")");
			return parseInt(name, 10) || 0;
		};
	}

	var MAX_NUM_ROLLS = 999;
	var MAX_ROLL = 9999999;
	var recentRolls = [];

	if (seed == undefined) {
		Math.seedrandom(window.RANDOM_ENTROPY, true);
	}
	else {
		Math.seedrandom(seed);
	}

	this.random = Math.randomInt;

	var othis = this;

	/**
	 * Utility class that triggers the execution of a callback after
	 * a specified number of tasks have signalled completion by calling
	 * taskComplete();
	 *
	 * @param taskCount Number of tasks that must complete before completionCallback is executed
	 * @param completionCallback The callback to execute once taskCount tasks have been completed
	 */
	function TaskCompletionCallback(taskCount, completionCallback, name) {
		var calls = 0;
		var called = false;

		this.taskComplete = function() {
			if (calls == taskCount) {
				throw "All " + calls + " tasks have already been completed for: " + name;
			}
			calls++;
			//log(name + ": " + calls);
			if (calls == taskCount) {
				called = true;
				completionCallback();
			}
		};

		this.verify = function() {
			if (calls == taskCount && !called) {
				completionCallback();
			}
		};
	};

	/**
	 * The result of rolling a die
	 */
	function RollResult(i) {
		this.i = i;
		this.v = 0;
	}

	/**
	 * The result of rolling a group
	 */
	function GroupResult(v) {
		this.v = v;
	}

	/**
	 * The result of a parsed roll expression that has also been validated
	 */
	function ValidatedRollExpression(rolls, resultType) {
		this.type = d20.dice.TYPE_VALIDATED_ROLLS;
		this.rolls = rolls;
		this.resultType = resultType;
	};

	/**
	 * Builds an eval'able expression from the roll results. Handles groups of expressions and
	 * groups with no entries as well as success/failure comparisons.
	 */
	function ExpressionBuilder() {
		var expression = "";
		var groupMemeberCount = undefined;
		var prevResults;

		var verifyInGroup = function() {
			if (groupMemeberCount == undefined) {
				throw "Not currently in a group expression: '" + expression + "'";
			}
		};

		this.addMathExpr = function(expr) {
			expression += expr;
		};

		this.startGroup = function() {
			expression += "(";
			groupMemeberCount = 0;
			prevResults = []; // FOR MATCH TOTAL ROLLS ONLY
		};

		this.addGroupValue = function(value) {
			verifyInGroup();
			if (groupMemeberCount > 0) {
				expression += "+";
			}
			expression += value;
			groupMemeberCount++;
		};

		this.addGroupSuccess = function(value, cp) {
			this.addGroupValue("(" + value + cp.comp + cp.point + "?1:0)");
		};

		this.addGroupFailure = function(value, cp) {
			this.addGroupValue("(" + value + cp.comp + cp.point + "?-1:0)");
		};

		this.addGroupMatch = function(value, cp) {
			var comp = cp.comp ? cp.comp : ">=";
			var point = cp.point ? cp.point : "0";
			prevResults.push(value);
			var match_obj = {};
			for (var i = 0; i < prevResults.length; i++) {
				var num = prevResults[i];
				match_obj[num] = match_obj[num] ? match_obj[num] + 1 : 1;
			}
			var matches = match_obj[value];
			if(matches === cp.threshold) {
				this.addGroupValue("(" + value + comp + point + "?1:0)");
			}
		};

		this.endGroup = function() {
			verifyInGroup();
			if (groupMemeberCount == 0) {
				expression += "0";
			}
			expression += ")";
			groupMemeberCount = undefined;
			prevResults = [];
		};

		this.eval = function() {
			log(expression);
			var result;
			var thisexp = expression;
			(function() {

				"use strict";

				var floor = Math.floor;
				var ceil = Math.ceil;
				var round = Math.round;
				var max = Math.max;
				var min = Math.min;
				var abs = Math.abs;

				try {
					result = eval(thisexp);
				}
				catch (e) {
					result = 0;
				}
			})();
			return result;
		};
	};

	/**
	 * log a message, might be disabled, see logerr for parameter details.
	 */
	var log = function(m) {
		return; // comment out this line to disable logging
		logerr(m);
	};

	/**
	 * Log a message, will never be disabled
	 *
	 * @param m
	 *          the message to log, if m is a function it will be evaluated before
	 *          logging
	 */
	var logerr = function(m) {
		if (_.isFunction(m)) {
			m = m();
		}
	};

	var fallbackErrorHandler = function(e) {
		logerr(e);
		throw e;
	};

	/**
	 * Formats a diceRoll object back into a roll expression
	 */
	var diceRollToString = function(roll) {
		var rollStr = roll.dice + "d" + roll.sides;

		if (roll.mods.compounding) {
			rollStr += "!!" + comparePointToString(roll.mods.compounding);
		}
		if (roll.mods.penetrating) {
			rollStr += "!p" + comparePointToString(roll.mods.penetrating);
		}
		if (roll.mods.exploding) {
			rollStr += "!" + comparePointToString(roll.mods.exploding);
		}
		if (roll.mods.keep) {
			rollStr += "k";
			if (roll.mods.keep.end != "h") {
				rollStr += roll.mods.keep.end;
			}
			rollStr += roll.mods.keep.count;
		}
		if (roll.mods.drop) {
			rollStr += "k";
			if (roll.mods.drop.end != "l") {
				rollStr += roll.mods.drop.end;
			}
			rollStr += roll.mods.drop.count;
		}
		if (roll.mods.reroll) {
			roll.mods.reroll.forEach(function(cp) {
				rollStr += "r" + comparePointToString(cp);
			});
		}
		if (roll.mods.sort) {
			rollStr += "s" + roll.mods.sort.order;
		}
		if (roll.mods.success) {
			rollStr += comparePointToString(roll.mods.success, true);
		}
		if (roll.mods.failure) {
			rollStr += "f" + comparePointToString(roll.mods.failure, true);
		}

		return rollStr;
	};
	var comparePointToString = function(cp, explicitEquals) {
		var cpStr = "";
		if (cp.point) {
			if (cp.comp != "==" || explicitEquals) {
				cpStr += cp.comp.charAt(0);
			}
			cpStr += cp.point;
		}
		return cpStr;
	};

	/**
	 * Validates that all of the rolls in the expression have sane combinations and limits in place
	 *
	 * @return The number of actual rolls in the array of expression objects
	 */
	var validateParseResult = function(rolls) {
		var resultType = undefined;

		// Per level track success/sum state
		for (var i = 0; i < rolls.length; i++) {
			if (rolls[i].type == d20.dice.TYPE_ROLL_EXPR || rolls[i].type == d20.dice.TYPE_GROUP_EXPR) {
				var rollType = getRollType(rolls[i]);
				if (resultType == undefined) {
					resultType = rollType;
				}
				else if (resultType != rollType) {
					throw "Cannot mix " + resultType + " and " + rollType + " rolls in a single roll expression";
				}
			}

			if (rolls[i].type == d20.dice.TYPE_ROLL_EXPR) {
				//Setup sides for fate rolls
				if (rolls[i].fate) {
					rolls[i].sides = 3;
				}
				//Setup sides for table rolls
				else if (rolls[i].table != undefined) {
					rolls[i].sides = d20.getTableElementCount(rolls[i].table);
				}

				// Enforce that fate dice don't support compounding
				if (rolls[i].fate && rolls[i].mods.compounding != undefined) {
					throw "Compounding FATE dice are not legal, try ! instead of !! for exploding FATE dice";
				}

				//Make sure that we don't try to do an exploding d1 dice. /sigh
				if (rolls[i].mods && rolls[i].mods.exploding != undefined && rolls[i].sides < 2) {
					throw "You must roll a d2 or higher to roll exploding dice.";
				}

				// Add sanity bounds checks
				rolls[i].dice = Math.max(Math.min(rolls[i].dice, MAX_NUM_ROLLS), 0);
				rolls[i].sides = Math.max(Math.min(rolls[i].sides, MAX_ROLL), 0);
			}

			if (rolls[i].type == d20.dice.TYPE_GROUP_EXPR) {

				//For groups with one sub-roll doign a sucess check verify that the sub-roll only contains one roll expression and no group expressions
				if (rolls[i].rolls.length == 1 && resultType == d20.dice.ROLL_TYPE_SUCCESS) {
					var foundRoll = false;
					for (var r = 0; r < rolls[i].rolls[0].length; r++) {
						if (rolls[i].rolls[0][r].type == d20.dice.TYPE_ROLL_EXPR) {
							if (foundRoll) {
								throw "Only one roll expression is allowed in a single sub-roll expression success check";
							}
							foundRoll = true;
						}
						else if (rolls[i].rolls[0][r].type == d20.dice.TYPE_GROUP_EXPR) {
							throw rolls[i].rolls[0][r].type + " expression is not supported in a single sub-roll expression success check";
						}
					}
				}

				// Recurse on grouped rolls
				var groupResultType = undefined;
				for (var g = 0; g < rolls[i].rolls.length; g++) {
					var subGroupResultType = validateParseResult(rolls[i].rolls[g]);
					if (groupResultType == undefined) {
						groupResultType = subGroupResultType;
					}
					else if (groupResultType != subGroupResultType) {
						throw "Cannot mix " + groupResultType + " and " + subGroupResultType + " rolls in a  roll group";
					}
				}
				rolls[i].resultType = groupResultType;
			}
		}

		if (resultType == undefined) {

			//Math-only rolls.
			if (rolls[0].type === d20.dice.TYPE_MATH_EXPR) {
				return d20.dice.TYPE_MATH_EXPR;
			}

			throw "Could not determine result type of: " + JSON.stringify(rolls);
		}
		return resultType;
	};

	var getRollType = function(diceRoll) {
		if (diceRoll.mods && diceRoll.mods.match !== undefined && diceRoll.mods.match.total !== undefined) {
			return d20.dice.ROLL_TYPE_MATCH;
		}
		else if (diceRoll.mods && diceRoll.mods.success !== undefined) {
			return d20.dice.ROLL_TYPE_SUCCESS;
		}
		else if (diceRoll.sides != undefined && diceRoll.sides.type == d20.dice.TYPE_LABEL) {
			return d20.dice.ROLL_TYPE_TABLE;
		}
		else {
			return d20.dice.ROLL_TYPE_SUM;
		}
	};

	/**
	 * Parse the dice formula string using the dice grammar and validate
	 * the result
	 *
	 * @param formula The parsed roll object model
	 */
	var parseRollString = function(rollString) {
		log(function() { return "E parseRollString: " + rollString; });

		// Use Parser Grammar to parse the roll expression
		var rolls = d20.DicePEG.parse(rollString);
		log(rolls);

		var resultType = validateParseResult(rolls);

		var vre = new ValidatedRollExpression(rolls, resultType);
		log(vre);
		log(JSON.stringify(vre));
		log(function() { return "L parseRollString: " + vre.rolls.length + " expressions from: " + rollString; });

		return vre;
	};

	/**
	 * Initiate all rolls in the parse tree
	 *
	 * @param rolls An array of expresion objects
	 * @param roll rollsCompleteCallback Callback to execute when each entry in the array is complete
	 */
	var initiateRolls = function(rolls, resultType, rollsCompleteCallback) {
		for (var i = 0; i < rolls.length; i++) {
			if (rolls[i].type == d20.dice.TYPE_ROLL_EXPR) {
				doRolls(rolls[i], rollsCompleteCallback);
			}
			else if (rolls[i].type == d20.dice.TYPE_GROUP_EXPR) {
				initiateGroupRolls(rolls[i], resultType, rollsCompleteCallback);
			}
			else {
				rollsCompleteCallback();
			}
		}
	};
	/**
	 * Initiates rolls for a group, needed so the correct scoping of groupCompleteCallback
	 * is used.
	 */
	var initiateGroupRolls = function(groupRoll, resultType, rollsCompleteCallback) {
		var groupCompleteCallback = new TaskCompletionCallback(groupRoll.rolls.length, function() {
			postProcessCompleteGroup(groupRoll, resultType);
			rollsCompleteCallback();
		}, "groupCompleteCallback");

		for (var g = 0; g < groupRoll.rolls.length; g++) {
			initiateSubGroupRolls(groupRoll.rolls[g], groupRoll.resultType, groupCompleteCallback);
		}
	};
	/**
	 * Initiates rolls for a subgroup, needed so the correct scoping of subGroupCompleteCallback
	 * is used.
	 */
	var initiateSubGroupRolls = function(subGroup, resultType, groupCompleteCallback) {
		var subGroupCompleteCallback = new TaskCompletionCallback(subGroup.length, function() {
			groupCompleteCallback.taskComplete();
		}, "subGroupCompleteCallback");

		initiateRolls(subGroup, resultType, function() {
			subGroupCompleteCallback.taskComplete();
		});
	};

	/**
	 * Fire off each roll required for the diceRoll using asyncRand.
	 */
	var doRolls = function(diceRoll, rollsCompleteCallback) {
		log(function() { return diceRollToString(diceRoll) + "\t - E doRolls"; });

		// Add arrays to track rolls to diceRoll
		diceRoll.results = [];

		// Setup the callback tracker for signaling when each roll is complete
		var taskCallback = new TaskCompletionCallback(diceRoll.dice, function() {
			diceRollCompleteCallback(diceRoll);
			rollsCompleteCallback();
		}, "rollCompleteCallback");

		var rollCompleteCallback = function() {
			taskCallback.taskComplete();
		};

		// Execute each roll for the dice
		for (var r = 0; r < diceRoll.dice; r++) {
			rollDie(r, diceRoll, rollCompleteCallback);
		}

		//Handling for the case where diceRoll.dice == 0, ensures the callback is executed no matter what
		taskCallback.verify();

		log(function() { return diceRollToString(diceRoll) + "\t - L doRolls"; });
	};

	/**
	 * Processes modifiers on the a single dice roll that are applied after all dice within
	 * the roll have completed. This includes keep, drop, and sort.
	 */
	var diceRollCompleteCallback = function(diceRoll) {
		log(function() { return diceRollToString(diceRoll) + "\t - E diceRollCompleteCallback"; });

		//First order rolls by index and the drop flag to have an intuitive "natural" ordering of dice
		diceRoll.results.sort(function(a, b) {
			var d = (a.i - b.i);
			if (d != 0 || a.d == b.d) {
				return d;
			}
			if (a.d) {
				return -1;
			}
			return 1;
		});

		//Clean up data model by removing roll index, it isn't needed after this point (right?)
		diceRoll.results.forEach(function(r) {
			delete r.i;
		});

		if (diceRoll.mods && diceRoll.mods.keep != undefined) {
			var order = (diceRoll.mods.keep.end == "l" ? "a" : "d");
			var sortedResults = sortRolls(diceRoll.results, order);

			keepRolls(sortedResults, diceRoll.mods.keep.count);
		}
		if (diceRoll.mods && diceRoll.mods.drop != undefined) {
			var order = (diceRoll.mods.drop.end == "l" ? "a" : "d");
			var sortedResults = sortRolls(diceRoll.results, order);

			dropRolls(sortedResults, diceRoll.mods.drop.count);
		}
		if (diceRoll.mods && diceRoll.mods.sort != undefined) {
			diceRoll.results = sortRolls(diceRoll.results, diceRoll.mods.sort.order);
		}

		log(function() { return diceRollToString(diceRoll) + "\t - L diceRollCompleteCallback"; });
	};

	/**
	 * Process modifiers on a group of rolls that are applied after all of the group expressions
	 * within the group.
	 */
	var postProcessCompleteGroup = function(groupRoll, resultType) {
		log(function() { return "E postProcessCompleteGroup(" + resultType + ")"; });

		if (groupRoll.mods && groupRoll.mods.keep != undefined && groupRoll.rolls.length == 1) {
			//apply keep to the total set of rolls within the group
			var order = (groupRoll.mods.keep.end == "l" ? "a" : "d");

			var allRolls = buildSubGroupRollsArray(groupRoll.rolls[0]);

			allRolls = sortRolls(allRolls, order);
			keepRolls(allRolls, groupRoll.mods.keep.count);

			cleanupSubGroupValues(groupRoll.rolls[0]);
		}
		if (groupRoll.mods && groupRoll.mods.drop != undefined && groupRoll.rolls.length == 1) {
			//apply drop to the total set of rolls within the group
			var order = (groupRoll.mods.drop.end == "l" ? "a" : "d");

			var allRolls = buildSubGroupRollsArray(groupRoll.rolls[0]);

			allRolls = sortRolls(allRolls, order);
			dropRolls(allRolls, groupRoll.mods.drop.count);

			cleanupSubGroupValues(groupRoll.rolls[0]);
		}

		//Total things up for the group, needed for subgroup keep/drop
		totalResult(groupRoll, resultType);

		if (groupRoll.mods && groupRoll.mods.keep != undefined && groupRoll.rolls.length > 1) {
			//apply keep to the subgroup results
			var order = (groupRoll.mods.keep.end == "l" ? "a" : "d");
			var groupResults = sortRolls(groupRoll.results, order);
			keepRolls(groupResults, groupRoll.mods.keep.count);
		}
		if (groupRoll.mods && groupRoll.mods.drop != undefined && groupRoll.rolls.length > 1) {
			//apply drop to the subgroup results
			var order = (groupRoll.mods.drop.end == "l" ? "a" : "d");
			var groupResults = sortRolls(groupRoll.results, order);
			dropRolls(groupResults, groupRoll.mods.drop.count);
		}

		log(function() { return "L postProcessCompleteGroup"; });
	};

	var buildSubGroupRollsArray = function(subGroups) {
		var allRolls = [];
		for (var g = 0; g < subGroups.length; g++) {
			if (subGroups[g].type == d20.dice.TYPE_ROLL_EXPR) {
				allRolls = allRolls.concat(subGroups[g].results);
			}
			else if (subGroups[g].type == d20.dice.TYPE_GROUP_EXPR) {
				subGroups[g].v = totalResult(subGroups[g], subGroups[g].resultType).eval();
				allRolls.push(subGroups[g]);
			}
		}
		return allRolls;
	};

	var cleanupSubGroupValues = function(subGroups) {
		subGroups.forEach(function(e) {
			if (e.type == d20.dice.TYPE_GROUP_EXPR) {
				delete e.v;
			}
		});
	};

	/**
	 * Keeps the first count rolls that are not already marked as dropped iterating through
	 * the array from 0 to N. After the count rolls are kept the remaining rolls are marked
	 * as dropped.
	 *
	 * @param rolls sorted array of rolls
	 * @param count number of rolls to keep
	 */
	var keepRolls = function(rolls, count) {
		var kept = 0;
		for (var i = 0; i < rolls.length; i++) {
			if (!rolls[i].d) {
				if (kept < count) {
					kept++;
				}
				else {
					rolls[i].d = true;
				}
			}
		}
	};

	/**
	 * Drops the first count rolls that are not already marked as dropped iterating through
	 * the array from 0 to N. After the count rolls are marked as dropped the method returns
	 *
	 * @param rolls sorted array of rolls
	 * @param count number of rolls to drop
	 */
	var dropRolls = function(rolls, count) {
		var dropped = 0;
		for (var i = 0; i < rolls.length && dropped < count; i++) {
			if (!rolls[i].d) {
				rolls[i].d = true;
				dropped++;
			}
		}
	};

	/**
	 * Return a of the rolls array sorted in the specified order
	 */
	var sortRolls = function(rolls, order) {
		var orderMod = (order == "d" ? -1 : 1);
		return rolls.slice(0).sort(function(a, b) {
			return (a.v - b.v) * orderMod;
		});
	};

	/**
	 * A simple random number generator, but we force it to be asynchronous so we
	 * can make sure that our dice engine can support an asynch generator. This
	 * way we can substitute in something like 3D Dice rolling or server-side
	 * "real" random numbers later on.
	 *
	 * @param sides
	 *          maximum integer to roll, returned value will be between 1 and
	 *          maxRoll inclusive
	 * @param randCallback
	 *          function called when the random number is generated, the random
	 *          number is provided as the only argument
	 */
	var asyncRand = function(sides, randCallback, no3d, rollid) {
		if (sides === 0) {
			setTimeout(function() {
				randCallback(0);
			}, 0);
		}

		//We no longer do local 3D rolls.

		else if (sides === 6 && d20.textchat && d20.textchat.egg_clickhole && !$("#lightly-overlay").is(":visible")) {
			var possibilities = [
				["2990", 1, 4],
				["2991", 1, 7],
				["2992", 1, 12],
				["2993", 2, 7],
				["2994", 2, 5],
				["2995", 2, 38],
				["2996", 2, 11],
				["2997", 3, 13],
				["2998", 3, 16],
				["2999", 3, 6],
				["3000", 3, 16],
				["3001", 4, 17],
				["3002", 4, 18],
				["3003", 4, 16],
				["3004", 5, 7],
				["3006", 5, 24],
				["3005", 5, 14],
				["3007", 5, 27],
				["3008", 6, 7],
				["3009", 6, 6],
				["3010", 6, 5],
				["3012", 6, 10]
			];

			var chosen = possibilities[othis.random(possibilities.length)];

			d20.textchat.sendShout({
				type: "playclickhole",
				playerid: window.currentPlayer.id,
				content: chosen,
				time: new Date().getTime()
			});

			if (window.fakeLightly) {
				window.fakeLightly("http://v.theonion.com/onionstudios/video/" + chosen[0] + "/640.mp4");
			}

			setTimeout(function() {
				randCallback(chosen[1]);
				$("#lightly-overlay").hide();
			}, (chosen[2] * 1000) + 2000);

		}
		else {
			setTimeout(function() {
				randCallback(othis.random(sides) + 1);
			}, 0);
		}
	};

	/**
	 * Compare a value to a ComparePoint, if defaultPoint is specified and no
	 * ComparePoint operator exists the comparison will be done as
	 * "value == defaultPoint"
	 */
	var compareToPoint = function(value, cp, defaultPoint) {
		if (cp.comp != undefined) {
			var cpFormula = value + cp.comp + cp.point;
			var cpResult = eval(cpFormula);
			return cpResult;
		}

		return value == defaultPoint;
	};

	/**
	 * Creates a new RollResult, pushes it onto the results array for the diceRoll
	 * and triggers asyncRand with a callback to individualRollCallback
	 *
	 * @param diceRoll The roll expression being executed
	 * @param rollCompleteCallback The callback to execute when the random number is generated
	 * @param rollModifierFunction An optional modifier function that can change the random number before it is passed to rollCompleteCallback
	 */
	var rollDie = function(rollIndex, diceRoll, rollCompleteCallback, extraRollCounter) {
		//Roll an additional die
		var rollResult = new RollResult(rollIndex);
		diceRoll.results.push(rollResult);

		//Have to do anon function call to so the correct rollResult reference is passed to the individualRollCallback
		(function(rr) {
			asyncRand(diceRoll.sides, function(rand) {
				individualRollCallback(diceRoll, rr, rand, rollCompleteCallback, extraRollCounter);
			}, (diceRoll.table !== undefined), diceRoll.rollid);
		}(rollResult));
	};

	/**
	 * Called by asyncRand for each new random roll, handles logic around immediately needed additional rolls
	 * for exploding, compounding, penetrating, and reroll modifiers
	 */
	var individualRollCallback = function(diceRoll, rollResult, rand, rollCompleteCallback, extraRollCounter) {
		extraRollCounter = (extraRollCounter || 0);
		log(function() { return diceRollToString(diceRoll) + "\t - E individualRollCallback(" + extraRollCounter + ") " + rand; });

		//Save the roll value, addition is used to handle modifiers like compounding that use the same
		//rollResult for multiple rolls
		//if(diceRoll.mods === undefined) diceRoll.mods = {};

		//If this is a rollable table roll, get the value for that table index.
		if (diceRoll.table !== undefined) {
			rollResult.tableidx = rand - 1;
			rollResult.v += d20.getTableElementValue(diceRoll.table, rollResult.tableidx);
		}
		else {
			rollResult.v += rand;
		}

		//Offset FATE rolls
		if (diceRoll.fate) {
			rollResult.v -= 2;
		}

		//Reduce roll by 1 for every extra penetrating roll
		if (diceRoll.mods && diceRoll.mods.penetrating != undefined && extraRollCounter > 0) {
			rollResult.v -= 1;
		}

		//Make sure we haven't exploded/compounded/penetrated/rerolled too many times
		if (extraRollCounter > MAX_NUM_ROLLS) {
			rollCompleteCallback();
		}
		else if (diceRoll.mods && diceRoll.mods.exploding != undefined && compareToPoint(rand, diceRoll.mods.exploding, diceRoll.sides)) {
			//Exploded - Roll an additional die
			rollDie(rollResult.i, diceRoll, rollCompleteCallback, extraRollCounter + 1);
		}
		else if (diceRoll.mods && diceRoll.mods.compounding != undefined && compareToPoint(rand, diceRoll.mods.compounding, diceRoll.sides)) {
			//Compounding - Roll another die but use the same rollResult
			asyncRand(diceRoll.sides, function(rand) {
				individualRollCallback(diceRoll, rollResult, rand, rollCompleteCallback, extraRollCounter + 1);
			}, (diceRoll.table !== undefined), diceRoll.rollid);
		}
		else if (diceRoll.mods && diceRoll.mods.penetrating != undefined && compareToPoint(rand, diceRoll.mods.penetrating, diceRoll.sides)) {
			//Exploded - Roll an additional die
			rollDie(rollResult.i, diceRoll, rollCompleteCallback, extraRollCounter + 1);
		}
		else if (diceRoll.mods && diceRoll.mods.reroll != undefined) {
			var rerolled = diceRoll.mods.reroll.some(function(reroll) {

				if (reroll.maxrerolls) {
					var numrollsforindex = 0;
					for (var jj = 0; jj < diceRoll.results.length; jj++) {
						if (diceRoll.results[jj].i === rollResult.i && diceRoll.results[jj].d === true) numrollsforindex++;
					}
				}

				if (compareToPoint(rand, reroll, 1)) {

					if (reroll.maxrerolls && numrollsforindex >= reroll.maxrerolls) {
						return false;
					}

					//Note that we
					//rerolled = true;
					rollResult.d = true;

					//ReRolled - Roll an additional die to replace the one that was dropped
					rollDie(rollResult.i, diceRoll, rollCompleteCallback, extraRollCounter + 1);

					//A true return stops iteration
					return true;
				}

				return false;
			});

			//If nothing was rerolled this die roll is complete
			if (!rerolled) {
				rollCompleteCallback();
			}
		}
		else {
			//No additional roll modifier, signal the die roll is complete
			rollCompleteCallback();
		}

		log(function() { return diceRollToString(diceRoll) + "\t - L individualRollCallback(" + extraRollCounter + ") " + rand; });
	};

	/**
	 * Apply all of the post-roll modifiers and perform totals
	 */
	var postProcessCompleteRolls = function(rolls, resultType, reprocess) {
		log(function() { return "E postProcessCompleteRolls"; });

		if (rolls.type == d20.dice.TYPE_VALIDATED_ROLLS) {
			// Special handling for the outer validated rolls data
			var total = postProcessCompleteRolls(rolls.rolls, rolls.resultType);
			rolls.total = total;
			return total;
		}

		var result = totalResults(rolls, resultType, reprocess);

		log(function() { return "L postProcessCompleteRolls - " + result; });
		return result;
	};

	var totalResults = function(rolls, resultType, reprocess, expression) {
		var expression = expression || new ExpressionBuilder();
		var expression = new ExpressionBuilder();
		for (var r = 0; r < rolls.length; r++) {
			totalResult(rolls[r], resultType, reprocess, expression);
		}
		return expression.eval();
	};

	var totalResult = function(roll, resultType, reprocess, expression) {
		var expression = expression || new ExpressionBuilder();
		if (roll.type == d20.dice.TYPE_ROLL_EXPR) {
			expression.startGroup();
			for (var d = 0; d < roll.results.length; d++) {
				if (!roll.results[d].d) {
					addResultValue(expression, resultType, roll.results[d].v, roll);
				}
			}
			expression.endGroup();
			// If we've got a match mod create a "matches" property with a random color assigned to the value if the number of matches meets threshold and comparison/point
			if(roll.mods.match) {
				var val_array = [];
				var match_obj = {};
				_.each(roll.results, function(r) {
					val_array.push(r["v"]);
				});
				var count_obj = val_array.reduce(function(countMap, value) {countMap[value] = ++countMap[value] || 1;return countMap}, {});
				var cur_count = 0;
				for(var k in count_obj) {
					if(count_obj[k] >= roll.mods.match.threshold) {
						if(!roll.mods.match.comp || !roll.mods.match.point || (roll.mods.match.comp === ">=" && k >= roll.mods.match.point) || (roll.mods.match.comp === "<=" && k <= roll.mods.match.point) || (roll.mods.match.comp === "==" && k == roll.mods.match.point)) {
							if(cur_count == 8) {cur_count = 0};
							match_obj[k] = d20.dice.MATCH_COLORS[cur_count];
							cur_count++;
						};
					};
				}
				roll.mods.match["matches"] = match_obj;
			}
		}
		else if (roll.type == d20.dice.TYPE_MATH_EXPR) {
			expression.addMathExpr(roll.expr);
		}
		else if (roll.type == d20.dice.TYPE_GROUP_EXPR) {
			expression.startGroup();
			if (!roll.d) {
				if (roll.results == undefined || reprocess) {
					roll.results = [];

					//For groups with 1 sub-roll that are have a success rollType use special to total each roll
					if (roll.rolls.length == 1 && resultType == d20.dice.ROLL_TYPE_SUCCESS) {

						//First step is to build up the math expressions to use before and after each roll result
						var mathPrefix = "";
						var rollExpression = undefined;
						var mathSuffix = "";
						for (var r = 0; r < roll.rolls[0].length; r++) {
							if (roll.rolls[0][r].type == d20.dice.TYPE_ROLL_EXPR) {
								if (rollExpression != undefined) {
									throw "Only one roll expression is allowed in a single sub-roll expression success check";
								}
								rollExpression = roll.rolls[0][r];
							}
							else if (roll.rolls[0][r].type == d20.dice.TYPE_MATH_EXPR) {
								if (rollExpression == undefined) {
									mathPrefix += roll.rolls[0][r].expr;
								}
								else {
									mathSuffix += roll.rolls[0][r].expr;
								}
							}
							else if (roll.rolls[0][r].type == d20.dice.TYPE_GROUP_EXPR) {
								throw roll.rolls[0][r].type + " expression is not supported in a single sub-roll expression success check";
							}
						}

						//Second step is to evaluate each roll with the math expressions and store the result in the group's results
						for (var r = 0; r < rollExpression.results.length; r++) {
							if (!rollExpression.results[r].d) {
								var rExp = new ExpressionBuilder();
								rExp.startGroup();
								rExp.addMathExpr(mathPrefix);
								rExp.addGroupValue(rollExpression.results[r].v);
								rExp.addMathExpr(mathSuffix);
								rExp.endGroup();

								roll.results.push(new GroupResult(rExp.eval()));
							}
						}
					}
					else {
						for (var g = 0; g < roll.rolls.length; g++) {
							var groupTotal = totalResults(roll.rolls[g], roll.resultType, reprocess);
							roll.results.push(new GroupResult(groupTotal));

							addResultValue(expression, resultType, groupTotal, roll);
						}
					}
				}
				else {
					roll.results.forEach(function(r) {
						if (!r.d) {
							addResultValue(expression, resultType, r.v, roll);
						}
					});
				}
			}
			expression.endGroup();
		}

		return expression;
	};

	var addResultValue = function(expression, resultType, value, roll) {
		if (resultType == d20.dice.ROLL_TYPE_SUM) {
			expression.addGroupValue(value);
		}
		else if (resultType == d20.dice.ROLL_TYPE_SUCCESS) {
			expression.addGroupSuccess(value, roll.mods.success);
			if (roll.mods && roll.mods.failure != undefined) {
				expression.addGroupFailure(value, roll.mods.failure);
			}
		}
		else if (resultType == d20.dice.ROLL_TYPE_MATCH) {
			expression.addGroupMatch(value, roll.mods.match);
		}
		else {
			throw "Unsupported resultType: " + resultType;
		}
	};

	/**
	 * reprocess an already processed roll result. Useful if structural changes such as reordering,
	 * or keep/drop toggling has been done and a recalculation of totals is needed
	 *
	 * @param rollResult The json object model returned to the finalCallback when the roll expression was originally processed
	 */
	this.reprocess = function(rollResult, finalCallback, errorCallback) {
		errorCallback = errorCallback || fallbackErrorHandler;

		try {
			postProcessCompleteRolls(rollResult, undefined, true);
			finalCallback(rollResult);
		}
		catch (e) {
			errorCallback(e);
		}
	};

	var remoteRollQueue = [];
	var remoteRollCallbacks = {};

	var performRemoteRoll = function(vre, rollid, rolltype, finalCallback, errorCallback) {
		remoteRollQueue.push({
			vre: vre,
			rollid: rollid,
			rolltype: rolltype
		});

		remoteRollCallbacks[rollid] = {
			success: finalCallback,
			error: errorCallback
		}

		debounced_doRemoteRollRequest();
	};

	var _doRemoteRollRequest = function() {

		if (remoteRollQueue.length === 0) return;

		if (!window.is_playerapp && window.currentPlayer.get("tddiceenabled") && window.currentPlayer.get("disableagency") === false) {

			if ($("#tdagencyoverlay").is(":visible")) {
				return;
			}
			$("#tdagencyoverlay").show();
			//DICECUP SFX
			var numberofdice = remoteRollQueue[0].vre.rolls[0].dice ? remoteRollQueue[0].vre.rolls[0].dice : 1;
			d20.tddice.playsound("dicecup", numberofdice);
			// d20.tddice.soundfx["dicecup.wav"].play();
			var posinfo = {};
			var $showline = $("#tdagencyoverlay svg line");
			var started_dragging = false;
			$("#tdagencyoverlay").on("mousedown", function(e) {
				posinfo.startx = e.clientX / $(window).width();
				posinfo.starty = e.clientY / $(window).height();
				$showline.attr("x1", e.clientX).attr("y1", e.clientY).attr("x2", e.clientX).attr("y2", e.clientY);
				started_dragging = true;
			});
			$("#tdagencyoverlay").on("mousemove", function(e) {
				if (started_dragging) {
					var xdist = Math.abs(posinfo.startx - (e.clientX / $(window).width()));
					var ydist = Math.abs(posinfo.starty - (e.clientY / $(window).height()));
					var curdist = Math.sqrt((xdist * xdist) + (ydist * ydist));
					if (curdist < 0.2) {
						$showline.css("stroke", "rgb(255,255,255)");
					}
					else if (curdist < 0.5) {
						$showline.css("stroke", "rgb(245,238,44)");
					}
					else {
						$showline.css("stroke", "rgb(245,44,44)");
					}
					$showline.attr("x2", e.clientX).attr("y2", e.clientY);
				}
			});
			$("#tdagencyoverlay").on("mouseup", function(e) {
				$("#tdagencyoverlay").off().hide();
				$showline.attr("x1", 0).attr("y1", 0).attr("x2", 0).attr("y2", 0);
				firebase.auth().currentUser.getIdToken(false).then((token) => {
					if (!posinfo.startx) {
						_posthookrollrequest(null, token);
					}
					else {
						posinfo.stopx = e.clientX / $(window).width();
						posinfo.stopy = e.clientY / $(window).height();
						_posthookrollrequest(posinfo, token);
					}
				});
			})
		}
		else {
			setTimeout(function() {
				if(window.GNTKN === "tutorial") {
					_posthookrollrequest();
				} else {
					firebase.auth().currentUser.getIdToken(false).then((token) => {
						_posthookrollrequest(null, token);
					});
				}
			}, 50);
		}
	};

	var _posthookrollrequest = function(posinfo = {}, idToken) {
		if (remoteRollQueue.length === 0) return;

		var rolldata = {
			cid: window.campaign_storage_path,
			fbnum: window.FIREBASE_ROOT,
			authkey: idToken,
			pid: window.currentPlayer.id,
			rolls: remoteRollQueue,
			use3d: (window.is_playerapp ? window.currentPlayer.get("apptddiceenabled") : window.currentPlayer.get("tddiceenabled")),
		};

		if (posinfo) {

			var deltas = {
				x: posinfo.startx - posinfo.stopx,
				y: posinfo.starty - posinfo.stopy
			};

			var mindistance = 0.01;
			var maxdistance = 0.3;

			if (Math.abs(deltas["x"]) < mindistance) {
				deltas["x"] = deltas["x"] < 0 ? -mindistance : mindistance
			}
			if (Math.abs(deltas["y"]) < mindistance) {
				deltas["y"] = deltas["y"] < 0 ? -mindistance : mindistance
			}
			if (Math.abs(deltas["x"]) > maxdistance) {
				deltas["x"] = deltas["x"] < 0 ? -maxdistance : maxdistance
			}
			if (Math.abs(deltas["y"]) > maxdistance) {
				deltas["y"] = deltas["y"] < 0 ? -maxdistance : maxdistance
			}

			rolldata.deltas = {
				x: deltas.x * 80 * -1,
				y: deltas.y * 80 * 1
			};
		}
		else if (rolldata.use3d === true) {
			rolldata.deltas = {
				x: Math.random() * 10 - 5,
				y: 20
			};
		}

		const rollURL = window.ROLL_URL || 'https://dice.roll20.net';

		$.ajax({
			url: rollURL + "/doroll",
			type: "POST",
			data: JSON.stringify(rolldata),
			contentType: "application/json; charset=utf-8",
			dataType: "json",
			success: function(queueresults) {
				for (var resultrid in queueresults) {
					if (!remoteRollCallbacks[resultrid]){
						remoteRollCallbacks[resultrid] = {
							success: d20.textchat.roll_default_callback,
							error: d20.textchat.roll_error_callback
						}
					}

					d20.dice_engine.newRoll(resultrid);
					if (queueresults[resultrid].error != undefined) {
						remoteRollCallbacks[resultrid].error("There was an error fetching your roll. " + queueresults[resultrid].error);
						continue;
					}
					var thisvre = JSON.parse(queueresults[resultrid].json);
					postProcessCompleteRolls(thisvre);
					remoteRollCallbacks[resultrid].success(thisvre, resultrid, queueresults[resultrid].signature, queueresults[resultrid].tdseed);

					if (d20.tutorial && queueresults[resultrid].shoutjson !== undefined) {
						d20.tddice.remoteRoll(JSON.parse(queueresults[resultrid].shoutjson));
					}
				}
			},
			error: function(e) {
				//Fallback to local rolling.
				_.each(rolldata.rolls, function(thisroll) {

					var vre = thisroll.vre;

					var wholeRollCompleteCallback = new TaskCompletionCallback(vre.rolls.length, function() {
						postProcessCompleteRolls(vre);
						setTimeout(function() {
							remoteRollCallbacks[thisroll.rollid].success(vre, null, false);
						}, 0);
					}, "wholeRollCompleteCallback");

					initiateRolls(vre.rolls, vre.resultType, function() {
						wholeRollCompleteCallback.taskComplete();
					});
				});
			}
		});

		remoteRollQueue = [];
	};

	var numBounce = 0;
	function showWarning (obj, bounces) {
		var player = window.Campaign.players.get(obj.pid);
		d20.textchat.incoming(false, {
			who: "system",
			type: "system",
			content: i18n("warning_roll_results_missing_name_number").tranSub(player.get("displayname"), bounces)
		});
		numBounce = 0;
	}
	var showWarningTH = _.throttle(showWarning, 7000, { leading: false }); // The warning will only show up every 5 seconds.
	d20.dice_engine.handleRollReceived = function(obj) {
		// If the roll comes in before the shout, we don't have to worry about it at all
		if (recentRolls.indexOf(obj.rid) === -1) {
			setTimeout(function() {
				if (recentRolls.indexOf(obj.rid) === -1) {
					showWarningTH(obj, ++numBounce);
				}
				else {
					recentRolls.splice(recentRolls.indexOf(obj.rid), 1);
				}
			}, 3000)
		}
		else {
			recentRolls.splice(recentRolls.indexOf(obj.rid), 1);
		}
	};
	d20.dice_engine.newRoll = function(rollId) {
		if (recentRolls.indexOf(rollId) === -1) {
			recentRolls.push(rollId);
		}
	};

	this.flushRemoteQueue = function() {
		_doRemoteRollRequest();
	}

	var debounced_doRemoteRollRequest = _.debounce(_doRemoteRollRequest, 100);

	/**
	 * Process a roll expression and call finalCallback when complete with an
	 * object that contains the total, formula, and originalFormula
	 */
	this.process = function(rollString, finalCallback, errorCallback) {
		errorCallback = errorCallback || fallbackErrorHandler;

		try {
			var vre = parseRollString(rollString);

			if (vre.rolls == 0) {
				throw "There were no dice to roll!";
			}

			var didHaveTables = false;
			var didHaveRolls = false;
			var hasTablesDepth = 0;

			var hasTables = function(subrolls) {
				hasTablesDepth++;
				if (subrolls !== undefined) {
					for (var i = 0; i < subrolls.length; i++) {
						if (subrolls[i].table !== undefined) {
							didHaveTables = true;
						}
						if (subrolls[i].type === "R") {
							didHaveRolls = true;
						}
						if ((!didHaveTables || !didHaveRolls) && hasTablesDepth < 99 && subrolls[i].rolls !== undefined && subrolls[i].rolls.length > 0) {
							for (var j = 0; j < subrolls[i].rolls.length; j++) {
								hasTables(subrolls[i].rolls[j]);
							}
						}
					}
				}
			};

			try {
				hasTables(vre.rolls);
			}
			catch (e) {
			}

			hasTables = null;

			if (d20.textchat && d20.textchat.egg_clickhole) {
				didHaveTables = true; //force using local rolls.
			}

			if (didHaveTables === true || didHaveRolls === false) {
				var wholeRollCompleteCallback = new TaskCompletionCallback(vre.rolls.length, function() {
					postProcessCompleteRolls(vre);
					setTimeout(function() {
						finalCallback(vre, null, false);
					}, 0);
				}, "wholeRollCompleteCallback");

				initiateRolls(vre.rolls, vre.resultType, function() {
					wholeRollCompleteCallback.taskComplete();
				});
			}

			else if (typeof $ === "undefined") {
				//We're on the API server?

				var rollid = generateUUID();

				var rolldata = {
					vre: vre,
					cid: CAMPAIGNID,
					fbnum: 'https://' + FIREBASENUM + '.firebaseio.com/',
					pid: "api",
					rid: rollid,
					use3d: false,
					authkey: FIREBASETOKEN,
					rolltype: d20.textchat.currentRollType
				};

				// This is only needed until we are 100% on GKE
				const rollURL = window.ROLL_URL || "https://app.roll20.net";
				request.post({
					url: rollURL + "/doroll",
					body: rolldata,
					json: true,
					timeout: 5000
				}, function(error, response, body) {

					if (!error && response.statusCode == 200 && body !== "") {
						var snap = body;
						if (snap.error !== undefined) {
							errorCallback("There was an error fetching your roll. " + snap.error);
							return;
						}
						var finalvre = JSON.parse(snap.json);
						postProcessCompleteRolls(finalvre);
						finalCallback(finalvre, rollid, snap.signature);
					}

					else {
						errorCallback("There was an error communicating with the QuantumRoll server.");
					}
				});
			}

			else {

				var rollid = generateUUID();

				performRemoteRoll(vre, rollid, d20.textchat.currentRollType, finalCallback, errorCallback);
			}
		}
		catch (e) {
			errorCallback(e);
		}
	};

	this.handleRollReq = function(vre, finalCallback) {
		var wholeRollCompleteCallback = new TaskCompletionCallback(vre.rolls.length, function() {
			try {
				postProcessCompleteRolls(vre);
			}
			catch (e) {
				finalCallback({
					error: "There was an error processing this roll."
				});
				return;
			}
			setTimeout(function() {
				finalCallback(vre);
			}, 0);
		}, "wholeRollCompleteCallback");

		try {
			initiateRolls(vre.rolls, vre.resultType, function() {
				wholeRollCompleteCallback.taskComplete();
			});
		}
		catch (e) {
			finalCallback({
				error: "There was an error processing this roll."
			});
		}
	};

	this.handleRollString = function(rollString) {
		var vre = parseRollString(rollString);

		if (vre.rolls == 0) {
			throw "There were no dice to roll!";
		}

		return vre;
	}

	return this;
};



const charactersMentioned = (content, regex) => {
	const matches = content.match(regex);

	if (matches == null) return {};

	return matches.reduce((acc, match) => {
		const input = match.substring(2, match.length - 1);
		const fields = input.split('|');

		let character;

		if (fields.length === 4) {
			const characterId = fields[0];
			character = d20.Campaign.characters.get(characterId);
			if (character != null) {
				acc[character.id] = character;
				return acc;
			}
		}

		const charName = fields[0];

		if (['selected', 'target', 'tracker'].includes(charName)) {
			if (charName === 'selected') {
				const selected = d20.engine.selected();
				if (selected.length > 0 && selected[0].model?.get('represents')) {
					character = d20.Campaign.characters.get(selected[0].model.get('represents'));
				}
				if (character != null) {
					acc[character.id] = character;
					return acc;
				}
			}
			return acc;
		}

		d20.Campaign.characters.each((someCharacter) => {
			if (
				someCharacter.get('name').toLowerCase() === charName.toLowerCase()
			) {
				character = someCharacter;
				acc[character.id] = character;
				return false;
			}
			return true;
		});

		return acc;
	}, {});
};

function RollCommandError(message) {
	this.name = 'RollCommandError';
	this.message = message;
	this.stack = (new Error()).stack;
}
RollCommandError.prototype = new Error();

d20.textchat = {
	commandhistory: [],
	commandIndex: 0,
	currentRollType: 'rollresult',
	commandInProgress: false,
	lastChatBeep: 0,
	talktomyself: false,
	allowed3drolls: [],
	globalrolled: 0,
	egg_clickhole: false,
	roll_error_callback(e) {
		console.log(e);
		const eop = {
			who: 'error',
			type: 'error',
			content: typeof e === 'string' ? e : 'There was an error with your formula. Please try again.',
		};
		d20.textchat.incoming(false, eop);
		d20.utils.textchatNotify(false);
	},
	subTables(rolls, passNum) {
		let _runningTotal = 0;
		let _hasTable = false;

		if (passNum > 99) {
			console.log('Too many subgroups, abort.');
			return undefined;
		}

		_.each(rolls, (roll) => {
			if (roll.type === 'G') {
				_.each(roll.rolls, (subrolls) => {
					const _subresult = d20.textchat.subTables(subrolls, passNum + 1);
					if (_subresult !== undefined) {
						_runningTotal += _subresult;
						_hasTable = true;
					}
				});
			} else if (roll.table) {
				const table = d20.Campaign.rollabletables.findTableByName(roll.table);
				const weighted = table.getWeightedArray();
				if (table) {
					_.each(roll.results, (result) => {
						_hasTable = true;
						result.tableItem = table.tableitems
							.get(weighted[result.tableidx])
							.toJSON();
						if (result.d === undefined) {
							_runningTotal += result.v;
						}
					});
				}
			} else if (roll.results) {
				_.each(roll.results, (result) => {
					if (result.d) return true;
					_runningTotal += result.v;
				});
			}
		});

		if (_hasTable) return _runningTotal;
		return undefined;
	},
	roll_default_callback(results, rollid, signature, tdseed) {
		const parentRef = firebase.database().ref(
			`${window.campaign_storage_path}`,
		);
		const fbref = parentRef.child('chat');
		const roll_type = 'rollresult';

		d20.textchat.globalrolled++;

		d20.utils.textchatNotify(false);

		if (results.error) {
			const eop = {
				who: 'error',
				type: 'error',
				content: results.error,
			};
			d20.textchat.incoming(false, eop);
		} else {
			if (results.rolls && results.rolls.length > 0) {
				try {
					const _tableResult = d20.textchat.subTables(results.rolls, 0);

					if (_tableResult !== undefined) {
						signature = null;
					}
				} catch (e) {
					console.log('ERROR matching table');
					console.log(e);
				}
			}

			const newop = {
				who: d20.textchat.$speakingas.find('option:selected').text(),
				type: roll_type,
				content: JSON.stringify(results),
				signature,
				origRoll: '[error]',
				playerid: window.currentPlayer.id,
				avatar: '',
				_fbid: rollid,
			};
			fbref
				.child(rollid)
				.setWithPriority(newop, firebase.database.ServerValue.TIMESTAMP);
		}
	},
};

$(() => {
	let lastName = '';
	let linesSinceName = 0;
	let windowIsFocused = true;
	let popoutWindowIsFocused = false;
	let autoCompleteOpen = false;
	let lastWhisperReceived;
	let fbref;
	let shoutref;
	const istypingtimers = {};
	const whoistyping = {};

	d20.textchat.tabIsFocused = true;

	if (d20.dice_engine) {
		d20.textchat.diceengine = new d20.dice_engine();
	}

	$(window).bind('focus', () => {
		windowIsFocused = true;
	});

	$(window).bind('blur', () => {
		windowIsFocused = false;
	});

	d20.textchat.$textarea = $('#textchat-input textarea');
	d20.textchat.$speakingas = $('#speakingas');
	d20.textchat.$textchat = $('#textchat');

	const x509 = new X509();
	x509.readCertPEM(
		'-----BEGIN CERTIFICATE-----\
MIICtTCCAl+gAwIBAgIJAJtwle/qkHJnMA0GCSqGSIb3DQEBBQUAMHIxCzAJBgNV\
BAYTAlVTMQswCQYDVQQIEwJLUzEQMA4GA1UEBxMHV2ljaGl0YTEPMA0GA1UEChMG\
Um9sbDIwMRMwEQYDVQQDEwpyb2xsMjAubmV0MR4wHAYJKoZIhvcNAQkBFg90ZWFt\
QHJvbGwyMC5uZXQwHhcNMTQwMzAzMTgwMTQ4WhcNMTQwNDAyMTgwMTQ4WjByMQsw\
CQYDVQQGEwJVUzELMAkGA1UECBMCS1MxEDAOBgNVBAcTB1dpY2hpdGExDzANBgNV\
BAoTBlJvbGwyMDETMBEGA1UEAxMKcm9sbDIwLm5ldDEeMBwGCSqGSIb3DQEJARYP\
dGVhbUByb2xsMjAubmV0MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBALJq8muAFnZM\
kJysXg9VJsevoQxtxV1NytYvCKHTtaCja/tyeLTRei0nu+NymPfNKKiRhv7R8D33\
oZLvIA/udusCAwEAAaOB1zCB1DAdBgNVHQ4EFgQUarGxVvODYDpzS5OKyKsTyCEm\
DSUwgaQGA1UdIwSBnDCBmYAUarGxVvODYDpzS5OKyKsTyCEmDSWhdqR0MHIxCzAJ\
BgNVBAYTAlVTMQswCQYDVQQIEwJLUzEQMA4GA1UEBxMHV2ljaGl0YTEPMA0GA1UE\
ChMGUm9sbDIwMRMwEQYDVQQDEwpyb2xsMjAubmV0MR4wHAYJKoZIhvcNAQkBFg90\
ZWFtQHJvbGwyMC5uZXSCCQCbcJXv6pByZzAMBgNVHRMEBTADAQH/MA0GCSqGSIb3\
DQEBBQUAA0EAjBHayltU3K4DCs2h4nC2quGGKzGE2h1nMCBzhQ1ed+vir+lLnWQv\
AOrqt50Nx7lMk+23uFGhGMysK2UyrqptMw==\
-----END CERTIFICATE-----',
	);

	const rollre = /\/((roll)|(r)|(gmroll)|(gr))[ ]+/i;
	const inviteLinkMessage = () => {
		if (window.is_gm) {
			$.get(`/campaigns/sharelink/${window.campaign_id}`, (bitly) => {
				d20.textchat.incoming(false, {
					who: 'system',
					type: 'system',
					content: `<h1 style="font-size: 1.2em;">Invite Players</h1>${i18n(
						'chat_campaign_link',
					)}<div class='sharelink'><a href='${bitly}'>${bitly}</a></div><div style='font-size: 0.9em;'></div>`,
				});
			});
		}
	};

	const postProcessOp = function (op, callback) {
		const listenerid = op.listenerid ? op.listenerid : undefined;
		op.content += '';
		if (op.content.match(rollre) !== null) {
			let currentRollType = 'rollresult';
			if (op.content.match(/\/((gmroll)|(gr))[ ]+/i) !== null) {
				currentRollType = 'gmrollresult';
			}

			d20.textchat.currentRollType = currentRollType;

			try {
				let rollexpression = op.content.replace(rollre, '');
				// Substitute in the final value of any inline rolls before we process our roll expressions.
				rollexpression = rollexpression.replace(
					/\$\[\[[0-9]+\]\]/g,
					(inlinematch) => {
						const inlinerollindex = inlinematch.substring(
							3,
							inlinematch.length - 1,
						);
						const inlineroll = op.inlinerolls[parseInt(inlinerollindex, 10)];
						if (inlineroll) {
							return inlineroll.results.total;
						}
						return 'INVALID INLINE ROLL';
					},
				);

				d20.utils.textchatNotify('Rolling the dice...');

				d20.textchat.diceengine.process(
					rollexpression,
					(results, rollid, signature, tdseed) => {
						d20.textchat.globalrolled++;

						d20.utils.textchatNotify(false);

						if (results.error) {
							const eop = {
								who: 'error',
								type: 'error',
								content: results.error,
							};
							d20.textchat.incoming(false, eop);
						} else {
							if (results.rolls && results.rolls.length > 0) {
								try {
									const _tableResult = d20.textchat.subTables(results.rolls, 0);

									if (_tableResult !== undefined) {
										signature = null;
									}
								} catch (e) {
									console.log('ERROR matching table');
									console.log(e);
								}
							}

							const newop = {
								who: d20.textchat.$speakingas.find('option:selected').text(),
								type: currentRollType,
								content: JSON.stringify(results),
								signature,
								origRoll: op.content.replace(rollre, ''),
								playerid: window.currentPlayer.id,
								avatar: op.avatar,
								_fbid: rollid,
							};

							if (listenerid) {
								newop.listenerid = listenerid;
							}

							if (tdseed) {
								newop.tdseed = tdseed;
							}

							if (op && op.opts && op.opts.tracker) {
								// Send the result to the tracker.
								sendResultToTracker(
									op.currentSelected,
									results,
									op.opts.tracker,
								);
							}

							callback(newop);
						}
					},
					d20.textchat.roll_error_callback,
				);
			} catch (e) {
				console.log(e);
				var eop = {
					who: 'error',
					type: 'error',
					content: typeof e === 'string' ? e : 'There was an error with your formula. Please try again.',
				};
				d20.textchat.incoming(false, eop);
			}
		} else if (
			op.content.substring(0, 4) === '/em ' || op.content.substring(0, 3) == '/e ' || op.content.substring(0, 4) == '/me '
		) {
			const emote = op.content
				.replace('/em ', '')
				.replace('/e ', '')
				.replace('/me ', '');

			var newop = {
				who: d20.textchat.$speakingas.find('option:selected').text(),
				type: 'emote',
				content: emote,
				playerid: window.currentPlayer.id,
				avatar: op.avatar,
			};

			if (listenerid) {
				newop.listenerid = listenerid;
			}

			callback(newop);
		} else if (
			op.content.substring(0, 5) === '/ooc ' || op.content.substring(0, 3) === '/o '
		) {
			var content = op.content.replace('/ooc ', '').replace('/o ', '');

			var newop = {
				who: d20.textchat.$speakingas.find('option:first-child').text(),
				type: 'general',
				playerid: window.currentPlayer.id,
				content,
				avatar: `/users/avatar/${window.currentPlayer.get('d20userid')}/30`,
			};

			if (listenerid) {
				newop.listenerid = listenerid;
			}

			callback(newop);
		} else if (window.is_gm && op.content.substring(0, 4) === '/as ') {
			var content = op.content.substring(4, op.content.length);
			var match = content.match(/\w+|"[^"]+"/);
			if (match != null && match.length) {
				content = content.substring(match[0].length, content.length);
				var newop = {
					who: match[0][0] === '"' ? match[0].substring(1, match[0].length - 1) : match[0],
					type: 'general',
					playerid: window.currentPlayer.id,
					content,
				};

				if (listenerid) {
					newop.listenerid = listenerid;
				}

				callback(newop);
			} else {
				throw 'Invalid. Try /as "Name of Character" <message>';
			}
		} else if (window.is_gm && op.content.substring(0, 6) === '/emas ') {
			var content = op.content.substring(6, op.content.length);
			var match = content.match(/\w+|"[^"]+"/);
			if (match != null && match.length) {
				content = content.substring(match[0].length, content.length);
				var newop = {
					who: match[0][0] === '"' ? match[0].substring(1, match[0].length - 1) : match[0],
					type: 'emote',
					playerid: window.currentPlayer.id,
					content,
				};

				if (listenerid) {
					newop.listenerid = listenerid;
				}

				callback(newop);
			} else {
				throw 'Invalid. Try /as "Name of Character" <message>';
			}
		} else if (window.is_gm && op.content.substring(0, 6) === '/desc ') {
			var content = op.content.substring(6, op.content.length);
			var newop = {
				who: '',
				type: 'desc',
				playerid: window.currentPlayer.id,
				content,
			};

			if (listenerid) {
				newop.listenerid = listenerid;
			}

			callback(newop);
		} else if (op.content.substring(0, 3) === '/w ') {
			const s = op.content.split(' ');
			let ms = s.slice(2, s.length);
			const whisperreg = /\"([^"]+)\"/i;
			var target = s[1];
			let matchfunc = function (input, tomatch) {
				return input.split(' ')[0].toLowerCase() === tomatch.toLowerCase();
			};

			if (s[1].substring(0, 1) === '"') {
				const regsearch = whisperreg.exec(op.content);
				if (regsearch) {
					target = regsearch[1];
					ms = op.content
						.replace(whisperreg, (_match) => '')
						.split(' ')
						.slice(1, s.length);
					matchfunc = function (input, tomatch) {
						return input.toLowerCase() === tomatch.toLowerCase();
					};
				}
			}

			// Try to find the target's id.
			var targetid = 0;
			let targetname;
			if (target.toLowerCase() == 'gm') {
				targetid = 'gm';
				targetname = 'GM';
			}
			if (targetid == 0) {
				// Check players.
				d20.Campaign.players.each((player) => {
					if (matchfunc(player.get('displayname'), target)) {
						targetid = player.id;
						targetname = player.get('displayname');
					}
				});
			}
			if (targetid == 0) {
				// Check characters.
				d20.Campaign.characters.each((character) => {
					if (matchfunc(character.get('name'), target)) {
						// Who conrols this character?
						if (
							!character.get('controlledby') || character.get('controlledby') == ''
						) {
							targetid = 'gm';
							targetname = 'GM';
						} else {
							targetid = character.get('controlledby');
							targetname = character.get('name');
						}
					}
				});
			}

			if (targetid == 0) {
				var eop = {
					who: 'error',
					type: 'error',
					content: `Unable to find a player or character with name: ${target}`,
				};
				d20.textchat.incoming(false, eop);
				return;
			}
			const message = ms.join(' ');
			var newop = {
				who: d20.textchat.$speakingas.find('option:selected').text(),
				type: 'whisper',
				target: targetid,
				target_name: targetname,
				playerid: window.currentPlayer.id,
				content: message,
				avatar: op.avatar,
			};

			if (listenerid) {
				newop.listenerid = listenerid;
			}
			callback(newop);
		} else if (op.content.substring(0, 5) == '/say ') {
			const speaktext = op.content.replace('/say ', '');
			const speakas = d20.textchat.$speakingas.val();

			op.content = speaktext;

			callback(newop);

			if (speakas.indexOf('character|') === -1) {
				// only do bubbles if we are speaking as a character.
				return;
			}
			const charid = speakas.split('|')[1];

			const shout = {
				type: 'say',
				characterid: charid,
				content: speaktext,
			};

			if (listenerid) {
				shout.listenerid = listenerid;
			}
		} else if (op.content.substring(0, 4) == '/fx ') {
			const fxopts = op.content.split(' ');
			let aimed = false;
			var target = op.currentSelected;
			let destination = false;
			let fxName = fxopts[1];
			const typebase = fxName.indexOf('-') > -1 ? fxName.split('-')[0] : fxName;
			// AIMED EFFECT?
			if (d20.fx.presetEffects[typebase]) {
				if (d20.fx.presetEffects[typebase].angle === -1) {
					aimed = true;
				}
			} else if (window.Campaign.custFx) {
				const customFx = window.Campaign.custFx.filter(
					(fx) => fx.get('name').toLowerCase() === typebase.toLowerCase(),
				)[0];
				if (customFx) {
					fxName = customFx.id;
					const definition = window.Campaign.custFx
						.get(fxName)
						.get('definition');
					if (definition.angle === -1) {
						aimed = true;
					}
				}
			}
			// ADDING DEFAULT DURATION IF NOT SET
			if (fxName.indexOf('|') === -1) {
				fxName += '|duration:25';
			} else if (fxName.indexOf('duration') === -1) {
				fxName += ',duration:25';
			}
			// CUSTOM TARGET?
			if (fxopts.length > 2) {
				var targetid = fxopts[2];
				target = d20.Campaign.activePage().thegraphics.get(targetid).view
					.graphic;
			}
			// CUSTOM DESTINATION?
			if (fxopts.length > 3) {
				const destinationid = fxopts[3];
				destination = d20.Campaign.activePage().thegraphics.get(destinationid)
					.view.graphic;
			}
			if (!target) {
				var eop = {
					who: 'error',
					type: 'error',
					content: 'The /fx command requires a selected token or token ID, but none was provided. Select a token and try again.',
				};
				d20.textchat.incoming(false, eop);
			} else {
				const x = target.left;
				const y = target.top;
				if (aimed) {
					if (destination) {
						const velocityInfo = {};
						velocityInfo.distance = getDist(
							destination.left - target.left,
							destination.top - target.top,
						);
						velocityInfo.angle = getAngle(
							destination.left - target.left,
							destination.top - target.top,
						);
						d20.fx.spawnFx(x, y, fxName, velocityInfo);
					} else {
						d20.fx.agencyFx(
							(velocityInfo) => {
								d20.fx.spawnFx(x, y, fxName, velocityInfo);
							},
							x,
							y,
						);
					}
				} else {
					d20.fx.spawnFx(x, y, fxName);
				}
			}

			callback('noop');
		} else if (
			op.content.substring(0, 16) === '/talktomyself on' || op.content === '/talktomyself' || op.content.substring(0, 17) === '/talktomyself off'
		) {
			if (
				op.content.substring(0, 16) === '/talktomyself on' || (op.content === '/talktomyself' && d20.textchat.talktomyself === false)
			) {
				d20.textchat.talktomyself = true;

				var eop = {
					who: 'system',
					type: 'system',
					content: '<strong>You are now talking to yourself.</strong> Chat messages and dice rolls will <strong>NOT BE BROADCAST</strong> to others until you turn this off. Use <code>/talktomyself off</code> to disable.',
				};

				d20.textchat.incoming(false, eop);

				d20.utils.textchatNotify('Talking to Yourself', true);
			} else if (
				op.content.substring(0, 17) === '/talktomyself off' || (op.content === '/talktomyself' && d20.textchat.talktomyself === true)
			) {
				d20.textchat.talktomyself = false;

				var eop = {
					who: 'system',
					type: 'system',
					content: '<strong>You are no longer talking to yourself.</strong> Hooray!',
				};

				d20.textchat.incoming(false, eop);

				d20.utils.textchatNotify(false, true);
			}
		} else if (op.content.split(' ')[0] === '/invite') {
			inviteLinkMessage();
		} else {
			var eop = {
				who: 'error',
				type: 'error',
				content: `Unrecognized command: ${op.content}`,
			};
			d20.textchat.incoming(false, eop);
		}
	};

	var getAngle = function (deltaX, deltaY) {
		let angle = (Math.atan2(deltaY, deltaX) * 180) / Math.PI;
		if (angle < 0) {
			angle = 360 + angle;
		}

		if (angle % 180 > 90) {
			if (angle % 90 > 45) {
				angle += 10 - (angle % 45) / 4.5;
			} else {
				angle += (angle % 45) / 4.5;
			}
		} else if (angle % 90 > 45) {
			angle -= 10 - (angle % 45) / 4.5;
		} else {
			angle -= (angle % 45) / 4.5;
		}

		return angle;
	};

	var getDist = function (deltaX, deltaY) {
		return Math.sqrt(Math.pow(deltaX, 2) + Math.pow(deltaY, 2));
	};

	var sendResultToTracker = function (currentSelected, results, modifytype) {
		if (!currentSelected || currentSelected.type !== 'image') {
			const eop = {
				who: 'error',
				type: 'error',
				content: 'You wanted to send the result of this roll to the turn tracker, but no valid token was selected!',
			};
			d20.textchat.incoming(false, eop);
		} else {
			// See if this token already has a turn.

			d20.Campaign.parentRef
				.child('campaign')
				.child('turnorder')
				.transaction((currentList) => {
					// Make sure our Backbone Model is up to date with the latest data.
					d20.Campaign.set('turnorder', currentList);

					const initlist = d20.Campaign.initiativewindow.cleanList();
					let foundexisting = false;

					if (results.total && results.total % 1 != 0) {
						results.total = parseFloat(results.total.toPrecision(12)); // ROUNDING ERROR BUGFIX
					}
					_.each(initlist, (listitem) => {
						if (listitem.id === currentSelected.model.id) {
							foundexisting = true;
							switch (modifytype) {
								case '+':
									listitem.pr = parseFloat(listitem.pr) + results.total;
									break;
								case '-':
									listitem.pr = parseFloat(listitem.pr) - results.total;
									break;
								default:
									listitem.pr = results.total;
							}
						}
					});
					if (!foundexisting) {
						initlist.push({
							id: currentSelected.model.id,
							pr: results.total,
							custom: '',
							_pageid: d20.Campaign.activePage().id,
						});
					}

					return JSON.stringify(initlist); // we return the new data
				});
		}
	};

	if (window.localStorage.getItem('colorTheme') === 'dark') {
		$('#textchat').addClass('sheet-darkmode');
	}
	d20.textchat.rawChatInput = function (op) {
		const finalop = _.extend(
			{
				who: d20.textchat.$speakingas.find('option:selected').text(),
				type: 'general',
				playerid: window.currentPlayer.id,
				content: '',
			},
			op,
		);
		if (d20.textchat.talktomyself) {
			d20.textchat.incoming(true, finalop);
		} else {
			const newid = fbref.push().key;
			fbref
				.child(newid)
				.setWithPriority(finalop, firebase.database.ServerValue.TIMESTAMP);
		}
	};

	const translateVariableToTokenOrCharacter = function (
		attrname,
		model,
		valtype,
	) {
		if (attrname.toLowerCase() == 'bar1') {
			return valtype == 'max' ? model.get('bar1_max') : model.get('bar1_value');
		}
		if (attrname.toLowerCase() == 'bar2') {
			return valtype == 'max' ? model.get('bar2_max') : model.get('bar2_value');
		}
		if (attrname.toLowerCase() == 'bar3') {
			return valtype == 'max' ? model.get('bar3_max') : model.get('bar3_value');
		}
		if (attrname.toLowerCase() == 'token_name') {
			return model.get('name');
		}
		if (attrname.toLowerCase() === 'token_id') {
			return model.id;
		}

		return undefined;

		// if(model.get("represents") !== "") {
		// character = d20.Campaign.characters.get(model.get("represents"));
		// if(attrname.toLowerCase() == "character_name") {
		// 	return character.get("name");
		// }
		// }
	};

	const handleDoChatInput = async (
		input,
		triggered_by = 'chatbox',
		listenerid = undefined,
		originalRollPromise = undefined,
	) => {
		if (!fbref) {
			console.log('No document!');
			return; // ERROR!
		}

		input = d20.utils.strip_tags(input);

		if (input != '') {
			d20.textchat.commandhistory.push(input);
			d20.textchat.commandhistory = _.last(d20.textchat.commandhistory, 20);
			d20.textchat.commandIndex = 0;

			const speakingas = d20.textchat.$speakingas.find('option:selected').val();
			let avatar = false;
			if (speakingas.indexOf('player') !== -1) {
				avatar = `/users/avatar/${window.currentPlayer.get('d20userid')}/30`;
			} else {
				const character = d20.Campaign.characters.get(speakingas.split('|')[1]);
				if (character) {
					avatar = character.get('avatar');
				}
			}

			let op = {
				who: d20.textchat.$speakingas.find('option:selected').text(),
				type: 'general',
				content: $.trim(input),
				playerid: window.currentPlayer.id,
				avatar,
			};

			if (listenerid) {
				op.listenerid = listenerid;
			}

			let noParseCommands = false;

			if (op.content.substring(0, 1) === '`') {
				noParseCommands = true;
				op.content = op.content.substring(1, op.content.length);
			}

			const selected = d20.engine.selected();
			if (selected.length > 0 && selected[0].model) {
				op.currentSelected = selected[0];
			}

			const macros = {};
			d20.Campaign.players.each((player) => {
				player.macros.each((shortcut) => {
					if (
						player.id == window.currentPlayer.id || shortcut.visibleToCurrentPlayer()
					) {
						macros[`#${shortcut.get('name')}`] = shortcut.get('action');
					}
				});
			});

			let queryCache = {};
			let targetCache = {};
			let prevMode = `${d20.engine.mode}`;

			// Resolve all abilities, variables, and macros, looping through both in case of nesting.
			const reg = /(#[^ \n]+)/gm;
			const abilreg = /(%{[^}]+})/gm;
			const optreg = /&{[^}]+}/;
			const varreg = /(@{[^}]+})/gm;
			let prev_resolved = '';

			let subpasses = 0;

			let makeSubstitutions = async () => {
				const charAttribs = charactersMentioned(op.content, varreg);
				const pendingAttribs = Object.values(charAttribs).reduce((promises, character) => {
					if (!character.attribs.backboneFirebase) {
						character.attribs.backboneFirebase = new BackboneFirebase(character.attribs);
						promises[character.id] = character.attribs.backboneFirebase.reference.once('value');
					}
					return promises;
				}, {});

				const charAbilities = charactersMentioned(op.content, abilreg);
				const pendingAbilities = Object.values(charAbilities).reduce((promises, character) => {
					if (!character.abilities.backboneFirebase) {
						character.abilities.backboneFirebase = new BackboneFirebase(character.abilities);
						promises[character.id] = character.abilities.backboneFirebase.reference.once('value');
					}
					return promises;
				}, {});

				await Promise.all([
					...Object.values(pendingAttribs),
					...Object.values(pendingAbilities),
				]);

				try {
					let origtoken;
					let waitOnTarget = false;
					let _squelch_errors = false;
					let actionHandled = false;

					/// Special case: This option has to be processed beofre we do substitutions.
					op.content = op.content.replace(/&{noerror}/g, (match) => {
						_squelch_errors = true;
						return ''; // take it out
					});

					op.content = op.content.replace(abilreg, (match) => {
						let abilid;
						let charid;
						let character;
						let ability;
						let charname;
						let abilname;
						let abilaction;
						let repsection;

						match = match.substring(2, match.length - 1);
						// Split off the potential roll id
						const firstSplit = match.split('||');
						match = firstSplit[0];
						const originalRollId = firstSplit[1];
						const s = match.split('|');

						if (s.length == 4) {
							abilid = s[1];
							charid = s[0];
							charname = s[2];
							abilname = s[3];
							character = d20.Campaign.characters.get(charid);
							if (character) {
								ability = character.abilities.get(abilid);
								abilaction = ability.get('action');
							}
						}

						if (s.length == 2) {
							charname = s[0];
							abilname = s[1];
						}

						// 3-argument target variant
						if (s.length == 3) {
							charname = s[0];
							abilname = s[2];
						}

						if (
							abilname.substring(0, 10) === 'repeating_' && !(d20.journal.customSheets && d20.journal.customSheets.availableRolls[abilname.toLowerCase()] !== undefined)
						) {
							const _reps = abilname.split('_');
							abilname = `repeating_${_reps[1]}_${_reps.slice(3).join('_')}`;
							repsection = `repeating_${_reps[1]}_${_reps[2]}_`;
						}

						if (charname.toLowerCase() == 'selected') {
							if (!op.currentSelected) {
								throw 'You attempted to use a roll command looking for the value of a selected token, but no tokens are selected.';
								return match;
							}

							if (op.currentSelected.model.get('represents') !== '') {
								character = d20.Campaign.characters.get(
									op.currentSelected.model.get('represents'),
								);
							} else {
								throw 'You attempted to use a roll command looking for a selected token ability, but the selected token does not represent a Character, and therefore has no abilities.';
								return match;
							}
						} else if (charname.toLowerCase() === 'target') {
							if (waitOnTarget || d20.engine.nextTargetCallback) {
								return `%{${match}}`;
							} // don't handle this one yet.

							let targetname = 'target';
							if (s.length > 2) {
								targetname = s[1];
								abilname = s[2];
							}

							if (!abilname) {
								throw 'Syntax Error: You must specify a valid ability to fetch from the target.';
							}

							d20.engine.nextTargetCallback = function (foundtarget) {
								if (foundtarget === false) {
									cleanupRoll();
									d20.engine.nextTargetCallback = false;
									return;
								}
								op.content = op.content.replace(
									/%\${currentTarget\|[^}]+}/,
									(targetmatch) => {
										const targetabil = targetmatch
											.split('|')[1]
											.replace('}', '');
										if (foundtarget.model.get('represents') !== '') {
											const targetchar = d20.Campaign.characters.get(
												foundtarget.model.get('represents'),
											);
											if (targetchar) {
												let foundval;
												targetchar.abilities.each((thisabil) => {
													if (
														thisabil.get('name').toLowerCase() == targetabil.toLowerCase()
													) {
														// pass it back through with a hard-coded character and ability id, since furthe processing is needed.
														foundval = `%{${targetchar.id}|${
															thisabil.id
														}|${targetchar.get('name')}|${thisabil.get(
															'name',
														)}}`;
													}
												});
												if (foundval !== undefined) return foundval;
												// Try for some further processing anyway.
												return `%{${targetchar.get('name')}|${targetabil}}`;
											}
											console.log(
												"Couldn't find character that represents this token.",
											);
										}
										if (!_squelch_errors) {
											const eop = {
												who: 'error',
												type: 'error',
												content: `No ability was found for targeted token by the name of ${targetabil}`,
											};
											d20.textchat.incoming(false, eop);
										}
										return match;
									},
								);
								d20.engine.nextTargetCallback = false;
								targetCache[targetname] = foundtarget;
								makeSubstitutions();
							};
							if (targetCache[targetname] !== undefined) {
								_.defer(() => {
									d20.engine.nextTargetCallback(targetCache[targetname]);
								});
							} else {
								setMode('targeting');
								$('#targetinginstructions .targetname').text(
									ucfirst(targetname),
								);
							}
							waitOnTarget = true;
							return `%\${currentTarget|${abilname}}`;
						}

						if (!character || !ability) {
							// Find char/attribute manually.
							if (!character) {
								d20.Campaign.characters.each((thischar) => {
									if (
										thischar.get('name').toLowerCase() == charname.toLowerCase() || thischar.id === charname
									) {
										character = thischar;
										return false;
									}
								});
							}

							if (!ability && character) {
								character.abilities.each((thisabil) => {
									if (
										thisabil.get('name').toLowerCase() == abilname.toLowerCase() || thisabil.id === abilname
									) {
										ability = thisabil;
										abilaction = ability.get('action');
										return false;
									}
								});
							}

							// Check for sheet rolls or action buttons
							if (
								!ability && character && d20.journal.customSheets
								&& d20.journal.customSheets.availableRolls && d20.journal.customSheets.availableActions
							) {
								const availableRoll = d20.journal.customSheets.availableRolls[abilname.toLowerCase()];
								const availableAction = d20.journal.customSheets.availableActions[abilname.toLowerCase()];
								if (availableRoll !== undefined) {
									ability = availableRoll;
									abilaction = ability;
								} else if (availableAction !== undefined) {
									// Need to prepend repeating section info, if present
									const finalAction = repsection ? repsection + availableAction : availableAction;
									d20.journal.notifyWorkersOfButtonClick(character.id, finalAction, {}, originalRollId);
									// this flag will prevent actually posting things in the chat,
									// since the action is just triggering a sheetworker
									// (which we've already done)
									actionHandled = true;
									return;
								}
							}
						}

						if (character && ability && character.currentPlayerControls()) {
							match = abilaction;
							// Substitute any attributes for the full-form.

							const _inSectionAttrs = {};
							if (repsection) {
								character.attribs.each((attrib) => {
									if (
										attrib.get('name').substring(0, repsection.length) === repsection
									) {
										_inSectionAttrs[
											attrib
												.get('name')
												.substring(repsection.length, attrib.get('name').length)
										] = true;
									}
								});
							}

							const subvarreg = /(@{[^}]+})/gm;
							match = match.replace(subvarreg, (submatch) => {
								const subvarname = submatch.substring(2, submatch.length - 1);
								const sms = subvarname.split('|');

								if (sms.length > 1 && sms[1] !== 'max') {
									return submatch; // it's already a full form, not relative, just return it.
								}
								const repsectionname = repsection !== undefined ? repsection.split('_')[1] : '';

								// Look for Nth repeating section variables
								if (
									sms[0].substring(0, 10) === 'repeating_' && sms[0].indexOf('$') !== -1
								) {
									const smssplit = sms[0].split('_');
									if (
										smssplit.length > 3 && smssplit[2] !== undefined && smssplit[2].substring(0, 1) === '$'
									) {
										const findIndex = parseInt(
											smssplit[2].replace('$', ''),
											10,
										);
										let possibleattribs = [];
										const searchkey = `${smssplit[0]}_${smssplit[1]}`;
										character.attribs.each((attrib) => {
											if (
												attrib
													.get('name')
													.toLowerCase()
													.substring(0, searchkey.length) === searchkey.toLowerCase()
											) {
												const _splitattribname = attrib.get('name').split('_');
												if (
													_splitattribname.length > 2 && _splitattribname[2] !== undefined
												) {
													possibleattribs.push(_splitattribname[2]);
												}
											}
										});
										possibleattribs = _.uniq(possibleattribs);
										possibleattribs = character.repeatingKeyOrder(
											possibleattribs,
											searchkey,
										);
										if (possibleattribs[findIndex] !== undefined) {
											smssplit[2] = possibleattribs[findIndex];
											sms[0] = smssplit.join('_');
										} else if (!_squelch_errors) {
											const eop = {
												who: 'error',
												type: 'error',
												content: `You tried to use the repeating section row at index ${findIndex} for ${searchkey}, but there doesn't seem to be a row at that index.`,
											};
											d20.textchat.incoming(false, eop);
										}
									}
								}

								// Check for variables in repeating sections
								if (repsection && _inSectionAttrs[sms[0]] !== undefined) {
									return `@{${character.get('name')}|${repsection}${sms[0]}${
										sms.length == 2 ? `|${sms[1]}` : ''
									}}`;
								}
								// It's a repeating section attribute we haven't defined yet but we have a default value for?
								if (
									repsection && d20.journal.customSheets && d20.journal.customSheets.availableAttributes[`repeating_${repsectionname}_${sms[0]}`.toLowerCase()] !== undefined && d20.journal.customSheets.availableAttributes[sms[0].toLowerCase()] === undefined
								) {
									return `@{${character.get('name')}|${repsection}${sms[0]}${
										sms.length == 2 ? `|${sms[1]}` : ''
									}}`;
								}
								return `@{${character.get('name')}|${sms[0]}${
									sms.length == 2 ? `|${sms[1]}` : ''
								}}`;
							});

							// Look for ~-style buttons that don't have character id's attached.
							match = match.replace(/\(~[^\)]+\)/g, (match) => {
								const s = match.split('|');
								if (s.length < 2) {
									let abilname = match.substring(2, match.length);
									if (
										repsection && abilname.substring(0, 10) === 'repeating_'
									) {
										const _splitabil = abilname.split('_');
										abilname = repsection + _splitabil.splice(2).join('_');
									}
									return `(~${character.id}|${abilname}`;
								}
								return match;
							});
						} else {
							if (!_squelch_errors) {
								const eop = {
									who: 'error',
									type: 'error',
									content: `No ability was found for %{${charname}|${abilname}}`,
								};
								d20.textchat.incoming(false, eop);
							}
							return match;
						}

						return match;
					});

					op.content = op.content.replace(reg, (match) => {
						if (macros[match] !== undefined) {
							return macros[match];
						}
						return match;
					});

					// TEMP: Redo lazy loading after resolving macro
					const charAttribs = charactersMentioned(op.content, varreg);
					const pendingAttribs = Object.values(charAttribs).reduce((promises, character) => {
						if (!character.attribs.backboneFirebase) {
							character.attribs.backboneFirebase = new BackboneFirebase(character.attribs);
							promises[character.id] = character.attribs.backboneFirebase.reference.once('value');
						}
						return promises;
					}, {});

					const charAbilities = charactersMentioned(op.content, abilreg);
					const pendingAbilities = Object.values(charAbilities).reduce((promises, character) => {
						if (!character.abilities.backboneFirebase) {
							character.abilities.backboneFirebase = new BackboneFirebase(character.abilities);
							promises[character.id] = character.abilities.backboneFirebase.reference.once('value');
						}
						return promises;
					}, {});

					await Promise.all([
						...Object.values(pendingAttribs),
						...Object.values(pendingAbilities),
					]);
					// END TEMP (pain)

					op.content = op.content.replace(varreg, (match) => {
						let attrid;
						let charid;
						let character;
						let attribute;
						let charname;
						let attrname;
						let repsection;

						match = match.substring(2, match.length - 1);
						const s = match.split('|');
						let valtype = 'current';
						let _overridePermissions = false;

						if (s.length == 4) {
							attrid = s[1];
							charid = s[0];
							charname = s[2];
							attrname = s[3];
							character = d20.Campaign.characters.get(charid);
							if (character) {
								attribute = character.attribs.get(attrid);
							}
						}

						if (!character) {
							charname = s[0];
							attrname = s[1];
							if (
								s.length > 2 && (`${s[2]}`.toLowerCase() == 'max' || `${s[3]}`.toLowerCase() == 'max')
							) {
								valtype = 'max';
							}

							if (charname.toLowerCase() == 'selected') {
								if (!op.currentSelected) {
									throw 'You attempted to use a roll command looking for the value of a selected token, but no tokens are selected.';
									return match;
								}

								const tokenvariable = translateVariableToTokenOrCharacter(
									attrname,
									op.currentSelected.model,
									valtype,
								);
								if (tokenvariable !== undefined) return tokenvariable;

								if (op.currentSelected.model.get('represents') !== '') {
									character = d20.Campaign.characters.get(
										op.currentSelected.model.get('represents'),
									);
									if (attrname.toLowerCase() === 'character_name') {
										return character.get('name');
									}
									if (attrname.toLowerCase() === 'character_id') return character.id;
								}
							} else if (charname.toLowerCase() === 'target') {
								if (waitOnTarget || d20.engine.nextTargetCallback) {
									return `@{${match}}`;
								} // don't handle this one yet.

								const prevMode = `${d20.engine.mode}`;
								let targetname = 'target';
								if (s.length > 2) {
									targetname = s[1];
									attrname = s[2];
								}

								if (!attrname) {
									throw 'Syntax Error: You must specify a valid attribute to fetch from the target.';
								}

								d20.engine.nextTargetCallback = async function (foundtarget) {
									if (foundtarget === false) {
										d20.engine.nextTargetCallback = false;
										cleanupRoll();
										// Reselect Original Tokens
										setTimeout(() => {
											if (d20.engine.mode != 'targeting') {
												for (let i = 0; i < origtoken.length; i++) {
													d20.engine.select(origtoken[i]);
												}
											}
										}, 500);
										return;
									}

									// Lazy load if necessary.
									const targetAttribs = d20.Campaign.characters.get(
										foundtarget?.model?.get('represents')
									)?.attribs;
									if (targetAttribs) {
										if (!targetAttribs.backboneFirebase) {
											targetAttribs.backboneFirebase = new BackboneFirebase(targetAttribs);
											await targetAttribs.backboneFirebase.reference.once('value');
										}
									}
									op.content = op.content.replace(
										/@\${currentTarget\|[^}]+}/,
										(targetmatch) => {
											const targetvar = targetmatch
												.split('|')[1]
												.replace('}', '');
											const tokenvariable = translateVariableToTokenOrCharacter(
												targetvar,
												foundtarget.model,
												valtype,
											);
											if (tokenvariable !== undefined) return tokenvariable;
											if (foundtarget.model.get('represents') !== '') {
												const targetchar = d20.Campaign.characters.get(
													foundtarget.model.get('represents'),
												);
												if (targetchar) {
													if (attrname.toLowerCase() === 'character_name') {
														return targetchar.get('name');
													}
													if (attrname.toLowerCase() === 'character_id') return targetchar.id;
													return `@{TARGET:${targetname}|${targetvar}${
														valtype === 'max' ? '|max' : ''
													}}`;
												}
												console.log(
													"Couldn't find character that represents this token.",
												);
											}
											if (!_squelch_errors) {
												const eop = {
													who: 'error',
													type: 'error',
													content: `No attribute was found for targeted token by the name of ${targetvar}`,
												};
												d20.textchat.incoming(false, eop);
											}
											return '';
										},
									);
									d20.engine.nextTargetCallback = false;
									targetCache[targetname] = foundtarget;
									makeSubstitutions();
									// Reselect Original Tokens
									setTimeout(() => {
										if (d20.engine.mode != 'targeting') {
											for (let i = 0; i < origtoken.length; i++) {
												d20.engine.select(origtoken[i]);
											}
										}
									}, 500);
								};
								if (targetCache[targetname] !== undefined) {
									_.defer(() => {
										d20.engine.nextTargetCallback(targetCache[targetname]);
									});
								} else {
									// Remember original tokens
									if (d20.engine.mode != 'targeting') {
										origtoken = d20.engine.selected();
									}
									setMode('targeting');
									$('#targetinginstructions .targetname').text(
										ucfirst(targetname),
									);
								}
								waitOnTarget = true;
								return `@\${currentTarget|${attrname}}`;
							} else if (charname.toLowerCase() === 'tracker') {
								const currentorder = d20.Campaign.initiativewindow.cleanList();
								let foundvalue;
								_.each(currentorder, (orderitem) => {
									if (
										orderitem.custom.toLowerCase() === attrname.toLowerCase()
									) {
										foundvalue = orderitem.pr;
										return false;
									}
									if (orderitem.id) {
										const tokenobj = d20.Campaign.activePage().thegraphics.get(
											orderitem.id,
										);
										if (
											tokenobj && tokenobj.get('name').toLowerCase() === attrname.toLowerCase()
										) {
											foundvalue = orderitem.pr;
											return false;
										}
									}
								});

								if (foundvalue !== undefined) return foundvalue;

								if (!_squelch_errors) {
									var eop = {
										who: 'error',
										type: 'error',
										content: `No turn order item was found by the name ${attrname}`,
									};
									d20.textchat.incoming(false, eop);
								}
								return '';
							}
						}

						if (attrname.substring(0, 10) === 'repeating_') {
							const _reps = attrname.split('_');
							repsection = `repeating_${_reps[1]}_${_reps[2]}_`;
						}

						if (!character || !attribute) {
							// Find char/attribute manually.

							if (
								!character && charname.substring(0, 7) === 'TARGET:' && targetCache[charname.substring(7, charname.length)]
							) {
								character = d20.Campaign.characters.get(
									targetCache[charname.substring(7, charname.length)].model.get(
										'represents',
									),
								);
								_overridePermissions = true;
							}

							if (!character) {
								d20.Campaign.characters.each((thischar) => {
									if (
										thischar.get('name').toLowerCase() == charname.toLowerCase()
									) {
										character = thischar;
										return false;
									}
								});
							}

							if (!attribute && character) {
								// Look for Nth repeating section variables
								if (
									attrname.substring(0, 10) === 'repeating_' && attrname.indexOf('$') !== -1
								) {
									const smssplit = attrname.split('_');
									if (
										smssplit.length > 3 && smssplit[2] !== undefined && smssplit[2].substring(0, 1) === '$'
									) {
										const findIndex = parseInt(
											smssplit[2].replace('$', ''),
											10,
										);
										let possibleattribs = [];
										const searchkey = `${smssplit[0]}_${smssplit[1]}`;
										character.attribs.each((attrib) => {
											if (
												attrib
													.get('name')
													.toLowerCase()
													.substring(0, searchkey.length) === searchkey.toLowerCase()
											) {
												const _splitattribname = attrib.get('name').split('_');
												if (
													_splitattribname.length > 2 && _splitattribname[2] !== undefined
												) {
													possibleattribs.push(_splitattribname[2]);
												}
											}
										});
										possibleattribs = _.uniq(possibleattribs);
										possibleattribs = character.repeatingKeyOrder(
											possibleattribs,
											searchkey,
										);
										if (possibleattribs[findIndex] !== undefined) {
											smssplit[2] = possibleattribs[findIndex];
											attrname = smssplit.join('_');
										} else if (!_squelch_errors) {
											var eop = {
												who: 'error',
												type: 'error',
												content: `You tried to use the repeating section row at index ${findIndex} for ${searchkey}, but there doesn't seem to be a row at that index.`,
											};
											d20.textchat.incoming(false, eop);
										}
									}
								}

								attribute = character.attribs.find(
									(thisattrib) => thisattrib.get('name').toLowerCase() === attrname.toLowerCase(),
								);
							}
						}

						if (!character) {
							var eop = {
								who: 'error',
								type: 'error',
								content: `No character was found for '${charname}'`,
							};
							d20.textchat.incoming(false, eop);

							return match;
						}

						const _inSectionAttrs = {};
						if (repsection) {
							character.attribs.each((attrib) => {
								if (
									attrib.get('name').substring(0, repsection.length) === repsection
								) {
									_inSectionAttrs[
										attrib
											.get('name')
											.substring(repsection.length, attrib.get('name').length)
									] = true;
								}
							});
						}

						const _substituteShortForms = function (thiscommand) {
							// Substitute any attributes for the full-form.
							const subvarreg = /(@{[^}]+})/gm;
							thiscommand = `${thiscommand}`.replace(subvarreg, (submatch) => {
								const subvarname = submatch.substring(2, submatch.length - 1);
								const sms = subvarname.split('|');

								if (sms.length > 1 && sms[1] !== 'max') {
									return submatch; // it's already a full form, not relative, just return it.
								}

								const repsectionname = repsection !== undefined ? repsection.split('_')[1] : '';

								// Check for variables in repeating sections
								if (repsection && _inSectionAttrs[sms[0]] !== undefined) {
									return `@{${
										_overridePermissions ? charname : character.get('name')
									}|${repsection}${sms[0]}${
										sms.length == 2 ? `|${sms[1]}` : ''
									}}`;
								}
								// It's a repeating section attribute we haven't defined yet but we have a default value for?
								if (
									repsection && d20.journal.customSheets && d20.journal.customSheets.availableAttributes[`repeating_${repsectionname}_${sms[0]}`.toLowerCase()] !== undefined && d20.journal.customSheets.availableAttributes[sms[0].toLowerCase()] === undefined
								) {
									return `@{${
										_overridePermissions ? charname : character.get('name')
									}|${repsection}${sms[0]}${
										sms.length == 2 ? `|${sms[1]}` : ''
									}}`;
								}
								return `@{${
									_overridePermissions ? charname : character.get('name')
								}|${sms[0]}${sms.length == 2 ? `|${sms[1]}` : ''}}`;
							});

							// Look for ~-style buttons that don't have character id's attached.
							thiscommand = thiscommand.replace(/\(~[^\)]+\)/g, (match) => {
								const s = match.split('|');
								if (s.length < 2) {
									let abilname = match.substring(2, match.length);
									if (
										repsection && abilname.substring(0, 10) === 'repeating_'
									) {
										const _splitabil = abilname.split('_');
										abilname = repsection + _splitabil.splice(2).join('_');
									}
									return `(~${character.id}|${abilname}`;
								}
								return match;
							});
							return thiscommand;
						};

						if (attrname === 'character_name') {
							return character.get('name');
						}
						if (attrname === 'character_id') {
							return character.id;
						}

						let _possibleAnswer;

						if (
							attribute && (character.currentPlayerControls() || _overridePermissions === true)
						) {
							if (valtype == 'max') {
								_possibleAnswer = attribute.get('max');
							} else {
								_possibleAnswer = attribute.get('current');
							}
						}

						if (_possibleAnswer !== undefined && _possibleAnswer !== '') {
							// Definitely return this.
							return _substituteShortForms(_possibleAnswer);
						}

						// Only bother with the below if we really need it.

						let _defaultAnswer;
						let _defaultKey = (
							attrname + (valtype === 'max' ? '_max' : '')
						).toLowerCase();

						// If we are trying to fetch an attribute in a repeating section, we have to check for the default value without the ROW ID.
						// e.g. if it's @{repeating_spells_-ABC12_SpellName} the default value is actually stored as "repeating_spells_SpellName" since it's shared across all repeating section rows.
						if (
							_defaultKey.substring(0, 10) === 'repeating_' && (!d20.journal.customSheets || d20.journal.customSheets.availableAttributes[_defaultKey] === undefined)
						) {
							const _dks = _defaultKey.split('_');
							if (!isNaN(_dks[2]) || _dks[2].substring(0, 1) === '-') {
								_dks.splice(2, 1);
								_defaultKey = _dks.join('_');
							}
						}

						if (
							(character.currentPlayerControls() || _overridePermissions === true) && d20.journal.customSheets && d20.journal.customSheets.availableAttributes && d20.journal.customSheets.availableAttributes[_defaultKey] !== undefined
						) {
							const _customSheetAttr = d20.journal.customSheets.availableAttributes[_defaultKey];
							_defaultAnswer = _customSheetAttr;
						}

						// Is it blank, but we don't have a better default?
						if (_possibleAnswer !== undefined && _defaultAnswer === undefined) {
							return _substituteShortForms(_possibleAnswer);
						}
						if (_defaultAnswer !== undefined) {
							return _substituteShortForms(_defaultAnswer);
						}

						// We fell through all the way and found nothing!
						if (!_squelch_errors) {
							var eop = {
								who: 'error',
								type: 'error',
								content: `No attribute was found for @{${charname}|${attrname}}`,
							};

							d20.textchat.incoming(false, eop);
						}

						return match;
					});

					subpasses++;

					if (waitOnTarget) return;

					// This flag indicates we've completely handled this action
					// so we don't want to put anything in the chat
					if (actionHandled) return;

					if (op.content == prev_resolved || subpasses > 99) {
						processQueries();
					} else {
						prev_resolved = op.content;
						makeSubstitutions();
					}
				} catch (e) {
					const eop = {
						who: 'error',
						type: 'error',
						content: `${e}`,
					};
					d20.textchat.incoming(false, eop);
				}
			};

			let processMultiOps = function () {
				// Allow having \n inside of roll templates.
				const bracketregex = /{{[\s\S]*?}}/g;

				op.content = op.content.replace(bracketregex, (match) => match.replace(/\n/g, '%NEWLINE%'));

				const multicommands = op.content.split('\n');

				let orderedops = [];
				let finishedops = 0;

				const checkFinishedOps = function () {
					if (!orderedops || finishedops < orderedops.length) {
						return;
					}

					const allPromises = [];

					for (let j = 0; j < orderedops.length; j++) {
						if (orderedops[j] === 'noop') {
							continue;
						}

						// This promise will allow us to pause here and wait for computed dice results, if needed
						const rollPromise = new Promise((resolve) => {
							const chatOp = orderedops[j];
							if (originalRollPromise) {
								// If this roll was initiated with the 'startRoll' sheetworker function
								// We need to pause here and wait for the modified results from the 'finishRoll' function

								// Reformat results from dice server
								const processedResults = (0,_util_textchatUtils__WEBPACK_IMPORTED_MODULE_4__.parseRollData)(chatOp);
								// Create a new promise that will be resolved with the 'finishRoll' sheetworker function
								const finalRollPromise = (0,_util_textchatUtils__WEBPACK_IMPORTED_MODULE_4__.createRollPromise)(d20.journal.pendingRollPromises, originalRollPromise.promiseId);
								// This will resolve the initial roll promise and send the results from the dice server
								// to the sheetworker
								originalRollPromise.resolve({
									rollId: finalRollPromise.promiseId,
									results: processedResults,
								});
								// This promise will be resolved when the sheet calls the finishRoll function,
								// And will include the final roll string, along with the custom computed roll results
								finalRollPromise.promise.then((results) => {
									// Mark the promise as resolved, so that it doesn't get timed out
									finalRollPromise.resolved = true;
									// Add the computed result to each roll, if provided
									(0,_util_textchatUtils__WEBPACK_IMPORTED_MODULE_4__.addComputedResults)(chatOp, results.rollResults, d20.utils.strip_tags);
									// After we've modified the roll with our new information
									// resolve to send it to firebase
									resolve(chatOp);
								}).catch(() => {
									// If we're rejected, it means we've timed out. Post the roll and a message that
									// We never got the results back. This helps prevent 'swallowing' undesirable roll results
									chatOp.content = `${i18n('sheetworker_roll_not_finished')} ${chatOp.content}`;
									resolve(chatOp);
								});
							} else {
								// If this roll wasn't initiated with the 'startRoll' sheetworker function
								// Resolve immediately to send to firebase as usual
								resolve(chatOp);
							}
						}).then((chatOp) => {
							if (chatOp._fbid) {
								const _opid = chatOp._fbid;
								delete chatOp._fbid;
								if (d20.textchat.talktomyself) {
									chatOp.id = _opid;
									chatOp.timestamp = new Date().getTime();
									d20.textchat.incoming(true, chatOp);
								} else {
									sendGAChatEvent(chatOp);
									fbref
										.child(_opid)
										.setWithPriority(
											chatOp,
											firebase.database.ServerValue.TIMESTAMP,
										);
								}
							} else if (d20.textchat.talktomyself) {
								chatOp.id = fbref.push().key;
								chatOp.timestamp = new Date().getTime();
								sendGAChatEvent(chatOp);
								d20.textchat.incoming(true, chatOp);
							} else {
								const newid = fbref.push().key;
								sendGAChatEvent(chatOp);
								fbref
									.child(newid)
									.setWithPriority(chatOp, firebase.database.ServerValue.TIMESTAMP);
							}
						});

						allPromises.push(rollPromise);
					}

					// Wait for cleanup until all rolls have finished
					Promise.all(allPromises).then(() => {
						cleanupRoll();
						orderedops = null;
					});
				};

				let i = 0;

				_.each(multicommands, (splitcontent) => {
					orderedops.push(false);
					const tempop = _.clone(op);
					tempop.content = splitcontent;

					tempop.content = tempop.content.replace(/%NEWLINE%/g, '<br/>\n');

					const idx = i + 0;
					let _userolltemplate;

					const callback = function (thisop) {
						if (typeof thisop === 'object') {
							// Make sure our inline rolls survived.
							if (tempop.inlinerolls) {
								thisop.inlinerolls = tempop.inlinerolls;
							}

							if (_userolltemplate) {
								thisop.rolltemplate = _userolltemplate;
							}

							// Delete unneeded info
							delete thisop.currentSelected;
							delete thisop.opts;

							if (thisop.type == 'api') {
								// Add "Selected" info.
								const selected = d20.engine.selected();
								if (selected && selected.length > 0) {
									thisop.selected = [];
									_.each(selected, (anobj) => {
										if (anobj.model == undefined) return true; // next
										thisop.selected.push({
											_type: anobj.model.get('type') == 'image' ? 'graphic' : anobj.model.get('type'),
											_id: anobj.model.id,
										});
									});
								}
							}
						}
						orderedops[idx] = thisop;
						finishedops++;
						_.defer(() => {
							checkFinishedOps();
						});
					};

					const inlineRollsCompleteCallback = function () {
						// Check for options.
						if (!noParseCommands) {
							tempop.content = tempop.content.replace(optreg, (match) => {
								match = match.substring(2, match.length - 1);
								if (!tempop.opts) tempop.opts = {};
								const eachopt = match.split(',');
								for (let oi = 0; oi < eachopt.length; oi++) {
									const optsplit = eachopt[oi].split(':');
									tempop.opts[optsplit[0]] = optsplit.length > 1 ? optsplit[1] : true;
								}
								return '';
							});
						}

						if (tempop.opts && tempop.opts.template !== undefined) {
							_userolltemplate = tempop.opts.template;
						}

						if (tempop.content.substring(0, 2) === '//') {
							callback('noop');
						} else if (
							!noParseCommands && tempop.content.substring(0, 1) == '/'
						) {
							postProcessOp(tempop, callback);
						} else {
							if (!noParseCommands && tempop.content.substring(0, 1) == '!') {
								tempop.type = 'api';
							}

							callback(tempop);
						}
					};

					if (!noParseCommands) {
						processInlineRolls(tempop, inlineRollsCompleteCallback);
					} else {
						inlineRollsCompleteCallback();
					}

					d20.textchat.diceengine.flushRemoteQueue();

					i++;
				});
			};

			var processInlineRolls = function (thisop, thisopcallback) {
				// Resolve all inline roll results.

				const inlinerollreg = /(\[\[.+\]\](?!\]))/gm;
				const inlinerolls = [];
				let inlinerollcount = 0;
				let inlinerollscompleted = 0;

				const checkFinishedInlineRolls = function () {
					if (inlinerollscompleted < inlinerollcount) return;
					thisop.inlinerolls = inlinerolls;
					thisopcallback();
				};

				const _findInlineRolls = function (subcontent, inlinecallback) {
					const stringStarts = [];
					const ignoreBracketsAt = [];
					let ignorenext = false;
					let incomment = false;
					let levelsdeep = 0;
					let stopparsing = false;

					while (!stopparsing) {
						for (var i = 0; i < subcontent.length; i++) {
							if (subcontent[i] === '[') {
								if (subcontent[i - 1] === '[') {
									// Started one!

									levelsdeep++;

									if (subcontent[i - 2] === '$') {
										// This is a result, not an actual roll.
										ignorenext = true;
										continue;
									} else {
										stringStarts.push(i - 1);
									}
								} else if (subcontent[i + 1] === '[') {
									// Do nothing, we'll get it next loop
								} else {
									// Comment
									incomment = true;
								}
							} else if (subcontent[i] === ']') {
								if (incomment) {
									incomment = false;
									ignoreBracketsAt.push(i);
									continue;
								}

								if (
									subcontent[i - 1] === ']' && ignoreBracketsAt.indexOf(i - 1) === -1
								) {
									// Stopped one!

									levelsdeep--;

									if (ignorenext) {
										ignorenext = false;
										continue;
									}

									var startedAt = stringStarts.slice(-1)[0];
									var rollstring = subcontent.substring(startedAt, i + 1);

									if (rollstring.indexOf('$[[') !== -1) {
										continue;
									}

									(function () {
										const myinlinerollindex = inlinerollcount + 0;
										const mylevelsdeep = levelsdeep + 0;
										inlinerollcount++; // global counter

										subcontent = `${subcontent.substring(
											0,
											startedAt,
										)}$[[${myinlinerollindex}]]${subcontent.substring(
											i + 1,
											subcontent.length,
										)}`;

										thisop.content = subcontent;

										_processRoll(rollstring, myinlinerollindex, () => {
											if (mylevelsdeep > 0) {
												// We're a nested roll, so substitute in the result value *immediately*.
												thisop.content = thisop.content.replace(
													`$[[${myinlinerollindex}]]`,
													inlinerolls[myinlinerollindex].results.total,
												);
											}

											inlinecallback();
										});
									}());

									if (levelsdeep > 0) {
										d20.textchat.diceengine.flushRemoteQueue();
										return;
									}
									break; // this will allow us to re-start our loop to get an accurate length count since a substitution has been made.
								}
							}
						}

						stopparsing = true; // if we didn't break, we didn't do any subsitutions, so fall through completely and finish.
					}

					// Made it all the way through? Nothing left to do!
					inlinecallback(subcontent);
				};

				var _processRoll = function (match, myinlinerollindex, rollcallback) {
					match = $.trim(match.substring(2, match.length - 2));

					const inlineopts = {};

					// Check for options.
					match = match.replace(optreg, (optmatch) => {
						optmatch = optmatch.substring(2, optmatch.length - 1);
						const eachopt = optmatch.split(',');
						for (let oi = 0; oi < eachopt.length; oi++) {
							const optsplit = eachopt[oi].split(':');
							inlineopts[optsplit[0]] = optsplit.length > 1 ? optsplit[1] : true;
						}
						return '';
					});

					d20.textchat.diceengine.process(
						match,
						(results, rollid, signature, tdseed) => {
							d20.textchat.globalrolled++;

							if (results.rolls && results.rolls.length > 0) {
								try {
									_.each(results.rolls, (roll) => {
										if (roll.table) {
											if (!d20.utils.stattracker.rolltables) {
												d20.utils.stattracker.rolltables = true;
											}

											const table = d20.Campaign.rollabletables.findTableByName(
												roll.table,
											);
											const weighted = table.getWeightedArray();
											if (table) {
												_.each(roll.results, (result) => {
													result.tableItem = table.tableitems
														.get(weighted[result.tableidx])
														.toJSON();
												});
											}
										}
									});
								} catch (e) {
									console.log('ERROR matching table');
									console.log(e);
								}
							}

							inlinerolls[myinlinerollindex] = {
								expression: match,
								results,
								signature,
								rollid,
							};

							if (tdseed) {
								inlinerolls[myinlinerollindex].tdseed = tdseed;
							}

							if (inlineopts.tracker) {
								sendResultToTracker(
									thisop.currentSelected,
									results,
									inlineopts.tracker,
								);
							}

							inlinerollscompleted++;

							rollcallback();
						},
					);
				};

				let prevstring = '';

				var inlinefinalcallback = function (newcontent) {
					if (prevstring !== thisop.content) {
						prevstring = thisop.content;
						_findInlineRolls(`${thisop.content}`, inlinefinalcallback);
					} else {
						checkFinishedInlineRolls();
					}
				};

				_findInlineRolls(`${thisop.content}`, inlinefinalcallback);
			};

			const sendGAChatEvent = (message) => {
				let player_display_name = window.currentPlayer.attributes.displayname;
				if (window.is_gm) {
					player_display_name += ' (GM)';
				}
				const player_selected = window.currentPlayer.attributes.speakingas === '' || window.currentPlayer.attributes.speakingas.split('|')[0] === 'player';
				const ooc = !player_selected && player_display_name === message.who;
				const speakingas = player_display_name === message.who ? 'player' : 'character';
				const selected_display_name = player_selected
					? player_display_name
					: d20.Campaign.characters.get(
						window.currentPlayer.attributes.speakingas.split('|')[1],
					).attributes.name;
				const custom_speakingas = message.who !== selected_display_name && !ooc;

				let event_action = message.type === 'whisper' && message.target === 'gm' ? 'gm_whisper' : message.type;
				if (d20.textchat.talktomyself) {
					event_action = 'talktomyself';
				}
				if (ooc) {
					event_action = 'ooc';
				} else if (custom_speakingas) {
					event_action = 'custom_as';
				}

				ga('send', {
					hitType: 'event',
					eventCategory: window.is_gm ? 'GmChatInput' : 'ChatInput',
					eventAction: event_action,
					eventLabel: triggered_by,
				});
				if (!d20.textchat.talktomyself) {
					ga('send', {
						hitType: 'event',
						eventCategory: 'SpeakingAs',
						eventAction: event_action,
						eventLabel: speakingas,
					});
				}
			};

			// Resolve all query variables.

			const queryreg = /(\?{[^}]+})/m;
			let numqueries = 0;

			var processQueries = function () {
				let foundquery = false;
				op.content = op.content.replace(queryreg, (match) => {
					if (numqueries > 99) return match;

					foundquery = true;
					numqueries++;

					match = $.trim(match.substring(2, match.length - 1));
					const ms = match.split('|');
					match = ms[0];

					if (queryCache[match] !== undefined) {
						_.defer(() => {
							processQueries();
						});
						return queryCache[match];
					}

					if (ms.length <= 2) {
						var $querydialog = $(
							`<div><p style='font-size: 1.15em;'><strong>${d20.utils.strip_tags(
								match,
							)}:</strong> <input type='text' style='width: 75px; margin-left: 5px;'></p></div>`,
						);
					} else {
						const options = [];
						ms.each((eachopt) => {
							const opt = eachopt.split(',');
							const optlabel = opt[0];
							let optvalue = opt[1] ? opt[1] : opt[0];
							optvalue = optvalue.replace(/'/g, '&#39');

							if (opt != match) {
								options.push(
									`<option value='${d20.utils.strip_tags(
										optvalue,
									)}'>${d20.utils.strip_tags(optlabel)}</option>`,
								);
							}
						});
						var $querydialog = $(
							`<div><p style='font-size: 1.15em;'><strong>${d20.utils.strip_tags(
								match,
							)}:</strong> <select style='width: 150px; margin-left: 5px;'>${options.join(
								'',
							)}</select></p></div>`,
						);
					}

					$querydialog.dialog({
						title: 'Input Value',
						beforeClose() {
							return false;
						},
						buttons: {
							Submit() {
								if (ms.length < 3) {
									queryCache[match] = $querydialog.find('input').val();
									op.content = op.content.replace(
										'?${1}',
										$querydialog.find('input').val(),
									);
								} else {
									queryCache[match] = $querydialog.find('select').val();
									op.content = op.content.replace(
										'?${1}',
										$querydialog.find('select').val(),
									);
								}
								$querydialog.off();
								$querydialog.dialog('destroy').remove();
								processQueries();
								d20.textchat.$textarea.focus();
							},
							Cancel() {
								$querydialog.off();
								$querydialog.dialog('destroy').remove();
								cleanupRoll();
							},
						},
					});
					$querydialog.on('keydown', 'input, select', (e) => {
						if (e.which == 13) {
							if (ms.length < 3) {
								queryCache[match] = $querydialog.find('input').val();
								op.content = op.content.replace(
									'?${1}',
									$querydialog.find('input').val(),
								);
							} else {
								queryCache[match] = $querydialog.find('select').val();
								op.content = op.content.replace(
									'?${1}',
									$querydialog.find('select').val(),
								);
							}
							$querydialog.off();
							$querydialog.dialog('destroy').remove();
							processQueries();
							e.stopPropagation();
							e.preventDefault();
							d20.textchat.$textarea.focus();
						}
					});
					_.defer(() => {
						if (ms.length <= 2) {
							if (ms.length === 2) {
								$querydialog
									.find('input')
									.val(ms[1])
									.select();
							}
							$querydialog.find('input').focus();
						} else {
							// Alternate way of doing it: Highlihgt the Submit button so Enter will press it.
							// $querydialog.parent().find(".ui-dialog-buttonpane button:first-child").focus();
							// CUrent way of doing it: Focus the select element.
							$querydialog.find('select').focus();
						}
					});
					return '?${1}';
				});

				if (!foundquery) {
					processMultiOps();
				}
			};

			var cleanupRoll = function () {
				makeSubstitutions = null;
				processInlineRolls = null;
				processMultiOps = null;
				processQueries = null;
				const inlinerolls = null;
				op = null;
				prev_resolved = null;
				queryCache = null;
				targetCache = null;
				if (d20.engine.mode !== prevMode) {
					setMode(prevMode);
				}
				prevMode = null;
			};

			if (noParseCommands) {
				processMultiOps();
			} else {
				makeSubstitutions();
			}
		}
	};

	d20.textchat.doChatInput = handleDoChatInput;

	$('#textchat-input').on('click', 'button', () => {
		const input = $.trim(d20.textchat.$textarea.val());

		d20.textchat.doChatInput(input);

		d20.textchat.$textarea.val('').focus();
	});

	let lastBroadcastTyping = false;

	const broadcastTyping = function (showas) {
		const ctime = new Date().getTime();

		if (lastBroadcastTyping && ctime - lastBroadcastTyping < 3000) {
			return;
		}

		if (d20.textchat.talktomyself) {
			return;
		}

		lastBroadcastTyping = ctime;
		d20.textchat.sendShout({
			type: 'istyping',
			playerid: window.currentPlayer.id,
			content: showas,
			time: new Date().getTime(),
		});
	};

	d20.textchat.$textarea.bind('keyup', function () {
		let curval = $(this).val();
		if (curval.length > 1 && curval.substring(0, 1) != '#') {
			let showas = false;
			if (
				curval.substring(0, 4) === '/as ' || curval.substring(0, 6) === '/emas '
			) {
				curval = curval.replace('/as ', '').replace('/emas ', '');

				const numspaces = curval.match(/ /g);
				if (numspaces == null || numspaces.length < 2) return;

				const numquotes = curval.match(/"/g);
				if (curval[0] === '"' && numquotes !== null && numquotes.length < 2) return;

				const match = curval.match(/\w+|"[^"]+"/);

				if (match != null && match.length && match.length > 0) {
					showas = match[0][0] === '"' ? match[0].substring(1, match[0].length - 1) : match[0];
				}
			} else if (
				curval.substring(0, 5) === '/ooc ' || curval.substring(0, 3) === '/o ' || curval.substring(0, 6) === '/desc ' || curval.substring(0, 4) === '/em ' || curval.substring(0, 4) === '/me ' || curval.substring(0, 3) === '/e '
			) {
				showas = d20.textchat.$speakingas.find('option:first-child').text();
			} else if (curval.substring(0, 1) !== '/') {
				showas = d20.textchat.$speakingas.find('option:selected').text();
			}

			if (showas) {
				broadcastTyping(showas);
			}
		}
	});

	d20.textchat.$textarea.bind('keydown', function (e) {
		if (e.which === 13) {
			if (autoCompleteOpen) {
				return false;
			}
			if (e.shiftKey === true) {
				return;
			}
			$(this)
				.parent()
				.find('button')
				.trigger('click');
			e.preventDefault();
		}
	});

	d20.textchat.$textarea.bind('keyup', 'up', function () {
		const currentcommand = d20.textchat.commandhistory[d20.textchat.commandhistory.length + d20.textchat.commandIndex
		];
		if ($(this).val() == '' || $(this).val() == currentcommand) {
			if (
				Math.abs(d20.textchat.commandIndex) < d20.textchat.commandhistory.length + 1
			) {
				d20.textchat.commandIndex = d20.textchat.commandIndex - 1;
			}
			$(this).val(
				d20.textchat.commandhistory[
					d20.textchat.commandhistory.length + d20.textchat.commandIndex
				],
			);
		}
	});

	d20.textchat.$textarea.bind('keyup', 'down', function () {
		const currentcommand = d20.textchat.commandhistory[d20.textchat.commandhistory.length + d20.textchat.commandIndex
		];
		if ($(this).val() == '' || $(this).val() == currentcommand) {
			if (d20.textchat.commandIndex < 0) {
				d20.textchat.commandIndex = d20.textchat.commandIndex + 1;
			}
			$(this).val(
				d20.textchat.commandhistory[
					d20.textchat.commandhistory.length + d20.textchat.commandIndex
				],
			);
		}
	});

	// Defines for the example the match to take which is any word (with Umlauts!!).
	const _leftMatch = function (string, area) {
		return string.substring(0, area.selectionStart).match(/[\w#%{]+$/);
	};

	const _setCursorPosition = function (area, pos) {
		if (area.setSelectionRange) {
			area.setSelectionRange(pos, pos);
		} else if (area.createTextRange) {
			const range = area.createTextRange();
			range.collapse(true);
			range.moveEnd('character', pos);
			range.moveStart('character', pos);
			range.select();
		}
	};

	d20.textchat.$textarea.autocomplete({
		delay: 100,
		autoFocus: true,
		position: {
			my: 'left top',
			at: 'left bottom',
		},
		source(request, response) {
			let str = _leftMatch(request.term, d20.textchat.$textarea[0]);
			str = str != null ? str[0] : '';

			if (str[0] === '%' && str[1] !== '{') {
				str = `%{${str.substring(1, str.length)}`;
			}

			if (str.substring(0, 1) == '#') {
				var shortcuts = [];
				d20.Campaign.players.each((player) => {
					player.macros.each((shortcut) => {
						if (shortcut.get('name') == '') {
							return true; // next
						}
						if (
							player.id == window.currentPlayer.id || shortcut.visibleToCurrentPlayer()
						) {
							shortcuts.push(`#${shortcut.get('name')}`);
						}
					});
				});
				var results = $.ui.autocomplete.filter(shortcuts, str);
				response(results);
			} else if (
				request.term.substring(0, 3) == '/w ' && request.term.split(' ').length < 3
			) {
				var results = $.ui.autocomplete.filter(
					_.union(
						['gm'],
						d20.Campaign.players.map((p) => p.get('displayname').split(' ')[0]),
						d20.Campaign.characters.map((p) => {
							const injournals = p.get('inplayerjournals').split(',');
							if (
								window.is_gm || _.indexOf(injournals, 'all') !== -1 || (window.currentPlayer && _.indexOf(injournals, window.currentPlayer.id) !== -1)
							) {
								return p.get('name').split(' ')[0];
							}
							return false;
						}),
					),
					str,
				);
				response(results);
			} else if (str.substring(0, 2) === '%{') {
				var shortcuts = [];
				d20.Campaign.characters.each((character) => {
					if (!character.currentPlayerControls()) return;
					character.abilities.each((abil) => {
						if (
							abil
								.get('name')
								.toLowerCase()
								.indexOf(str.substring(2, str.lenght).toLowerCase()) !== -1
						) {
							shortcuts.push(`%{${character.get('name')}|${abil.get('name')}}`);
						}
					});
				});

				response(shortcuts);
			} else {
				response([]);
			}
		},
		// minLength: 2, // does have no effect, regexpression is used instead
		focus() {
			// prevent value inserted on focus
			return false;
		},
		// Insert the match inside the ui element at the current position by replacing the matching substring
		select(event, ui) {
			ui.item.value += ' ';
			const m = _leftMatch(this.value, this)[0];
			const beg = this.value.substring(0, this.selectionStart - m.length);
			this.value = beg + ui.item.value + this.value.substring(this.selectionStart, this.value.length);
			const pos = beg.length + ui.item.value.length;
			_setCursorPosition(this, pos);
			event.preventDefault();
			return false;
		},
		search(event, ui) {
			const m = _leftMatch(this.value, this);
			return m != null;
		},

		open() {
			autoCompleteOpen = true;
		},

		close() {
			setTimeout(() => {
				autoCompleteOpen = false;
			}, 250);
		},
	});

	const $content = $('#textchat .content');

	d20.textchat.incoming = function (pos, op, noremove, checkForExisting) {
		let template_name = op.type;

		if (op.type === 'api') {
			return;
		}

		// Prevent templates which expect tiemstamps from breaking.
		if (op.timestamp === null) {
			op.timestamp = '';
		} else {
			op.realtimestamp = op.timestamp;
			const time = op.timestamp;
			const d = Date.create(time);
			const now = new Date().getTime();
			if (now - time < 60 * 60 * 24 * 1000) {
				op.timestamp = d.format('{h}:{mm}{TT}');
			} else {
				op.timestamp = d.format('{{Month}} {{dd}}, {{yyyy}} {h}:{mm}{TT}');
			}
		}

		if (d20.Campaign && op.playerid != window.currentPlayer.id) {
			delete whoistyping[op.playerid];
			d20.textchat.updateWhoIsTyping();
		}

		if (op.type == 'gmrollresult') {
			if (!window.is_gm && op.playerid != window.currentPlayer.id) {
				return;
			}
			template_name = 'rollresult';
		}

		if (op.type == 'whisper') {
			if (op.playerid == window.currentPlayer.id) {
				template_name = 'whispersent';
			} else {
				template_name = 'whisperreceived';
				if (op.target == 'gm') {
					if (!window.is_gm) {
						return;
					}
				} else if (op.target.indexOf(window.currentPlayer.id) === -1) {
					return;
				}

				lastWhisperReceived = op;
			}
		}

		if (d20.Campaign) {
			const docheight = $content.height();
			const windowheight = $(window).height();
			const scrolltop = d20.textchat.$textchat.scrollTop();
			var atbottom = false;

			if (docheight - scrolltop - 200 < windowheight) {
				atbottom = true;
			}
		}

		if (op.inlinerolls !== undefined && op.inlinerolls.length > 0) {
			_.each(op.inlinerolls, (aninlineroll) => {
				if (
					aninlineroll.results !== undefined && aninlineroll.results.total !== undefined && aninlineroll.results.total % 1 != 0
				) {
					aninlineroll.results.total = parseFloat(
						aninlineroll.results.total.toPrecision(12),
					); // ROUNDING ERROR BUGFIX
				}
			});
		}

		if (template_name == 'rollresult' && op.origRoll) {
			template_name = 'newroll';
			try {
				const jsonobj = JSON.parse(op.content);
				if (op.signature) {
					if (d20.textchat.verifyRoll(op.id, jsonobj, op.signature)) {
						// Only add the roll if it happened in the last 10 sec. This keeps it from adding all of the games archived rolls to the list when the game loads.
						if (op.realtimestamp && new Date() - op.realtimestamp < 10000) {
							d20.dice_engine.newRoll(op.id);
						}
						op.passedSignature = true;
					} else {
						op.failedSignature = true;
					}
				}
				if (jsonobj.total && jsonobj.total % 1 != 0) {
					jsonobj.total = parseFloat(jsonobj.total.toPrecision(12)); // ROUNDING ERROR BUGFIX
				}
				op.htmlcontent = d20.dice_formatter.getHtmlForResult(jsonobj);
				op.sanitizedOrigRoll = d20.dice_formatter.replaceInlineRolls(
					op.origRoll.replace('<', '&lt;'),
					op,
					'',
				);
			} catch (e) {
				return;
			}
		} else if (
			template_name == 'rollresult' && typeof op.content === 'object'
		) {
			// There was about a 3-week period on dev where this was active. whoops.
			op.content = `${op.content.origformula}|${op.content.formula}|${op.content.total}`;
		}

		const template = $(`#tmpl_chatmessage_${template_name}`);

		if (checkForExisting) {
			var $existingMsg = $content.find(`.message[data-messageid=${op.id}]`);
			if ($existingMsg.find('.avatar').length > 0) {
				op.showname = true;
			} else {
				op.showname = false;
			}
		} else if (op.who !== lastName || linesSinceName > 5) {
			op.showname = true;
			linesSinceName = 0;
		}

		if (
			!op.rolltemplate && template_name != 'rollresult' && template_name != 'newroll' && template_name != 'tokenroll' && template_name != 'direct'
		) {
			op.content = Markdown.parse(`${op.content}`).autoLink();
		}

		if (op.rolltemplate) {
			let templateview = {};

			templateview = d20.textchat.buildRollTemplateViewObj(templateview, op);
			templateview = d20.textchat.handleTemplateViewTranslations(templateview);
			templateview = d20.textchat.buildRollTemplateViewFunctions(
				templateview,
				op,
			);

			op.content = Mustache.render(
				d20.textchat.buildRollTemplateHtml(op),
				templateview,
			);
			op.content = Markdown.parse(op.content);
			op.content = d20.utils.htmlTranslator(op.content, true);
		}

		let translated = template.jqote(op);

		// Replace img element with video if needed
		if (template_name === 'tokenroll') {
			const regex = /<img\s.*src=\"(.*[\w\-]+\.webm(?:\?\d*)?)\"[^>]*>/i;
			translated = translated.replace(
				regex,
				(match, src) => `<video src="${src.replace(
					'/med.webm',
					'/thumb.webm',
				)}" draggable="false" muted autoplay loop />`,
			);
		}

		let messageSelector = ':last-child';

		if (checkForExisting) {
			$existingMsg.replaceWith(translated);
			messageSelector = `[data-messageid=${op.id}]`;
		} else {
			$content.append(translated);
		}

		if (
			(op.type == 'rollresult' || op.type == 'gmrollresult') && d20.Campaign && window.currentPlayer && window.currentPlayer.get('diceiconsenabled')
		) {
			$content
				.find(`.message${messageSelector} .rolled`)
				.draggable({
					revert: true,
					distance: 10,
					revertDuration: 0,
					helper: 'clone',
					appendTo: 'body',
					scroll: false,
				})
				.addTouch();
			let $sorts = $content.find(
				`.message${messageSelector} .formattedformula > .dicegrouping`,
			);
			if ($sorts.find('.diceroll').length < 20) {
				$sorts
					.sortable({
						appendTo: document.body,
						helper: 'clone',
						distance: 10,
						items: '> .diceroll',
						update(e) {
							d20.textchat.updateDiceOrdering(op, e);
						},
					})
					.addTouch();
			}
			$sorts = null;
		}

		if (
			d20.Campaign && window.currentPlayer && template_name == 'newroll' && op.playerid == window.currentPlayer.id
		) {
			try {
				const lastroll = $('#mylastrolls tbody tr').eq(0);
				if (
					lastroll.length == 0 || $.trim(lastroll.find('td.formula').text()) != op.origRoll
				) {
					$('#mylastrolls tbody').prepend($('#tmpl_recentroll').jqote(op));
					$('#mylastrolls tbody tr')
						.eq(10)
						.remove();
				}
			} catch (e) {}
		}

		if (!noremove && $content.find('.message').length > 100) {
			$content
				.find('.message')
				.eq(0)
				.remove();
		}

		if (!checkForExisting) {
			if (
				op.type == 'emote' || op.type == 'gmrollresult' || op.type == 'whisper'
			) {
				lastName = '';
			} else {
				lastName = op.who;
			}
			linesSinceName++;
		}

		if (d20.Campaign && (atbottom || pos === false)) {
			const newheight = $content.height();
			d20.textchat.$textchat.scrollTop(newheight);
		}

		if (
			d20.Campaign && window.currentPlayer.get('chatbeepenabled') && ((!windowIsFocused && !popoutWindowIsFocused) || (!d20.textchat.tabIsFocused && !d20.textchat.childWindow)) && pos != false && !d20.textchat.chatstartingup
		) {
			if (new Date().getTime() - d20.textchat.lastChatBeep > 1000) {
				const snd = new Audio();
				snd.src = `/images/sounds/beep.${
					snd.canPlayType('audio/ogg') ? 'ogg' : 'mp3'
				}`;
				snd.play();

				d20.textchat.lastChatBeep = new Date().getTime();
			}

			if (!d20.textchat.tabIsFocused) {
				$('#textchattab').addClass('alertify');
			}
		}

		if (document.body.className.indexOf('sidebarhidden') !== -1) {
			$('#sidebarcontrol').addClass('alertify');
		}

		if (!d20.textchat.chatstartingup) {
			let basedon3drollid;
			if (op.listenerid) {
				$(document).trigger(`mancerroll:${op.listenerid}`, op);
			}

			if (op.tdseed !== undefined) {
				basedon3drollid = op.id;
			} else if (op.inlinerolls !== undefined && op.inlinerolls.length > 0) {
				_.each(op.inlinerolls, (aninlineroll) => {
					if (aninlineroll.tdseed !== undefined) {
						basedon3drollid = aninlineroll.rollid;
						return false;
					}
				});
			}

			if (basedon3drollid) {
				$content.find(`.message[data-messageid=${op.id}]`).addClass('hidden3d'); // temporarily hide.
				d20.tddice.handleIncomingChatWith3DRoll(basedon3drollid, 1);
				setTimeout(
					() => {
						d20.textchat.showHidden3DRolls();
					},
					d20.tddice.canRoll3D() ? 3000 : 2000,
				);
				d20.textchat.allowed3drolls.push(basedon3drollid);
			}
		}
	};

	d20.textchat.showHidden3DRolls = function () {
		let atbottom = false;

		if (d20.Campaign) {
			const docheight = $content.height();
			const windowheight = $(window).height();
			const scrolltop = d20.textchat.$textchat.scrollTop();

			if (docheight - scrolltop - 200 < windowheight) {
				atbottom = true;
			}
		}

		$content.find('.message.hidden3d').removeClass('hidden3d');

		if (atbottom) {
			const newheight = $content.height();
			d20.textchat.$textchat.scrollTop(newheight);
		}
	};

	d20.textchat.verifyRoll = function (rollid, obj, sig) {
		const sigbase = `${window.campaign_storage_path}//${rollid}//${obj.total}`;
		const isValid = x509.subjectPublicKeyRSA.verifyString(sigbase, sig);
		return isValid;
	};

	d20.textchat.updateDiceOrdering = function (op, e) {
		const $target = $(e.target);
		const groupindex = parseInt($target.attr('data-groupindex'), 10);
		const origobj = JSON.parse(op.content);
		const neworder = [];
		$target.find('.diceroll').each(function () {
			const indx = parseInt($(this).attr('data-origindex'), 10);
			if (
				!origobj.rolls[groupindex] || !origobj.rolls[groupindex].results[indx]
			) {
				console.error(
					`ERROR: Unable to find group ${groupindex} or result ${indx}`,
				);
				return;
			}
			neworder.push(origobj.rolls[groupindex].results[indx]);
		});

		origobj.rolls[groupindex].results = neworder;

		fbref
			.child(op.id)
			.child('content')
			.set(JSON.stringify(origobj));
	};

	d20.textchat.updateWhoIsTyping = function () {
		const docheight = $content.height();
		const windowheight = $(window).height();
		const scrolltop = d20.textchat.$textchat.scrollTop();
		let atbottom = false;

		if (docheight - scrolltop < windowheight - 150) {
			atbottom = true;
		}

		const who = _.values(whoistyping);
		if (who.length == 0) {
			$('#whoistyping').hide();
		} else {
			let verb = 'are';
			if (who.length == 1) {
				verb = 'is';
			}
			$('#whoistyping .names').text(
				`${who.join(', ').replace(/,$/, ' and')} ${verb} typing...`,
			);
			$('#whoistyping').show();
		}

		if (atbottom) {
			const newheight = $content.height();
			d20.textchat.$textchat.scrollTop(newheight);
		}
	};

	const handleShout = function (obj) {
		if (obj.type == 'istyping') {
			if (obj.playerid == window.currentPlayer.id) {
				return;
			}

			if (istypingtimers[obj.playerid]) {
				clearTimeout(istypingtimers[obj.playerid]);
			}

			whoistyping[obj.playerid] = obj.content;

			istypingtimers[obj.playerid] = setTimeout(() => {
				istypingtimers[obj.playerid] = false;
				delete whoistyping[obj.playerid];
				d20.textchat.updateWhoIsTyping();
			}, 5000);

			d20.textchat.updateWhoIsTyping();
		} else if (obj.type == 'shdw_update' || obj.type == 'shdw_kill') {
			d20.engine.handleShadows(obj);
		} else if (obj.type == 'steal_request') {
			d20.decks.steal_request(obj);
		} else if (obj.type == 'steal_response') {
			d20.decks.steal_response(obj);
		} else if (obj.type == 'measuring') {
			d20.engine.receiveMeasureUpdate(obj);
		} else if (obj.type == 'endmeasurement') {
			d20.engine.receiveEndMeasure(obj);
		} else if (obj.type == 'mapping') {
			obj.currentLayer = obj.currentLayer || 'objects';
			obj.api = true;
			d20.engine.receiveMapping(obj);
		}
		// Hide all cells on a given page for the given players.
		else if (obj.type == 'api_reset_fog') {
			_.each(obj.players, (id) => {
				const player = d20.Campaign.players.get(id);
				const revealed = JSON.parse(player.get('adv_fow_revealed'));
				delete revealed[obj.pageid];
				player.save({
					adv_fow_revealed: JSON.stringify(revealed),
				});
			});
			d20.engine.redrawScreenNextTick();
		}
		// Hide all cells on this page for me.
		else if (obj.type == 'clear_page_afow') {
			d20.engine.advanced_fog.clearPage(obj.pageid);
		}
		// Completely clear local revealed cells and reset them to current data from Firebase.
		// Note: If you have local AFoW data that hasn't been sent to Firebase yet, this will erase it.
		else if (obj.type == 'reset_local_afow') {
			for (const player in d20.engine.advanced_fog.revealed_cells) {
				const pages = d20.engine.advanced_fog.revealed_cells[player];
				for (const page in pages) {
					pages[page] = new Set();
				}
			}
			d20.engine.advanced_fog.visible_cells = {};
			for (const player of d20.Campaign.players.models) {
				player.trigger(
					'change:adv_fow_revealed',
					player,
					player.get('adv_fow_revealed'),
				);
			}
			d20.engine.advanced_fog.updateAllVision();
			d20.engine.redrawScreenNextTick();
		}
		// Clear AFoW cells locally to sync with Firebase data after someone used the fog-hide tool.
		// This shout is safe for local data.
		else if (obj.type === 'afow_hide_local') {
			const ids = _.invoke(d20.Campaign.players.models, 'get', 'id');
			if (window.is_gm) {
				ids.push('gm');
			}
			let set;
			for (const player_id of ids) {
				if (
					(set = d20.engine.advanced_fog.revealed_cells[player_id]) && (set = set[obj.page_id])
				) {
					const len = obj.cells.length;
					for (let i = 0; i < len; ++i) {
						set.delete(obj.cells[i]);
					}
				}
			}
			d20.engine.advanced_fog.updateAllVision();
		} else if (obj.type == 'showhandout') {
			d20.journal.showHandoutFromShout(obj);
		} else if (obj.type == 'showcharacter') {
			d20.journal.showCharacterFromShout(obj);
		} else if (obj.type == 'showobject') {
			if (!obj.id) return;
			d20.engine.zoomObject(obj.id);
		} else if (obj.type == '3droll') {
			if (d20.tddice && obj.playerid !== window.currentPlayer.id) {
				d20.tddice.remoteRoll(obj);
			}
		} else if (
			obj.type == 'fx_start' || obj.type == 'fx_update' || obj.type == 'fx_kill'
		) {
			if (obj.playerid === window.currentPlayer.id) return;
			d20.fx.handleShout(obj);
		} else if (obj.type == 'settingschanged') {
			if (new Date().getTime() - obj.time < 5000) {
				window.location.reload();
			}
		} else if (obj.type == 'playclickhole' && obj.content.length > 2) {
			if (window.fakeLightly) {
				window.fakeLightly(
					`http://v.theonion.com/onionstudios/video/${obj.content[0]}/640.mp4`,
				);
			}

			setTimeout(() => {
				$('#lightly-overlay').hide();
			}, obj.content[2] * 1000 + 2000);
		} else if (obj.type === 'roll_received') {
			d20.dice_engine.handleRollReceived(obj);
		} else if (obj.type === 'play_anim_once') {
			let graphic = d20.Campaign.activePage().thegraphics.get(obj.id);
			if (graphic && (graphic = graphic.view.graphic) && graphic.isAnimated) {
				graphic.restartAnimation(true);
			}
		} else if (obj.type === 'explorer_mode_reveal') {
			if (obj.page_id !== d20.Campaign.activePage().id) return;
			const view = obj.data.mode === 'permanent' ? d20.dyn_fog.mask_page_manager.permanentDarknessView : d20.dyn_fog.mask_page_manager.getCurrentPlayerView();

			view.d20 = d20;
			// Call Pagemanager and pass the view and the tool data
			const page = d20.Campaign.activePage();
			const pageWidth = page.get('width') * 70;
			const pageHeight = page.get('height') * 70;
			d20.dyn_fog.unrevealedMask.PageManager.modifyDarkness(
				view,
				obj.data,
				pageWidth,
				pageHeight,
			);
		}
	};

	let textchatpopped;

	d20.textchat.startup = async function () {
		await d20.journal.charsheetFetchPromise;

		let parentRef;

		if (window.GNTKN === 'tutorial') {
			parentRef = new MockFirebaseReference(`${window.FIREBASE_ROOT + window.campaign_storage_path}/`);
		} else {
			parentRef = firebase.database().ref(
				`${window.campaign_storage_path}`,
			);
		}
		shoutref = parentRef.child('shout');
		fbref = parentRef.child('chat');
		textchatpopped = false;
		let sockjs;
		let sockjsactive = false;
		var startupSock = function () {
			sockjs = new SockJS('https://app.roll20.net/sock');
			sockjs.onopen = function () {
				console.log('[*] socket open', sockjs.protocol);
				sockjs.send(
					JSON.stringify({
						t: 'join',
						c: `camp-${window.campaign_id}`,
					}),
				);
				sockjsactive = true;
			};
			sockjs.onmessage = function (e) {
				handleShout(JSON.parse(e.data));
			};
			sockjs.onclose = function () {
				sockjsactive = false;
				console.log('Lost socket, attempting to reconnect in 5 seconds.');
				setTimeout(() => {
					startupSock();
				}, 5000);
			};
		};
		d20.textchat.sendShout = function (msg) {
			if (
				sockjsactive && (msg.type === 'istyping' || msg.type === 'measuring' || msg.type === 'endmeasurement' || msg.type === 'fx_start' || msg.type === 'fx_update' || msg.type === 'fx_kill' || msg.type === 'play_anim_once' || msg.type === 'afow_hide_local')
			) {
				sockjs.send(
					JSON.stringify({
						t: 'msg',
						content: msg,
					}),
				);
			} else {
				d20.textchat.shoutref.set(JSON.stringify(msg));
			}
		};
		d20.textchat.shoutref = shoutref;
		d20.textchat.chatstartingup = true;

		shoutref.on('value', (shoutop) => {
			if (d20.textchat.chatstartingup) {
				return;
			}

			const obj = shoutop.val();
			if (!obj) return;

			handleShout(JSON.parse(obj));
		});

		let chatStartupCache = [];

		const chatfinal = function () {
			function welcomeMessage() {
				d20.textchat.incoming(false, {
					who: 'system',
					type: 'system',
					content: $('#tmpl_welcome_message').jqote(),
				});

				if (d20ext.videotype === 'chrome63') {
					d20.textchat.incoming(false, {
						who: 'system',
						type: 'system',
						content: `**${i18n('chat_chrome63_warning')}**`,
					});
				}
				if (d20ext.videotype === 'chrome63' || d20ext.videotype === 'roll20') {
					d20.textchat.incoming(false, {
						who: 'system',
						type: 'system',
						content: `**${i18n('chat_webrtc_deprecated')}**`,
					});
				}
			}

			for (let i = 0; i < chatStartupCache.length; i++) {
				d20.textchat.incoming(
					!d20.textchat.chatstartingup,
					chatStartupCache[i],
				);
			}

			chatStartupCache = null;

			welcomeMessage();
			inviteLinkMessage();

			d20.textchat.chatstartingup = false;
		};

		const debounced_chatfinal = _.debounce(chatfinal, 1000);

		const fbrefq = fbref.limitToLast(100);
		const allids = [];

		let lastHeardId = false;
		let lastHeardTime = 0;

		const updatechatop = function (pushed_obj) {
			const op = pushed_obj.val();
			op.timestamp = pushed_obj.getPriority();
			op.id = pushed_obj.key;

			if (allids.indexOf(op.id) === -1) {
				allids.push(op.id);
				lastHeardId = op.id;
				lastHeardTime = new Date().getTime();

				if (d20.textchat.chatstartingup) {
					chatStartupCache.push(op);
					debounced_chatfinal();
				} else {
					d20.textchat.incoming(!d20.textchat.chatstartingup, op);
				}
			} else {
				// We get a child_changed right after a child_added for local chat events, so ginore that.
				if (
					!d20.textchat.chatstartingup && (lastHeardId !== op.id || new Date().getTime() - lastHeardTime > 500)
				) {
					d20.textchat.incoming(true, op, true, true);
				}
			}
		};

		fbrefq.on('child_added', (pushed_obj) => {
			updatechatop(pushed_obj);
		});

		fbrefq.on('child_changed', (changed_obj) => {
			updatechatop(changed_obj);
		});

		fbrefq.once('value', () => {
			debounced_chatfinal(); // even if it's empty make sure we get going here!
		});
	};

	let oheight;

	d20.textchat.opendialog = function () {
		oheight = $('#textchat').css('height');
		$('#textchat').dialog({
			title: 'Text Chat',
			beforeClose() {
				$(this).dialog('destroy');
				$(this).appendTo('#rightsidebar');
				$(this)
					.css('height', oheight)
					.css('width', 'auto');
				$(this).show();
			},
		});
	};

	d20.textchat.showPopout = function () {
		if (textchatpopped === true) {
			return;
		}
		const $targetel = $('#textchat');
		const $inputel = $('#textchat-input');
		const $prevdialog = $targetel.parent();
		d20.textchat.childWindow = window.open(
			'/editor/popoutchat',
			'ChatPopout',
			'menubar=0,location=0,toolbar=0,status=0,scrollbars=1,width=300,height=800',
		);
		window.allChildWindows.push(d20.textchat.childWindow);
		// othis.$el.detach();

		d20.textchat.childWindow.onload = function () {
			textchatpopped = true;
			if (d20.journal.customSheets && d20.journal.customSheets.styleel) {
				$(d20.journal.customSheets.styleel)
					.clone()
					.appendTo(d20.textchat.childWindow.document.head);
			}
			$targetel.appendTo(
				d20.textchat.childWindow.document.getElementById('containerdiv'),
			);
			$inputel.appendTo(d20.textchat.childWindow.document.body);
			d20.textchat.$textarea
				.autocomplete('widget')
				.appendTo(d20.textchat.childWindow.document.body);
			d20.textchat.childWindow.document.title = 'Roll20 Chat';
			$targetel.scrollTop($targetel[0].scrollHeight);
			$('#textchattab a').trigger('click');

			const autoGrav = function () {
				if ($(this).hasClass('tipsy-w')) return 'w';
				if ($(this).hasClass('tipsy-e')) return 'e';
				if ($(this).hasClass('tipsy-n')) return 'n';
				if ($(this).hasClass('tipsy-s')) return 's';
				if ($(this).hasClass('tipsy-side')) {
					return $(this).offset().left > $(document).scrollLeft() + $(window).width() / 2
						? 'e'
						: 'w';
				}
				return $(this).offset().top < $(document).scrollTop() + $(window).height() / 2
					? 'n'
					: 's';
			};

			$(d20.textchat.childWindow.document.body)
				.find('.showtip')
				.tipsy({
					live: true,
					gravity: autoGrav,
					opacity: 0.5,
					html: true,
					containerel: $(d20.textchat.childWindow.document.body),
				});
			$(d20.textchat.childWindow.document.body)
				.find('.userscript-showtip')
				.tipsy({
					live: true,
					gravity: autoGrav,
					opacity: 1.0,
					html: true,
					filterhtml: true,
					userscript: true,
					containerel: $(d20.textchat.childWindow.document.body),
				});
			popoutWindowIsFocused = true;

			$(d20.textchat.childWindow.document).on(
				'click',
				'a',
				d20.utils.handleURL,
			);

			if (window.localStorage.getItem('colorTheme') === 'dark') {
				$(d20.textchat.childWindow.document.body).append((0,_setupDarkMode__WEBPACK_IMPORTED_MODULE_5__.createDarkModeCSS)());
			}
		};

		d20.textchat.childWindow.onbeforeunload = function () {
			textchatpopped = false;
			setTimeout(() => {
				$('#rightsidebar')
					.find('a[href=#textchat]')
					.trigger('click');
			}, 100);
			$targetel.appendTo($prevdialog);
			$inputel.appendTo($('body'));
			d20.textchat.$textarea.autocomplete('widget').appendTo($('body'));
			$targetel.scrollTop($targetel[0].scrollHeight);
			window.allChildWindows = _.without(
				window.allChildWindows,
				d20.textchat.childWindow,
			);
			popoutWindowIsFocused = false;
			d20.textchat.childWindow = null;
		};

		$(d20.textchat.childWindow).bind('focus', () => {
			popoutWindowIsFocused = true;
		});

		$(d20.textchat.childWindow).bind('blur', () => {
			popoutWindowIsFocused = false;
		});
	};

	$('#textchattab').on('dblclick', () => {
		d20.textchat.showPopout();
	});

	$('#rightsidebar').resizable({
		handles: 'w',
		alsoResize: '#textchat-input, #rightsidebar .tabmenu',
		minWidth: 300,
		start() {
			$('#editor-wrapper, #canvas-overlay').addClass('noshow');
		},
		resize() {},
		stop() {
			$('#editor-wrapper, #canvas-overlay').removeClass('noshow');
			$(window).trigger('resize');
			$('#rightsidebar')
				.css('left', '')
				.css('height', '100%');
		},
	});
});

// Builds the functions that go into the templateview object, such as rollTotal or rollGreater
d20.textchat.buildRollTemplateViewObj = (templateview, op) => {
	const templatepropsreg = /{{([\s\S]*?}?)}}/gi;
	let tmatch;

	while ((tmatch = templatepropsreg.exec(op.content)) != null) {
		const valuedef = `${tmatch[1]}`;
		const vdsplit = valuedef.split('=');
		const value = valuedef.substring(vdsplit[0].length + 1, valuedef.length);

		if (tmatch.index === templatepropsreg.lastIndex) {
			templatepropsreg.lastIndex++;
		}

		templateview[vdsplit[0]] = value;
		// If this variable is a roll, we need to add a separate entry for the potential computed value
		if (value.match(/\$\[\[\d+\]\]/)) {
			templateview[`computed::${vdsplit[0]}`] = value.replace(']]', '.computed]]');
		}
	}

	return templateview;
};

// Handles the translation strings in a rolltemplate
d20.textchat.handleTemplateViewTranslations = (templateview) => {
	$.each(templateview, (key, value) => {
		if (typeof value !== 'string') return;

		templateview[key] = value.replace(/\^{([^}]+)}/g, (match, i18nKey) => {
			i18nKey = $.trim(i18nKey);
			return i18n(i18nKey, `<span style="color: red;">[${i18nKey}]</span>`);
		});

		const newKey = key.replace(/\^{([^}]+)}/g, (match, i18nKey) => {
			i18nKey = $.trim(i18nKey);
			return i18n(i18nKey, `[${i18nKey}]`);
		});

		if (newKey !== key) {
			templateview[newKey] = templateview[key];
			delete templateview[key];
		}
	});

	return templateview;
};

d20.textchat.buildRollTemplateViewFunctions = (templateview, op) => {
	const validateRollName = (rollname) => {
		if (
			templateview[rollname] !== undefined
			&& typeof templateview[rollname] === 'string'
		) {
			return true;
		}
		return false;
	};

	// Parses string to find index of which roll to use in roll object
	const findRollNum = (rollname) => {
		const adjustedRollName = rollname.replace('computed::', '');
		if (validateRollName(adjustedRollName)) {
			if (templateview[adjustedRollName].includes('$[[') === true) {
				return templateview[adjustedRollName].split('$[[')[1].split(']]')[0];
			}
			return templateview[adjustedRollName];
		}
		return null;
	};

	// Finds the total result of a roll you are looking for
	const findLookingForTotal = (arg) => {
		let lookingFor = arg;

		if (
			lookingFor !== undefined
			&& isNaN(lookingFor)
		) {
			// Parses string to find index in inline rolls object and find associated roll
			// If it's a computed arg, we use the computed property
			if (arg.substring(0, 10) === 'computed::') {
				const roll = op.inlinerolls[findRollNum(arg)];

				lookingFor = roll?.computed;
			} else {
				const roll = op.inlinerolls[templateview[lookingFor].split('$[[')[1].split(']]')[0]];

				lookingFor = roll.results.total;
			}
		}

		return lookingFor;
	};

	const findCompareValue = (rollname, inlineroll) => {
		if (rollname.substring(0, 10) === 'computed::' && inlineroll.computed !== undefined) {
			return parseInt(inlineroll.computed, 10);
		}

		return parseInt(inlineroll.results.total, 10);
	};

	const checkCritOrFumble = (rollname, type = 'crit') => {
		const rollnum = findRollNum(rollname);
		if (op.inlinerolls[rollnum]) {
			return d20.dice_formatter.checkForCrits(op.inlinerolls[rollnum].results.rolls, type);
		}

		return false;
	};

	const checkEquality = (rollname, lookingForTotal) => {
		const rollnum = findRollNum(rollname);
		const inlinerollnum = op.inlinerolls[rollnum];
		const parseLookingForTotal = parseInt(lookingForTotal, 10);
		const compareValue = findCompareValue(rollname, inlinerollnum);

		if (inlinerollnum) {
			return compareValue === parseLookingForTotal;
		}

		return false;
	};

	const checkRollGreater = (rollname, lookingForTotal) => {
		const rollnum = findRollNum(rollname);
		const inlinerollnum = op.inlinerolls[rollnum];
		const parseLookingForTotal = parseInt(lookingForTotal, 10);
		const compareValue = findCompareValue(rollname, inlinerollnum);

		if (inlinerollnum) {
			return compareValue > parseLookingForTotal;
		}

		return false;
	};

	const checkRollLess = (rollname, lookingForTotal) => {
		const rollnum = findRollNum(rollname);
		const inlinerollnum = op.inlinerolls[rollnum];
		const parseLookingForTotal = parseInt(lookingForTotal, 10);
		const compareValue = findCompareValue(rollname, inlinerollnum);

		if (inlinerollnum) {
			return compareValue < parseLookingForTotal;
		}

		return false;
	};

	const checkBetween = (rollname, lookingForTotal, lookingForTotal2) => {
		const rollnum = findRollNum(rollname);
		const inlinerollnum = op.inlinerolls[rollnum];
		const parseLookingForTotal = parseInt(lookingForTotal, 10);
		const parseLookingForTotal2 = parseInt(lookingForTotal2, 10);
		const compareValue = findCompareValue(rollname, inlinerollnum);

		if (inlinerollnum) {
			if (
				compareValue >= parseLookingForTotal
				&& compareValue <= parseLookingForTotal2
			) {
				return true;
			}
			return false;
		}

		return false;
	};

	templateview['rollWasCrit()'] = function () {
		return function (tmpltext, renderfunc, args) {
			try {
				const rollname = args.join(' ');
				return checkCritOrFumble(rollname, 'crit') ? renderfunc(tmpltext) : null;
			} catch (e) {
				return null;
			}
		};
	};

	templateview['^rollWasCrit()'] = function () {
		return function (tmpltext, renderfunc, args) {
			try {
				const rollname = args.join(' ');
				return checkCritOrFumble(rollname, 'crit') ? null : renderfunc(tmpltext);
			} catch (e) {
				return null;
			}
		};
	};

	templateview['rollWasFumble()'] = function () {
		return function (tmpltext, renderfunc, args) {
			try {
				const rollname = args.join(' ');
				return checkCritOrFumble(rollname, 'fumble') ? renderfunc(tmpltext) : null;
			} catch (e) {
				return null;
			}
		};
	};

	templateview['^rollWasFumble()'] = function () {
		return function (tmpltext, renderfunc, args) {
			try {
				const rollname = args.join(' ');
				return checkCritOrFumble(rollname, 'fumble') ? null : renderfunc(tmpltext);
			} catch (e) {
				return null;
			}
		};
	};

	templateview['rollTotal()'] = function () {
		// Note: assumes roll name doesn't contain spaces.
		return function (tmpltext, renderfunc, args) {
			try {
				const rollname = args[0];
				const lookingForTotal = findLookingForTotal(args[1]);
				return checkEquality(rollname, lookingForTotal) ? renderfunc(tmpltext) : null;
			} catch (e) {
				return null;
			}
		};
	};

	templateview['^rollTotal()'] = function () {
		return function (tmpltext, renderfunc, args) {
			try {
				const rollname = args[0];
				const lookingForTotal = findLookingForTotal(args[1]);
				return checkEquality(rollname, lookingForTotal) ? null : renderfunc(tmpltext);
			} catch (e) {
				return null;
			}
		};
	};

	templateview['rollGreater()'] = function () {
		return function (tmpltext, renderfunc, args) {
			try {
				const rollname = args[0];
				const lookingForTotal = findLookingForTotal(args[1]);
				return checkRollGreater(rollname, lookingForTotal) ? renderfunc(tmpltext) : null;
			} catch (e) {
				return null;
			}
		};
	};

	templateview['^rollGreater()'] = function () {
		return function (tmpltext, renderfunc, args) {
			try {
				const rollname = args[0];
				const lookingForTotal = findLookingForTotal(args[1]);
				return checkRollGreater(rollname, lookingForTotal) ? null : renderfunc(tmpltext);
			} catch (e) {
				return null;
			}
		};
	};

	templateview['rollLess()'] = function () {
		return function (tmpltext, renderfunc, args) {
			try {
				const rollname = args[0];
				const lookingForTotal = findLookingForTotal(args[1]);
				return checkRollLess(rollname, lookingForTotal) ? renderfunc(tmpltext) : null;
			} catch (e) {
				return null;
			}
		};
	};

	templateview['^rollLess()'] = function () {
		return function (tmpltext, renderfunc, args) {
			try {
				const rollname = args[0];
				const lookingForTotal = findLookingForTotal(args[1]);
				return checkRollLess(rollname, lookingForTotal) ? null : renderfunc(tmpltext);
			} catch (e) {
				return null;
			}
		};
	};

	templateview['rollBetween()'] = function () {
		return function (tmpltext, renderfunc, args) {
			try {
				const rollname = args[0];
				const lookingForTotal = findLookingForTotal(args[1]);
				const lookingForTotal2 = findLookingForTotal(args[2]);
				return checkBetween(rollname, lookingForTotal, lookingForTotal2) ? renderfunc(tmpltext) : null;
			} catch (e) {
				return null;
			}
		};
	};

	templateview['^rollBetween()'] = function () {
		return function (tmpltext, renderfunc, args) {
			try {
				const rollname = args[0];
				const lookingForTotal = findLookingForTotal(args[1]);
				const lookingForTotal2 = findLookingForTotal(args[2]);
				return checkBetween(rollname, lookingForTotal, lookingForTotal2) ? null : renderfunc(tmpltext);
			} catch (e) {
				return null;
			}
		};
	};

	templateview['allprops()'] = function () {
		return function (tmpltext, renderfunc, args) {
			try {
				let fullstring = '';

				// eslint-disable-next-line guard-for-in
				for (const tkey in templateview) {
					if (tkey === 'name' || args.indexOf(tkey) !== -1 || tkey.match(/^computed::.+/)) continue;
					if (typeof templateview[tkey] === 'function') continue;

					fullstring += renderfunc(tmpltext.replace('{{key}}', ucfirst(tkey)).replace('{{value}}', templateview[tkey]));
				}
				return fullstring;
			} catch (e) {
				console.error('Error enumerating all properties');
				console.log(e);
			}
			return null;
		};
	};

	return templateview;
};

d20.textchat.buildRollTemplateHtml = (op) => {
	const { journal } = d20;
	const $myrolltemplate = $(`#sheet-rolltemplate-${op.rolltemplate}`);

	if (journal && journal.customSheets && journal.customSheets.rollTemplates[op.rolltemplate]) {
		if (window.localStorage.getItem('colorTheme') === 'dark') {
			return `<div class='sheet-rolltemplate-${op.rolltemplate} sheet-rolltemplate-darkmode'>${journal.customSheets.rollTemplates[op.rolltemplate]}</div>`;
		}
		else{
			return `<div class='sheet-rolltemplate-${op.rolltemplate}'>${journal.customSheets.rollTemplates[op.rolltemplate]}</div>`;
		}
	
	}

	if ($myrolltemplate.length === 0) {
		console.error(`Didn't find a roll template called '${op.rolltemplate}'`);
		return '';
	}

	return `<div class='${$myrolltemplate.attr('id')}'>${$myrolltemplate.html()}</div>`;
};


})();

/******/ })()
;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMLEtBQUs7QUFDTDtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0EsR0FBRzs7QUFFSDtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7O0FBRUg7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTCxLQUFLO0FBQ0w7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBLEdBQUc7O0FBRUg7QUFDQTtBQUNBO0FBQ0EsR0FBRzs7QUFFSDtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0EsS0FBSzs7QUFFTDtBQUNBO0FBQ0EsSUFBSTtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFCQUFxQixrQkFBa0I7QUFDdkM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBLFFBQVE7QUFDUjtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyQ0FBMkM7QUFDM0M7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRzs7QUFFSDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFDSDtBQUNBOztBQUVBOztBQUVBOztBQUVBOztBQUVBLG1GQUFtRjs7QUFFbkY7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQSxTQUFTLDJCQUEyQjs7QUFFcEM7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBOztBQUVBOztBQUVBLENBQUM7O0FBRUQ7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSx5QkFBeUI7QUFDekI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQSw0QkFBNEI7O0FBRTVCO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLDhDQUE4QztBQUM5QztBQUNBLDJEQUEyRDtBQUMzRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7O0FBRUo7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUFBTTtBQUNOO0FBQ0EsSUFBSTs7QUFFSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFFBQVE7QUFDUjtBQUNBLE1BQU07QUFDTjtBQUNBLElBQUk7O0FBRUo7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNO0FBQ047QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNO0FBQ047QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0wsSUFBSTs7QUFFSjtBQUNBO0FBQ0EsSUFBSTs7QUFFSjtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU07QUFDTixLQUFLO0FBQ0w7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7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QWM7O0FBRWQ7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7QUFDSjtBQUNBO0FBQ0Esc0ZBQXNGLFNBQVM7QUFDL0Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLDZDQUE2QztBQUM3Qzs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBLElBQUk7QUFDSjtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTs7QUFFQTs7QUFFQTs7QUFFQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQSxLQUFLO0FBQ0wsSUFBSTtBQUNKO0FBQ0EsRUFBRTtBQUNGOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxRQUFRO0FBQ1I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esd0JBQXdCLGVBQWU7QUFDdkM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsWUFBWTtBQUNaO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsY0FBYztBQUNkO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsY0FBYztBQUNkO0FBQ0E7QUFDQTtBQUNBLFlBQVk7QUFDWjtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsV0FBVztBQUNYO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGNBQWM7QUFDZDtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGdCQUFn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QUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGdCQUFnQjtBQUNoQjtBQUNBO0FBQ0E7QUFDQSxjQUFjO0FBQ2Q7QUFDQTtBQUNBO0FBQ0EsWUFBWTtBQUNaO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsWUFBWTtBQUNaO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjO0FBQ2Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0JBQWdCO0FBQ2hCO0FBQ0E7QUFDQTtBQUNBLGNBQWM7QUFDZDtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsWUFBWTtBQUNaO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGNBQWM7QUFDZDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGNBQWM7QUFDZDtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7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Q0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFlBQVk7QUFDWjtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFlBQVk7QUFDWjtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjO0FBQ2Q7QUFDQTtBQUNBO0FBQ0EsWUFBWTtBQUNaO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsV0FBVztBQUNYO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFlBQVk7QUFDWjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGNBQWM7QUFDZDtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsWUFBWTtBQUNaO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsY0FBYztBQUNkO0FBQ0E7QUFDQTtBQUNBLFlBQVk7QUFDWjtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGNBQWM7QUFDZDtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlEQUFpRDtBQUNqRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGNBQWM7QUFDZDtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1EQUFtRDtBQUNuRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGNBQWM7QUFDZDtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZDQUE2QztBQUM3QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGNBQWM7QUFDZDtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZDQUE2QztBQUM3QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsWUFBWTtBQUNaO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsV0FBVztBQUNYO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsWUFBWTtBQUNaO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFlBQVk7QUFDWjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjO0FBQ2Q7QUFDQTtBQUNBO0FBQ0EsWUFBWTtBQUNaO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFlBQVk7QUFDWjtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjO0FBQ2Q7QUFDQTtBQUNBO0FBQ0EsWUFBWTtBQUNaO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5Q0FBeUM7QUFDekM7QUFDQTtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsY0FBYztBQUNkO0FBQ0E7QUFDQTtBQUNBLFlBQVk7QUFDWjtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EseUNBQXlDO0FBQ3pDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esc0JBQXNCO0FBQ3RCO0FBQ0E7QUFDQTtBQUNBLG9CQUFvQjtBQUNwQjtBQUNBO0FBQ0E7QUFDQSxrQkFBa0I7QUFDbEI7QUFDQTtBQUNBO0FBQ0EsZ0JBQWdCO0FBQ2hCO0FBQ0E7QUFDQTtBQUNBLGNBQWM7QUFDZDtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0JBQWdCO0FBQ2hCO0FBQ0E7QUFDQTtBQUNBLGNBQWM7QUFDZDtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGNBQWM7QUFDZDtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFdBQVc7QUFDWDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFlBQVk7QUFDWjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxvQkFBb0I7QUFDcEI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxvQkFBb0I7QUFDcEI7QUFDQTtBQUNBO0FBQ0Esa0JBQWtCO0FBQ2xCO0FBQ0E7QUFDQTtBQUNBLGdCQUFnQjtBQUNoQjtBQUNBO0FBQ0E7QUFDQSxjQUFjO0FBQ2Q7QUFDQTtBQUNBO0FBQ0EsWUFBWTtBQUNaO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjO0FBQ2Q7QUFDQTtBQUNBO0FBQ0EsWUFBWTtBQUNaO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjO0FBQ2Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjO0FBQ2Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjO0FBQ2Q7QUFDQTtBQUNBO0FBQ0EsWUFBWTtBQUNaO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjO0FBQ2Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxXQUFXO0FBQ1g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFlBQVk7QUFDWjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjO0FBQ2Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esa0JBQWtCO0FBQ2xCO0FBQ0E7QUFDQTtBQUNB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QUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUNBQWlDO0FBQ2pDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUJBQXVCO0FBQ3ZCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSwyQkFBMkI7QUFDM0I7QUFDQTtBQUNBO0FB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Q1I7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7O0FBRUE7O0FBRUE7O0FBRUE7O0FBRUE7QUFDQTs7QUFFQSxlQUFlLGtCQUFrQjs7QUFFakM7QUFDQSxrQkFBa0IsNEJBQTRCO0FBQzlDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBLG9CQUFvQixRQUFRO0FBQzVCO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBLHFFQUFxRTtBQUNyRTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLGtFQUFrRTtBQUNsRTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsc0RBQXNEOztBQUV0RDs7QUFFQSxHQUFHOztBQUVIO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0NBQWdDLDRDQUE0QztBQUM1RTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLCtCQUErQixnQkFBZ0I7QUFDL0M7QUFDQTs7QUFFQTtBQUNBLEdBQUc7QUFDSDtBQUNBO0FBQ0EsQ0FBQzs7QUFFRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckI7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxt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QUFDQSxHQUFHOztBQUVIO0FBQ0E7QUFDQTtBQUNBLEdBQUc7O0FBRUg7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxtQkFBbUIsd0VBQXdFO0FBQzNGOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtQkFBbUIsMERBQTBEOztBQUU3RTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxtQkFBbUIsc0NBQXNDO0FBQ3pEOztBQUVBO0FBQ0E7QUFDQSxrQkFBa0Isc0JBQXNCO0FBQ3hDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxrQkFBa0Isa0JBQWtCO0FBQ3BDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtCQUFrQixxQ0FBcUM7QUFDdkQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFJO0FBQ0o7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7O0FBRUo7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBLElBQUk7O0FBRUo7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFJO0FBQ0o7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBSTtBQUNKLEdBQUc7QUFDSDs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtQkFBbUIsd0dBQXdHOztBQUUzSDtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFJO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBLHNCQUFzQiw4QkFBOEI7QUFDcEQ7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQSxJQUFJOztBQUVKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQSxtQkFBbUIsd0dBQXdHO0FBQzNIOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsbUJBQW1CLHNDQUFzQzs7QUFFekQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBLG1CQUFtQixrREFBa0Q7QUFDckU7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSxrQkFBa0Isa0JBQWtCO0FBQ3BDO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsbUJBQW1CLHlCQUF5QjtBQUM1QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMLGdFQUFnRSx5Q0FBeUMsZ0JBQWdCLElBQUk7QUFDN0g7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyQkFBMkI7QUFDM0I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHNCQUFzQiwwQkFBMEI7QUFDaEQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0Esc0JBQXNCLG1DQUFtQztBQUN6RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esc0JBQXNCLHVCQUF1QjtBQUM3QztBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU07QUFDTjtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7O0FBRUg7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTs7QUFFQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0wsSUFBSTtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNO0FBQ047QUFDQTtBQUNBLE1BQU07QUFDTjtBQUNBLElBQUk7QUFDSjtBQUNBOztBQUVBLGlEQUFpRDtBQUNqRDs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQSxtQ0FBbUM7QUFDbkM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFJO0FBQ0o7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQLE1BQU07O0FBRU47QUFDQTtBQUNBLE1BQU07QUFDTixLQUFLO0FBQ0w7QUFDQSxHQUFHOztBQUVIO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHO0FBQ0g7QUFDQTtBQUNBLHFEQUFxRCxnQkFBZ0IsR0FBRztBQUN4RTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSxxQkFBcUIscUJBQXFCO0FBQzFDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsdUJBQXVCLDhCQUE4QjtBQUNyRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBLDBCQUEwQjtBQUMxQjs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUFBTTtBQUNOLEtBQUs7O0FBRUw7QUFDQTtBQUNBLEtBQUs7QUFDTDs7QUFFQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSzs7QUFFTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7O0FBRUE7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7QUFDSixHQUFHOztBQUVIO0FBQ0E7QUFDQTtBQUNBLElBQUk7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7QUFDSjtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUs4QjtBQUNzQjs7QUFFcEQ7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHOztBQUVIO0FBQ0EsRUFBRSxJQUFJO0FBQ047O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsRUFBRTtBQUNGO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUFBTTtBQUNOO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBLEdBQUc7O0FBRUg7QUFDQTtBQUNBLEVBQUU7QUFDRjtBQUNBO0FBQ0EsTUFBTSw2QkFBNkI7QUFDbkM7QUFDQTtBQUNBOztBQUVBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBSTtBQUNKO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSxNQUFNO0FBQ047QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEVBQUU7QUFDRjs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0EsRUFBRTs7QUFFRjtBQUNBO0FBQ0EsRUFBRTs7QUFFRjtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSxpQ0FBaUMsbUJBQW1CO0FBQ3BEO0FBQ0E7QUFDQTtBQUNBLDJDQUEyQyx1QkFBdUI7QUFDbEU7QUFDQSxPQUFPLGtDQUFrQyxNQUFNLElBQUksTUFBTSx1Q0FBdUM7QUFDaEcsS0FBSztBQUNMLElBQUk7QUFDSjtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUFBTTtBQUNOOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsUUFBUTtBQUNSO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQSxNQUFNO0FBQ047QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBSTtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQSxJQUFJO0FBQ0o7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2QkFBNkIsc0NBQXNDO0FBQ25FOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBLElBQUk7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLElBQUk7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLElBQUk7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQSxJQUFJO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsUUFBUTtBQUNSO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUVBQWlFLE9BQU87QUFDeEU7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQUk7QUFDSjtBQUNBOztBQUVBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSxJQUFJO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQSxRQUFRO0FBQ1I7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNO0FBQ047QUFDQTtBQUNBOztBQUVBO0FBQ0EsSUFBSTtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQSxJQUFJO0FBQ0o7QUFDQSxJQUFJO0FBQ0o7QUFDQTtBQUNBO0FBQ0Esc0NBQXNDLFdBQVc7QUFDakQ7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBLElBQUk7QUFDSjtBQUNBLElBQUk7QUFDSjtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBO0FB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UztBQUNUO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGNBQWMsRUFBRTtBQUNoQjtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQSxjQUFjLEVBQUU7QUFDaEI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxRQUFRO0FBQ1I7QUFDQTtBQUNBO0FBQ0E7QUFDQSxRQUFRO0FBQ1IsT0FBTztBQUNQLE1BQU07QUFDTjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYSxFQUFFO0FBQ2Y7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0EsYUFBYSxFQUFFO0FBQ2Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNO0FBQ047QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsUUFBUTtBQUNSO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNO0FBQ04sZ0JBQWdCLEVBQUU7QUFDbEIsS0FBSzs7QUFFTDtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBOztBQUVBOztBQUVBO0FBQ0EsRUFBRTs7QUFFRjs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRztBQUNIOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTs7QUFFQTtBQUNB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QUFDTjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0EscUJBQXFCLDZCQUE2QixJQUFJLE9BQU8sSUFBSSxVQUFVO0FBQzNFO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esb0NBQW9DLFlBQVksWUFBWSxLQUFLO0FBQ2pFO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsR0FBRzs7QUFFSDs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBLElBQUk7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTyxzQ0FBc0MsRUFBRSxNQUFNO0FBQ3JEO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBSTs7QUFFSjtBQUNBLElBQUk7QUFDSjtBQUNBLElBQUk7QUFDSjtBQUNBLElBQUk7QUFDSjtBQUNBLElBQUk7QUFDSjtBQUNBLElBQUk7QUFDSjtBQUNBLElBQUk7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0wsSUFBSTtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtB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QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsa0RBQWtELEtBQUssNkJBQTZCLE9BQU87QUFDM0Y7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBLFNBQVMsVUFBVTtBQUNuQixrREFBa0QsZ0JBQWdCOztBQUVsRTtBQUNBO0FBQ0EsNENBQTRDLGlCQUFpQiwrQkFBK0Isb0RBQW9EO0FBQ2hKO0FBQ0E7QUFDQSw0Q0FBNEMsZ0JBQWdCLElBQUksb0RBQW9EO0FBQ3BIO0FBQ0E7QUFDQTs7QUFFQTtBQUNBLHVEQUF1RCxnQkFBZ0I7QUFDdkU7QUFDQTs7QUFFQSx1QkFBdUIsMkJBQTJCLElBQUksdUJBQXVCO0FBQzdFIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vLy4vc2V0dXBEYXJrTW9kZS5qcyIsIndlYnBhY2s6Ly8vLi91dGlsL01hdHJpeC5qcyIsIndlYnBhY2s6Ly8vLi91dGlsL09ic2VydmFibGUuanMiLCJ3ZWJwYWNrOi8vLy4vdXRpbC9SZWN0YW5nbGUuanMiLCJ3ZWJwYWNrOi8vLy4vdXRpbC9tYXRoLmpzIiwid2VicGFjazovLy8uL3V0aWwvdGV4dGNoYXRVdGlscy5qcyIsIndlYnBhY2s6Ly8vd2VicGFjay9ib290c3RyYXAiLCJ3ZWJwYWNrOi8vL3dlYnBhY2svcnVudGltZS9kZWZpbmUgcHJvcGVydHkgZ2V0dGVycyIsIndlYnBhY2s6Ly8vd2VicGFjay9ydW50aW1lL2hhc093blByb3BlcnR5IHNob3J0aGFuZCIsIndlYnBhY2s6Ly8vd2VicGFjay9ydW50aW1lL21ha2UgbmFtZXNwYWNlIG9iamVjdCIsIndlYnBhY2s6Ly8vLi9jaGF0LmNvbXBpbGVkLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIERhcmsgTW9kZSBTdHlsZXNoZWV0XG5mdW5jdGlvbiBjcmVhdGVEYXJrTW9kZUNTUygpIHtcblx0Y29uc3QgY3NzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpO1xuXHRjc3MucmVsID0gJ3N0eWxlc2hlZXQnO1xuXHRjc3MuaHJlZiA9ICcvYXNzZXRzL2VkaXRvckRhcmtNb2RlLmNzcyc7XG5cdGNzcy5pZCA9ICd0aGVtZS1saW5rJztcblx0cmV0dXJuIGNzcztcbn1cblxuLy8gRGFyayBNb2RlIHN3aXRjaFxuY29uc3QgZGFya01vZGVUb2dnbGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjZGFyay1tb2RlLXN3aXRjaCcpO1xuY29uc3QgZGFya01vZGVMb2NhbFN0b3JhZ2VWYWx1ZSA9IHdpbmRvdy5sb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnY29sb3JUaGVtZScpO1xuZnVuY3Rpb24gZ2V0RGFya01vZGVUb2dnbGVTdGF0ZSgpIHtcblx0cmV0dXJuIGRhcmtNb2RlVG9nZ2xlLmNoZWNrZWQ7XG59XG5cbi8qKlxuICogU2VuZCBjb2xvciB0aGVtZSBjaG9pY2UgdG8gR29vZ2xlIEFuYWx5dGljc1xuICovXG5mdW5jdGlvbiByZXBvcnRDb2xvclRoZW1lKCkge1xuXHRnYSgnc2VuZCcsIHtcblx0XHRoaXRUeXBlOiAnZXZlbnQnLFxuXHRcdGV2ZW50Q2F0ZWdvcnk6ICdWVFQnLFxuXHRcdGV2ZW50QWN0aW9uOiBnZXREYXJrTW9kZVRvZ2dsZVN0YXRlKCkgPyAnRGFyaycgOiAnTGlnaHQnLFxuXHRcdGV2ZW50TGFiZWw6ICdVSS1UaGVtZScsXG5cdH0pO1xufVxuXG5mdW5jdGlvbiBmaXJlU3ByaWdFdmVudCgpIHtcblx0dHJ5IHtcblx0XHRTcHJpZygndHJhY2snLCAnRGFyayBNb2RlJyk7XG5cdH0gY2F0Y2ggKGVycikge1xuXHRcdHdpbmRvdy5ERF9SVU0/LmFkZEVycm9yKGVycik7XG5cdH1cbn1cblxuZnVuY3Rpb24gY3JlYXRlU2hlcGhlcmRUb3VyKCkge1xuXHQvLyBQb3B1cCBtZXNzYWdpbmdcblx0Y29uc3QgZGFya01vZGV0b3VyID0gbmV3IFNoZXBoZXJkLlRvdXIoe1xuXHRcdGRlZmF1bHRTdGVwT3B0aW9uczoge1xuXHRcdFx0Y2FuY2VsSWNvbjoge1xuXHRcdFx0XHRlbmFibGVkOiB0cnVlLFxuXHRcdFx0fSxcblx0XHRcdGNsYXNzZXM6ICdyb2xsMjAtZGFya21vZGUtc3RlcCcsXG5cdFx0fSxcblx0fSk7XG5cdGRhcmtNb2RldG91ci5hZGRTdGVwKHtcblx0XHR0aXRsZTogaTE4bignZGFya19tb2RlX3BvcHVwX3RpdGxlJyksXG5cdFx0dGV4dDogaTE4bignZGFya19tb2RlX3BvcHVwX2Rlc2MnKSxcblx0XHRhdHRhY2hUbzoge1xuXHRcdFx0ZWxlbWVudDogJy5kYXJrLW1vZGUtc3dpdGNoJyxcblx0XHRcdG9uOiAncmlnaHQnLFxuXHRcdH0sXG5cdFx0YnV0dG9uczogW1xuXHRcdFx0e1xuXHRcdFx0XHRhY3Rpb24oKSB7XG5cdFx0XHRcdFx0Y29uc3QgdGhlbWUgPSBnZXREYXJrTW9kZVRvZ2dsZVN0YXRlKCkgPyAnZGFyaycgOiAnbGlnaHQnO1xuXHRcdFx0XHRcdHdpbmRvdy5sb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnY29sb3JUaGVtZScsIHRoZW1lKTtcblx0XHRcdFx0XHRyZXR1cm4gdGhpcy5jYW5jZWwoKTtcblx0XHRcdFx0fSxcblx0XHRcdFx0Y2xhc3NlczogJ3NoZXBoZXJkLWJ1dHRvbi1zZWNvbmRhcnknLFxuXHRcdFx0XHR0ZXh0OiAnRGlzbWlzcycsXG5cdFx0XHR9LFxuXHRcdF0sXG5cdFx0cG9wcGVyT3B0aW9uczoge1xuXHRcdFx0bW9kaWZpZXJzOiBbeyBuYW1lOiAnb2Zmc2V0Jywgb3B0aW9uczogeyBvZmZzZXQ6IFswLCAyMF0gfSB9XSxcblx0XHR9LFxuXHRcdGlkOiAnZGFya01vZGVNb2RhbCcsXG5cdH0pO1xuXG5cdHJldHVybiBkYXJrTW9kZXRvdXI7XG59XG5cbi8vIEluaXRpYWxpemVzIHRoZSBsb2NhbFN0b3JhZ2UgdmFsdWUgYW5kIGVuYWJsZXMgdGhlIHN3aXRjaFxuZnVuY3Rpb24gc2V0dXBEYXJrTW9kZSgpIHtcblx0aWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdjb2xvclRoZW1lJykgPT09IG51bGwpIHtcblx0XHRjcmVhdGVTaGVwaGVyZFRvdXIoKS5zdGFydCgpO1xuXHR9XG5cdC8vIElmIHRoZXJlIGlzIGEgdmFsdWUgaW4gbG9jYWwgc3RvcmFnZSB0aGVuIHVzZSB0aGF0XG5cdGlmIChkYXJrTW9kZUxvY2FsU3RvcmFnZVZhbHVlKSB7XG5cdFx0ZGFya01vZGVUb2dnbGUuY2hlY2tlZCA9IGRhcmtNb2RlTG9jYWxTdG9yYWdlVmFsdWUgPT09ICdkYXJrJztcblx0fSBlbHNlIHsgLy8gb3RoZXJ3aXNlLCB1c2UgYSBtZWRpYSBxdWVyeSB0byBjaGVjayB0aGUgYnJvd3NlciBwcmVmZXJlbmNlXG5cdFx0Y29uc3QgZGFya01vZGVQcmVmZXJyZWQgPSB3aW5kb3cubWF0Y2hNZWRpYSgnKHByZWZlcnMtY29sb3Itc2NoZW1lOiBkYXJrKScpLm1hdGNoZXM7XG5cdFx0ZGFya01vZGVUb2dnbGUuY2hlY2tlZCA9IGRhcmtNb2RlUHJlZmVycmVkO1xuXHR9XG5cblx0aWYgKGdldERhcmtNb2RlVG9nZ2xlU3RhdGUoKSkge1xuXHRcdGRvY3VtZW50LmJvZHkuYXBwZW5kKGNyZWF0ZURhcmtNb2RlQ1NTKCkpO1xuXHRcdGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5kYXJrLW1vZGUtc3dpdGNoIC50b29sdGlwdGV4dCcpLmlubmVySFRNTCA9IGkxOG4oJ2RhcmtfbW9kZV9kaXNhYmxlJyk7XG5cdH1cblxuXHRkYXJrTW9kZVRvZ2dsZS5kaXNhYmxlZCA9IGZhbHNlO1xuXG5cdC8vIElmIHRoZSB1c2VyIG1hbnVhbGx5IHRvZ2dsZXMgdGhlIHN3aXRjaCwgdGhlbiBzYXZlIHRoZWlyIHByZWZlcmVuY2UgdG8gbG9jYWwgc3RvcmFnZVxuXHRkYXJrTW9kZVRvZ2dsZS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoKSA9PiB7XG5cdFx0Y29uc3QgdGhlbWUgPSBnZXREYXJrTW9kZVRvZ2dsZVN0YXRlKCkgPyAnZGFyaycgOiAnbGlnaHQnO1xuXHRcdHdpbmRvdy5sb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnY29sb3JUaGVtZScsIHRoZW1lKTtcblxuXHRcdGNvbnN0IHRoZW1lQ1NTID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI3RoZW1lLWxpbmsnKTtcblx0XHRpZiAodGhlbWVDU1MpIHtcblx0XHRcdGlmICh0aGVtZUNTUy5nZXRBdHRyaWJ1dGUoJ2hyZWYnKSA9PT0gJycpIHtcblx0XHRcdFx0dGhlbWVDU1MuaHJlZiA9ICcvYXNzZXRzL2VkaXRvckRhcmtNb2RlLmNzcyc7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0aGVtZUNTUy5ocmVmID0gJyc7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIHtcblx0XHRcdGRvY3VtZW50LmJvZHkuYXBwZW5kKGNyZWF0ZURhcmtNb2RlQ1NTKCkpO1xuXHRcdH1cblxuXHRcdGlmICh0aGVtZSA9PT0gJ2RhcmsnKSB7XG5cdFx0XHRkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZGFyay1tb2RlLXN3aXRjaCAudG9vbHRpcHRleHQnKS5pbm5lckhUTUwgPSBpMThuKCdkYXJrX21vZGVfZGlzYWJsZScpO1xuXHRcdFx0aWYoJCgnaWZyYW1lJykpe1xuXHRcdFx0XHQkKCdpZnJhbWUnKS5jb250ZW50cygpLmZpbmQoJ2JvZHknKS5hdHRyKCdjbGFzcycsJ3NoZWV0LWRhcmttb2RlJyk7XG5cdFx0XHRcdCQoJyN0ZXh0Y2hhdCcpLmFkZENsYXNzKCdzaGVldC1kYXJrbW9kZScpO1xuXHRcdFx0XHQkKCcjdGV4dGNoYXQgW2NsYXNzXj1cInNoZWV0LXJvbGx0ZW1wbGF0ZS1cIl0nKS5hZGRDbGFzcygnc2hlZXQtcm9sbHRlbXBsYXRlLWRhcmttb2RlJyk7XG5cdFx0XHR9XG5cblx0XHR9IGVsc2Uge1xuXHRcdFx0ZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmRhcmstbW9kZS1zd2l0Y2ggLnRvb2x0aXB0ZXh0JykuaW5uZXJIVE1MID0gaTE4bignZGFya19tb2RlX2VuYWJsZScpO1xuXHRcdFx0aWYoJCgnaWZyYW1lJykpe1xuXHRcdFx0XHQkKCdpZnJhbWUnKS5jb250ZW50cygpLmZpbmQoJ2JvZHknKS5hdHRyKCdjbGFzcycsJycpO1xuXHRcdFx0XHQkKCcjdGV4dGNoYXQnKS5yZW1vdmVDbGFzcygnc2hlZXQtZGFya21vZGUnKTtcblx0XHRcdFx0JCgnI3RleHRjaGF0IC5zaGVldC1yb2xsdGVtcGxhdGUtZGFya21vZGUnKS5yZW1vdmVDbGFzcygnc2hlZXQtcm9sbHRlbXBsYXRlLWRhcmttb2RlJyk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9KTtcblxuXHRyZXBvcnRDb2xvclRoZW1lKCk7XG5cdGlmIChnZXREYXJrTW9kZVRvZ2dsZVN0YXRlKCkpIHtcblx0XHRmaXJlU3ByaWdFdmVudCgpO1xuXHR9XG59XG5cbmV4cG9ydCB7XG5cdHNldHVwRGFya01vZGUsXG5cdGNyZWF0ZURhcmtNb2RlQ1NTLFxufTtcbiIsImltcG9ydCB7IGRvdCB9IGZyb20gJy4vbWF0aCc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE1hdHJpeCB7XG5cdC8qKlxuXHQgKiBAY29uc3RydWN0c1xuXHQgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IGFtb3VudHMgLSBGYWN0b3IgdG8gc2NhbGUgYnkgaW4gZWFjaCBkaXJlY3Rpb24uXG5cdCAqIEByZXR1cm5zIHtNYXRyaXh9IFNjYWxpbmcgbWF0cml4XG5cdCAqL1xuXHRzdGF0aWMgc2NhbGUoYW1vdW50cykge1xuXHRcdGNvbnN0IGxlbiA9IGFtb3VudHMubGVuZ3RoO1xuXHRcdGNvbnN0IG0gPSBNYXRyaXguaWRlbnRpdHkobGVuKTtcblx0XHRmb3IobGV0IGkgPSAwOyBpIDwgbGVuOyArK2kpIHtcblx0XHRcdG0uZGF0YVtpICogbGVuICsgaV0gPSBhbW91bnRzW2ldO1xuXHRcdH1cblx0XHRyZXR1cm4gbTtcblx0fVxuXG5cdC8qKlxuXHQgKiBAY29uc3RydWN0c1xuXHQgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IGFtb3VudHMgLSBGYWN0b3IgdG8gdHJhbnNsYXRlIGJ5IGluIGVhY2ggZGlyZWN0aW9uLlxuXHQgKiBAcmV0dXJucyB7TWF0cml4fSBUcmFuc2xhdGlvbiBtYXRyaXhcblx0ICovXG5cdHN0YXRpYyB0cmFuc2xhdGUoYW1vdW50cykge1xuXHRcdGNvbnN0IGxlbiA9IGFtb3VudHMubGVuZ3RoICsgMTtcblx0XHRjb25zdCBtID0gTWF0cml4LmlkZW50aXR5KGxlbik7XG5cdFx0Zm9yKGxldCBpID0gMTsgaSA8IGxlbjsgKytpKSB7XG5cdFx0XHRtLmRhdGFbaSAqIGxlbiAtIDFdID0gYW1vdW50c1tpIC0gMV07XG5cdFx0fVxuXHRcdHJldHVybiBtO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBjb25zdHJ1Y3RzXG5cdCAqIEBwYXJhbSB7bnVtYmVyfSByYWRpYW5zIC0gQW1vdW50IGJ5IHdoaWNoIHRvIHJvdGF0ZVxuXHQgKiBAcGFyYW0ge251bWJlcn0gW2ZpbmFsX2RpbWVuc2lvbmFsaXR5ID0gMl0gLSBUaGUgZGltZW5zaW9uIG9mIHRoZSBmaW5hbCBtYXRyaXhcblx0ICogQHJldHVybnMge01hdHJpeH0gUm90YXRpb24gbWF0cml4XG5cdCAqL1xuXHRzdGF0aWMgcm90YXRlMkQocmFkaWFucywgZmluYWxfZGltZW5zaW9uYWxpdHkgPSAyKSB7XG5cdFx0Y29uc3Qgc2luID0gTWF0aC5zaW4ocmFkaWFucyksIGNvcyA9IE1hdGguY29zKHJhZGlhbnMpO1xuXHRcdGNvbnN0IG91dCA9IHRoaXMuaWRlbnRpdHkoZmluYWxfZGltZW5zaW9uYWxpdHkpO1xuXHRcdG91dC5kYXRhWzBdID0gY29zO1xuXHRcdG91dC5kYXRhWzFdID0gLXNpbjtcblx0XHRvdXQuZGF0YVtmaW5hbF9kaW1lbnNpb25hbGl0eV0gPSBzaW47XG5cdFx0b3V0LmRhdGFbZmluYWxfZGltZW5zaW9uYWxpdHkgKyAxXSA9IGNvcztcblx0XHRyZXR1cm4gb3V0O1xuXHR9XG5cblx0LyoqXG5cdCAqIEBjb25zdHJ1Y3RzXG5cdCAqIEBwYXJhbSB7bnVtYmVyfSBzaXplIC0gRGltZW5zaW9uIG9mIHRoZSBtYXRyaXggaW4gYm90aCBkaXJlY3Rpb25zLlxuXHQgKiBAcmV0dXJucyB7TWF0cml4fSBJZGVudGl0eSBtYXRyaXhcblx0ICovXG5cdHN0YXRpYyBpZGVudGl0eShzaXplKSB7XG5cdFx0Y29uc3QgZGF0YSA9IG5ldyBBcnJheShzaXplICogc2l6ZSkuZmlsbCgwKTtcblx0XHRmb3IobGV0IGkgPSAwOyBpIDwgc2l6ZTsgKytpKSB7XG5cdFx0XHRkYXRhW2kgKiBzaXplICsgaV0gPSAxO1xuXHRcdH1cblx0XHRyZXR1cm4gbmV3IE1hdHJpeChkYXRhLCBzaXplLCBzaXplKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBAY29uc3RydWN0c1xuXHQgKiBAcGFyYW0ge0FycmF5PE51bWJlcj59IGRhdGEgLSBFbGVtZW50cyBvZiB0aGUgbWF0cml4LCBpbiByb3ctbWFqb3Igb3JkZXIuXG5cdCAqIEBwYXJhbSB7TnVtYmVyfSBtIC0gTnVtYmVyIG9mIHJvd3MuXG5cdCAqIEBwYXJhbSB7TnVtYmVyfSBuIC0gTnVtYmVyIG9mIGNvbHVtbnMuXG5cdCAqL1xuXHRjb25zdHJ1Y3RvcihkYXRhLCBtLCBuKSB7XG5cdFx0dGhpcy5tID0gdGhpcy5yb3dzID0gbTtcblx0XHR0aGlzLm4gPSB0aGlzLmNvbHMgPSBuO1xuXHRcdHRoaXMuZGF0YSA9IE9iamVjdC5hc3NpZ24oW10sIGRhdGEpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEByZXR1cm5zIHtNYXRyaXh9IEEgY2xvbmUgb2YgdGhpcyBNYXRyaXguXG5cdCAqL1xuXHRjbG9uZSgpIHtcblx0XHRyZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5kYXRhLCB0aGlzLm0sIHRoaXMubik7XG5cdH1cblxuXHQvKipcblx0ICogQHJldHVybiB7QXJyYXk8QXJyYXk8TnVtYmVyPj59IExpc3Qgb2Ygcm93cy5cblx0ICovXG5cdGdldFJvd3MoKSB7XG5cdFx0bGV0IHIgPSBuZXcgQXJyYXkodGhpcy5yb3dzKTtcblx0XHRsZXQgaSA9IDA7XG5cdFx0d2hpbGUoaSA8IHRoaXMuY29scykge1xuXHRcdFx0cltpXSA9IHRoaXMuZGF0YS5zbGljZShpICogdGhpcy5jb2xzLCArK2kgKiB0aGlzLmNvbHMpO1xuXHRcdH1cblx0XHRyZXR1cm4gcjtcblx0fVxuXG5cdC8qKlxuXHQgKiBAcmV0dXJuIHtBcnJheTxBcnJheTxOdW1iZXI+Pn0gTGlzdCBvZiBjb2x1bW5zXG5cdCAqL1xuXHRnZXRDb2xzKCl7XG5cdFx0bGV0IHIgPSBuZXcgQXJyYXkodGhpcy5jb2xzKTtcblx0XHRmb3IobGV0IGkgPSAwOyBpIDwgdGhpcy5jb2xzOyArK2kpIHtcblx0XHRcdHJbaV0gPSBuZXcgQXJyYXkodGhpcy5yb3dzKTtcblx0XHRcdGZvcihsZXQgaiA9IDA7IGogPCB0aGlzLnJvd3M7ICsraikge1xuXHRcdFx0XHRyW2ldW2pdID0gdGhpcy5kYXRhW2ogKiB0aGlzLmNvbHMgKyBpXTtcblx0XHRcdH1cblx0XHR9XG5cdFx0cmV0dXJuIHI7XG5cdH1cblxuXHQvKipcblx0ICogQHJldHVybiB7TWF0cml4fSBUcmFuc3Bvc2VkIGNvcHkgb2YgdGhpcyBtYXRyaXguXG5cdCAqL1xuXHR0cmFuc3Bvc2UoKSB7XG5cdFx0cmV0dXJuIG5ldyBNYXRyaXgoXy5mbGF0dGVuKHRoaXMuZ2V0Q29scygpKSwgdGhpcy5jb2xzLCB0aGlzLnJvd3MpO1xuXHR9XG5cblx0LyoqXG5cdCAqIE11bHRpcGx5IHRoaXMgbWF0cml4IHdpdGggYW5vdGhlciBtYXRyaXggb3IgdmVjdG9yLlxuXHQgKiBAcGFyYW0geyhNYXRyaXggfCBBcnJheTxOdW1iZXI+KX0gbWF0IC0gTWF0cml4IG9yIHZlY3RvciB3aXRoIHdoaWNoIHRvIG11bHRpcGx5LlxuXHQgKiBAcmV0dXJuIHsoTWF0cml4IHwgQXJyYXk8TnVtYmVyPil9IFJlc3VsdCBtYXRyaXggb3IgdmVjdG9yLlxuXHQgKi9cblx0bXVsKG1hdCkge1xuXHRcdGlmKHRoaXMuY29scyA9PT0gbWF0LnJvd3MpIHsgLy8gbWF0IGlzIGFub3RoZXIgbWF0cml4XG5cdFx0XHRsZXQgc2VsZiA9IHRoaXMuZ2V0Um93cygpO1xuXHRcdFx0bGV0IG90aGVyID0gbWF0LmdldENvbHMoKTtcblx0XHRcdGxldCByID0gbmV3IEFycmF5KHRoaXMucm93cyAqIG1hdC5jb2xzKTtcblx0XHRcdGZvcihsZXQgaSA9IDA7IGkgPCB0aGlzLnJvd3M7ICsraSkge1xuXHRcdFx0XHRmb3IobGV0IGogPSAwOyBqIDwgbWF0LmNvbHM7ICsraikge1xuXHRcdFx0XHRcdHJbaSAqIG1hdC5jb2xzICsgal0gPSBkb3Qoc2VsZltpXSwgb3RoZXJbal0pO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gbmV3IE1hdHJpeChyLCBtYXQuY29scywgdGhpcy5yb3dzKTtcblx0XHR9XG5cdFx0ZWxzZSBpZih0aGlzLmNvbHMgPT09IG1hdC5sZW5ndGgpIHsgLy8gbWF0IGlzIGEgdmVjdG9yXG5cdFx0XHRsZXQgc2VsZiA9IHRoaXMuZ2V0Um93cygpO1xuXHRcdFx0bGV0IHIgPSBuZXcgQXJyYXkodGhpcy5yb3dzKTtcblx0XHRcdGZvcihsZXQgaSA9IDA7IGkgPCB0aGlzLnJvd3M7ICsraSkge1xuXHRcdFx0XHRyW2ldID0gZG90KHNlbGZbaV0sIG1hdCk7XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gcjtcblx0XHR9XG5cdFx0ZWxzZSBpZih0aGlzLnJvd3MgPT09IG1hdC5sZW5ndGgpIHsgLy8gbWF0IGlzIGEgdmVjdG9yXG5cdFx0XHRsZXQgc2VsZiA9IHRoaXMuZ2V0Q29scygpO1xuXHRcdFx0bGV0IHIgPSBuZXcgQXJyYXkodGhpcy5jb2xzKTtcblx0XHRcdGZvcihsZXQgaSA9IDA7IGkgPCB0aGlzLmNvbHM7ICsraSkge1xuXHRcdFx0XHRyW2ldID0gZG90KHNlbGZbaV0sIG1hdCk7XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gcjtcblx0XHR9XG5cdFx0ZWxzZSB7XG5cdFx0XHRyZXR1cm4gTmFOO1xuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBDcmVhdGUgYSBuZXcgbWF0cml4IG9mIGEgZGlmZmVyZW50IHNpemUgd2hpY2ggbWFpbnRhaW5zIHRoZSBkYXRhIGZyb20gdGhpcyBNYXRyaXguXG5cdCAqIEBwYXJhbSB7bnVtYmVyfSBtIC0gTnVtYmVyIG9mIHJvd3Ncblx0ICogQHBhcmFtIHtudW1iZXJ9IG4gLSBOdW1iZXIgb2YgY29sdW1uc1xuXHQgKiBAcmV0dXJucyBUaGUgbmV3IE1hdHJpeFxuXHQgKi9cblx0cmVzaXplKG0sIG4pIHtcdFx0XHRcblx0XHRsZXQgbmV3X2RhdGEgPSB0aGlzLmdldFJvd3MoKTtcblx0XHRuZXdfZGF0YS5zcGxpY2UobSwgdGhpcy5tIC0gbSwgLi4ubmV3IEFycmF5KE1hdGgubWF4KG0gLSB0aGlzLm0sIDApKS5maWxsKG51bGwpKTtcblx0XHRuZXdfZGF0YSA9IF8uY2hhaW4obmV3X2RhdGEpXG5cdFx0XHQubWFwKHIgPT4gciA9PT0gbnVsbCA/IG5ldyBBcnJheShuKS5maWxsKDApIDogcilcblx0XHRcdC5lYWNoKHIgPT4gci5zcGxpY2Uobiwgci5sZW5ndGggLSBuLCAuLi5uZXcgQXJyYXkoTWF0aC5tYXgobiAtIHIubGVuZ3RoLCAwKSkuZmlsbCgwKSkpXG5cdFx0XHQudmFsdWUoKTtcblxuXHRcdHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcihuZXdfZGF0YSwgbSwgbik7XG5cdH1cblxuXHQvKipcblx0ICogQHJldHVybnMge0Zsb2F0MzJBcnJheX0gVGhlIHZhbHVlcyBvZiB0aGlzIG1hdHJpeCBpbiByb3ctbWFqb3Igb3JkZXIgY29udmVydGVkIHRvIGEgRmxvYXQzMkFycmF5LlxuXHQgKi9cblx0dG9GbG9hdDMyQXJyYXkoKSB7XG5cdFx0cmV0dXJuIG5ldyBGbG9hdDMyQXJyYXkodGhpcy5kYXRhKTtcblx0fVxufSIsIi8qKlxuICogQGNsYXNzZGVzYyBBIGNsYXNzIHdoaWNoIGNhbiBiZSBsaXN0ZW5lZCB0byBmb3IgZXZlbnRzLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPYnNlcnZhYmxlIHtcblx0LyoqXG5cdCAqIEBjb25zdHJ1Y3RvclxuXHQgKi9cblx0Y29uc3RydWN0b3IoKSB7XG5cdFx0dGhpcy5vYnNlcnZlcnMgPSBuZXcgTWFwKCk7XG5cdH1cblxuXHQvKipcblx0ICogQWRkIGFuIGV2ZW50IGxpc3RlbmVyXG5cdCAqIEBwYXJhbSB7Kn0gZXZlbnQgLSBUaGUgZXZlbnQgZm9yIHdoaWNoIHRvIGxpc3RlblxuXHQgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayAtIFdoYXQgdG8gZG8gd2hlbiB0aGUgZXZlbnQgZmlyZXNcblx0ICogQHJldHVybnMge1N5bWJvbH0gQSByZWZlcmVuY2UgZm9yIGRldGFjaGluZyB0aGlzIG9ic2VydmVyXG5cdCAqL1xuXHRvbihldmVudCwgY2FsbGJhY2spIHtcblx0XHRjb25zdCByZWYgPSBTeW1ib2woKTtcblx0XHRsZXQgZXZlbnRNYXAgPSB0aGlzLm9ic2VydmVycy5nZXQoZXZlbnQpO1xuXG5cdFx0aWYgKCFldmVudE1hcCkge1xuXHRcdFx0ZXZlbnRNYXAgPSBuZXcgTWFwKCk7XG5cdFx0XHR0aGlzLm9ic2VydmVycy5zZXQoZXZlbnQsIGV2ZW50TWFwKTtcblx0XHR9XG5cdFx0ZXZlbnRNYXAuc2V0KHJlZiwgY2FsbGJhY2spO1xuXHRcdHJldHVybiByZWY7XG5cdH1cblxuXHQvKipcblx0ICogUmVtb3ZlIGFuIGV2ZW50IGxpc3RlbmVyXG5cdCAqIEBwYXJhbSB7Kn0gZXZlbnQgLSBUaGUgZXZlbnQgd2hpY2ggdGhlIGxpc3RlbmVyIGlzIG9ic2VydmluZ1xuXHQgKiBAcGFyYW0ge1N5bWJvbH0gcmVmIC0gVGhlIFN5bWJvbCByZXR1cm5lZCBmcm9tIG9uKClcblx0ICovXG5cdG9mZihldmVudCwgcmVmKSB7XG5cdFx0Y29uc3QgZXZlbnRNYXAgPSB0aGlzLm9ic2VydmVycy5nZXQoZXZlbnQpO1xuXHRcdGlmIChldmVudE1hcCkge1xuXHRcdFx0cmV0dXJuIGV2ZW50TWFwLmRlbGV0ZShyZWYpO1xuXHRcdH1cblx0XHRyZXR1cm4gZmFsc2U7XG5cdH1cblxuXHQvKipcblx0ICogQ2xlYXIgYWxsIG9ic2VydmVycyBmcm9tIHRoZSBzcGVjaWZpZWQgZXZlbnRzLlxuXHQgKiBJZiBubyBldmVudHMgYXJlIGdpdmVuLCB0aGVuIGFsbCBvYnNlcnZlcnMgYXJlIGNsZWFyZWQgZnJvbSBhbGwgZXZlbnRzLlxuXHQgKiBAcGFyYW0ge0l0ZXJhYmxlPGFueT59IFtldmVudHNdIC0gRXZlbnRzIGZyb20gd2hpY2ggb2JzZXJ2ZXJzIHNob3VsZCBiZSBjbGVhcmVkXG5cdCAqL1xuXHRjbGVhckV2ZW50T2JzZXJ2ZXJzKGV2ZW50cyA9IG51bGwpIHtcblx0XHRpZiAoZXZlbnRzID09PSBudWxsKSB7XG5cdFx0XHR0aGlzLm9ic2VydmVycyA9IG5ldyBNYXAoKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Zm9yIChjb25zdCBlIG9mIGV2ZW50cykge1xuXHRcdFx0XHR0aGlzLm9ic2VydmVycy5kZWxldGUoZSk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG5cblx0LyoqXG5cdCAqIFRyaWdnZXIgYW4gZXZlbnRcblx0ICogQHBhcmFtIHsqfSBldmVudCAtIFdoaWNoIGV2ZW50P1xuXHQgKiBAcGFyYW0gIHsuLi5hbnl9IGFyZ3MgLSBBcmd1bWVudCBsaXN0IHRvIGJlIHBhc3NlZCB0byBvYnNlcnZlcnNcblx0ICovXG5cdHRyaWdnZXIoZXZlbnQsIC4uLmFyZ3MpIHtcblx0XHRsZXQgaXRlcmFibGU7XG5cdFx0dHJ5IHtcblx0XHRcdGl0ZXJhYmxlID0gdGhpcy5vYnNlcnZlcnMuZ2V0KGV2ZW50KS52YWx1ZXMoKTtcblx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0Zm9yIChjb25zdCBjYWxsYmFjayBvZiBpdGVyYWJsZSkge1xuXHRcdFx0Y2FsbGJhY2soLi4uYXJncyk7XG5cdFx0fVxuXHR9XG59XG4iLCJpbXBvcnQge1xuXHRhZGQsXG5cdHN1Yixcblx0ZGl2LFxuXHRkb3QsXG59IGZyb20gJy4vbWF0aCc7XG5pbXBvcnQgTWF0cml4IGZyb20gJy4vTWF0cml4JztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVjdGFuZ2xlIHtcblx0LyoqXG5cdCAqIEBjb25zdHJ1Y3RzXG5cdCAqIEBwYXJhbSB7TnVtYmVyfSB4IC0gWCBjb29yZGluYXRlIG9mIG1pZHBvaW50LlxuXHQgKiBAcGFyYW0ge051bWJlcn0geSAtIFkgY29vcmRpbmF0ZSBvZiBtaWRwb2ludC5cblx0ICogQHBhcmFtIHtOdW1iZXJ9IHcgLSBXaWR0aCBvZiByZWN0YW5nbGUuXG5cdCAqIEBwYXJhbSB7TnVtYmVyfSBoIC0gSGVpZ2h0IG9mIHJlY3RhbmdsZS5cblx0ICogQHBhcmFtIHtOdW1iZXJ9IHRoZXRhIC0gQW5nbGUgb2Ygcm90YXRpb24sIGluIHJhZGlhbnMuXG5cdCAqL1xuXHRjb25zdHJ1Y3Rvcih4LCB5LCB3LCBoLCB0aGV0YSkge1xuXHRcdHRoaXMubWlkcG9pbnQgPSBbeCwgeV07XG5cdFx0dGhpcy53aWR0aCA9IHc7XG5cdFx0dGhpcy5oZWlnaHQgPSBoO1xuXHRcdHRoaXMudGhldGEgPSB0aGV0YSAlIChNYXRoLlBJICogMik7XG5cblx0XHQvLyBTZXQgcG9pbnRzIHRvIGJlIGFuIG9mZnNldCBmcm9tIHRoZSBtaWRwb2ludCwgaW4gY2FzZSB3ZSBuZWVkIHRvIHJvdGF0ZSB0aGVtXG5cdFx0Y29uc3QgaGFsZl9oID0gaCAqIDAuNSwgaGFsZl93ID0gdyAqIDAuNTtcblx0XHR0aGlzLnBvaW50cyA9IFtcblx0XHRcdFstaGFsZl93LCAtaGFsZl9oXSwgLy8gVG9wLWxlZnRcblx0XHRcdFstaGFsZl93LCBoYWxmX2hdLCAvLyBCb3R0b20tbGVmdFxuXHRcdFx0W2hhbGZfdywgaGFsZl9oXSwgLy8gQm90dG9tLXJpZ2h0XG5cdFx0XHRbaGFsZl93LCAtaGFsZl9oXSAvLyBUb3AtcmlnaHRcblx0XHRdO1xuXG5cdFx0aWYodGhpcy50aGV0YSAhPT0gMCkge1xuXHRcdFx0Y29uc3Qgc2luID0gTWF0aC5zaW4odGhldGEpLCBjb3MgPSBNYXRoLmNvcyh0aGV0YSk7XG5cblx0XHRcdHRoaXMucm90YXRpb24gPSBuZXcgTWF0cml4KFtjb3MsIC1zaW4sIHNpbiwgY29zXSwgMiwgMik7XG5cdFx0XHR0aGlzLnJvdGF0aW9uX2ludmVyc2UgPSB0aGlzLnJvdGF0aW9uLnRyYW5zcG9zZSgpO1xuXHRcdFx0dGhpcy5wb2ludHMgPSBfLm1hcCh0aGlzLnBvaW50cywgcCA9PiB0aGlzLnJvdGF0aW9uLm11bChwKSk7XG5cdFx0fVxuXG5cdFx0Ly8gTW92ZSBwb2ludHMgdG8gdGhlaXIgYWJzb2x1dGUgcG9zaXRpb25zXG5cdFx0dGhpcy5wb2ludHMgPSBfLm1hcCh0aGlzLnBvaW50cywgcCA9PiBhZGQocCwgdGhpcy5taWRwb2ludCkpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEV4cGFuZCBvciBjb250cmFjdCB0aGlzIFJlY3RhbmdsZSBieSBhIGdpdmVuIGFtb3VudCBpbiBlYWNoIGdpdmVuIGRpcmVjdGlvbiBpbiBsb2NhbCBzcGFjZS5cblx0ICogQHBhcmFtIHtvYmplY3R9IG1hZ25pdHVkZXNcblx0ICogQHBhcmFtIHtudW1iZXJ9IFttYWduaXR1ZGVzLmxlZnRdIC14XG5cdCAqIEBwYXJhbSB7bnVtYmVyfSBbbWFnbml0dWRlcy5yaWdodF0gK3hcblx0ICogQHBhcmFtIHtudW1iZXJ9IFttYWduaXR1ZGVzLnVwXSAteVxuXHQgKiBAcGFyYW0ge251bWJlcn0gW21hZ25pdHVkZXMuZG93bl0gK3lcblx0ICogQHJldHVybiB7UmVjdGFuZ2xlfSB0aGlzXG5cdCAqIEBjaGFpbmFibGVcblx0ICovXG5cdHJlc2l6ZShtYWduaXR1ZGVzKSB7XG5cdFx0Y29uc3QgbGVmdCA9IG1hZ25pdHVkZXMubGVmdCB8fCAwLCByaWdodCA9IG1hZ25pdHVkZXMucmlnaHQgfHwgMDtcblx0XHRjb25zdCB1cCA9IG1hZ25pdHVkZXMudXAgfHwgMCwgZG93biA9IG1hZ25pdHVkZXMuZG93biB8fCAwO1xuXHRcdGxldCB2ZWN0b3JzID0gW1xuXHRcdFx0Wy1sZWZ0LCAwXSxcblx0XHRcdFtyaWdodCwgMF0sXG5cdFx0XHRbMCwgLXVwXSxcblx0XHRcdFswLCBkb3duXVxuXHRcdF07XG5cblx0XHRpZih0aGlzLnJvdGF0aW9uKSB7XG5cdFx0XHR2ZWN0b3JzID0gXy5tYXAodmVjdG9ycywgdiA9PiB0aGlzLnJvdGF0aW9uLm11bCh2KSk7XG5cdFx0fVxuXG5cdFx0dGhpcy5wb2ludHNbMF0gPSBhZGQodGhpcy5wb2ludHNbMF0sIHZlY3RvcnNbMF0sIHZlY3RvcnNbMl0pO1xuXHRcdHRoaXMucG9pbnRzWzFdID0gYWRkKHRoaXMucG9pbnRzWzFdLCB2ZWN0b3JzWzBdLCB2ZWN0b3JzWzNdKTtcblx0XHR0aGlzLnBvaW50c1syXSA9IGFkZCh0aGlzLnBvaW50c1syXSwgdmVjdG9yc1sxXSwgdmVjdG9yc1szXSk7XG5cdFx0dGhpcy5wb2ludHNbM10gPSBhZGQodGhpcy5wb2ludHNbM10sIHZlY3RvcnNbMV0sIHZlY3RvcnNbMl0pO1xuXG5cdFx0dGhpcy53aWR0aCArPSBsZWZ0ICsgcmlnaHQ7XG5cdFx0dGhpcy5oZWlnaHQgKz0gdXAgKyBkb3duO1xuXHRcdHRoaXMubWlkcG9pbnQgPSBkaXYoc3ViKHRoaXMucG9pbnRzWzJdLCB0aGlzLnBvaW50c1swXSksIDIpO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogVHJhbnNsYXRlIHRoaXMgUmVjdGFuZ2xlIGJ5IHRoZSBnaXZlbiB2ZWN0b3IuXG5cdCAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gdmVjdG9yIC0gMiBkaW1lbnNpb25hbCB2ZWN0b3IgdG8gdHJhbnNsYXRlIGJ5LlxuXHQgKiBAcmV0dXJucyB7UmVjdGFuZ2xlfSB0aGlzXG5cdCAqIEBjaGFpbmFibGVcblx0ICovXG5cdHRyYW5zbGF0ZSh2ZWN0b3IpIHtcblx0XHR0aGlzLm1pZHBvaW50ID0gYWRkKHRoaXMubWlkcG9pbnQsIHZlY3Rvcik7XG5cdFx0dGhpcy5wb2ludHMgPSBfLm1hcCh0aGlzLnBvaW50cywgcCA9PiBhZGQocCwgdmVjdG9yKSk7XG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogU2NhbGUgdGhpcyBSZWN0YW5nbGUgYnkgdGhlIGdpdmVuIHZlY3RvciBpbiBsb2NhbCBzcGFjZS5cblx0ICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSB2ZWN0b3IgLSAyIGRpbWVuc2lvbmFsIHZlY3RvciB0byBzY2FsZSBieS5cblx0ICogQHJldHVybnMge1JlY3RhbmdsZX0gdGhpc1xuXHQgKiBAY2hhaW5hYmxlXG5cdCAqL1xuXHRzY2FsZSh2ZWN0b3IpIHtcblx0XHRjb25zdCBtYXRyaXggPSBNYXRyaXguc2NhbGUodmVjdG9yKTtcblx0XHR0aGlzLnBvaW50cyA9IF8ubWFwKHRoaXMucG9pbnRzLCBwID0+XG5cdFx0XHQvLyBUcmFuc2xhdGUgdG8gb3JpZ2luLCBzY2FsZSwgdHJhbnNsYXRlIGJhY2tcblx0XHRcdGFkZChcblx0XHRcdFx0bWF0cml4Lm11bChcblx0XHRcdFx0XHRzdWIocCwgdGhpcy5taWRwb2ludClcblx0XHRcdFx0KSxcblx0XHRcdFx0dGhpcy5taWRwb2ludFxuXHRcdFx0KVxuXHRcdCk7XG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogVXNlIFNlcGFyYXRpbmcgQXhpcyBUaGVvcmVtIHRvIHRlc3QgaW50ZXJzZWN0aW9uLlxuXHQgKiBAcGFyYW0ge1JlY3RhbmdsZX0gcmVjdCAtIFRoZSByZWN0YW5nbGUgd2l0aCB3aGljaCB0byB0ZXN0IGludGVyc2VjdGlvbi5cblx0ICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGUgdHdvIHJlY3RhbmdsZXMgaW50ZXJzZWN0LlxuXHQgKi9cblx0cmVjdGFuZ2xlSW50ZXJzZWN0aW9uKHJlY3QpIHtcblx0XHQvLyBQYXJhbGxlbCBub3JtYWxzIGFyZSBmdW5jdGlvbmFsbHkgaWRlbnRpY2FsIGZvciB0aGlzIGFsZ29yaXRobSwgc28gb25seSBuZWVkIDIgdmVjdG9ycy5cblx0XHRjb25zdCBnZXQyTm9ybWFscyA9IChyKSA9PiB7XG5cdFx0XHRsZXQgbm9ybWFscyA9IFtcblx0XHRcdFx0WzEsIDBdLFxuXHRcdFx0XHRbMCwgMV1cblx0XHRcdF07XG5cdFx0XHRpZihyLnJvdGF0aW9uKSB7XG5cdFx0XHRcdHJldHVybiBfLm1hcChub3JtYWxzLCBuID0+IHIucm90YXRpb24ubXVsKG4pKTtcblx0XHRcdH1cblx0XHRcdHJldHVybiBub3JtYWxzO1xuXHRcdH07XG5cdFx0Ly8gR2V0IHRoZSBtaW4gYW5kIG1heCBvZiB0aGUgc2hhcGUgcHJvamVjdGVkIHVwb24gdGhpcyBheGlzLlxuXHRcdGNvbnN0IHByb2plY3RTaGFwZSA9IChwb2ludHMsIGF4aXMpID0+IHtcblx0XHRcdGxldCBtaW4gPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksIG1heCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTtcblx0XHRcdGZvcihjb25zdCBwIG9mIHBvaW50cykge1xuXHRcdFx0XHRjb25zdCBkID0gZG90KHAsIGF4aXMpO1xuXHRcdFx0XHRtaW4gPSBNYXRoLm1pbihtaW4sIGQpO1xuXHRcdFx0XHRtYXggPSBNYXRoLm1heChtYXgsIGQpO1xuXHRcdFx0fVxuXHRcdFx0cmV0dXJuIHsgbWluOiBtaW4sIG1heDogbWF4IH07XG5cdFx0fVxuXG5cdFx0Y29uc3Qgbm9ybWFscyA9IFsuLi5nZXQyTm9ybWFscyh0aGlzKSwgLi4uZ2V0Mk5vcm1hbHMocmVjdCldO1xuXHRcdGxldCBpbnRlcnNlY3Rpb24gPSB0cnVlO1xuXG5cdFx0Ly8gV2Uga25vdyB0aGF0IHRoZXNlIHNoYXBlcyBpbnRlcnNlY3QgaWYgbm9uZSBvZiB0aGUgbm9ybWFscyBhcmUgc2VwYXJhdGluZyBheGVzLlxuXHRcdGZvcihjb25zdCBuIG9mIG5vcm1hbHMpIHtcblx0XHRcdGNvbnN0IG1pbmUgPSBwcm9qZWN0U2hhcGUodGhpcy5wb2ludHMsIG4pLCBvdGhlciA9IHByb2plY3RTaGFwZShyZWN0LnBvaW50cywgbik7XG5cdFx0XHRpZihtaW5lLm1heCA8IG90aGVyLm1pbiB8fCBvdGhlci5tYXggPCBtaW5lLm1pbil7XG5cdFx0XHRcdC8vIEZvdW5kIGEgc2VwYXJhdGluZyBheGlzOyBubyBpbnRlcnNlY3Rpb24uXG5cdFx0XHRcdGludGVyc2VjdGlvbiA9IGZhbHNlO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdH1cblx0XHR9XG5cdFx0cmV0dXJuIGludGVyc2VjdGlvbjtcblx0fVxufVxuIiwiLyoqXG4gKiBBZGQgYSB2ZWN0b3Igd2l0aCB2ZWN0b3JzIC8gc2NhbGFyc1xuICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSB2ZWN0b3JcbiAqIEBwYXJhbSB7Li4uKEFycmF5PG51bWJlcj4gfCBudW1iZXIpfSBhcmdzIC0gVmVjdG9ycyBvciBzY2FsYXJzXG4gKiBAcmV0dXJucyB7QXJyYXk8bnVtYmVyPn0gVmVjdG9yIHJlc3VsdCBvZiBhZGRpdGlvblxuICovXG5mdW5jdGlvbiBhZGQodmVjdG9yKSB7IC8vIHZhcmlhZGljXG5cdGNvbnN0IGFjY3VtdWxhdG9yID0gXy5jbG9uZSh2ZWN0b3IpO1xuXHRmb3IobGV0IGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgKytpKSB7XG5cdFx0aWYoYXJndW1lbnRzW2ldLmxlbmd0aCkgeyAvLyB2ZWN0b3IgYXJnXG5cdFx0XHRmb3IobGV0IGogPSAwOyBqIDwgYWNjdW11bGF0b3IubGVuZ3RoOyArK2opIHtcblx0XHRcdFx0YWNjdW11bGF0b3Jbal0gKz0gYXJndW1lbnRzW2ldW2pdO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRlbHNlIHsgLy8gc2NhbGFyIGFyZ1xuXHRcdFx0Zm9yKGxldCBqID0gMDsgaiA8IGFjY3VtdWxhdG9yLmxlbmd0aDsgKytqKSB7XG5cdFx0XHRcdGFjY3VtdWxhdG9yW2pdICs9IGFyZ3VtZW50c1tpXTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblx0cmV0dXJuIGFjY3VtdWxhdG9yO1xufVxuXG4vKipcbiAqIFN1YnRyYWN0IGEgdmVjdG9yIHdpdGggdmVjdG9ycyAvIHNjYWxhcnNcbiAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gdmVjdG9yXG4gKiBAcGFyYW0gey4uLihBcnJheTxudW1iZXI+IHwgbnVtYmVyKX0gYXJncyAtIFNjYWxhcnMgb3IgdmVjdG9yc1xuICogQHJldHVybnMge0FycmF5PG51bWJlcj59IFZlY3RvciByZXN1bHQgb2Ygc3VidHJhY3Rpb25cbiAqL1xuZnVuY3Rpb24gc3ViKHZlY3RvcikgeyAvLyB2YXJpYWRpY1xuXHRjb25zdCBhY2N1bXVsYXRvciA9IF8uY2xvbmUodmVjdG9yKTtcblx0Zm9yKGxldCBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7ICsraSkge1xuXHRcdGlmKGFyZ3VtZW50c1tpXS5sZW5ndGgpIHsgLy8gdmVjdG9yIGFyZ1xuXHRcdFx0Zm9yKGxldCBqID0gMDsgaiA8IGFjY3VtdWxhdG9yLmxlbmd0aDsgKytqKSB7XG5cdFx0XHRcdGFjY3VtdWxhdG9yW2pdIC09IGFyZ3VtZW50c1tpXVtqXTtcblx0XHRcdH1cblx0XHR9XG5cdFx0ZWxzZSB7IC8vIHNjYWxhciBhcmdcblx0XHRcdGZvcihsZXQgaiA9IDA7IGogPCBhY2N1bXVsYXRvci5sZW5ndGg7ICsraikge1xuXHRcdFx0XHRhY2N1bXVsYXRvcltqXSAtPSBhcmd1bWVudHNbaV07XG5cdFx0XHR9XG5cdFx0fVxuXG5cdH1cblx0cmV0dXJuIGFjY3VtdWxhdG9yO1xufVxuXG4vKipcbiAqIFZlY3RvciAvIHNjYWxhciBtdWx0aXBsaWNhdGlvblxuICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSB2ZWN0b3JcbiAqIEBwYXJhbSB7Li4ubnVtYmVyfSBhcmdzIC0gU2NhbGFyc1xuICogQHJldHVybnMge0FycmF5PG51bWJlcj59IFZlY3RvciByZXN1bHQgb2YgbXVsdGlwbGljYXRpb25cbiAqL1xuZnVuY3Rpb24gbXVsKHZlY3Rvcil7IC8vIHZhcmlhZGljXG5cdGNvbnN0IGFjY3VtdWxhdG9yID0gXy5jbG9uZSh2ZWN0b3IpO1xuXHRmb3IobGV0IGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgKytpKSB7XG5cdFx0Zm9yKGxldCBqID0gMDsgaiA8IGFjY3VtdWxhdG9yLmxlbmd0aDsgKytqKSB7XG5cdFx0XHRhY2N1bXVsYXRvcltqXSAqPSBhcmd1bWVudHNbaV07XG5cdFx0fVxuXHR9XG5cdHJldHVybiBhY2N1bXVsYXRvcjtcbn1cblxuLyoqXG4gKiBWZWN0b3IgLyBzY2FsYXIgZGl2aXNpb25cbiAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gdmVjdG9yXG4gKiBAcGFyYW0gey4uLm51bWJlcn0gYXJncyAtIFNjYWxhcnNcbiAqIEByZXR1cm5zIHtBcnJheTxudW1iZXI+fSBWZWN0b3IgcmVzdWx0IG9mIGRpdmlzaW9uXG4gKi9cbmZ1bmN0aW9uIGRpdih2ZWN0b3IpeyAvLyB2YXJpYWRpY1xuXHRjb25zdCBhY2N1bXVsYXRvciA9IF8uY2xvbmUodmVjdG9yKTtcblx0Zm9yKGxldCBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7ICsraSkge1xuXHRcdGZvcihsZXQgaiA9IDA7IGogPCBhY2N1bXVsYXRvci5sZW5ndGg7ICsraikge1xuXHRcdFx0YWNjdW11bGF0b3Jbal0gLz0gYXJndW1lbnRzW2ldO1xuXHRcdH1cblx0fVxuXHRyZXR1cm4gYWNjdW11bGF0b3I7XG59XG5cbi8qKlxuICogQ29tcHV0ZSB0aGUgZG90IHByb2R1Y3QgYmV0d2VlbiB0d28gdmVjdG9ycy5cbiAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gYSAtIEZpcnN0IHZlY3RvclxuICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBiIC0gU2Vjb25kIHZlY3RvclxuICogQHJldHVybnMge251bWJlciB8IE5hTn0gU2NhbGFyIHJlc3VsdCBvZiBkb3QgcHJvZHVjdFxuICovXG5mdW5jdGlvbiBkb3QoYSwgYikge1xuXHRpZighYS5sZW5ndGggfHwgYS5sZW5ndGggIT09IGIubGVuZ3RoKSB7XG5cdFx0cmV0dXJuIE5hTjtcblx0fVxuXHRsZXQgYWNjdW11bGF0b3IgPSAwO1xuXHRmb3IobGV0IGkgPSAwOyBpIDwgYS5sZW5ndGg7ICsraSkge1xuXHRcdGFjY3VtdWxhdG9yICs9IGFbaV0gKiBiW2ldO1xuXHR9XG5cdHJldHVybiBhY2N1bXVsYXRvcjtcbn1cblxuLyoqXG4gKiBDb21wdXRlIHRoZSBjcm9zcyBwcm9kdWN0IGJldHdlZW4gdHdvIHZlY3RvcjNzXG4gKiBcbiAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gYSAtIEZpcnN0IHZlY3RvcjNcbiAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gYiAtIFNlY29uZCB2ZWN0b3IzXG4gKiBcbiAqIEByZXR1cm5zIHtBcnJheTxudW1iZXI+fSBDcm9zcyBwcm9kdWN0IHJlc3VsdFxuICovXG5mdW5jdGlvbiBjcm9zcyhhLCBiKSB7XG5cdGNvbnN0IHJlc3VsdCA9IG5ldyBBcnJheSgzKTtcblx0cmVzdWx0WzBdID0gYVsxXSAqIGJbMl0gLSBhWzJdICogYlsxXTtcblx0cmVzdWx0WzFdID0gYVsyXSAqIGJbMF0gLSBhWzBdICogYlsyXTtcblx0cmVzdWx0WzJdID0gYVswXSAqIGJbMV0gLSBhWzFdICogYlswXTtcblx0cmV0dXJuIHJlc3VsdDtcbn1cblxuLyoqXG4gKiBJbnRlcnNlY3Rpb24gdGVzdCBiZXR3ZWVuIHR3byBsaW5lcy5cbiAqIEBwYXJhbSB7QXJyYXk8QXJyYXk8bnVtYmVyPj59IGwxIC0gRmlyc3QgbGluZVxuICogQHBhcmFtIHtBcnJheTxBcnJheTxudW1iZXI+Pn0gbDIgLSBTZWNvbmQgbGluZVxuICogQHJldHVybiB7QXJyYXk8QXJyYXk8bnVtYmVyPj4gfCBOYU59IEludGVyc2VjdGlvbiBwb2ludCwgb3IgTmFOIGlmIHRoZSBsaW5lcyBhcmUgcGFyYWxsZWxcbiAqL1xuZnVuY3Rpb24gbGluZV9saW5lX2ludGVyc2VjdGlvbiAobDEsIGwyKSB7IC8vIGVhY2ggbGluZSBpcyBkZWZpbmVkIGJ5IHR3byBwb2ludHNcblx0bGV0IGRldGVybWluYW50MngyID0gKGEsIGIsIGMsIGQpID0+IGEgKiBkIC0gYiAqIGM7XG5cdGxldCBwMSA9IHsgeDogbDFbMF1bMF0sIHk6IGwxWzBdWzFdIH07XG5cdGxldCBwMiA9IHsgeDogbDFbMV1bMF0sIHk6IGwxWzFdWzFdIH07XG5cdGxldCBwMyA9IHsgeDogbDJbMF1bMF0sIHk6IGwyWzBdWzFdIH07XG5cdGxldCBwNCA9IHsgeDogbDJbMV1bMF0sIHk6IGwyWzFdWzFdIH07XG5cblx0bGV0IGRlbm9taW5hdG9yID0gZGV0ZXJtaW5hbnQyeDIocDEueCAtIHAyLngsIHAxLnkgLSBwMi55LCBwMy54IC0gcDQueCwgcDMueSAtIHA0LnkpO1xuXG5cdGlmKGRlbm9taW5hdG9yID09PSAwKSB7XG5cdFx0cmV0dXJuIE5hTjtcblx0fVxuXHRlbHNlIHtcblx0XHRsZXQgYSA9IGRldGVybWluYW50MngyKHAxLngsIHAxLnksIHAyLngsIHAyLnkpO1xuXHRcdGxldCBjID0gZGV0ZXJtaW5hbnQyeDIocDMueCwgcDMueSwgcDQueCwgcDQueSk7XG5cblx0XHRyZXR1cm4gW1xuXHRcdFx0ZGV0ZXJtaW5hbnQyeDIoYSwgcDEueCAtIHAyLngsIGMsIHAzLnggLSBwNC54KSAvIGRlbm9taW5hdG9yLFxuXHRcdFx0ZGV0ZXJtaW5hbnQyeDIoYSwgcDEueSAtIHAyLnksIGMsIHAzLnkgLSBwNC55KSAvIGRlbm9taW5hdG9yXG5cdFx0XTtcblx0fVxufVxuXG4vKipcbiAqIEludGVyc2VjdGlvbiB0ZXN0IGJldHdlZW4gdHdvIGxpbmUgc2VnbWVudHMgb24gYW4gWFkgQ29vcmRpbmF0ZSBQbGFuZS5cbiAqIEBwYXJhbSB7QXJyYXk8QXJyYXk8bnVtYmVyPj59IGwxIC0gRmlyc3QgbGluZVxuICogQHBhcmFtIHtBcnJheTxBcnJheTxudW1iZXI+Pn0gbDIgLSBTZWNvbmQgbGluZVxuICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBsaW5lcyBpbnRlcnNlY3QsIGZhc2Ugb3RoZXJ3aXNlXG4gKi9cbmZ1bmN0aW9uIGxpbmVfc2VnbWVudF9pbnRlcnNlY3Rpb24obDEsIGwyKSB7IC8vIGVhY2ggbGluZSBpcyBkZWZpbmVkIGJ5IHR3byBwb2ludHNcblx0Ly8gQ2hlY2sgaWYgdGhlIGludGVyc2VjdGlvbiBwb2ludCBpcyB3aXRoaW4gYSByZWN0YW5nbGUgZGVmaW5lZCBieSB0aGUgbGluZSdzIGVuZHBvaW50c1xuXHRjb25zdCBwb2ludFdpdGhpblJlY3RhbmdsZSA9IChsaW5lLCBwb2ludCkgPT4ge1xuXHRcdGxldCB0b3AgPSBNYXRoLmZsb29yKE1hdGgubWluKGxpbmVbMF1bMV0sIGxpbmVbMV1bMV0pKTsgLy8gZmxvb3IvY2VpbCB0aGVzZSB2YWx1ZXMgdG8gcHJldmVudCBmbG9hdGluZyBwb2ludCBlcnJvcnNcblx0XHRsZXQgYm90dG9tID0gTWF0aC5jZWlsKE1hdGgubWF4KGxpbmVbMF1bMV0sIGxpbmVbMV1bMV0pKTtcblx0XHRsZXQgbGVmdCA9IE1hdGguZmxvb3IoTWF0aC5taW4obGluZVswXVswXSwgbGluZVsxXVswXSkpO1xuXHRcdGxldCByaWdodCA9IE1hdGguY2VpbChNYXRoLm1heChsaW5lWzBdWzBdLCBsaW5lWzFdWzBdKSk7XG5cdFx0cmV0dXJuIChiZXR3ZWVuKGxlZnQsIHJpZ2h0LCBwb2ludFswXSkgJiYgYmV0d2Vlbih0b3AsIGJvdHRvbSwgcG9pbnRbMV0pKTtcblx0fTtcblxuXHRjb25zdCBpbnRlcnNlY3Rpb24gPSBsaW5lX2xpbmVfaW50ZXJzZWN0aW9uKGwxLCBsMik7XG5cblx0aWYodHlwZW9mIGludGVyc2VjdGlvbiAhPT0gXCJvYmplY3RcIikgeyAvLyBzaW5jZSB0aGUgaW50ZXJzZWN0aW9uIHJldHVybnMgTmFOIGlmIHBhcmFsbGVsLCBtYWtlIHN1cmUgdGhlIHJlc3VsdCByZXR1cm5lZCBpcyBhbiBhcnJheVxuXHRcdHJldHVybiBmYWxzZTtcblx0fVxuXG5cdHJldHVybiAocG9pbnRXaXRoaW5SZWN0YW5nbGUobDEsIGludGVyc2VjdGlvbikgJiYgcG9pbnRXaXRoaW5SZWN0YW5nbGUobDIsIGludGVyc2VjdGlvbikpOyAvLyBJZiB0aGUgcG9pbnQgaXMgd2l0aGluIHRoZSBib3VuZGluZyBib3ggb2YgYm90aCBsaW5lcywgaXQgaW50ZXJzZWN0cyB0aGVtXG59XG5cbi8qKlxuICogQ2hlY2sgaWYgYSBudW1iZXIgbjMgaXMgYmV0d2VlbiB0d28gbnVtYmVycyBuMSBhbmQgbjIuXG4gKiBAcGFyYW0ge251bWJlcn0gbjEgLSBGaXJzdCBudW1iZXJcbiAqIEBwYXJhbSB7bnVtYmVyfSBuMiAtIFNlY29uZCBudW1iZXJcbiAqIEBwYXJhbSB7bnVtYmVyfSBuMyAtIFRoaXJkIG51bWJlciAodGhlIG9uZSB3ZSdyZSBjaGVja2luZyBhZ2FpbnN0IHRoZSBvdGhlciB0d28pXG4gKiBAcGFyYW0ge2Jvb2xlYW59IGluY2x1c2l2ZSAtIE9wdGlvbmFsLiBJZiBzZXQgdG8gZmFsc2UsIGNvbXBhcmlzb24gd2lsbCBiZSA+IC8gPCByYXRoZXIgdGhhbiA+PSAvIDw9XG4gKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIG4zIGlzIGJldHdlZW4gbjEgYW5kIG4yLCBmYWxzZSBvdGhlcndpc2VcbiAqL1xuZnVuY3Rpb24gYmV0d2VlbihuMSwgbjIsIG4zLCBpbmNsdXNpdmUgPSB0cnVlKSB7XG5cdGNvbnN0IG1heCA9IE1hdGgubWF4KG4xLCBuMik7XG5cdGNvbnN0IG1pbiA9IE1hdGgubWluKG4xLCBuMik7XG5cblx0aWYoaW5jbHVzaXZlKSB7XG5cdFx0cmV0dXJuICgobjMgPD0gbWF4KSAmJiAobjMgPj0gbWluKSk7XG5cdH0gZWxzZSB7XG5cdFx0cmV0dXJuICgobjMgPCBtYXgpICYmIChuMyA+IG1pbikpO1xuXHR9XG59XG5cbi8qKlxuICogTGluZWFyIGludGVycG9sYXRpb24uIGEgYW5kIGIgbXVzdCBib3RoIGVpdGhlciBiZSBzY2FsYXJzIG9yIHZlY3RvcnMgb2YgZXF1YWwgbGVuZ3RoLlxuICogQHBhcmFtIHtudW1iZXIgfCBBcnJheTxudW1iZXI+fSBhIC0gRmlyc3QgdmVjdG9yIC8gc2NhbGFyXG4gKiBAcGFyYW0ge251bWJlciB8IEFycmF5PG51bWJlcj59IGIgLSBTZWNvbmQgdmVjdG9yIC8gc2NhbGFyXG4gKiBAcGFyYW0ge251bWJlcn0gdCAtIEludGVycG9sYXRpb24gZmFjdG9yXG4gKiBAcmV0dXJuIHtudW1iZXIgfCBBcnJheTxudW1iZXI+fSBJbnRlcnBvbGF0ZWQgc2NhbGFyIC8gdmVjdG9yXG4gKi9cbmZ1bmN0aW9uIGxlcnAoYSwgYiwgdCkge1xuXHRpZihhLmxlbmd0aCAhPT0gYi5sZW5ndGgpIHtcblx0XHRyZXR1cm4gTmFOO1xuXHR9XG5cdGlmKGEubGVuZ3RoKSB7IC8vIGEgYW5kIGIgYXJlIHZlY3RvcnNcblx0XHRyZXR1cm4gYWRkKGEsIG11bChzdWIoYiwgYSksIHQpKTtcblx0fVxuXHRlbHNlIHsgLy8gYSBhbmQgYiBhcmUgc2NhbGFyc1xuXHRcdHJldHVybiBhICsgdCAqIChiIC0gYSk7XG5cdH1cbn1cblxuLyoqXG4gKiBTcGhlcmljYWwgbGluZWFyIGludGVycG9sYXRpb25cbiAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gYSAtIEZpcnN0IHZlY3RvclxuICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBiIC0gU2Vjb25kIHZlY3RvclxuICogQHBhcmFtIHtudW1iZXJ9IHQgLSBJbnRlcnBvbGF0aW9uIGZhY3RvciAodXN1YWxseSBbMCwgMV0pXG4gKiBAcmV0dXJucyB7QXJyYXk8bnVtYmVyPn0gVmVjdG9yIHJlc3VsdFxuICovXG5mdW5jdGlvbiBzbGVycChhLCBiLCB0KSB7XG5cdGlmKCFhLmxlbmd0aCA+IDEgfHwgYS5sZW5ndGggIT09IGIubGVuZ3RoKSB7XG5cdFx0cmV0dXJuIE5hTjtcblx0fVxuXHRjb25zdCBjbGFtcGVkID0gY2xhbXAoZG90KG5vcm1hbGl6ZShhKSwgbm9ybWFsaXplKGIpKSwgLTEsIDEpO1xuXHRjb25zdCBvbWVnYSA9IE1hdGguYWNvcyhjbGFtcGVkKTtcblx0Y29uc3Qgc2luX29tZWdhID0gTWF0aC5zaW4ob21lZ2EpO1xuXHRyZXR1cm4gYWRkKG11bChhLCBNYXRoLnNpbigoMSAtIHQpICogb21lZ2EpIC8gc2luX29tZWdhKSwgbXVsKGIsIE1hdGguc2luKHQgKiBvbWVnYSkgLyBzaW5fb21lZ2EpKTtcbn1cblxuLyoqXG4gKiBDbGFtcCBhIHZhbHVlIHRvIGEgcmFuZ2UgYm91bmRlZCBieSBtaW4gYW5kIG1heCAoaW5jbHVzaXZlKS5cbiAqIEBwYXJhbSB7bnVtYmVyfSB2IC0gTnVtYmVyIHRvIGJlIGNsYW1wZWRcbiAqIEBwYXJhbSB7bnVtYmVyfSBtaW4gLSBNaW5pbXVtIHZhbHVlXG4gKiBAcGFyYW0ge251bWJlcn0gbWF4IC0gTWF4aW11bSB2YWx1ZVxuICogQHJldHVybiB7bnVtYmVyfSBDbGFtcGVkIHZhbHVlXG4gKi9cbmZ1bmN0aW9uIGNsYW1wKHYsIG1pbiwgbWF4KSB7XG5cdHJldHVybiBNYXRoLm1heChtaW4sIE1hdGgubWluKHYsIG1heCkpO1xufVxuXG4vKipcbiAqIENvbnZlcnQgZnJvbSByYWRpYW5zIHRvIGRlZ3JlZXMuXG4gKiBAcGFyYW0ge251bWJlcn0gcmFkaWFuc1xuICogQHJldHVybnMge251bWJlcn0gRGVncmVlc1xuICovXG5mdW5jdGlvbiBkZWdyZWVzKHJhZGlhbnMpIHtcblx0cmV0dXJuIHJhZGlhbnMgLyBNYXRoLlBJICogMTgwO1xufVxuXG4vKipcbiAqIENvbnZlcnQgZnJvbSBkZWdyZWVzIHRvIHJhZGlhbnMuXG4gKiBAcGFyYW0ge251bWJlcn0gZGVncmVlc1xuICogQHJldHVybiB7bnVtYmVyfSBSYWRpYW5zXG4gKi9cbmZ1bmN0aW9uIHJhZGlhbnMoZGVncmVlcykge1xuXHRyZXR1cm4gZGVncmVlcyAvIDE4MCAqIE1hdGguUEk7XG59XG5cbi8qKlxuICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSB2IC0gVmVjdG9yXG4gKiBAcmV0dXJucyB7QXJyYXk8bnVtYmVyPn0gQSBub3JtYWxpemVkIGNvcHkgb2YgdGhlIHZlY3Rvci5cbiAqL1xuZnVuY3Rpb24gbm9ybWFsaXplKHYpIHtcblx0Y29uc3QgbWFnMiA9IG1hZ25pdHVkZTIodik7XG5cdHJldHVybiBkaXYodiwgbWFnMiA9PT0gMCA/IEluZmluaXR5IDogTWF0aC5zcXJ0KG1hZzIpKTtcbn1cblxuLyoqXG4gKiBHZXQgdGhlIG1hZ25pdHVkZSBvZiB0aGlzIHZlY3Rvci4gUmVsYXRpdmVseSBzbG93LlxuICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSB2IC0gVmVjdG9yXG4gKiBAcmV0dXJucyB7bnVtYmVyfSBNYWduaXR1ZGVcbiAqL1xuZnVuY3Rpb24gbWFnbml0dWRlKHYpIHtcblx0cmV0dXJuIE1hdGguc3FydChkb3QodiwgdikpO1xufVxuXG4vKipcbiAqIEdldCB0aGUgc3F1YXJlZCBtYWduaXR1ZGUgb2YgdGhpcyB2ZWN0b3IuIFRoaXMgaXMgc2lnbmlmaWNhbnRseSBmYXN0ZXIgdGhhbiBjYWxsaW5nIG1hZ25pdHVkZVxuICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSB2IC0gVmVjdG9yXG4gKiBAcmV0dXJucyB7bnVtYmVyfSBTcXVhcmVkIG1hZ25pdHVkZS5cbiAqL1xuZnVuY3Rpb24gbWFnbml0dWRlMih2KSB7XG5cdHJldHVybiBkb3Qodiwgdik7XG59XG5cbmV4cG9ydCB7XG5cdGFkZCxcblx0c3ViLFxuXHRtdWwsXG5cdGRpdixcblx0ZG90LFxuXHRjcm9zcyxcblx0bGluZV9saW5lX2ludGVyc2VjdGlvbixcblx0bGluZV9zZWdtZW50X2ludGVyc2VjdGlvbixcblx0YmV0d2Vlbixcblx0bGVycCxcblx0c2xlcnAsXG5cdGNsYW1wLFxuXHRkZWdyZWVzLFxuXHRyYWRpYW5zLFxuXHRub3JtYWxpemUsXG5cdG1hZ25pdHVkZSxcblx0bWFnbml0dWRlMixcbn07XG4iLCIvKipcbiAqIFRha2VzIGFuIGFycmF5IG9mIHJvbGxzIGZyb20gdGhlIGRpY2Ugc2VydmVyLFxuICogc2ltcGxpZmllcyBlYWNoIHJvbGwgaW50byB0aGUgZm9ybWF0IHVzZWQgYnkgc2hlZXR3b3JrZXJzXG4gKiBAcGFyYW0ge09iamVjdFtdfSBpbmxpbmVyb2xscyAtIEFuIGFycmF5IG9mIHJvbGxzIGZyb20gdGhlIHJvbGwgc2VydmVyXG4gKiBAcmV0dXJucyB7T2JqZWN0W119IEFuIGFycmF5IG9mIHJvbGxzIGZvcm1hdHRlZCBmb3IgdXNlIGJ5IHNoZWV0d29ya2Vyc1xuICovXG5jb25zdCBmb3JtYXREaWNlRm9yU2hlZXR3b3JrZXJzID0gKGlubGluZXJvbGxzKSA9PiB7XG5cdGNvbnN0IHJvbGxzID0gW107XG5cblx0Xy5lYWNoKGlubGluZXJvbGxzLCAocm9sbCkgPT4ge1xuXHRcdC8vIHJlc3VsdDogdGhlIHRvdGFsIHZhbHVlIG9mIHRoZSByb2xsIGNvbXB1dGVkIGJ5IHRoZSByb2xsIHNlcnZlclxuXHRcdC8vIGV4cHJlc3Npb246IHRoZSBvcmlnaW5hbCBleHByZXNzaW9uIGZvciB0aGlzIHJvbGwgKGkuZS4gJzFkMjArNCcpXG5cdFx0Ly8gZGljZTogYW4gYXJyYXkgb2YgaW50ZWdlcnMgZm9yIHRoZSBhY3R1YWwgcmVzdWx0IG9mIGVhY2ggZGllXG5cdFx0Ly8gcm9sbHM6IGFkZGl0aW9uYWwgaW5mb3JtYXRpb24gYWJvdXQgZWFjaCBpbmRpdmlkdWFsIHJvbGwsIGluY2x1ZGVpbmc6XG5cdFx0Ly8gLSBkaWNlOiBudW1iZXIgb2YgZGljZSByb2xsZWQgKHRoZSAnMicgaW4gJzJkNicpXG5cdFx0Ly8gLSBzaWRlczogbnVtYmVyIG9mIHNpZGVzIGZvciB0aGlzIHNldCBvZiBkaWNlICh0aGUgJzYnIGluICcyZDYnKVxuXHRcdC8vIC0gcmVzdWx0czogYW4gYXJyYXkgb2YgaW50ZWdlcnMgZm9yIHRoZSBhY3R1YWwgcmVzdWx0IG9mIGVhY2ggZGllIGluIHRoaXMgcGFydGljdWxhciByb2xsXG5cdFx0Y29uc3QgdGhpc3JvbGwgPSB7XG5cdFx0XHRyZXN1bHQ6IHJvbGwucmVzdWx0cy50b3RhbCxcblx0XHRcdGRpY2U6IFtdLFxuXHRcdFx0ZXhwcmVzc2lvbjogcm9sbC5leHByZXNzaW9uLFxuXHRcdFx0cm9sbHM6IFtdLFxuXHRcdH07XG5cdFx0Ly8gTG9vcCB0aHJvdWdoIGVhY2ggcm9sbFxuXHRcdF8uZWFjaChyb2xsLnJlc3VsdHMucm9sbHMsIChkaWNlKSA9PiB7XG5cdFx0XHQvLyBDb25zdHJ1Y3QgYW4gYXJyYXkgb2YgcmVzdWx0cyBmcm9tIHRoaXMgcm9sbFxuXHRcdFx0Y29uc3Qgcm9sbFJlc3VsdHMgPSBfLnBsdWNrKGRpY2UucmVzdWx0cywgJ3YnKTtcblx0XHRcdC8vIEFkZCB0aGF0IHRvIG91ciBhcnJheSBvZiBhbGwgZGljZSByZXN1bHRzXG5cdFx0XHR0aGlzcm9sbC5kaWNlID0gdGhpc3JvbGwuZGljZS5jb25jYXQocm9sbFJlc3VsdHMpO1xuXHRcdFx0Ly8gTWFrZSBzdXJlIHRoaXMgaXMgYWN0dWFsbHkgYSByb2xsIGFuZCBub3QgYSBtYXRoZW1hdGljYWwgb3BlcmF0aW9uXG5cdFx0XHRpZiAocm9sbFJlc3VsdHMubGVuZ3RoID4gMCAmJiBkaWNlLnNpZGVzICYmIGRpY2UuZGljZSkge1xuXHRcdFx0XHQvLyBJZiB0aGlzIGlzIGFjdHVhbGx5IGEgcm9sbCwgYWRkIG1vcmUgaW5mb3JtYXRpb24gdG8gb3VyIHJvbGxzIGFycmF5XG5cdFx0XHRcdHRoaXNyb2xsLnJvbGxzLnB1c2goe1xuXHRcdFx0XHRcdHNpZGVzOiBkaWNlLnNpZGVzLFxuXHRcdFx0XHRcdGRpY2U6IGRpY2UuZGljZSxcblx0XHRcdFx0XHRyZXN1bHRzOiByb2xsUmVzdWx0cyxcblx0XHRcdFx0fSk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdFx0cm9sbHMucHVzaCh0aGlzcm9sbCk7XG5cdH0pO1xuXG5cdHJldHVybiByb2xscztcbn07XG5cbi8qKlxuICogR2l2ZW4gYSByb2xsIHN0cmluZyB3aXRoIG5hbWVkIHJvbGxzLCByZXR1cm5zIGFuIG9iamVjdCB0byBtYXRjaCByb2xsXG4gKiBuYW1lcyB3aXRoIHRoZSBjb3JyZXNwb25kaW5nIGluZGV4IGZvciB0aGUgbG9jYXRpb24gb2YgdGhhdCByb2xsXG4gKiBpbiB0aGUgaW5saW5lcm9sbHMgYXJyYXlcbiAqIEBwYXJhbSB7c3RyaW5nfSByb2xsU3RyaW5nIC0gQSByb2xsIHN0cmluZyBmcm9tIGEgY2hhcmFjdGVyIHNoZWV0LFxuICogd2l0aCByb2xscyBhbHJlYWR5IHJlcGxhY2VkIHdpdGggaW5kaWNlc1xuICogQHJldHVybnMge09iamVjdH0gS2V5cyBhcmUgbmFtZXMgb2Ygcm9sbHMsIHZhbHVlcyBhcmUgdGhlIGluZGV4XG4gKiBsb2NhdGlvbiBvZiB0aGF0IHJvbGwgY29ycmVzcG9uZGluZyB0byB0aGUgaW5saW5lcm9sbHMgYXJyYXlcbiAqL1xuY29uc3QgZ2V0SW5kZXhlc0Zyb21Sb2xsU3RyaW5nID0gKHJvbGxTdHJpbmcpID0+IHtcblx0Y29uc3Qgcm9sbFJlZ2V4ID0gL3t7KFtcXHNcXFNdKj99Pyl9fS9naTtcblx0Y29uc3QgcmVzdWx0cyA9IHt9O1xuXHRjb25zdCBtYXRjaGVzID0gcm9sbFN0cmluZy5tYXRjaChyb2xsUmVnZXgpO1xuXG5cdGlmICghbWF0Y2hlcykgcmV0dXJuIHt9O1xuXG5cdG1hdGNoZXMuZm9yRWFjaCgocm9sbCkgPT4ge1xuXHRcdC8vIHZhbGlkIG1hdGNoZXMgd2lsbCBsb29rIGxpa2UgXCJ7e3JvbGwxPSRbWzFdXX19XCJcblx0XHQvLyBBdHRlbXB0IHRvIG1hdGNoIHRoZSByb2xsIG5hbWUgb24gdGhlIGxlZnQgc2lkZSBvZiB0aGUgc3RyaW5nXG5cdFx0Y29uc3QgbmFtZSA9IHJvbGwubWF0Y2goL3t7KC4qKT0vKTtcblx0XHQvLyBBdHRlbXB0IHRvIG1hdGNoIHRoZSByb2xsIGluZGV4IG9uIHRoZSByaWdodCBzaWRlIG9mIHRoZSBzdHJpbmdcblx0XHRjb25zdCBpbmRleCA9IHJvbGwubWF0Y2goL1xcJFxcW1xcWyguKilcXF1cXF0vKTtcblx0XHQvLyBJZiBib3RoIG1hdGNoLCB1c2UgdGhlIGNhcHR1cmUgZ3JvdXAgZnJvbSBlYWNoIG1hdGNoXG5cdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHByZWZlci1kZXN0cnVjdHVyaW5nXG5cdFx0aWYgKG5hbWUgJiYgaW5kZXgpIHJlc3VsdHNbbmFtZVsxXV0gPSBpbmRleFsxXTtcblx0fSk7XG5cdHJldHVybiByZXN1bHRzO1xufTtcblxuLyoqXG4gKiBUYWtlcyB0aGUgYXJyYXkgb2YgaW5saW5lcm9sbHMgZnJvbSB0aGUgY2hhdCBvcGVyYXRpb24gb2JqZWN0LCBmb3JtYXRzIHRoZW0gaW50byB0aGUgc2ltcGxpZmllZFxuICogc2hlZXR3b3JrZXIgcm9sbCBmb3JtYXQsIGFuZCByZXR1cm5zIHRoZW0gaW4gYW4gb2JqZWN0IHdpdGggdGhlIHJvbGwgbmFtZXMgYXMgdGhleSBrZXlzXG4gKiBAcGFyYW0ge0NoYXRPcGVyYXRpb259IGNoYXRPcCAtIENoYXQgb3BlcmF0aW9uIG9iamVjdCBvZiB0aGUgcm9sbCB0byBiZSBtb2RpZmllZFxuICogQHJldHVybnMge09iamVjdH0gS2V5cyBhcmUgbmFtZXMgb2Ygcm9sbHMsIHZhbHVlcyBhcmUgZm9ybWF0ZWQgcm9sbCByZXN1bHRzXG4gKi9cbmNvbnN0IHBhcnNlUm9sbERhdGEgPSAoY2hhdE9wKSA9PiB7XG5cdGNvbnN0IHJlc3VsdHMgPSB7fTtcblx0Ly8gR2V0IHRoZSBhcnJheSBvZiBmb3JtYXR0ZWQgZGljZSByb2xsc1xuXHRjb25zdCByb2xsQXJyYXkgPSBmb3JtYXREaWNlRm9yU2hlZXR3b3JrZXJzKGNoYXRPcC5pbmxpbmVyb2xscyk7XG5cdC8vIEdldCBhbiBvYmplY3QgdG8gbWF0Y2ggZWxlbWVudHMgaW4gdGhhdCBhcnJheSB0byB0aGUgcm9sbCBuYW1lXG5cdGNvbnN0IG5hbWVzV2l0aEluZGV4ZXMgPSBnZXRJbmRleGVzRnJvbVJvbGxTdHJpbmcoY2hhdE9wLmNvbnRlbnQpO1xuXHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZ3VhcmQtZm9yLWluXG5cdGZvciAoY29uc3QgbmFtZSBpbiBuYW1lc1dpdGhJbmRleGVzKSB7XG5cdFx0cmVzdWx0c1tuYW1lXSA9IHJvbGxBcnJheVtuYW1lc1dpdGhJbmRleGVzW25hbWVdXTtcblx0fVxuXHRyZXR1cm4gcmVzdWx0cztcbn07XG5cbi8qKlxuICogQWRkcyBhIG5ldyBwcm9taXNlIHRvIHBlbmRpbmdSb2xsUHJvbWlzZXMgdGhhdCBjYW4gYmUgcmVzb2x2ZWQgdmlhXG4gKiB0aGUgZmluaXNoUm9sbCBzaGVldHdvcmtlciBmdW5jdGlvblxuICogQHBhcmFtIHtPYmplY3R9IHBlbmRpbmdSb2xsUHJvbWlzZXMgLSBPdXIgb2JqZWN0IGZvciBvcmdhbml6aW5nIGFsbCBwZW5kaW5nUm9sbFByb21pc2VzXG4gKiBAcGFyYW0ge3N0cmluZ30gcHJvbWlzZUlkIC0gVGhlIHVuaXF1ZSBpZCBmb3IgdGhpcyBwcm9taXNlXG4gKiBAcmV0dXJucyB7T2JqZWN0fSBBbiBvYmplY3QgY29udGFpbmluZyB0aGUgcHJvbWlzZSwgcmVzb2x2ZSBmdW5jdGlvbiwgYW5kIHRoZSBwcm9taXNlIGlkXG4gKi9cbmNvbnN0IGNyZWF0ZVJvbGxQcm9taXNlID0gKHBlbmRpbmdSb2xsUHJvbWlzZXMsIHByb21pc2VJZCkgPT4ge1xuXHQvLyBLZWVwcyB0cmFjayBvZiByb2xsIHByb21pc2VzLCBzbyB0aGF0IHRoZXkgY2FuIGJlIHJlc29sdmVkIGxhdGVyXG5cdC8vIFdoZW4gdGhlIHNoZWV0d29ya2VyIGNhbGxzIHRoZSBmaW5pc2ggcm9sbCBmdW5jdGlvblxuXHRjb25zdCByZXN1bHQgPSB7XG5cdFx0Ly8gRmxhZyB0byBkZXRlcm1pbmUgaWYgd2UgbmVlZCB0byByZWplY3QgdGhlIHByb21pc2UgYWZ0ZXIgdGhlIHRpbWVvdXRcblx0XHRyZXNvbHZlZDogZmFsc2UsXG5cdFx0cHJvbWlzZUlkLFxuXHR9O1xuXHRyZXN1bHQucHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHQvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSByZXNvbHZlIGZ1bmN0aW9uIHNvIHRoYXQgaXQgY2FuIGJlIHJlc29sdmVkIGV4dGVybmFsbHlcblx0XHRyZXN1bHQucmVzb2x2ZSA9IHJlc29sdmU7XG5cblx0XHQvLyBBZnRlciA1IHNlY29uZHMsIGlmIHdlIGhhdmVuJ3QgZ290dGVuIGEgcmVzcG9uc2UgZnJvbSB0aGUgc2hlZXR3b3JrZXIsXG5cdFx0Ly8gUmVqZWN0IHRoaXMgcHJvbWlzZSBhbmQgZGlzcGxheSBvdXIgZXJyb3IgbWVzc2FnZVxuXHRcdHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdFx0aWYgKCFyZXN1bHQucmVzb2x2ZWQpIHJlamVjdCgpO1xuXHRcdFx0Ly8gQ2xlYW4gdXAsIHdlJ3JlIGRvbmUgd2l0aCB0aGlzIHByb21pc2Vcblx0XHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1wYXJhbS1yZWFzc2lnblxuXHRcdFx0ZGVsZXRlIHBlbmRpbmdSb2xsUHJvbWlzZXNbcHJvbWlzZUlkXTtcblx0XHR9LCA1MDAwKTtcblx0fSk7XG5cblx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXBhcmFtLXJlYXNzaWduXG5cdHBlbmRpbmdSb2xsUHJvbWlzZXNbcHJvbWlzZUlkXSA9IHJlc3VsdDtcblxuXHRyZXR1cm4gcGVuZGluZ1JvbGxQcm9taXNlc1twcm9taXNlSWRdO1xufTtcblxuLyoqXG4gKiBBZGRzIGNvbXB1dGVkIHJlc3VsdHMgZnJvbSBzaGVldHdvcmtlciB0byBhY3R1YWwgcmVzdWx0cyBmcm9tIHJvbGwgc2VydmVyXG4gKiBAcGFyYW0ge0NoYXRPcGVyYXRpb259IGNoYXRPcCAtIENoYXQgb3BlcmF0aW9uIG9iamVjdCBvZiB0aGUgcm9sbCB0byBiZSBtb2RpZmllZFxuICogQHBhcmFtIHtPYmplY3R9IGNvbXB1dGVkUmVzdWx0cyAtIEtleXMgYXJlIG5hbWVzIG9mIHJvbGxzLFxuICogVmFsdWVzIGFyZSB0aGUgY29ycmVzcG9uZGluZyBjb21wdXRlZCBzdHJpbmcgdmFsdWVcbiAqIEBwYXJhbSB7RnVuY3Rpb259IHN0cmlwVGFncyAtIFRoZSBzdHJpcCB0YWdzIHNhbml0aXphdGlvbiBmdW5jdGlvbiBmcm9tIGQyMC51dGlsc1xuICovXG5jb25zdCBhZGRDb21wdXRlZFJlc3VsdHMgPSAoY2hhdE9wLCBjb21wdXRlZFJlc3VsdHMsIHN0cmlwVGFncykgPT4ge1xuXHRjb25zdCByb2xsSW5kZXhlcyA9IGdldEluZGV4ZXNGcm9tUm9sbFN0cmluZyhjaGF0T3AuY29udGVudCk7XG5cdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBndWFyZC1mb3ItaW5cblx0Zm9yIChjb25zdCByb2xsIGluIHJvbGxJbmRleGVzKSB7XG5cdFx0Y29uc3QgaW5kZXggPSByb2xsSW5kZXhlc1tyb2xsXTtcblx0XHRpZiAoY2hhdE9wLmlubGluZXJvbGxzW2luZGV4XSAmJiBjb21wdXRlZFJlc3VsdHNbcm9sbF0gIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0Ly8gQWRkaW5nIHRoZSBjb21wdXRlZCByZXN1bHQgYXMgYSBuZXcgZmllbGQgdG8gdGhlIGlubGluZSByb2xsXG5cdFx0XHQvLyBBcyBsb25nIGFzIHdlIGRvbid0IGNoYW5nZSB0aGUgJ3Jlc3VsdHMnIGZpZWxkLCB0aGUgcm9sbFxuXHRcdFx0Ly8gd2lsbCBzdGlsbCBiZSBjb3JyZWN0bHkgc2lnbmVkXG5cdFx0XHQvLyBTdHJpbmdpZnkgdGhlIHJlc3VsdCBhbmQgc2VuZCBpdCB0aHJvdWdoIHRoZSBzYW5pdGl6YXRpb24gZnVuY3Rpb24sXG5cdFx0XHQvLyBUbyBtYWtlIHN1cmUgdGhlcmUgaXNuJ3QgYW55IGRpc2FsbG93ZWQganMvaHRtbFxuXHRcdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXBhcmFtLXJlYXNzaWduXG5cdFx0XHRjaGF0T3AuaW5saW5lcm9sbHNbaW5kZXhdLmNvbXB1dGVkID0gc3RyaXBUYWdzKGAke2NvbXB1dGVkUmVzdWx0c1tyb2xsXX1gKTtcblx0XHR9XG5cdH1cbn07XG5cbmV4cG9ydCB7XG5cdGZvcm1hdERpY2VGb3JTaGVldHdvcmtlcnMsXG5cdGdldEluZGV4ZXNGcm9tUm9sbFN0cmluZyxcblx0cGFyc2VSb2xsRGF0YSxcblx0Y3JlYXRlUm9sbFByb21pc2UsXG5cdGFkZENvbXB1dGVkUmVzdWx0cyxcbn07XG4iLCIvLyBUaGUgbW9kdWxlIGNhY2hlXG52YXIgX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fID0ge307XG5cbi8vIFRoZSByZXF1aXJlIGZ1bmN0aW9uXG5mdW5jdGlvbiBfX3dlYnBhY2tfcmVxdWlyZV9fKG1vZHVsZUlkKSB7XG5cdC8vIENoZWNrIGlmIG1vZHVsZSBpcyBpbiBjYWNoZVxuXHR2YXIgY2FjaGVkTW9kdWxlID0gX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fW21vZHVsZUlkXTtcblx0aWYgKGNhY2hlZE1vZHVsZSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0cmV0dXJuIGNhY2hlZE1vZHVsZS5leHBvcnRzO1xuXHR9XG5cdC8vIENyZWF0ZSBhIG5ldyBtb2R1bGUgKGFuZCBwdXQgaXQgaW50byB0aGUgY2FjaGUpXG5cdHZhciBtb2R1bGUgPSBfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX19bbW9kdWxlSWRdID0ge1xuXHRcdC8vIG5vIG1vZHVsZS5pZCBuZWVkZWRcblx0XHQvLyBubyBtb2R1bGUubG9hZGVkIG5lZWRlZFxuXHRcdGV4cG9ydHM6IHt9XG5cdH07XG5cblx0Ly8gRXhlY3V0ZSB0aGUgbW9kdWxlIGZ1bmN0aW9uXG5cdF9fd2VicGFja19tb2R1bGVzX19bbW9kdWxlSWRdKG1vZHVsZSwgbW9kdWxlLmV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pO1xuXG5cdC8vIFJldHVybiB0aGUgZXhwb3J0cyBvZiB0aGUgbW9kdWxlXG5cdHJldHVybiBtb2R1bGUuZXhwb3J0cztcbn1cblxuIiwiLy8gZGVmaW5lIGdldHRlciBmdW5jdGlvbnMgZm9yIGhhcm1vbnkgZXhwb3J0c1xuX193ZWJwYWNrX3JlcXVpcmVfXy5kID0gKGV4cG9ydHMsIGRlZmluaXRpb24pID0+IHtcblx0Zm9yKHZhciBrZXkgaW4gZGVmaW5pdGlvbikge1xuXHRcdGlmKF9fd2VicGFja19yZXF1aXJlX18ubyhkZWZpbml0aW9uLCBrZXkpICYmICFfX3dlYnBhY2tfcmVxdWlyZV9fLm8oZXhwb3J0cywga2V5KSkge1xuXHRcdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIGtleSwgeyBlbnVtZXJhYmxlOiB0cnVlLCBnZXQ6IGRlZmluaXRpb25ba2V5XSB9KTtcblx0XHR9XG5cdH1cbn07IiwiX193ZWJwYWNrX3JlcXVpcmVfXy5vID0gKG9iaiwgcHJvcCkgPT4gKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApKSIsIi8vIGRlZmluZSBfX2VzTW9kdWxlIG9uIGV4cG9ydHNcbl9fd2VicGFja19yZXF1aXJlX18uciA9IChleHBvcnRzKSA9PiB7XG5cdGlmKHR5cGVvZiBTeW1ib2wgIT09ICd1bmRlZmluZWQnICYmIFN5bWJvbC50b1N0cmluZ1RhZykge1xuXHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICdNb2R1bGUnIH0pO1xuXHR9XG5cdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsgdmFsdWU6IHRydWUgfSk7XG59OyIsIi8qIGVzbGludC1kaXNhYmxlIG5vLXVuZGVmICovXG5pbXBvcnQgT2JzZXJ2YWJsZSBmcm9tICcuL3V0aWwvT2JzZXJ2YWJsZSc7XG5pbXBvcnQgKiBhcyBkMjBtYXRoIGZyb20gJy4vdXRpbC9tYXRoJztcbmltcG9ydCBNYXRyaXggZnJvbSAnLi91dGlsL01hdHJpeCc7XG5pbXBvcnQgUmVjdGFuZ2xlIGZyb20gJy4vdXRpbC9SZWN0YW5nbGUnO1xuXG5kMjAudXRpbHMgPSB7XG5cdFNWRzoge30sXG5cdHN0YXR0cmFja2VyOiB7fSxcblx0X2hleF9jb2xvcl9yZWdleDogL14jWzAtOWEtZl17Nn0kL2ksXG5cdF92aWRlb191cmxfcmVnZXg6IC9bXFx3XFwtXStcXC53ZWJtL2ksXG5cdGlzVmlkZW86IHVybCA9PiBkMjAudXRpbHMuX3ZpZGVvX3VybF9yZWdleC50ZXN0KHVybCksXG5cblx0LyoqXG5cdCAqIENhcHR1cmluZyBncm91cHM6IDE6IFwiZGVhZFwiLCAyOiBoZXggY29sb3IsIDM6IG51bWJlciB0byBvdmVybGF5XG5cdCAqIEBjb25zdGFudFxuXHQgKiBAcHJpdmF0ZVxuXHQgKi9cblx0X3N0YXR1c19yZWdleDogL14oPzooZGVhZCl8KFteQF0rKSg/OkAoXFxkKSk/KSQvLFxuXG5cdC8qKlxuXHQgKiBAdHlwZWRlZiBTdGF0dXNIYXNoXG5cdCAqIEB0eXBlIHtvYmplY3R9XG5cdCAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gZGVhZCAtIFwiZGVhZFwiIGlmIHRoZSBzdGF0dXMgdHlwZSBpcyBkZWFkLlxuXHQgKiBAcHJvcGVydHkgez9zdHJpbmd9IGNvbG9yIC0gSWYgdGhlIHN0YXR1cyBpcyBmb3IgYSBjb2xvciwgdGhlbiB0aGlzIHdpbGwgYmUgaXRzIGhleCBjb2RlLlxuXHQgKiBAcHJvcGVydHkgez9udW1iZXJ9IGljb24gLSBJZiB0aGUgc3RhdHVzIGlzIGZvciBhbiBpY29uLCB0aGVuIHRoaXMgd2lsbCBiZSBpdHMgc2hlZXQgaW5kZXguXG5cdCAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gbnVtYmVyIC0gU3RyaW5nIGNvbnRhaW5pbmcgYSBzaW5nbGUgZGlnaXQgdG8gYmUgb3ZlcmxheWVkIG9uIHRvcCBvZiB0aGUgc3RhdHVzIGljb24vY29sb3IuXG5cdCAqL1xuXHQvKipcblx0ICogR2V0IGluZm9ybWF0aW9uIGFib3V0IHdoYXQgdGhpcyBzdGF0dXMgbmFtZSBtZWFucy5cblx0ICogQHBhcmFtIHtzdHJpbmd9IHN0YXR1c1xuXHQgKiBAcmV0dXJuIHtTdGF0dXNIYXNofSBSZW5kZXJpbmcgZGF0YSBmb3IgdGhpcyBzdGF0dXMuXG5cdCAqL1xuXHRwYXJzZVN0YXR1czogc3RhdHVzID0+IHtcblx0XHRjb25zdCByZXN1bHRzID0gZDIwLnV0aWxzLl9zdGF0dXNfcmVnZXguZXhlYyhzdGF0dXMpO1xuXHRcdGNvbnN0IHN0YXR1c19oYXNoID0ge1xuXHRcdFx0ZGVhZDogKHJlc3VsdHMgJiYgcmVzdWx0c1sxXSkgfHwgbnVsbCwgLy8gcmVzdWx0c1sxXSBpZiBkZWZpbmVkLCBlbHNlIG51bGxcblx0XHRcdGljb246IG51bGwsXG5cdFx0XHRjb2xvcjogbnVsbCxcblx0XHRcdG51bWJlcjogKHJlc3VsdHMgJiYgcmVzdWx0c1szXSkgfHwgbnVsbCAvLyByZXN1bHRzWzNdIGlmIGRlZmluZWQsIGVsc2UgbnVsbFxuXHRcdH07XG5cdFx0aWYgKHJlc3VsdHMgJiYgcmVzdWx0c1syXSAmJiByZXN1bHRzWzJdICE9PSAnZGVhZCcpIHtcblx0XHRcdGlmIChfLmtleXMoZDIwLnRva2VuX2VkaXRvci5jb2xvck1hcmtlcnMpLmluY2x1ZGVzKHJlc3VsdHNbMl0pKSB7XG5cdFx0XHRcdHN0YXR1c19oYXNoLmNvbG9yID0gZDIwLnRva2VuX2VkaXRvci5jb2xvck1hcmtlcnNbcmVzdWx0c1syXV07XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRjb25zdCBpbWFnZSA9IF8uZmluZCh0b2tlbl9tYXJrZXJfYXJyYXksIChtYXJrZXIpID0+IHsgcmV0dXJuIG1hcmtlci50YWcgPT09IHJlc3VsdHNbMl0gfSk7XG5cdFx0XHRcdGlmICghaW1hZ2UpIHJldHVybiBmYWxzZTtcblx0XHRcdFx0c3RhdHVzX2hhc2guaWNvbiA9IGltYWdlLmlkO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRyZXR1cm4gcmVzdWx0cyAmJiBzdGF0dXNfaGFzaDtcblx0fSxcblxuXHRnZXRDb3JyZWN0U3RhdHVzTmFtZTogc3RhdHVzID0+IHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgcmVzdWx0cyA9IGQyMC51dGlscy5fc3RhdHVzX3JlZ2V4LmV4ZWMoc3RhdHVzKTtcblx0XHRcdGlmIChfLmtleXMoZDIwLnRva2VuX2VkaXRvci5jb2xvck1hcmtlcnMpLmluY2x1ZGVzKHJlc3VsdHNbMl0pKSB7XG5cdFx0XHRcdHJldHVybiBzdGF0dXM7XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IHRva2VuTWFya2VySWQgPSByZXN1bHRzWzJdID8gcGFyc2VJbnQoXy5sYXN0KHJlc3VsdHNbMl0uc3BsaXQoJzo6JykpKSA6IHJlc3VsdHNbMF07XG5cdFx0XHRjb25zdCBtYXJrZXIgPSBfLmZpbmQodG9rZW5fbWFya2VyX2FycmF5LCAobWFya2VyKSA9PiB7IHJldHVybiBtYXJrZXIuaWQgPT09IHRva2VuTWFya2VySWQgfSk7XG5cdFx0XHRpZiAobWFya2VyKSB7XG5cdFx0XHRcdGxldCBjb3JyZWN0TmFtZSA9IG1hcmtlci50YWc7XG5cdFx0XHRcdGlmIChyZXN1bHRzWzNdKSB7XG5cdFx0XHRcdFx0Y29ycmVjdE5hbWUgKz0gYEAke3Jlc3VsdHNbM119YDtcblx0XHRcdFx0fVxuXHRcdFx0XHRyZXR1cm4gY29ycmVjdE5hbWU7XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gc3RhdHVzO1xuXHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdGNvbnNvbGUuZXJyb3IoZSk7XG5cdFx0XHRyZXR1cm4gc3RhdHVzO1xuXHRcdH1cblx0fSxcblx0T2JzZXJ2YWJsZSxcbn07XG5cbndpbmRvd1tcImQyMGV4dFwiXSA9IHdpbmRvd1tcImQyMGV4dFwiXSB8fCB7fTtcbndpbmRvd1tcImQyMGV4dFwiXVtcInV0aWxzXCJdID0gZDIwLnV0aWxzO1xuXG5TdHJpbmcucHJvdG90eXBlLnRyYW5TdWIgPSBmdW5jdGlvbigpIHtcblx0dmFyIG9Bcmd1bWVudHMgPSBhcmd1bWVudHM7XG5cdHJldHVybiB0aGlzLnJlcGxhY2UoL3t7WzAtOV0rfX0vZywgZnVuY3Rpb24ocykge1xuXHRcdHJldHVybiBvQXJndW1lbnRzW3BhcnNlSW50KHMuc3Vic3RyaW5nKDIsIHMubGVuZ3RoIC0gMikpXTtcblx0fSk7XG59O1xuXG5kMjAubWF0aCA9IHtcblx0Li4uZDIwbWF0aCxcblx0TWF0cml4LFxuXHRSZWN0YW5nbGUsXG59O1xuXG4oZnVuY3Rpb24oKSB7XG5cdGlmICh0eXBlb2YgSlNfVFJBTlNMQVRJT05TICE9PSAndW5kZWZpbmVkJykge1xuXHRcdGkxOG4udHJhbnNsYXRvci5hZGQoe1xuXHRcdFx0dmFsdWVzOiBKU19UUkFOU0xBVElPTlNcblx0XHR9KTtcblx0fVxuXHR2YXIgaTE4bk91dHB1dEpTT04gPSB7fTtcblx0ZDIwLnV0aWxzLmh0bWxUcmFuc2xhdG9yID0gZnVuY3Rpb24oJGh0bWwsIGRvRHluYW1pYykge1xuXHRcdGlmICgkaHRtbCA9PT0gJycpIHJldHVybiAnJztcblx0XHRpZiAodHlwZW9mIGRvRHluYW1pYyA9PT0gJ3VuZGVmaW5lZCcpIGRvRHluYW1pYyA9IGZhbHNlO1xuXG5cdFx0dmFyIHJldHVyblR5cGUgPSAnalF1ZXJ5Jztcblx0XHQvLyBjcmVhdGVzIGpRdWVyeSBvYmogaWYgbm90IGFscmVhZHksIGJ1dCByZXR1cm5zIHRoZSB0eXBlIGl0J3MgZ2l2ZW5cblx0XHRpZiAodHlwZW9mICRodG1sID09PSAnc3RyaW5nJykge1xuXHRcdFx0cmV0dXJuVHlwZSA9ICdzdHJpbmcnO1xuXHRcdFx0JGh0bWwgPSAkKCRodG1sKTtcblx0XHR9XG5cdFx0ZWxzZSBpZiAoISgkaHRtbCBpbnN0YW5jZW9mIGpRdWVyeSkpIHtcblx0XHRcdHJldHVyblR5cGUgPSAnaHRtbCc7XG5cdFx0XHQkaHRtbCA9ICQoJGh0bWwpO1xuXHRcdH1cblx0XHR2YXIgYXR0cmlidXRlcyA9ICdbZGF0YS1pMThuXSxbZGF0YS1pMThuLXBsYWNlaG9sZGVyXSxbZGF0YS1pMThuLXRpdGxlXSxbZGF0YS1pMThuLWFsdF0sW2RhdGEtaTE4bi1hcmlhLWxhYmVsXSxbZGF0YS1pMThuLWxhYmVsXSc7XG5cdFx0aWYgKGRvRHluYW1pYykgYXR0cmlidXRlcyArPSAnLFtkYXRhLWkxOG4tZHluYW1pY10nO1xuXHRcdHZhciBsaXN0VmFsaWRhdG9yID0gZnVuY3Rpb24obGlzdFZhbHVlKSB7XG5cdFx0XHR2YXIgZXJyb3JNZXNzYWdlID0gW107XG5cdFx0XHRpZiAobGlzdFZhbHVlID09PSAnZXJyb3InKSBlcnJvck1lc3NhZ2UucHVzaCgnTWlzc2luZyBsaXN0IGtleS4nKTtcblx0XHRcdGlmIChsaXN0VmFsdWUgPT09ICcnKSBlcnJvck1lc3NhZ2UucHVzaCgnRW1wdHkgbGlzdCBlbnRyeS4nKTtcblxuXHRcdFx0aWYgKGVycm9yTWVzc2FnZS5sZW5ndGggPiAwKSB7XG5cdFx0XHRcdHJldHVybiBlcnJvck1lc3NhZ2Uuam9pbignICcpO1xuXHRcdFx0fVxuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdH07XG5cdFx0JGh0bWwuZmluZChhdHRyaWJ1dGVzKS5lYWNoKGZ1bmN0aW9uKCkge1xuXHRcdFx0dmFyICR0aGlzID0gJCh0aGlzKTtcblx0XHRcdHZhciBvcHRpb25zID0gWyctcGxhY2Vob2xkZXInLCAnLXRpdGxlJywgJy1hbHQnLCAnLWFyaWEtbGFiZWwnLCAnLWxhYmVsJywgJyddO1xuXHRcdFx0aWYgKGRvRHluYW1pYykgb3B0aW9ucy5wdXNoKCctZHluYW1pYycpO1xuXG5cdFx0XHQkLmVhY2gob3B0aW9ucywgZnVuY3Rpb24oKSB7XG5cdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0aWYgKHR5cGVvZiAkdGhpcy5hdHRyKCdkYXRhLWkxOG4nICsgdGhpcykgPT09ICd1bmRlZmluZWQnKSByZXR1cm47XG5cblx0XHRcdFx0XHR2YXIgaTE4bkF0dHIgPSB0aGlzICE9PSAnJyA/IHRoaXMuc3Vic3RyKDEpIDogZmFsc2U7XG5cdFx0XHRcdFx0dmFyIGlzRHluYW1pYyA9IChkb0R5bmFtaWMgJiYgaTE4bkF0dHIgPT09ICdkeW5hbWljJyk7XG5cdFx0XHRcdFx0dmFyIGkxOG5LZXkgPSBpc0R5bmFtaWMgPyAkdGhpcy50ZXh0KCkgOiAkdGhpcy5hdHRyKCdkYXRhLWkxOG4nICsgdGhpcyk7XG5cblx0XHRcdFx0XHR2YXIgaTE4blZhcnMgPSAoJHRoaXMuYXR0cignZGF0YS1pMThuLXZhcnMnKSB8fCAnJykuc3BsaXQoJ3wnKTtcblx0XHRcdFx0XHQvLyBpZiBpdCBpcyB0aGUgdGV4dCBvZiBhbiBlbGVtZW50IHdlIGNhbiBoaWdobGlnaHQgdGhlIHRleHQgYXMgYSBtaXNzaW5nIGtleSB3aXRoIHRoZSBleHRyYSBzcGFuIHN0eWxlLCBpZiBpdCdzIGF0dHJpYnV0ZSdzIHRleHQgdGhhdCB3b24ndCB3b3JrXG5cdFx0XHRcdFx0dmFyIGkxOG5FcnJvciA9IChpMThuQXR0ciA/ICdbJyArIGkxOG5LZXkgKyAnXScgOiAnPHNwYW4gc3R5bGU9XCJjb2xvcjogcmVkO1wiPlsnICsgaTE4bktleSArICddPC9zcGFuPicpO1xuXHRcdFx0XHRcdHZhciBpMThuVGV4dCA9IGkxOG4oaTE4bktleSwgaTE4bkVycm9yKTtcblxuXHRcdFx0XHRcdGkxOG5PdXRwdXRKU09OW2kxOG5LZXldID0gKGkxOG5BdHRyID8gJHRoaXMuYXR0cihpMThuQXR0cikgOiAkdGhpcy5odG1sKCkpO1xuXHRcdFx0XHRcdGkxOG5UZXh0ID0gKGkxOG5WYXJzLmxlbmd0aCA9PT0gMCA/IGkxOG5UZXh0IDogaTE4blRleHQucmVwbGFjZSgve3soWzAtOV0rKX19L2csIGZ1bmN0aW9uKHgsICQxKSB7XG5cdFx0XHRcdFx0XHQvLyBpZiB0aGUgdmFyIGlzIG5vdCBkZWZpbmVkLCBrZWVwIHRoZSBtYXRjaCBhcy1pcy4gU28gaXQgc3RheXMgb3V0IG9mIHRoZSB3YXkgb2Ygcm9sbCB0ZW1wbGF0ZXMgYXMgbXVjaCBhcyBwb3NzaWJsZS5cblx0XHRcdFx0XHRcdHJldHVybiBpMThuVmFyc1skMV0gPyBpMThuVmFyc1skMV0gOiAne3snICsgJDEgKyAnfX0nO1xuXHRcdFx0XHRcdH0pKTtcblxuXHRcdFx0XHRcdGlmICghaTE4bkF0dHIgfHwgaXNEeW5hbWljKSB7XG5cdFx0XHRcdFx0XHQkdGhpcy5odG1sKGkxOG5UZXh0KTtcblx0XHRcdFx0XHRcdC8vIFlvdSBjYW5ub3QgaGF2ZSBib3RoIGRhdGEtaTE4biBhbmQgZGF0YS1pMThuLWR5bmFtaWMsIHRoZXkgYXJlIGF0IHRoZSBlbmQgb2YgdGhlIGxpc3QsIGlmIGVpdGhlciBvbmUgcnVucyB3ZSBicmVhayBvdXQgb2YgdGhlIGxvb3Bcblx0XHRcdFx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZSB7XG5cdFx0XHRcdFx0XHQkdGhpcy5hdHRyKGkxOG5BdHRyLCBpMThuVGV4dCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHRcdGNhdGNoIChlKSB7XG5cdFx0XHRcdFx0Y29uc29sZS5sb2coJ1RyYW5zbGF0aW9uIEVycm9yOicsIGUpO1xuXHRcdFx0XHRcdGNvbnNvbGUubG9nKCR0aGlzKTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0fSk7XG5cdFx0JGh0bWwuZmluZCgnW2RhdGEtaTE4bi1saXN0XScpLmVhY2goZnVuY3Rpb24oKSB7XG5cdFx0XHR2YXIgJHRoaXMgPSAkKHRoaXMpO1xuXHRcdFx0dmFyIGkxOG5LZXkgPSAkdGhpcy5hdHRyKCdkYXRhLWkxOG4tbGlzdCcpO1xuXHRcdFx0dmFyIGxpc3RWYWx1ZSA9IGkxOG4oaTE4bktleSwgJ2Vycm9yJyk7XG5cdFx0XHR2YXIgbGlzdEVycm9yID0gbGlzdFZhbGlkYXRvcihsaXN0VmFsdWUpO1xuXG5cdFx0XHRpZiAobGlzdEVycm9yKSB7XG5cdFx0XHRcdCR0aGlzLmF0dHIoJ2RhdGEtaTE4bi1lcnJvcicsIGxpc3RFcnJvcik7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblxuXHRcdFx0dmFyIG5ld0xpc3RPcmRlciA9ICQubWFwKGxpc3RWYWx1ZS5zcGxpdCgnLCcpLCBmdW5jdGlvbihudW1iZXIpIHtcblx0XHRcdFx0cmV0dXJuICQudHJpbShudW1iZXIpO1xuXHRcdFx0fSk7XG5cdFx0XHR2YXIgbGlzdE1heCA9ICR0aGlzLmZpbmQoJ1tkYXRhLWkxOG4tbGlzdC1pdGVtXScpLmxlbmd0aDtcblx0XHRcdHZhciAkbmV3TGlzdCA9ICR0aGlzLmNsb25lKCk7XG5cdFx0XHR2YXIgbGlzdEVycm9yID0gZmFsc2U7XG5cblx0XHRcdGlmICgkdGhpcy5maW5kKCdbZGF0YS1pMThuLWxpc3QtaXRlbS1udW1dJykubGVuZ3RoID4gMCkge1xuXHRcdFx0XHQkLmVhY2gobmV3TGlzdE9yZGVyLCBmdW5jdGlvbihrZXksIG51bWJlcikge1xuXHRcdFx0XHRcdGlmICgkdGhpcy5maW5kKCdbZGF0YS1pMThuLWxpc3QtaXRlbT1cIicgKyBuZXdMaXN0T3JkZXJba2V5XSArICdcIl0nKS5sZW5ndGggPT09IDApIHtcblx0XHRcdFx0XHRcdCR0aGlzLmF0dHIoJ2RhdGEtaTE4bi1lcnJvcicsICdMaXN0IGRvZXMgbm90IGNvbnRhaW4gdGhlIGtleTogJyArIG5ld0xpc3RPcmRlcltrZXldICsgJy4nKTtcblx0XHRcdFx0XHRcdGxpc3RFcnJvciA9IHRydWU7XG5cdFx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdCRuZXdMaXN0LmZpbmQoJ1tkYXRhLWkxOG4tbGlzdC1pdGVtLW51bT1cIicgKyAoa2V5ICsgMSkgKyAnXCJdJykucmVwbGFjZVdpdGgoJHRoaXMuZmluZCgnW2RhdGEtaTE4bi1saXN0LWl0ZW09XCInICsgbnVtYmVyICsgJ1wiXScpLmNsb25lKCkucmVtb3ZlQXR0cignZGF0YS1pMThuLWxpc3QtaXRlbS1udW0nKSk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXHRcdFx0ZWxzZSB7XG5cdFx0XHRcdCRuZXdMaXN0LmZpbmQoJ1tkYXRhLWkxOG4tbGlzdC1pdGVtXScpLmVhY2goZnVuY3Rpb24oa2V5KSB7XG5cdFx0XHRcdFx0aWYgKCR0aGlzLmZpbmQoJ1tkYXRhLWkxOG4tbGlzdC1pdGVtPVwiJyArIG5ld0xpc3RPcmRlcltrZXldICsgJ1wiXScpLmxlbmd0aCA9PT0gMCkge1xuXHRcdFx0XHRcdFx0JHRoaXMuYXR0cignZGF0YS1pMThuLWVycm9yJywgJ0xpc3QgZG9lcyBub3QgY29udGFpbiB0aGUga2V5OiAnICsgbmV3TGlzdE9yZGVyW2tleV0gKyAnLicpO1xuXHRcdFx0XHRcdFx0bGlzdEVycm9yID0gdHJ1ZTtcblx0XHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0JCh0aGlzKS5yZXBsYWNlV2l0aCgkdGhpcy5maW5kKCdbZGF0YS1pMThuLWxpc3QtaXRlbT1cIicgKyBuZXdMaXN0T3JkZXJba2V5XSArICdcIl0nKS5jbG9uZSgpLnJlbW92ZUF0dHIoJ2RhdGEtaTE4bi1saXN0LWl0ZW0nKSk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXHRcdFx0aWYgKCFsaXN0RXJyb3IpIHtcblx0XHRcdFx0JHRoaXMucmVwbGFjZVdpdGgoJG5ld0xpc3QpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHRcdHdpbmRvdy5pMThuT3V0cHV0ID0gSlNPTi5zdHJpbmdpZnkoaTE4bk91dHB1dEpTT04pO1xuXHRcdHN3aXRjaCAocmV0dXJuVHlwZSkge1xuXHRcdFx0Y2FzZSAnc3RyaW5nJzpcblx0XHRcdFx0cmV0dXJuICRodG1sLnByb3AoJ291dGVySFRNTCcpO1xuXHRcdFx0Y2FzZSAnaHRtbCc6XG5cdFx0XHRcdHJldHVybiAkaHRtbFswXTtcblx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdHJldHVybiAkaHRtbDtcblx0XHR9XG5cdH07XG5cblx0ZDIwLnV0aWxzLmhhbmRsZVVSTCA9IGZ1bmN0aW9uKGUpIHtcblx0XHRpZiAoJCh0aGlzKS5oYXNDbGFzcyhcImxpZ2h0bHlcIikpIHJldHVybjtcblxuXHRcdGlmICgkKHRoaXMpLnBhcmVudHMoXCIubm90ZS1lZGl0YWJsZVwiKS5sZW5ndGggPiAwKSByZXR1cm47XG5cblx0XHR2YXIgdXJsID0gJCh0aGlzKS5hdHRyKFwiaHJlZlwiKTtcblx0XHRpZiAodHlwZW9mIHVybCA9PT0gXCJ1bmRlZmluZWRcIikgcmV0dXJuIGZhbHNlO1xuXG5cdFx0aWYgKHVybC5pbmRleE9mKFwiam91cm5hbC5yb2xsMjAubmV0XCIpICE9PSAtMSB8fCB1cmwuaW5kZXhPZihcIndpa2kucm9sbDIwLm5ldFwiKSAhPT0gLTEpIHtcblx0XHRcdHZhciB0eXBlID0gdXJsLnNwbGl0KFwiL1wiKVszXTtcblx0XHRcdHZhciBpZCA9IHVybC5zcGxpdChcIi9cIilbNF07XG5cdFx0XHR2YXIgaXRlbSA9IGQyMC5DYW1wYWlnblt0eXBlICsgXCJzXCJdLmdldChpZCk7XG5cdFx0XHRpZiAoaXRlbSkge1xuXHRcdFx0XHR2YXIgaW5qb3VybmFscyA9IGl0ZW0uZ2V0KFwiaW5wbGF5ZXJqb3VybmFsc1wiKS5zcGxpdChcIixcIik7XG5cdFx0XHRcdGlmICh3aW5kb3cuaXNfZ20gfHwgXy5pbmRleE9mKGluam91cm5hbHMsIFwiYWxsXCIpICE9PSAtMSB8fCAod2luZG93LmN1cnJlbnRQbGF5ZXIgJiYgXy5pbmRleE9mKGluam91cm5hbHMsIHdpbmRvdy5jdXJyZW50UGxheWVyLmlkKSAhPT0gLTEpKSB7XG5cdFx0XHRcdFx0aWYgKHR5cGUgPT0gXCJjaGFyYWN0ZXJcIiAmJiBpdGVtLmF0dHJpYnMgJiYgaXRlbS5hYmlsaXRpZXMpIHtcblx0XHRcdFx0XHRcdGNvbnN0IGNoYXJvYmogPSBpdGVtO1xuXHRcdFx0XHRcdFx0Y29uc3QgY2hhckF0dHJpYlByb21pc2VzID0gW107XG5cdFx0XHRcdFx0XHRpZiAoIWNoYXJvYmo/LmF0dHJpYnM/LmJhY2tib25lRmlyZWJhc2UpIHtcblx0XHRcdFx0XHRcdFx0Y2hhcm9iai5hdHRyaWJzLmJhY2tib25lRmlyZWJhc2UgPSBuZXcgQmFja2JvbmVGaXJlYmFzZShjaGFyb2JqLmF0dHJpYnMpO1xuXHRcdFx0XHRcdFx0XHRjaGFyQXR0cmliUHJvbWlzZXMucHVzaChjaGFyb2JqLmF0dHJpYnMuYmFja2JvbmVGaXJlYmFzZS5yZWZlcmVuY2Uub25jZSgndmFsdWUnKSk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRpZiAoIWNoYXJvYmo/LmFiaWxpdGllcz8uYmFja2JvbmVGaXJlYmFzZSkge1xuXHRcdFx0XHRcdFx0XHRjaGFyb2JqLmFiaWxpdGllcy5iYWNrYm9uZUZpcmViYXNlID0gbmV3IEJhY2tib25lRmlyZWJhc2UoY2hhcm9iai5hYmlsaXRpZXMpO1xuXHRcdFx0XHRcdFx0XHRjaGFyQXR0cmliUHJvbWlzZXMucHVzaChjaGFyb2JqLmFiaWxpdGllcy5iYWNrYm9uZUZpcmViYXNlLnJlZmVyZW5jZS5vbmNlKCd2YWx1ZScpKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFByb21pc2UuYWxsKGNoYXJBdHRyaWJQcm9taXNlcykudGhlbigoKSA9PiB7XG5cdFx0XHRcdFx0XHRcdGl0ZW0udmlldy5zaG93RGlhbG9nKCk7XG5cdFx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRpdGVtLnZpZXcuc2hvd0RpYWxvZygpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdFx0JChcIiNleGlzdGluZ1wiICsgdHlwZSArIFwic1wiKS5maW5kKFwidHJbZGF0YS1cIiArIHR5cGUgKyBcImlkPVwiICsgaWQgKyBcIl1cIikudHJpZ2dlcihcImNsaWNrXCIpO1xuXG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0fVxuXG5cdFx0dmFyIGNvbXBlbmRpdW1VUkxSZWdleCA9IC8oPzooPzpodHRwKD86cz8pOlxcL1xcLyg/OmFwcFxcLik/cm9sbDIwKD86c3RhZ2luZyk/XFwuKD86bmV0fGxvY2FsOjUwMDApXFwvfF5cXC8/KWNvbXBlbmRpdW1cXC8pKFteXFwvXSspXFwvKFteXFwvIz9dKykvaVxuXHRcdHZhciBjb21wZW5kaXVtTWF0Y2ggPSB1cmwubWF0Y2goY29tcGVuZGl1bVVSTFJlZ2V4KTtcblxuXHRcdGlmIChjb21wZW5kaXVtTWF0Y2gpIHtcblx0XHRcdGQyMC51dGlscy5vcGVuQ29tcGVuZGl1bVBhZ2UoY29tcGVuZGl1bU1hdGNoWzFdLCBjb21wZW5kaXVtTWF0Y2hbMl0pO1xuXG5cdFx0XHRlLnN0b3BQcm9wYWdhdGlvbigpO1xuXHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGlmICh1cmwuaW5kZXhPZihcImphdmFzY3JpcHQ6XCIpICE9PSAtMSkge1xuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdH1cblxuXHRcdC8vQWxsb3cgdXMgdG8gbGluayB0byBBUEkgY29tbWFuZHMgaW4gdGhlIGZvcm1hdCBbQnV0dG9uIFRleHRdKCFjb21tYW5kKVxuXHRcdGlmICh1cmwuc3Vic3RyaW5nKDAsIDEpID09PSBcImBcIikge1xuXHRcdFx0ZDIwLnRleHRjaGF0LmRvQ2hhdElucHV0KHVybC5zdWJzdHJpbmcoMSksICdsaW5rX2NsaWNrJyk7XG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0fVxuXHRcdGlmICh1cmwuc3Vic3RyaW5nKDAsIDEpID09PSBcIiFcIikge1xuXHRcdFx0Ly9BUEkgY29tbWFuZC5cblx0XHRcdGQyMC50ZXh0Y2hhdC5kb0NoYXRJbnB1dCh1cmwsICdhcGlfbGlua19jbGljaycpO1xuXHRcdFx0Ly92YXIgb2xkdGV4dCA9ICQodGhpcykudGV4dCgpO1xuXHRcdFx0Ly92YXIgJG90aGlzID0gJCh0aGlzKTtcblx0XHRcdC8vJCh0aGlzKS50ZXh0KFwiRXhlY3V0ZWQ6IFwiICsgdXJsKTtcblx0XHRcdC8vc2V0VGltZW91dChmdW5jdGlvbigpIHtcblx0XHRcdC8vICAkb3RoaXMudGV4dChvbGR0ZXh0KTtcblx0XHRcdC8vfSwgMTAwMCk7XG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0fVxuXG5cdFx0aWYgKHVybC5zdWJzdHJpbmcoMCwgMSkgPT09IFwiflwiKSB7XG5cdFx0XHRkMjAudGV4dGNoYXQuZG9DaGF0SW5wdXQoXCIle1wiICsgdXJsLnN1YnN0cmluZygxLCB1cmwubGVuZ3RoKSArIFwifVwiLCAnbGlua19jbGljaycpO1xuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdH1cblxuXHRcdGlmICh1cmwgPT09IHVuZGVmaW5lZCB8fCAkKHRoaXMpLmF0dHIoXCJyZWxcIikgIT09IFwiZXh0ZXJuYWxcIiAmJiAodXJsLmluZGV4T2YoXCJqYXZhc2NyaXB0OlwiKSAhPT0gLTEgfHwgdXJsLmluZGV4T2YoXCI6Ly9cIikgPT09IC0xKSkge1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGUuc3RvcFByb3BhZ2F0aW9uKCk7XG5cdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG5cdFx0dmFyIGRpYWxvZyA9ICQoJzxkaXYgY2xhc3M9XCJkaWFsb2cgZGlhbG9nLWRhbmdlclwiPicgKyB1cmwgKyAnPGJyIC8+PGJyIC8+VGhpcyBsaW5rIHdpbGwgb3BlbiB1cCBhIG5ldyB3aW5kb3cgKG9yIHRhYikgdG8gYW4gZXh0ZXJuYWwgc2l0ZS4gSnVzdCBjbG9zZSB0aGUgbmV3IHdpbmRvdy90YWIgdG8gcmV0dXJuIHRvIHRoZSBlZGl0b3IuPC9kaXY+Jyk7XG5cdFx0ZGlhbG9nLmRpYWxvZyh7XG5cdFx0XHRtb2RhbDogdHJ1ZSxcblx0XHRcdHRpdGxlOiBcIkNvbmZpcm0gRXh0ZXJuYWwgTGlua1wiLFxuXHRcdFx0YnV0dG9uczoge1xuXHRcdFx0XHRcIkNvbnRpbnVlXCI6IGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRcdCQodGhpcykuZGlhbG9nKFwiZGVzdHJveVwiKS5yZW1vdmUoKTtcblx0XHRcdFx0XHR3aW5kb3cub3Blbih1cmwpO1xuXHRcdFx0XHR9LFxuXHRcdFx0XHRcIkNhbmNlbFwiOiBmdW5jdGlvbigpIHtcblx0XHRcdFx0XHQkKHRoaXMpLmRpYWxvZyhcImRlc3Ryb3lcIikucmVtb3ZlKCk7XG5cdFx0XHRcdH1cblx0XHRcdH0sXG5cdFx0XHRiZWZvcmVDbG9zZTogZnVuY3Rpb24oKSB7XG5cdFx0XHRcdCQodGhpcykuZGlhbG9nKFwiZGVzdHJveVwiKS5yZW1vdmUoKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fTtcblxuXHRkMjAudXRpbHMub3BlbkNvbXBlbmRpdW1QYWdlID0gZnVuY3Rpb24oY29tcGVuZGl1bUJvb2tOYW1lLCBjb21wZW5kaXVtUGFnZU5hbWUsIGNvbXBlbmRpdW1QYWdlVW5pcXVlTmFtZSkge1xuXHRcdGlmICh0eXBlb2YgY29tcGVuZGl1bVBhZ2VVbmlxdWVOYW1lID09PSBcInVuZGVmaW5lZFwiKSBjb21wZW5kaXVtUGFnZVVuaXF1ZU5hbWUgPSBudWxsO1xuXHRcdHZhciBhZGRyZXNzTmFtZSA9IGNvbXBlbmRpdW1QYWdlTmFtZTtcblx0XHR2YXIgYW5jaG9yTmFtZSA9IFwiXCI7XG5cdFx0aWYoY29tcGVuZGl1bVBhZ2VVbmlxdWVOYW1lKSB7XG5cdFx0XHR2YXIgc3BsaXQgPSBjb21wZW5kaXVtUGFnZVVuaXF1ZU5hbWUuc3BsaXQoXCIjXCIpO1xuXHRcdFx0YWRkcmVzc05hbWUgPSBzcGxpdFswXTtcblx0XHRcdGFuY2hvck5hbWUgPSBzcGxpdFsxXSA/IFwiI1wiICsgc3BsaXRbMV0gOiBcIlwiO1xuXHRcdH1cblx0XHR2YXIgbWF4d2lkdGggPSA3NTA7XG5cdFx0dmFyIG1heGhlaWdodCA9IDgwMDtcblx0XHR2YXIgbWluaGVpZ2h0ID0gJCh3aW5kb3cpLmhlaWdodCgpIC0gMTAwO1xuXHRcdGlmIChtaW5oZWlnaHQgPiBtYXhoZWlnaHQpIHtcblx0XHRcdG1pbmhlaWdodCA9IG1heGhlaWdodDtcblx0XHR9XG5cdFx0dmFyIG1pbndpZHRoID0gJCh3aW5kb3cpLndpZHRoKCkgLSA1MDtcblx0XHRpZiAobWlud2lkdGggPiBtYXh3aWR0aCkge1xuXHRcdFx0bWlud2lkdGggPSBtYXh3aWR0aDtcblx0XHR9XG5cdFx0dmFyICR0ZW1wZGlhbG9nID0gJChcIjxkaXYgY2xhc3M9J2NvbXBlbmRpdW1wb3B1cCc+PGlmcmFtZSBzcmM9XFxcIlwiICsgZDIwLmNvbXBlbmRpdW0uY29tcGVuZGl1bUJhc2UgKyBcImNvbXBlbmRpdW0vXCIgKyBjb21wZW5kaXVtQm9va05hbWUgKyBcIi9cIiArIGFkZHJlc3NOYW1lICsgXCI/c2hhcmVkQ29tcGVuZGl1bT1cIiArIGNhbXBhaWduX2lkICsgYW5jaG9yTmFtZSArIFwiXFxcIiBzdHlsZT0nd2lkdGg6IDEwMCU7IGhlaWdodDogY2FsYygxMDAlIC0gNXB4KTsnIGZyYW1lYm9yZGVyPScwJz48L2lmcmFtZT48L2Rpdj5cIik7XG5cdFx0JHRlbXBkaWFsb2cuZGlhbG9nKHtcblx0XHRcdG1vZGFsOiBmYWxzZSxcblx0XHRcdHRpdGxlOiBcIjxidXR0b24gY2xhc3M9J3Nob3dwb3BvdXQgYnRuIHBpY3Rvcycgc3R5bGU9J21hcmdpbi1yaWdodDogMTVweDsnPnw8L2J1dHRvbj5cIiArIGNvbXBlbmRpdW1QYWdlTmFtZS5zcGxpdChcIjpcIilbMF0sXG5cdFx0XHRiZWZvcmVDbG9zZTogZnVuY3Rpb24oKSB7XG5cdFx0XHRcdCR0ZW1wZGlhbG9nLmRpYWxvZyhcImRlc3Ryb3lcIikucmVtb3ZlKCk7XG5cdFx0XHR9LFxuXHRcdFx0d2lkdGg6IG1pbndpZHRoICsgNDAsXG5cdFx0XHRoZWlnaHQ6IG1pbmhlaWdodCxcblx0XHRcdHpJbmRleDogMTEwMDBcblx0XHR9KTtcblxuXHRcdHZhciBzaG93Q29tcGVuZGl1bVBvcG91dCA9IGZ1bmN0aW9uKCkge1xuXHRcdFx0dmFyICRwcmV2ZGlhbG9nID0gJHRlbXBkaWFsb2c7XG5cdFx0XHR2YXIgd2lud2lkdGggPSA5MDA7XG5cdFx0XHR2YXIgd2luaGVpZ2h0ID0gNzUwO1xuXG5cdFx0XHR3aW53aWR0aCA9ICRwcmV2ZGlhbG9nLndpZHRoKCk7XG5cdFx0XHR3aW5oZWlnaHQgPSAkcHJldmRpYWxvZy5oZWlnaHQoKTtcblx0XHRcdCRwcmV2ZGlhbG9nLmRpYWxvZyhcImNsb3NlXCIpOyAvL3RoaXMgd2lsbCB0b3RhbGx5IHJlbW92ZSB0aGUgcHJldmlvdXMgaW5mcmFtZSBhbmQgZXZlcnl0aGluZywgYnV0IHdlIGNhbiBzdGlsbCByZS1hcHBlbmQgaXQgYXMgbG9uZyBhcyB3ZSBoYXZlIGEgcmVmZXJlbmNlIHRvIGl0XG5cblx0XHRcdHZhciBjb21wZW5kaXVtQ2hpbGRXaW5kb3cgPSB3aW5kb3cub3BlbihcIi9lZGl0b3IvcG9wb3V0XCIsIFwiUG9wb3V0XCIgKyAoY29tcGVuZGl1bVBhZ2VVbmlxdWVOYW1lIHx8IGNvbXBlbmRpdW1QYWdlTmFtZSksIFwibWVudWJhcj0wLGxvY2F0aW9uPTAsdG9vbGJhcj0wLHN0YXR1cz0wLHNjcm9sbGJhcnM9MSx3aWR0aD1cIiArIHdpbndpZHRoICsgXCIsaGVpZ2h0PVwiICsgd2luaGVpZ2h0KTtcblx0XHRcdHdpbmRvdy5hbGxDaGlsZFdpbmRvd3MucHVzaChjb21wZW5kaXVtQ2hpbGRXaW5kb3cpO1xuXG5cdFx0XHRjb21wZW5kaXVtQ2hpbGRXaW5kb3cub25sb2FkID0gZnVuY3Rpb24oKSB7XG5cdFx0XHRcdCRwcmV2ZGlhbG9nLmFwcGVuZFRvKGNvbXBlbmRpdW1DaGlsZFdpbmRvdy5kb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImNvbnRhaW5lcmRpdlwiKSk7XG5cdFx0XHRcdCRwcmV2ZGlhbG9nLnNob3coKTtcblx0XHRcdFx0Y29tcGVuZGl1bUNoaWxkV2luZG93LmRvY3VtZW50LnRpdGxlID0gY29tcGVuZGl1bVBhZ2VOYW1lO1xuXHRcdFx0fVxuXHRcdFx0Y29tcGVuZGl1bUNoaWxkV2luZG93Lm9uYmVmb3JldW5sb2FkID0gZnVuY3Rpb24oKSB7XG5cdFx0XHRcdHdpbmRvdy5hbGxDaGlsZFdpbmRvd3MgPSBfLndpdGhvdXQod2luZG93LmFsbENoaWxkV2luZG93cywgb3RoaXMuY2hpbGRXaW5kb3cpXG5cdFx0XHRcdGNvbXBlbmRpdW1DaGlsZFdpbmRvdyA9IG51bGw7XG5cdFx0XHRcdCRwcmV2ZGlhbG9nLmh0bWwoXCJcIik7XG5cdFx0XHRcdCRwcmV2ZGlhbG9nID0gbnVsbDtcblx0XHRcdH07XG5cdFx0fVxuXG5cdFx0JHRlbXBkaWFsb2cucGFyZW50KCkub24oXCJjbGlja1wiLCBcIi5zaG93cG9wb3V0XCIsIGZ1bmN0aW9uKCkge1xuXHRcdFx0c2hvd0NvbXBlbmRpdW1Qb3BvdXQoKTtcblx0XHR9KTtcblx0fTtcblxuXHRkMjAudXRpbHMucGxheWVyWm9uZUhlaWdodCA9IGZ1bmN0aW9uKCkge1xuXHRcdHZhciBpbml0aWFsID0gJChcIiNwbGF5ZXJ6b25lIC5wbGF5ZXJcIikuaGVpZ2h0KCkgKyA2NTtcblx0XHRpZiAoJChcIiNtYWNyb2JhclwiKS5pcyhcIjp2aXNpYmxlXCIpKSB7XG5cdFx0XHRpbml0aWFsICs9ICQoXCIjbWFjcm9iYXJcIikuaGVpZ2h0KCk7XG5cdFx0fVxuXHRcdHJldHVybiBpbml0aWFsO1xuXHR9O1xuXG5cdGQyMC51dGlscy5hZGRJbWFnZVByb3h5ID0gKHVybCkgPT4ge1xuXHRcdGNvbnN0IG1hdGNoID0gdXJsLnRvU3RyaW5nKCk7XG5cdFx0Y29uc3Qgbm9wcm94eSA9IFsnaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pbycsICdodHRwOi8vaW1nc3J2LnJvbGwyMC5uZXQnLCAnaHR0cHM6Ly9pbWdzcnYucm9sbDIwLm5ldCcsIGltZ3Nydl91cmwsICdodHRwczovL2FwcC5yb2xsMjAubmV0JywgJ2h0dHBzOi8vc3RvcmFnZS5nb29nbGVhcGlzLmNvbS9jaGFyLXNoZWV0LWFwcC1pbWFnZXMtNmUxMDE0MTEnXTtcblxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgbm9wcm94eS5sZW5ndGg7IGkrKykge1xuXHRcdFx0aWYgKG1hdGNoLnN1YnN0cmluZygwLCBub3Byb3h5W2ldLmxlbmd0aCkgPT09IG5vcHJveHlbaV0pIHtcblx0XHRcdFx0cmV0dXJuIG1hdGNoO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGlmICgvXmh0dHBzPzpcXC9cXC8vLnRlc3QobWF0Y2gpKSB7XG5cdFx0XHRyZXR1cm4gYCR7aW1nc3J2X3VybH0/c3JjPSR7ZXNjYXBlKG1hdGNoKX1gO1xuXHRcdH1cblxuXHRcdHJldHVybiAnJztcblx0fTtcblxuXHRkMjAudXRpbHMuc3RyaXBfdGFncyA9IGZ1bmN0aW9uKGlucHV0LCBhbGxvd2VkLCBpZ25vcmVhZHZhbmNlZCkge1xuXHRcdC8vIFN0cmlwcyBIVE1MIGFuZCBQSFAgdGFncyBmcm9tIGEgc3RyaW5nXG5cdFx0aWYgKCFpZ25vcmVhZHZhbmNlZCAmJiBhbGxvd2VkICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdGlucHV0ID0gaHRtbF9zYW5pdGl6ZShcblx0XHRcdFx0aW5wdXQsXG5cdFx0XHRcdGZ1bmN0aW9uKHVybCwgb2JqaW5kZXgsIG9ianNlY29uZGluZHgsIG9iamluZm8pIHtcblx0XHRcdFx0XHR2YXIgbWF0Y2ggPSB1cmwudG9TdHJpbmcoKTtcblxuXHRcdFx0XHRcdGlmIChvYmppbmZvICYmIG9iamluZm8uWE1MX1RBRyA9PT0gXCJhXCIpIHtcblx0XHRcdFx0XHRcdHJldHVybiBtYXRjaDtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRjb25zdCBub3Byb3h5ID0gW1wiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pb1wiLCBcImh0dHA6Ly9pbWdzcnYucm9sbDIwLm5ldFwiLCBcImh0dHBzOi8vaW1nc3J2LnJvbGwyMC5uZXRcIiwgaW1nc3J2X3VybCwgXCJodHRwczovL2FwcC5yb2xsMjAubmV0XCIsIFwiaHR0cHM6Ly9zdG9yYWdlLmdvb2dsZWFwaXMuY29tL2NoYXItc2hlZXQtYXBwLWltYWdlcy02ZTEwMTQxMVwiXTtcblxuXHRcdFx0XHRcdGZvcihsZXQgaT0wOyBpPG5vcHJveHkubGVuZ3RoOyBpKyspe1xuXHRcdFx0XHRcdFx0aWYobWF0Y2guc3Vic3RyaW5nKDAsIG5vcHJveHlbaV0ubGVuZ3RoKSA9PT0gbm9wcm94eVtpXSkge1xuXHRcdFx0XHRcdFx0XHRyZXR1cm4gbWF0Y2g7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fTtcblx0XHRcdFx0XHRpZiAoL15odHRwcz86XFwvXFwvLy50ZXN0KG1hdGNoKSkge1xuXHRcdFx0XHRcdFx0cmV0dXJuIGltZ3Nydl91cmwgKyBcIi8/c3JjPVwiICsgZXNjYXBlKG1hdGNoKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZSB7XG5cdFx0XHRcdFx0XHRyZXR1cm4gXCJcIjtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0sXG5cdFx0XHRcdGZ1bmN0aW9uKGdyb3VwaWQpIHtcblx0XHRcdFx0XHR2YXIgY2xhc3NlcyA9IGdyb3VwaWQuc3BsaXQoXCIgXCIpO1xuXHRcdFx0XHRcdF8uZWFjaChjbGFzc2VzLCBmdW5jdGlvbihpZCwgaWR4KSB7XG5cdFx0XHRcdFx0XHRpZiAoaWQuc3Vic3RyaW5nKDAsIDExKSA9PT0gXCJ1c2Vyc2NyaXB0LVwiIHx8IGlkLnN1YnN0cmluZygwLCA2KSA9PT0gXCJzaGVldC1cIikge1xuXHRcdFx0XHRcdFx0XHRjbGFzc2VzW2lkeF0gPSBpZDtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRjbGFzc2VzW2lkeF0gPSBcInVzZXJzY3JpcHQtXCIgKyBpZDtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRyZXR1cm4gY2xhc3Nlcy5qb2luKFwiIFwiKTtcblx0XHRcdFx0fVxuXHRcdFx0KTtcblx0XHRcdC8vaW5wdXQgPSBodG1sX3Nhbml0aXplKGlucHV0LCBmdW5jdGlvbiB1cmxYKHVybCkgeyBpZigvXmh0dHBzPzpcXC9cXC8vLnRlc3QodXJsKSkgeyByZXR1cm4gdXJsIH0gfSwgZnVuY3Rpb24gaWRYKGlkKSB7IHJldHVybiBcInVzZXJzY3JpcHQtXCIgKyBpZCB9KTtcblx0XHR9XG5cdFx0YWxsb3dlZCA9ICgoKGFsbG93ZWQgfHwgXCJcIikgKyBcIlwiKS50b0xvd2VyQ2FzZSgpLm1hdGNoKC88W2Etel1bYS16MC05XSo+L2cpIHx8IFtdKS5qb2luKCcnKTsgLy8gbWFraW5nIHN1cmUgdGhlIGFsbG93ZWQgYXJnIGlzIGEgc3RyaW5nIGNvbnRhaW5pbmcgb25seSB0YWdzIGluIGxvd2VyY2FzZSAoPGE+PGI+PGM+KVxuXHRcdHZhciB0YWdzID0gLzxcXC8/KFthLXpdW2EtejAtOV0qKVxcYltePl0qPi9naSxcblx0XHRcdGNvbW1lbnRzQW5kUGhwVGFncyA9IC88IS0tW1xcc1xcU10qPy0tPnw8XFw/KD86cGhwKT9bXFxzXFxTXSo/XFw/Pi9naTtcblx0XHRyZXR1cm4gaW5wdXQucmVwbGFjZShjb21tZW50c0FuZFBocFRhZ3MsICcnKS5yZXBsYWNlKHRhZ3MsIGZ1bmN0aW9uKCQwLCAkMSkge1xuXHRcdFx0cmV0dXJuIGFsbG93ZWQuaW5kZXhPZignPCcgKyAkMS50b0xvd2VyQ2FzZSgpICsgJz4nKSA+IC0xID8gJDAgOiAnJztcblx0XHR9KTtcblx0XHQvL3JldHVybiBpbnB1dDtcblx0fTtcblxuXHRkMjAudXRpbHMudGltZW91dCA9IChtcykgPT4ge1xuXHRcdHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTtcblx0fTtcblxuXHRkMjAudXRpbHMuaTE4biA9IChrZXkpID0+IHtcblx0XHRyZXR1cm4gaTE4bihrZXkpO1xuXHR9O1xuXG5cdGQyMC51dGlscy5odG1sQWxsb3dlZCA9IFwiPGNvZGU+PHNwYW4+PGRpdj48bGFiZWw+PGE+PGJyPjxiciAvPjxwPjxiPjxpPjxkZWw+PHN0cmlrZT48dT48aW1nPjx2aWRlbz48YXVkaW8+PHBhcmFtPjxibG9ja3F1b3RlPjxtYXJrPjxjaXRlPjxzbWFsbD48dWw+PG9sPjxsaT48aHI+PGRsPjxkdD48ZGQ+PHN1cD48c3ViPjxiaWc+PHByZT48Y29kZT48ZmlndXJlPjxmaWdjYXB0aW9uPjxzdHJvbmc+PGVtPjx0YWJsZT48dHI+PHRkPjx0aD48dGJvZHk+PHRoZWFkPjx0Zm9vdD48Y2FwdGlvbj48aDE+PGgyPjxoMz48aDQ+PGg1PjxoNj5cIjtcblxuXHRkMjAudXRpbHMuaGFuZGxlSFRNTElucHV0ID0gZnVuY3Rpb24oaW5wdXQpIHtcblx0XHRyZXR1cm4gZXNjYXBlKGQyMC51dGlscy5zdHJpcF90YWdzKGQyMC51dGlscy5hdXRvTGluayhpbnB1dCksIGQyMC51dGlscy5odG1sQWxsb3dlZCkpO1xuXHR9O1xuXG5cdGQyMC51dGlscy5oYW5kbGVIVE1MT3V0cHV0ID0gZnVuY3Rpb24oaW5wdXQsIGF1dG9saW5rKSB7XG5cdFx0cmV0dXJuIGQyMC51dGlscy5zdHJpcF90YWdzKHVuZXNjYXBlKGlucHV0KSwgZDIwLnV0aWxzLmh0bWxBbGxvd2VkKTtcblx0fTtcblxuXHRkMjAudXRpbHMuc2hvd092ZXJRdW90YSA9IGZ1bmN0aW9uKCkge1xuXHRcdHZhciAkZGlhbG9nID0gJChcIjxkaXY+PHA+V2UncmUgc29ycnksIGJ1dCBpdCBsb29rcyBsaWtlIHlvdSd2ZSB1cGxvYWRlZCBtb3JlIHRoYW4geW91ciBhbGxvdHRlZCBxdW90YSBvZiBzdG9yYWdlIHNwYWNlIG9uIFJvbGwyMC4gWW91IGNhbiBpbmNyZWFzZSB5b3VyIHF1b3RhIGJ5IDxhIGhyZWY9Jy9hY2NvdW50L3N1cHBvcnRlci8/cXVvdGFpbmFwcCcgdGFyZ2V0PSdfYmxhbmsnPmJlY29taW5nIGEgUGx1cyB1c2VyPC9hPiAob3IgdXBncmFkaW5nIHlvdXIgUGx1cyBhY2NvdW50IGlmIHlvdSBhbHJlYWR5IGhhdmUgb25lKSwgb3IgYnkgPGEgaHJlZj0naHR0cDovL2hlbHAucm9sbDIwLm5ldC9zaWRlYmFyLWFydC1saWJyYXJ5LycgdGFyZ2V0PSdfYmxhbmsnPmRlbGV0aW5nIGl0ZW1zIGZyb20geW91ciBBcnQgTGlicmFyeTwvYT4uPC9kaXY+XCIpO1xuXHRcdCRkaWFsb2cuZGlhbG9nKHtcblx0XHRcdG1vZGFsOiB0cnVlLFxuXHRcdFx0dGl0bGU6IFwiUXVvdGEgRXhjZWVkZWRcIixcblx0XHRcdGJ1dHRvbnM6IHtcblx0XHRcdFx0XCJVcGdyYWRlIEFjY291bnRcIjogZnVuY3Rpb24oKSB7XG5cdFx0XHRcdFx0d2luZG93Lm9wZW4oXCIvYWNjb3VudC9zdXBwb3J0ZXIvP3F1b3RhaW5hcHBcIik7XG5cdFx0XHRcdFx0JGRpYWxvZy5kaWFsb2coXCJkZXN0cm95XCIpO1xuXHRcdFx0XHR9LFxuXHRcdFx0XHRcIk5vIFRoYW5rc1wiOiBmdW5jdGlvbigpIHtcblx0XHRcdFx0XHQkZGlhbG9nLmRpYWxvZygnZGVzdHJveScpO1xuXHRcdFx0XHR9XG5cdFx0XHR9LFxuXHRcdFx0YmVmb3JlQ2xvc2U6IGZ1bmN0aW9uKCkge1xuXHRcdFx0XHQkZGlhbG9nLmRpYWxvZyhcImRlc3Ryb3lcIik7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH07XG5cblx0ZDIwLnV0aWxzLnNob3dCYWRDb252ZXJ0ID0gZnVuY3Rpb24oKSB7XG5cdFx0dmFyICRkaWFsb2cgPSAkKFwiPGRpdj48cD5UaGVyZSB3YXMgYW4gZXJyb3IgdHJ5aW5nIHRvIGNvbnZlcnQgdGhlIFBERi4gQmUgc3VyZSB5b3UgZGlkbid0IHNwZWNpZnkgYW4gaW52YWxpZCBwYWdlIG51bWJlci4gSXQncyBhbHNvIHBvc3NpYmxlIHRoZSBQREYgaXMgY29ycnVwdGVkIG9yIGlzbid0IHN1cHBvcnRlZCBieSBvdXIgY29udmVyc2lvbiBzb2Z0d2FyZS48L2Rpdj5cIik7XG5cdFx0JGRpYWxvZy5kaWFsb2coe1xuXHRcdFx0bW9kYWw6IHRydWUsXG5cdFx0XHR0aXRsZTogXCJQREYgQ29udmVyc2lvbiBFcnJvclwiLFxuXHRcdFx0YnV0dG9uczoge1xuXHRcdFx0XHRcIkRyYXQhXCI6IGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRcdCRkaWFsb2cuZGlhbG9nKCdkZXN0cm95Jyk7XG5cdFx0XHRcdH1cblx0XHRcdH0sXG5cdFx0XHRiZWZvcmVDbG9zZTogZnVuY3Rpb24oKSB7XG5cdFx0XHRcdCRkaWFsb2cuZGlhbG9nKFwiZGVzdHJveVwiKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fTtcblxuXHRkMjAudXRpbHMuc2V0dXBBdmF0YXIgPSBmdW5jdGlvbigkZWwsIG90aGlzKSB7XG5cdFx0JGVsLmJpbmQoXCJ1cGxvYWRjb21wbGV0ZVwiLCBmdW5jdGlvbihlLCByZXNwb25zZSkge1xuXHRcdFx0ZS5zdG9wUHJvcGFnYXRpb24oKTtcblx0XHRcdGlmIChyZXNwb25zZSA9PSBcIm92ZXJxdW90YVwiKSB7XG5cdFx0XHRcdGQyMC51dGlscy5zaG93T3ZlclF1b3RhKCk7XG5cdFx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcdH1cblxuXHRcdFx0Ly8gdmFyIGpzb24gPSBKU09OLnBhcnNlKHJlc3BvbnNlKTtcblx0XHRcdC8vIGlmKCFqc29uKSB7XG5cdFx0XHQvLyAgICAgJGVsLmZpbmQoXCIuc3RhdHVzXCIpLmh0bWwoXCI8ZGl2IGNsYXNzPSdhbGVydCBhbGVydC1kYW5nZXInPkVycm9yIHVwbG9hZGluZyBmaWxlLiBQbGVhZXMgdHJ5IGFnYWluLjwvZGl2PlwiKTtcblx0XHRcdC8vICAgICByZXR1cm47XG5cdFx0XHQvLyB9XG5cblx0XHRcdG90aGlzLnVwZGF0ZU1vZGVsKCk7XG5cdFx0XHRjb25zdCByZXNwb25zZUltYWdlVVJMID0gIHJlc3BvbnNlLmJhc2UucmVwbGFjZSgnL29yaWdpbmFsLicsICcvbWVkLicpICsgKHJlc3BvbnNlLmJhc2UuaW5kZXhPZignPycpID09PSAtMSA/ICc/JyArIE1hdGguZmxvb3IobmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMDAwKSA6ICcnKTtcblx0XHRcdGlmICgkZWwuaGFzQ2xhc3MoJ2NhcmRfYmFjaycpKXtcblx0XHRcdFx0b3RoaXMubW9kZWwuc2F2ZSh7XG5cdFx0XHRcdFx0Y2FyZF9iYWNrOiByZXNwb25zZUltYWdlVVJMXG5cdFx0XHRcdH0pO1xuXHRcdFx0fSBlbHNlIGlmICgkZWwuaGFzQ2xhc3MoJ2F2YXRhcicpKXtcblx0XHRcdFx0b3RoaXMubW9kZWwuc2F2ZSh7XG5cdFx0XHRcdFx0YXZhdGFyOiByZXNwb25zZUltYWdlVVJMXG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXHRcdH0pO1xuXG5cdFx0JGVsLmRuZFVwbG9hZGVyKHtcblx0XHRcdHVybDogXCIvaW1hZ2VfbGlicmFyeS9uZXd1cGxvYWRcIixcblx0XHRcdG1ldGhvZDogXCJQT1NUXCIsXG5cdFx0XHRhbGxvd011bHRpcGxlOiBmYWxzZVxuXHRcdH0pO1xuXG5cdFx0JGVsLmJpbmQoXCJyZW1vdmVpbWFnZVwiLCBmdW5jdGlvbigpIHtcblx0XHRcdG90aGlzLnVwZGF0ZU1vZGVsKCk7XG5cdFx0XHRpZiAoJGVsLmhhc0NsYXNzKCdjYXJkX2JhY2snKSl7XG5cdFx0XHRcdG90aGlzLm1vZGVsLnNhdmUoe1xuXHRcdFx0XHRcdGNhcmRfYmFjazogXCJcIlxuXHRcdFx0XHR9KTtcblx0XHRcdH0gZWxzZSBpZiAoJGVsLmhhc0NsYXNzKCdhdmF0YXInKSl7XG5cdFx0XHRcdG90aGlzLm1vZGVsLnNhdmUoe1xuXHRcdFx0XHRcdGF2YXRhcjogXCJcIlxuXHRcdFx0XHR9KTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdC8vRml4ZXMgaHR0cHM6Ly9naXRodWIuY29tL1JvbGwyMC9Db2xsYWIvaXNzdWVzLzRcblx0XHQkZWwub24oXCJjbGlja1wiLCBcIi5yZW1vdmVcIiwgZnVuY3Rpb24oKSB7XG5cdFx0XHQkZWwudHJpZ2dlcihcInJlbW92ZWltYWdlXCIpO1xuXHRcdH0pXG5cblx0XHQkZWwuZHJvcHBhYmxlKHtcblx0XHRcdGRyb3A6IGZ1bmN0aW9uKGUsIHVpKSB7XG5cdFx0XHRcdGUub3JpZ2luYWxFdmVudC5kcm9wSGFuZGxlZCA9IHRydWU7XG5cblx0XHRcdFx0Ly8kdGhpcy5maW5kKFwiLmJhclwiKS5jc3MoXCJ3aWR0aFwiLCBcIjEwMCVcIik7XG5cdFx0XHRcdCRlbC50cmlnZ2VyKFwidXBsb2FkY29tcGxldGVcIiwgW3tcblx0XHRcdFx0XHRiYXNlOiB1aS5kcmFnZ2FibGUuYXR0cihcImRhdGEtZnVsbHNpemV1cmxcIilcblx0XHRcdFx0fSwgdHJ1ZV0pO1xuXG5cdFx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdFx0ZS5zdG9wUHJvcGFnYXRpb24oKTtcblx0XHRcdH0sXG5cdFx0XHRob3ZlckNsYXNzOiBcImRyb3AtaGlnaGxpZ2h0XCIsXG5cdFx0XHR0b2xlcmFuY2U6IFwidG91Y2hcIixcblx0XHRcdGdyZWVkeTogdHJ1ZSxcblx0XHRcdGFjY2VwdDogXCIucmVzdWx0aW1hZ2UsIC5saWJyYXJ5LWl0ZW1cIlxuXHRcdH0pO1xuXHR9O1xuXG5cdGQyMC51dGlscy5zdW1tZXJub3RlSW5pdCA9IGZ1bmN0aW9uKCkge1xuXHRcdGxldCAkdGV4dGFyZWEgPSAkKHRoaXMpO1xuXHRcdGxldCAkbG9hZGVyID0gJChcIjxkaXYgY2xhc3M9XFxcImxvYWRlclxcXCI+PC9kaXY+XCIpO1xuXHRcdGxldCBzaG93Q29kZVZpZXcgPSAkdGV4dGFyZWEuaGFzQ2xhc3MoXCJjb2RlLXZpZXdcIik7XG5cdFx0bGV0IGluQXBwRWRpdG9yID0gJHRleHRhcmVhLmhhc0NsYXNzKFwiaW4tYXBwLWVkaXRvclwiKTtcblx0XHRsZXQgY2FsbGJhY2tzID0ge307XG5cdFx0bGV0IHRvb2xiYXIgPSBbXG5cdFx0XHRbXCJzdHlsZVwiLCBbXCJzdHlsZVwiXV0sXG5cdFx0XHRbXCJmb250XCIsIFtcImJvbGRcIiwgXCJpdGFsaWNcIiwgXCJ1bmRlcmxpbmVcIiwgXCJzdHJpa2V0aHJvdWdoXCIsIFwiY2xlYXJcIl1dLFxuXHRcdFx0W1wic2l6ZVwiLCBbXCJzdXBlcnNjcmlwdFwiLCBcInN1YnNjcmlwdFwiXV0sXG5cdFx0XHRbXCJwYXJhXCIsIFtcIm9sXCIsIFwidWxcIiwgXCJwYXJhZ3JhcGhcIl1dXG5cdFx0XTtcblx0XHRpZiAoIWluQXBwRWRpdG9yKSB7XG5cdFx0XHR0b29sYmFyLnB1c2goW1wiaW5zZXJ0XCIsIFtcInRhYmxlXCIsIFwibGlua1wiLCBcInBpY3R1cmVcIiwgXCJoclwiXV0pO1xuXHRcdFx0Y2FsbGJhY2tzID0ge1xuXHRcdFx0XHRvbkltYWdlVXBsb2FkOiBmdW5jdGlvbihmaWxlcykge1xuXHRcdFx0XHRcdGxldCAkc3VtbWVybm90ZSA9ICQodGhpcyk7XG5cdFx0XHRcdFx0JGxvYWRlci5zaG93KCk7XG5cdFx0XHRcdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBmaWxlcy5sZW5ndGg7IGkrKykge1xuXHRcdFx0XHRcdFx0bGV0IG5hbWUgPSBmaWxlc1tpXS5uYW1lLnNwbGl0KFwiLlwiKVswXTtcblx0XHRcdFx0XHRcdGxldCBkYXRhID0gbmV3IEZvcm1EYXRhKCk7XG5cdFx0XHRcdFx0XHRkYXRhLmFwcGVuZChcImZpbGVcIiwgZmlsZXNbaV0pO1xuXHRcdFx0XHRcdFx0JC5hamF4KHtcblx0XHRcdFx0XHRcdFx0ZGF0YTogZGF0YSxcblx0XHRcdFx0XHRcdFx0ZGF0YVR5cGU6IFwiSlNPTlwiLFxuXHRcdFx0XHRcdFx0XHR0eXBlOiBcIlBPU1RcIixcblx0XHRcdFx0XHRcdFx0dXJsOiBcIi9mb3J1bS91cGxvYWRcIixcblx0XHRcdFx0XHRcdFx0Y2FjaGU6IGZhbHNlLFxuXHRcdFx0XHRcdFx0XHRjb250ZW50VHlwZTogZmFsc2UsXG5cdFx0XHRcdFx0XHRcdHByb2Nlc3NEYXRhOiBmYWxzZSxcblx0XHRcdFx0XHRcdFx0c3VjY2VzczogZnVuY3Rpb24ocmVzcG9uc2UpIHtcblx0XHRcdFx0XHRcdFx0XHRpZiAodHlwZW9mIHJlc3BvbnNlLmVycm9yICE9PSBcInVuZGVmaW5lZFwiKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRhbGVydChyZXNwb25zZS5lcnJvcik7XG5cdFx0XHRcdFx0XHRcdFx0XHQkbG9hZGVyLmhpZGUoKTtcblx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdFx0ZWxzZSB7XG5cdFx0XHRcdFx0XHRcdFx0XHQkc3VtbWVybm90ZS5zdW1tZXJub3RlKFwiaW5zZXJ0SW1hZ2VcIiwgcmVzcG9uc2VbXCJmaWxlbGlua1wiXSwgbmFtZSlcblx0XHRcdFx0XHRcdFx0XHRcdFx0LmRvbmUoZnVuY3Rpb24oKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0JGxvYWRlci5oaWRlKCk7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdFx0ZXJyb3I6IGZ1bmN0aW9uKGpxWEhSLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikge1xuXHRcdFx0XHRcdFx0XHRcdGFsZXJ0KFwiVGhlcmUgd2FzIGFuIGVycm9yIHVwbG9hZGluZyB5b3VyIGltYWdlLiBUaGlzIHdhcyBwcm9iYWJseSBjYXVzZWQgYnkgZWl0aGVyIGNvbm5lY3Rpb24gaXNzdWVzLCBvciB0aGUgZmlsZSBiZWluZyB0b28gbGFyZ2UuXCIpO1xuXHRcdFx0XHRcdFx0XHRcdCRsb2FkZXIuaGlkZSgpO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0sXG5cdFx0XHRcdG9uSW1hZ2VVcGxvYWRFcnJvcjogZnVuY3Rpb24ob25lLCB0d28sIHRocmVlKSB7XG5cdFx0XHRcdFx0Y29uc29sZS5lcnJvcihcIkltYWdlIFVwbG9hZCBFcnJvclwiKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblx0XHRlbHNlIHtcblx0XHRcdHRvb2xiYXIucHVzaChbXCJpbnNlcnRcIiwgW1wibGlua1wiLCBcInVubGlua1wiXV0pO1xuXHRcdFx0dG9vbGJhci5wdXNoKFtcImhyXCIsIFtcImhyXCJdXSk7XG5cdFx0XHR0b29sYmFyLnB1c2goW1wiY29sb3JcIiwgW1wiY29sb3JcIl1dKTtcblx0XHRcdHRvb2xiYXIucHVzaChbXCJ0YWJsZUFkZFwiLCBbXCJ0YWJsZVwiLCBcInRhYmxlSGVhZGVyc1wiLCBcImFkZFJvd1VwXCIsIFwiYWRkUm93RG93blwiLCBcImFkZENvbExlZnRcIiwgXCJhZGRDb2xSaWdodFwiXV0pO1xuXHRcdFx0dG9vbGJhci5wdXNoKFtcInRhYmxlRGVsZXRlXCIsIFtcImRlbGV0ZVJvd1wiLCBcImRlbGV0ZUNvbFwiLCBcImRlbGV0ZVRhYmxlXCJdXSk7XG5cdFx0fVxuXHRcdGlmIChzaG93Q29kZVZpZXcpIHtcblx0XHRcdHRvb2xiYXIucHVzaChbXCJjb2RlXCIsIFtcImNvZGV2aWV3XCJdXSlcblx0XHR9XG5cdFx0bGV0IHN1bW1lcm5vdGVEZWZhdWx0cyA9IHtcblx0XHRcdHRvb2xiYXI6IHRvb2xiYXIsXG5cdFx0XHRkaXNhYmxlRHJhZ0FuZERyb3A6IGluQXBwRWRpdG9yLFxuXHRcdFx0Y2FsbGJhY2tzOiBjYWxsYmFja3MsXG5cdFx0XHRtYXhIZWlnaHQ6IDMwMCxcblx0XHRcdGRpYWxvZ3NJbkJvZHk6IGluQXBwRWRpdG9yLFxuXHRcdFx0b25DcmVhdGVMaW5rOiBmdW5jdGlvbiAobGlua1VSTCkge1xuXHRcdFx0XHQvLyBJZiB0aGUgVVJMIGlzIGEgc3BlY2lhbCBjYXNlLCByZXBsYWNlIHRoZSA6IHdpdGggaHRtbC1lc2NhcGVkIDpcblx0XHRcdFx0aWYgKGxpbmtVUkxbMF0gPT09IFwiYFwiIHx8IGxpbmtVUkxbMF0gPT09IFwiIVwiIHx8IGxpbmtVUkxbMF0gPT09IFwiflwiKSB7XG5cdFx0XHRcdFx0bGlua1VSTCA9IGxpbmtVUkwucmVwbGFjZSgvOi9nLCBcIiYjNTg7XCIpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdHJldHVybiBsaW5rVVJMO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRpZiAoaW5BcHBFZGl0b3IpIHtcblx0XHRcdHN1bW1lcm5vdGVEZWZhdWx0c1tcInBvcG92ZXJcIl0gPSB7XG5cdFx0XHRcdHRhYmxlOiBbXSxcblx0XHRcdFx0bGluazogW11cblx0XHRcdH07XG5cdFx0fVxuXHRcdGVsc2Uge1xuXHRcdFx0c3VtbWVybm90ZURlZmF1bHRzW1wicG9wb3ZlclwiXSA9IHtcblx0XHRcdFx0dGFibGU6IFtcblx0XHRcdFx0XHRbJ2FkZCcsIFsndGFibGVIZWFkZXJzJywgJ2FkZFJvd0Rvd24nLCAnYWRkUm93VXAnLCAnYWRkQ29sTGVmdCcsICdhZGRDb2xSaWdodCddXSxcblx0XHRcdFx0XHRbJ2RlbGV0ZScsIFsnZGVsZXRlUm93JywgJ2RlbGV0ZUNvbCcsICdkZWxldGVUYWJsZSddXVxuXHRcdFx0XHRdXG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0JHRleHRhcmVhLnN1bW1lcm5vdGUoc3VtbWVybm90ZURlZmF1bHRzKTtcblx0XHQkbG9hZGVyLmhpZGUoKTtcblx0XHQkdGV4dGFyZWEuc2libGluZ3MoXCIubm90ZS1lZGl0b3JcIikuYXBwZW5kKCRsb2FkZXIpO1xuXHR9O1xuXG5cdGQyMC51dGlscy5tYWtlQ29udGVudEVkaXRhYmxlID0gZnVuY3Rpb24oJGNvbnRhaW5lciwgY29udGVudCwgaW5jbHVkZUNvZGVWaWV3KSB7XG5cdFx0bGV0ICRjb250ZW50ID0gJChjb250ZW50KTtcblx0XHQkY29udGFpbmVyLmh0bWwoXCI8dGV4dGFyZWEgY2xhc3M9J3N1bW1lcm5vdGVcIiArIChpbmNsdWRlQ29kZVZpZXcgPyBcIiBjb2RlLXZpZXdcIiA6IFwiXCIpICsgXCInPjwvdGV4dGFyZWE+XCIpO1xuXHRcdCRjb250YWluZXIuZmluZChcInRleHRhcmVhLnN1bW1lcm5vdGVcIikuZWFjaChkMjAudXRpbHMuc3VtbWVybm90ZUluaXQpO1xuXHRcdCRjb250YWluZXIuZmluZChcInRleHRhcmVhLnN1bW1lcm5vdGVcIikuc3VtbWVybm90ZShcImZvY3VzXCIpO1xuXHRcdCRjb250ZW50LmZpbmQoXCIubGlnaHRseVwiKS5lYWNoKGZ1bmN0aW9uKCkge1xuXHRcdFx0bGV0ICRpbWdXcmFwcGVyID0gJCh0aGlzKTtcblx0XHRcdGxldCAkaW1nID0gJCgkaW1nV3JhcHBlci5odG1sKCkpO1xuXHRcdFx0JGltZ1dyYXBwZXIuYWZ0ZXIoJGltZyk7XG5cdFx0XHQkaW1nV3JhcHBlci5yZW1vdmUoKTtcblx0XHR9KTtcblx0XHQkY29udGFpbmVyLmZpbmQoXCIubm90ZS1lZGl0YWJsZVwiKS5odG1sKCRjb250ZW50Lmh0bWwoKSk7XG5cdFx0JGNvbnRhaW5lci5maW5kKFwidGV4dGFyZWEuc3VtbWVybm90ZVwiKS50cmlnZ2VyKFwic3VtbWVybm90ZS5jaGFuZ2VcIik7XG5cdH07XG5cblx0ZDIwLnV0aWxzLmFkZENTU1J1bGVzID0gZnVuY3Rpb24ocnVsZXMpIHtcblx0XHQvLyBtYWtlIGEgbmV3IHN0eWxlc2hlZXRcblx0XHR2YXIgbnMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpO1xuXHRcdGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdoZWFkJylbMF0uYXBwZW5kQ2hpbGQobnMpO1xuXG5cdFx0Ly8gU2FmYXJpIGRvZXMgbm90IHNlZSB0aGUgbmV3IHN0eWxlc2hlZXQgdW5sZXNzIHlvdSBhcHBlbmQgc29tZXRoaW5nLlxuXHRcdC8vIEhvd2V2ZXIhICBJRSB3aWxsIGJsb3cgY2h1bmtzLCBzbyAuLi4gZmlsdGVyIGl0IHRodXNseTpcblx0XHRpZiAoIXdpbmRvdy5jcmVhdGVQb3B1cCkge1xuXHRcdFx0bnMuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJycpKTtcblx0XHR9XG5cdFx0dmFyIHMgPSBkb2N1bWVudC5zdHlsZVNoZWV0c1tkb2N1bWVudC5zdHlsZVNoZWV0cy5sZW5ndGggLSAxXTtcblx0XHQvLyBzb21lIHJ1bGVzIHRvIGFwcGx5XG5cblx0XHQvLyBsb29wIHRocm91Z2ggYW5kIGluc2VydFxuXHRcdGZvciAobGV0IHNlbGVjdG9yIGluIHJ1bGVzKSB7XG5cdFx0XHRpZiAocy5pbnNlcnRSdWxlKSB7XG5cdFx0XHRcdC8vIGl0J3MgYW4gSUUgYnJvd3NlclxuXHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdHMuaW5zZXJ0UnVsZShzZWxlY3RvciArIHJ1bGVzW3NlbGVjdG9yXSwgcy5jc3NSdWxlcy5sZW5ndGgpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGNhdGNoIChlKSB7fVxuXHRcdFx0fVxuXHRcdFx0ZWxzZSB7XG5cdFx0XHRcdC8vIGl0J3MgYSBXM0MgYnJvd3NlclxuXHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdHMuYWRkUnVsZShzZWxlY3RvciwgcnVsZXNbc2VsZWN0b3JdKTtcblx0XHRcdFx0fVxuXHRcdFx0XHRjYXRjaCAoZSkge1xuXHRcdFx0XHRcdGNvbnNvbGUubG9nKFwiRXJyb3IgYWRkZGluZyBydWxlIVwiKTtcblx0XHRcdFx0XHRjb25zb2xlLmxvZyhlKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblx0fTtcblxuXHRkMjAudXRpbHMuZGVmYXVsdERpY2VUb2tlbnMgPSB7XG5cdFx0Ly9cImQ0XCI6IFtcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc0NzMwMy9ZeG1PRzE2elBGaVNyVy1sRWRtcFRnL3RodW1iLnBuZz8xMzYyNDUzMjcxXCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzQ3MzAxL2tNU2NoMTl6VW5Mb0dveVN3RjlZa3cvdGh1bWIucG5nPzEzNjI0NTMyNzFcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83NDczMDIvRU5yZkZSaFAycERkbmVLZ1Q2Smd4Zy90aHVtYi5wbmc/MTM2MjQ1MzI3MVwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc0NzMwNC9hWjhLQjBwdGtzSmNnUlF4OGdNUzJ3L3RodW1iLnBuZz8xMzYyNDUzMjcxXCJdLFxuXHRcdC8vXCJkMjBcIjogW1wiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzQ3MjcxL3ZQdllHODRqMnRTU3BaNDhEM2VOcVEvdGh1bWIucG5nPzEzNjI0NTMxNTFcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83NDcyNzIvNkJQbk5XM1BCRWhQY2xrYi14SVE5dy90aHVtYi5wbmc/MTM2MjQ1MzE1MVwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc0NzI3NC9NellMS1dLNVNWaGJkdko4bmFwSXpRL3RodW1iLnBuZz8xMzYyNDUzMTUxXCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzQ3MjczL0swTHg3NlBTRGFBUWROaldtb1hhbmcvdGh1bWIucG5nPzEzNjI0NTMxNTFcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83NDcyNzYvUTcyU0VvZ0U1ZnFPNnY2YU1DQlVQdy90aHVtYi5wbmc/MTM2MjQ1MzE1MlwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc0NzI3NS9hUndQQXBwSUZ0N0hQTTVDNnkwbFFRL3RodW1iLnBuZz8xMzYyNDUzMTUyXCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzQ3Mjc3L2JlT1BKa3dQQTRQUlY0UUxxN2J5T2cvdGh1bWIucG5nPzEzNjI0NTMxNTJcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83NDcyNzgvNWo1Q2lnWUJBUDNERy1jTnJIUV9GUS90aHVtYi5wbmc/MTM2MjQ1MzE1MlwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc0NzI4Mi9SV1RKSlRQY3hPdlpOUUdDYUJpUWNnL3RodW1iLnBuZz8xMzYyNDUzMTUzXCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzQ3MjgwL0o1WC03clJCdWFPVnpLQ1hnSldZblEvdGh1bWIucG5nPzEzNjI0NTMxNTNcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83NDcyODEvX2JWdHU3dzJGWm9ZSjk1aUFOdWRKZy90aHVtYi5wbmc/MTM2MjQ1MzE1M1wiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc0NzI3OS9INHdMYnUyZmNJcWpYYUJOUjhGMFpRL3RodW1iLnBuZz8xMzYyNDUzMTUzXCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzQ3Mjg0L0Z6VmR3Y0FaVnVDeXpIR2xFUXVTRWcvdGh1bWIucG5nPzEzNjI0NTMxNTRcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83NDcyODMvbVNTakVDV1hyR29VcFdXcFJyV3BHdy90aHVtYi5wbmc/MTM2MjQ1MzE1NFwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc0NzI4OC9hOExYSnBFMTlVUHBNVFE4Wnc2cS13L3RodW1iLnBuZz8xMzYyNDUzMTU1XCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzQ3Mjg1L3QxaHdUOWMzbHJEWXhxSXRmWFltR3cvdGh1bWIucG5nPzEzNjI0NTMxNTRcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83NDcyODcvd3IzNXJ6OHlMalFreWlRS0JLUlI5QS90aHVtYi5wbmc/MTM2MjQ1MzE1NVwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc0NzI5MC9kM182WDF3bngxTV9xZTN3cEJYdThRL3RodW1iLnBuZz8xMzYyNDUzMTU2XCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzQ3MjkxLzB1RG5TVlAydmI1MWpnY2pxZTNLQUEvdGh1bWIucG5nPzEzNjI0NTMxNThcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83NDcyODkvanV2WkFaMDBGX0FFVFFiNGc0bFYzdy90aHVtYi5wbmc/MTM2MjQ1MzE1NVwiXVxuXHRcdFwiZDRcIjogW1wiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NTQyL0RFWWFCZFA4dzlCMUNVU0syNmltMEEvdGh1bWIucG5nPzEzNjMwNTAwNTZcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk1NDAvUDd5S2RlNWZ5R1pDQjF1ZDcwVU96QS90aHVtYi5wbmc/MTM2MzA1MDA1NlwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTUzOS9BTzRtLTQ1Ykd3NXlPY25aWFVBbjlnL3RodW1iLnBuZz8xMzYzMDUwMDU2XCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NTQxL29XQS1obUJBSE5BaWpjZUhyOGstM0EvdGh1bWIucG5nPzEzNjMwNTAwNTZcIl0sXG5cdFx0XCJkNlwiOiBbXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk1MzMvLWdTODVIVWFYSXZtRTVTakdwb0g0dy90aHVtYi5wbmc/MTM2MzA0OTk5OFwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTUzNS92a2NfUFQ0ei1kX09OMU12ZkhhQ2lBL3RodW1iLnBuZz8xMzYzMDQ5OTk5XCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NTM0L21IRGFkRmlyaWU0TDEyX2lpLUhZcVEvdGh1bWIucG5nPzEzNjMwNDk5OThcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk1MzEvblhxcDJCaGR3VnNRbjdjRFIzY01sZy90aHVtYi5wbmc/MTM2MzA0OTk5OFwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTUzMi9uUUQ1X0lYWUxXTjdZQ2puZDV6dWdBL3RodW1iLnBuZz8xMzYzMDQ5OTk4XCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NTM2L3R0aXd3aVdFMlBWa2hEMmQ3ZlYzR0EvdGh1bWIucG5nPzEzNjMwNDk5OTlcIl0sXG5cdFx0XCJkOFwiOiBbXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk1MTQvR1BDaDV2cWRTd3Z0X0FOa2EzeWhhdy90aHVtYi5wbmc/MTM2MzA0OTgwMlwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTUxNy9ubnVmMVBlMkZxNzBCSXM5RkdJN21RL3RodW1iLnBuZz8xMzYzMDQ5ODAyXCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NTE2L1dud3V3VDd5YjVWTTMtS2lKWTNHT2cvdGh1bWIucG5nPzEzNjMwNDk4MDJcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk1MTUvR3gyMWJ1VmQ2ZDZvblBzQUxyR0ZXUS90aHVtYi5wbmc/MTM2MzA0OTgwMlwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTUxOC80THFmVUdpWDhzQlhyWDliNWdVbkx3L3RodW1iLnBuZz8xMzYzMDQ5ODAzXCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NTE5L1lPUjVXYXYwLTMtTDFmbTR2RC1MRlEvdGh1bWIucG5nPzEzNjMwNDk4MDNcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk1MjIvZEdGWFhzRUp6MEVQQThkUnBadk96QS90aHVtYi5wbmc/MTM2MzA0OTgwNFwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTUyMS9RWG02R2NJaEs2elRkTXZKWlZTOE9nL3RodW1iLnBuZz8xMzYzMDQ5ODA0XCJdLFxuXHRcdFwiZDEwXCI6IFtcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTQ5OC9manVwNUZ6NGlWLVRGS3hWOXoxUXRnL3RodW1iLnBuZz8xMzYzMDQ5NzE3XCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NTAwL3VnN203ZzFySUkwNVpGenlUcmtSbXcvdGh1bWIucG5nPzEzNjMwNDk3MTdcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk0OTkvUU5aUjVrR2llTTF4MDB5UXZTWVliZy90aHVtYi5wbmc/MTM2MzA0OTcxN1wiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTQ5Ny90a3oyNTUyLU1xVjhhX3dvQUQ4UzRBL3RodW1iLnBuZz8xMzYzMDQ5NzE3XCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NTAxL3hLanFJeFh6aWJwY3gzTHA3VUg2cWcvdGh1bWIucG5nPzEzNjMwNDk3MThcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk1MDIvQnBjMVFBVHpPMjkzTHZHUzNuZUJzUS90aHVtYi5wbmc/MTM2MzA0OTcxOFwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTUwNC9CcHcyNFQ4bmEwbkpORmRUS1pYNWF3L3RodW1iLnBuZz8xMzYzMDQ5NzE4XCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NTAzL3VrUWJjN3VES2ZsNjJuZzJFTzZoNmcvdGh1bWIucG5nPzEzNjMwNDk3MTlcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk1MDUvMjM5NDhZNl9PMEJjMFJ1SXZlM0JiQS90aHVtYi5wbmc/MTM2MzA0OTcxOVwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTUwNi9WaHdiRlZEbTJLT3RlNWgycDk3bjd3L3RodW1iLnBuZz8xMzYzMDQ5NzE5XCJdLFxuXHRcdFwiZDEyXCI6IFtcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTQ3Ni9GUmthUjZYdnl6VXVaYjBaQjd5c0NBL3RodW1iLnBuZz8xMzYzMDQ5NDg5XCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NDc0L1V5VEtESHhmLWZVMXpDM3c2dWRsMHcvdGh1bWIucG5nPzEzNjMwNDk0ODlcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk0NzUva1VLMlVtQmFEMk5vMDBHcDRRX09DUS90aHVtYi5wbmc/MTM2MzA0OTQ4OVwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTQ3Ny9PVm5KRGpBa01QTGsyOWhqcEZqVXZ3L3RodW1iLnBuZz8xMzYzMDQ5NDg5XCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NDc4LzJsYTl0YVprX3ZxZEtJdFlaNkpFZkEvdGh1bWIucG5nPzEzNjMwNDk0OTBcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk0NzkvZmE4ZjlPVklCdDc5b0VUamk4QzhMZy90aHVtYi5wbmc/MTM2MzA0OTQ5MFwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTQ4MC9DVHV3OVlpaWpxMjRyYTNHOVlNdVBBL3RodW1iLnBuZz8xMzYzMDQ5NDkwXCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NDgxL2Q0b25uYzdOT0FiTkc1SmJpTDltYmcvdGh1bWIucG5nPzEzNjMwNDk0OTFcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk0ODIvT3kyZFRrQjMtTmx4aU1zVFJqNzhudy90aHVtYi5wbmc/MTM2MzA0OTQ5MVwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTQ4My9tT19LVThubE83R0RRS2MySl9hTmVnL3RodW1iLnBuZz8xMzYzMDQ5NDkxXCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NDg0LzNNWUc1ZFlKaGlLWHNSWnRTVXBIWncvdGh1bWIucG5nPzEzNjMwNDk0OTFcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk0ODUvVnhBM3VtVkRtWXJINUFfVkJlY1VJUS90aHVtYi5wbmc/MTM2MzA0OTQ5MlwiXSxcblx0XHRcImQyMFwiOiBbXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk0NDUvT2ZMWEduYmtOcjJxS2cxUXFrNGNQZy90aHVtYi5wbmc/MTM2MzA0OTMxNFwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTQ0Ny9icjRUZFNoYnVNSVotRC1seWVYc0tBL3RodW1iLnBuZz8xMzYzMDQ5MzE1XCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NDU0LzJBUnNKTG9QNHRFeGJDV3JSYWF4UWcvdGh1bWIucG5nPzEzNjMwNDkzMThcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk0NDQvM3ByeVZPS1J4TUNCaXNFSHBIM0xXZy90aHVtYi5wbmc/MTM2MzA0OTMxNFwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTQ0Ni9ZazRzU0YzZVdmbnBlSmQ0RFFwVjJBL3RodW1iLnBuZz8xMzYzMDQ5MzE0XCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NDUwL3RkdmpWdmlGSGhNX0t4akZSUW9taEEvdGh1bWIucG5nPzEzNjMwNDkzMTZcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk0NTYvdHdiSGxQcTBDRmpGQ3BBeVM1OUNUUS90aHVtYi5wbmc/MTM2MzA0OTMxOVwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTQ0OS9QUEhEaXJaZkVvd2hqQkh4UWR4Sml3L3RodW1iLnBuZz8xMzYzMDQ5MzE1XCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NDQ4LzFTcE5ycnVucEh3ck5ic0tjcXBDelEvdGh1bWIucG5nPzEzNjMwNDkzMTVcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk0NTgvVnN1ZUJZcWFEbHZwOUJqbFhsOXdNUS90aHVtYi5wbmc/MTM2MzA0OTMyMFwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTQ1MS9uV3FoSDlpTWltVUFKaF85ak9GRW9nL3RodW1iLnBuZz8xMzYzMDQ5MzE2XCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NDUyL1R2a3N2VTZBWm0yd21wRVEySGtCbFEvdGh1bWIucG5nPzEzNjMwNDkzMTdcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk0NTkvTDRwd21xSWJRazBUZmFDTUV4cll4US90aHVtYi5wbmc/MTM2MzA0OTMyMFwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTQ1My9NRG1lTVdPUV9sQVJmdkZvVDFuM0tRL3RodW1iLnBuZz8xMzYzMDQ5MzE3XCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NDYwL215OFZFR3lZY0pJSFpOMnVYUDZRWFEvdGh1bWIucG5nPzEzNjMwNDkzMjFcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk0NTUvbnV6NUFlZmRRU0I2SDRtdlVYb3Fody90aHVtYi5wbmc/MTM2MzA0OTMxOFwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTQ1Ny9rUUJ1bnE3aVhHbUhOcVpRQ2E1TUNBL3RodW1iLnBuZz8xMzYzMDQ5MzE5XCIsIFwiaHR0cHM6Ly9zMy5hbWF6b25hd3MuY29tL2ZpbGVzLmQyMC5pby9pbWFnZXMvNzc5NDYzLzZuX3o3R3dkN2VhY20zLUhDLWYtbWcvdGh1bWIucG5nPzEzNjMwNDkzMjJcIiwgXCJodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvL2ltYWdlcy83Nzk0NjIvYVZ6M3FDZTJRTTJuV2huM0JvVDlyZy90aHVtYi5wbmc/MTM2MzA0OTMyMVwiLCBcImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9maWxlcy5kMjAuaW8vaW1hZ2VzLzc3OTQ2MS80UHVGSllkZEpXSmpqNHVMNVMzbXhRL3RodW1iLnBuZz8xMzYzMDQ5MzIxXCJdXG5cdH1cblxuXHRmb3IgKHZhciBkZHQgaW4gZDIwLnV0aWxzLmRlZmF1bHREaWNlVG9rZW5zKSB7XG5cdFx0ZDIwLnV0aWxzLmRlZmF1bHREaWNlVG9rZW5zW2RkdF0gPSBfLm1hcChkMjAudXRpbHMuZGVmYXVsdERpY2VUb2tlbnNbZGR0XSwgZnVuY3Rpb24oaXRlbSkge1xuXHRcdFx0cmV0dXJuIGVzY2FwZShpdGVtICsgXCJcIik7XG5cdFx0fSlcblx0fVxuXG5cdGQyMC51dGlscy5oZXhUb1JnYiA9IGZ1bmN0aW9uKGgpIHtcblx0XHRoWzRdIHx8IChoID0gaC5yZXBsYWNlKC8uL2csICckJiQmJykuc2xpY2UoMSkpO1xuXHRcdHJldHVybiBbJzB4JyArIGhbMV0gKyBoWzJdIHwgMCwgJzB4JyArIGhbM10gKyBoWzRdIHwgMCwgJzB4JyArIGhbNV0gKyBoWzZdIHwgMF1cblx0fTtcblxuXHR2YXIgbGlua0NhY2hlID0ge307XG5cblx0dmFyIF9yZWZyZXNoTGlua0NhY2hlID0gZnVuY3Rpb24oKSB7XG5cdFx0dmFyIHBvc3NpYmlsaXRpZXMgPSB7fTtcblx0XHRkMjAuQ2FtcGFpZ24uY2hhcmFjdGVycy5lYWNoKGZ1bmN0aW9uKGNoYXJhY3Rlcikge1xuXHRcdFx0dmFyIGluam91cm5hbHMgPSBjaGFyYWN0ZXIuZ2V0KFwiaW5wbGF5ZXJqb3VybmFsc1wiKS5zcGxpdChcIixcIik7XG5cdFx0XHRpZiAod2luZG93LmlzX2dtIHx8IF8uaW5kZXhPZihpbmpvdXJuYWxzLCBcImFsbFwiKSAhPT0gLTEgfHwgKHdpbmRvdy5jdXJyZW50UGxheWVyICYmIF8uaW5kZXhPZihpbmpvdXJuYWxzLCB3aW5kb3cuY3VycmVudFBsYXllci5pZCkgIT09IC0xKSkge1xuXHRcdFx0XHRwb3NzaWJpbGl0aWVzW2NoYXJhY3Rlci5nZXQoXCJuYW1lXCIpLnRvTG93ZXJDYXNlKCldID0ge1xuXHRcdFx0XHRcdHR5cGU6IFwiY2hhcmFjdGVyXCIsXG5cdFx0XHRcdFx0aWQ6IGNoYXJhY3Rlci5pZFxuXHRcdFx0XHR9O1xuXHRcdFx0fVxuXHRcdH0pO1xuXG5cdFx0ZDIwLkNhbXBhaWduLmhhbmRvdXRzLmVhY2goZnVuY3Rpb24oaGFuZG91dCkge1xuXHRcdFx0dmFyIGluam91cm5hbHMgPSBoYW5kb3V0LmdldChcImlucGxheWVyam91cm5hbHNcIikuc3BsaXQoXCIsXCIpO1xuXHRcdFx0aWYgKHdpbmRvdy5pc19nbSB8fCBfLmluZGV4T2YoaW5qb3VybmFscywgXCJhbGxcIikgIT09IC0xIHx8ICh3aW5kb3cuY3VycmVudFBsYXllciAmJiBfLmluZGV4T2YoaW5qb3VybmFscywgd2luZG93LmN1cnJlbnRQbGF5ZXIuaWQpICE9PSAtMSkpIHtcblx0XHRcdFx0cG9zc2liaWxpdGllc1toYW5kb3V0LmdldChcIm5hbWVcIikudG9Mb3dlckNhc2UoKV0gPSB7XG5cdFx0XHRcdFx0dHlwZTogXCJoYW5kb3V0XCIsXG5cdFx0XHRcdFx0aWQ6IGhhbmRvdXQuaWRcblx0XHRcdFx0fTtcblx0XHRcdH1cblx0XHR9KTtcblx0XHRsaW5rQ2FjaGUgPSBwb3NzaWJpbGl0aWVzO1xuXHR9O1xuXG5cdGQyMC51dGlscy5yZWZyZXNoTGlua0NhY2hlID0gXy5kZWJvdW5jZShfcmVmcmVzaExpbmtDYWNoZSwgMTAwKTtcblxuXHRkMjAudXRpbHMuYXV0b0xpbmsgPSBmdW5jdGlvbih0ZXh0KSB7XG5cdFx0dmFyIGxpbmtyZWcgPSAvXFxbW15cXF1dK1xcXS9nXG5cdFx0dGV4dCA9IHRleHQucmVwbGFjZShsaW5rcmVnLCBmdW5jdGlvbihtYXRjaCkge1xuXHRcdFx0bWF0Y2ggPSBtYXRjaC5zdWJzdHJpbmcoMSwgbWF0Y2gubGVuZ3RoIC0gMSk7XG5cdFx0XHR2YXIgZm91bmRtYXRjaCA9IGxpbmtDYWNoZVttYXRjaC50b0xvd2VyQ2FzZSgpXTtcblx0XHRcdGlmIChmb3VuZG1hdGNoKSB7XG5cdFx0XHRcdHJldHVybiBcIjxhIGhyZWY9J2h0dHA6Ly9qb3VybmFsLnJvbGwyMC5uZXQvXCIgKyBmb3VuZG1hdGNoLnR5cGUgKyBcIi9cIiArIGZvdW5kbWF0Y2guaWQgKyBcIic+XCIgKyBtYXRjaCArIFwiPC9hPlwiO1xuXHRcdFx0fVxuXHRcdFx0ZWxzZSB7XG5cdFx0XHRcdHJldHVybiBcIltcIiArIG1hdGNoICsgXCJdXCI7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdFx0cmV0dXJuIHRleHQ7XG5cdH07XG5cblx0dmFyICRub3RpZmllciA9ICQoXCIjdGV4dGNoYXQtbm90aWZpZXJcIik7XG5cblx0dmFyIGN1cnJlbnRUZXh0Y2hhdE5vdGlmaWNhdGlvblBlcm1hbmVudCA9IGZhbHNlO1xuXG5cdGQyMC51dGlscy50ZXh0Y2hhdE5vdGlmeSA9IGZ1bmN0aW9uKG1zZywgcGVybWFuZW50KSB7XG5cblx0XHRpZiAoY3VycmVudFRleHRjaGF0Tm90aWZpY2F0aW9uUGVybWFuZW50ID09PSB0cnVlICYmIHBlcm1hbmVudCAhPT0gdHJ1ZSkgcmV0dXJuOyAvL2lnbm9yZSBub24tcGVybWFuZW50IG1lc3NhZ2VzXG5cblx0XHRpZiAobXNnID09PSBmYWxzZSkge1xuXHRcdFx0JG5vdGlmaWVyLmhpZGUoKTtcblx0XHR9XG5cdFx0ZWxzZSB7XG5cdFx0XHQkbm90aWZpZXIuc2hvdygpLnRleHQobXNnKTtcblx0XHR9XG5cblx0XHRpZiAocGVybWFuZW50ID09PSB0cnVlKSB7XG5cdFx0XHRpZiAobXNnICE9PSBmYWxzZSkgY3VycmVudFRleHRjaGF0Tm90aWZpY2F0aW9uUGVybWFuZW50ID0gdHJ1ZTtcblx0XHRcdGVsc2UgY3VycmVudFRleHRjaGF0Tm90aWZpY2F0aW9uUGVybWFuZW50ID0gZmFsc2U7XG5cdFx0fVxuXHR9XG5cblx0ZDIwLnV0aWxzLmdldFBhcmVudHNVbnRpbCA9IGZ1bmN0aW9uKGVsZW0sIHBhcmVudCwgc2VsZWN0b3IpIHtcblxuXHRcdHZhciBwYXJlbnRzID0gW107XG5cdFx0Ly8gaWYgKCBwYXJlbnQgKSB7XG5cdFx0Ly8gICAgIHZhciBwYXJlbnRUeXBlID0gcGFyZW50LmNoYXJBdCgwKTtcblx0XHQvLyB9XG5cdFx0aWYgKHNlbGVjdG9yKSB7XG5cdFx0XHR2YXIgc2VsZWN0b3JUeXBlID0gc2VsZWN0b3IuY2hhckF0KDApO1xuXHRcdH1cblxuXHRcdC8vIEdldCBtYXRjaGVzXG5cdFx0Zm9yICg7IGVsZW0gJiYgZWxlbSAhPT0gZG9jdW1lbnQ7IGVsZW0gPSBlbGVtLnBhcmVudE5vZGUpIHtcblxuXHRcdFx0Ly8gQ2hlY2sgaWYgcGFyZW50IGhhcyBiZWVuIHJlYWNoZWRcblx0XHRcdC8vIGlmICggcGFyZW50ICkge1xuXG5cdFx0XHQvLyAgICAgLy8gSWYgcGFyZW50IGlzIGEgY2xhc3Ncblx0XHRcdC8vICAgICBpZiAoIHBhcmVudFR5cGUgPT09ICcuJyApIHtcblx0XHRcdC8vICAgICAgICAgaWYgKCBlbGVtLmNsYXNzTGlzdC5jb250YWlucyggcGFyZW50LnN1YnN0cigxKSApICkge1xuXHRcdFx0Ly8gICAgICAgICAgICAgYnJlYWs7XG5cdFx0XHQvLyAgICAgICAgIH1cblx0XHRcdC8vICAgICB9XG5cblx0XHRcdC8vICAgICAvLyBJZiBwYXJlbnQgaXMgYW4gSURcblx0XHRcdC8vICAgICBpZiAoIHBhcmVudFR5cGUgPT09ICcjJyApIHtcblx0XHRcdC8vICAgICAgICAgaWYgKCBlbGVtLmlkID09PSBwYXJlbnQuc3Vic3RyKDEpICkge1xuXHRcdFx0Ly8gICAgICAgICAgICAgYnJlYWs7XG5cdFx0XHQvLyAgICAgICAgIH1cblx0XHRcdC8vICAgICB9XG5cblx0XHRcdC8vICAgICAvLyBJZiBwYXJlbnQgaXMgYSBkYXRhIGF0dHJpYnV0ZVxuXHRcdFx0Ly8gICAgIGlmICggcGFyZW50VHlwZSA9PT0gJ1snICkge1xuXHRcdFx0Ly8gICAgICAgICBpZiAoIGVsZW0uaGFzQXR0cmlidXRlKCBwYXJlbnQuc3Vic3RyKDEsIHBhcmVudC5sZW5ndGggLSAxKSApICkge1xuXHRcdFx0Ly8gICAgICAgICAgICAgYnJlYWs7XG5cdFx0XHQvLyAgICAgICAgIH1cblx0XHRcdC8vICAgICB9XG5cblx0XHRcdC8vICAgICAvLyBJZiBwYXJlbnQgaXMgYSB0YWdcblx0XHRcdC8vICAgICBpZiAoIGVsZW0udGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSBwYXJlbnQgKSB7XG5cdFx0XHQvLyAgICAgICAgIGJyZWFrO1xuXHRcdFx0Ly8gICAgIH1cblxuXHRcdFx0Ly8gfVxuXG5cdFx0XHRpZiAocGFyZW50KSB7XG5cdFx0XHRcdGlmIChwYXJlbnQgPT09IGVsZW0pIHtcblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHRpZiAoc2VsZWN0b3IpIHtcblxuXHRcdFx0XHQvLyBJZiBzZWxlY3RvciBpcyBhIGNsYXNzXG5cdFx0XHRcdGlmIChzZWxlY3RvclR5cGUgPT09ICcuJykge1xuXHRcdFx0XHRcdGlmIChlbGVtLmNsYXNzTGlzdC5jb250YWlucyhzZWxlY3Rvci5zdWJzdHIoMSkpKSB7XG5cdFx0XHRcdFx0XHRwYXJlbnRzLnB1c2goZWxlbSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cblx0XHRcdFx0Ly8gSWYgc2VsZWN0b3IgaXMgYW4gSURcblx0XHRcdFx0aWYgKHNlbGVjdG9yVHlwZSA9PT0gJyMnKSB7XG5cdFx0XHRcdFx0aWYgKGVsZW0uaWQgPT09IHNlbGVjdG9yLnN1YnN0cigxKSkge1xuXHRcdFx0XHRcdFx0cGFyZW50cy5wdXNoKGVsZW0pO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXG5cdFx0XHRcdC8vIElmIHNlbGVjdG9yIGlzIGEgZGF0YSBhdHRyaWJ1dGVcblx0XHRcdFx0aWYgKHNlbGVjdG9yVHlwZSA9PT0gJ1snKSB7XG5cdFx0XHRcdFx0aWYgKGVsZW0uaGFzQXR0cmlidXRlKHNlbGVjdG9yLnN1YnN0cigxLCBzZWxlY3Rvci5sZW5ndGggLSAxKSkpIHtcblx0XHRcdFx0XHRcdHBhcmVudHMucHVzaChlbGVtKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblxuXHRcdFx0XHQvLyBJZiBzZWxlY3RvciBpcyBhIHRhZ1xuXHRcdFx0XHRpZiAoZWxlbS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09IHNlbGVjdG9yKSB7XG5cdFx0XHRcdFx0cGFyZW50cy5wdXNoKGVsZW0pO1xuXHRcdFx0XHR9XG5cblx0XHRcdH1cblx0XHRcdGVsc2Uge1xuXHRcdFx0XHRwYXJlbnRzLnB1c2goZWxlbSk7XG5cdFx0XHR9XG5cblx0XHR9XG5cblx0XHRyZXR1cm4gcGFyZW50cztcblxuXHR9O1xuXG59KSgpO1xuXG53aW5kb3cudWNmaXJzdCA9IGZ1bmN0aW9uKHN0cmluZykge1xuXHRyZXR1cm4gc3RyaW5nLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgc3RyaW5nLnNsaWNlKDEpO1xufTtcblxuLyohXG4gQXV0aG9yOiBTdGVwaGVuIEtvcmVja3lcbiBXZWJzaXRlOiBodHRwOi8vc3RlcGhlbmtvcmVja3kuY29tXG4gUGx1Z2luIFdlYnNpdGU6IGh0dHA6Ly9naXRodWIuY29tL3Nrb3JlY2t5L0FkZC1DbGVhclxuIFZlcnNpb246IDIuMC41XG4gVGhlIE1JVCBMaWNlbnNlIChNSVQpXG4gQ29weXJpZ2h0IChjKSAyMDE1IFN0ZXBoZW4gS29yZWNreVxuIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluIGFsbFxuIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFXG4gU09GVFdBUkUuXG4qL1xuXG47XG4oZnVuY3Rpb24oJCwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkKSB7XG5cblx0Ly8gQ3JlYXRlIHRoZSBkZWZhdWx0cyBvbmNlXG5cdHZhciBwbHVnaW5OYW1lID0gXCJhZGRDbGVhclwiLFxuXHRcdGRlZmF1bHRzID0ge1xuXHRcdFx0Y2xvc2VTeW1ib2w6IFwiJiMxMDAwNjtcIixcblx0XHRcdGNvbG9yOiBcIiNDQ0NcIixcblx0XHRcdHRvcDogLTEsXG5cdFx0XHRyaWdodDogOCxcblx0XHRcdHJldHVybkZvY3VzOiB0cnVlLFxuXHRcdFx0c2hvd09uTG9hZDogZmFsc2UsXG5cdFx0XHRvbkNsZWFyOiBudWxsLFxuXHRcdFx0aGlkZU9uQmx1cjogZmFsc2UsXG5cdFx0XHR0YWJiYWJsZTogdHJ1ZVxuXHRcdH07XG5cblx0Ly8gVGhlIGFjdHVhbCBwbHVnaW4gY29uc3RydWN0b3Jcblx0ZnVuY3Rpb24gUGx1Z2luKGVsZW1lbnQsIG9wdGlvbnMpIHtcblx0XHR0aGlzLmVsZW1lbnQgPSBlbGVtZW50O1xuXG5cdFx0dGhpcy5vcHRpb25zID0gJC5leHRlbmQoe30sIGRlZmF1bHRzLCBvcHRpb25zKTtcblxuXHRcdHRoaXMuX2RlZmF1bHRzID0gZGVmYXVsdHM7XG5cdFx0dGhpcy5fbmFtZSA9IHBsdWdpbk5hbWU7XG5cblx0XHR0aGlzLmluaXQoKTtcblx0fVxuXG5cdFBsdWdpbi5wcm90b3R5cGUgPSB7XG5cblx0XHRpbml0OiBmdW5jdGlvbigpIHtcblx0XHRcdHZhciAkdGhpcyA9ICQodGhpcy5lbGVtZW50KSxcblx0XHRcdFx0JGNsZWFyQnV0dG9uLFxuXHRcdFx0XHRtZSA9IHRoaXMsXG5cdFx0XHRcdG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7XG5cblx0XHRcdCR0aGlzLndyYXAoXCI8c3BhbiBzdHlsZT0ncG9zaXRpb246cmVsYXRpdmU7JyBjbGFzcz0nYWRkLWNsZWFyLXNwYW4nPjwvc3Bhbj5cIik7XG5cdFx0XHR2YXIgdGFiSW5kZXggPSBvcHRpb25zLnRhYmJhYmxlID8gXCJcIiA6IFwiIHRhYmluZGV4PSctMSdcIjtcblx0XHRcdCRjbGVhckJ1dHRvbiA9ICQoXCI8YSBocmVmPScjY2xlYXInIHN0eWxlPSdkaXNwbGF5OiBub25lOydcIiArIHRhYkluZGV4ICsgXCI+XCIgKyBvcHRpb25zLmNsb3NlU3ltYm9sICsgXCI8L2E+XCIpO1xuXHRcdFx0JHRoaXMuYWZ0ZXIoJGNsZWFyQnV0dG9uKTtcblx0XHRcdCR0aGlzLm5leHQoKS5jc3Moe1xuXHRcdFx0XHRjb2xvcjogb3B0aW9ucy5jb2xvcixcblx0XHRcdFx0J3RleHQtZGVjb3JhdGlvbic6ICdub25lJyxcblx0XHRcdFx0ZGlzcGxheTogJ25vbmUnLFxuXHRcdFx0XHQnbGluZS1oZWlnaHQnOiAxLFxuXHRcdFx0XHRvdmVyZmxvdzogJ2hpZGRlbicsXG5cdFx0XHRcdHBvc2l0aW9uOiAnYWJzb2x1dGUnLFxuXHRcdFx0XHRyaWdodDogb3B0aW9ucy5yaWdodCxcblx0XHRcdFx0dG9wOiBvcHRpb25zLnRvcFxuXHRcdFx0fSwgdGhpcyk7XG5cblx0XHRcdGlmICgkdGhpcy52YWwoKS5sZW5ndGggPj0gMSAmJiBvcHRpb25zLnNob3dPbkxvYWQgPT09IHRydWUpIHtcblx0XHRcdFx0JGNsZWFyQnV0dG9uLmNzcyh7XG5cdFx0XHRcdFx0ZGlzcGxheTogJ2Jsb2NrJ1xuXHRcdFx0XHR9KTtcblx0XHRcdH1cblxuXHRcdFx0JHRoaXMuZm9jdXMoZnVuY3Rpb24oKSB7XG5cdFx0XHRcdGlmICgkKHRoaXMpLnZhbCgpLmxlbmd0aCA+PSAxKSB7XG5cdFx0XHRcdFx0JGNsZWFyQnV0dG9uLmNzcyh7XG5cdFx0XHRcdFx0XHRkaXNwbGF5OiAnYmxvY2snXG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXG5cdFx0XHQkdGhpcy5ibHVyKGZ1bmN0aW9uKGUpIHtcblx0XHRcdFx0aWYgKG9wdGlvbnMuaGlkZU9uQmx1cikge1xuXHRcdFx0XHRcdHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG5cdFx0XHRcdFx0XHR2YXIgcmVsYXRlZFRhcmdldCA9IGUucmVsYXRlZFRhcmdldCB8fCBlLmV4cGxpY2l0T3JpZ2luYWxUYXJnZXQgfHwgZG9jdW1lbnQuYWN0aXZlRWxlbWVudDtcblx0XHRcdFx0XHRcdGlmIChyZWxhdGVkVGFyZ2V0ICE9PSAkY2xlYXJCdXR0b25bMF0pIHtcblx0XHRcdFx0XHRcdFx0JGNsZWFyQnV0dG9uLmNzcyh7XG5cdFx0XHRcdFx0XHRcdFx0ZGlzcGxheTogJ25vbmUnXG5cdFx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH0sIDApO1xuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblxuXHRcdFx0dmFyIGhhbmRsZVVzZXJJbnB1dCA9IGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRpZiAoJCh0aGlzKS52YWwoKS5sZW5ndGggPj0gMSkge1xuXHRcdFx0XHRcdCRjbGVhckJ1dHRvbi5jc3Moe1xuXHRcdFx0XHRcdFx0ZGlzcGxheTogJ2Jsb2NrJ1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGVsc2Uge1xuXHRcdFx0XHRcdCRjbGVhckJ1dHRvbi5jc3Moe1xuXHRcdFx0XHRcdFx0ZGlzcGxheTogJ25vbmUnXG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH1cblx0XHRcdH07XG5cblx0XHRcdHZhciBoYW5kbGVJbnB1dCA9IGZ1bmN0aW9uKCkge1xuXHRcdFx0XHQkdGhpcy5vZmYoJ2tleXVwJywgaGFuZGxlVXNlcklucHV0KTtcblx0XHRcdFx0JHRoaXMub2ZmKCdjdXQnLCBoYW5kbGVVc2VySW5wdXQpO1xuXHRcdFx0XHRoYW5kbGVJbnB1dCA9IGhhbmRsZVVzZXJJbnB1dDtcblx0XHRcdFx0aGFuZGxlVXNlcklucHV0LmNhbGwodGhpcyk7XG5cdFx0XHR9O1xuXG5cdFx0XHQkdGhpcy5vbigna2V5dXAnLCBoYW5kbGVVc2VySW5wdXQpO1xuXG5cdFx0XHQkdGhpcy5vbignY3V0JywgZnVuY3Rpb24oKSB7XG5cdFx0XHRcdHZhciBzZWxmID0gdGhpcztcblx0XHRcdFx0c2V0VGltZW91dChmdW5jdGlvbigpIHtcblx0XHRcdFx0XHRoYW5kbGVVc2VySW5wdXQuY2FsbChzZWxmKTtcblx0XHRcdFx0fSwgMCk7XG5cdFx0XHR9KTtcblxuXHRcdFx0JHRoaXMub24oJ2lucHV0JywgZnVuY3Rpb24oKSB7XG5cdFx0XHRcdGhhbmRsZUlucHV0LmNhbGwodGhpcyk7XG5cdFx0XHR9KTtcblxuXHRcdFx0aWYgKG9wdGlvbnMuaGlkZU9uQmx1cikge1xuXHRcdFx0XHQkY2xlYXJCdXR0b24uYmx1cihmdW5jdGlvbigpIHtcblx0XHRcdFx0XHQkY2xlYXJCdXR0b24uY3NzKHtcblx0XHRcdFx0XHRcdGRpc3BsYXk6ICdub25lJ1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9KTtcblx0XHRcdH1cblxuXHRcdFx0JGNsZWFyQnV0dG9uLmNsaWNrKGZ1bmN0aW9uKGUpIHtcblx0XHRcdFx0dmFyICRpbnB1dCA9ICQobWUuZWxlbWVudCk7XG5cdFx0XHRcdCRpbnB1dC52YWwoXCJcIikudHJpZ2dlcihcImtleXVwXCIpO1xuXHRcdFx0XHQkKHRoaXMpLmNzcyh7XG5cdFx0XHRcdFx0ZGlzcGxheTogJ25vbmUnXG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRpZiAob3B0aW9ucy5yZXR1cm5Gb2N1cyA9PT0gdHJ1ZSkge1xuXHRcdFx0XHRcdCRpbnB1dC5mb2N1cygpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGlmIChvcHRpb25zLm9uQ2xlYXIpIHtcblx0XHRcdFx0XHRvcHRpb25zLm9uQ2xlYXIoJGlucHV0KTtcblx0XHRcdFx0fVxuXHRcdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHR9KTtcblx0XHR9XG5cblx0fTtcblxuXHQkLmZuW3BsdWdpbk5hbWVdID0gZnVuY3Rpb24ob3B0aW9ucykge1xuXHRcdHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7XG5cdFx0XHRpZiAoISQuZGF0YSh0aGlzLCBcInBsdWdpbl9cIiArIHBsdWdpbk5hbWUpKSB7XG5cdFx0XHRcdCQuZGF0YSh0aGlzLCBcInBsdWdpbl9cIiArIHBsdWdpbk5hbWUsXG5cdFx0XHRcdFx0bmV3IFBsdWdpbih0aGlzLCBvcHRpb25zKSk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH07XG5cbn0pKGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCk7XG5kMjAuam91cm5hbCA9IGQyMC5qb3VybmFsIHx8IHt9O1xuZDIwLmNvbXBlbmRpdW0gPSBkMjAuY29tcGVuZGl1bSB8fCB7fTtcblxuZDIwLmpvdXJuYWwuY2hhcnNoZWV0TG9hZFJlc29sdmUgPSBudWxsO1xuZDIwLmpvdXJuYWwuY2hhcnNoZWV0TG9hZFJlamVjdCA9IG51bGw7XG5kMjAuam91cm5hbC5jaGFyc2hlZXRMb2FkUHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0ZDIwLmpvdXJuYWwuY2hhcnNoZWV0TG9hZFJlc29sdmUgPSByZXNvbHZlO1xuXHRkMjAuam91cm5hbC5jaGFyc2hlZXRMb2FkUmVqZWN0ID0gcmVqZWN0O1xufSk7XG5cbmQyMC5qb3VybmFsLnNhbmRib3hMb2FkUmVzb2x2ZSA9IG51bGw7XG5kMjAuam91cm5hbC5zYW5kYm94TG9hZFJlamVjdCA9IG51bGw7XG5kMjAuam91cm5hbC5zYW5kYm94TG9hZFByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdGQyMC5qb3VybmFsLnNhbmRib3hMb2FkUmVzb2x2ZSA9IHJlc29sdmU7XG5cdGQyMC5qb3VybmFsLnNhbmRib3hMb2FkUmVqZWN0ID0gcmVqZWN0O1xufSk7XG5cbmQyMC5jb21wZW5kaXVtLmNvbXBlbmRpdW1Mb2FkUmVzb2x2ZSA9IG51bGw7XG5kMjAuY29tcGVuZGl1bS5jb21wZW5kaXVtTG9hZFJlamVjdCA9IG51bGw7XG5kMjAuY29tcGVuZGl1bS5jb21wZW5kaXVtTG9hZFByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cdGQyMC5jb21wZW5kaXVtLmNvbXBlbmRpdW1Mb2FkUmVzb2x2ZSA9IHJlc29sdmU7XG5cdGQyMC5jb21wZW5kaXVtLmNvbXBlbmRpdW1Mb2FkUmVqZWN0ID0gcmVqZWN0O1xufSk7XG5kMjAuam91cm5hbC51c2luZ0ZhbGxiYWNrID0gZmFsc2U7XG5cbmNsYXNzIENoYXJzaGVldEZhbGxiYWNrRXJyb3IgZXh0ZW5kcyBFcnJvciB7XG5cdGNvbnN0cnVjdG9yKC4uLnBhcmFtcykge1xuXHRcdHN1cGVyKC4uLnBhcmFtcyk7XG5cblx0XHRpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHtcblx0XHRcdEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIENoYXJzaGVldEZhbGxiYWNrRXJyb3IpO1xuXHRcdH1cblxuXHRcdHRoaXMubmFtZSA9ICdDaGFyc2hlZXRGYWxsYmFja0Vycm9yJztcblx0fVxufVxuXG5jb25zdCBnZXRFcnJvck1lc3NhZ2UgPSAoZXJyb3IpID0+IHtcblx0dHJ5IHtcblx0XHRyZXR1cm4gYENoYXJzaGVldCBGYWxsYmFjazogQ29kZTogJHtlcnJvci5zdGF0dXN9OyBTdGF0dXM6ICR7ZXJyb3Iuc3RhdHVzVGV4dH1gO1xuXHR9IGNhdGNoIChlKSB7XG5cdFx0cmV0dXJuICdDaGFyc2hlZXQgRmFsbGJhY2s6IFVua293biBFcnJvcic7XG5cdH1cbn07XG5cbmNvbnN0IGdldFRpbWluZ0ZvclJldHJpZXMgPSAocmV0cmllcykgPT4ge1xuXHRzd2l0Y2ggKHJldHJpZXMpIHtcblx0XHRjYXNlIDE6XG5cdFx0XHRyZXR1cm4geyB0aW1lb3V0OiAxNTAwMCwgZGVsYXk6IDIwMDAgfTtcblx0XHRjYXNlIDI6XG5cdFx0XHRyZXR1cm4geyB0aW1lb3V0OiAzMDAwMCwgZGVsYXk6IDUwMDAgfTtcblx0XHRkZWZhdWx0OlxuXHRcdFx0cmV0dXJuIHsgdGltZW91dDogNTAwMCwgZGVsYXk6IDEwMCB9O1xuXHR9XG59O1xuXG5mdW5jdGlvbiBnZXRDaGFyc2hlZXREYXRhKHByb3BzID0gW10pIHtcblx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRsZXQgcmV0cmllcyA9IDA7XG5cblx0XHRjb25zdCBzZW5kUmVxdWVzdCA9ICgpID0+IHtcblx0XHRcdGNvbnN0IHsgdGltZW91dCwgZGVsYXkgfSA9IGdldFRpbWluZ0ZvclJldHJpZXMocmV0cmllcyk7XG5cblx0XHRcdCQuYWpheCh7XG5cdFx0XHRcdHVybDogYCR7Q0hBUlNIRUVUX1VSTH0vZ3JhcGhxbGAsXG5cdFx0XHRcdHR5cGU6ICdQT1NUJyxcblx0XHRcdFx0ZGF0YTogeyBxdWVyeTogYHtjaGFyYWN0ZXJTaGVldChzaG9ydG5hbWU6IFwiJHtDSEFSU0hFRVRfTkFNRX1cIiwgY2FtcGFpZ25JZDogJHtjYW1wYWlnbl9pZH0peyR7cHJvcHMuam9pbigpfX19YCB9LFxuXHRcdFx0XHR0aW1lb3V0LFxuXHRcdFx0XHRlcnJvcjogKGVycm9yKSA9PiB7XG5cdFx0XHRcdFx0aWYgKHJldHJpZXMgPCAyKSB7XG5cdFx0XHRcdFx0XHRyZXRyaWVzICs9IDE7XG5cdFx0XHRcdFx0XHRzZXRUaW1lb3V0KHNlbmRSZXF1ZXN0LCBkZWxheSk7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdHJlamVjdChlcnJvcik7XG5cdFx0XHRcdFx0XHRpZiAoIWQyMC5qb3VybmFsLnVzaW5nRmFsbGJhY2spIHtcblx0XHRcdFx0XHRcdFx0ZDIwLmpvdXJuYWwudXNpbmdGYWxsYmFjayA9IHRydWU7XG5cdFx0XHRcdFx0XHRcdHRocm93IG5ldyBDaGFyc2hlZXRGYWxsYmFja0Vycm9yKGdldEVycm9yTWVzc2FnZShlcnJvcikpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSxcblx0XHRcdFx0c3VjY2VzczogKHJlc3VsdCkgPT4ge1xuXHRcdFx0XHRcdGlmIChyZXN1bHQuZXJyb3JzKSByZWplY3QocmVzdWx0LmVycm9ycyk7XG5cblx0XHRcdFx0XHRpZiAocmVzdWx0LmRhdGEgJiYgcmVzdWx0LmRhdGEuY2hhcmFjdGVyU2hlZXQpIHtcblx0XHRcdFx0XHRcdHJlc29sdmUocmVzdWx0LmRhdGEuY2hhcmFjdGVyU2hlZXQpO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRyZWplY3QoKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0sXG5cdFx0XHR9KTtcblx0XHR9O1xuXG5cdFx0aWYgKENIQVJTSEVFVF9OQU1FID09PSAnY3VzdG9tJykge1xuXHRcdFx0Ly8gRm9yIG5vdywgYWx3YXlzIHVzZSB0aGUgZmFsbGJhY2sgZm9yIGEgY3VzdG9tIHNoZWV0XG5cdFx0XHRyZWplY3QoJ0NVU1RPTScpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRzZW5kUmVxdWVzdCgpO1xuXHRcdH1cblx0fSk7XG59XG5cbmZ1bmN0aW9uIGdldENoYXJzaGVldERhdGFGYWxsYmFjaygpIHtcblx0Y29uc3QgdXJsID0gQ0hBUlNIRUVUX05BTUUgPT09ICdjdXN0b20nID8gYC9lZGl0b3IvY3VzdG9tY2hhcnNoZWV0ZGF0YS8ke2NhbXBhaWduX2lkfWAgOiBgL2VkaXRvci9jaGFyc2hlZXRkYXRhLyR7Y2FtcGFpZ25faWR9YDtcblxuXHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdGxldCByZXRyaWVzID0gMDtcblxuXHRcdGNvbnN0IHNlbmRSZXF1ZXN0ID0gKCkgPT4ge1xuXHRcdFx0JC5hamF4KHtcblx0XHRcdFx0dXJsLFxuXHRcdFx0XHR0eXBlOiAnR0VUJyxcblx0XHRcdFx0ZXJyb3I6IChlcnJvcikgPT4ge1xuXHRcdFx0XHRcdGlmIChyZXRyaWVzIDwgMikge1xuXHRcdFx0XHRcdFx0cmV0cmllcyArPSAxO1xuXHRcdFx0XHRcdFx0c2VuZFJlcXVlc3QoKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0cmVqZWN0KGVycm9yKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0sXG5cdFx0XHRcdHN1Y2Nlc3M6IChyZXN1bHQpID0+IHtcblx0XHRcdFx0XHRjb25zdCBwYXJzZWRSZXN1bHQgPSBKU09OLnBhcnNlKHJlc3VsdCk7XG5cdFx0XHRcdFx0cmVzb2x2ZShwYXJzZWRSZXN1bHQpO1xuXHRcdFx0XHR9LFxuXHRcdFx0fSk7XG5cdFx0fTtcblxuXHRcdHNlbmRSZXF1ZXN0KCk7XG5cdH0pO1xufVxuXG5kMjAuam91cm5hbC5sb2FkQ3VzdG9tQ2hhcnNoZWV0ID0gYXN5bmMgKCkgPT4ge1xuXHRhd2FpdCBkMjAuam91cm5hbC5jaGFyc2hlZXRGZXRjaFByb21pc2U7XG5cblx0bGV0ICRsYXlvdXRmcmFnID0gJChgPGRpdiBjbGFzcz0ncm9vdCc+JHtkMjAuam91cm5hbC5jdXN0b21TaGVldHMubGF5b3V0aHRtbH08L2Rpdj5gKTtcblx0JGxheW91dGZyYWcgPSBkMjAudXRpbHMuaHRtbFRyYW5zbGF0b3IoJGxheW91dGZyYWcpO1xuXG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5hdmFpbGFibGVSb2xscyA9IHt9O1xuXHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMuYXZhaWxhYmxlQWN0aW9ucyA9IHt9O1xuXHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMuYXZhaWxhYmxlQXR0cmlidXRlcyA9IHt9O1xuXHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMucmVzZXJ2ZWRBdHRyaWJ1dGVzID0ge307XG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy50b2tlbkFjdGlvbnMgPSBbXTtcblx0ZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzLmF0dHJEZXBzID0ge307XG5cblx0ZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzLmV2ZW50TGlzdGVuZXJzID0gW107XG5cblx0Y29uc3QgYXR0cnJlZ2V4ID0gL0B7W159XSt9L2c7XG5cblx0ZDIwLmpvdXJuYWwudXBkYXRlU2hlZXREZXBzID0gZnVuY3Rpb24gKGF0dHJuYW1lLCBhdHRydmFsKSB7XG5cdFx0Y29uc3QgaW5jbHVkZWRBdHRyaWJ1dGVzID0gYXR0cnZhbC5tYXRjaChhdHRycmVnZXgpO1xuXG5cdFx0aWYgKCFpbmNsdWRlZEF0dHJpYnV0ZXMpIHJldHVybiB0cnVlO1xuXG5cdFx0Zm9yIChsZXQgamogPSAwOyBqaiA8IGluY2x1ZGVkQXR0cmlidXRlcy5sZW5ndGg7IGpqKyspIHtcblx0XHRcdGNvbnN0IGluY2x1ZGVkQXR0ck5hbWUgPSBpbmNsdWRlZEF0dHJpYnV0ZXNbampdLnN1YnN0cmluZygyLCBpbmNsdWRlZEF0dHJpYnV0ZXNbampdLmxlbmd0aCAtIDEpLnRvTG93ZXJDYXNlKCk7XG5cdFx0XHRpZiAoIWQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5hdHRyRGVwc1tpbmNsdWRlZEF0dHJOYW1lXSkgZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzLmF0dHJEZXBzW2luY2x1ZGVkQXR0ck5hbWVdID0gW107XG5cdFx0XHRpZiAoZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzLmF0dHJEZXBzW2luY2x1ZGVkQXR0ck5hbWVdLmluZGV4T2YoYXR0cm5hbWUudG9Mb3dlckNhc2UoKSkgPT09IC0xKSB7XG5cdFx0XHRcdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5hdHRyRGVwc1tpbmNsdWRlZEF0dHJOYW1lXS5wdXNoKGF0dHJuYW1lLnRvTG93ZXJDYXNlKCkpO1xuXHRcdFx0fVxuXHRcdH1cblx0fTtcblxuXHQkbGF5b3V0ZnJhZy5maW5kKCdidXR0b25bdHlwZT1yb2xsXScpLmVhY2goZnVuY3Rpb24gKCkge1xuXHRcdC8vIEFzc3VtZSBpdCBzdGFydHMgd2l0aCArIHN0cmlwIG91dCBcInJvbGxfXCIgaW4gdGhlIFwibmFtZVwiIGF0dHJpYnV0ZVxuXHRcdGNvbnN0ICR0aGlzZWwgPSAkKHRoaXMpO1xuXHRcdGNvbnN0IF8kZmllbGRzZXQgPSAkdGhpc2VsLnBhcmVudHMoJ2ZpZWxkc2V0Jyk7XG5cdFx0Y29uc3QgX3JvbGxwcmVmaXggPSAoXyRmaWVsZHNldC5sZW5ndGggPiAwID8gYCR7XyRmaWVsZHNldC5hdHRyKCdjbGFzcycpfV9gIDogJycpO1xuXG5cdFx0aWYgKCR0aGlzZWwuYXR0cignbmFtZScpICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdGNvbnN0IF9yb2xsbmFtZSA9IF9yb2xscHJlZml4ICsgJHRoaXNlbC5hdHRyKCduYW1lJykuc3Vic3RyaW5nKDUsICR0aGlzZWwuYXR0cignbmFtZScpLmxlbmd0aCkudG9Mb3dlckNhc2UoKTtcblx0XHRcdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5hdmFpbGFibGVSb2xsc1tfcm9sbG5hbWVdID0gJHRoaXNlbC52YWwoKS5zcGxpdCgnXFxcXG4nKS5qb2luKCdcXG4nKTtcblx0XHRcdGlmICgkdGhpc2VsLmhhc0NsYXNzKCd0b2tlbmFjdGlvbicpKSB7XG5cdFx0XHRcdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy50b2tlbkFjdGlvbnMucHVzaChfcm9sbG5hbWUpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdCR0aGlzZWwuYWRkQ2xhc3MoJ2J0bicpO1xuXHR9KTtcblxuXHQvLyBHZXQgYSBsaXN0IG9mIGFjdGlvbiBidXR0b25zLCBzbyB3ZSBjYW4gdXNlIHRoZW0gaW4gbWFjcm9zXG5cdCRsYXlvdXRmcmFnLmZpbmQoJ2J1dHRvblt0eXBlPWFjdGlvbl0nKS5lYWNoKGZ1bmN0aW9uICgpIHtcblx0XHRjb25zdCAkdGhpc2VsID0gJCh0aGlzKTtcblx0XHRjb25zdCBmaWVsZHNldCA9ICR0aGlzZWwucGFyZW50cygnZmllbGRzZXQnKTtcblx0XHQvLyBQcmVmaXggd2l0aCByZXBlYXRpbmcgc2VjdGlvbiBuYW1lLCBpZiBpbiBvbmVcblx0XHRjb25zdCByb2xscHJlZml4ID0gKGZpZWxkc2V0Lmxlbmd0aCA+IDAgPyBgJHtmaWVsZHNldC5hdHRyKCdjbGFzcycpfV9gIDogJycpO1xuXG5cdFx0aWYgKCR0aGlzZWwuYXR0cignbmFtZScpICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdGNvbnN0IGJ1dHRvbk5hbWUgPSAkdGhpc2VsLmF0dHIoJ25hbWUnKS5yZXBsYWNlKC9eYWN0Xy8sICcnKTtcblx0XHRcdGNvbnN0IHJvbGxOYW1lID0gKHJvbGxwcmVmaXggKyBidXR0b25OYW1lKS50b0xvd2VyQ2FzZSgpO1xuXHRcdFx0ZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzLmF2YWlsYWJsZUFjdGlvbnNbcm9sbE5hbWVdID0gYnV0dG9uTmFtZTtcblx0XHR9XG5cdH0pO1xuXG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy50b2tlbkFjdGlvbnMgPSBfLnNvcnRCeShcblx0XHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMudG9rZW5BY3Rpb25zLCAoYWN0aW9ubmFtZSkgPT4gYWN0aW9ubmFtZVxuXHQpO1xuXG5cdGNvbnN0IGNoZWNrX2RlZmF1bHQgPSBmdW5jdGlvbiAoX2F0dHJuYW1lLCAkdGhpc2VsLCBkZWZhdWx0X3ZhbHVlKSB7XG5cdFx0aWYgKCFkMjAuam91cm5hbC5jdXN0b21TaGVldHMuYXZhaWxhYmxlQXR0cmlidXRlc1tfYXR0cm5hbWVdIHx8IChkMjAuam91cm5hbC5jdXN0b21TaGVldHMuYXZhaWxhYmxlQXR0cmlidXRlc1tfYXR0cm5hbWVdICYmICR0aGlzZWwudmFsKCkgJiYgJHRoaXNlbC52YWwoKSAhPSBkZWZhdWx0X3ZhbHVlKSkge1xuXHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0fVxuXHRcdHJldHVybiBmYWxzZTtcblx0fTtcblxuXHQkbGF5b3V0ZnJhZy5maW5kKCcqW25hbWVePVwiYXR0cl9cIl0nKS5lYWNoKGZ1bmN0aW9uICgpIHtcblx0XHRjb25zdCAkdGhpc2VsID0gJCh0aGlzKTtcblxuXHRcdGNvbnN0IF8kZnNldCA9ICR0aGlzZWwucGFyZW50cygnZmllbGRzZXQnKTtcblx0XHRsZXQgX3ByZWZpeCA9ICcnO1xuXHRcdGlmIChfJGZzZXQubGVuZ3RoID4gMCkge1xuXHRcdFx0Y29uc3QgY2xhc3NsaXN0ID0gXyRmc2V0WzBdLmNsYXNzTGlzdDtcblx0XHRcdGxldCBncm91cG5hbWU7XG5cdFx0XHRfLmVhY2goY2xhc3NsaXN0LCAodmFsKSA9PiB7XG5cdFx0XHRcdGlmICh2YWwuc3Vic3RyaW5nKDAsIDEwKSA9PT0gJ3JlcGVhdGluZ18nKSB7XG5cdFx0XHRcdFx0Z3JvdXBuYW1lID0gdmFsLnRvTG93ZXJDYXNlKCkucmVwbGFjZShcIidcIiwgJyZxdW90OycpO1xuXHRcdFx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0XHRpZiAoZ3JvdXBuYW1lKSBfcHJlZml4ID0gYCR7Z3JvdXBuYW1lfV9gO1xuXHRcdH1cblxuXHRcdGNvbnN0IF9hdHRybmFtZSA9IF9wcmVmaXggKyAkdGhpc2VsLmF0dHIoJ25hbWUnKS5zdWJzdHJpbmcoNSwgJHRoaXNlbC5hdHRyKCduYW1lJykubGVuZ3RoKS50b0xvd2VyQ2FzZSgpO1xuXG5cdFx0aWYgKHRoaXMudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAnaW5wdXQnICYmICR0aGlzZWwuYXR0cigndHlwZScpID09PSAnY2hlY2tib3gnICYmICR0aGlzZWwudmFsKCkgIT09IHVuZGVmaW5lZCAmJiBjaGVja19kZWZhdWx0KF9hdHRybmFtZSwgJHRoaXNlbCwgdW5kZWZpbmVkKSkge1xuXHRcdFx0aWYgKCR0aGlzZWwucHJvcCgnY2hlY2tlZCcpKSB7XG5cdFx0XHRcdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5hdmFpbGFibGVBdHRyaWJ1dGVzW19hdHRybmFtZV0gPSAkdGhpc2VsLnZhbCgpIHx8ICcnO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0ZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzLmF2YWlsYWJsZUF0dHJpYnV0ZXNbX2F0dHJuYW1lXSA9ICcwJztcblx0XHRcdH1cblx0XHR9IGVsc2UgaWYgKHRoaXMudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAnaW5wdXQnICYmICR0aGlzZWwuYXR0cigndHlwZScpID09PSAncmFkaW8nICYmICR0aGlzZWwudmFsKCkgIT09IHVuZGVmaW5lZCAmJiBjaGVja19kZWZhdWx0KF9hdHRybmFtZSwgJHRoaXNlbCwgdW5kZWZpbmVkKSkge1xuXHRcdFx0aWYgKCR0aGlzZWwucHJvcCgnY2hlY2tlZCcpKSB7XG5cdFx0XHRcdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5hdmFpbGFibGVBdHRyaWJ1dGVzW19hdHRybmFtZV0gPSAkdGhpc2VsLnZhbCgpIHx8ICcnO1xuXHRcdFx0fVxuXHRcdH0gZWxzZSBpZiAoJHRoaXNlbC5wcm9wKCdkaXNhYmxlZCcpKSB7XG5cdFx0XHRpZiAoIXRoaXMuYXR0cmlidXRlcy52YWx1ZSkge1xuXHRcdFx0XHRjb25zb2xlLmxvZygnU0hFRVQgRVJST1I6IFNwZWNpZmllZCBhIGRpc2FibGVkIGlucHV0IHdpdGhvdXQgYSB2YWxpZCBmb3JtdWxhIGluIHRoZSB2YWx1ZSBhdHRyaWJ1dGUuJyk7XG5cdFx0XHRcdHJldHVybiB0cnVlO1xuXHRcdFx0fVxuXHRcdFx0ZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzLmF2YWlsYWJsZUF0dHJpYnV0ZXNbX2F0dHJuYW1lXSA9IHRoaXMuYXR0cmlidXRlcy52YWx1ZS5ub2RlVmFsdWUgfHwgJyc7XG5cdFx0XHRkMjAuam91cm5hbC51cGRhdGVTaGVldERlcHMoX2F0dHJuYW1lLCBkMjAuam91cm5hbC5jdXN0b21TaGVldHMuYXZhaWxhYmxlQXR0cmlidXRlc1tfYXR0cm5hbWVdKTtcblx0XHRcdCR0aGlzZWwuYXR0cignZGF0YS1mb3JtdWxhJywgdGhpcy5hdHRyaWJ1dGVzLnZhbHVlLm5vZGVWYWx1ZSk7XG5cdFx0XHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMucmVzZXJ2ZWRBdHRyaWJ1dGVzW19hdHRybmFtZV0gPSB0cnVlO1xuXHRcdH0gZWxzZSBpZiAodGhpcy50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdzcGFuJykge1xuXHRcdFx0Ly8gaWYgaXQgYWxyZWFkeSBoYXMgYSB2YWx1ZSwga2VlcHMgdGhlIHZhbHVlLCBvdGhlcndpc2UgaXQgaXMgc2V0IHRvIHVuZGVmaW5lZFxuXHRcdFx0ZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzLmF2YWlsYWJsZUF0dHJpYnV0ZXNbX2F0dHJuYW1lXSA9IGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5hdmFpbGFibGVBdHRyaWJ1dGVzW19hdHRybmFtZV07XG5cdFx0fSBlbHNlIGlmIChjaGVja19kZWZhdWx0KF9hdHRybmFtZSwgJHRoaXNlbCwgJycpKSB7XG5cdFx0XHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMuYXZhaWxhYmxlQXR0cmlidXRlc1tfYXR0cm5hbWVdID0gJHRoaXNlbC52YWwoKSB8fCAnJztcblx0XHR9XG5cblx0XHQvLyBDaGVjayBmb3IgZHluYW1pYyBkZXBlbmRlbmNpZXNcblx0XHRpZiAoISR0aGlzZWwucHJvcCgnZGlzYWJsZWQnKSAmJiB0eXBlb2YgJHRoaXNlbC52YWwoKSA9PT0gJ3N0cmluZycgJiYgJHRoaXNlbC52YWwoKS5pbmRleE9mKCdAeycpICE9PSAtMSkge1xuXHRcdFx0ZDIwLmpvdXJuYWwudXBkYXRlU2hlZXREZXBzKF9hdHRybmFtZSwgJHRoaXNlbC52YWwoKSk7XG5cdFx0fVxuXHR9KTtcblxuXHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMubGF5b3V0aHRtbCA9ICRsYXlvdXRmcmFnLmh0bWwoKTtcblxuXHRjb25zdCBoZWFkID0gZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdO1xuXG5cdGlmIChkMjAuam91cm5hbC5jdXN0b21TaGVldHMuaWZyYW1lQ3NzKSB7XG5cdFx0ZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzLmlmcmFtZVN0eWxlRWwgPSBkMjAuam91cm5hbC5tYWtlQ3NzRWxlbWVudChkMjAuam91cm5hbC5jdXN0b21TaGVldHMuaWZyYW1lQ3NzKTtcblx0fVxuXG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5zdHlsZWVsID0gZDIwLmpvdXJuYWwubWFrZUNzc0VsZW1lbnQoZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzLmNzcyk7XG5cdCQoJ3N0eWxlW3RpdGxlPWNoYXJzaGVldF0nKS5yZW1vdmUoKTtcblx0aGVhZC5hcHBlbmRDaGlsZChkMjAuam91cm5hbC5jdXN0b21TaGVldHMuc3R5bGVlbCk7XG5cblx0ZDIwLmpvdXJuYWwuY2hhcnNoZWV0TG9hZFJlc29sdmUoKTtcbn07XG5cbmQyMC5qb3VybmFsLm1ha2VDc3NFbGVtZW50ID0gKGNzcykgPT4ge1xuXHRjb25zdCBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7XG5cblx0c3R5bGUudHlwZSA9ICd0ZXh0L2Nzcyc7XG5cdHN0eWxlLnRpdGxlID0gJ2NoYXJzaGVldCc7XG5cdGlmIChzdHlsZS5zdHlsZVNoZWV0KSB7XG5cdFx0c3R5bGUuc3R5bGVTaGVldC5jc3NUZXh0ID0gY3NzO1xuXHR9IGVsc2Uge1xuXHRcdHN0eWxlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGNzcykpO1xuXHR9XG5cdHJldHVybiBzdHlsZTtcbn07XG5cbmNvbnN0IGh0bWxTYW5pdGl6ZUxlZ2FjeSA9IChkaXJ0eUh0bWwpID0+IHtcblx0bGV0IGFsbG93ZWQgPSAnPGJyPjxpbnB1dD48dGV4dGFyZWE+PGRpdj48c3Bhbj48bGFiZWw+PGhyPjxpbWc+PGI+PGk+PHN0cm9uZz48ZW0+PGgxPjxoMj48aDM+PGg0PjxoNT48aDY+PHA+PGhyPjx0YWJsZT48dHI+PHRkPjx0Ym9keT48dGhlYWQ+PHRoPjx0Zm9vdD48c2VsZWN0PjxvcHRpb24+PGZpZWxkc2V0PjxidXR0b24+PHVsPjxsaT48b2w+PGNhcHRpb24+Jztcblx0Ly8gUmVtb3ZlIGFueXRoaW5nIGluIDxtb2JpbGU+IHRhZ3Ncblx0bGV0IGlucHV0ID0gZGlydHlIdG1sLnJlcGxhY2UoLzxtb2JpbGVcXHMqPltcXHNcXFNdKj88XFwvbW9iaWxlXFxzKj58PFxcLyp3ZWJcXHMqPnw8XFwvKm1vYmlsZVxccyo+L2csICcnKTtcblx0Ly8gU3RyaXBzIEhUTUwgYW5kIFBIUCB0YWdzIGZyb20gYSBzdHJpbmdcblx0aWYgKGFsbG93ZWQgIT09IHVuZGVmaW5lZCkge1xuXHRcdGlucHV0ID0gaHRtbF9zYW5pdGl6ZShcblx0XHRcdGlucHV0LFxuXHRcdFx0KHVybCkgPT4ge1xuXHRcdFx0XHRjb25zdCBtYXRjaCA9IHVybC50b1N0cmluZygpO1xuXHRcdFx0XHRjb25zdCBub3Byb3h5ID0gWydodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvJywgJ2h0dHA6Ly9pbWdzcnYucm9sbDIwLm5ldCcsICdodHRwczovL2ltZ3Nydi5yb2xsMjAubmV0JywgaW1nc3J2X3VybCwgJ2h0dHBzOi8vYXBwLnJvbGwyMC5uZXQnLCAnaHR0cHM6Ly9zdG9yYWdlLmdvb2dsZWFwaXMuY29tL2NoYXItc2hlZXQtYXBwLWltYWdlcy02ZTEwMTQxMSddO1xuXG5cdFx0XHRcdGZvciAobGV0IGkgPSAwOyBpIDwgbm9wcm94eS5sZW5ndGg7IGkrKykge1xuXHRcdFx0XHRcdGlmIChtYXRjaC5zdWJzdHJpbmcoMCwgbm9wcm94eVtpXS5sZW5ndGgpID09PSBub3Byb3h5W2ldKSB7XG5cdFx0XHRcdFx0XHRyZXR1cm4gbWF0Y2g7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHRcdGlmICgvXmh0dHBzPzpcXC9cXC8vLnRlc3QobWF0Y2gpKSB7XG5cdFx0XHRcdFx0cmV0dXJuIGAke2ltZ3Nydl91cmx9P3NyYz0ke2VzY2FwZShtYXRjaCl9YDtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdHJldHVybiAnJztcblx0XHRcdH0sXG5cdFx0XHQoZ3JvdXBpZCkgPT4ge1xuXHRcdFx0XHRjb25zdCBjbGFzc2VzID0gZ3JvdXBpZC5zcGxpdCgnICcpO1xuXHRcdFx0XHRfLmVhY2goY2xhc3NlcywgKGlkLCBpZHgpID0+IHtcblx0XHRcdFx0XHRpZiAoaWQuc3Vic3RyaW5nKDAsIDUpID09PSAnYXR0cl8nIHx8IGlkLnN1YnN0cmluZygwLCA2KSA9PT0gJ3NoZWV0LScgfHwgaWQuc3Vic3RyaW5nKDAsIDEwKSA9PT0gJ3JlcGVhdGluZ18nIHx8IGlkLnN1YnN0cmluZygwLCA1KSA9PT0gJ3JvbGxfJyB8fCBpZC5zdWJzdHJpbmcoMCwgNCkgPT09ICdhY3RfJyB8fCBpZCA9PT0gJ3Rva2VuYWN0aW9uJyB8fCBpZC5zdWJzdHJpbmcoMCwgNSkgPT09ICdjb21wXycpIHtcblx0XHRcdFx0XHRcdGNsYXNzZXNbaWR4XSA9IGlkO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRjbGFzc2VzW2lkeF0gPSBgc2hlZXQtJHtpZH1gO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSk7XG5cdFx0XHRcdHJldHVybiBjbGFzc2VzLmpvaW4oJyAnKTtcblx0XHRcdH0sXG5cdFx0KTtcblx0fVxuXHRhbGxvd2VkID0gKChgJHthbGxvd2VkIHx8ICcnfWApLnRvTG93ZXJDYXNlKCkubWF0Y2goLzxbYS16XVthLXowLTldKj4vZykgfHwgW10pLmpvaW4oJycpOyAvLyBtYWtpbmcgc3VyZSB0aGUgYWxsb3dlZCBhcmcgaXMgYSBzdHJpbmcgY29udGFpbmluZyBvbmx5IHRhZ3MgaW4gbG93ZXJjYXNlICg8YT48Yj48Yz4pXG5cdGNvbnN0IHRhZ3MgPSAvPFxcLz8oW2Etel1bYS16MC05XSopXFxiW14+XSo+L2dpO1xuXHRjb25zdCBjb21tZW50c0FuZFBocFRhZ3MgPSAvPCEtLVtcXHNcXFNdKj8tLT58PFxcPyg/OnBocCk/W1xcc1xcU10qP1xcPz4vZ2k7XG5cdHJldHVybiBpbnB1dC5yZXBsYWNlKGNvbW1lbnRzQW5kUGhwVGFncywgJycpLnJlcGxhY2UodGFncywgKCQwLCAkMSkgPT4gKGFsbG93ZWQuaW5kZXhPZihgPCR7JDEudG9Mb3dlckNhc2UoKX0+YCkgPiAtMSA/ICQwIDogJycpKTtcbn07XG5cbmNvbnN0IGh0bWxTYW5pdGl6ZSA9IChkaXJ0eUh0bWwsIGxlZ2FjeSA9IGZhbHNlKSA9PiB7XG5cdGNvbnN0IHRhZ3MgPSBbJ2EnLCAnYWJicicsICdhZGRyZXNzJywgJ2FydGljbGUnLCAnYXNpZGUnLCAnYicsICdiZGknLCAnYmRvJywgJ2Jsb2NrcXVvdGUnLCAnYnInLCAnYnV0dG9uJywgJ2NhcHRpb24nLFxuXHRcdCdjaXRlJywgJ2NvZGUnLCAnY29sJywgJ2NvbGdyb3VwJywgJ2RhdGEnLCAnZGF0YWxpc3QnLCAnZGQnLCAnZGV0YWlscycsICdkZm4nLCAnZGl2JywgJ2RsJywgJ2R0JywgJ2VtJywgJ2ZpZWxkc2V0JywgJ2ZpZ2NhcHRpb24nLFxuXHRcdCdmaWd1cmUnLCAnZm9vdGVyJywgJ2gxJywgJ2gyJywgJ2gzJywgJ2g0JywgJ2g1JywgJ2g2JywgJ2hlYWRlcicsICdoZ3JvdXAnLCAnaHInLCAnaScsICdpbWcnLCAnaW5wdXQnLCAna2JkJyxcblx0XHQnbGFiZWwnLCAnbGknLCAnbWFpbicsICdtYWluJywgJ21hcmsnLCAnbmF2JywgJ29sJywgJ29wdGlvbicsICdwJywgJ3ByZScsICdxJywgJ3JiJywgJ3JwJywgJ3J0JywgJ3J0YycsICdydWJ5Jyxcblx0XHQncycsICdzYW1wJywgJ3NlY3Rpb24nLCAnc2VsZWN0JywgJ3NtYWxsJywgJ3NwYW4nLCAnc3Ryb25nJywgJ3N1YicsICdzdW1tYXJ5JywgJ3N1cCcsICd0YWJsZScsICd0Ym9keScsICd0ZCcsICd0ZXh0YXJlYScsXG5cdFx0J3Rmb290JywgJ3RoJywgJ3RoZWFkJywgJ3RpbWUnLCAndHInLCAndScsICd1bCcsICd2YXInLCAnd2JyJ107XG5cdGxldCBhdHRyaWJ1dGVzID0gWydhYmJyJywgJ2FjY2VwdCcsICdhY2Nlc3NrZXknLCAnYWxpZ24nLCAnYWx0JywgJ2FyaWEtKicsICdhdXRvY29tcGxldGUnLCAnYXhpcycsICdiZ2NvbG9yJywgJ2JvcmRlcicsXG5cdFx0J2NlbGxwYWRkaW5nJywgJ2NlbGxzcGFjaW5nJywgJ2NoYXInLCAnY2hhcm9mZicsICdjaGVja2VkJywgJ2NsYXNzJywgJ2NsZWFyJywgJ2NvbG9yJywgJ2NvbHMnLCAnY29sc3BhbicsICdjb21wYWN0Jyxcblx0XHQnY29udHJvbHMnLCAnY29vcmRzJywgJ2RhdGEtKicsICdkYXRldGltZScsICdkZWZhdWx0JywgJ2RpcicsICdkaXNhYmxlZCcsICdkcmFnZ2FibGUnLCAnZW5jdHlwZScsICdmYWNlJywgJ2ZvcicsXG5cdFx0J2ZyYW1lJywgJ2ZyYW1lYm9yZGVyJywgJ2hlaWdodCcsICdoaWRkZW4nLCAnaGlnaCcsICdocmVmJywgJ2hyZWZsYW5nJywgJ2hzcGFjZScsICdpbmVydCcsICdpbnB1dG1vZGUnLCAnaXNtYXAnLCAnaXRlbXByb3AnLFxuXHRcdCdpdGVtc2NvcGUnLCAna2luZCcsICdsYWJlbCcsICdsYW5nJywgJ2xpc3QnLCAnbG9hZGluZycsICdsb29wJywgJ2xvdycsICdtYXJnaW5oZWlnaHQnLCAnbWFyZ2lud2lkdGgnLCAnbWF4JywgJ21heGxlbmd0aCcsXG5cdFx0J21ldGhvZCcsICdtaW4nLCAnbXVsdGlwbGUnLCAnbXV0ZWQnLCAnbmFtZScsICdub2hyZWYnLCAnbm9zaGFkZScsICdub3ZhbGlkYXRlJywgJ25vd3JhcCcsICdvcGVuJywgJ3BsYWNlaG9sZGVyJyxcblx0XHQncHJlbG9hZCcsICdyYWRpb2dyb3VwJywgJ3JlYWRvbmx5JywgJ3JlcXVpcmVkJywgJ3JldmVyc2VkJywgJ3JvbGUnLCAncm93cycsICdyb3dzcGFuJywgJ3J1bGVzJywgJ3Njb3BlJywgJ3NlbGVjdGVkJyxcblx0XHQnc2hhcGUnLCAnc2l6ZScsICdzcGFuJywgJ3NwZWxsY2hlY2snLCAnc3JjJywgJ3NyY2xhbmcnLCAnc3RhcnQnLCAnc3RlcCcsICdzdHlsZScsICdzdW1tYXJ5JywgJ3RhYmluZGV4JywgJ3RpdGxlJyxcblx0XHQndHJhbnNsYXRlJywgJ3R5cGUnLCAndmFsaWduJywgJ3ZhbHVlJywgJ3ZzcGFjZScsICd3aWR0aCcsICd3cmFwJ107XG5cblx0aWYgKCFsZWdhY3kpIGF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzLmNvbmNhdCgnaWQnKTtcblxuXHQvLyBSZW1vdmUgYW55dGhpbmcgaW4gPG1vYmlsZT4gdGFnc1xuXHRjb25zdCBpbnB1dCA9IGRpcnR5SHRtbC5yZXBsYWNlKC88bW9iaWxlXFxzKj5bXFxzXFxTXSo/PFxcL21vYmlsZVxccyo+fDxcXC8qd2ViXFxzKj58PFxcLyptb2JpbGVcXHMqPi9nLCAnJyk7XG5cblx0Y29uc3QgY2xlYW5lZEh0bWwgPSBXaW5kb3cuc2FuaXRpemVIdG1sKFxuXHRcdGlucHV0LFxuXHRcdHtcblx0XHRcdGFsbG93ZWRBdHRyaWJ1dGVzOiB7XG5cdFx0XHRcdCcqJzogYXR0cmlidXRlcyxcblx0XHRcdH0sXG5cdFx0XHRhbGxvd2VkVGFnczogdGFncyxcblx0XHRcdHRyYW5zZm9ybVRhZ3M6IHtcblx0XHRcdFx0JyonOiAodGFnTmFtZSwgYXR0cmlicykgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IG5ld0F0dHJpYnMgPSBhdHRyaWJzO1xuXHRcdFx0XHRcdGlmIChsZWdhY3kgJiYgYXR0cmlicy5jbGFzcykge1xuXHRcdFx0XHRcdFx0Y29uc3QgY2xhc3NlcyA9IGF0dHJpYnMuY2xhc3Muc3BsaXQoJyAnKTtcblx0XHRcdFx0XHRcdGNsYXNzZXMuZm9yRWFjaCgoa2xhc3MsIGkpID0+IHtcblx0XHRcdFx0XHRcdFx0aWYgKGtsYXNzLnN1YnN0cmluZygwLCA2KSA9PT0gJ3NoZWV0LScgfHwga2xhc3MgPT09ICd0b2tlbmFjdGlvbicgfHwgWydhdHRyJywgJ3JlcGVhdGluZycsICdyb2xsJywgJ2FjdCcsICdjb21wJ10uaW5jbHVkZXMoa2xhc3Muc3BsaXQoJ18nKVswXSkpIHtcblx0XHRcdFx0XHRcdFx0XHRjbGFzc2VzW2ldID0ga2xhc3M7XG5cdFx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdFx0Y2xhc3Nlc1tpXSA9IGBzaGVldC0ke2tsYXNzfWA7XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0bmV3QXR0cmlicy5jbGFzcyA9IGNsYXNzZXMuam9pbignICcpO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGlmIChhdHRyaWJzLnNyYykge1xuXHRcdFx0XHRcdFx0bmV3QXR0cmlicy5zcmMgPSBkMjAudXRpbHMuYWRkSW1hZ2VQcm94eShhdHRyaWJzLnNyYyk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0aWYgKGF0dHJpYnMuaHJlZikge1xuXHRcdFx0XHRcdFx0aWYgKGF0dHJpYnMuaHJlZi5zdWJzdHJpbmcoMCwgMSkgIT09ICcjJykge1xuXHRcdFx0XHRcdFx0XHRuZXdBdHRyaWJzLmhyZWYgPSAnIyc7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0XHRcdHRhZ05hbWUsXG5cdFx0XHRcdFx0XHRhdHRyaWJzOiBuZXdBdHRyaWJzLFxuXHRcdFx0XHRcdH07XG5cdFx0XHRcdH0sXG5cdFx0XHR9LFxuXHRcdFx0cGFyc2VyOiB7XG5cdFx0XHRcdHhtbE1vZGU6IHRydWUsXG5cdFx0XHRcdGRlY29kZUVudGl0aWVzOiBmYWxzZSxcblx0XHRcdH0sXG5cdFx0fSxcblx0KTtcblxuXHRyZXR1cm4gY2xlYW5lZEh0bWw7XG59O1xuXG5kMjAuam91cm5hbC5zZXRMZWdhY3lTYW5pdGl6YXRpb24gPSAobGVnYWN5KSA9PiB7XG5cdGQyMC5qb3VybmFsLmxlZ2FjeVNhbml0aXphdGlvbiA9IGxlZ2FjeTtcblx0ZDIwLmpvdXJuYWwuaHRtbEZpbHRlckZ1bmMgPSBsZWdhY3kgPyBodG1sU2FuaXRpemVMZWdhY3kgOiBodG1sU2FuaXRpemU7XG59O1xuXG5kMjAuam91cm5hbC5jc3NGaWx0ZXJGdW5jID0gZnVuY3Rpb24gKGlucHV0Q3NzLCBhbGxvd2VkKSB7XG5cdGxldCBpbnB1dCA9IGlucHV0Q3NzLnJlcGxhY2UoL1xcL1xcKlxccypzdGFydCBtb2JpbGVcXHMqXFwqXFwvW1xcU1xcc10qP1xcL1xcKlxccyplbmQgbW9iaWxlXFxzKlxcKlxcLy9naSwgJycpOyAvLyByZW1vdmUgbW9iaWxlIGNzc1xuXHRpbnB1dCA9IGlucHV0LnJlcGxhY2UoL1xcL1xcKlteKl0rXFwqXFwvL2csICcnKTsgLy8gcmVtb3ZlIGFsbCBjc3MgY29tbWVudHNcblxuXHQvLyBMb29rIGZvciBzZWxlY3RvcnMsIG1ha2Ugc3VyZSB0aGF0IHRoZXkgc3RhcnQgd2l0aCAuY2hhci1zaGVldFxuXHRjb25zdCBmb250X2ltcG9ydHMgPSBpbnB1dC5tYXRjaCgvKEBpbXBvcnQgdXJsXFwoWyd8XCJdLitbJ3xcIl1cXCk7KikvaWcpIHx8IFtdO1xuXHRpbnB1dCA9IGlucHV0LnJlcGxhY2UoLyhAaW1wb3J0IHVybFxcKFsnfFwiXS4rWyd8XCJdXFwpOyopL2lnLCAnJyk7XG5cblx0aW5wdXQgPSBpbnB1dC5yZXBsYWNlKC8oW157XSspe1tefV0qfS9pZywgKG1hdGNoLCBzZWxlY3RvcnMpID0+IHtcblx0XHRzZWxlY3RvcnMgPSAkLnRyaW0oc2VsZWN0b3JzKTtcblx0XHRjb25zdCBzYXJyYXkgPSBzZWxlY3RvcnMuc3BsaXQoJywnKTtcblx0XHRsZXQgZmluYWxzZWxlY3RvciA9ICcnO1xuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgc2FycmF5Lmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRzYXJyYXlbaV0gPSAkLnRyaW0oc2FycmF5W2ldKTtcblx0XHRcdGlmIChzYXJyYXlbaV0uc3Vic3RyaW5nKDAsIDEpID09PSAnIycpIHtcblx0XHRcdFx0c2FycmF5W2ldID0gc2FycmF5W2ldLnJlcGxhY2UoJyMnLCAnLicpO1xuXHRcdFx0fVxuXHRcdFx0aWYgKHNhcnJheVtpXS5tYXRjaCgvXlxcLmxhbmctW2Etel17Mn0oIC4qKT8kLykpIHtcblx0XHRcdFx0c2FycmF5W2ldID0gYC5jaGFyc2hlZXQke3NhcnJheVtpXX1gO1xuXHRcdFx0fSBlbHNlIGlmICghc2FycmF5W2ldLm1hdGNoKC9eXFwuY2hhcnNoZWV0KFxcLmxhbmctW2Etel17Mn0pPyggLiopPyQvKSAmJiBzYXJyYXlbaV0gIT09ICdAZm9udC1mYWNlJyAmJiBzYXJyYXlbaV0uc3Vic3RyaW5nKDAsIDIwKSAhPT0gJy5zaGVldC1yb2xsdGVtcGxhdGUtJyAmJiBzYXJyYXlbaV0uc3Vic3RyaW5nKDAsIDM2KSAhPT0gJy53aXRob3V0YXZhdGFycyAuc2hlZXQtcm9sbHRlbXBsYXRlLScgJiYgc2FycmF5W2ldLnN1YnN0cmluZygwLCA4KSAhPT0gJ0BpbXBvcnQgJykge1xuXHRcdFx0XHRzYXJyYXlbaV0gPSBgLmNoYXJzaGVldCAke3NhcnJheVtpXX1gO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRmaW5hbHNlbGVjdG9yID0gc2FycmF5LmpvaW4oJywnKTtcblx0XHRtYXRjaCA9IG1hdGNoLnJlcGxhY2Uoc2VsZWN0b3JzLCBmaW5hbHNlbGVjdG9yKTtcblx0XHRyZXR1cm4gbWF0Y2g7XG5cdH0pO1xuXG5cdGNvbnN0IGV2aWwgPSBbXG5cdFx0LyhcXGJkYXRhOlxcYnxldmFsfGNvb2tpZXxcXGJ3aW5kb3dcXGJ8XFxicGFyZW50XFxifFxcYnRoaXNcXGIpL2ksIC8vIHN1c3BpY2lvdXMgamF2YXNjcmlwdC10eXBlIHdvcmRzXG5cdFx0L2JlaGF2aW91P3J8ZXhwcmVzc2lvbnxtb3otYmluZGluZ3xAY2hhcnNldHxqYXZhc2NyaXB0fHZic2NyaXB0fFtcXDxdfFxcXFxcXHcvaSxcblx0XHQvQGltcG9ydCAoPyF1cmxcXChbJ1wiXWh0dHBzOlxcL1xcL2ZvbnRzXFwuZ29vZ2xlYXBpc1xcLmNvbVxcL2Nzc1xcP2ZhbWlseT0pL2ksXG5cdFx0Ly8vIFtcXDw+XS8sIC8vIGJhY2sgc2xhc2gsIGh0bWwgdGFncyxcblx0XHQvW1xceDdmLVxceGZmXS8sIC8vIGhpZ2ggYnl0ZXMgLS0gc3VzcGVjdFxuXHRcdC9bXFx4MDAtXFx4MDhcXHgwQlxceDBDXFx4MEUtXFx4MUZdLywgLy8gbG93IGJ5dGVzIC0tIHN1c3BlY3Rcblx0XHQvJlxcIy8sIC8vIGJhZCBjaGFyc2V0XG5cdF07XG5cblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBldmlsLmxlbmd0aDsgaSsrKSB7XG5cdFx0aWYgKGlucHV0Lm1hdGNoKGV2aWxbaV0pKSB7XG5cdFx0XHRjb25zb2xlLmxvZyhpbnB1dC5tYXRjaChldmlsW2ldKSk7XG5cdFx0XHRjb25zb2xlLmVycm9yKCdQb3RlbnRpYWwgQ1NTIHNlY3VyaXR5IHZpb2xhdGlvbjsgY2hhcmFjdGVyIHNoZWV0IHRlbXBsYXRlIHN0eWxpbmcgdGhyb3duIG91dC4nKTtcblx0XHRcdGlucHV0ID0gJyc7XG5cdFx0fVxuXHR9XG5cblx0Zm9udF9pbXBvcnRzLmZvckVhY2goKGZvbnRJbXBvcnQpID0+IHtcblx0XHRpZiAoZm9udEltcG9ydC5pbmNsdWRlcygnZm9udHMuZ29vZ2xlYXBpcy5jb20nKSkge1xuXHRcdFx0aW5wdXQgPSBgJHtmb250SW1wb3J0fSAke2lucHV0fWA7XG5cdFx0fVxuXHR9KTtcblxuXHRpbnB1dCA9IGlucHV0LnJlcGxhY2UoL3VybFtcXHNdKlxcKFteXFwpXStcXCkvaWcsIChtYXRjaCkgPT4ge1xuXHRcdG1hdGNoID0gbWF0Y2gucmVwbGFjZSgvXFxzL2dpLCAnJyk7IC8vIHJlcGxhY2UgYWxsIHdoaXRlc3BhY2UuXG5cdFx0bWF0Y2ggPSBtYXRjaC5yZXBsYWNlKCd1cmwoJywgJycpO1xuXHRcdGNvbnN0IHBzID0gbWF0Y2guc3BsaXQoJyknKTtcblx0XHRtYXRjaCA9IHBzW3BzLmxlbmd0aCAtIDJdOyAvLyBldmVyeXRoaW5nIGJlZm9yZSBsYXN0IHBhcmVudGhlc2VzXG5cdFx0bWF0Y2ggPSBtYXRjaC5yZXBsYWNlKC8nL2lnLCAnJyk7XG5cdFx0bWF0Y2ggPSBtYXRjaC5yZXBsYWNlKC9cIi9pZywgJycpOyAvLyByZW1vdmUgYWxsIHF1b3Rlcy9hcG9zdHJvcGhlc1xuXHRcdC8vIEF0IHRoaXMgcG9pbnQgaXQgc2hvdWxkIGp1c3QgYmUgdGhlIFVSTC5cblx0XHRjb25zdCBub3Byb3h5ID0gWydodHRwczovL3MzLmFtYXpvbmF3cy5jb20vZmlsZXMuZDIwLmlvJywgJ2h0dHA6Ly9pbWdzcnYucm9sbDIwLm5ldCcsICdodHRwczovL2ltZ3Nydi5yb2xsMjAubmV0JywgaW1nc3J2X3VybCwgJ2h0dHBzOi8vYXBwLnJvbGwyMC5uZXQnICwgJ2h0dHBzOi8vc3RvcmFnZS5nb29nbGVhcGlzLmNvbS9jaGFyLXNoZWV0LWFwcC1pbWFnZXMtNmUxMDE0MTEnXTtcblxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgbm9wcm94eS5sZW5ndGg7IGkrKykge1xuXHRcdFx0aWYgKG1hdGNoLnN1YnN0cmluZygwLCBub3Byb3h5W2ldLmxlbmd0aCkgPT09IG5vcHJveHlbaV0pIHtcblx0XHRcdFx0cmV0dXJuIGB1cmwoXCIke21hdGNofVwiKWA7XG5cdFx0XHR9XG5cdFx0fVxuXHRcdGlmICgvXmh0dHBzPzpcXC9cXC8vLnRlc3QobWF0Y2gpKSB7XG5cdFx0XHRyZXR1cm4gYHVybCgnJHtpbWdzcnZfdXJsfS8/c3JjPSR7ZXNjYXBlKCQudHJpbShtYXRjaCkpfScpYDtcblx0XHR9XG5cblx0XHRyZXR1cm4gJyc7XG5cdH0pO1xuXG5cdGFsbG93ZWQgPSAoKGAke2FsbG93ZWQgfHwgJyd9YCkudG9Mb3dlckNhc2UoKS5tYXRjaCgvPFthLXpdW2EtejAtOV0qPi9nKSB8fCBbXSkuam9pbignJyk7IC8vIG1ha2luZyBzdXJlIHRoZSBhbGxvd2VkIGFyZyBpcyBhIHN0cmluZyBjb250YWluaW5nIG9ubHkgdGFncyBpbiBsb3dlcmNhc2UgKDxhPjxiPjxjPilcblx0Y29uc3QgdGFncyA9IC88XFwvPyhbYS16XVthLXowLTldKilcXGJbXj5dKj4vZ2k7XG5cdGNvbnN0IGNvbW1lbnRzQW5kUGhwVGFncyA9IC88IS0tW1xcc1xcU10qPy0tPnw8XFw/KD86cGhwKT9bXFxzXFxTXSo/XFw/Pi9naTtcblx0cmV0dXJuIGlucHV0LnJlcGxhY2UoY29tbWVudHNBbmRQaHBUYWdzLCAnJykucmVwbGFjZSh0YWdzLCAoJDAsICQxKSA9PiAoYWxsb3dlZC5pbmRleE9mKGA8JHskMS50b0xvd2VyQ2FzZSgpfT5gKSA+IC0xID8gJDAgOiAnJykpO1xufTtcblxuZDIwLmpvdXJuYWwubG9hZFNoZWV0RnJvbUZhbGxiYWNrID0gKGN1c3RvbWNoYXJzaGVldF9odG1sLCBjdXN0b21jaGFyc2hlZXRfY3NzKSA9PiB7XG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5yb2xsVGVtcGxhdGVzID0ge307XG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5jaGFybWFuY2VyVGVtcGxhdGVzID0ge307XG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5jaGFybWFuY2VyUmVwZWF0aW5nID0ge307XG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy53b3JrZXJTY3JpcHRzID0gW107XG5cblx0bGV0IGRlY29kZWRodG1sID0gQkFTRTY0LmRlY29kZShjdXN0b21jaGFyc2hlZXRfaHRtbCk7XG5cdGNvbnN0IGRlY29kZWRDc3MgPSBCQVNFNjQuZGVjb2RlKGN1c3RvbWNoYXJzaGVldF9jc3MpLnJlcGxhY2UoL1xcL1xcKlxccyo/c3RhcnQgbW9iaWxlXFxzKj9cXCpcXC9bXFxzXFxTXSo/XFwvXFwqXFxzKj9lbmQgbW9iaWxlXFxzKj9cXCpcXC8vZ2ltLCAnJyk7XG5cblx0Y29uc3Qgcm9sbHRlbXBsYXRlcmVnZXggPSAvKDxyb2xsdGVtcGxhdGUgW14+XSs+KShbXFxzXFxTXSo/KSg8XFwvcm9sbHRlbXBsYXRlPikvaWc7XG5cdGNvbnN0IHJvbGx0ZW1wY2xhc3NyZWdleCA9IC8oY2xhc3M9XFxcInNoZWV0LXJvbGx0ZW1wbGF0ZS0pKFteXFxcIl0rKShcXFwiPikvaTtcblxuXHRkZWNvZGVkaHRtbCA9IGRlY29kZWRodG1sLnJlcGxhY2Uocm9sbHRlbXBsYXRlcmVnZXgsIGZ1bmN0aW9uIChtYXRjaCkge1xuXHRcdGNvbnN0IGNsYXNzbWF0Y2hlcyA9IHJvbGx0ZW1wY2xhc3NyZWdleC5leGVjKG1hdGNoKTtcblx0XHRpZiAoY2xhc3NtYXRjaGVzICYmIGNsYXNzbWF0Y2hlcy5sZW5ndGggPiAzKSB7XG5cdFx0XHRjb25zdCBteWlkID0gY2xhc3NtYXRjaGVzWzJdO1xuXHRcdFx0bGV0IHRlbXBsYXRlSW5uZXJIdG1sID0gYXJndW1lbnRzWzJdO1xuXHRcdFx0dGVtcGxhdGVJbm5lckh0bWwgPSBkMjAuam91cm5hbC5odG1sRmlsdGVyRnVuYyh0ZW1wbGF0ZUlubmVySHRtbCwgdHJ1ZSk7XG5cdFx0XHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMucm9sbFRlbXBsYXRlc1tteWlkXSA9IHRlbXBsYXRlSW5uZXJIdG1sO1xuXHRcdH1cblxuXHRcdHJldHVybiAnJztcblx0fSk7XG5cblx0Y29uc3QgY2hhcm1hbmNlcnRlbXBsYXRlcmVnZXggPSAvKDxjaGFybWFuY2VyIFtePl0rPikoW1xcc1xcU10qPykoPFxcL2NoYXJtYW5jZXI+KS9pZztcblx0Y29uc3QgY2hhcm1hbmNlcnRlbXBjbGFzc3JlZ2V4ID0gLyhjbGFzcz1cXFwic2hlZXQtKGNoYXJtYW5jZXJ8cmVwZWF0aW5nKS0pKFteXFxcIl0rKShcXFwiPikvaTtcblxuXHRkZWNvZGVkaHRtbCA9IGRlY29kZWRodG1sLnJlcGxhY2UoY2hhcm1hbmNlcnRlbXBsYXRlcmVnZXgsIGZ1bmN0aW9uIChtYXRjaCkge1xuXHRcdGNvbnN0IGNsYXNzbWF0Y2hlcyA9IGNoYXJtYW5jZXJ0ZW1wY2xhc3NyZWdleC5leGVjKG1hdGNoKTtcblx0XHRpZiAoY2xhc3NtYXRjaGVzICYmIGNsYXNzbWF0Y2hlcy5sZW5ndGggPiA0KSB7XG5cdFx0XHRjb25zdCBteWlkID0gY2xhc3NtYXRjaGVzWzNdO1xuXHRcdFx0bGV0IHRlbXBsYXRlSW5uZXJIdG1sID0gYXJndW1lbnRzWzJdO1xuXHRcdFx0dGVtcGxhdGVJbm5lckh0bWwgPSBkMjAuam91cm5hbC5odG1sRmlsdGVyRnVuYyh0ZW1wbGF0ZUlubmVySHRtbCk7XG5cdFx0XHRpZiAoY2xhc3NtYXRjaGVzWzJdLnRvTG93ZXJDYXNlKCkgPT0gJ2NoYXJtYW5jZXInKSB7XG5cdFx0XHRcdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5jaGFybWFuY2VyVGVtcGxhdGVzW215aWRdID0gdGVtcGxhdGVJbm5lckh0bWw7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMuY2hhcm1hbmNlclJlcGVhdGluZ1tteWlkLnNwbGl0KCcgJylbMF1dID0gdGVtcGxhdGVJbm5lckh0bWw7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuICcnO1xuXHR9KTtcblxuXHRjb25zdCBzY3JpcHRqc3JlZ2V4ID0gLyg8c2NyaXB0IFtePl0rPikoW1xcc1xcU10qPykoPFxcL3NjcmlwdD4pL2lnO1xuXHRjb25zdCB3b3JrZXJqc3R5cGVyZWdleCA9IC8odHlwZT1bXFxcInwnXXRleHRcXC93b3JrZXJbXFxcInwnXT4pL2k7XG5cblx0ZGVjb2RlZGh0bWwgPSBkZWNvZGVkaHRtbC5yZXBsYWNlKHNjcmlwdGpzcmVnZXgsIGZ1bmN0aW9uIChtYXRjaCkge1xuXHRcdGNvbnN0IHdvcmtlcm1hdGNoZXMgPSB3b3JrZXJqc3R5cGVyZWdleC5leGVjKG1hdGNoKTtcblx0XHRpZiAod29ya2VybWF0Y2hlcyAmJiB3b3JrZXJtYXRjaGVzWzBdLmluZGV4T2YoJ3RleHQvd29ya2VyJykgIT09IC0xKSB7XG5cdFx0XHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMud29ya2VyU2NyaXB0cy5wdXNoKGFyZ3VtZW50c1syXSk7XG5cdFx0XHRyZXR1cm4gJyc7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIG1hdGNoO1xuXHR9KTtcblxuXHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMubGF5b3V0aHRtbCA9IGQyMC5qb3VybmFsLmh0bWxGaWx0ZXJGdW5jKGRlY29kZWRodG1sKTtcblxuXHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMuY3NzID0gZDIwLmpvdXJuYWwuY3NzRmlsdGVyRnVuYyhkZWNvZGVkQ3NzKTtcblxuXHRpZiAoIWQyMC5qb3VybmFsLmxlZ2FjeVNhbml0aXphdGlvbikgZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzLmlmcmFtZUNzcyA9IGRlY29kZWRDc3M7XG59O1xuXG5jb25zdCBsb2FkQmxhbmtTaGVldCA9ICgpID0+IHtcblx0ZDIwLmpvdXJuYWwudXNlQ3VzdG9tU2hlZXRzID0gZmFsc2U7XG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy50cmFuc2xhdGlvbiA9IHsgdmFsdWVzOiB7fSwgbGFuZzogTEFOR1VBR0UgfTtcblx0aTE4bi50cmFuc2xhdG9yLmFkZChkMjAuam91cm5hbC5jdXN0b21TaGVldHMudHJhbnNsYXRpb24pO1xuXG5cdGQyMC5qb3VybmFsLnNldExlZ2FjeVNhbml0aXphdGlvbihmYWxzZSk7XG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5zaGVldFNldHRpbmdzID0ge307XG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5yb2xsVGVtcGxhdGVzID0ge307XG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5jaGFybWFuY2VyVGVtcGxhdGVzID0ge307XG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5jaGFybWFuY2VyUmVwZWF0aW5nID0ge307XG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy53b3JrZXJTY3JpcHRzID0gW107XG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5sYXlvdXRodG1sID0gJyc7XG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5jc3MgPSAnJztcblx0ZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzLmlmcmFtZUNzcyA9ICcnO1xuXG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5hdmFpbGFibGVSb2xscyA9IHt9O1xuXHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMuYXZhaWxhYmxlQWN0aW9ucyA9IHt9O1xuXHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMuYXZhaWxhYmxlQXR0cmlidXRlcyA9IHt9O1xuXHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMucmVzZXJ2ZWRBdHRyaWJ1dGVzID0ge307XG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy50b2tlbkFjdGlvbnMgPSBbXTtcblx0ZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzLmF0dHJEZXBzID0ge307XG5cblx0ZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzLmV2ZW50TGlzdGVuZXJzID0gW107XG5cblx0ZDIwLmNvbXBlbmRpdW0uc2hvcnROYW1lID0gQ09NUEVORElVTV9PVkVSUklERSA/IENPTVBFTkRJVU1fT1ZFUlJJREUgOiAnJztcbn07XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFsbENoYXJzaGVldERhdGEoKSB7XG5cdGQyMC5qb3VybmFsLnVzZUN1c3RvbVNoZWV0cyA9IHRydWU7XG5cdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cyA9IHtcblx0XHRzaGVldFNldHRpbmdzOiB7fSxcblx0XHRyb2xsVGVtcGxhdGVzOiB7fSxcblx0XHRjaGFybWFuY2VyVGVtcGxhdGVzOiB7fSxcblx0XHRjaGFybWFuY2VyUmVwZWF0aW5nOiB7fSxcblx0XHR3b3JrZXJTY3JpcHRzOiBbXSxcblx0XHRsYXlvdXRodG1sOiAnJyxcblx0XHRjc3M6ICcnLFxuXHRcdGlmcmFtZUNzczogJycsXG5cblx0XHRhdmFpbGFibGVSb2xsczoge30sXG5cdFx0YXZhaWxhYmxlQWN0aW9uczoge30sXG5cdFx0YXZhaWxhYmxlQXR0cmlidXRlczoge30sXG5cdFx0cmVzZXJ2ZWRBdHRyaWJ1dGVzOiB7fSxcblx0XHR0b2tlbkFjdGlvbnM6IFtdLFxuXHRcdGF0dHJEZXBzOiB7fSxcblxuXHRcdGV2ZW50TGlzdGVuZXJzOiBbXSxcblx0fTtcblxuXHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcblx0XHRpZiAoQ0hBUlNIRUVUX05BTUUgPT09ICdub25lJykge1xuXHRcdFx0bG9hZEJsYW5rU2hlZXQoKTtcblx0XHRcdHJlc29sdmUoKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0UHJvbWlzZS5hbGwoW1xuXHRcdFx0XHRnZXRDaGFyc2hlZXREYXRhKFsnY3NzKHNhbml0aXplZDogdHJ1ZSknLCAnaHRtbCcsICdyb2xsdGVtcGxhdGVzJywgJ21hbmNlcnRlbXBsYXRlcycsICd1c2VyT3B0aW9ucyddKSxcblx0XHRcdFx0Z2V0Q2hhcnNoZWV0RGF0YShbJ3NoZWV0d29ya2VycycsICdsZWdhY3lTYW5pdGl6YXRpb24nLCBgdHJhbnNsYXRpb24obGFuZ3VhZ2U6IFwiJHtMQU5HVUFHRX1cIilgLCAnaWZyYW1lQ3NzJywgJ2NvbXBlbmRpdW0nXSksXG5cdFx0XHRdKS50aGVuKChyZXN1bHRzKSA9PiB7XG5cdFx0XHRcdGNvbnN0IGNoYXJzaGVldERhdGEgPSB7XG5cdFx0XHRcdFx0Li4ucmVzdWx0c1swXSxcblx0XHRcdFx0XHQuLi5yZXN1bHRzWzFdLFxuXHRcdFx0XHR9O1xuXHRcdFx0XHRkMjAuam91cm5hbC5zZXRMZWdhY3lTYW5pdGl6YXRpb24oY2hhcnNoZWV0RGF0YS5sZWdhY3lTYW5pdGl6YXRpb24pO1xuXG5cdFx0XHRcdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy50cmFuc2xhdGlvbiA9IHsgdmFsdWVzOiBjaGFyc2hlZXREYXRhLnRyYW5zbGF0aW9uLCBsYW5nOiBMQU5HVUFHRSB9O1xuXHRcdFx0XHRpMThuLnRyYW5zbGF0b3IuYWRkKGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy50cmFuc2xhdGlvbik7XG5cblx0XHRcdFx0ZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzLnNoZWV0U2V0dGluZ3MgPSBjaGFyc2hlZXREYXRhLnVzZXJPcHRpb25zO1xuXG5cdFx0XHRcdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5yb2xsVGVtcGxhdGVzID0gY2hhcnNoZWV0RGF0YS5yb2xsdGVtcGxhdGVzO1xuXHRcdFx0XHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMuY2hhcm1hbmNlclRlbXBsYXRlcyA9IGNoYXJzaGVldERhdGEubWFuY2VydGVtcGxhdGVzLmNoYXJtYW5jZXI7XG5cdFx0XHRcdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5jaGFybWFuY2VyUmVwZWF0aW5nID0gY2hhcnNoZWV0RGF0YS5tYW5jZXJ0ZW1wbGF0ZXMucmVwZWF0aW5nO1xuXHRcdFx0XHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMud29ya2VyU2NyaXB0cyA9IGNoYXJzaGVldERhdGEuc2hlZXR3b3JrZXJzO1xuXHRcdFx0XHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMubGF5b3V0aHRtbCA9IGNoYXJzaGVldERhdGEuaHRtbDtcblx0XHRcdFx0ZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzLmNzcyA9IGNoYXJzaGVldERhdGEuY3NzO1xuXHRcdFx0XHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMuaWZyYW1lQ3NzID0gY2hhcnNoZWV0RGF0YS5pZnJhbWVDc3M7XG5cblx0XHRcdFx0ZDIwLmNvbXBlbmRpdW0uc2hvcnROYW1lID0gQ09NUEVORElVTV9PVkVSUklERSA/IENPTVBFTkRJVU1fT1ZFUlJJREUgOiBjaGFyc2hlZXREYXRhLmNvbXBlbmRpdW07XG5cblx0XHRcdFx0cmVzb2x2ZSgpO1xuXHRcdFx0fSkuY2F0Y2goKGVycm9yKSA9PiB7XG5cdFx0XHRcdGlmIChlcnJvciAhPT0gJ0NVU1RPTScpIHtcblx0XHRcdFx0XHQvLyBEb24ndCBuZWVkIHRvIHdhcm4gaWYgd2UncmUgZmFsbGluZyBiYWNrIGZvciBhIGN1c3RvbSBzaGVldFxuXHRcdFx0XHRcdGNvbnNvbGUud2FybignRmFpbHVyZSBjb250YWN0aW5nIGNoYXJhY3RlciBzaGVldCBzZXJ2aWNlLCB1c2luZyBmYWxsYmFjay4nKTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGdldENoYXJzaGVldERhdGFGYWxsYmFjaygpLnRoZW4oKHJlc3VsdCkgPT4ge1xuXHRcdFx0XHRcdGQyMC5qb3VybmFsLnNldExlZ2FjeVNhbml0aXphdGlvbihyZXN1bHQubGVnYWN5X3Nhbml0aXphdGlvbik7XG5cblx0XHRcdFx0XHRpZiAoc2hlZXRTYW5kYm94R2FtZSkge1xuXHRcdFx0XHRcdFx0ZDIwLmpvdXJuYWwuY3VzdG9tY2hhcnNoZWV0X2h0bWwgPSByZXN1bHQuaHRtbDtcblx0XHRcdFx0XHRcdGQyMC5qb3VybmFsLmN1c3RvbWNoYXJzaGVldF9jc3MgPSByZXN1bHQuY3NzO1xuXHRcdFx0XHRcdFx0ZDIwLmpvdXJuYWwuY3VzdG9tY2hhcnNoZWV0X3RyYW5zbGF0aW9uID0gcmVzdWx0LnRyYW5zbGF0aW9uO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy50cmFuc2xhdGlvbiA9IEpTT04ucGFyc2UoQkFTRTY0LmRlY29kZShyZXN1bHQudHJhbnNsYXRpb24pKTtcblx0XHRcdFx0XHRpMThuLnRyYW5zbGF0b3IuYWRkKGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy50cmFuc2xhdGlvbik7XG5cblx0XHRcdFx0XHRkMjAuam91cm5hbC5jdXN0b21TaGVldHMuc2hlZXRTZXR0aW5ncyA9IHJlc3VsdC5zaGVldF9vcHRpb25zO1xuXG5cdFx0XHRcdFx0ZDIwLmNvbXBlbmRpdW0uc2hvcnROYW1lID0gQ09NUEVORElVTV9PVkVSUklERSA/IENPTVBFTkRJVU1fT1ZFUlJJREUgOiByZXN1bHQuY29tcGVuZGl1bTtcblxuXHRcdFx0XHRcdGQyMC5qb3VybmFsLmxvYWRTaGVldEZyb21GYWxsYmFjayhyZXN1bHQuaHRtbCwgcmVzdWx0LmNzcyk7XG5cblx0XHRcdFx0XHRyZXNvbHZlKCk7XG5cdFx0XHRcdH0pLmNhdGNoKChpbm5lckVycm9yKSA9PiB7XG5cdFx0XHRcdFx0Ly8gSWYgdGhlIGZhbGxiYWNrIGZhaWxzLCBsb2FkIGEgYmxhbmsgc2hlZXQuXG5cdFx0XHRcdFx0Y29uc29sZS5lcnJvcignVW5hYmxlIHRvIGxvYWQgY2hhcmFjdGVyIHNoZWV0IGRhdGEuJyk7XG5cdFx0XHRcdFx0aWYgKGlubmVyRXJyb3IpIGNvbnNvbGUuZXJyb3IoaW5uZXJFcnJvcik7XG5cblx0XHRcdFx0XHRsb2FkQmxhbmtTaGVldCgpO1xuXG5cdFx0XHRcdFx0cmVzb2x2ZSgpO1xuXHRcdFx0XHR9KTtcblx0XHRcdH0pO1xuXHRcdH1cblx0fSk7XG59XG5cbmQyMC5qb3VybmFsLmNoYXJzaGVldEZldGNoUHJvbWlzZSA9IGdldEFsbENoYXJzaGVldERhdGEoKTtcblxuZDIwLkRpY2VQRUcgPSAoZnVuY3Rpb24oKXtcbiAgLypcbiAgICogR2VuZXJhdGVkIGJ5IFBFRy5qcyAwLjcuMC5cbiAgICpcbiAgICogaHR0cDovL3BlZ2pzLm1hamRhLmN6L1xuICAgKi9cbiAgXG4gIGZ1bmN0aW9uIHF1b3RlKHMpIHtcbiAgICAvKlxuICAgICAqIEVDTUEtMjYyLCA1dGggZWQuLCA3LjguNDogQWxsIGNoYXJhY3RlcnMgbWF5IGFwcGVhciBsaXRlcmFsbHkgaW4gYVxuICAgICAqIHN0cmluZyBsaXRlcmFsIGV4Y2VwdCBmb3IgdGhlIGNsb3NpbmcgcXVvdGUgY2hhcmFjdGVyLCBiYWNrc2xhc2gsXG4gICAgICogY2FycmlhZ2UgcmV0dXJuLCBsaW5lIHNlcGFyYXRvciwgcGFyYWdyYXBoIHNlcGFyYXRvciwgYW5kIGxpbmUgZmVlZC5cbiAgICAgKiBBbnkgY2hhcmFjdGVyIG1heSBhcHBlYXIgaW4gdGhlIGZvcm0gb2YgYW4gZXNjYXBlIHNlcXVlbmNlLlxuICAgICAqXG4gICAgICogRm9yIHBvcnRhYmlsaXR5LCB3ZSBhbHNvIGVzY2FwZSBlc2NhcGUgYWxsIGNvbnRyb2wgYW5kIG5vbi1BU0NJSVxuICAgICAqIGNoYXJhY3RlcnMuIE5vdGUgdGhhdCBcIlxcMFwiIGFuZCBcIlxcdlwiIGVzY2FwZSBzZXF1ZW5jZXMgYXJlIG5vdCB1c2VkXG4gICAgICogYmVjYXVzZSBKU0hpbnQgZG9lcyBub3QgbGlrZSB0aGUgZmlyc3QgYW5kIElFIHRoZSBzZWNvbmQuXG4gICAgICovXG4gICAgIHJldHVybiAnXCInICsgc1xuICAgICAgLnJlcGxhY2UoL1xcXFwvZywgJ1xcXFxcXFxcJykgIC8vIGJhY2tzbGFzaFxuICAgICAgLnJlcGxhY2UoL1wiL2csICdcXFxcXCInKSAgICAvLyBjbG9zaW5nIHF1b3RlIGNoYXJhY3RlclxuICAgICAgLnJlcGxhY2UoL1xceDA4L2csICdcXFxcYicpIC8vIGJhY2tzcGFjZVxuICAgICAgLnJlcGxhY2UoL1xcdC9nLCAnXFxcXHQnKSAgIC8vIGhvcml6b250YWwgdGFiXG4gICAgICAucmVwbGFjZSgvXFxuL2csICdcXFxcbicpICAgLy8gbGluZSBmZWVkXG4gICAgICAucmVwbGFjZSgvXFxmL2csICdcXFxcZicpICAgLy8gZm9ybSBmZWVkXG4gICAgICAucmVwbGFjZSgvXFxyL2csICdcXFxccicpICAgLy8gY2FycmlhZ2UgcmV0dXJuXG4gICAgICAucmVwbGFjZSgvW1xceDAwLVxceDA3XFx4MEJcXHgwRS1cXHgxRlxceDgwLVxcdUZGRkZdL2csIGVzY2FwZSlcbiAgICAgICsgJ1wiJztcbiAgfVxuICBcbiAgdmFyIHJlc3VsdCA9IHtcbiAgICAvKlxuICAgICAqIFBhcnNlcyB0aGUgaW5wdXQgd2l0aCBhIGdlbmVyYXRlZCBwYXJzZXIuIElmIHRoZSBwYXJzaW5nIGlzIHN1Y2Nlc3NmdWxsLFxuICAgICAqIHJldHVybnMgYSB2YWx1ZSBleHBsaWNpdGx5IG9yIGltcGxpY2l0bHkgc3BlY2lmaWVkIGJ5IHRoZSBncmFtbWFyIGZyb21cbiAgICAgKiB3aGljaCB0aGUgcGFyc2VyIHdhcyBnZW5lcmF0ZWQgKHNlZSB8UEVHLmJ1aWxkUGFyc2VyfCkuIElmIHRoZSBwYXJzaW5nIGlzXG4gICAgICogdW5zdWNjZXNzZnVsLCB0aHJvd3MgfFBFRy5wYXJzZXIuU3ludGF4RXJyb3J8IGRlc2NyaWJpbmcgdGhlIGVycm9yLlxuICAgICAqL1xuICAgIHBhcnNlOiBmdW5jdGlvbihpbnB1dCwgc3RhcnRSdWxlKSB7XG4gICAgICB2YXIgcGFyc2VGdW5jdGlvbnMgPSB7XG4gICAgICAgIFwic3RhcnRcIjogcGFyc2Vfc3RhcnQsXG4gICAgICAgIFwicm9sbEV4cHJlc3Npb25cIjogcGFyc2Vfcm9sbEV4cHJlc3Npb24sXG4gICAgICAgIFwicm9sbEV4cHJlc3Npb25QcmltYXJ5XCI6IHBhcnNlX3JvbGxFeHByZXNzaW9uUHJpbWFyeSxcbiAgICAgICAgXCJ2YWxpZFJvbGxTdWZmaXhcIjogcGFyc2VfdmFsaWRSb2xsU3VmZml4LFxuICAgICAgICBcInJvbGxHcm91cFwiOiBwYXJzZV9yb2xsR3JvdXAsXG4gICAgICAgIFwicm9sbEdyb3VwRXhwcmVzc2lvblwiOiBwYXJzZV9yb2xsR3JvdXBFeHByZXNzaW9uLFxuICAgICAgICBcImxhYmVsQXdhcmVSb2xsT3BlcmF0b3JcIjogcGFyc2VfbGFiZWxBd2FyZVJvbGxPcGVyYXRvcixcbiAgICAgICAgXCJyb2xsT3BlcmF0b3JcIjogcGFyc2Vfcm9sbE9wZXJhdG9yLFxuICAgICAgICBcImZ1bGxSb2xsXCI6IHBhcnNlX2Z1bGxSb2xsLFxuICAgICAgICBcImNvcmVSb2xsXCI6IHBhcnNlX2NvcmVSb2xsLFxuICAgICAgICBcIm51bWJlck9mRGljZVwiOiBwYXJzZV9udW1iZXJPZkRpY2UsXG4gICAgICAgIFwibnVtYmVyT2ZTaWRlc1wiOiBwYXJzZV9udW1iZXJPZlNpZGVzLFxuICAgICAgICBcImdyb3VwTW9kc1wiOiBwYXJzZV9ncm91cE1vZHMsXG4gICAgICAgIFwicm9sbE1vZHNcIjogcGFyc2Vfcm9sbE1vZHMsXG4gICAgICAgIFwiZXhwbG9kaW5nTW9kXCI6IHBhcnNlX2V4cGxvZGluZ01vZCxcbiAgICAgICAgXCJjb21wb3VuZGluZ01vZFwiOiBwYXJzZV9jb21wb3VuZGluZ01vZCxcbiAgICAgICAgXCJwZW5ldHJhdGluZ01vZFwiOiBwYXJzZV9wZW5ldHJhdGluZ01vZCxcbiAgICAgICAgXCJrZWVwTW9kXCI6IHBhcnNlX2tlZXBNb2QsXG4gICAgICAgIFwiZHJvcE1vZFwiOiBwYXJzZV9kcm9wTW9kLFxuICAgICAgICBcImN1c3RvbUNyaXRNb2RcIjogcGFyc2VfY3VzdG9tQ3JpdE1vZCxcbiAgICAgICAgXCJjdXN0b21GdW1ibGVNb2RcIjogcGFyc2VfY3VzdG9tRnVtYmxlTW9kLFxuICAgICAgICBcInJlcm9sbE1vZFwiOiBwYXJzZV9yZXJvbGxNb2QsXG4gICAgICAgIFwicmVyb2xsT25jZU1vZFwiOiBwYXJzZV9yZXJvbGxPbmNlTW9kLFxuICAgICAgICBcInNvcnRNb2RcIjogcGFyc2Vfc29ydE1vZCxcbiAgICAgICAgXCJmbG9vck1vZFwiOiBwYXJzZV9mbG9vck1vZCxcbiAgICAgICAgXCJtdWx0aXBsZU1vZFwiOiBwYXJzZV9tdWx0aXBsZU1vZCxcbiAgICAgICAgXCJzdWNjZXNzTW9kXCI6IHBhcnNlX3N1Y2Nlc3NNb2QsXG4gICAgICAgIFwibWF0Y2hNb2RcIjogcGFyc2VfbWF0Y2hNb2QsXG4gICAgICAgIFwibWF0Y2hUb3RhbE1vZFwiOiBwYXJzZV9tYXRjaFRvdGFsTW9kLFxuICAgICAgICBcIm1hdGNoVGhyZXNob2xkXCI6IHBhcnNlX21hdGNoVGhyZXNob2xkLFxuICAgICAgICBcImNvbXBhcmlzb25Qb2ludFwiOiBwYXJzZV9jb21wYXJpc29uUG9pbnQsXG4gICAgICAgIFwiY29tcGFyaXNvblwiOiBwYXJzZV9jb21wYXJpc29uLFxuICAgICAgICBcIm1hdGhFeHByZXNzaW9uXCI6IHBhcnNlX21hdGhFeHByZXNzaW9uLFxuICAgICAgICBcIm1hdGhFeHByZXNzaW9uUHJpbWFyeVwiOiBwYXJzZV9tYXRoRXhwcmVzc2lvblByaW1hcnksXG4gICAgICAgIFwiaW5saW5lTGFiZWxXaXRoU3BhY2VcIjogcGFyc2VfaW5saW5lTGFiZWxXaXRoU3BhY2UsXG4gICAgICAgIFwiaW5saW5lTGFiZWxcIjogcGFyc2VfaW5saW5lTGFiZWwsXG4gICAgICAgIFwib3BlcmF0b3JcIjogcGFyc2Vfb3BlcmF0b3IsXG4gICAgICAgIFwibnVtYmVyXCI6IHBhcnNlX251bWJlcixcbiAgICAgICAgXCJpbnRlZ2VyXCI6IHBhcnNlX2ludGVnZXIsXG4gICAgICAgIFwic2lnbmVkSW50ZWdlclwiOiBwYXJzZV9zaWduZWRJbnRlZ2VyLFxuICAgICAgICBcImZsb2F0XCI6IHBhcnNlX2Zsb2F0LFxuICAgICAgICBcImV4cG9uZW50XCI6IHBhcnNlX2V4cG9uZW50LFxuICAgICAgICBcIl9cIjogcGFyc2VfXyxcbiAgICAgICAgXCJfX1wiOiBwYXJzZV9fX1xuICAgICAgfTtcbiAgICAgIFxuICAgICAgaWYgKHN0YXJ0UnVsZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGlmIChwYXJzZUZ1bmN0aW9uc1tzdGFydFJ1bGVdID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIHJ1bGUgbmFtZTogXCIgKyBxdW90ZShzdGFydFJ1bGUpICsgXCIuXCIpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzdGFydFJ1bGUgPSBcInN0YXJ0XCI7XG4gICAgICB9XG4gICAgICBcbiAgICAgIHZhciBwb3MgPSAwO1xuICAgICAgdmFyIHJlcG9ydEZhaWx1cmVzID0gMDtcbiAgICAgIHZhciByaWdodG1vc3RGYWlsdXJlc1BvcyA9IDA7XG4gICAgICB2YXIgcmlnaHRtb3N0RmFpbHVyZXNFeHBlY3RlZCA9IFtdO1xuICAgICAgXG4gICAgICBmdW5jdGlvbiBwYWRMZWZ0KGlucHV0LCBwYWRkaW5nLCBsZW5ndGgpIHtcbiAgICAgICAgdmFyIHJlc3VsdCA9IGlucHV0O1xuICAgICAgICBcbiAgICAgICAgdmFyIHBhZExlbmd0aCA9IGxlbmd0aCAtIGlucHV0Lmxlbmd0aDtcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYWRMZW5ndGg7IGkrKykge1xuICAgICAgICAgIHJlc3VsdCA9IHBhZGRpbmcgKyByZXN1bHQ7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZ1bmN0aW9uIGVzY2FwZShjaCkge1xuICAgICAgICB2YXIgY2hhckNvZGUgPSBjaC5jaGFyQ29kZUF0KDApO1xuICAgICAgICB2YXIgZXNjYXBlQ2hhcjtcbiAgICAgICAgdmFyIGxlbmd0aDtcbiAgICAgICAgXG4gICAgICAgIGlmIChjaGFyQ29kZSA8PSAweEZGKSB7XG4gICAgICAgICAgZXNjYXBlQ2hhciA9ICd4JztcbiAgICAgICAgICBsZW5ndGggPSAyO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGVzY2FwZUNoYXIgPSAndSc7XG4gICAgICAgICAgbGVuZ3RoID0gNDtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuICdcXFxcJyArIGVzY2FwZUNoYXIgKyBwYWRMZWZ0KGNoYXJDb2RlLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpLCAnMCcsIGxlbmd0aCk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZ1bmN0aW9uIG1hdGNoRmFpbGVkKGZhaWx1cmUpIHtcbiAgICAgICAgaWYgKHBvcyA8IHJpZ2h0bW9zdEZhaWx1cmVzUG9zKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBpZiAocG9zID4gcmlnaHRtb3N0RmFpbHVyZXNQb3MpIHtcbiAgICAgICAgICByaWdodG1vc3RGYWlsdXJlc1BvcyA9IHBvcztcbiAgICAgICAgICByaWdodG1vc3RGYWlsdXJlc0V4cGVjdGVkID0gW107XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJpZ2h0bW9zdEZhaWx1cmVzRXhwZWN0ZWQucHVzaChmYWlsdXJlKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZnVuY3Rpb24gcGFyc2Vfc3RhcnQoKSB7XG4gICAgICAgIHZhciByZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyO1xuICAgICAgICB2YXIgcG9zMCwgcG9zMTtcbiAgICAgICAgXG4gICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgIHBvczEgPSBwb3M7XG4gICAgICAgIHJlc3VsdDAgPSBwYXJzZV9yb2xsRXhwcmVzc2lvbigpO1xuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDEgPSBbXTtcbiAgICAgICAgICBpZiAoaW5wdXQubGVuZ3RoID4gcG9zKSB7XG4gICAgICAgICAgICByZXN1bHQyID0gaW5wdXQuY2hhckF0KHBvcyk7XG4gICAgICAgICAgICBwb3MrKztcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MiA9IG51bGw7XG4gICAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJhbnkgY2hhcmFjdGVyXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICB3aGlsZSAocmVzdWx0MiAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MS5wdXNoKHJlc3VsdDIpO1xuICAgICAgICAgICAgaWYgKGlucHV0Lmxlbmd0aCA+IHBvcykge1xuICAgICAgICAgICAgICByZXN1bHQyID0gaW5wdXQuY2hhckF0KHBvcyk7XG4gICAgICAgICAgICAgIHBvcysrO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzdWx0MiA9IG51bGw7XG4gICAgICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiYW55IGNoYXJhY3RlclwiKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MCA9IFtyZXN1bHQwLCByZXN1bHQxXTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIHJlLCBjb20pIHtcbiAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShyZSkpIHtcbiAgICAgICAgICAgICAgcmUgPSBbcmVdO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vSWYgYSBjb21tZW50IGV4aXN0cyBhcHBlbmQgaXQgdG8gdGhlIGVuZCBvZiB0aGUgcm9sbCBleHByZXNzaW9uXG4gICAgICAgICAgICBpZiAoY29tICE9PSBcIlwiKSB7XG4gICAgICAgICAgICAgIGNvbSA9IGNvbS5qb2luKFwiXCIpO1xuICAgICAgICAgICAgICBpZiAoY29tLnRyaW0oKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgcmUucHVzaChuZXcgQ29tbWVudChjb20pKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiByZTtcbiAgICAgICAgICB9KShwb3MwLCByZXN1bHQwWzBdLCByZXN1bHQwWzFdKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDA7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZ1bmN0aW9uIHBhcnNlX3JvbGxFeHByZXNzaW9uKCkge1xuICAgICAgICB2YXIgcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0MjtcbiAgICAgICAgdmFyIHBvczAsIHBvczE7XG4gICAgICAgIFxuICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICBwb3MxID0gcG9zO1xuICAgICAgICByZXN1bHQwID0gcGFyc2Vfcm9sbEV4cHJlc3Npb25QcmltYXJ5KCk7XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MSA9IHBhcnNlX2xhYmVsQXdhcmVSb2xsT3BlcmF0b3IoKTtcbiAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MiA9IHBhcnNlX3JvbGxFeHByZXNzaW9uKCk7XG4gICAgICAgICAgICBpZiAocmVzdWx0MiAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICByZXN1bHQwID0gW3Jlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDJdO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDAgPSAoZnVuY3Rpb24ob2Zmc2V0LCBsZWZ0LCBvcGVyLCByaWdodCkge1xuICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGxlZnQ7XG4gICAgICAgICAgICByZXN1bHQgPSBtZXJnZUV4cHJlc3Npb25zKHJlc3VsdCwgb3Blcik7XG4gICAgICAgICAgICByZXN1bHQgPSBtZXJnZUV4cHJlc3Npb25zKHJlc3VsdCwgcmlnaHQpO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICB9KShwb3MwLCByZXN1bHQwWzBdLCByZXN1bHQwWzFdLCByZXN1bHQwWzJdKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICAgIHBvczEgPSBwb3M7XG4gICAgICAgICAgcmVzdWx0MCA9IHBhcnNlX3JvbGxFeHByZXNzaW9uUHJpbWFyeSgpO1xuICAgICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQxID0gcGFyc2VfaW5saW5lTGFiZWxXaXRoU3BhY2UoKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBbcmVzdWx0MCwgcmVzdWx0MV07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIHJlcCwgbGJsKSB7XG4gICAgICAgICAgICAgIHJldHVybiBtZXJnZUV4cHJlc3Npb25zKHJlcCwgbGJsKTtcbiAgICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMF0sIHJlc3VsdDBbMV0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgICAgICBwb3MxID0gcG9zO1xuICAgICAgICAgICAgcmVzdWx0MCA9IHBhcnNlX2lubGluZUxhYmVsV2l0aFNwYWNlKCk7XG4gICAgICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICByZXN1bHQxID0gcGFyc2Vfcm9sbEV4cHJlc3Npb24oKTtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdDEgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQwID0gW3Jlc3VsdDAsIHJlc3VsdDFdO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIGxibCwgcmUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbWVyZ2VFeHByZXNzaW9ucyhsYmwsIHJlKTtcbiAgICAgICAgICAgICAgfSkocG9zMCwgcmVzdWx0MFswXSwgcmVzdWx0MFsxXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICBwb3MgPSBwb3MwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IHBhcnNlX3JvbGxFeHByZXNzaW9uUHJpbWFyeSgpO1xuICAgICAgICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHJlc3VsdDAgPSAoZnVuY3Rpb24ob2Zmc2V0LCByZXApIHtcbiAgICAgICAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShyZXApKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlcCA9IFtyZXBdO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcDtcbiAgICAgICAgICAgICAgICB9KShwb3MwLCByZXN1bHQwKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDA7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZ1bmN0aW9uIHBhcnNlX3JvbGxFeHByZXNzaW9uUHJpbWFyeSgpIHtcbiAgICAgICAgdmFyIHJlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDIsIHJlc3VsdDMsIHJlc3VsdDQ7XG4gICAgICAgIHZhciBwb3MwLCBwb3MxLCBwb3MyO1xuICAgICAgICBcbiAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgcG9zMSA9IHBvcztcbiAgICAgICAgcmVzdWx0MCA9IHBhcnNlX2Z1bGxSb2xsKCk7XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcG9zMiA9IHBvcztcbiAgICAgICAgICByZXBvcnRGYWlsdXJlcysrO1xuICAgICAgICAgIHJlc3VsdDEgPSBwYXJzZV92YWxpZFJvbGxTdWZmaXgoKTtcbiAgICAgICAgICByZXBvcnRGYWlsdXJlcy0tO1xuICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQxID0gXCJcIjtcbiAgICAgICAgICAgIHBvcyA9IHBvczI7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdDEgPSBudWxsO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MCA9IFtyZXN1bHQwLCByZXN1bHQxXTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIGZyKSB7XG4gICAgICAgICAgICByZXR1cm4gZnI7XG4gICAgICAgICAgfSkocG9zMCwgcmVzdWx0MFswXSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICBwb3MgPSBwb3MwO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgICBwb3MxID0gcG9zO1xuICAgICAgICAgIHJlc3VsdDAgPSBwYXJzZV9yb2xsR3JvdXAoKTtcbiAgICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcG9zMiA9IHBvcztcbiAgICAgICAgICAgIHJlcG9ydEZhaWx1cmVzKys7XG4gICAgICAgICAgICByZXN1bHQxID0gcGFyc2VfdmFsaWRSb2xsU3VmZml4KCk7XG4gICAgICAgICAgICByZXBvcnRGYWlsdXJlcy0tO1xuICAgICAgICAgICAgaWYgKHJlc3VsdDEgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MSA9IFwiXCI7XG4gICAgICAgICAgICAgIHBvcyA9IHBvczI7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXN1bHQxID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBbcmVzdWx0MCwgcmVzdWx0MV07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIHJnKSB7XG4gICAgICAgICAgICAgIHJldHVybiByZztcbiAgICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMF0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgICAgICByZXN1bHQwID0gcGFyc2VfbnVtYmVyKCk7XG4gICAgICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgbnVtKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBNYXRoRXhwcmVzc2lvbihudW0pO1xuICAgICAgICAgICAgICB9KShwb3MwLCByZXN1bHQwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICAgICAgICBwb3MxID0gcG9zO1xuICAgICAgICAgICAgICBpZiAoaW5wdXQuc3Vic3RyKHBvcywgNikgPT09IFwiZmxvb3IoXCIpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQwID0gXCJmbG9vcihcIjtcbiAgICAgICAgICAgICAgICBwb3MgKz0gNjtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcImZsb29yKFxcXCJcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0MSA9IHBhcnNlX18oKTtcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgcmVzdWx0MiA9IHBhcnNlX3JvbGxFeHByZXNzaW9uKCk7XG4gICAgICAgICAgICAgICAgICBpZiAocmVzdWx0MiAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQzID0gcGFyc2VfXygpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0MyAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnB1dC5jaGFyQ29kZUF0KHBvcykgPT09IDQxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQ0ID0gXCIpXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICBwb3MrKztcbiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0NCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJcXFwiKVxcXCJcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQ0ICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gW3Jlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDIsIHJlc3VsdDMsIHJlc3VsdDRdO1xuICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgcmV4cCkge1xuICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgIHJldHVybiBtZXJnZUV4cHJlc3Npb25zKFwiZmxvb3IoXCIsIG1lcmdlRXhwcmVzc2lvbnMocmV4cCwgXCIpXCIpKTtcbiAgICAgICAgICAgICAgICB9KShwb3MwLCByZXN1bHQwWzJdKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICAgICAgICAgIHBvczEgPSBwb3M7XG4gICAgICAgICAgICAgICAgaWYgKGlucHV0LnN1YnN0cihwb3MsIDUpID09PSBcImNlaWwoXCIpIHtcbiAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBcImNlaWwoXCI7XG4gICAgICAgICAgICAgICAgICBwb3MgKz0gNTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJcXFwiY2VpbChcXFwiXCIpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgcmVzdWx0MSA9IHBhcnNlX18oKTtcbiAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdDIgPSBwYXJzZV9yb2xsRXhwcmVzc2lvbigpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0MiAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDMgPSBwYXJzZV9fKCk7XG4gICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdDMgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnB1dC5jaGFyQ29kZUF0KHBvcykgPT09IDQxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDQgPSBcIilcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zKys7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQ0ID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcG9ydEZhaWx1cmVzID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJcXFwiKVxcXCJcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQ0ICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBbcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0MiwgcmVzdWx0MywgcmVzdWx0NF07XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIHJleHApIHtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1lcmdlRXhwcmVzc2lvbnMoXCJjZWlsKFwiLCBtZXJnZUV4cHJlc3Npb25zKHJleHAsIFwiKVwiKSk7XG4gICAgICAgICAgICAgICAgICB9KShwb3MwLCByZXN1bHQwWzJdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICAgICAgICAgICAgcG9zMSA9IHBvcztcbiAgICAgICAgICAgICAgICAgIGlmIChpbnB1dC5zdWJzdHIocG9zLCA2KSA9PT0gXCJyb3VuZChcIikge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gXCJyb3VuZChcIjtcbiAgICAgICAgICAgICAgICAgICAgcG9zICs9IDY7XG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcG9ydEZhaWx1cmVzID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJcXFwicm91bmQoXFxcIlwiKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0MSA9IHBhcnNlX18oKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdDEgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXN1bHQyID0gcGFyc2Vfcm9sbEV4cHJlc3Npb24oKTtcbiAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0MiAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0MyA9IHBhcnNlX18oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQzICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnB1dC5jaGFyQ29kZUF0KHBvcykgPT09IDQxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0NCA9IFwiKVwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvcysrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDQgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJcXFwiKVxcXCJcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQ0ICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IFtyZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyLCByZXN1bHQzLCByZXN1bHQ0XTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSAoZnVuY3Rpb24ob2Zmc2V0LCByZXhwKSB7XG4gICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWVyZ2VFeHByZXNzaW9ucyhcInJvdW5kKFwiLCBtZXJnZUV4cHJlc3Npb25zKHJleHAsIFwiKVwiKSk7XG4gICAgICAgICAgICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMl0pO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgICAgICAgICAgICAgIHBvczEgPSBwb3M7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpbnB1dC5zdWJzdHIocG9zLCA0KSA9PT0gXCJhYnMoXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gXCJhYnMoXCI7XG4gICAgICAgICAgICAgICAgICAgICAgcG9zICs9IDQ7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcG9ydEZhaWx1cmVzID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtYXRjaEZhaWxlZChcIlxcXCJhYnMoXFxcIlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXN1bHQxID0gcGFyc2VfXygpO1xuICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQyID0gcGFyc2Vfcm9sbEV4cHJlc3Npb24oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQyICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDMgPSBwYXJzZV9fKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQzICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlucHV0LmNoYXJDb2RlQXQocG9zKSA9PT0gNDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDQgPSBcIilcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvcysrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQ0ID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaEZhaWxlZChcIlxcXCIpXFxcIlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdDQgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBbcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0MiwgcmVzdWx0MywgcmVzdWx0NF07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSAoZnVuY3Rpb24ob2Zmc2V0LCByZXhwKSB7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1lcmdlRXhwcmVzc2lvbnMoXCJhYnMoXCIsIG1lcmdlRXhwcmVzc2lvbnMocmV4cCwgXCIpXCIpKTtcbiAgICAgICAgICAgICAgICAgICAgICB9KShwb3MwLCByZXN1bHQwWzJdKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICAgICAgICAgICAgICAgIHBvczEgPSBwb3M7XG4gICAgICAgICAgICAgICAgICAgICAgaWYgKGlucHV0LmNoYXJDb2RlQXQocG9zKSA9PT0gNDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBcIihcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvcysrO1xuICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaEZhaWxlZChcIlxcXCIoXFxcIlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDEgPSBwYXJzZV9fKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQyID0gcGFyc2Vfcm9sbEV4cHJlc3Npb24oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdDIgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQzID0gcGFyc2VfXygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQzICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5wdXQuY2hhckNvZGVBdChwb3MpID09PSA0MSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQ0ID0gXCIpXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvcysrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0NCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcIilcXFwiXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0NCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gW3Jlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDIsIHJlc3VsdDMsIHJlc3VsdDRdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSAoZnVuY3Rpb24ob2Zmc2V0LCByZXhwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtZXJnZUV4cHJlc3Npb25zKFwiKFwiLCBtZXJnZUV4cHJlc3Npb25zKHJleHAsIFwiKVwiKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KShwb3MwLCByZXN1bHQwWzJdKTtcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQwO1xuICAgICAgfVxuICAgICAgXG4gICAgICBmdW5jdGlvbiBwYXJzZV92YWxpZFJvbGxTdWZmaXgoKSB7XG4gICAgICAgIHZhciByZXN1bHQwO1xuICAgICAgICB2YXIgcG9zMDtcbiAgICAgICAgXG4gICAgICAgIHJlc3VsdDAgPSBwYXJzZV9fXygpO1xuICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDAgPSBwYXJzZV9pbmxpbmVMYWJlbFdpdGhTcGFjZSgpO1xuICAgICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgICBpZiAoaW5wdXQuY2hhckNvZGVBdChwb3MpID09PSAxMjUpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IFwifVwiO1xuICAgICAgICAgICAgICBwb3MrKztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgICAgICBtYXRjaEZhaWxlZChcIlxcXCJ9XFxcIlwiKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgaWYgKGlucHV0LmNoYXJDb2RlQXQocG9zKSA9PT0gNDQpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQwID0gXCIsXCI7XG4gICAgICAgICAgICAgICAgcG9zKys7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgaWYgKHJlcG9ydEZhaWx1cmVzID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICBtYXRjaEZhaWxlZChcIlxcXCIsXFxcIlwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICBpZiAoaW5wdXQuY2hhckNvZGVBdChwb3MpID09PSA0MSkge1xuICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IFwiKVwiO1xuICAgICAgICAgICAgICAgICAgcG9zKys7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgaWYgKHJlcG9ydEZhaWx1cmVzID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcIilcXFwiXCIpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgICAgICAgICAgIHJlcG9ydEZhaWx1cmVzKys7XG4gICAgICAgICAgICAgICAgICByZXN1bHQwID0gcGFyc2Vfb3BlcmF0b3IoKTtcbiAgICAgICAgICAgICAgICAgIHJlcG9ydEZhaWx1cmVzLS07XG4gICAgICAgICAgICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgICAgICAgICAgICAgcmVwb3J0RmFpbHVyZXMrKztcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlucHV0Lmxlbmd0aCA+IHBvcykge1xuICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBpbnB1dC5jaGFyQXQocG9zKTtcbiAgICAgICAgICAgICAgICAgICAgICBwb3MrKztcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiYW55IGNoYXJhY3RlclwiKTtcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmVwb3J0RmFpbHVyZXMtLTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gXCJcIjtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICBwb3MgPSBwb3MwO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQwO1xuICAgICAgfVxuICAgICAgXG4gICAgICBmdW5jdGlvbiBwYXJzZV9yb2xsR3JvdXAoKSB7XG4gICAgICAgIHZhciByZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyLCByZXN1bHQzLCByZXN1bHQ0LCByZXN1bHQ1O1xuICAgICAgICB2YXIgcG9zMCwgcG9zMTtcbiAgICAgICAgXG4gICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgIHBvczEgPSBwb3M7XG4gICAgICAgIGlmIChpbnB1dC5jaGFyQ29kZUF0KHBvcykgPT09IDEyMykge1xuICAgICAgICAgIHJlc3VsdDAgPSBcIntcIjtcbiAgICAgICAgICBwb3MrKztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcIntcXFwiXCIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDEgPSBwYXJzZV9fKCk7XG4gICAgICAgICAgaWYgKHJlc3VsdDEgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlc3VsdDIgPSBwYXJzZV9yb2xsR3JvdXBFeHByZXNzaW9uKCk7XG4gICAgICAgICAgICBpZiAocmVzdWx0MiAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICByZXN1bHQzID0gcGFyc2VfXygpO1xuICAgICAgICAgICAgICBpZiAocmVzdWx0MyAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGlmIChpbnB1dC5jaGFyQ29kZUF0KHBvcykgPT09IDEyNSkge1xuICAgICAgICAgICAgICAgICAgcmVzdWx0NCA9IFwifVwiO1xuICAgICAgICAgICAgICAgICAgcG9zKys7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIHJlc3VsdDQgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgaWYgKHJlcG9ydEZhaWx1cmVzID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcIn1cXFwiXCIpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0NCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgcmVzdWx0NSA9IHBhcnNlX2dyb3VwTW9kcygpO1xuICAgICAgICAgICAgICAgICAgcmVzdWx0NSA9IHJlc3VsdDUgIT09IG51bGwgPyByZXN1bHQ1IDogXCJcIjtcbiAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQ1ICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBbcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0MiwgcmVzdWx0MywgcmVzdWx0NCwgcmVzdWx0NV07XG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIHJvbGxzLCBtb2QpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgR3JvdXBFeHByZXNzaW9uKHJvbGxzLCBtb2QpO1xuICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMl0sIHJlc3VsdDBbNV0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0MDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZnVuY3Rpb24gcGFyc2Vfcm9sbEdyb3VwRXhwcmVzc2lvbigpIHtcbiAgICAgICAgdmFyIHJlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDIsIHJlc3VsdDMsIHJlc3VsdDQ7XG4gICAgICAgIHZhciBwb3MwLCBwb3MxO1xuICAgICAgICBcbiAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgcG9zMSA9IHBvcztcbiAgICAgICAgcmVzdWx0MCA9IHBhcnNlX3JvbGxFeHByZXNzaW9uKCk7XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IHBhcnNlX3JvbGxHcm91cCgpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MSA9IHBhcnNlX18oKTtcbiAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgaWYgKGlucHV0LmNoYXJDb2RlQXQocG9zKSA9PT0gNDQpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MiA9IFwiLFwiO1xuICAgICAgICAgICAgICBwb3MrKztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDIgPSBudWxsO1xuICAgICAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgICAgICBtYXRjaEZhaWxlZChcIlxcXCIsXFxcIlwiKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHJlc3VsdDIgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MyA9IHBhcnNlX18oKTtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdDMgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQ0ID0gcGFyc2Vfcm9sbEdyb3VwRXhwcmVzc2lvbigpO1xuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQ0ICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHQwID0gW3Jlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDIsIHJlc3VsdDMsIHJlc3VsdDRdO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgbGVmdCwgcmlnaHQpIHtcbiAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShsZWZ0KSkge1xuICAgICAgICAgICAgICBsZWZ0ID0gW2xlZnRdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHJpZ2h0ICE9PSBcIlwiKSB7XG4gICAgICAgICAgICAgIHJldHVybiBbbGVmdF0uY29uY2F0KHJpZ2h0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gbGVmdDtcbiAgICAgICAgICB9KShwb3MwLCByZXN1bHQwWzBdLCByZXN1bHQwWzRdKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICAgIHJlc3VsdDAgPSBwYXJzZV9yb2xsRXhwcmVzc2lvbigpO1xuICAgICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQwID0gcGFyc2Vfcm9sbEdyb3VwKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgbGVmdCkgeyBcbiAgICAgICAgICAgICAgcmV0dXJuIFtsZWZ0XTtcbiAgICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDApO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDA7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZ1bmN0aW9uIHBhcnNlX2xhYmVsQXdhcmVSb2xsT3BlcmF0b3IoKSB7XG4gICAgICAgIHZhciByZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyO1xuICAgICAgICB2YXIgcG9zMCwgcG9zMTtcbiAgICAgICAgXG4gICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgIHBvczEgPSBwb3M7XG4gICAgICAgIHJlc3VsdDAgPSBwYXJzZV9yb2xsT3BlcmF0b3IoKTtcbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQxID0gW107XG4gICAgICAgICAgcmVzdWx0MiA9IHBhcnNlX3JvbGxPcGVyYXRvcigpO1xuICAgICAgICAgIGlmIChyZXN1bHQyID09PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQyID0gcGFyc2VfaW5saW5lTGFiZWxXaXRoU3BhY2UoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgd2hpbGUgKHJlc3VsdDIgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlc3VsdDEucHVzaChyZXN1bHQyKTtcbiAgICAgICAgICAgIHJlc3VsdDIgPSBwYXJzZV9yb2xsT3BlcmF0b3IoKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQyID09PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJlc3VsdDIgPSBwYXJzZV9pbmxpbmVMYWJlbFdpdGhTcGFjZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MCA9IFtyZXN1bHQwLCByZXN1bHQxXTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIG9wZXIsIGFkZGwpIHtcbiAgICAgICAgICAgIHZhciByZXN1bHQgPSBvcGVyO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhZGRsLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgIHJlc3VsdCA9IG1lcmdlRXhwcmVzc2lvbnMocmVzdWx0LCBhZGRsW2ldKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgfSkocG9zMCwgcmVzdWx0MFswXSwgcmVzdWx0MFsxXSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICBwb3MgPSBwb3MwO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgICBwb3MxID0gcG9zO1xuICAgICAgICAgIHJlc3VsdDAgPSBwYXJzZV9pbmxpbmVMYWJlbFdpdGhTcGFjZSgpO1xuICAgICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQxID0gcGFyc2VfbGFiZWxBd2FyZVJvbGxPcGVyYXRvcigpO1xuICAgICAgICAgICAgaWYgKHJlc3VsdDEgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IFtyZXN1bHQwLCByZXN1bHQxXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgbGJsLCBvcGVyKSB7XG4gICAgICAgICAgICAgIHJldHVybiBtZXJnZUV4cHJlc3Npb25zKGxibCwgb3Blcik7XG4gICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMF0sIHJlc3VsdDBbMV0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDA7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZ1bmN0aW9uIHBhcnNlX3JvbGxPcGVyYXRvcigpIHtcbiAgICAgICAgdmFyIHJlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDIsIHJlc3VsdDMsIHJlc3VsdDQsIHJlc3VsdDUsIHJlc3VsdDY7XG4gICAgICAgIHZhciBwb3MwLCBwb3MxO1xuICAgICAgICBcbiAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgcG9zMSA9IHBvcztcbiAgICAgICAgcmVzdWx0MCA9IHBhcnNlX18oKTtcbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQxID0gcGFyc2Vfb3BlcmF0b3IoKTtcbiAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MiA9IHBhcnNlX18oKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQyICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJlc3VsdDMgPSBwYXJzZV9tYXRoRXhwcmVzc2lvblByaW1hcnkoKTtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdDMgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQ0ID0gcGFyc2VfXygpO1xuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQ0ICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHQ1ID0gcGFyc2Vfcm9sbE9wZXJhdG9yKCk7XG4gICAgICAgICAgICAgICAgICBpZiAocmVzdWx0NSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQ2ID0gcGFyc2VfXygpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0NiAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBbcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0MiwgcmVzdWx0MywgcmVzdWx0NCwgcmVzdWx0NSwgcmVzdWx0Nl07XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDAgPSAoZnVuY3Rpb24ob2Zmc2V0LCBsZWZ0LCBudW0sIHJpZ2h0KSB7XG4gICAgICAgICAgICByZXR1cm4gbGVmdCArIG51bSArIHJpZ2h0O1xuICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMV0sIHJlc3VsdDBbM10sIHJlc3VsdDBbNV0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgICAgcG9zMSA9IHBvcztcbiAgICAgICAgICByZXN1bHQwID0gcGFyc2VfXygpO1xuICAgICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQxID0gcGFyc2Vfb3BlcmF0b3IoKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJlc3VsdDIgPSBwYXJzZV9fKCk7XG4gICAgICAgICAgICAgIGlmIChyZXN1bHQyICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0MCA9IFtyZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyXTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIG9wZXIpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIG9wZXI7XG4gICAgICAgICAgICB9KShwb3MwLCByZXN1bHQwWzFdKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQwO1xuICAgICAgfVxuICAgICAgXG4gICAgICBmdW5jdGlvbiBwYXJzZV9mdWxsUm9sbCgpIHtcbiAgICAgICAgdmFyIHJlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDI7XG4gICAgICAgIHZhciBwb3MwLCBwb3MxO1xuICAgICAgICBcbiAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgcG9zMSA9IHBvcztcbiAgICAgICAgcmVzdWx0MCA9IHBhcnNlX2NvcmVSb2xsKCk7XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MSA9IHBhcnNlX3JvbGxNb2RzKCk7XG4gICAgICAgICAgcmVzdWx0MSA9IHJlc3VsdDEgIT09IG51bGwgPyByZXN1bHQxIDogXCJcIjtcbiAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MCA9IFtyZXN1bHQwLCByZXN1bHQxXTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIHJvbGwsIG1vZCkge1xuICAgICAgICAgICAgaWYgKG1vZCAhPT0gXCJcIikge1xuICAgICAgICAgICAgICByb2xsLm1vZHMgPSBtb2Q7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIHJvbGw7XG4gICAgICAgICAgfSkocG9zMCwgcmVzdWx0MFswXSwgcmVzdWx0MFsxXSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICBwb3MgPSBwb3MwO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgICBwb3MxID0gcG9zO1xuICAgICAgICAgIHJlc3VsdDAgPSBwYXJzZV9udW1iZXJPZkRpY2UoKTtcbiAgICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgaWYgKGlucHV0LnN1YnN0cihwb3MsIDEpLnRvTG93ZXJDYXNlKCkgPT09IFwidFwiKSB7XG4gICAgICAgICAgICAgIHJlc3VsdDEgPSBpbnB1dC5zdWJzdHIocG9zLCAxKTtcbiAgICAgICAgICAgICAgcG9zKys7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXN1bHQxID0gbnVsbDtcbiAgICAgICAgICAgICAgaWYgKHJlcG9ydEZhaWx1cmVzID09PSAwKSB7XG4gICAgICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJcXFwidFxcXCJcIik7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJlc3VsdDIgPSBwYXJzZV9pbmxpbmVMYWJlbCgpO1xuICAgICAgICAgICAgICBpZiAocmVzdWx0MiAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBbcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0Ml07XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSAoZnVuY3Rpb24ob2Zmc2V0LCBjb3VudCwgdGFibGUpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBUYWJsZVJvbGxFeHByZXNzaW9uKGNvdW50LCB0YWJsZS50ZXh0KTtcbiAgICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMF0sIHJlc3VsdDBbMl0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDA7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZ1bmN0aW9uIHBhcnNlX2NvcmVSb2xsKCkge1xuICAgICAgICB2YXIgcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0MjtcbiAgICAgICAgdmFyIHBvczAsIHBvczE7XG4gICAgICAgIFxuICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICBwb3MxID0gcG9zO1xuICAgICAgICByZXN1bHQwID0gcGFyc2VfbnVtYmVyT2ZEaWNlKCk7XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgaWYgKGlucHV0LnN1YnN0cihwb3MsIDEpLnRvTG93ZXJDYXNlKCkgPT09IFwiZFwiKSB7XG4gICAgICAgICAgICByZXN1bHQxID0gaW5wdXQuc3Vic3RyKHBvcywgMSk7XG4gICAgICAgICAgICBwb3MrKztcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MSA9IG51bGw7XG4gICAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJcXFwiZFxcXCJcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICBpZiAoaW5wdXQuc3Vic3RyKHBvcywgMSkudG9Mb3dlckNhc2UoKSA9PT0gXCJmXCIpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MiA9IGlucHV0LnN1YnN0cihwb3MsIDEpO1xuICAgICAgICAgICAgICBwb3MrKztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDIgPSBudWxsO1xuICAgICAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgICAgICBtYXRjaEZhaWxlZChcIlxcXCJmXFxcIlwiKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHJlc3VsdDIgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IFtyZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgY291bnQpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgRmF0ZVJvbGxFeHByZXNzaW9uKGNvdW50KTtcbiAgICAgICAgICB9KShwb3MwLCByZXN1bHQwWzBdKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICAgIHBvczEgPSBwb3M7XG4gICAgICAgICAgcmVzdWx0MCA9IHBhcnNlX251bWJlck9mRGljZSgpO1xuICAgICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgICBpZiAoaW5wdXQuc3Vic3RyKHBvcywgMSkudG9Mb3dlckNhc2UoKSA9PT0gXCJkXCIpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MSA9IGlucHV0LnN1YnN0cihwb3MsIDEpO1xuICAgICAgICAgICAgICBwb3MrKztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDEgPSBudWxsO1xuICAgICAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgICAgICBtYXRjaEZhaWxlZChcIlxcXCJkXFxcIlwiKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHJlc3VsdDEgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MiA9IHBhcnNlX251bWJlck9mU2lkZXMoKTtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdDIgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQwID0gW3Jlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDJdO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgY291bnQsIHNpZGVzKSB7XG4gICAgICAgICAgICAgIHJldHVybiBuZXcgUm9sbEV4cHJlc3Npb24oY291bnQsIHNpZGVzKTtcbiAgICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMF0sIHJlc3VsdDBbMl0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDA7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZ1bmN0aW9uIHBhcnNlX251bWJlck9mRGljZSgpIHtcbiAgICAgICAgdmFyIHJlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDIsIHJlc3VsdDMsIHJlc3VsdDQ7XG4gICAgICAgIHZhciBwb3MwLCBwb3MxO1xuICAgICAgICBcbiAgICAgICAgcmVzdWx0MCA9IHBhcnNlX2ludGVnZXIoKTtcbiAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICAgIHBvczEgPSBwb3M7XG4gICAgICAgICAgaWYgKGlucHV0LmNoYXJDb2RlQXQocG9zKSA9PT0gNDApIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSBcIihcIjtcbiAgICAgICAgICAgIHBvcysrO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICBtYXRjaEZhaWxlZChcIlxcXCIoXFxcIlwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlc3VsdDEgPSBwYXJzZV9fKCk7XG4gICAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICByZXN1bHQyID0gcGFyc2VfbWF0aEV4cHJlc3Npb24oKTtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdDIgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQzID0gcGFyc2VfXygpO1xuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQzICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICBpZiAoaW5wdXQuY2hhckNvZGVBdChwb3MpID09PSA0MSkge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQ0ID0gXCIpXCI7XG4gICAgICAgICAgICAgICAgICAgIHBvcysrO1xuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0NCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcIilcXFwiXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICBpZiAocmVzdWx0NCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gW3Jlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDIsIHJlc3VsdDMsIHJlc3VsdDRdO1xuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSAoZnVuY3Rpb24ob2Zmc2V0LCBleHByKSB7XG4gICAgICAgICAgICAgIHJldHVybiBNYXRoLnJvdW5kKGV2YWwoXCIoXCIgKyBleHByICsgXCIpXCIpKTtcbiAgICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMl0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgICAgICByZXN1bHQwID0gXCJcIjtcbiAgICAgICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSAoZnVuY3Rpb24ob2Zmc2V0KSB7IHJldHVybiAxOyB9KShwb3MwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQwO1xuICAgICAgfVxuICAgICAgXG4gICAgICBmdW5jdGlvbiBwYXJzZV9udW1iZXJPZlNpZGVzKCkge1xuICAgICAgICB2YXIgcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0MiwgcmVzdWx0MywgcmVzdWx0NDtcbiAgICAgICAgdmFyIHBvczAsIHBvczE7XG4gICAgICAgIFxuICAgICAgICByZXN1bHQwID0gcGFyc2VfaW50ZWdlcigpO1xuICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgICAgcG9zMSA9IHBvcztcbiAgICAgICAgICBpZiAoaW5wdXQuY2hhckNvZGVBdChwb3MpID09PSA0MCkge1xuICAgICAgICAgICAgcmVzdWx0MCA9IFwiKFwiO1xuICAgICAgICAgICAgcG9zKys7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgaWYgKHJlcG9ydEZhaWx1cmVzID09PSAwKSB7XG4gICAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcIihcXFwiXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MSA9IHBhcnNlX18oKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJlc3VsdDIgPSBwYXJzZV9tYXRoRXhwcmVzc2lvbigpO1xuICAgICAgICAgICAgICBpZiAocmVzdWx0MiAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHJlc3VsdDMgPSBwYXJzZV9fKCk7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdDMgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgIGlmIChpbnB1dC5jaGFyQ29kZUF0KHBvcykgPT09IDQxKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdDQgPSBcIilcIjtcbiAgICAgICAgICAgICAgICAgICAgcG9zKys7XG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQ0ID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcG9ydEZhaWx1cmVzID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJcXFwiKVxcXCJcIik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQ0ICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBbcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0MiwgcmVzdWx0MywgcmVzdWx0NF07XG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIGV4cHIpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIE1hdGgucm91bmQoZXZhbChcIihcIiArIGV4cHIgKyBcIilcIikpO1xuICAgICAgICAgICAgfSkocG9zMCwgcmVzdWx0MFsyXSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgICBwb3MgPSBwb3MwO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgICAgIGlmIChpbnB1dC5zdWJzdHIocG9zLCAxKS50b0xvd2VyQ2FzZSgpID09PSBcImZcIikge1xuICAgICAgICAgICAgICByZXN1bHQwID0gaW5wdXQuc3Vic3RyKHBvcywgMSk7XG4gICAgICAgICAgICAgIHBvcysrO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcImZcXFwiXCIpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCkgeyByZXR1cm4gXCJGXCI7IH0pKHBvczApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDA7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZ1bmN0aW9uIHBhcnNlX2dyb3VwTW9kcygpIHtcbiAgICAgICAgdmFyIHJlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDI7XG4gICAgICAgIHZhciBwb3MwLCBwb3MxO1xuICAgICAgICBcbiAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgcG9zMSA9IHBvcztcbiAgICAgICAgcmVzdWx0MCA9IHBhcnNlX2tlZXBNb2QoKTtcbiAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gcGFyc2VfZHJvcE1vZCgpO1xuICAgICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQwID0gcGFyc2VfbXVsdGlwbGVNb2QoKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBwYXJzZV9tYXRjaFRvdGFsTW9kKCk7XG4gICAgICAgICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0MCA9IHBhcnNlX21hdGNoTW9kKCk7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBwYXJzZV9zdWNjZXNzTW9kKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MSA9IFtdO1xuICAgICAgICAgIHJlc3VsdDIgPSBwYXJzZV9ncm91cE1vZHMoKTtcbiAgICAgICAgICB3aGlsZSAocmVzdWx0MiAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MS5wdXNoKHJlc3VsdDIpO1xuICAgICAgICAgICAgcmVzdWx0MiA9IHBhcnNlX2dyb3VwTW9kcygpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MCA9IFtyZXN1bHQwLCByZXN1bHQxXTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIGhlYWQsIHRhaWwpIHtcbiAgICAgICAgICAgIHJldHVybiBwcm9jZXNzTW9kcyhoZWFkLCB0YWlsKTtcbiAgICAgICAgICB9KShwb3MwLCByZXN1bHQwWzBdLCByZXN1bHQwWzFdKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDA7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZ1bmN0aW9uIHBhcnNlX3JvbGxNb2RzKCkge1xuICAgICAgICB2YXIgcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0MjtcbiAgICAgICAgdmFyIHBvczAsIHBvczE7XG4gICAgICAgIFxuICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICBwb3MxID0gcG9zO1xuICAgICAgICByZXN1bHQwID0gcGFyc2VfY29tcG91bmRpbmdNb2QoKTtcbiAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gcGFyc2VfcGVuZXRyYXRpbmdNb2QoKTtcbiAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MCA9IHBhcnNlX2V4cGxvZGluZ01vZCgpO1xuICAgICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IHBhcnNlX2tlZXBNb2QoKTtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQwID0gcGFyc2VfZHJvcE1vZCgpO1xuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHQwID0gcGFyc2VfcmVyb2xsT25jZU1vZCgpO1xuICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IHBhcnNlX3Jlcm9sbE1vZCgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBwYXJzZV9jdXN0b21Dcml0TW9kKCk7XG4gICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBwYXJzZV9jdXN0b21GdW1ibGVNb2QoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBwYXJzZV9zb3J0TW9kKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IHBhcnNlX21hdGNoVG90YWxNb2QoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IHBhcnNlX21hdGNoTW9kKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gcGFyc2Vfc3VjY2Vzc01vZCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDEgPSBbXTtcbiAgICAgICAgICByZXN1bHQyID0gcGFyc2Vfcm9sbE1vZHMoKTtcbiAgICAgICAgICB3aGlsZSAocmVzdWx0MiAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MS5wdXNoKHJlc3VsdDIpO1xuICAgICAgICAgICAgcmVzdWx0MiA9IHBhcnNlX3JvbGxNb2RzKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQwID0gW3Jlc3VsdDAsIHJlc3VsdDFdO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgaGVhZCwgdGFpbCkge1xuICAgICAgICAgICAgcmV0dXJuIHByb2Nlc3NNb2RzKGhlYWQsIHRhaWwpO1xuICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMF0sIHJlc3VsdDBbMV0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0MDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZnVuY3Rpb24gcGFyc2VfZXhwbG9kaW5nTW9kKCkge1xuICAgICAgICB2YXIgcmVzdWx0MCwgcmVzdWx0MTtcbiAgICAgICAgdmFyIHBvczAsIHBvczE7XG4gICAgICAgIFxuICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICBwb3MxID0gcG9zO1xuICAgICAgICBpZiAoaW5wdXQuY2hhckNvZGVBdChwb3MpID09PSAzMykge1xuICAgICAgICAgIHJlc3VsdDAgPSBcIiFcIjtcbiAgICAgICAgICBwb3MrKztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcIiFcXFwiXCIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDEgPSBwYXJzZV9jb21wYXJpc29uUG9pbnQoKTtcbiAgICAgICAgICByZXN1bHQxID0gcmVzdWx0MSAhPT0gbnVsbCA/IHJlc3VsdDEgOiBcIlwiO1xuICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQwID0gW3Jlc3VsdDAsIHJlc3VsdDFdO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgY3ApIHtcbiAgICAgICAgICAgIHJldHVybiB7IFxuICAgICAgICAgICAgICBleHBsb2Rpbmc6IGNwXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMV0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0MDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZnVuY3Rpb24gcGFyc2VfY29tcG91bmRpbmdNb2QoKSB7XG4gICAgICAgIHZhciByZXN1bHQwLCByZXN1bHQxO1xuICAgICAgICB2YXIgcG9zMCwgcG9zMTtcbiAgICAgICAgXG4gICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgIHBvczEgPSBwb3M7XG4gICAgICAgIGlmIChpbnB1dC5zdWJzdHIocG9zLCAyKSA9PT0gXCIhIVwiKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IFwiISFcIjtcbiAgICAgICAgICBwb3MgKz0gMjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcIiEhXFxcIlwiKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQxID0gcGFyc2VfY29tcGFyaXNvblBvaW50KCk7XG4gICAgICAgICAgcmVzdWx0MSA9IHJlc3VsdDEgIT09IG51bGwgPyByZXN1bHQxIDogXCJcIjtcbiAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MCA9IFtyZXN1bHQwLCByZXN1bHQxXTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIGNwKSB7XG4gICAgICAgICAgICByZXR1cm4geyBcbiAgICAgICAgICAgICAgY29tcG91bmRpbmc6IGNwXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMV0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0MDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZnVuY3Rpb24gcGFyc2VfcGVuZXRyYXRpbmdNb2QoKSB7XG4gICAgICAgIHZhciByZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyO1xuICAgICAgICB2YXIgcG9zMCwgcG9zMTtcbiAgICAgICAgXG4gICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgIHBvczEgPSBwb3M7XG4gICAgICAgIGlmIChpbnB1dC5jaGFyQ29kZUF0KHBvcykgPT09IDMzKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IFwiIVwiO1xuICAgICAgICAgIHBvcysrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJcXFwiIVxcXCJcIik7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgaWYgKGlucHV0LnN1YnN0cihwb3MsIDEpLnRvTG93ZXJDYXNlKCkgPT09IFwicFwiKSB7XG4gICAgICAgICAgICByZXN1bHQxID0gaW5wdXQuc3Vic3RyKHBvcywgMSk7XG4gICAgICAgICAgICBwb3MrKztcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MSA9IG51bGw7XG4gICAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJcXFwicFxcXCJcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQyID0gcGFyc2VfY29tcGFyaXNvblBvaW50KCk7XG4gICAgICAgICAgICByZXN1bHQyID0gcmVzdWx0MiAhPT0gbnVsbCA/IHJlc3VsdDIgOiBcIlwiO1xuICAgICAgICAgICAgaWYgKHJlc3VsdDIgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IFtyZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgY3ApIHtcbiAgICAgICAgICAgIHJldHVybiB7IFxuICAgICAgICAgICAgICBwZW5ldHJhdGluZzogY3BcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfSkocG9zMCwgcmVzdWx0MFsyXSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICBwb3MgPSBwb3MwO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQwO1xuICAgICAgfVxuICAgICAgXG4gICAgICBmdW5jdGlvbiBwYXJzZV9rZWVwTW9kKCkge1xuICAgICAgICB2YXIgcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0MjtcbiAgICAgICAgdmFyIHBvczAsIHBvczE7XG4gICAgICAgIFxuICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICBwb3MxID0gcG9zO1xuICAgICAgICBpZiAoaW5wdXQuc3Vic3RyKHBvcywgMSkudG9Mb3dlckNhc2UoKSA9PT0gXCJrXCIpIHtcbiAgICAgICAgICByZXN1bHQwID0gaW5wdXQuc3Vic3RyKHBvcywgMSk7XG4gICAgICAgICAgcG9zKys7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgaWYgKHJlcG9ydEZhaWx1cmVzID09PSAwKSB7XG4gICAgICAgICAgICBtYXRjaEZhaWxlZChcIlxcXCJrXFxcIlwiKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICBpZiAoL15bJ2gnfCdsJ10vaS50ZXN0KGlucHV0LmNoYXJBdChwb3MpKSkge1xuICAgICAgICAgICAgcmVzdWx0MSA9IGlucHV0LmNoYXJBdChwb3MpO1xuICAgICAgICAgICAgcG9zKys7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdDEgPSBudWxsO1xuICAgICAgICAgICAgaWYgKHJlcG9ydEZhaWx1cmVzID09PSAwKSB7XG4gICAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiWydoJ3wnbCddaVwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgcmVzdWx0MSA9IHJlc3VsdDEgIT09IG51bGwgPyByZXN1bHQxIDogXCJcIjtcbiAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MiA9IHBhcnNlX2ludGVnZXIoKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQyICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBbcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0Ml07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIGhsLCBjb3VudCkge1xuICAgICAgICAgICAgcmV0dXJuIHsgXG4gICAgICAgICAgICAgIGtlZXA6IHtcbiAgICAgICAgICAgICAgICBlbmQ6IChobC50b0xvd2VyQ2FzZSgpIHx8ICdoJyksXG4gICAgICAgICAgICAgICAgY291bnQ6Y291bnRcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9KShwb3MwLCByZXN1bHQwWzFdLCByZXN1bHQwWzJdKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDA7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZ1bmN0aW9uIHBhcnNlX2Ryb3BNb2QoKSB7XG4gICAgICAgIHZhciByZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyO1xuICAgICAgICB2YXIgcG9zMCwgcG9zMTtcbiAgICAgICAgXG4gICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgIHBvczEgPSBwb3M7XG4gICAgICAgIGlmIChpbnB1dC5zdWJzdHIocG9zLCAxKS50b0xvd2VyQ2FzZSgpID09PSBcImRcIikge1xuICAgICAgICAgIHJlc3VsdDAgPSBpbnB1dC5zdWJzdHIocG9zLCAxKTtcbiAgICAgICAgICBwb3MrKztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcImRcXFwiXCIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIGlmICgvXlsnaCd8J2wnXS9pLnRlc3QoaW5wdXQuY2hhckF0KHBvcykpKSB7XG4gICAgICAgICAgICByZXN1bHQxID0gaW5wdXQuY2hhckF0KHBvcyk7XG4gICAgICAgICAgICBwb3MrKztcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MSA9IG51bGw7XG4gICAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJbJ2gnfCdsJ11pXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXN1bHQxID0gcmVzdWx0MSAhPT0gbnVsbCA/IHJlc3VsdDEgOiBcIlwiO1xuICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQyID0gcGFyc2VfaW50ZWdlcigpO1xuICAgICAgICAgICAgaWYgKHJlc3VsdDIgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IFtyZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgaGwsIGNvdW50KSB7XG4gICAgICAgICAgICByZXR1cm4geyBcbiAgICAgICAgICAgICAgZHJvcDoge1xuICAgICAgICAgICAgICAgIGVuZDogKGhsLnRvTG93ZXJDYXNlKCkgfHwgJ2wnKSxcbiAgICAgICAgICAgICAgICBjb3VudDpjb3VudFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMV0sIHJlc3VsdDBbMl0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0MDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZnVuY3Rpb24gcGFyc2VfY3VzdG9tQ3JpdE1vZCgpIHtcbiAgICAgICAgdmFyIHJlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDI7XG4gICAgICAgIHZhciBwb3MwLCBwb3MxO1xuICAgICAgICBcbiAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgcG9zMSA9IHBvcztcbiAgICAgICAgaWYgKGlucHV0LnN1YnN0cihwb3MsIDIpLnRvTG93ZXJDYXNlKCkgPT09IFwiY3NcIikge1xuICAgICAgICAgIHJlc3VsdDAgPSBpbnB1dC5zdWJzdHIocG9zLCAyKTtcbiAgICAgICAgICBwb3MgKz0gMjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcImNzXFxcIlwiKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQxID0gcGFyc2VfY29tcGFyaXNvblBvaW50KCk7XG4gICAgICAgICAgcmVzdWx0MSA9IHJlc3VsdDEgIT09IG51bGwgPyByZXN1bHQxIDogXCJcIjtcbiAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MiA9IHBhcnNlX2N1c3RvbUNyaXRNb2QoKTtcbiAgICAgICAgICAgIHJlc3VsdDIgPSByZXN1bHQyICE9PSBudWxsID8gcmVzdWx0MiA6IFwiXCI7XG4gICAgICAgICAgICBpZiAocmVzdWx0MiAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICByZXN1bHQwID0gW3Jlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDJdO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDAgPSAoZnVuY3Rpb24ob2Zmc2V0LCBjcCwgdGFpbCkge1xuICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHtcbiAgICAgICAgICAgICAgY3VzdG9tQ3JpdDogKGNwICE9PSBcIlwiID8gW2NwXSA6IFt7fV0pXG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIGlmICh0YWlsICE9PSBcIlwiKSB7XG4gICAgICAgICAgICAgIHJlc3VsdC5jdXN0b21Dcml0ID0gcmVzdWx0LmN1c3RvbUNyaXQuY29uY2F0KHRhaWwuY3VzdG9tQ3JpdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICB9KShwb3MwLCByZXN1bHQwWzFdLCByZXN1bHQwWzJdKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDA7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZ1bmN0aW9uIHBhcnNlX2N1c3RvbUZ1bWJsZU1vZCgpIHtcbiAgICAgICAgdmFyIHJlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDI7XG4gICAgICAgIHZhciBwb3MwLCBwb3MxO1xuICAgICAgICBcbiAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgcG9zMSA9IHBvcztcbiAgICAgICAgaWYgKGlucHV0LnN1YnN0cihwb3MsIDIpLnRvTG93ZXJDYXNlKCkgPT09IFwiY2ZcIikge1xuICAgICAgICAgIHJlc3VsdDAgPSBpbnB1dC5zdWJzdHIocG9zLCAyKTtcbiAgICAgICAgICBwb3MgKz0gMjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcImNmXFxcIlwiKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQxID0gcGFyc2VfY29tcGFyaXNvblBvaW50KCk7XG4gICAgICAgICAgcmVzdWx0MSA9IHJlc3VsdDEgIT09IG51bGwgPyByZXN1bHQxIDogXCJcIjtcbiAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MiA9IHBhcnNlX2N1c3RvbUZ1bWJsZU1vZCgpO1xuICAgICAgICAgICAgcmVzdWx0MiA9IHJlc3VsdDIgIT09IG51bGwgPyByZXN1bHQyIDogXCJcIjtcbiAgICAgICAgICAgIGlmIChyZXN1bHQyICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBbcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0Ml07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIGNwLCB0YWlsKSB7XG4gICAgICAgICAgICB2YXIgcmVzdWx0ID0ge1xuICAgICAgICAgICAgICBjdXN0b21GdW1ibGU6IChjcCAhPT0gXCJcIiA/IFtjcF0gOiBbe31dKVxuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAodGFpbCAhPT0gXCJcIikge1xuICAgICAgICAgICAgICByZXN1bHQuY3VzdG9tRnVtYmxlID0gcmVzdWx0LmN1c3RvbUZ1bWJsZS5jb25jYXQodGFpbC5jdXN0b21GdW1ibGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgfSkocG9zMCwgcmVzdWx0MFsxXSwgcmVzdWx0MFsyXSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICBwb3MgPSBwb3MwO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQwO1xuICAgICAgfVxuICAgICAgXG4gICAgICBmdW5jdGlvbiBwYXJzZV9yZXJvbGxNb2QoKSB7XG4gICAgICAgIHZhciByZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyO1xuICAgICAgICB2YXIgcG9zMCwgcG9zMTtcbiAgICAgICAgXG4gICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgIHBvczEgPSBwb3M7XG4gICAgICAgIGlmIChpbnB1dC5zdWJzdHIocG9zLCAxKS50b0xvd2VyQ2FzZSgpID09PSBcInJcIikge1xuICAgICAgICAgIHJlc3VsdDAgPSBpbnB1dC5zdWJzdHIocG9zLCAxKTtcbiAgICAgICAgICBwb3MrKztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcInJcXFwiXCIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDEgPSBwYXJzZV9jb21wYXJpc29uUG9pbnQoKTtcbiAgICAgICAgICByZXN1bHQxID0gcmVzdWx0MSAhPT0gbnVsbCA/IHJlc3VsdDEgOiBcIlwiO1xuICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQyID0gcGFyc2VfcmVyb2xsTW9kKCk7XG4gICAgICAgICAgICByZXN1bHQyID0gcmVzdWx0MiAhPT0gbnVsbCA/IHJlc3VsdDIgOiBcIlwiO1xuICAgICAgICAgICAgaWYgKHJlc3VsdDIgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IFtyZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgY3AsIHRhaWwpIHtcbiAgICAgICAgICAgIHZhciByZXN1bHQgPSB7XG4gICAgICAgICAgICAgIHJlcm9sbDogKGNwICE9PSBcIlwiID8gW2NwXSA6IFt7fV0pXG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIGlmICh0YWlsICE9PSBcIlwiKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnJlcm9sbCA9IHJlc3VsdC5yZXJvbGwuY29uY2F0KHRhaWwucmVyb2xsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMV0sIHJlc3VsdDBbMl0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0MDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZnVuY3Rpb24gcGFyc2VfcmVyb2xsT25jZU1vZCgpIHtcbiAgICAgICAgdmFyIHJlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDI7XG4gICAgICAgIHZhciBwb3MwLCBwb3MxO1xuICAgICAgICBcbiAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgcG9zMSA9IHBvcztcbiAgICAgICAgaWYgKGlucHV0LnN1YnN0cihwb3MsIDIpLnRvTG93ZXJDYXNlKCkgPT09IFwicm9cIikge1xuICAgICAgICAgIHJlc3VsdDAgPSBpbnB1dC5zdWJzdHIocG9zLCAyKTtcbiAgICAgICAgICBwb3MgKz0gMjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcInJvXFxcIlwiKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQxID0gcGFyc2VfY29tcGFyaXNvblBvaW50KCk7XG4gICAgICAgICAgcmVzdWx0MSA9IHJlc3VsdDEgIT09IG51bGwgPyByZXN1bHQxIDogXCJcIjtcbiAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MiA9IHBhcnNlX3Jlcm9sbE1vZCgpO1xuICAgICAgICAgICAgcmVzdWx0MiA9IHJlc3VsdDIgIT09IG51bGwgPyByZXN1bHQyIDogXCJcIjtcbiAgICAgICAgICAgIGlmIChyZXN1bHQyICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBbcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0Ml07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIGNwLCB0YWlsKSB7XG4gICAgICAgICAgICB2YXIgcmVzdWx0ID0ge1xuICAgICAgICAgICAgICByZXJvbGw6IChjcCAhPT0gXCJcIiA/IFtjcF0gOiBbe31dKVxuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAodGFpbCAhPT0gXCJcIikge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5yZXJvbGwgPSByZXN1bHQucmVyb2xsLmNvbmNhdCh0YWlsLnJlcm9sbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYocmVzdWx0LnJlcm9sbCAmJiByZXN1bHQucmVyb2xsWzBdKSByZXN1bHQucmVyb2xsWzBdLm1heHJlcm9sbHMgPSAxO1xuICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgfSkocG9zMCwgcmVzdWx0MFsxXSwgcmVzdWx0MFsyXSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICBwb3MgPSBwb3MwO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQwO1xuICAgICAgfVxuICAgICAgXG4gICAgICBmdW5jdGlvbiBwYXJzZV9zb3J0TW9kKCkge1xuICAgICAgICB2YXIgcmVzdWx0MCwgcmVzdWx0MTtcbiAgICAgICAgdmFyIHBvczAsIHBvczE7XG4gICAgICAgIFxuICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICBwb3MxID0gcG9zO1xuICAgICAgICBpZiAoaW5wdXQuc3Vic3RyKHBvcywgMSkudG9Mb3dlckNhc2UoKSA9PT0gXCJzXCIpIHtcbiAgICAgICAgICByZXN1bHQwID0gaW5wdXQuc3Vic3RyKHBvcywgMSk7XG4gICAgICAgICAgcG9zKys7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgaWYgKHJlcG9ydEZhaWx1cmVzID09PSAwKSB7XG4gICAgICAgICAgICBtYXRjaEZhaWxlZChcIlxcXCJzXFxcIlwiKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICBpZiAoL15bJ2EnfCdkJ10vaS50ZXN0KGlucHV0LmNoYXJBdChwb3MpKSkge1xuICAgICAgICAgICAgcmVzdWx0MSA9IGlucHV0LmNoYXJBdChwb3MpO1xuICAgICAgICAgICAgcG9zKys7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdDEgPSBudWxsO1xuICAgICAgICAgICAgaWYgKHJlcG9ydEZhaWx1cmVzID09PSAwKSB7XG4gICAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiWydhJ3wnZCddaVwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgcmVzdWx0MSA9IHJlc3VsdDEgIT09IG51bGwgPyByZXN1bHQxIDogXCJcIjtcbiAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MCA9IFtyZXN1bHQwLCByZXN1bHQxXTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIG9yZGVyKSB7XG4gICAgICAgICAgICByZXR1cm4geyBcbiAgICAgICAgICAgICAgc29ydDoge1xuICAgICAgICAgICAgICAgIG9yZGVyOiAob3JkZXIudG9Mb3dlckNhc2UoKSB8fCAnYScpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfSkocG9zMCwgcmVzdWx0MFsxXSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICBwb3MgPSBwb3MwO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQwO1xuICAgICAgfVxuICAgICAgXG4gICAgICBmdW5jdGlvbiBwYXJzZV9mbG9vck1vZCgpIHtcbiAgICAgICAgdmFyIHJlc3VsdDA7XG4gICAgICAgIHZhciBwb3MwO1xuICAgICAgICBcbiAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgaWYgKGlucHV0LnN1YnN0cihwb3MsIDMpID09PSBcImZsclwiKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IFwiZmxyXCI7XG4gICAgICAgICAgcG9zICs9IDM7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgaWYgKHJlcG9ydEZhaWx1cmVzID09PSAwKSB7XG4gICAgICAgICAgICBtYXRjaEZhaWxlZChcIlxcXCJmbHJcXFwiXCIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDAgPSAoZnVuY3Rpb24ob2Zmc2V0KSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICByb3VuZDoge1xuICAgICAgICAgICAgICAgIHR5cGU6IFwiZmxvb3JcIlxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH0pKHBvczApO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0MDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZnVuY3Rpb24gcGFyc2VfbXVsdGlwbGVNb2QoKSB7XG4gICAgICAgIHZhciByZXN1bHQwLCByZXN1bHQxO1xuICAgICAgICB2YXIgcG9zMCwgcG9zMTtcbiAgICAgICAgXG4gICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgIHBvczEgPSBwb3M7XG4gICAgICAgIGlmIChpbnB1dC5zdWJzdHIocG9zLCAxKS50b0xvd2VyQ2FzZSgpID09PSBcInhcIikge1xuICAgICAgICAgIHJlc3VsdDAgPSBpbnB1dC5zdWJzdHIocG9zLCAxKTtcbiAgICAgICAgICBwb3MrKztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcInhcXFwiXCIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDEgPSBwYXJzZV9pbnRlZ2VyKCk7XG4gICAgICAgICAgaWYgKHJlc3VsdDEgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSBbcmVzdWx0MCwgcmVzdWx0MV07XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDAgPSAoZnVuY3Rpb24ob2Zmc2V0LCB0aW1lcykge1xuICAgICAgICAgICAgcmV0dXJuIHsgXG4gICAgICAgICAgICAgIG11bHRpcGxlOiB7XG4gICAgICAgICAgICAgICAgdGltZXM6IHRpbWVzXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfSkocG9zMCwgcmVzdWx0MFsxXSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICBwb3MgPSBwb3MwO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQwO1xuICAgICAgfVxuICAgICAgXG4gICAgICBmdW5jdGlvbiBwYXJzZV9zdWNjZXNzTW9kKCkge1xuICAgICAgICB2YXIgcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0MjtcbiAgICAgICAgdmFyIHBvczAsIHBvczEsIHBvczI7XG4gICAgICAgIFxuICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICBwb3MxID0gcG9zO1xuICAgICAgICByZXN1bHQwID0gcGFyc2VfY29tcGFyaXNvblBvaW50KCk7XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcG9zMiA9IHBvcztcbiAgICAgICAgICBpZiAoaW5wdXQuc3Vic3RyKHBvcywgMSkudG9Mb3dlckNhc2UoKSA9PT0gXCJmXCIpIHtcbiAgICAgICAgICAgIHJlc3VsdDEgPSBpbnB1dC5zdWJzdHIocG9zLCAxKTtcbiAgICAgICAgICAgIHBvcysrO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQxID0gbnVsbDtcbiAgICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICBtYXRjaEZhaWxlZChcIlxcXCJmXFxcIlwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHJlc3VsdDEgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlc3VsdDIgPSBwYXJzZV9jb21wYXJpc29uUG9pbnQoKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQyICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJlc3VsdDEgPSBbcmVzdWx0MSwgcmVzdWx0Ml07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXN1bHQxID0gbnVsbDtcbiAgICAgICAgICAgICAgcG9zID0gcG9zMjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MSA9IG51bGw7XG4gICAgICAgICAgICBwb3MgPSBwb3MyO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXN1bHQxID0gcmVzdWx0MSAhPT0gbnVsbCA/IHJlc3VsdDEgOiBcIlwiO1xuICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQwID0gW3Jlc3VsdDAsIHJlc3VsdDFdO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgY3AsIGZhaWx1cmUpIHtcbiAgICAgICAgICAgIHZhciByZXN1bHQgPSB7IFxuICAgICAgICAgICAgICBzdWNjZXNzOiBjcFxuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoZmFpbHVyZSAhPT0gXCJcIikge1xuICAgICAgICAgICAgICByZXN1bHRbXCJmYWlsdXJlXCJdID0gZmFpbHVyZVsxXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMF0sIHJlc3VsdDBbMV0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0MDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZnVuY3Rpb24gcGFyc2VfbWF0Y2hNb2QoKSB7XG4gICAgICAgIHZhciByZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyO1xuICAgICAgICB2YXIgcG9zMCwgcG9zMTtcbiAgICAgICAgXG4gICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgIHBvczEgPSBwb3M7XG4gICAgICAgIGlmIChpbnB1dC5jaGFyQ29kZUF0KHBvcykgPT09IDEwOSkge1xuICAgICAgICAgIHJlc3VsdDAgPSBcIm1cIjtcbiAgICAgICAgICBwb3MrKztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcIm1cXFwiXCIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDEgPSBwYXJzZV9tYXRjaFRocmVzaG9sZCgpO1xuICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQyID0gcGFyc2VfY29tcGFyaXNvblBvaW50KCk7XG4gICAgICAgICAgICByZXN1bHQyID0gcmVzdWx0MiAhPT0gbnVsbCA/IHJlc3VsdDIgOiBcIlwiO1xuICAgICAgICAgICAgaWYgKHJlc3VsdDIgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IFtyZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgbXQsIGNwKSB7XG4gICAgICAgICAgICB2YXIgcmVzdWx0ID0ge1xuICAgICAgICAgICAgICBtYXRjaDogKGNwICE9PSBcIlwiID8gY3AgOiB7fSlcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZXN1bHQubWF0Y2hbXCJ0aHJlc2hvbGRcIl0gPSBtdDtcbiAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMV0sIHJlc3VsdDBbMl0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0MDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZnVuY3Rpb24gcGFyc2VfbWF0Y2hUb3RhbE1vZCgpIHtcbiAgICAgICAgdmFyIHJlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDI7XG4gICAgICAgIHZhciBwb3MwLCBwb3MxO1xuICAgICAgICBcbiAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgcG9zMSA9IHBvcztcbiAgICAgICAgaWYgKGlucHV0LnN1YnN0cihwb3MsIDIpID09PSBcIm10XCIpIHtcbiAgICAgICAgICByZXN1bHQwID0gXCJtdFwiO1xuICAgICAgICAgIHBvcyArPSAyO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJcXFwibXRcXFwiXCIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDEgPSBwYXJzZV9tYXRjaFRocmVzaG9sZCgpO1xuICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQyID0gcGFyc2VfY29tcGFyaXNvblBvaW50KCk7XG4gICAgICAgICAgICByZXN1bHQyID0gcmVzdWx0MiAhPT0gbnVsbCA/IHJlc3VsdDIgOiBcIlwiO1xuICAgICAgICAgICAgaWYgKHJlc3VsdDIgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IFtyZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgbXQsIGNwKSB7XG4gICAgICAgICAgICB2YXIgcmVzdWx0ID0ge1xuICAgICAgICAgICAgICBtYXRjaDogKGNwICE9PSBcIlwiID8gY3AgOiB7fSlcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZXN1bHQubWF0Y2hbXCJ0aHJlc2hvbGRcIl0gPSBtdDtcbiAgICAgICAgICAgIHJlc3VsdC5tYXRjaFtcInRvdGFsXCJdID0gdHJ1ZTtcbiAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMV0sIHJlc3VsdDBbMl0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0MDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZnVuY3Rpb24gcGFyc2VfbWF0Y2hUaHJlc2hvbGQoKSB7XG4gICAgICAgIHZhciByZXN1bHQwLCByZXN1bHQxO1xuICAgICAgICB2YXIgcG9zMDtcbiAgICAgICAgXG4gICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgIHJlc3VsdDAgPSBbXTtcbiAgICAgICAgaWYgKC9eWzAtOV0vLnRlc3QoaW5wdXQuY2hhckF0KHBvcykpKSB7XG4gICAgICAgICAgcmVzdWx0MSA9IGlucHV0LmNoYXJBdChwb3MpO1xuICAgICAgICAgIHBvcysrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDEgPSBudWxsO1xuICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJbMC05XVwiKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgd2hpbGUgKHJlc3VsdDEgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwLnB1c2gocmVzdWx0MSk7XG4gICAgICAgICAgaWYgKC9eWzAtOV0vLnRlc3QoaW5wdXQuY2hhckF0KHBvcykpKSB7XG4gICAgICAgICAgICByZXN1bHQxID0gaW5wdXQuY2hhckF0KHBvcyk7XG4gICAgICAgICAgICBwb3MrKztcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MSA9IG51bGw7XG4gICAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJbMC05XVwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgbnVtKSB7IFxuICAgICAgICAgICAgdmFyIHJlc3VsdCA9IG51bSAmJiBudW0gIT0gW10gJiYgcGFyc2VJbnQobnVtLmpvaW4oXCJcIiksIDEwKSA+IDIgPyBwYXJzZUludChudW0uam9pbihcIlwiKSwgMTApIDogMjtcbiAgICAgICAgICAgIHJldHVybiByZXN1bHRcbiAgICAgICAgICB9KShwb3MwLCByZXN1bHQwKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDA7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZ1bmN0aW9uIHBhcnNlX2NvbXBhcmlzb25Qb2ludCgpIHtcbiAgICAgICAgdmFyIHJlc3VsdDAsIHJlc3VsdDE7XG4gICAgICAgIHZhciBwb3MwLCBwb3MxO1xuICAgICAgICBcbiAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgcG9zMSA9IHBvcztcbiAgICAgICAgcmVzdWx0MCA9IHBhcnNlX2NvbXBhcmlzb24oKTtcbiAgICAgICAgcmVzdWx0MCA9IHJlc3VsdDAgIT09IG51bGwgPyByZXN1bHQwIDogXCJcIjtcbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQxID0gcGFyc2VfaW50ZWdlcigpO1xuICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQwID0gW3Jlc3VsdDAsIHJlc3VsdDFdO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgY29tcCwgcG9pbnQpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIGNvbXA6KGNvbXAgPT0gXCJcIiA/IFwiPVwiIDogY29tcCkgKyBcIj1cIiwgXG4gICAgICAgICAgICAgIHBvaW50OnBvaW50XG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMF0sIHJlc3VsdDBbMV0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0MDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZnVuY3Rpb24gcGFyc2VfY29tcGFyaXNvbigpIHtcbiAgICAgICAgdmFyIHJlc3VsdDA7XG4gICAgICAgIFxuICAgICAgICBpZiAoL15bPnw8fD1dLy50ZXN0KGlucHV0LmNoYXJBdChwb3MpKSkge1xuICAgICAgICAgIHJlc3VsdDAgPSBpbnB1dC5jaGFyQXQocG9zKTtcbiAgICAgICAgICBwb3MrKztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiWz58PHw9XVwiKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDA7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZ1bmN0aW9uIHBhcnNlX21hdGhFeHByZXNzaW9uKCkge1xuICAgICAgICB2YXIgcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0MiwgcmVzdWx0MywgcmVzdWx0NCwgcmVzdWx0NSwgcmVzdWx0NjtcbiAgICAgICAgdmFyIHBvczAsIHBvczE7XG4gICAgICAgIFxuICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICBwb3MxID0gcG9zO1xuICAgICAgICByZXN1bHQwID0gcGFyc2VfXygpO1xuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDEgPSBwYXJzZV9tYXRoRXhwcmVzc2lvblByaW1hcnkoKTtcbiAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MiA9IHBhcnNlX18oKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQyICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJlc3VsdDMgPSBwYXJzZV9vcGVyYXRvcigpO1xuICAgICAgICAgICAgICBpZiAocmVzdWx0MyAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHJlc3VsdDQgPSBwYXJzZV9fKCk7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdDQgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgIHJlc3VsdDUgPSBwYXJzZV9tYXRoRXhwcmVzc2lvbigpO1xuICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdDUgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0NiA9IHBhcnNlX18oKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdDYgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gW3Jlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDIsIHJlc3VsdDMsIHJlc3VsdDQsIHJlc3VsdDUsIHJlc3VsdDZdO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgbGVmdCwgb3BlciwgcmlnaHQpIHtcbiAgICAgICAgICAgIHJldHVybiBsZWZ0ICsgb3BlciArIHJpZ2h0O1xuICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMV0sIHJlc3VsdDBbM10sIHJlc3VsdDBbNV0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgICAgcG9zMSA9IHBvcztcbiAgICAgICAgICByZXN1bHQwID0gcGFyc2VfXygpO1xuICAgICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQxID0gcGFyc2VfbWF0aEV4cHJlc3Npb25QcmltYXJ5KCk7XG4gICAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICByZXN1bHQyID0gcGFyc2VfXygpO1xuICAgICAgICAgICAgICBpZiAocmVzdWx0MiAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBbcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0Ml07XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSAoZnVuY3Rpb24ob2Zmc2V0LCBleHByKSB7XG4gICAgICAgICAgICAgIHJldHVybiBleHByO1xuICAgICAgICAgICAgfSkocG9zMCwgcmVzdWx0MFsxXSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgICBwb3MgPSBwb3MwO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0MDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZnVuY3Rpb24gcGFyc2VfbWF0aEV4cHJlc3Npb25QcmltYXJ5KCkge1xuICAgICAgICB2YXIgcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0MiwgcmVzdWx0MywgcmVzdWx0NDtcbiAgICAgICAgdmFyIHBvczAsIHBvczE7XG4gICAgICAgIFxuICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICBwb3MxID0gcG9zO1xuICAgICAgICByZXN1bHQwID0gcGFyc2VfXygpO1xuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDEgPSBwYXJzZV9udW1iZXIoKTtcbiAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgcmVzdWx0MiA9IHBhcnNlX18oKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQyICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBbcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0Ml07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIG51bSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bTtcbiAgICAgICAgICB9KShwb3MwLCByZXN1bHQwWzFdKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICAgIHBvczEgPSBwb3M7XG4gICAgICAgICAgaWYgKGlucHV0LmNoYXJDb2RlQXQocG9zKSA9PT0gNDApIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSBcIihcIjtcbiAgICAgICAgICAgIHBvcysrO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICBtYXRjaEZhaWxlZChcIlxcXCIoXFxcIlwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlc3VsdDEgPSBwYXJzZV9fKCk7XG4gICAgICAgICAgICBpZiAocmVzdWx0MSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICByZXN1bHQyID0gcGFyc2VfbWF0aEV4cHJlc3Npb24oKTtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdDIgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQzID0gcGFyc2VfXygpO1xuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQzICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICBpZiAoaW5wdXQuY2hhckNvZGVBdChwb3MpID09PSA0MSkge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQ0ID0gXCIpXCI7XG4gICAgICAgICAgICAgICAgICAgIHBvcysrO1xuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0NCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcIilcXFwiXCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICBpZiAocmVzdWx0NCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQwID0gW3Jlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDIsIHJlc3VsdDMsIHJlc3VsdDRdO1xuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSAoZnVuY3Rpb24ob2Zmc2V0LCBleHByKSB7XG4gICAgICAgICAgICAgIHJldHVybiBcIihcIiArIGV4cHIgKyBcIilcIjtcbiAgICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMl0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDA7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZ1bmN0aW9uIHBhcnNlX2lubGluZUxhYmVsV2l0aFNwYWNlKCkge1xuICAgICAgICB2YXIgcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0MjtcbiAgICAgICAgdmFyIHBvczAsIHBvczE7XG4gICAgICAgIFxuICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICBwb3MxID0gcG9zO1xuICAgICAgICByZXN1bHQwID0gcGFyc2VfXygpO1xuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDEgPSBwYXJzZV9pbmxpbmVMYWJlbCgpO1xuICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQyID0gcGFyc2VfXygpO1xuICAgICAgICAgICAgaWYgKHJlc3VsdDIgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IFtyZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgbGJsKSB7IFxuICAgICAgICAgICAgcmV0dXJuIGxibDtcbiAgICAgICAgICB9KShwb3MwLCByZXN1bHQwWzFdKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDA7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZ1bmN0aW9uIHBhcnNlX2lubGluZUxhYmVsKCkge1xuICAgICAgICB2YXIgcmVzdWx0MCwgcmVzdWx0MSwgcmVzdWx0MjtcbiAgICAgICAgdmFyIHBvczAsIHBvczE7XG4gICAgICAgIFxuICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICBwb3MxID0gcG9zO1xuICAgICAgICBpZiAoaW5wdXQuY2hhckNvZGVBdChwb3MpID09PSA5MSkge1xuICAgICAgICAgIHJlc3VsdDAgPSBcIltcIjtcbiAgICAgICAgICBwb3MrKztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcIltcXFwiXCIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDEgPSBbXTtcbiAgICAgICAgICBpZiAoL15bXlxcXV0vLnRlc3QoaW5wdXQuY2hhckF0KHBvcykpKSB7XG4gICAgICAgICAgICByZXN1bHQyID0gaW5wdXQuY2hhckF0KHBvcyk7XG4gICAgICAgICAgICBwb3MrKztcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0MiA9IG51bGw7XG4gICAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJbXlxcXFxdXVwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgd2hpbGUgKHJlc3VsdDIgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlc3VsdDEucHVzaChyZXN1bHQyKTtcbiAgICAgICAgICAgIGlmICgvXlteXFxdXS8udGVzdChpbnB1dC5jaGFyQXQocG9zKSkpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MiA9IGlucHV0LmNoYXJBdChwb3MpO1xuICAgICAgICAgICAgICBwb3MrKztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDIgPSBudWxsO1xuICAgICAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgICAgICBtYXRjaEZhaWxlZChcIlteXFxcXF1dXCIpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICBpZiAoaW5wdXQuY2hhckNvZGVBdChwb3MpID09PSA5Mykge1xuICAgICAgICAgICAgICByZXN1bHQyID0gXCJdXCI7XG4gICAgICAgICAgICAgIHBvcysrO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzdWx0MiA9IG51bGw7XG4gICAgICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiXFxcIl1cXFwiXCIpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocmVzdWx0MiAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICByZXN1bHQwID0gW3Jlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDJdO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDAgPSAoZnVuY3Rpb24ob2Zmc2V0LCB0ZXh0KSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IExhYmVsKHRleHQuam9pbihcIlwiKSk7XG4gICAgICAgICAgfSkocG9zMCwgcmVzdWx0MFsxXSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICBwb3MgPSBwb3MwO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQwO1xuICAgICAgfVxuICAgICAgXG4gICAgICBmdW5jdGlvbiBwYXJzZV9vcGVyYXRvcigpIHtcbiAgICAgICAgdmFyIHJlc3VsdDA7XG4gICAgICAgIFxuICAgICAgICBpZiAoL15bK3xcXC18KnxcXC98JV0vLnRlc3QoaW5wdXQuY2hhckF0KHBvcykpKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IGlucHV0LmNoYXJBdChwb3MpO1xuICAgICAgICAgIHBvcysrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJbK3xcXFxcLXwqfFxcXFwvfCVdXCIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0MDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZnVuY3Rpb24gcGFyc2VfbnVtYmVyKCkge1xuICAgICAgICB2YXIgcmVzdWx0MDtcbiAgICAgICAgXG4gICAgICAgIHJlc3VsdDAgPSBwYXJzZV9leHBvbmVudCgpO1xuICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDAgPSBwYXJzZV9mbG9hdCgpO1xuICAgICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQwID0gcGFyc2Vfc2lnbmVkSW50ZWdlcigpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0MDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZnVuY3Rpb24gcGFyc2VfaW50ZWdlcigpIHtcbiAgICAgICAgdmFyIHJlc3VsdDAsIHJlc3VsdDE7XG4gICAgICAgIHZhciBwb3MwO1xuICAgICAgICBcbiAgICAgICAgcG9zMCA9IHBvcztcbiAgICAgICAgaWYgKC9eWzAtOV0vLnRlc3QoaW5wdXQuY2hhckF0KHBvcykpKSB7XG4gICAgICAgICAgcmVzdWx0MSA9IGlucHV0LmNoYXJBdChwb3MpO1xuICAgICAgICAgIHBvcysrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDEgPSBudWxsO1xuICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJbMC05XVwiKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDEgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gW107XG4gICAgICAgICAgd2hpbGUgKHJlc3VsdDEgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlc3VsdDAucHVzaChyZXN1bHQxKTtcbiAgICAgICAgICAgIGlmICgvXlswLTldLy50ZXN0KGlucHV0LmNoYXJBdChwb3MpKSkge1xuICAgICAgICAgICAgICByZXN1bHQxID0gaW5wdXQuY2hhckF0KHBvcyk7XG4gICAgICAgICAgICAgIHBvcysrO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzdWx0MSA9IG51bGw7XG4gICAgICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiWzAtOV1cIik7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgZGlnaXRzKSB7IFxuICAgICAgICAgICAgcmV0dXJuIHBhcnNlSW50KGRpZ2l0cy5qb2luKFwiXCIpLCAxMCk7XG4gICAgICAgICAgfSkocG9zMCwgcmVzdWx0MCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgPT09IG51bGwpIHtcbiAgICAgICAgICBwb3MgPSBwb3MwO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQwO1xuICAgICAgfVxuICAgICAgXG4gICAgICBmdW5jdGlvbiBwYXJzZV9zaWduZWRJbnRlZ2VyKCkge1xuICAgICAgICB2YXIgcmVzdWx0MCwgcmVzdWx0MTtcbiAgICAgICAgdmFyIHBvczAsIHBvczE7XG4gICAgICAgIFxuICAgICAgICBwb3MwID0gcG9zO1xuICAgICAgICBwb3MxID0gcG9zO1xuICAgICAgICBpZiAoL15bK3xcXC1dLy50ZXN0KGlucHV0LmNoYXJBdChwb3MpKSkge1xuICAgICAgICAgIHJlc3VsdDAgPSBpbnB1dC5jaGFyQXQocG9zKTtcbiAgICAgICAgICBwb3MrKztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiWyt8XFxcXC1dXCIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXN1bHQwID0gcmVzdWx0MCAhPT0gbnVsbCA/IHJlc3VsdDAgOiBcIlwiO1xuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDEgPSBwYXJzZV9pbnRlZ2VyKCk7XG4gICAgICAgICAgaWYgKHJlc3VsdDEgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSBbcmVzdWx0MCwgcmVzdWx0MV07XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzdWx0MCA9IG51bGw7XG4gICAgICAgICAgcG9zID0gcG9zMTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdDAgPSAoZnVuY3Rpb24ob2Zmc2V0LCBzaWduLCBpbnQpIHtcbiAgICAgICAgICAgcmV0dXJuIHNpZ24gPT0gXCItXCIgPyAtMSAqIGludCA6IGludDtcbiAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMF0sIHJlc3VsdDBbMV0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0MDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZnVuY3Rpb24gcGFyc2VfZmxvYXQoKSB7XG4gICAgICAgIHZhciByZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyLCByZXN1bHQzO1xuICAgICAgICB2YXIgcG9zMCwgcG9zMTtcbiAgICAgICAgXG4gICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgIHBvczEgPSBwb3M7XG4gICAgICAgIHJlc3VsdDAgPSBwYXJzZV9zaWduZWRJbnRlZ2VyKCk7XG4gICAgICAgIHJlc3VsdDAgPSByZXN1bHQwICE9PSBudWxsID8gcmVzdWx0MCA6IFwiXCI7XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgaWYgKGlucHV0LmNoYXJDb2RlQXQocG9zKSA9PT0gNDYpIHtcbiAgICAgICAgICAgIHJlc3VsdDEgPSBcIi5cIjtcbiAgICAgICAgICAgIHBvcysrO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQxID0gbnVsbDtcbiAgICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICBtYXRjaEZhaWxlZChcIlxcXCIuXFxcIlwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHJlc3VsdDEgIT09IG51bGwpIHtcbiAgICAgICAgICAgIGlmICgvXlswLTldLy50ZXN0KGlucHV0LmNoYXJBdChwb3MpKSkge1xuICAgICAgICAgICAgICByZXN1bHQzID0gaW5wdXQuY2hhckF0KHBvcyk7XG4gICAgICAgICAgICAgIHBvcysrO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzdWx0MyA9IG51bGw7XG4gICAgICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiWzAtOV1cIik7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChyZXN1bHQzICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJlc3VsdDIgPSBbXTtcbiAgICAgICAgICAgICAgd2hpbGUgKHJlc3VsdDMgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQyLnB1c2gocmVzdWx0Myk7XG4gICAgICAgICAgICAgICAgaWYgKC9eWzAtOV0vLnRlc3QoaW5wdXQuY2hhckF0KHBvcykpKSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHQzID0gaW5wdXQuY2hhckF0KHBvcyk7XG4gICAgICAgICAgICAgICAgICBwb3MrKztcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgcmVzdWx0MyA9IG51bGw7XG4gICAgICAgICAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJbMC05XVwiKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDIgPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHJlc3VsdDIgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MCA9IFtyZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgaW50LCBkZWMpIHtcbiAgICAgICAgICAgIC8vQ2hlY2sgZm9yIC0wIGZvciBzdHVmZiBsaWtlIC0wLjUgc3RhcnRpbmcgYW4gZXhwcmVzc2lvbi5cbiAgICAgICAgICAgIGlmKGludCA9PT0gMCAmJiAoMS9pbnQgPCAwKSkgcmV0dXJuICgtMS4wICogcGFyc2VGbG9hdChpbnQgKyBcIi5cIiArIGRlYy5qb2luKFwiXCIpKSk7XG4gICAgICAgICAgICBlbHNlIHJldHVybiBwYXJzZUZsb2F0KGludCArIFwiLlwiICsgZGVjLmpvaW4oXCJcIikpO1xuICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMF0sIHJlc3VsdDBbMl0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0MDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZnVuY3Rpb24gcGFyc2VfZXhwb25lbnQoKSB7XG4gICAgICAgIHZhciByZXN1bHQwLCByZXN1bHQxLCByZXN1bHQyLCByZXN1bHQzLCByZXN1bHQ0O1xuICAgICAgICB2YXIgcG9zMCwgcG9zMTtcbiAgICAgICAgXG4gICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgIHBvczEgPSBwb3M7XG4gICAgICAgIHJlc3VsdDAgPSBwYXJzZV9zaWduZWRJbnRlZ2VyKCk7XG4gICAgICAgIHJlc3VsdDAgPSByZXN1bHQwICE9PSBudWxsID8gcmVzdWx0MCA6IFwiXCI7XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgaWYgKGlucHV0LmNoYXJDb2RlQXQocG9zKSA9PT0gNDYpIHtcbiAgICAgICAgICAgIHJlc3VsdDEgPSBcIi5cIjtcbiAgICAgICAgICAgIHBvcysrO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQxID0gbnVsbDtcbiAgICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICBtYXRjaEZhaWxlZChcIlxcXCIuXFxcIlwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHJlc3VsdDEgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHJlc3VsdDIgPSBwYXJzZV9pbnRlZ2VyKCk7XG4gICAgICAgICAgICBpZiAocmVzdWx0MiAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICBpZiAoaW5wdXQuY2hhckNvZGVBdChwb3MpID09PSAxMDEpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQzID0gXCJlXCI7XG4gICAgICAgICAgICAgICAgcG9zKys7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0MyA9IG51bGw7XG4gICAgICAgICAgICAgICAgaWYgKHJlcG9ydEZhaWx1cmVzID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICBtYXRjaEZhaWxlZChcIlxcXCJlXFxcIlwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKHJlc3VsdDMgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQ0ID0gcGFyc2Vfc2lnbmVkSW50ZWdlcigpO1xuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQ0ICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHQwID0gW3Jlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDIsIHJlc3VsdDMsIHJlc3VsdDRdO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgaW50LCBkZWMsIGV4cCkgeyBcbiAgICAgICAgICAgIHJldHVybiBwYXJzZUZsb2F0KGludCArIFwiLlwiICsgZGVjICsgXCJlXCIgKyBleHApO1xuICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMF0sIHJlc3VsdDBbMl0sIHJlc3VsdDBbNF0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgICAgcG9zMSA9IHBvcztcbiAgICAgICAgICByZXN1bHQwID0gcGFyc2Vfc2lnbmVkSW50ZWdlcigpO1xuICAgICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgICBpZiAoaW5wdXQuY2hhckNvZGVBdChwb3MpID09PSAxMDEpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MSA9IFwiZVwiO1xuICAgICAgICAgICAgICBwb3MrKztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDEgPSBudWxsO1xuICAgICAgICAgICAgICBpZiAocmVwb3J0RmFpbHVyZXMgPT09IDApIHtcbiAgICAgICAgICAgICAgICBtYXRjaEZhaWxlZChcIlxcXCJlXFxcIlwiKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHJlc3VsdDEgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcmVzdWx0MiA9IHBhcnNlX3NpZ25lZEludGVnZXIoKTtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdDIgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQwID0gW3Jlc3VsdDAsIHJlc3VsdDEsIHJlc3VsdDJdO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICAgICAgICBwb3MgPSBwb3MxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQwID0gbnVsbDtcbiAgICAgICAgICAgIHBvcyA9IHBvczE7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgaW50LCBleHApIHsgXG4gICAgICAgICAgICAgIHJldHVybiBwYXJzZUZsb2F0KGludCArIFwiZVwiICsgZXhwKTtcbiAgICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDBbMF0sIHJlc3VsdDBbMl0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDA7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZ1bmN0aW9uIHBhcnNlX18oKSB7XG4gICAgICAgIHZhciByZXN1bHQwLCByZXN1bHQxO1xuICAgICAgICB2YXIgcG9zMDtcbiAgICAgICAgXG4gICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgIHJlc3VsdDAgPSBbXTtcbiAgICAgICAgaWYgKC9eWyB8XFx0XS8udGVzdChpbnB1dC5jaGFyQXQocG9zKSkpIHtcbiAgICAgICAgICByZXN1bHQxID0gaW5wdXQuY2hhckF0KHBvcyk7XG4gICAgICAgICAgcG9zKys7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzdWx0MSA9IG51bGw7XG4gICAgICAgICAgaWYgKHJlcG9ydEZhaWx1cmVzID09PSAwKSB7XG4gICAgICAgICAgICBtYXRjaEZhaWxlZChcIlsgfFxcXFx0XVwiKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgd2hpbGUgKHJlc3VsdDEgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwLnB1c2gocmVzdWx0MSk7XG4gICAgICAgICAgaWYgKC9eWyB8XFx0XS8udGVzdChpbnB1dC5jaGFyQXQocG9zKSkpIHtcbiAgICAgICAgICAgIHJlc3VsdDEgPSBpbnB1dC5jaGFyQXQocG9zKTtcbiAgICAgICAgICAgIHBvcysrO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXN1bHQxID0gbnVsbDtcbiAgICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICBtYXRjaEZhaWxlZChcIlsgfFxcXFx0XVwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdDAgIT09IG51bGwpIHtcbiAgICAgICAgICByZXN1bHQwID0gKGZ1bmN0aW9uKG9mZnNldCwgc3BhY2UpIHtcbiAgICAgICAgICAgIHJldHVybiBzcGFjZS5qb2luKFwiXCIpO1xuICAgICAgICAgIH0pKHBvczAsIHJlc3VsdDApO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwID09PSBudWxsKSB7XG4gICAgICAgICAgcG9zID0gcG9zMDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0MDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZnVuY3Rpb24gcGFyc2VfX18oKSB7XG4gICAgICAgIHZhciByZXN1bHQwLCByZXN1bHQxO1xuICAgICAgICB2YXIgcG9zMDtcbiAgICAgICAgXG4gICAgICAgIHBvczAgPSBwb3M7XG4gICAgICAgIGlmICgvXlsgfFxcdF0vLnRlc3QoaW5wdXQuY2hhckF0KHBvcykpKSB7XG4gICAgICAgICAgcmVzdWx0MSA9IGlucHV0LmNoYXJBdChwb3MpO1xuICAgICAgICAgIHBvcysrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDEgPSBudWxsO1xuICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgbWF0Y2hGYWlsZWQoXCJbIHxcXFxcdF1cIik7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IFtdO1xuICAgICAgICAgIHdoaWxlIChyZXN1bHQxICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHQwLnB1c2gocmVzdWx0MSk7XG4gICAgICAgICAgICBpZiAoL15bIHxcXHRdLy50ZXN0KGlucHV0LmNoYXJBdChwb3MpKSkge1xuICAgICAgICAgICAgICByZXN1bHQxID0gaW5wdXQuY2hhckF0KHBvcyk7XG4gICAgICAgICAgICAgIHBvcysrO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzdWx0MSA9IG51bGw7XG4gICAgICAgICAgICAgIGlmIChyZXBvcnRGYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICAgIG1hdGNoRmFpbGVkKFwiWyB8XFxcXHRdXCIpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdDAgPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQwICE9PSBudWxsKSB7XG4gICAgICAgICAgcmVzdWx0MCA9IChmdW5jdGlvbihvZmZzZXQsIHNwYWNlKSB7XG4gICAgICAgICAgICByZXR1cm4gc3BhY2Uuam9pbihcIlwiKTtcbiAgICAgICAgICB9KShwb3MwLCByZXN1bHQwKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0MCA9PT0gbnVsbCkge1xuICAgICAgICAgIHBvcyA9IHBvczA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDA7XG4gICAgICB9XG4gICAgICBcbiAgICAgIFxuICAgICAgZnVuY3Rpb24gY2xlYW51cEV4cGVjdGVkKGV4cGVjdGVkKSB7XG4gICAgICAgIGV4cGVjdGVkLnNvcnQoKTtcbiAgICAgICAgXG4gICAgICAgIHZhciBsYXN0RXhwZWN0ZWQgPSBudWxsO1xuICAgICAgICB2YXIgY2xlYW5FeHBlY3RlZCA9IFtdO1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV4cGVjdGVkLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgaWYgKGV4cGVjdGVkW2ldICE9PSBsYXN0RXhwZWN0ZWQpIHtcbiAgICAgICAgICAgIGNsZWFuRXhwZWN0ZWQucHVzaChleHBlY3RlZFtpXSk7XG4gICAgICAgICAgICBsYXN0RXhwZWN0ZWQgPSBleHBlY3RlZFtpXTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNsZWFuRXhwZWN0ZWQ7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGZ1bmN0aW9uIGNvbXB1dGVFcnJvclBvc2l0aW9uKCkge1xuICAgICAgICAvKlxuICAgICAgICAgKiBUaGUgZmlyc3QgaWRlYSB3YXMgdG8gdXNlIHxTdHJpbmcuc3BsaXR8IHRvIGJyZWFrIHRoZSBpbnB1dCB1cCB0byB0aGVcbiAgICAgICAgICogZXJyb3IgcG9zaXRpb24gYWxvbmcgbmV3bGluZXMgYW5kIGRlcml2ZSB0aGUgbGluZSBhbmQgY29sdW1uIGZyb21cbiAgICAgICAgICogdGhlcmUuIEhvd2V2ZXIgSUUncyB8c3BsaXR8IGltcGxlbWVudGF0aW9uIGlzIHNvIGJyb2tlbiB0aGF0IGl0IHdhc1xuICAgICAgICAgKiBlbm91Z2ggdG8gcHJldmVudCBpdC5cbiAgICAgICAgICovXG4gICAgICAgIFxuICAgICAgICB2YXIgbGluZSA9IDE7XG4gICAgICAgIHZhciBjb2x1bW4gPSAxO1xuICAgICAgICB2YXIgc2VlbkNSID0gZmFsc2U7XG4gICAgICAgIFxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IE1hdGgubWF4KHBvcywgcmlnaHRtb3N0RmFpbHVyZXNQb3MpOyBpKyspIHtcbiAgICAgICAgICB2YXIgY2ggPSBpbnB1dC5jaGFyQXQoaSk7XG4gICAgICAgICAgaWYgKGNoID09PSBcIlxcblwiKSB7XG4gICAgICAgICAgICBpZiAoIXNlZW5DUikgeyBsaW5lKys7IH1cbiAgICAgICAgICAgIGNvbHVtbiA9IDE7XG4gICAgICAgICAgICBzZWVuQ1IgPSBmYWxzZTtcbiAgICAgICAgICB9IGVsc2UgaWYgKGNoID09PSBcIlxcclwiIHx8IGNoID09PSBcIlxcdTIwMjhcIiB8fCBjaCA9PT0gXCJcXHUyMDI5XCIpIHtcbiAgICAgICAgICAgIGxpbmUrKztcbiAgICAgICAgICAgIGNvbHVtbiA9IDE7XG4gICAgICAgICAgICBzZWVuQ1IgPSB0cnVlO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb2x1bW4rKztcbiAgICAgICAgICAgIHNlZW5DUiA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHsgbGluZTogbGluZSwgY29sdW1uOiBjb2x1bW4gfTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgXG4gICAgICAgIC8vU2V0dXAgVFlQRV8qIHZhcmlhYmxlcyBpbiB0aGUgZDIwIG5hbWVzcGFjZSBzbyB0aGF0IGF0IHJ1bnRpbWUgdGhlIHNhbWUgY29uc3RhbnRzXG4gICAgICAgIC8vIGFyZSB1c2VkIGJ5IGFsbCBzY3JpcHRzXG4gICAgICAgIHZhciBkMjAgPSAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LmQyMCAhPT0gdW5kZWZpbmVkKSA/IHdpbmRvdy5kMjAgOiB7fTtcbiAgICAgICAgaWYgKGQyMC5kaWNlID09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIGQyMC5kaWNlID0gZDIwLmRpY2UgfHwge307XG4gICAgICAgICAgZDIwLmRpY2UuVFlQRV9NQVRIX0VYUFIgPSBcIk1cIjtcbiAgICAgICAgICBkMjAuZGljZS5UWVBFX1JPTExfRVhQUiA9IFwiUlwiO1xuICAgICAgICAgIGQyMC5kaWNlLlRZUEVfR1JPVVBfRVhQUiA9IFwiR1wiO1xuICAgICAgICAgIGQyMC5kaWNlLlRZUEVfTEFCRUwgPSBcIkxcIjtcbiAgICAgICAgICBkMjAuZGljZS5UWVBFX0NPTU1FTlQgPSBcIkNcIjtcbiAgICAgICAgICBkMjAuZGljZS5UWVBFX1ZBTElEQVRFRF9ST0xMUyA9IFwiVlwiO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBmdW5jdGlvbiBsb2coZCkge1xuICAgICAgICAgICBjb25zb2xlLmxvZyhkKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLyoqXG4gICAgICAgICAqIENyZWF0ZXMgYSBuZXcgbWF0aCBleHByZXNzaW9uXG4gICAgICAgICAqIFxuICAgICAgICAgKiBAcGFyYW0gZXhwciBCYXNlIGV4cHJlc3Npb24sIGRlZmF1bHRzIHRvIFwiXCJcbiAgICAgICAgICovXG4gICAgICAgIGZ1bmN0aW9uIE1hdGhFeHByZXNzaW9uKGV4cHIpIHtcbiAgICAgICAgICAgdGhpcy50eXBlID0gZDIwLmRpY2UuVFlQRV9NQVRIX0VYUFI7XG4gICAgICAgICAgIHRoaXMuZXhwciA9IChleHByICE9IHVuZGVmaW5lZCA/IGV4cHIgOiBcIlwiKTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBDcmVhdGVzIGEgbmV3IHJvbGwgZXhwcmVzc2lvblxuICAgICAgICAgKiBcbiAgICAgICAgICogQHBhcmFtIGRpY2UgTnVtYmVyIG9mIGRpY2UgdG8gcm9sbFxuICAgICAgICAgKiBAcGFyYW0gc2lkZXMgTnVtYmVyIG9mIHNpZGVzIG9uIHRoZSBkaWNlXG4gICAgICAgICAqL1xuICAgICAgICBmdW5jdGlvbiBSb2xsRXhwcmVzc2lvbihkaWNlLCBzaWRlcykge1xuICAgICAgICAgIHRoaXMudHlwZSA9IGQyMC5kaWNlLlRZUEVfUk9MTF9FWFBSO1xuICAgICAgICAgIHRoaXMuZGljZSA9IGRpY2U7XG4gICAgICAgICAgdGhpcy5zaWRlcyA9IHNpZGVzO1xuICAgICAgICAgIHRoaXMubW9kcyA9IHt9O1xuICAgICAgICB9O1xuICAgICAgXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBDcmVhdGVzIGEgbmV3IGZhdGUgcm9sbCBleHByZXNzaW9uXG4gICAgICAgICAqL1xuICAgICAgICBmdW5jdGlvbiBGYXRlUm9sbEV4cHJlc3Npb24oZGljZSwgdGFibGUpIHtcbiAgICAgICAgICB0aGlzLnR5cGUgPSBkMjAuZGljZS5UWVBFX1JPTExfRVhQUjtcbiAgICAgICAgICB0aGlzLmRpY2UgPSBkaWNlO1xuICAgICAgICAgIHRoaXMuZmF0ZSA9IHRydWU7XG4gICAgICAgICAgdGhpcy5tb2RzID0ge307XG4gICAgICAgIH07XG4gICAgICBcbiAgICAgICAgLyoqXG4gICAgICAgICAqIENyZWF0ZXMgYSBuZXcgdGFibGUgcm9sbCBleHByZXNzaW9uXG4gICAgICAgICAqL1xuICAgICAgICBmdW5jdGlvbiBUYWJsZVJvbGxFeHByZXNzaW9uKGRpY2UsIHRhYmxlKSB7XG4gICAgICAgICAgdGhpcy50eXBlID0gZDIwLmRpY2UuVFlQRV9ST0xMX0VYUFI7XG4gICAgICAgICAgdGhpcy5kaWNlID0gZGljZTtcbiAgICAgICAgICB0aGlzLnRhYmxlID0gdGFibGU7XG4gICAgICAgICAgdGhpcy5tb2RzID0ge307XG4gICAgICAgIH07XG4gICAgICBcbiAgICAgICAgLyoqXG4gICAgICAgICAqIENyZWF0ZXMgYSBuZXcgZ3JvdXAgZXhwcmVzc2lvblxuICAgICAgICAgKiBcbiAgICAgICAgICogQHBhcmFtIHJvbGxzIFRoZSBhcnJheSBvZiByb2xscyB0aGF0IGFyZSBtZW1iZXJzIG9mIHRoZSBncm91cFxuICAgICAgICAgKi9cbiAgICAgICAgZnVuY3Rpb24gR3JvdXBFeHByZXNzaW9uKHJvbGxzLCBtb2RzKSB7XG4gICAgICAgICAgdGhpcy50eXBlID0gZDIwLmRpY2UuVFlQRV9HUk9VUF9FWFBSO1xuICAgICAgICAgIHRoaXMucm9sbHMgPSByb2xscztcbiAgICAgICAgICB0aGlzLm1vZHMgPSAobW9kcyB8fCB7fSk7XG4gICAgICAgIH1cbiAgICAgIFxuICAgICAgICAvKipcbiAgICAgICAgICogQ3JlYXRlcyBhIG5ldyBsYWJlbFxuICAgICAgICAgKiBcbiAgICAgICAgICogQHBhcmFtIHRleHQgY29udGVudCBvZiB0aGUgbGFiZWxcbiAgICAgICAgICovXG4gICAgICAgIGZ1bmN0aW9uIExhYmVsKHRleHQpIHtcbiAgICAgICAgICB0aGlzLnR5cGUgPSBkMjAuZGljZS5UWVBFX0xBQkVMO1xuICAgICAgICAgIHRoaXMudGV4dCA9IHRleHQ7XG4gICAgICAgIH1cbiAgICAgIFxuICAgICAgICAvKipcbiAgICAgICAgICogQ3JlYXRlcyBhIG5ldyBjb21tZW50XG4gICAgICAgICAqIFxuICAgICAgICAgKiBAcGFyYW0gdGV4dCBjb250ZW50IG9mIHRoZSBjb21tZW50XG4gICAgICAgICAqL1xuICAgICAgICBmdW5jdGlvbiBDb21tZW50KHRleHQpIHtcbiAgICAgICAgICB0aGlzLnR5cGUgPSBkMjAuZGljZS5UWVBFX0NPTU1FTlQ7XG4gICAgICAgICAgdGhpcy50ZXh0ID0gdGV4dDtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLyoqXG4gICAgICAgICAqIE1lcmdlIHR3byBleHByZXNzaW9ucyBvciBhcnJheXMgb2YgZXhwcmVzc2lvbnMuIEZvciBib3RoIGFyZ3VtZW50cyBzdHJpbmdzLFxuICAgICAgICAgKiBzaW5nbGUgZXhwcmVzc2lvbnMsIGFuZCBhcnJheXMgb2YgZXhwcmVzc2lvbnMgYXJlIGFsbCB2YWxpZC5cbiAgICAgICAgICogXG4gICAgICAgICAqIFN0cmluZyBhcmd1bWVudHMgYXJlIGNvbnZlcnRlZCBpbnRvIE1hdGhFeHByZXNzaW9uc1xuICAgICAgICAgKiBBZGphY2VudCBNYXRoRXhwcmVzc2lvbnMgYXJlIG1lcmdlZCBpbnRvIGEgc2luZ2xlIE1hdGhFeHByZXNzaW9uXG4gICAgICAgICAqIFxuICAgICAgICAgKiBAcmV0dXJucyBhcnJheSBvZiBleHByZXNzaW9uc1xuICAgICAgICAgKi9cbiAgICAgICAgZnVuY3Rpb24gbWVyZ2VFeHByZXNzaW9ucyhsZWZ0LCByaWdodCkge1xuICAgICAgICAgICAvL0lmIGxlZnQgaXMgYSBzdHJpbmcgY29udmVydCB0byBNYXRoRXhwcmVzc2lvblxuICAgICAgICAgICBpZiAodHlwZW9mIGxlZnQgPT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgICBpZiAobGVmdC5sZW5ndGggPT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiByaWdodDtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBsZWZ0ID0gbmV3IE1hdGhFeHByZXNzaW9uKGxlZnQpO1xuICAgICAgICAgICB9XG4gICAgICAgICAgIC8vSWYgcmlnaHQgaXMgYSBzdHJpbmcgY29udmVydCB0byBNYXRoRXhwcmVzc2lvblxuICAgICAgICAgICBpZiAodHlwZW9mIHJpZ2h0ID09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgICAgaWYgKHJpZ2h0Lmxlbmd0aCA9PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGxlZnQ7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgcmlnaHQgPSBuZXcgTWF0aEV4cHJlc3Npb24ocmlnaHQpO1xuICAgICAgICAgICB9XG4gICAgICBcbiAgICAgICAgICAgLy9JZiBib3RoIGxlZnQgYW5kIHJpZ2h0IGFyZSBhcnJheXMgbWVyZ2UgaW50byBhIHNpbmdsZSBhcnJheVxuICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShsZWZ0KSAmJiBBcnJheS5pc0FycmF5KHJpZ2h0KSkge1xuICAgICAgICAgICAgIC8vSWYgZW5kIG9mIGxlZnQgYW5kIHN0YXJ0IG9mIHJpZ2h0IGFyZSBib3RoIG1hdGggZXhwcmVzc2lvbnNcbiAgICAgICAgICAgICBpZiAobGVmdFtsZWZ0Lmxlbmd0aC0xXS50eXBlID09IGQyMC5kaWNlLlRZUEVfTUFUSF9FWFBSICYmIHJpZ2h0WzBdLnR5cGUgPT0gZDIwLmRpY2UuVFlQRV9NQVRIX0VYUFIpIHtcbiAgICAgICAgICAgICAgIC8vUmVtb3ZlIHRoZSBlbmQgb2YgdGhlIGxlZnRcbiAgICAgICAgICAgICAgIHZhciBsZWZ0TWF0aCA9IGxlZnQucG9wKCk7XG4gICAgICAgICAgICAgICAvL01lcmdlIHRoZSBlbmQgb2YgdGhlIGxlZnQgdG8gdGhlIHN0YXJ0IG9mIHRoZSByaWdodFxuICAgICAgICAgICAgICAgcmlnaHRbMF0uZXhwciA9IGxlZnRNYXRoLmV4cHIgKyByaWdodFswXS5leHByO1xuICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICBcbiAgICAgICAgICAgICAvL01lcmdlIHRoZSB0d28gYXJyYXlzXG4gICAgICAgICAgICAgcmV0dXJuIGxlZnQuY29uY2F0KHJpZ2h0KTtcbiAgICAgICAgICAgfVxuICAgICAgICAgICAvL0xlZnQgaXMgYW4gYXJyYXksIHJpZ2h0IGlzIGFuIG9iamVjdFxuICAgICAgICAgICBlbHNlIGlmIChBcnJheS5pc0FycmF5KGxlZnQpKSB7XG4gICAgICAgICAgICAgLy9FbmQgb2YgdGhlIGxlZnQgYW5kIHJpZ2h0IGFyZSBtYXRoIGV4cHJlc3Npb25zLCBhcHBlbmQgcmlnaHQgb250byB0aGUgZW5kIG9mIGxlZnRcbiAgICAgICAgICAgICBpZiAobGVmdFtsZWZ0Lmxlbmd0aC0xXS50eXBlID09IGQyMC5kaWNlLlRZUEVfTUFUSF9FWFBSICYmIHJpZ2h0LnR5cGUgPT0gZDIwLmRpY2UuVFlQRV9NQVRIX0VYUFIpIHtcbiAgICAgICAgICAgICAgIGxlZnRbbGVmdC5sZW5ndGgtMV0uZXhwciArPSByaWdodC5leHByO1xuICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAvL0VuZCBvZiB0aGUgbGVmdCBpcyBub3QgYSBtYXRoIGV4cHJlc3Npb24sIGFwcGVuZCByaWdodCB0byB0aGUgbGVmdCBhcnJheVxuICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgbGVmdC5wdXNoKHJpZ2h0KTtcbiAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgXG4gICAgICAgICAgICAgcmV0dXJuIGxlZnQ7XG4gICAgICAgICAgIH1cbiAgICAgICAgICAgLy9SaWdodCBpcyBhbiBhcnJheSwgbGVmdCBpcyBhbiBvYmplY3RcbiAgICAgICAgICAgZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyaWdodCkpIHtcbiAgICAgICAgICAgICAvL1N0YXJ0IG9mIHRoZSByaWdodCBhbmQgbGVmdCBhcmUgbWF0aCBleHByZXNzaW9ucywgcHJlcGVuZCBsZWZ0IG9udG8gdGhlIHN0YXJ0IG9mIHJpZ2h0XG4gICAgICAgICAgICAgaWYgKHJpZ2h0WzBdLnR5cGUgPT0gZDIwLmRpY2UuVFlQRV9NQVRIX0VYUFIgJiYgbGVmdC50eXBlID09IGQyMC5kaWNlLlRZUEVfTUFUSF9FWFBSKSB7XG4gICAgICAgICAgICAgICByaWdodFswXS5leHByID0gbGVmdC5leHByICsgcmlnaHRbMF0uZXhwcjtcbiAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgLy9TdGFydCBvZiB0aGUgcmlnaHQgaXMgbm90IGEgbWF0aCBleHByZXNzaW9uLCBwcmVwZW5kIGxlZnQgdG8gdGhlIHJpZ2h0IGFycmF5XG4gICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICByaWdodC51bnNoaWZ0KGxlZnQpO1xuICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICBcbiAgICAgICAgICAgICByZXR1cm4gcmlnaHQ7XG4gICAgICAgICAgIH1cbiAgICAgICAgICAgLy9JZiBib3RoIGxlZnQgYW5kIHJpZ2h0IGFyZSBzaW5nbGUgbWF0aCBleHByZXNzaW9ucyBhcHBlbmQgcmlnaHQgdG8gbGVmdFxuICAgICAgICAgICAvL2FuZCByZXR1cm4gbGVmdFxuICAgICAgICAgICBlbHNlIGlmIChsZWZ0LnR5cGUgPT0gZDIwLmRpY2UuVFlQRV9NQVRIX0VYUFIgJiYgcmlnaHQudHlwZSA9PSBkMjAuZGljZS5UWVBFX01BVEhfRVhQUikge1xuICAgICAgICAgICAgIGxlZnQuZXhwciArPSByaWdodC5leHByO1xuICAgICAgICAgICAgIHJldHVybiBsZWZ0O1xuICAgICAgICAgICB9XG4gICAgICAgICAgIFxuICAgICAgICAgICAvL0xlZnQgYW5kIFJpZ2h0IGFyZSBub3QgYXJyYXlzXG4gICAgICAgICAgIHJldHVybiBbbGVmdCwgcmlnaHRdO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvKipcbiAgICAgICAgICogUHJvY2VzcyByb2xsL2dyb3VwIG1vZHMgaW50byBhIHNpbmdsZSBvYmplY3RcbiAgICAgICAgICogQHJldHVybnMgVGhlIGNvbXBsZXRlIG9iamVjdFxuICAgICAgICAgKi9cbiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc01vZHMoaGVhZCwgdGFpbCkge1xuICAgICAgICAgIHZhciByZXN1bHQgPSBoZWFkO1xuICAgICAgICAgIGlmICh0YWlsLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGZvciAodmFyIGF0dHJuYW1lIGluIHRhaWxbMF0pIHtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdFthdHRybmFtZV0gIT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cge21lc3NhZ2U6XCInXCIgKyBhdHRybmFtZSArIFwiJyByb2xsIG1vZGlmaWVyIGNhbiBvbmx5IGJlIHNwZWNpZmllZCBvbmNlXCJ9O1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHJlc3VsdFthdHRybmFtZV0gPSB0YWlsWzBdW2F0dHJuYW1lXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfTtcbiAgICAgIFxuICAgICAgXG4gICAgICB2YXIgcmVzdWx0ID0gcGFyc2VGdW5jdGlvbnNbc3RhcnRSdWxlXSgpO1xuICAgICAgXG4gICAgICAvKlxuICAgICAgICogVGhlIHBhcnNlciBpcyBub3cgaW4gb25lIG9mIHRoZSBmb2xsb3dpbmcgdGhyZWUgc3RhdGVzOlxuICAgICAgICpcbiAgICAgICAqIDEuIFRoZSBwYXJzZXIgc3VjY2Vzc2Z1bGx5IHBhcnNlZCB0aGUgd2hvbGUgaW5wdXQuXG4gICAgICAgKlxuICAgICAgICogICAgLSB8cmVzdWx0ICE9PSBudWxsfFxuICAgICAgICogICAgLSB8cG9zID09PSBpbnB1dC5sZW5ndGh8XG4gICAgICAgKiAgICAtIHxyaWdodG1vc3RGYWlsdXJlc0V4cGVjdGVkfCBtYXkgb3IgbWF5IG5vdCBjb250YWluIHNvbWV0aGluZ1xuICAgICAgICpcbiAgICAgICAqIDIuIFRoZSBwYXJzZXIgc3VjY2Vzc2Z1bGx5IHBhcnNlZCBvbmx5IGEgcGFydCBvZiB0aGUgaW5wdXQuXG4gICAgICAgKlxuICAgICAgICogICAgLSB8cmVzdWx0ICE9PSBudWxsfFxuICAgICAgICogICAgLSB8cG9zIDwgaW5wdXQubGVuZ3RofFxuICAgICAgICogICAgLSB8cmlnaHRtb3N0RmFpbHVyZXNFeHBlY3RlZHwgbWF5IG9yIG1heSBub3QgY29udGFpbiBzb21ldGhpbmdcbiAgICAgICAqXG4gICAgICAgKiAzLiBUaGUgcGFyc2VyIGRpZCBub3Qgc3VjY2Vzc2Z1bGx5IHBhcnNlIGFueSBwYXJ0IG9mIHRoZSBpbnB1dC5cbiAgICAgICAqXG4gICAgICAgKiAgIC0gfHJlc3VsdCA9PT0gbnVsbHxcbiAgICAgICAqICAgLSB8cG9zID09PSAwfFxuICAgICAgICogICAtIHxyaWdodG1vc3RGYWlsdXJlc0V4cGVjdGVkfCBjb250YWlucyBhdCBsZWFzdCBvbmUgZmFpbHVyZVxuICAgICAgICpcbiAgICAgICAqIEFsbCBjb2RlIGZvbGxvd2luZyB0aGlzIGNvbW1lbnQgKGluY2x1ZGluZyBjYWxsZWQgZnVuY3Rpb25zKSBtdXN0XG4gICAgICAgKiBoYW5kbGUgdGhlc2Ugc3RhdGVzLlxuICAgICAgICovXG4gICAgICBpZiAocmVzdWx0ID09PSBudWxsIHx8IHBvcyAhPT0gaW5wdXQubGVuZ3RoKSB7XG4gICAgICAgIHZhciBvZmZzZXQgPSBNYXRoLm1heChwb3MsIHJpZ2h0bW9zdEZhaWx1cmVzUG9zKTtcbiAgICAgICAgdmFyIGZvdW5kID0gb2Zmc2V0IDwgaW5wdXQubGVuZ3RoID8gaW5wdXQuY2hhckF0KG9mZnNldCkgOiBudWxsO1xuICAgICAgICB2YXIgZXJyb3JQb3NpdGlvbiA9IGNvbXB1dGVFcnJvclBvc2l0aW9uKCk7XG4gICAgICAgIFxuICAgICAgICB0aHJvdyBuZXcgdGhpcy5TeW50YXhFcnJvcihcbiAgICAgICAgICBjbGVhbnVwRXhwZWN0ZWQocmlnaHRtb3N0RmFpbHVyZXNFeHBlY3RlZCksXG4gICAgICAgICAgZm91bmQsXG4gICAgICAgICAgb2Zmc2V0LFxuICAgICAgICAgIGVycm9yUG9zaXRpb24ubGluZSxcbiAgICAgICAgICBlcnJvclBvc2l0aW9uLmNvbHVtblxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgXG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0sXG4gICAgXG4gICAgLyogUmV0dXJucyB0aGUgcGFyc2VyIHNvdXJjZSBjb2RlLiAqL1xuICAgIHRvU291cmNlOiBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuX3NvdXJjZTsgfVxuICB9O1xuICBcbiAgLyogVGhyb3duIHdoZW4gYSBwYXJzZXIgZW5jb3VudGVycyBhIHN5bnRheCBlcnJvci4gKi9cbiAgXG4gIHJlc3VsdC5TeW50YXhFcnJvciA9IGZ1bmN0aW9uKGV4cGVjdGVkLCBmb3VuZCwgb2Zmc2V0LCBsaW5lLCBjb2x1bW4pIHtcbiAgICBmdW5jdGlvbiBidWlsZE1lc3NhZ2UoZXhwZWN0ZWQsIGZvdW5kKSB7XG4gICAgICB2YXIgZXhwZWN0ZWRIdW1hbml6ZWQsIGZvdW5kSHVtYW5pemVkO1xuICAgICAgXG4gICAgICBzd2l0Y2ggKGV4cGVjdGVkLmxlbmd0aCkge1xuICAgICAgICBjYXNlIDA6XG4gICAgICAgICAgZXhwZWN0ZWRIdW1hbml6ZWQgPSBcImVuZCBvZiBpbnB1dFwiO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIDE6XG4gICAgICAgICAgZXhwZWN0ZWRIdW1hbml6ZWQgPSBleHBlY3RlZFswXTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBleHBlY3RlZEh1bWFuaXplZCA9IGV4cGVjdGVkLnNsaWNlKDAsIGV4cGVjdGVkLmxlbmd0aCAtIDEpLmpvaW4oXCIsIFwiKVxuICAgICAgICAgICAgKyBcIiBvciBcIlxuICAgICAgICAgICAgKyBleHBlY3RlZFtleHBlY3RlZC5sZW5ndGggLSAxXTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZm91bmRIdW1hbml6ZWQgPSBmb3VuZCA/IHF1b3RlKGZvdW5kKSA6IFwiZW5kIG9mIGlucHV0XCI7XG4gICAgICBcbiAgICAgIHJldHVybiBcIkV4cGVjdGVkIFwiICsgZXhwZWN0ZWRIdW1hbml6ZWQgKyBcIiBidXQgXCIgKyBmb3VuZEh1bWFuaXplZCArIFwiIGZvdW5kLlwiO1xuICAgIH1cbiAgICBcbiAgICB0aGlzLm5hbWUgPSBcIlN5bnRheEVycm9yXCI7XG4gICAgdGhpcy5leHBlY3RlZCA9IGV4cGVjdGVkO1xuICAgIHRoaXMuZm91bmQgPSBmb3VuZDtcbiAgICB0aGlzLm1lc3NhZ2UgPSBidWlsZE1lc3NhZ2UoZXhwZWN0ZWQsIGZvdW5kKTtcbiAgICB0aGlzLm9mZnNldCA9IG9mZnNldDtcbiAgICB0aGlzLmxpbmUgPSBsaW5lO1xuICAgIHRoaXMuY29sdW1uID0gY29sdW1uO1xuICB9O1xuICBcbiAgcmVzdWx0LlN5bnRheEVycm9yLnByb3RvdHlwZSA9IEVycm9yLnByb3RvdHlwZTtcbiAgXG4gIHJldHVybiByZXN1bHQ7XG59KSgpO1xuXG5kMjAuZGljZV9mb3JtYXR0ZXIgPSB7fTtcbmQyMGV4dFtcImRpY2VfZm9ybWF0dGVyXCJdID0gZDIwLmRpY2VfZm9ybWF0dGVyO1xuXG4oZnVuY3Rpb24oKSB7XG5cblx0dmFyIHNob3dDcml0QW5pbWF0aW9uID0gZnVuY3Rpb24oKSB7XG5cblx0XHRyZXR1cm47XG5cblx0XHRpZihkMjAudGV4dGNoYXQuY2hhdHN0YXJ0aW5ndXApIHJldHVybjtcblxuXHRcdCQoXCIjY3JpdGFuaW1hdGlvblwiKS5hZGRDbGFzcyhcImNyaXR0ZWRcIik7XG5cdFx0JChcIiNtYWluY2FudmFzXCIpLmFkZENsYXNzKFwiY3JpdHRlZFwiKTtcblx0XHRzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuXHRcdFx0JChcIiNjcml0YW5pbWF0aW9uXCIpLnJlbW92ZUNsYXNzKFwiY3JpdHRlZFwiKTtcblx0XHRcdCQoXCIjbWFpbmNhbnZhc1wiKS5yZW1vdmVDbGFzcyhcImNyaXR0ZWRcIik7XG5cdFx0fSwgMjAwMCk7XG5cdH1cblx0XG5cdHZhciBmb3JtYXRSb2xscyA9IGZ1bmN0aW9uKHJvbGxzKSB7XG5cblx0XHR2YXIgZm9ybXVsYSA9IFwiXCI7XG5cblx0XHRmb3IodmFyIGk9MDsgaSA8IHJvbGxzLmxlbmd0aDsgaSsrKSB7XG5cblx0XHRcdGlmKHJvbGxzW2ldLnR5cGUgPT09IGQyMC5kaWNlLlRZUEVfR1JPVVBfRVhQUikge1xuXHRcdFx0XHRmb3JtdWxhICs9IFwiezxkaXYgY2xhc3M9J3BhcnNlZ3JvdXAnPlwiXG5cdFx0XHRcdGZvcih2YXIgZ2k9MDsgZ2kgPCByb2xsc1tpXS5yb2xscy5sZW5ndGg7IGdpKyspIHtcblx0XHRcdFx0XHRmb3JtdWxhICs9IFwiPGRpdiBjbGFzcz0ncGFyc2Vncm91cGl0ZW0gXCI7XG5cdFx0XHRcdFx0aWYocm9sbHNbaV0ucmVzdWx0cyAmJiByb2xsc1tpXS5yZXN1bHRzW2dpXS5kKSB7XG5cdFx0XHRcdFx0XHRmb3JtdWxhICs9IFwiZHJvcHBlZFwiO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRmb3JtdWxhICs9IFwiJz5cIjtcblx0XHRcdFx0XHRmb3JtdWxhICs9IGZvcm1hdFJvbGxzKHJvbGxzW2ldLnJvbGxzW2dpXSk7XG5cdFx0XHRcdFx0aWYoZ2kgKyAxIDwgcm9sbHNbaV0ucm9sbHMubGVuZ3RoKSB7XG5cdFx0XHRcdFx0XHRmb3JtdWxhICs9IFwiICsgXCJcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0Zm9ybXVsYSArPSBcIjwvZGl2PlwiO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGZvcm11bGEgKz0gXCI8L2Rpdj59XCI7XG5cdFx0XHR9XG5cblx0XHRcdGlmKHJvbGxzW2ldLnR5cGUgPT09IGQyMC5kaWNlLlRZUEVfUk9MTF9FWFBSKSB7XG5cdFx0XHRcdGZvcm11bGEgKz0gXCI8ZGl2IGNsYXNzPSdkaWNlZ3JvdXBpbmcnIGRhdGEtZ3JvdXBpbmRleD0nXCIraStcIicgXCJcblxuXHRcdFx0XHQvL0lzIHRoZSBuZXh0IG9uZSBhIGxhYmVsPyBpZiBzbyBhZGQgYSB0aXRsZVxuXHRcdFx0XHRpZihyb2xsc1tpKzFdICYmIHJvbGxzW2krMV0udHlwZSA9PSBkMjAuZGljZS5UWVBFX0xBQkVMKSB7XG5cdFx0XHRcdFx0Zm9ybXVsYSArPSBcInRpdGxlPSdcIityb2xsc1tpKzFdLnRleHQucmVwbGFjZSgvJy9nLCBcIiZhcG9zO1wiKStcIidcIlxuXHRcdFx0XHR9XG5cblx0XHRcdFx0Zm9ybXVsYSArPSBcIj5cIjtcblx0XHRcdFx0Zm9ybXVsYSArPSBcIihcIjtcblx0XHRcdFx0Zm9yICh2YXIgciA9IDA7IHIgPCByb2xsc1tpXS5yZXN1bHRzLmxlbmd0aDsgcisrKSB7XG5cdFx0XHRcdFx0Zm9ybXVsYSArPSBcIjxkaXYgZGF0YS1vcmlnaW5kZXg9J1wiK3IrXCInIGNsYXNzPSdkaWNlcm9sbCBcIlxuXG5cdFx0XHRcdFx0aWYocm9sbHNbaV0ucmVzdWx0cy5sZW5ndGggPiA1MCkge1xuXHRcdFx0XHRcdFx0Zm9ybXVsYSArPSBcIndpdGhvdXRpY29ucyBcIjtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRpZihyb2xsc1tpXS5mYXRlKSB7XG5cdFx0XHRcdFx0XHRmb3JtdWxhICs9IFwiZDZcIjtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZSBpZighcm9sbHNbaV0udGFibGUpIHtcblx0XHRcdFx0XHRcdGZvcm11bGEgKz0gXCJkXCIgKyByb2xsc1tpXS5zaWRlcztcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRpZihyb2xsc1tpXS5yZXN1bHRzW3JdLmQgPT09IHRydWUpIHtcblx0XHRcdFx0XHRcdGZvcm11bGEgKz0gXCIgZHJvcHBlZCBcIjtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHR2YXIgZGlkQ3JpdCA9IGZhbHNlO1xuXHRcdFx0XHRcdHZhciBkaWRGdW1ibGUgPSBmYWxzZTtcblx0XHRcdFx0XHR2YXIgZGlkTWF0Y2ggPSBmYWxzZTtcblxuXHRcdFx0XHRcdGlmKHJvbGxzW2ldLm1vZHMgJiYgcm9sbHNbaV0ubW9kcy5jdXN0b21Dcml0KSB7XG5cdFx0XHRcdFx0XHQvL0NoZWNrIGVhY2ggdG8gc2VlIGlmIHdlIGNyaXR0ZWQuXG5cdFx0XHRcdFx0XHRfLmVhY2gocm9sbHNbaV0ubW9kcy5jdXN0b21Dcml0LCBmdW5jdGlvbihjc2RlZikge1xuXHRcdFx0XHRcdFx0XHRpZihjc2RlZi5jb21wID09PSBcIjw9XCIpIHtcblx0XHRcdFx0XHRcdFx0XHRpZihyb2xsc1tpXS5yZXN1bHRzW3JdLnYgPD0gY3NkZWYucG9pbnQpIGRpZENyaXQgPSB0cnVlO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdGVsc2UgaWYoY3NkZWYuY29tcCA9PT0gXCI+PVwiKSB7XG5cdFx0XHRcdFx0XHRcdFx0aWYocm9sbHNbaV0ucmVzdWx0c1tyXS52ID49IGNzZGVmLnBvaW50KSBkaWRDcml0ID0gdHJ1ZTtcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRlbHNlIGlmKGNzZGVmLmNvbXAgPT09IFwiPT1cIikge1xuXHRcdFx0XHRcdFx0XHRcdGlmKHJvbGxzW2ldLnJlc3VsdHNbcl0udiA9PT0gY3NkZWYucG9pbnQpIGRpZENyaXQgPSB0cnVlO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZSBpZihyb2xsc1tpXS5yZXN1bHRzW3JdLnYgPT09IHJvbGxzW2ldLnNpZGVzKSB7XG5cdFx0XHRcdFx0XHRkaWRDcml0ID0gdHJ1ZTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRpZihkaWRDcml0KSB7XG5cdFx0XHRcdFx0XHRmb3JtdWxhICs9IFwiIGNyaXRzdWNjZXNzIFwiO1xuXHRcdFx0XHRcdFx0c2hvd0NyaXRBbmltYXRpb24oKTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRpZihyb2xsc1tpXS5tb2RzICYmIHJvbGxzW2ldLm1vZHMuY3VzdG9tRnVtYmxlKSB7XG5cdFx0XHRcdFx0XHQvL0NoZWNrIGVhY2ggdG8gc2VlIGlmIHdlIGNyaXR0ZWQuXG5cdFx0XHRcdFx0XHRfLmVhY2gocm9sbHNbaV0ubW9kcy5jdXN0b21GdW1ibGUsIGZ1bmN0aW9uKGNzZGVmKSB7XG5cdFx0XHRcdFx0XHRcdGlmKGNzZGVmLmNvbXAgPT09IFwiPD1cIikge1xuXHRcdFx0XHRcdFx0XHRcdGlmKHJvbGxzW2ldLnJlc3VsdHNbcl0udiA8PSBjc2RlZi5wb2ludCkgZGlkRnVtYmxlID0gdHJ1ZTtcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRlbHNlIGlmKGNzZGVmLmNvbXAgPT09IFwiPj1cIikge1xuXHRcdFx0XHRcdFx0XHRcdGlmKHJvbGxzW2ldLnJlc3VsdHNbcl0udiA+PSBjc2RlZi5wb2ludCkgZGlkRnVtYmxlID0gdHJ1ZTtcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRlbHNlIGlmKGNzZGVmLmNvbXAgPT09IFwiPT1cIikge1xuXHRcdFx0XHRcdFx0XHRcdGlmKHJvbGxzW2ldLnJlc3VsdHNbcl0udiA9PT0gY3NkZWYucG9pbnQpIGRpZEZ1bWJsZSA9IHRydWU7XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRlbHNlIGlmKHJvbGxzW2ldLnJlc3VsdHNbcl0udiA9PT0gMSAmJiByb2xsc1tpXS5mYXRlICE9PSB0cnVlKSB7XG5cdFx0XHRcdFx0XHRkaWRGdW1ibGUgPSB0cnVlO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGlmKGRpZEZ1bWJsZSkge1xuXHRcdFx0XHRcdFx0Zm9ybXVsYSArPSBcIiBjcml0ZmFpbCBcIjtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRpZihyb2xsc1tpXS5tb2RzICYmIHJvbGxzW2ldLm1vZHMubWF0Y2ggJiYgcm9sbHNbaV0ubW9kcy5tYXRjaC5tYXRjaGVzW3JvbGxzW2ldLnJlc3VsdHNbcl0udl0pIHtcblx0XHRcdFx0XHRcdGRpZE1hdGNoID0gdHJ1ZTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRpZihkaWRNYXRjaCkge1xuXHRcdFx0XHRcdFx0Zm9ybXVsYSArPSBcIiBtYXRjaC1cIiArIHJvbGxzW2ldLm1vZHMubWF0Y2gubWF0Y2hlc1tyb2xsc1tpXS5yZXN1bHRzW3JdLnZdICsgXCJcIjtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRmb3JtdWxhICs9IFwiJz5cIjtcblxuXHRcdFx0XHRcdGlmKGRpZE1hdGNoKSB7XG5cdFx0XHRcdFx0XHRmb3JtdWxhICs9IFwiPGRpdiBjbGFzcz0nbWF0Y2hiYXInIHN0eWxlPSdib3JkZXItY29sb3I6XCIgKyByb2xsc1tpXS5tb2RzLm1hdGNoLm1hdGNoZXNbcm9sbHNbaV0ucmVzdWx0c1tyXS52XSArIFwiJz48L2Rpdj5cIjtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRmb3JtdWxhICs9IFwiPGRpdiBjbGFzcz0nZGljb24nPjxkaXYgY2xhc3M9J2RpZHJvbGwnPlwiOyBcblx0XHRcdFx0XHRpZiAocm9sbHNbaV0uZmF0ZSA9PT0gdHJ1ZSkge1xuXHRcdFx0XHRcdFx0c3dpdGNoKHJvbGxzW2ldLnJlc3VsdHNbcl0udikge1xuXHRcdFx0XHRcdFx0XHRjYXNlIDE6IFxuXHRcdFx0XHRcdFx0XHRcdGZvcm11bGEgKz0gXCIrXCI7XG5cdFx0XHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0XHRcdGNhc2UgMDogXG5cdFx0XHRcdFx0XHRcdFx0Zm9ybXVsYSArPSBcIjBcIjtcblx0XHRcdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRcdFx0Y2FzZSAtMTpcblx0XHRcdFx0XHRcdFx0XHRmb3JtdWxhICs9IFwiLVwiO1xuXHRcdFx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRlbHNlIGlmKHJvbGxzW2ldLnJlc3VsdHNbcl0udGFibGVJdGVtKSB7XG5cdFx0XHRcdFx0XHRpZihyb2xsc1tpXS5yZXN1bHRzW3JdLnRhYmxlSXRlbS5hdmF0YXIgJiYgcm9sbHNbaV0ucmVzdWx0c1tyXS50YWJsZUl0ZW0uYXZhdGFyICE9PSBcIlwiKSB7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IGF2YXRhciA9IHJvbGxzW2ldLnJlc3VsdHNbcl0udGFibGVJdGVtLmF2YXRhci5yZXBsYWNlKFwiL21lZC53ZWJtXCIsIFwiL3RodW1iLndlYm1cIik7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IHRpdGxlID0gZDIwZXh0LnV0aWxzLnN0cmlwX3RhZ3Mocm9sbHNbaV0ucmVzdWx0c1tyXS50YWJsZUl0ZW0ubmFtZSkucmVwbGFjZSgvJy9nLCBcIiZhcG9zO1wiKTtcblx0XHRcdFx0XHRcdFx0XG5cdFx0XHRcdFx0XHRcdGZvcm11bGEgKz0gZDIwLnV0aWxzLmlzVmlkZW8oYXZhdGFyKSA/XG5cdFx0XHRcdFx0XHRcdFx0YDx2aWRlbyBzcmM9XCIke2F2YXRhcn1cIiB0aXRsZT1cIiR7dGl0bGV9XCIgbXV0ZWQgYXV0b3BsYXkgbG9vcCAvPmAgOlxuXHRcdFx0XHRcdFx0XHRcdGA8aW1nIHNyYz1cIiR7YXZhdGFyfVwiIHRpdGxlPVwiJHt0aXRsZX1cIiAvPmA7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRlbHNlIHtcblx0XHRcdFx0XHRcdFx0Zm9ybXVsYSArPSBkMjBleHQudXRpbHMuc3RyaXBfdGFncyhyb2xsc1tpXS5yZXN1bHRzW3JdLnRhYmxlSXRlbS5uYW1lKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZSB7XG5cdFx0XHRcdFx0XHRmb3JtdWxhICs9IHJvbGxzW2ldLnJlc3VsdHNbcl0udjtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRmb3JtdWxhICs9IFwiPC9kaXY+PGRpdiBjbGFzcz0nYmFja2luZyc+PC9kaXY+PC9kaXY+XCI7XG5cblx0XHRcdFx0XHRpZiAocm9sbHNbaV0uZmF0ZSAhPT0gdHJ1ZSAmJiByICsgMSA8IHJvbGxzW2ldLnJlc3VsdHMubGVuZ3RoKSB7XG5cdFx0XHRcdFx0XHRmb3JtdWxhICs9IFwiK1wiO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGZvcm11bGEgKz0gXCI8L2Rpdj5cIjtcblx0XHRcdFx0fVxuXHRcdFx0XHRmb3JtdWxhICs9IFwiKVwiO1xuXHRcdFx0XHRmb3JtdWxhICs9IFwiPC9kaXY+XCI7XG5cdFx0XHR9XG5cblx0XHRcdGVsc2UgaWYocm9sbHNbaV0udHlwZSA9PT0gZDIwLmRpY2UuVFlQRV9NQVRIX0VYUFIpIHtcblx0XHRcdFx0Zm9ybXVsYSArPSByb2xsc1tpXS5leHByO1xuXHRcdFx0fVxuXG5cdFx0fVxuXG5cdFx0cmV0dXJuIGZvcm11bGE7XG5cdH07XG5cblx0dmFyIHRleHRPbmx5Rm9ybWF0Um9sbHMgPSBmdW5jdGlvbihyb2xscykge1xuXG5cdFx0dmFyIGZvcm11bGEgPSBcIlwiO1xuXG5cdFx0Zm9yKHZhciBpPTA7IGkgPCByb2xscy5sZW5ndGg7IGkrKykge1xuXG5cdFx0XHRpZihyb2xsc1tpXS50eXBlID09PSBkMjAuZGljZS5UWVBFX0dST1VQX0VYUFIpIHtcblx0XHRcdFx0Zm9ybXVsYSArPSBcIntcIlxuXHRcdFx0XHRmb3IodmFyIGdpPTA7IGdpIDwgcm9sbHNbaV0ucm9sbHMubGVuZ3RoOyBnaSsrKSB7XG5cdFx0XHRcdFx0Zm9ybXVsYSArPSB0ZXh0T25seUZvcm1hdFJvbGxzKHJvbGxzW2ldLnJvbGxzW2dpXSk7XG5cdFx0XHRcdFx0aWYoZ2kgKyAxIDwgcm9sbHNbaV0ucm9sbHMubGVuZ3RoKSB7XG5cdFx0XHRcdFx0XHRmb3JtdWxhICs9IFwiK1wiXG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHRcdGZvcm11bGEgKz0gXCJ9XCI7XG5cdFx0XHR9XG5cblx0XHRcdGlmKHJvbGxzW2ldLnR5cGUgPT09IGQyMC5kaWNlLlRZUEVfUk9MTF9FWFBSKSB7XG5cdFx0XHRcdHZhciBybCA9IHJvbGxzW2ldLnJlc3VsdHMgIT09IHVuZGVmaW5lZCA/IHJvbGxzW2ldLnJlc3VsdHMubGVuZ3RoIDogMDtcblx0XHRcdFx0Zm9ybXVsYSArPSBcIihcIjtcblx0XHRcdFx0Zm9yICh2YXIgciA9IDA7IHIgPCBybDsgcisrKSB7XG5cdFx0XHRcdFx0aWYgKHJvbGxzW2ldLmZhdGUgPT09IHRydWUpIHtcblx0XHRcdFx0XHRcdHN3aXRjaChyb2xsc1tpXS5yZXN1bHRzW3JdLnYpIHtcblx0XHRcdFx0XHRcdFx0Y2FzZSAxOiBcblx0XHRcdFx0XHRcdFx0XHRmb3JtdWxhICs9IFwiK1wiO1xuXHRcdFx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdFx0XHRjYXNlIDA6IFxuXHRcdFx0XHRcdFx0XHRcdGZvcm11bGEgKz0gXCIwXCI7XG5cdFx0XHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0XHRcdGNhc2UgLTE6XG5cdFx0XHRcdFx0XHRcdFx0Zm9ybXVsYSArPSBcIi1cIjtcblx0XHRcdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZSBpZihyb2xsc1tpXS5yZXN1bHRzW3JdLnRhYmxlSXRlbSkge1xuXHRcdFx0XHRcdFx0Zm9ybXVsYSArPSBkMjBleHQudXRpbHMuc3RyaXBfdGFncyhyb2xsc1tpXS5yZXN1bHRzW3JdLnRhYmxlSXRlbS5uYW1lKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZSB7XG5cdFx0XHRcdFx0XHRmb3JtdWxhICs9IHJvbGxzW2ldLnJlc3VsdHNbcl0udjtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRpZiAocm9sbHNbaV0uZmF0ZSAhPT0gdHJ1ZSAmJiByICsgMSA8IHJvbGxzW2ldLnJlc3VsdHMubGVuZ3RoKSB7XG5cdFx0XHRcdFx0XHRmb3JtdWxhICs9IFwiK1wiO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0XHRmb3JtdWxhICs9IFwiKVwiO1xuXHRcdFx0fVxuXG5cdFx0XHRlbHNlIGlmKHJvbGxzW2ldLnR5cGUgPT09IGQyMC5kaWNlLlRZUEVfTUFUSF9FWFBSKSB7XG5cdFx0XHRcdGZvcm11bGEgKz0gcm9sbHNbaV0uZXhwcjtcblx0XHRcdH1cblxuXHRcdH1cblxuXHRcdHJldHVybiBmb3JtdWxhO1xuXG5cdH07XG5cblx0dmFyIGJhc2ljSFRNTEZvcm1hdFJvbGxzID0gZnVuY3Rpb24ocm9sbHMpIHtcblxuXHRcdGlmKCFyb2xscykgcmV0dXJuO1xuXG5cdFx0dmFyIGZvcm11bGEgPSBcIlwiO1xuXG5cdFx0Zm9yKHZhciBpPTA7IGkgPCByb2xscy5sZW5ndGg7IGkrKykge1xuXHRcdFx0aWYocm9sbHNbaV0udHlwZSA9PT0gZDIwLmRpY2UuVFlQRV9HUk9VUF9FWFBSKSB7XG5cdFx0XHRcdGZvcm11bGEgKz0gXCJ7XCJcblx0XHRcdFx0Zm9yKHZhciBnaT0wOyBnaSA8IHJvbGxzW2ldLnJvbGxzLmxlbmd0aDsgZ2krKykge1xuXHRcdFx0XHRcdGZvcm11bGEgKz0gYmFzaWNIVE1MRm9ybWF0Um9sbHMocm9sbHNbaV0ucm9sbHNbZ2ldKTtcblx0XHRcdFx0XHRpZihnaSArIDEgPCByb2xsc1tpXS5yb2xscy5sZW5ndGgpIHtcblx0XHRcdFx0XHRcdGZvcm11bGEgKz0gXCIrXCJcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdFx0Zm9ybXVsYSArPSBcIn1cIjtcblx0XHRcdH1cblxuXHRcdFx0aWYocm9sbHNbaV0udHlwZSA9PT0gZDIwLmRpY2UuVFlQRV9ST0xMX0VYUFIpIHtcblx0XHRcdFx0dmFyIHJsID0gcm9sbHNbaV0ucmVzdWx0cyAhPT0gdW5kZWZpbmVkID8gcm9sbHNbaV0ucmVzdWx0cy5sZW5ndGggOiAwO1xuXHRcdFx0XHR2YXIgbWF0Y2hlcyA9IHJvbGxzW2ldLm1vZHMgJiYgcm9sbHNbaV0ubW9kcy5tYXRjaCAmJiByb2xsc1tpXS5tb2RzLm1hdGNoLm1hdGNoZXMgPyByb2xsc1tpXS5tb2RzLm1hdGNoLm1hdGNoZXMgOiBbXTtcblx0XHRcdFx0Zm9ybXVsYSArPSBcIihcIjtcblx0XHRcdFx0Zm9yICh2YXIgciA9IDA7IHIgPCBybDsgcisrKSB7XG5cblx0XHRcdFx0XHRmb3JtdWxhICs9IFwiPHNwYW4gY2xhc3M9J2Jhc2ljZGljZXJvbGxcIjtcblxuXHRcdFx0XHRcdGlmKHJvbGxzW2ldLnJlc3VsdHNbcl0uZCkge1xuXHRcdFx0XHRcdFx0Zm9ybXVsYSArPSBcIiBkcm9wcGVkXCI7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGVsc2Uge1xuXHRcdFx0XHRcdFx0dmFyIGRpZENyaXQgPSBmYWxzZTtcblx0XHRcdFx0XHRcdHZhciBkaWRGdW1ibGUgPSBmYWxzZTtcblx0XHRcdFx0XHRcdGlmKHJvbGxzW2ldLm1vZHMgJiYgcm9sbHNbaV0ubW9kcy5jdXN0b21Dcml0KSB7XG5cdFx0XHRcdFx0XHRcdC8vQ2hlY2sgZWFjaCB0byBzZWUgaWYgd2UgY3JpdHRlZC5cblx0XHRcdFx0XHRcdFx0Xy5lYWNoKHJvbGxzW2ldLm1vZHMuY3VzdG9tQ3JpdCwgZnVuY3Rpb24oY3NkZWYpIHtcblx0XHRcdFx0XHRcdFx0XHRpZihjc2RlZi5jb21wID09PSBcIjw9XCIpIHtcblx0XHRcdFx0XHRcdFx0XHRcdGlmKHJvbGxzW2ldLnJlc3VsdHNbcl0udiA8PSBjc2RlZi5wb2ludCkgZGlkQ3JpdCA9IHRydWU7XG5cdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdGVsc2UgaWYoY3NkZWYuY29tcCA9PT0gXCI+PVwiKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRpZihyb2xsc1tpXS5yZXN1bHRzW3JdLnYgPj0gY3NkZWYucG9pbnQpIGRpZENyaXQgPSB0cnVlO1xuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHRlbHNlIGlmKGNzZGVmLmNvbXAgPT09IFwiPT1cIikge1xuXHRcdFx0XHRcdFx0XHRcdFx0aWYocm9sbHNbaV0ucmVzdWx0c1tyXS52ID09PSBjc2RlZi5wb2ludCkgZGlkQ3JpdCA9IHRydWU7XG5cdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdGVsc2UgaWYocm9sbHNbaV0ucmVzdWx0c1tyXS52ID09PSByb2xsc1tpXS5zaWRlcykge1xuXHRcdFx0XHRcdFx0XHRkaWRDcml0ID0gdHJ1ZTtcblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0aWYoZGlkQ3JpdCkge1xuXHRcdFx0XHRcdFx0XHRmb3JtdWxhICs9IFwiIGNyaXRzdWNjZXNzIFwiO1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRpZihyb2xsc1tpXS5tb2RzICYmIHJvbGxzW2ldLm1vZHMuY3VzdG9tRnVtYmxlKSB7XG5cdFx0XHRcdFx0XHRcdC8vQ2hlY2sgZWFjaCB0byBzZWUgaWYgd2UgY3JpdHRlZC5cblx0XHRcdFx0XHRcdFx0Xy5lYWNoKHJvbGxzW2ldLm1vZHMuY3VzdG9tRnVtYmxlLCBmdW5jdGlvbihjc2RlZikge1xuXHRcdFx0XHRcdFx0XHRcdGlmKGNzZGVmLmNvbXAgPT09IFwiPD1cIikge1xuXHRcdFx0XHRcdFx0XHRcdFx0aWYocm9sbHNbaV0ucmVzdWx0c1tyXS52IDw9IGNzZGVmLnBvaW50KSBkaWRGdW1ibGUgPSB0cnVlO1xuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHRlbHNlIGlmKGNzZGVmLmNvbXAgPT09IFwiPj1cIikge1xuXHRcdFx0XHRcdFx0XHRcdFx0aWYocm9sbHNbaV0ucmVzdWx0c1tyXS52ID49IGNzZGVmLnBvaW50KSBkaWRGdW1ibGUgPSB0cnVlO1xuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHRlbHNlIGlmKGNzZGVmLmNvbXAgPT09IFwiPT1cIikge1xuXHRcdFx0XHRcdFx0XHRcdFx0aWYocm9sbHNbaV0ucmVzdWx0c1tyXS52ID09PSBjc2RlZi5wb2ludCkgZGlkRnVtYmxlID0gdHJ1ZTtcblx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0ZWxzZSBpZihyb2xsc1tpXS5yZXN1bHRzW3JdLnYgPT09IDEgJiYgcm9sbHNbaV0uZmF0ZSAhPT0gdHJ1ZSkge1xuXHRcdFx0XHRcdFx0XHRkaWRGdW1ibGUgPSB0cnVlO1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRpZihkaWRGdW1ibGUpIHtcblx0XHRcdFx0XHRcdFx0Zm9ybXVsYSArPSBcIiBjcml0ZmFpbCBcIjtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRpZihtYXRjaGVzICE9IFtdICYmIG1hdGNoZXNbcm9sbHNbaV0ucmVzdWx0c1tyXS52XSkge1xuXHRcdFx0XHRcdFx0Zm9ybXVsYSArPSBcIicgc3R5bGU9J2NvbG9yOiBcIiArIG1hdGNoZXNbcm9sbHNbaV0ucmVzdWx0c1tyXS52XSArIFwiJ1wiO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGZvcm11bGEgKz0gXCInPlwiO1xuXG5cdFx0XHRcdFx0aWYgKHJvbGxzW2ldLmZhdGUgPT09IHRydWUpIHtcblx0XHRcdFx0XHRcdHN3aXRjaChyb2xsc1tpXS5yZXN1bHRzW3JdLnYpIHtcblx0XHRcdFx0XHRcdFx0Y2FzZSAxOiBcblx0XHRcdFx0XHRcdFx0XHRmb3JtdWxhICs9IFwiK1wiO1xuXHRcdFx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdFx0XHRjYXNlIDA6IFxuXHRcdFx0XHRcdFx0XHRcdGZvcm11bGEgKz0gXCIwXCI7XG5cdFx0XHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0XHRcdGNhc2UgLTE6XG5cdFx0XHRcdFx0XHRcdFx0Zm9ybXVsYSArPSBcIi1cIjtcblx0XHRcdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZSBpZihyb2xsc1tpXS5yZXN1bHRzW3JdLnRhYmxlSXRlbSkge1xuXHRcdFx0XHRcdFx0Zm9ybXVsYSArPSBkMjBleHQudXRpbHMuc3RyaXBfdGFncyhyb2xsc1tpXS5yZXN1bHRzW3JdLnRhYmxlSXRlbS5uYW1lKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZSB7XG5cdFx0XHRcdFx0XHRmb3JtdWxhICs9IHJvbGxzW2ldLnJlc3VsdHNbcl0udjtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRmb3JtdWxhICs9IFwiPC9zcGFuPlwiO1xuXG5cdFx0XHRcdFx0aWYgKHJvbGxzW2ldLmZhdGUgIT09IHRydWUgJiYgciArIDEgPCByb2xsc1tpXS5yZXN1bHRzLmxlbmd0aCkge1xuXHRcdFx0XHRcdFx0Zm9ybXVsYSArPSBcIitcIjtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdFx0Zm9ybXVsYSArPSBcIilcIjtcblx0XHRcdH1cblxuXHRcdFx0ZWxzZSBpZihyb2xsc1tpXS50eXBlID09PSBkMjAuZGljZS5UWVBFX01BVEhfRVhQUikge1xuXHRcdFx0XHRmb3JtdWxhICs9IHJvbGxzW2ldLmV4cHI7XG5cdFx0XHR9XG5cblx0XHR9XG5cblx0XHRyZXR1cm4gZm9ybXVsYTtcblxuXHR9O1xuXG5cdGQyMC5kaWNlX2Zvcm1hdHRlci5jaGVja0ZvckNyaXRzID0gZnVuY3Rpb24ocm9sbHMsIGNyaXR0eXBlKSB7XG5cblx0XHRpZighcm9sbHMpIHJldHVybiBmYWxzZTtcblxuXHRcdHZhciBkaWRDcml0ID0gZmFsc2U7XG5cdFx0dmFyIGRpZEZ1bWJsZSA9IGZhbHNlO1xuXG5cdFx0Zm9yKHZhciBpPTA7IGkgPCByb2xscy5sZW5ndGg7IGkrKykge1xuXG5cdFx0XHRpZihyb2xsc1tpXS50eXBlID09PSBkMjAuZGljZS5UWVBFX0dST1VQX0VYUFIpIHtcblx0XHRcdFx0Zm9yKHZhciBnaT0wOyBnaSA8IHJvbGxzW2ldLnJvbGxzLmxlbmd0aDsgZ2krKykge1xuXHRcdFx0XHRcdGlmKGQyMC5kaWNlX2Zvcm1hdHRlci5jaGVja0ZvckNyaXRzKHJvbGxzW2ldLnJvbGxzW2dpXSwgY3JpdHR5cGUpID09PSB0cnVlKSB7XG5cdFx0XHRcdFx0XHRpZihjcml0dHlwZSA9PT0gXCJjcml0XCIpIFxuXHRcdFx0XHRcdFx0XHRkaWRDcml0ID0gdHJ1ZTtcblx0XHRcdFx0XHRcdGVsc2UgXG5cdFx0XHRcdFx0XHRcdGRpZEZ1bWJsZSA9IHRydWU7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdGlmKHJvbGxzW2ldLnR5cGUgPT09IGQyMC5kaWNlLlRZUEVfUk9MTF9FWFBSKSB7XG5cdFx0XHRcdHZhciBybCA9IHJvbGxzW2ldLnJlc3VsdHMgIT09IHVuZGVmaW5lZCA/IHJvbGxzW2ldLnJlc3VsdHMubGVuZ3RoIDogMDtcblx0XHRcdFx0Zm9yICh2YXIgciA9IDA7IHIgPCBybDsgcisrKSB7XG5cdFx0XHRcdFx0Ly8gU2tpcCBkcm9wcGVkIGRpY2Ugc28gdGhleSBjYW4ndCB0cmlnZ2VyIFdhc0NyaXQgb3IgV2FzRnVtYmxlXG5cdFx0XHRcdFx0aWYocm9sbHNbaV0ucmVzdWx0c1tyXS5kID09PSB0cnVlKSBjb250aW51ZTtcblxuXHRcdFx0XHRcdGlmKHJvbGxzW2ldLm1vZHMgJiYgcm9sbHNbaV0ubW9kcy5jdXN0b21Dcml0KSB7XG5cdFx0XHRcdFx0XHQvL0NoZWNrIGVhY2ggdG8gc2VlIGlmIHdlIGNyaXR0ZWQuXG5cdFx0XHRcdFx0XHRfLmVhY2gocm9sbHNbaV0ubW9kcy5jdXN0b21Dcml0LCBmdW5jdGlvbihjc2RlZikge1xuXHRcdFx0XHRcdFx0XHRpZihjc2RlZi5jb21wID09PSBcIjw9XCIpIHtcblx0XHRcdFx0XHRcdFx0XHRpZihyb2xsc1tpXS5yZXN1bHRzW3JdLnYgPD0gY3NkZWYucG9pbnQpIGRpZENyaXQgPSB0cnVlO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdGVsc2UgaWYoY3NkZWYuY29tcCA9PT0gXCI+PVwiKSB7XG5cdFx0XHRcdFx0XHRcdFx0aWYocm9sbHNbaV0ucmVzdWx0c1tyXS52ID49IGNzZGVmLnBvaW50KSBkaWRDcml0ID0gdHJ1ZTtcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRlbHNlIGlmKGNzZGVmLmNvbXAgPT09IFwiPT1cIikge1xuXHRcdFx0XHRcdFx0XHRcdGlmKHJvbGxzW2ldLnJlc3VsdHNbcl0udiA9PT0gY3NkZWYucG9pbnQpIGRpZENyaXQgPSB0cnVlO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZSBpZihyb2xsc1tpXS5yZXN1bHRzW3JdLnYgPT09IHJvbGxzW2ldLnNpZGVzKSB7XG5cdFx0XHRcdFx0XHRkaWRDcml0ID0gdHJ1ZTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRpZihyb2xsc1tpXS5tb2RzICYmIHJvbGxzW2ldLm1vZHMuY3VzdG9tRnVtYmxlKSB7XG5cdFx0XHRcdFx0XHQvL0NoZWNrIGVhY2ggdG8gc2VlIGlmIHdlIGNyaXR0ZWQuXG5cdFx0XHRcdFx0XHRfLmVhY2gocm9sbHNbaV0ubW9kcy5jdXN0b21GdW1ibGUsIGZ1bmN0aW9uKGNzZGVmKSB7XG5cdFx0XHRcdFx0XHRcdGlmKGNzZGVmLmNvbXAgPT09IFwiPD1cIikge1xuXHRcdFx0XHRcdFx0XHRcdGlmKHJvbGxzW2ldLnJlc3VsdHNbcl0udiA8PSBjc2RlZi5wb2ludCkgZGlkRnVtYmxlID0gdHJ1ZTtcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRlbHNlIGlmKGNzZGVmLmNvbXAgPT09IFwiPj1cIikge1xuXHRcdFx0XHRcdFx0XHRcdGlmKHJvbGxzW2ldLnJlc3VsdHNbcl0udiA+PSBjc2RlZi5wb2ludCkgZGlkRnVtYmxlID0gdHJ1ZTtcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRlbHNlIGlmKGNzZGVmLmNvbXAgPT09IFwiPT1cIikge1xuXHRcdFx0XHRcdFx0XHRcdGlmKHJvbGxzW2ldLnJlc3VsdHNbcl0udiA9PT0gY3NkZWYucG9pbnQpIGRpZEZ1bWJsZSA9IHRydWU7XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRlbHNlIGlmKHJvbGxzW2ldLnJlc3VsdHNbcl0udiA9PT0gMSAmJiByb2xsc1tpXS5mYXRlICE9PSB0cnVlKSB7XG5cdFx0XHRcdFx0XHRkaWRGdW1ibGUgPSB0cnVlO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiAoY3JpdHR5cGUgPT09IFwiY3JpdFwiID8gZGlkQ3JpdCA6IGRpZEZ1bWJsZSk7XG5cdH1cblxuXHRkMjAuZGljZV9mb3JtYXR0ZXIuZ2V0SHRtbEZvclJlc3VsdCA9IGZ1bmN0aW9uKHJlc3VsdE9iaikge1xuXHRcdHZhciBmb3JtdWxhID0gZm9ybWF0Um9sbHMocmVzdWx0T2JqLnJvbGxzKTtcblx0XHR2YXIgdG90YWwgPSByZXN1bHRPYmoudG90YWw7XG5cblx0XHRpZihyZXN1bHRPYmoucmVzdWx0VHlwZSA9PT0gZDIwLmRpY2UuUk9MTF9UWVBFX1NVQ0NFU1MpIHtcblx0XHRcdHRvdGFsID0gdG90YWwgPT09IDEgPyB0b3RhbCArIFwiIFN1Y2Nlc3NcIiA6IHRvdGFsICsgXCIgU3VjY2Vzc2VzXCI7XG5cdFx0fVxuXHRcdGVsc2UgaWYocmVzdWx0T2JqLnJlc3VsdFR5cGUgPT09IGQyMC5kaWNlLlJPTExfVFlQRV9NQVRDSCkge1xuXHRcdFx0dG90YWwgPSB0b3RhbCA9PT0gMSA/IHRvdGFsICsgXCIgTWF0Y2hcIiA6IHRvdGFsICsgXCIgTWF0Y2hlc1wiO1xuXHRcdH1cblxuXHRcdHJldHVybiB7XG5cdFx0XHRmb3JtdWxhOiBmb3JtdWxhLFxuXHRcdFx0dG90YWw6IHRvdGFsXG5cdFx0fVxuXHR9O1xuXG5cdGQyMC5kaWNlX2Zvcm1hdHRlci5yZXBsYWNlSW5saW5lUm9sbHMgPSBmdW5jdGlvbih0ZXh0Y29udGVudCwgb3AsIGFsbG93ZWRUYWdzKSB7XG5cdFx0Ly8gdGV4dGNvbnRlbnQgPSBkMjAudXRpbHMuc3RyaXBfdGFncyh0ZXh0Y29udGVudC5yZXBsYWNlKFwiPFwiLFwiJmx0O1wiKSwgYWxsb3dlZFRhZ3MpO1xuXHRcdHRleHRjb250ZW50ID0gZDIwLnV0aWxzLnN0cmlwX3RhZ3ModGV4dGNvbnRlbnQsIGFsbG93ZWRUYWdzKTtcblx0XHRpZighb3AuaW5saW5lcm9sbHMpIHJldHVybiB0ZXh0Y29udGVudDtcblx0XHR0ZXh0Y29udGVudCA9IHRleHRjb250ZW50LnJlcGxhY2UoL1xcJFxcW1xcW1swLTldKyhcXC5jb21wdXRlZCk/XFxdXFxdL2csIGZ1bmN0aW9uKGlubGluZW1hdGNoKSB7XG5cdFx0XHRjb25zdCBzdHJpcHBlZE1hdGNoID0gaW5saW5lbWF0Y2gucmVwbGFjZSgvW1xcJFxcW1xcW1xcXVxcXV0vZywgJycpO1xuXHRcdFx0Ly8gQ2hlY2sgd2hldGhlciB3ZSdyZSBsb29raW5nIGZvciB0aGUgY29tcHV0ZWQgdmFsdWVcblx0XHRcdGNvbnN0IGNvbXB1dGVkID0gc3RyaXBwZWRNYXRjaC5zdWJzdHIoLTkpID09PSAnLmNvbXB1dGVkJyA/IHRydWUgOiBmYWxzZTtcblx0XHRcdHZhciBpbmxpbmVyb2xsaW5kZXggPSBzdHJpcHBlZE1hdGNoLnNwbGl0KCcuJylbMF07XG5cdFx0XHR2YXIgaW5saW5lcm9sbCA9IG9wLmlubGluZXJvbGxzW3BhcnNlSW50KGlubGluZXJvbGxpbmRleCwgMTApXTtcblx0XHRcdGlmKCFpbmxpbmVyb2xsIHx8ICFpbmxpbmVyb2xsLnJlc3VsdHMpIHtcblx0XHRcdFx0cmV0dXJuIFwiSU5WQUxJRCBJTkxJTkUgUk9MTCFcIjtcblx0XHRcdH1cblxuXHRcdFx0aW5saW5lcm9sbC5leHByZXNzaW9uID0gaW5saW5lcm9sbC5leHByZXNzaW9uLnJlcGxhY2UoXCI8XCIsXCImbHQ7XCIpO1xuXHRcdFx0dmFyIG15dGl0bGUgPSBcIlJvbGxpbmcgXCIgKyBkMjAudXRpbHMuc3RyaXBfdGFncyhpbmxpbmVyb2xsLmV4cHJlc3Npb24sIGFsbG93ZWRUYWdzKSArIFwiID0gXCI7XG5cblx0XHRcdGlmKGlubGluZXJvbGwuc2lnbmF0dXJlICYmIGQyMC50ZXh0Y2hhdC52ZXJpZnlSb2xsKGlubGluZXJvbGwucm9sbGlkLCBpbmxpbmVyb2xsLnJlc3VsdHMsIGlubGluZXJvbGwuc2lnbmF0dXJlKSkge1xuXHRcdFx0XHRteXRpdGxlID0gXCI8aW1nIHNyYz0nL2ltYWdlcy9xdWFudHVtcm9sbHdoaXRlLnBuZycgY2xhc3M9J2lubGluZXFyb2xsJz4gXCIgKyBteXRpdGxlO1xuXHRcdFx0fVxuXG5cdFx0XHRteXRpdGxlICs9IGJhc2ljSFRNTEZvcm1hdFJvbGxzKGlubGluZXJvbGwucmVzdWx0cy5yb2xscyk7XG5cblx0XHRcdC8vIFVzZSB0aGUgY29tcHV0ZWQgcmVzdWx0IGlmIHJlcXVlc3RlZFxuXHRcdFx0Ly8gTm90ZSB0aGF0IGlmIGEgY29tcHV0ZWQgdmFsdWUgaXNuJ3QgcHJlc2VudCwgdGhlIHRvdGFsIHdpbGwgYmUgdXNlZFxuXHRcdFx0dmFyIG15dG90YWwgPSBjb21wdXRlZCAmJiBpbmxpbmVyb2xsLmNvbXB1dGVkICE9PSB1bmRlZmluZWQgPyBpbmxpbmVyb2xsLmNvbXB1dGVkIDppbmxpbmVyb2xsLnJlc3VsdHMudG90YWw7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRpZihteXRvdGFsID09IDAgJiYgaW5saW5lcm9sbC5yZXN1bHRzLnJvbGxzWzBdLnJlc3VsdHNbMF0udGFibGVJdGVtKSBteXRvdGFsID0gZDIwZXh0LnV0aWxzLnN0cmlwX3RhZ3MoaW5saW5lcm9sbC5yZXN1bHRzLnJvbGxzWzBdLnJlc3VsdHNbMF0udGFibGVJdGVtLm5hbWUpO1xuXHRcdFx0fVxuXHRcdFx0Y2F0Y2goZSkge1xuXHRcdFx0XHQvL2Rpc2NhcmRcblx0XHRcdH1cblxuXHRcdFx0dmFyIG15aHRtbCA9IFwiPHNwYW4gY2xhc3M9J2lubGluZXJvbGxyZXN1bHQgc2hvd3RpcCB0aXBzeS1uLXJpZ2h0XCI7XG5cdFx0XHR2YXIgaGFzY3JpdCA9IG15dGl0bGUuaW5kZXhPZihcImNyaXRzdWNjZXNzXCIpICE9PSAtMTtcblx0XHRcdHZhciBoYXNmYWlsID0gbXl0aXRsZS5pbmRleE9mKFwiY3JpdGZhaWxcIikgIT09IC0xO1xuXG5cdFx0XHRpZihoYXNjcml0ICYmIGhhc2ZhaWwpIHtcblx0XHRcdFx0bXlodG1sICs9IFwiIGltcG9ydGFudHJvbGxcIjtcblx0XHRcdH1cblx0XHRcdGVsc2UgaWYoaGFzY3JpdCkge1xuXHRcdFx0XHRteWh0bWwgKz0gXCIgZnVsbGNyaXRcIjtcblx0XHRcdH1cblx0XHRcdGVsc2UgaWYoaGFzZmFpbCkge1xuXHRcdFx0XHRteWh0bWwgKz0gXCIgZnVsbGZhaWxcIjtcblx0XHRcdH1cblxuXHRcdFx0bXlodG1sICs9IFwiJyB0aXRsZT0nXCIrbXl0aXRsZS5yZXBsYWNlKC8nL2csIFwiJnF1b3Q7XCIpK1wiJz5cIiArIG15dG90YWwgKyBcIjwvc3Bhbj5cIjtcblxuXHRcdFx0cmV0dXJuIG15aHRtbDtcblxuXHRcdH0pO1xuXG5cdFx0cmV0dXJuIHRleHRjb250ZW50O1xuXHR9O1xuXG5cdC8qKlxuXHQqIEFzc29jaWF0ZSBmb3JtYXQgbWFya2VycyB3aXRoIENTUyBjbGFzc2VzXG5cdCovXG5cdHZhciByb2xsRm9ybWF0cyA9IHtcblx0XHRcIkBcIjogXCJjcml0c3VjY2Vzc1wiLFxuXHRcdFwiI1wiOiBcImNyaXRmYWlsXCIsXG5cdFx0XCJfXCI6IFwiZHJvcHBlZFwiXG5cdH07XG5cblx0LyoqXG5cdCogRGV0ZXJtaW5lcyBhbGwgbmVzc3RlZCBmb3JtYXR0aW5nIHJ1bGVzIFxuXHQqL1xuXHR2YXIgZ2V0QWxsRm9ybWF0cyA9IGZ1bmN0aW9uKHJvbGwsIGZvcm1hdHMpIHtcblx0XHRmb3IgKHZhciBmb3JtYXRUeXBlIGluIHJvbGxGb3JtYXRzKSB7XG5cdFx0XHR2YXIgcGF0dGVybiA9IG5ldyBSZWdFeHAoXCJcXFxce1wiICsgZm9ybWF0VHlwZSArIFwiKC4rPylcIiArIGZvcm1hdFR5cGUgKyBcIlxcXFx9XCIsIFwiZ1wiKTtcblx0XHRcdHZhciBtYXRjaDtcblx0XHRcdGlmICgobWF0Y2ggPSBwYXR0ZXJuLmV4ZWMocm9sbCkpICE9IG51bGwpIHtcblx0XHRcdFx0Zm9ybWF0cy5wdXNoKCByb2xsRm9ybWF0c1tmb3JtYXRUeXBlXSApO1xuXHRcdFx0XHRyZXR1cm4gZ2V0QWxsRm9ybWF0cyhtYXRjaFsxXSwgZm9ybWF0cyk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHJvbGw7XG5cdH1cblxuXHQvKipcblx0KiBGb3JtYXRzIGEgZGljZSByb2xsIHN0cmluZyBpbnRvIEhUTUxcblx0Ki9cblx0ZDIwLmRpY2VfZm9ybWF0dGVyLm9sZGZvcm1hdCA9IGZ1bmN0aW9uKHJvbGxSZXN1bHQpIHtcblx0XHRpZihyb2xsUmVzdWx0ID09PSB1bmRlZmluZWQpIHtcblx0XHRcdHJldHVybiBcIlwiO1xuXHRcdH1cblx0XHRyZXR1cm4gcm9sbFJlc3VsdC5yZXBsYWNlKC9cXHsoW0AjX10pKC4rPylcXDFcXH0vZywgZnVuY3Rpb24ocm9sbCwgZm9ybWF0VHlwZSwgdmFsdWUpIHtcblx0XHRcdHZhciBmb3JtYXRzID0gWyByb2xsRm9ybWF0c1tmb3JtYXRUeXBlXSBdO1xuXHRcdFx0dmFyIHZhbHVlID0gZ2V0QWxsRm9ybWF0cyh2YWx1ZSwgZm9ybWF0cyk7XG5cblx0XHRcdHJldHVybiBcIjxzcGFuIGNsYXNzPSdcIiArIGZvcm1hdHMuc29ydCgpLmpvaW4oXCIgXCIpICsgXCInPlwiICsgdmFsdWUgKyBcIjwvc3Bhbj5cIjtcblx0XHR9KTtcblx0fVxuXHRcbn0pKCk7XG5cbmQyMC5kaWNlX2VuZ2luZSA9IGZ1bmN0aW9uKHNlZWQpIHtcblx0ZDIwLmRpY2UgPSBkMjAuZGljZSB8fCB7fTtcblx0ZDIwLmRpY2UuVFlQRV9NQVRIX0VYUFIgPSBcIk1cIjtcblx0ZDIwLmRpY2UuVFlQRV9ST0xMX0VYUFIgPSBcIlJcIjtcblx0ZDIwLmRpY2UuVFlQRV9HUk9VUF9FWFBSID0gXCJHXCI7XG5cdGQyMC5kaWNlLlRZUEVfTEFCRUwgPSBcIkxcIjtcblx0ZDIwLmRpY2UuVFlQRV9DT01NRU5UID0gXCJDXCI7XG5cdGQyMC5kaWNlLlRZUEVfVkFMSURBVEVEX1JPTExTID0gXCJWXCI7XG5cdGQyMC5kaWNlLlJPTExfVFlQRV9NQVRDSCA9IFwibWF0Y2hcIjtcblx0ZDIwLmRpY2UuUk9MTF9UWVBFX1NVQ0NFU1MgPSBcInN1Y2Nlc3NcIjtcblx0ZDIwLmRpY2UuUk9MTF9UWVBFX1RBQkxFID0gXCJ0YWJsZVwiO1xuXHRkMjAuZGljZS5ST0xMX1RZUEVfU1VNID0gXCJzdW1cIjtcblx0ZDIwLmRpY2UuTUFUQ0hfQ09MT1JTID0gW1wiI2VlMDA4NlwiLFwiI2ZmOWMwMFwiLFwiIzY4OGRlOFwiLFwiI2E2ZjkwMFwiLFwiI2E5MDllMVwiLFwiI2ZmNmEwMFwiLFwiIzA3YWZkZVwiLFwiI2VlZmUwMFwiXTtcblxuXHRpZiAoZDIwLmdldFRhYmxlRWxlbWVudENvdW50ID09IHVuZGVmaW5lZCkge1xuXHRcdGQyMC5nZXRUYWJsZUVsZW1lbnRDb3VudCA9IGZ1bmN0aW9uKG5hbWUpIHtcblx0XHRcdGxvZyhcIlVzaW5nIGZhbGxiYWNrIGdldFRhYmxlRWxlbWVudENvdW50KFwiICsgbmFtZSArIFwiKVwiKTtcblx0XHRcdHJldHVybiBuYW1lLmxlbmd0aDtcblx0XHR9O1xuXHRcdGQyMC5nZXRUYWJsZUVsZW1lbnRWYWx1ZSA9IGZ1bmN0aW9uKG5hbWUsIGluZGV4KSB7XG5cdFx0XHRsb2coXCJVc2luZyBmYWxsYmFjayBnZXRUYWJsZUVsZW1lbnRWYWx1ZShcIiArIG5hbWUgKyBcIiwgXCIgKyBpbmRleCArIFwiKVwiKTtcblx0XHRcdHJldHVybiBwYXJzZUludChuYW1lLCAxMCkgfHwgMDtcblx0XHR9O1xuXHR9XG5cblx0dmFyIE1BWF9OVU1fUk9MTFMgPSA5OTk7XG5cdHZhciBNQVhfUk9MTCA9IDk5OTk5OTk7XG5cdHZhciByZWNlbnRSb2xscyA9IFtdO1xuXG5cdGlmIChzZWVkID09IHVuZGVmaW5lZCkge1xuXHRcdE1hdGguc2VlZHJhbmRvbSh3aW5kb3cuUkFORE9NX0VOVFJPUFksIHRydWUpO1xuXHR9XG5cdGVsc2Uge1xuXHRcdE1hdGguc2VlZHJhbmRvbShzZWVkKTtcblx0fVxuXG5cdHRoaXMucmFuZG9tID0gTWF0aC5yYW5kb21JbnQ7XG5cblx0dmFyIG90aGlzID0gdGhpcztcblxuXHQvKipcblx0ICogVXRpbGl0eSBjbGFzcyB0aGF0IHRyaWdnZXJzIHRoZSBleGVjdXRpb24gb2YgYSBjYWxsYmFjayBhZnRlclxuXHQgKiBhIHNwZWNpZmllZCBudW1iZXIgb2YgdGFza3MgaGF2ZSBzaWduYWxsZWQgY29tcGxldGlvbiBieSBjYWxsaW5nXG5cdCAqIHRhc2tDb21wbGV0ZSgpO1xuXHQgKlxuXHQgKiBAcGFyYW0gdGFza0NvdW50IE51bWJlciBvZiB0YXNrcyB0aGF0IG11c3QgY29tcGxldGUgYmVmb3JlIGNvbXBsZXRpb25DYWxsYmFjayBpcyBleGVjdXRlZFxuXHQgKiBAcGFyYW0gY29tcGxldGlvbkNhbGxiYWNrIFRoZSBjYWxsYmFjayB0byBleGVjdXRlIG9uY2UgdGFza0NvdW50IHRhc2tzIGhhdmUgYmVlbiBjb21wbGV0ZWRcblx0ICovXG5cdGZ1bmN0aW9uIFRhc2tDb21wbGV0aW9uQ2FsbGJhY2sodGFza0NvdW50LCBjb21wbGV0aW9uQ2FsbGJhY2ssIG5hbWUpIHtcblx0XHR2YXIgY2FsbHMgPSAwO1xuXHRcdHZhciBjYWxsZWQgPSBmYWxzZTtcblxuXHRcdHRoaXMudGFza0NvbXBsZXRlID0gZnVuY3Rpb24oKSB7XG5cdFx0XHRpZiAoY2FsbHMgPT0gdGFza0NvdW50KSB7XG5cdFx0XHRcdHRocm93IFwiQWxsIFwiICsgY2FsbHMgKyBcIiB0YXNrcyBoYXZlIGFscmVhZHkgYmVlbiBjb21wbGV0ZWQgZm9yOiBcIiArIG5hbWU7XG5cdFx0XHR9XG5cdFx0XHRjYWxscysrO1xuXHRcdFx0Ly9sb2cobmFtZSArIFwiOiBcIiArIGNhbGxzKTtcblx0XHRcdGlmIChjYWxscyA9PSB0YXNrQ291bnQpIHtcblx0XHRcdFx0Y2FsbGVkID0gdHJ1ZTtcblx0XHRcdFx0Y29tcGxldGlvbkNhbGxiYWNrKCk7XG5cdFx0XHR9XG5cdFx0fTtcblxuXHRcdHRoaXMudmVyaWZ5ID0gZnVuY3Rpb24oKSB7XG5cdFx0XHRpZiAoY2FsbHMgPT0gdGFza0NvdW50ICYmICFjYWxsZWQpIHtcblx0XHRcdFx0Y29tcGxldGlvbkNhbGxiYWNrKCk7XG5cdFx0XHR9XG5cdFx0fTtcblx0fTtcblxuXHQvKipcblx0ICogVGhlIHJlc3VsdCBvZiByb2xsaW5nIGEgZGllXG5cdCAqL1xuXHRmdW5jdGlvbiBSb2xsUmVzdWx0KGkpIHtcblx0XHR0aGlzLmkgPSBpO1xuXHRcdHRoaXMudiA9IDA7XG5cdH1cblxuXHQvKipcblx0ICogVGhlIHJlc3VsdCBvZiByb2xsaW5nIGEgZ3JvdXBcblx0ICovXG5cdGZ1bmN0aW9uIEdyb3VwUmVzdWx0KHYpIHtcblx0XHR0aGlzLnYgPSB2O1xuXHR9XG5cblx0LyoqXG5cdCAqIFRoZSByZXN1bHQgb2YgYSBwYXJzZWQgcm9sbCBleHByZXNzaW9uIHRoYXQgaGFzIGFsc28gYmVlbiB2YWxpZGF0ZWRcblx0ICovXG5cdGZ1bmN0aW9uIFZhbGlkYXRlZFJvbGxFeHByZXNzaW9uKHJvbGxzLCByZXN1bHRUeXBlKSB7XG5cdFx0dGhpcy50eXBlID0gZDIwLmRpY2UuVFlQRV9WQUxJREFURURfUk9MTFM7XG5cdFx0dGhpcy5yb2xscyA9IHJvbGxzO1xuXHRcdHRoaXMucmVzdWx0VHlwZSA9IHJlc3VsdFR5cGU7XG5cdH07XG5cblx0LyoqXG5cdCAqIEJ1aWxkcyBhbiBldmFsJ2FibGUgZXhwcmVzc2lvbiBmcm9tIHRoZSByb2xsIHJlc3VsdHMuIEhhbmRsZXMgZ3JvdXBzIG9mIGV4cHJlc3Npb25zIGFuZFxuXHQgKiBncm91cHMgd2l0aCBubyBlbnRyaWVzIGFzIHdlbGwgYXMgc3VjY2Vzcy9mYWlsdXJlIGNvbXBhcmlzb25zLlxuXHQgKi9cblx0ZnVuY3Rpb24gRXhwcmVzc2lvbkJ1aWxkZXIoKSB7XG5cdFx0dmFyIGV4cHJlc3Npb24gPSBcIlwiO1xuXHRcdHZhciBncm91cE1lbWViZXJDb3VudCA9IHVuZGVmaW5lZDtcblx0XHR2YXIgcHJldlJlc3VsdHM7XG5cblx0XHR2YXIgdmVyaWZ5SW5Hcm91cCA9IGZ1bmN0aW9uKCkge1xuXHRcdFx0aWYgKGdyb3VwTWVtZWJlckNvdW50ID09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHR0aHJvdyBcIk5vdCBjdXJyZW50bHkgaW4gYSBncm91cCBleHByZXNzaW9uOiAnXCIgKyBleHByZXNzaW9uICsgXCInXCI7XG5cdFx0XHR9XG5cdFx0fTtcblxuXHRcdHRoaXMuYWRkTWF0aEV4cHIgPSBmdW5jdGlvbihleHByKSB7XG5cdFx0XHRleHByZXNzaW9uICs9IGV4cHI7XG5cdFx0fTtcblxuXHRcdHRoaXMuc3RhcnRHcm91cCA9IGZ1bmN0aW9uKCkge1xuXHRcdFx0ZXhwcmVzc2lvbiArPSBcIihcIjtcblx0XHRcdGdyb3VwTWVtZWJlckNvdW50ID0gMDtcblx0XHRcdHByZXZSZXN1bHRzID0gW107IC8vIEZPUiBNQVRDSCBUT1RBTCBST0xMUyBPTkxZXG5cdFx0fTtcblxuXHRcdHRoaXMuYWRkR3JvdXBWYWx1ZSA9IGZ1bmN0aW9uKHZhbHVlKSB7XG5cdFx0XHR2ZXJpZnlJbkdyb3VwKCk7XG5cdFx0XHRpZiAoZ3JvdXBNZW1lYmVyQ291bnQgPiAwKSB7XG5cdFx0XHRcdGV4cHJlc3Npb24gKz0gXCIrXCI7XG5cdFx0XHR9XG5cdFx0XHRleHByZXNzaW9uICs9IHZhbHVlO1xuXHRcdFx0Z3JvdXBNZW1lYmVyQ291bnQrKztcblx0XHR9O1xuXG5cdFx0dGhpcy5hZGRHcm91cFN1Y2Nlc3MgPSBmdW5jdGlvbih2YWx1ZSwgY3ApIHtcblx0XHRcdHRoaXMuYWRkR3JvdXBWYWx1ZShcIihcIiArIHZhbHVlICsgY3AuY29tcCArIGNwLnBvaW50ICsgXCI/MTowKVwiKTtcblx0XHR9O1xuXG5cdFx0dGhpcy5hZGRHcm91cEZhaWx1cmUgPSBmdW5jdGlvbih2YWx1ZSwgY3ApIHtcblx0XHRcdHRoaXMuYWRkR3JvdXBWYWx1ZShcIihcIiArIHZhbHVlICsgY3AuY29tcCArIGNwLnBvaW50ICsgXCI/LTE6MClcIik7XG5cdFx0fTtcblxuXHRcdHRoaXMuYWRkR3JvdXBNYXRjaCA9IGZ1bmN0aW9uKHZhbHVlLCBjcCkge1xuXHRcdFx0dmFyIGNvbXAgPSBjcC5jb21wID8gY3AuY29tcCA6IFwiPj1cIjtcblx0XHRcdHZhciBwb2ludCA9IGNwLnBvaW50ID8gY3AucG9pbnQgOiBcIjBcIjtcblx0XHRcdHByZXZSZXN1bHRzLnB1c2godmFsdWUpO1xuXHRcdFx0dmFyIG1hdGNoX29iaiA9IHt9O1xuXHRcdFx0Zm9yICh2YXIgaSA9IDA7IGkgPCBwcmV2UmVzdWx0cy5sZW5ndGg7IGkrKykge1xuXHRcdFx0XHR2YXIgbnVtID0gcHJldlJlc3VsdHNbaV07XG5cdFx0XHRcdG1hdGNoX29ialtudW1dID0gbWF0Y2hfb2JqW251bV0gPyBtYXRjaF9vYmpbbnVtXSArIDEgOiAxO1xuXHRcdFx0fVxuXHRcdFx0dmFyIG1hdGNoZXMgPSBtYXRjaF9vYmpbdmFsdWVdO1xuXHRcdFx0aWYobWF0Y2hlcyA9PT0gY3AudGhyZXNob2xkKSB7XG5cdFx0XHRcdHRoaXMuYWRkR3JvdXBWYWx1ZShcIihcIiArIHZhbHVlICsgY29tcCArIHBvaW50ICsgXCI/MTowKVwiKTtcblx0XHRcdH1cblx0XHR9O1xuXG5cdFx0dGhpcy5lbmRHcm91cCA9IGZ1bmN0aW9uKCkge1xuXHRcdFx0dmVyaWZ5SW5Hcm91cCgpO1xuXHRcdFx0aWYgKGdyb3VwTWVtZWJlckNvdW50ID09IDApIHtcblx0XHRcdFx0ZXhwcmVzc2lvbiArPSBcIjBcIjtcblx0XHRcdH1cblx0XHRcdGV4cHJlc3Npb24gKz0gXCIpXCI7XG5cdFx0XHRncm91cE1lbWViZXJDb3VudCA9IHVuZGVmaW5lZDtcblx0XHRcdHByZXZSZXN1bHRzID0gW107XG5cdFx0fTtcblxuXHRcdHRoaXMuZXZhbCA9IGZ1bmN0aW9uKCkge1xuXHRcdFx0bG9nKGV4cHJlc3Npb24pO1xuXHRcdFx0dmFyIHJlc3VsdDtcblx0XHRcdHZhciB0aGlzZXhwID0gZXhwcmVzc2lvbjtcblx0XHRcdChmdW5jdGlvbigpIHtcblxuXHRcdFx0XHRcInVzZSBzdHJpY3RcIjtcblxuXHRcdFx0XHR2YXIgZmxvb3IgPSBNYXRoLmZsb29yO1xuXHRcdFx0XHR2YXIgY2VpbCA9IE1hdGguY2VpbDtcblx0XHRcdFx0dmFyIHJvdW5kID0gTWF0aC5yb3VuZDtcblx0XHRcdFx0dmFyIG1heCA9IE1hdGgubWF4O1xuXHRcdFx0XHR2YXIgbWluID0gTWF0aC5taW47XG5cdFx0XHRcdHZhciBhYnMgPSBNYXRoLmFicztcblxuXHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdHJlc3VsdCA9IGV2YWwodGhpc2V4cCk7XG5cdFx0XHRcdH1cblx0XHRcdFx0Y2F0Y2ggKGUpIHtcblx0XHRcdFx0XHRyZXN1bHQgPSAwO1xuXHRcdFx0XHR9XG5cdFx0XHR9KSgpO1xuXHRcdFx0cmV0dXJuIHJlc3VsdDtcblx0XHR9O1xuXHR9O1xuXG5cdC8qKlxuXHQgKiBsb2cgYSBtZXNzYWdlLCBtaWdodCBiZSBkaXNhYmxlZCwgc2VlIGxvZ2VyciBmb3IgcGFyYW1ldGVyIGRldGFpbHMuXG5cdCAqL1xuXHR2YXIgbG9nID0gZnVuY3Rpb24obSkge1xuXHRcdHJldHVybjsgLy8gY29tbWVudCBvdXQgdGhpcyBsaW5lIHRvIGRpc2FibGUgbG9nZ2luZ1xuXHRcdGxvZ2VycihtKTtcblx0fTtcblxuXHQvKipcblx0ICogTG9nIGEgbWVzc2FnZSwgd2lsbCBuZXZlciBiZSBkaXNhYmxlZFxuXHQgKlxuXHQgKiBAcGFyYW0gbVxuXHQgKiAgICAgICAgICB0aGUgbWVzc2FnZSB0byBsb2csIGlmIG0gaXMgYSBmdW5jdGlvbiBpdCB3aWxsIGJlIGV2YWx1YXRlZCBiZWZvcmVcblx0ICogICAgICAgICAgbG9nZ2luZ1xuXHQgKi9cblx0dmFyIGxvZ2VyciA9IGZ1bmN0aW9uKG0pIHtcblx0XHRpZiAoXy5pc0Z1bmN0aW9uKG0pKSB7XG5cdFx0XHRtID0gbSgpO1xuXHRcdH1cblx0fTtcblxuXHR2YXIgZmFsbGJhY2tFcnJvckhhbmRsZXIgPSBmdW5jdGlvbihlKSB7XG5cdFx0bG9nZXJyKGUpO1xuXHRcdHRocm93IGU7XG5cdH07XG5cblx0LyoqXG5cdCAqIEZvcm1hdHMgYSBkaWNlUm9sbCBvYmplY3QgYmFjayBpbnRvIGEgcm9sbCBleHByZXNzaW9uXG5cdCAqL1xuXHR2YXIgZGljZVJvbGxUb1N0cmluZyA9IGZ1bmN0aW9uKHJvbGwpIHtcblx0XHR2YXIgcm9sbFN0ciA9IHJvbGwuZGljZSArIFwiZFwiICsgcm9sbC5zaWRlcztcblxuXHRcdGlmIChyb2xsLm1vZHMuY29tcG91bmRpbmcpIHtcblx0XHRcdHJvbGxTdHIgKz0gXCIhIVwiICsgY29tcGFyZVBvaW50VG9TdHJpbmcocm9sbC5tb2RzLmNvbXBvdW5kaW5nKTtcblx0XHR9XG5cdFx0aWYgKHJvbGwubW9kcy5wZW5ldHJhdGluZykge1xuXHRcdFx0cm9sbFN0ciArPSBcIiFwXCIgKyBjb21wYXJlUG9pbnRUb1N0cmluZyhyb2xsLm1vZHMucGVuZXRyYXRpbmcpO1xuXHRcdH1cblx0XHRpZiAocm9sbC5tb2RzLmV4cGxvZGluZykge1xuXHRcdFx0cm9sbFN0ciArPSBcIiFcIiArIGNvbXBhcmVQb2ludFRvU3RyaW5nKHJvbGwubW9kcy5leHBsb2RpbmcpO1xuXHRcdH1cblx0XHRpZiAocm9sbC5tb2RzLmtlZXApIHtcblx0XHRcdHJvbGxTdHIgKz0gXCJrXCI7XG5cdFx0XHRpZiAocm9sbC5tb2RzLmtlZXAuZW5kICE9IFwiaFwiKSB7XG5cdFx0XHRcdHJvbGxTdHIgKz0gcm9sbC5tb2RzLmtlZXAuZW5kO1xuXHRcdFx0fVxuXHRcdFx0cm9sbFN0ciArPSByb2xsLm1vZHMua2VlcC5jb3VudDtcblx0XHR9XG5cdFx0aWYgKHJvbGwubW9kcy5kcm9wKSB7XG5cdFx0XHRyb2xsU3RyICs9IFwia1wiO1xuXHRcdFx0aWYgKHJvbGwubW9kcy5kcm9wLmVuZCAhPSBcImxcIikge1xuXHRcdFx0XHRyb2xsU3RyICs9IHJvbGwubW9kcy5kcm9wLmVuZDtcblx0XHRcdH1cblx0XHRcdHJvbGxTdHIgKz0gcm9sbC5tb2RzLmRyb3AuY291bnQ7XG5cdFx0fVxuXHRcdGlmIChyb2xsLm1vZHMucmVyb2xsKSB7XG5cdFx0XHRyb2xsLm1vZHMucmVyb2xsLmZvckVhY2goZnVuY3Rpb24oY3ApIHtcblx0XHRcdFx0cm9sbFN0ciArPSBcInJcIiArIGNvbXBhcmVQb2ludFRvU3RyaW5nKGNwKTtcblx0XHRcdH0pO1xuXHRcdH1cblx0XHRpZiAocm9sbC5tb2RzLnNvcnQpIHtcblx0XHRcdHJvbGxTdHIgKz0gXCJzXCIgKyByb2xsLm1vZHMuc29ydC5vcmRlcjtcblx0XHR9XG5cdFx0aWYgKHJvbGwubW9kcy5zdWNjZXNzKSB7XG5cdFx0XHRyb2xsU3RyICs9IGNvbXBhcmVQb2ludFRvU3RyaW5nKHJvbGwubW9kcy5zdWNjZXNzLCB0cnVlKTtcblx0XHR9XG5cdFx0aWYgKHJvbGwubW9kcy5mYWlsdXJlKSB7XG5cdFx0XHRyb2xsU3RyICs9IFwiZlwiICsgY29tcGFyZVBvaW50VG9TdHJpbmcocm9sbC5tb2RzLmZhaWx1cmUsIHRydWUpO1xuXHRcdH1cblxuXHRcdHJldHVybiByb2xsU3RyO1xuXHR9O1xuXHR2YXIgY29tcGFyZVBvaW50VG9TdHJpbmcgPSBmdW5jdGlvbihjcCwgZXhwbGljaXRFcXVhbHMpIHtcblx0XHR2YXIgY3BTdHIgPSBcIlwiO1xuXHRcdGlmIChjcC5wb2ludCkge1xuXHRcdFx0aWYgKGNwLmNvbXAgIT0gXCI9PVwiIHx8IGV4cGxpY2l0RXF1YWxzKSB7XG5cdFx0XHRcdGNwU3RyICs9IGNwLmNvbXAuY2hhckF0KDApO1xuXHRcdFx0fVxuXHRcdFx0Y3BTdHIgKz0gY3AucG9pbnQ7XG5cdFx0fVxuXHRcdHJldHVybiBjcFN0cjtcblx0fTtcblxuXHQvKipcblx0ICogVmFsaWRhdGVzIHRoYXQgYWxsIG9mIHRoZSByb2xscyBpbiB0aGUgZXhwcmVzc2lvbiBoYXZlIHNhbmUgY29tYmluYXRpb25zIGFuZCBsaW1pdHMgaW4gcGxhY2Vcblx0ICpcblx0ICogQHJldHVybiBUaGUgbnVtYmVyIG9mIGFjdHVhbCByb2xscyBpbiB0aGUgYXJyYXkgb2YgZXhwcmVzc2lvbiBvYmplY3RzXG5cdCAqL1xuXHR2YXIgdmFsaWRhdGVQYXJzZVJlc3VsdCA9IGZ1bmN0aW9uKHJvbGxzKSB7XG5cdFx0dmFyIHJlc3VsdFR5cGUgPSB1bmRlZmluZWQ7XG5cblx0XHQvLyBQZXIgbGV2ZWwgdHJhY2sgc3VjY2Vzcy9zdW0gc3RhdGVcblx0XHRmb3IgKHZhciBpID0gMDsgaSA8IHJvbGxzLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRpZiAocm9sbHNbaV0udHlwZSA9PSBkMjAuZGljZS5UWVBFX1JPTExfRVhQUiB8fCByb2xsc1tpXS50eXBlID09IGQyMC5kaWNlLlRZUEVfR1JPVVBfRVhQUikge1xuXHRcdFx0XHR2YXIgcm9sbFR5cGUgPSBnZXRSb2xsVHlwZShyb2xsc1tpXSk7XG5cdFx0XHRcdGlmIChyZXN1bHRUeXBlID09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHRcdHJlc3VsdFR5cGUgPSByb2xsVHlwZTtcblx0XHRcdFx0fVxuXHRcdFx0XHRlbHNlIGlmIChyZXN1bHRUeXBlICE9IHJvbGxUeXBlKSB7XG5cdFx0XHRcdFx0dGhyb3cgXCJDYW5ub3QgbWl4IFwiICsgcmVzdWx0VHlwZSArIFwiIGFuZCBcIiArIHJvbGxUeXBlICsgXCIgcm9sbHMgaW4gYSBzaW5nbGUgcm9sbCBleHByZXNzaW9uXCI7XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0aWYgKHJvbGxzW2ldLnR5cGUgPT0gZDIwLmRpY2UuVFlQRV9ST0xMX0VYUFIpIHtcblx0XHRcdFx0Ly9TZXR1cCBzaWRlcyBmb3IgZmF0ZSByb2xsc1xuXHRcdFx0XHRpZiAocm9sbHNbaV0uZmF0ZSkge1xuXHRcdFx0XHRcdHJvbGxzW2ldLnNpZGVzID0gMztcblx0XHRcdFx0fVxuXHRcdFx0XHQvL1NldHVwIHNpZGVzIGZvciB0YWJsZSByb2xsc1xuXHRcdFx0XHRlbHNlIGlmIChyb2xsc1tpXS50YWJsZSAhPSB1bmRlZmluZWQpIHtcblx0XHRcdFx0XHRyb2xsc1tpXS5zaWRlcyA9IGQyMC5nZXRUYWJsZUVsZW1lbnRDb3VudChyb2xsc1tpXS50YWJsZSk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHQvLyBFbmZvcmNlIHRoYXQgZmF0ZSBkaWNlIGRvbid0IHN1cHBvcnQgY29tcG91bmRpbmdcblx0XHRcdFx0aWYgKHJvbGxzW2ldLmZhdGUgJiYgcm9sbHNbaV0ubW9kcy5jb21wb3VuZGluZyAhPSB1bmRlZmluZWQpIHtcblx0XHRcdFx0XHR0aHJvdyBcIkNvbXBvdW5kaW5nIEZBVEUgZGljZSBhcmUgbm90IGxlZ2FsLCB0cnkgISBpbnN0ZWFkIG9mICEhIGZvciBleHBsb2RpbmcgRkFURSBkaWNlXCI7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHQvL01ha2Ugc3VyZSB0aGF0IHdlIGRvbid0IHRyeSB0byBkbyBhbiBleHBsb2RpbmcgZDEgZGljZS4gL3NpZ2hcblx0XHRcdFx0aWYgKHJvbGxzW2ldLm1vZHMgJiYgcm9sbHNbaV0ubW9kcy5leHBsb2RpbmcgIT0gdW5kZWZpbmVkICYmIHJvbGxzW2ldLnNpZGVzIDwgMikge1xuXHRcdFx0XHRcdHRocm93IFwiWW91IG11c3Qgcm9sbCBhIGQyIG9yIGhpZ2hlciB0byByb2xsIGV4cGxvZGluZyBkaWNlLlwiO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0Ly8gQWRkIHNhbml0eSBib3VuZHMgY2hlY2tzXG5cdFx0XHRcdHJvbGxzW2ldLmRpY2UgPSBNYXRoLm1heChNYXRoLm1pbihyb2xsc1tpXS5kaWNlLCBNQVhfTlVNX1JPTExTKSwgMCk7XG5cdFx0XHRcdHJvbGxzW2ldLnNpZGVzID0gTWF0aC5tYXgoTWF0aC5taW4ocm9sbHNbaV0uc2lkZXMsIE1BWF9ST0xMKSwgMCk7XG5cdFx0XHR9XG5cblx0XHRcdGlmIChyb2xsc1tpXS50eXBlID09IGQyMC5kaWNlLlRZUEVfR1JPVVBfRVhQUikge1xuXG5cdFx0XHRcdC8vRm9yIGdyb3VwcyB3aXRoIG9uZSBzdWItcm9sbCBkb2lnbiBhIHN1Y2VzcyBjaGVjayB2ZXJpZnkgdGhhdCB0aGUgc3ViLXJvbGwgb25seSBjb250YWlucyBvbmUgcm9sbCBleHByZXNzaW9uIGFuZCBubyBncm91cCBleHByZXNzaW9uc1xuXHRcdFx0XHRpZiAocm9sbHNbaV0ucm9sbHMubGVuZ3RoID09IDEgJiYgcmVzdWx0VHlwZSA9PSBkMjAuZGljZS5ST0xMX1RZUEVfU1VDQ0VTUykge1xuXHRcdFx0XHRcdHZhciBmb3VuZFJvbGwgPSBmYWxzZTtcblx0XHRcdFx0XHRmb3IgKHZhciByID0gMDsgciA8IHJvbGxzW2ldLnJvbGxzWzBdLmxlbmd0aDsgcisrKSB7XG5cdFx0XHRcdFx0XHRpZiAocm9sbHNbaV0ucm9sbHNbMF1bcl0udHlwZSA9PSBkMjAuZGljZS5UWVBFX1JPTExfRVhQUikge1xuXHRcdFx0XHRcdFx0XHRpZiAoZm91bmRSb2xsKSB7XG5cdFx0XHRcdFx0XHRcdFx0dGhyb3cgXCJPbmx5IG9uZSByb2xsIGV4cHJlc3Npb24gaXMgYWxsb3dlZCBpbiBhIHNpbmdsZSBzdWItcm9sbCBleHByZXNzaW9uIHN1Y2Nlc3MgY2hlY2tcIjtcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRmb3VuZFJvbGwgPSB0cnVlO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0ZWxzZSBpZiAocm9sbHNbaV0ucm9sbHNbMF1bcl0udHlwZSA9PSBkMjAuZGljZS5UWVBFX0dST1VQX0VYUFIpIHtcblx0XHRcdFx0XHRcdFx0dGhyb3cgcm9sbHNbaV0ucm9sbHNbMF1bcl0udHlwZSArIFwiIGV4cHJlc3Npb24gaXMgbm90IHN1cHBvcnRlZCBpbiBhIHNpbmdsZSBzdWItcm9sbCBleHByZXNzaW9uIHN1Y2Nlc3MgY2hlY2tcIjtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblxuXHRcdFx0XHQvLyBSZWN1cnNlIG9uIGdyb3VwZWQgcm9sbHNcblx0XHRcdFx0dmFyIGdyb3VwUmVzdWx0VHlwZSA9IHVuZGVmaW5lZDtcblx0XHRcdFx0Zm9yICh2YXIgZyA9IDA7IGcgPCByb2xsc1tpXS5yb2xscy5sZW5ndGg7IGcrKykge1xuXHRcdFx0XHRcdHZhciBzdWJHcm91cFJlc3VsdFR5cGUgPSB2YWxpZGF0ZVBhcnNlUmVzdWx0KHJvbGxzW2ldLnJvbGxzW2ddKTtcblx0XHRcdFx0XHRpZiAoZ3JvdXBSZXN1bHRUeXBlID09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHRcdFx0Z3JvdXBSZXN1bHRUeXBlID0gc3ViR3JvdXBSZXN1bHRUeXBlO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRlbHNlIGlmIChncm91cFJlc3VsdFR5cGUgIT0gc3ViR3JvdXBSZXN1bHRUeXBlKSB7XG5cdFx0XHRcdFx0XHR0aHJvdyBcIkNhbm5vdCBtaXggXCIgKyBncm91cFJlc3VsdFR5cGUgKyBcIiBhbmQgXCIgKyBzdWJHcm91cFJlc3VsdFR5cGUgKyBcIiByb2xscyBpbiBhICByb2xsIGdyb3VwXCI7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHRcdHJvbGxzW2ldLnJlc3VsdFR5cGUgPSBncm91cFJlc3VsdFR5cGU7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0aWYgKHJlc3VsdFR5cGUgPT0gdW5kZWZpbmVkKSB7XG5cblx0XHRcdC8vTWF0aC1vbmx5IHJvbGxzLlxuXHRcdFx0aWYgKHJvbGxzWzBdLnR5cGUgPT09IGQyMC5kaWNlLlRZUEVfTUFUSF9FWFBSKSB7XG5cdFx0XHRcdHJldHVybiBkMjAuZGljZS5UWVBFX01BVEhfRVhQUjtcblx0XHRcdH1cblxuXHRcdFx0dGhyb3cgXCJDb3VsZCBub3QgZGV0ZXJtaW5lIHJlc3VsdCB0eXBlIG9mOiBcIiArIEpTT04uc3RyaW5naWZ5KHJvbGxzKTtcblx0XHR9XG5cdFx0cmV0dXJuIHJlc3VsdFR5cGU7XG5cdH07XG5cblx0dmFyIGdldFJvbGxUeXBlID0gZnVuY3Rpb24oZGljZVJvbGwpIHtcblx0XHRpZiAoZGljZVJvbGwubW9kcyAmJiBkaWNlUm9sbC5tb2RzLm1hdGNoICE9PSB1bmRlZmluZWQgJiYgZGljZVJvbGwubW9kcy5tYXRjaC50b3RhbCAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRyZXR1cm4gZDIwLmRpY2UuUk9MTF9UWVBFX01BVENIO1xuXHRcdH1cblx0XHRlbHNlIGlmIChkaWNlUm9sbC5tb2RzICYmIGRpY2VSb2xsLm1vZHMuc3VjY2VzcyAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRyZXR1cm4gZDIwLmRpY2UuUk9MTF9UWVBFX1NVQ0NFU1M7XG5cdFx0fVxuXHRcdGVsc2UgaWYgKGRpY2VSb2xsLnNpZGVzICE9IHVuZGVmaW5lZCAmJiBkaWNlUm9sbC5zaWRlcy50eXBlID09IGQyMC5kaWNlLlRZUEVfTEFCRUwpIHtcblx0XHRcdHJldHVybiBkMjAuZGljZS5ST0xMX1RZUEVfVEFCTEU7XG5cdFx0fVxuXHRcdGVsc2Uge1xuXHRcdFx0cmV0dXJuIGQyMC5kaWNlLlJPTExfVFlQRV9TVU07XG5cdFx0fVxuXHR9O1xuXG5cdC8qKlxuXHQgKiBQYXJzZSB0aGUgZGljZSBmb3JtdWxhIHN0cmluZyB1c2luZyB0aGUgZGljZSBncmFtbWFyIGFuZCB2YWxpZGF0ZVxuXHQgKiB0aGUgcmVzdWx0XG5cdCAqXG5cdCAqIEBwYXJhbSBmb3JtdWxhIFRoZSBwYXJzZWQgcm9sbCBvYmplY3QgbW9kZWxcblx0ICovXG5cdHZhciBwYXJzZVJvbGxTdHJpbmcgPSBmdW5jdGlvbihyb2xsU3RyaW5nKSB7XG5cdFx0bG9nKGZ1bmN0aW9uKCkgeyByZXR1cm4gXCJFIHBhcnNlUm9sbFN0cmluZzogXCIgKyByb2xsU3RyaW5nOyB9KTtcblxuXHRcdC8vIFVzZSBQYXJzZXIgR3JhbW1hciB0byBwYXJzZSB0aGUgcm9sbCBleHByZXNzaW9uXG5cdFx0dmFyIHJvbGxzID0gZDIwLkRpY2VQRUcucGFyc2Uocm9sbFN0cmluZyk7XG5cdFx0bG9nKHJvbGxzKTtcblxuXHRcdHZhciByZXN1bHRUeXBlID0gdmFsaWRhdGVQYXJzZVJlc3VsdChyb2xscyk7XG5cblx0XHR2YXIgdnJlID0gbmV3IFZhbGlkYXRlZFJvbGxFeHByZXNzaW9uKHJvbGxzLCByZXN1bHRUeXBlKTtcblx0XHRsb2codnJlKTtcblx0XHRsb2coSlNPTi5zdHJpbmdpZnkodnJlKSk7XG5cdFx0bG9nKGZ1bmN0aW9uKCkgeyByZXR1cm4gXCJMIHBhcnNlUm9sbFN0cmluZzogXCIgKyB2cmUucm9sbHMubGVuZ3RoICsgXCIgZXhwcmVzc2lvbnMgZnJvbTogXCIgKyByb2xsU3RyaW5nOyB9KTtcblxuXHRcdHJldHVybiB2cmU7XG5cdH07XG5cblx0LyoqXG5cdCAqIEluaXRpYXRlIGFsbCByb2xscyBpbiB0aGUgcGFyc2UgdHJlZVxuXHQgKlxuXHQgKiBAcGFyYW0gcm9sbHMgQW4gYXJyYXkgb2YgZXhwcmVzaW9uIG9iamVjdHNcblx0ICogQHBhcmFtIHJvbGwgcm9sbHNDb21wbGV0ZUNhbGxiYWNrIENhbGxiYWNrIHRvIGV4ZWN1dGUgd2hlbiBlYWNoIGVudHJ5IGluIHRoZSBhcnJheSBpcyBjb21wbGV0ZVxuXHQgKi9cblx0dmFyIGluaXRpYXRlUm9sbHMgPSBmdW5jdGlvbihyb2xscywgcmVzdWx0VHlwZSwgcm9sbHNDb21wbGV0ZUNhbGxiYWNrKSB7XG5cdFx0Zm9yICh2YXIgaSA9IDA7IGkgPCByb2xscy5sZW5ndGg7IGkrKykge1xuXHRcdFx0aWYgKHJvbGxzW2ldLnR5cGUgPT0gZDIwLmRpY2UuVFlQRV9ST0xMX0VYUFIpIHtcblx0XHRcdFx0ZG9Sb2xscyhyb2xsc1tpXSwgcm9sbHNDb21wbGV0ZUNhbGxiYWNrKTtcblx0XHRcdH1cblx0XHRcdGVsc2UgaWYgKHJvbGxzW2ldLnR5cGUgPT0gZDIwLmRpY2UuVFlQRV9HUk9VUF9FWFBSKSB7XG5cdFx0XHRcdGluaXRpYXRlR3JvdXBSb2xscyhyb2xsc1tpXSwgcmVzdWx0VHlwZSwgcm9sbHNDb21wbGV0ZUNhbGxiYWNrKTtcblx0XHRcdH1cblx0XHRcdGVsc2Uge1xuXHRcdFx0XHRyb2xsc0NvbXBsZXRlQ2FsbGJhY2soKTtcblx0XHRcdH1cblx0XHR9XG5cdH07XG5cdC8qKlxuXHQgKiBJbml0aWF0ZXMgcm9sbHMgZm9yIGEgZ3JvdXAsIG5lZWRlZCBzbyB0aGUgY29ycmVjdCBzY29waW5nIG9mIGdyb3VwQ29tcGxldGVDYWxsYmFja1xuXHQgKiBpcyB1c2VkLlxuXHQgKi9cblx0dmFyIGluaXRpYXRlR3JvdXBSb2xscyA9IGZ1bmN0aW9uKGdyb3VwUm9sbCwgcmVzdWx0VHlwZSwgcm9sbHNDb21wbGV0ZUNhbGxiYWNrKSB7XG5cdFx0dmFyIGdyb3VwQ29tcGxldGVDYWxsYmFjayA9IG5ldyBUYXNrQ29tcGxldGlvbkNhbGxiYWNrKGdyb3VwUm9sbC5yb2xscy5sZW5ndGgsIGZ1bmN0aW9uKCkge1xuXHRcdFx0cG9zdFByb2Nlc3NDb21wbGV0ZUdyb3VwKGdyb3VwUm9sbCwgcmVzdWx0VHlwZSk7XG5cdFx0XHRyb2xsc0NvbXBsZXRlQ2FsbGJhY2soKTtcblx0XHR9LCBcImdyb3VwQ29tcGxldGVDYWxsYmFja1wiKTtcblxuXHRcdGZvciAodmFyIGcgPSAwOyBnIDwgZ3JvdXBSb2xsLnJvbGxzLmxlbmd0aDsgZysrKSB7XG5cdFx0XHRpbml0aWF0ZVN1Ykdyb3VwUm9sbHMoZ3JvdXBSb2xsLnJvbGxzW2ddLCBncm91cFJvbGwucmVzdWx0VHlwZSwgZ3JvdXBDb21wbGV0ZUNhbGxiYWNrKTtcblx0XHR9XG5cdH07XG5cdC8qKlxuXHQgKiBJbml0aWF0ZXMgcm9sbHMgZm9yIGEgc3ViZ3JvdXAsIG5lZWRlZCBzbyB0aGUgY29ycmVjdCBzY29waW5nIG9mIHN1Ykdyb3VwQ29tcGxldGVDYWxsYmFja1xuXHQgKiBpcyB1c2VkLlxuXHQgKi9cblx0dmFyIGluaXRpYXRlU3ViR3JvdXBSb2xscyA9IGZ1bmN0aW9uKHN1Ykdyb3VwLCByZXN1bHRUeXBlLCBncm91cENvbXBsZXRlQ2FsbGJhY2spIHtcblx0XHR2YXIgc3ViR3JvdXBDb21wbGV0ZUNhbGxiYWNrID0gbmV3IFRhc2tDb21wbGV0aW9uQ2FsbGJhY2soc3ViR3JvdXAubGVuZ3RoLCBmdW5jdGlvbigpIHtcblx0XHRcdGdyb3VwQ29tcGxldGVDYWxsYmFjay50YXNrQ29tcGxldGUoKTtcblx0XHR9LCBcInN1Ykdyb3VwQ29tcGxldGVDYWxsYmFja1wiKTtcblxuXHRcdGluaXRpYXRlUm9sbHMoc3ViR3JvdXAsIHJlc3VsdFR5cGUsIGZ1bmN0aW9uKCkge1xuXHRcdFx0c3ViR3JvdXBDb21wbGV0ZUNhbGxiYWNrLnRhc2tDb21wbGV0ZSgpO1xuXHRcdH0pO1xuXHR9O1xuXG5cdC8qKlxuXHQgKiBGaXJlIG9mZiBlYWNoIHJvbGwgcmVxdWlyZWQgZm9yIHRoZSBkaWNlUm9sbCB1c2luZyBhc3luY1JhbmQuXG5cdCAqL1xuXHR2YXIgZG9Sb2xscyA9IGZ1bmN0aW9uKGRpY2VSb2xsLCByb2xsc0NvbXBsZXRlQ2FsbGJhY2spIHtcblx0XHRsb2coZnVuY3Rpb24oKSB7IHJldHVybiBkaWNlUm9sbFRvU3RyaW5nKGRpY2VSb2xsKSArIFwiXFx0IC0gRSBkb1JvbGxzXCI7IH0pO1xuXG5cdFx0Ly8gQWRkIGFycmF5cyB0byB0cmFjayByb2xscyB0byBkaWNlUm9sbFxuXHRcdGRpY2VSb2xsLnJlc3VsdHMgPSBbXTtcblxuXHRcdC8vIFNldHVwIHRoZSBjYWxsYmFjayB0cmFja2VyIGZvciBzaWduYWxpbmcgd2hlbiBlYWNoIHJvbGwgaXMgY29tcGxldGVcblx0XHR2YXIgdGFza0NhbGxiYWNrID0gbmV3IFRhc2tDb21wbGV0aW9uQ2FsbGJhY2soZGljZVJvbGwuZGljZSwgZnVuY3Rpb24oKSB7XG5cdFx0XHRkaWNlUm9sbENvbXBsZXRlQ2FsbGJhY2soZGljZVJvbGwpO1xuXHRcdFx0cm9sbHNDb21wbGV0ZUNhbGxiYWNrKCk7XG5cdFx0fSwgXCJyb2xsQ29tcGxldGVDYWxsYmFja1wiKTtcblxuXHRcdHZhciByb2xsQ29tcGxldGVDYWxsYmFjayA9IGZ1bmN0aW9uKCkge1xuXHRcdFx0dGFza0NhbGxiYWNrLnRhc2tDb21wbGV0ZSgpO1xuXHRcdH07XG5cblx0XHQvLyBFeGVjdXRlIGVhY2ggcm9sbCBmb3IgdGhlIGRpY2Vcblx0XHRmb3IgKHZhciByID0gMDsgciA8IGRpY2VSb2xsLmRpY2U7IHIrKykge1xuXHRcdFx0cm9sbERpZShyLCBkaWNlUm9sbCwgcm9sbENvbXBsZXRlQ2FsbGJhY2spO1xuXHRcdH1cblxuXHRcdC8vSGFuZGxpbmcgZm9yIHRoZSBjYXNlIHdoZXJlIGRpY2VSb2xsLmRpY2UgPT0gMCwgZW5zdXJlcyB0aGUgY2FsbGJhY2sgaXMgZXhlY3V0ZWQgbm8gbWF0dGVyIHdoYXRcblx0XHR0YXNrQ2FsbGJhY2sudmVyaWZ5KCk7XG5cblx0XHRsb2coZnVuY3Rpb24oKSB7IHJldHVybiBkaWNlUm9sbFRvU3RyaW5nKGRpY2VSb2xsKSArIFwiXFx0IC0gTCBkb1JvbGxzXCI7IH0pO1xuXHR9O1xuXG5cdC8qKlxuXHQgKiBQcm9jZXNzZXMgbW9kaWZpZXJzIG9uIHRoZSBhIHNpbmdsZSBkaWNlIHJvbGwgdGhhdCBhcmUgYXBwbGllZCBhZnRlciBhbGwgZGljZSB3aXRoaW5cblx0ICogdGhlIHJvbGwgaGF2ZSBjb21wbGV0ZWQuIFRoaXMgaW5jbHVkZXMga2VlcCwgZHJvcCwgYW5kIHNvcnQuXG5cdCAqL1xuXHR2YXIgZGljZVJvbGxDb21wbGV0ZUNhbGxiYWNrID0gZnVuY3Rpb24oZGljZVJvbGwpIHtcblx0XHRsb2coZnVuY3Rpb24oKSB7IHJldHVybiBkaWNlUm9sbFRvU3RyaW5nKGRpY2VSb2xsKSArIFwiXFx0IC0gRSBkaWNlUm9sbENvbXBsZXRlQ2FsbGJhY2tcIjsgfSk7XG5cblx0XHQvL0ZpcnN0IG9yZGVyIHJvbGxzIGJ5IGluZGV4IGFuZCB0aGUgZHJvcCBmbGFnIHRvIGhhdmUgYW4gaW50dWl0aXZlIFwibmF0dXJhbFwiIG9yZGVyaW5nIG9mIGRpY2Vcblx0XHRkaWNlUm9sbC5yZXN1bHRzLnNvcnQoZnVuY3Rpb24oYSwgYikge1xuXHRcdFx0dmFyIGQgPSAoYS5pIC0gYi5pKTtcblx0XHRcdGlmIChkICE9IDAgfHwgYS5kID09IGIuZCkge1xuXHRcdFx0XHRyZXR1cm4gZDtcblx0XHRcdH1cblx0XHRcdGlmIChhLmQpIHtcblx0XHRcdFx0cmV0dXJuIC0xO1xuXHRcdFx0fVxuXHRcdFx0cmV0dXJuIDE7XG5cdFx0fSk7XG5cblx0XHQvL0NsZWFuIHVwIGRhdGEgbW9kZWwgYnkgcmVtb3Zpbmcgcm9sbCBpbmRleCwgaXQgaXNuJ3QgbmVlZGVkIGFmdGVyIHRoaXMgcG9pbnQgKHJpZ2h0Pylcblx0XHRkaWNlUm9sbC5yZXN1bHRzLmZvckVhY2goZnVuY3Rpb24ocikge1xuXHRcdFx0ZGVsZXRlIHIuaTtcblx0XHR9KTtcblxuXHRcdGlmIChkaWNlUm9sbC5tb2RzICYmIGRpY2VSb2xsLm1vZHMua2VlcCAhPSB1bmRlZmluZWQpIHtcblx0XHRcdHZhciBvcmRlciA9IChkaWNlUm9sbC5tb2RzLmtlZXAuZW5kID09IFwibFwiID8gXCJhXCIgOiBcImRcIik7XG5cdFx0XHR2YXIgc29ydGVkUmVzdWx0cyA9IHNvcnRSb2xscyhkaWNlUm9sbC5yZXN1bHRzLCBvcmRlcik7XG5cblx0XHRcdGtlZXBSb2xscyhzb3J0ZWRSZXN1bHRzLCBkaWNlUm9sbC5tb2RzLmtlZXAuY291bnQpO1xuXHRcdH1cblx0XHRpZiAoZGljZVJvbGwubW9kcyAmJiBkaWNlUm9sbC5tb2RzLmRyb3AgIT0gdW5kZWZpbmVkKSB7XG5cdFx0XHR2YXIgb3JkZXIgPSAoZGljZVJvbGwubW9kcy5kcm9wLmVuZCA9PSBcImxcIiA/IFwiYVwiIDogXCJkXCIpO1xuXHRcdFx0dmFyIHNvcnRlZFJlc3VsdHMgPSBzb3J0Um9sbHMoZGljZVJvbGwucmVzdWx0cywgb3JkZXIpO1xuXG5cdFx0XHRkcm9wUm9sbHMoc29ydGVkUmVzdWx0cywgZGljZVJvbGwubW9kcy5kcm9wLmNvdW50KTtcblx0XHR9XG5cdFx0aWYgKGRpY2VSb2xsLm1vZHMgJiYgZGljZVJvbGwubW9kcy5zb3J0ICE9IHVuZGVmaW5lZCkge1xuXHRcdFx0ZGljZVJvbGwucmVzdWx0cyA9IHNvcnRSb2xscyhkaWNlUm9sbC5yZXN1bHRzLCBkaWNlUm9sbC5tb2RzLnNvcnQub3JkZXIpO1xuXHRcdH1cblxuXHRcdGxvZyhmdW5jdGlvbigpIHsgcmV0dXJuIGRpY2VSb2xsVG9TdHJpbmcoZGljZVJvbGwpICsgXCJcXHQgLSBMIGRpY2VSb2xsQ29tcGxldGVDYWxsYmFja1wiOyB9KTtcblx0fTtcblxuXHQvKipcblx0ICogUHJvY2VzcyBtb2RpZmllcnMgb24gYSBncm91cCBvZiByb2xscyB0aGF0IGFyZSBhcHBsaWVkIGFmdGVyIGFsbCBvZiB0aGUgZ3JvdXAgZXhwcmVzc2lvbnNcblx0ICogd2l0aGluIHRoZSBncm91cC5cblx0ICovXG5cdHZhciBwb3N0UHJvY2Vzc0NvbXBsZXRlR3JvdXAgPSBmdW5jdGlvbihncm91cFJvbGwsIHJlc3VsdFR5cGUpIHtcblx0XHRsb2coZnVuY3Rpb24oKSB7IHJldHVybiBcIkUgcG9zdFByb2Nlc3NDb21wbGV0ZUdyb3VwKFwiICsgcmVzdWx0VHlwZSArIFwiKVwiOyB9KTtcblxuXHRcdGlmIChncm91cFJvbGwubW9kcyAmJiBncm91cFJvbGwubW9kcy5rZWVwICE9IHVuZGVmaW5lZCAmJiBncm91cFJvbGwucm9sbHMubGVuZ3RoID09IDEpIHtcblx0XHRcdC8vYXBwbHkga2VlcCB0byB0aGUgdG90YWwgc2V0IG9mIHJvbGxzIHdpdGhpbiB0aGUgZ3JvdXBcblx0XHRcdHZhciBvcmRlciA9IChncm91cFJvbGwubW9kcy5rZWVwLmVuZCA9PSBcImxcIiA/IFwiYVwiIDogXCJkXCIpO1xuXG5cdFx0XHR2YXIgYWxsUm9sbHMgPSBidWlsZFN1Ykdyb3VwUm9sbHNBcnJheShncm91cFJvbGwucm9sbHNbMF0pO1xuXG5cdFx0XHRhbGxSb2xscyA9IHNvcnRSb2xscyhhbGxSb2xscywgb3JkZXIpO1xuXHRcdFx0a2VlcFJvbGxzKGFsbFJvbGxzLCBncm91cFJvbGwubW9kcy5rZWVwLmNvdW50KTtcblxuXHRcdFx0Y2xlYW51cFN1Ykdyb3VwVmFsdWVzKGdyb3VwUm9sbC5yb2xsc1swXSk7XG5cdFx0fVxuXHRcdGlmIChncm91cFJvbGwubW9kcyAmJiBncm91cFJvbGwubW9kcy5kcm9wICE9IHVuZGVmaW5lZCAmJiBncm91cFJvbGwucm9sbHMubGVuZ3RoID09IDEpIHtcblx0XHRcdC8vYXBwbHkgZHJvcCB0byB0aGUgdG90YWwgc2V0IG9mIHJvbGxzIHdpdGhpbiB0aGUgZ3JvdXBcblx0XHRcdHZhciBvcmRlciA9IChncm91cFJvbGwubW9kcy5kcm9wLmVuZCA9PSBcImxcIiA/IFwiYVwiIDogXCJkXCIpO1xuXG5cdFx0XHR2YXIgYWxsUm9sbHMgPSBidWlsZFN1Ykdyb3VwUm9sbHNBcnJheShncm91cFJvbGwucm9sbHNbMF0pO1xuXG5cdFx0XHRhbGxSb2xscyA9IHNvcnRSb2xscyhhbGxSb2xscywgb3JkZXIpO1xuXHRcdFx0ZHJvcFJvbGxzKGFsbFJvbGxzLCBncm91cFJvbGwubW9kcy5kcm9wLmNvdW50KTtcblxuXHRcdFx0Y2xlYW51cFN1Ykdyb3VwVmFsdWVzKGdyb3VwUm9sbC5yb2xsc1swXSk7XG5cdFx0fVxuXG5cdFx0Ly9Ub3RhbCB0aGluZ3MgdXAgZm9yIHRoZSBncm91cCwgbmVlZGVkIGZvciBzdWJncm91cCBrZWVwL2Ryb3Bcblx0XHR0b3RhbFJlc3VsdChncm91cFJvbGwsIHJlc3VsdFR5cGUpO1xuXG5cdFx0aWYgKGdyb3VwUm9sbC5tb2RzICYmIGdyb3VwUm9sbC5tb2RzLmtlZXAgIT0gdW5kZWZpbmVkICYmIGdyb3VwUm9sbC5yb2xscy5sZW5ndGggPiAxKSB7XG5cdFx0XHQvL2FwcGx5IGtlZXAgdG8gdGhlIHN1Ymdyb3VwIHJlc3VsdHNcblx0XHRcdHZhciBvcmRlciA9IChncm91cFJvbGwubW9kcy5rZWVwLmVuZCA9PSBcImxcIiA/IFwiYVwiIDogXCJkXCIpO1xuXHRcdFx0dmFyIGdyb3VwUmVzdWx0cyA9IHNvcnRSb2xscyhncm91cFJvbGwucmVzdWx0cywgb3JkZXIpO1xuXHRcdFx0a2VlcFJvbGxzKGdyb3VwUmVzdWx0cywgZ3JvdXBSb2xsLm1vZHMua2VlcC5jb3VudCk7XG5cdFx0fVxuXHRcdGlmIChncm91cFJvbGwubW9kcyAmJiBncm91cFJvbGwubW9kcy5kcm9wICE9IHVuZGVmaW5lZCAmJiBncm91cFJvbGwucm9sbHMubGVuZ3RoID4gMSkge1xuXHRcdFx0Ly9hcHBseSBkcm9wIHRvIHRoZSBzdWJncm91cCByZXN1bHRzXG5cdFx0XHR2YXIgb3JkZXIgPSAoZ3JvdXBSb2xsLm1vZHMuZHJvcC5lbmQgPT0gXCJsXCIgPyBcImFcIiA6IFwiZFwiKTtcblx0XHRcdHZhciBncm91cFJlc3VsdHMgPSBzb3J0Um9sbHMoZ3JvdXBSb2xsLnJlc3VsdHMsIG9yZGVyKTtcblx0XHRcdGRyb3BSb2xscyhncm91cFJlc3VsdHMsIGdyb3VwUm9sbC5tb2RzLmRyb3AuY291bnQpO1xuXHRcdH1cblxuXHRcdGxvZyhmdW5jdGlvbigpIHsgcmV0dXJuIFwiTCBwb3N0UHJvY2Vzc0NvbXBsZXRlR3JvdXBcIjsgfSk7XG5cdH07XG5cblx0dmFyIGJ1aWxkU3ViR3JvdXBSb2xsc0FycmF5ID0gZnVuY3Rpb24oc3ViR3JvdXBzKSB7XG5cdFx0dmFyIGFsbFJvbGxzID0gW107XG5cdFx0Zm9yICh2YXIgZyA9IDA7IGcgPCBzdWJHcm91cHMubGVuZ3RoOyBnKyspIHtcblx0XHRcdGlmIChzdWJHcm91cHNbZ10udHlwZSA9PSBkMjAuZGljZS5UWVBFX1JPTExfRVhQUikge1xuXHRcdFx0XHRhbGxSb2xscyA9IGFsbFJvbGxzLmNvbmNhdChzdWJHcm91cHNbZ10ucmVzdWx0cyk7XG5cdFx0XHR9XG5cdFx0XHRlbHNlIGlmIChzdWJHcm91cHNbZ10udHlwZSA9PSBkMjAuZGljZS5UWVBFX0dST1VQX0VYUFIpIHtcblx0XHRcdFx0c3ViR3JvdXBzW2ddLnYgPSB0b3RhbFJlc3VsdChzdWJHcm91cHNbZ10sIHN1Ykdyb3Vwc1tnXS5yZXN1bHRUeXBlKS5ldmFsKCk7XG5cdFx0XHRcdGFsbFJvbGxzLnB1c2goc3ViR3JvdXBzW2ddKTtcblx0XHRcdH1cblx0XHR9XG5cdFx0cmV0dXJuIGFsbFJvbGxzO1xuXHR9O1xuXG5cdHZhciBjbGVhbnVwU3ViR3JvdXBWYWx1ZXMgPSBmdW5jdGlvbihzdWJHcm91cHMpIHtcblx0XHRzdWJHcm91cHMuZm9yRWFjaChmdW5jdGlvbihlKSB7XG5cdFx0XHRpZiAoZS50eXBlID09IGQyMC5kaWNlLlRZUEVfR1JPVVBfRVhQUikge1xuXHRcdFx0XHRkZWxldGUgZS52O1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9O1xuXG5cdC8qKlxuXHQgKiBLZWVwcyB0aGUgZmlyc3QgY291bnQgcm9sbHMgdGhhdCBhcmUgbm90IGFscmVhZHkgbWFya2VkIGFzIGRyb3BwZWQgaXRlcmF0aW5nIHRocm91Z2hcblx0ICogdGhlIGFycmF5IGZyb20gMCB0byBOLiBBZnRlciB0aGUgY291bnQgcm9sbHMgYXJlIGtlcHQgdGhlIHJlbWFpbmluZyByb2xscyBhcmUgbWFya2VkXG5cdCAqIGFzIGRyb3BwZWQuXG5cdCAqXG5cdCAqIEBwYXJhbSByb2xscyBzb3J0ZWQgYXJyYXkgb2Ygcm9sbHNcblx0ICogQHBhcmFtIGNvdW50IG51bWJlciBvZiByb2xscyB0byBrZWVwXG5cdCAqL1xuXHR2YXIga2VlcFJvbGxzID0gZnVuY3Rpb24ocm9sbHMsIGNvdW50KSB7XG5cdFx0dmFyIGtlcHQgPSAwO1xuXHRcdGZvciAodmFyIGkgPSAwOyBpIDwgcm9sbHMubGVuZ3RoOyBpKyspIHtcblx0XHRcdGlmICghcm9sbHNbaV0uZCkge1xuXHRcdFx0XHRpZiAoa2VwdCA8IGNvdW50KSB7XG5cdFx0XHRcdFx0a2VwdCsrO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGVsc2Uge1xuXHRcdFx0XHRcdHJvbGxzW2ldLmQgPSB0cnVlO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXHR9O1xuXG5cdC8qKlxuXHQgKiBEcm9wcyB0aGUgZmlyc3QgY291bnQgcm9sbHMgdGhhdCBhcmUgbm90IGFscmVhZHkgbWFya2VkIGFzIGRyb3BwZWQgaXRlcmF0aW5nIHRocm91Z2hcblx0ICogdGhlIGFycmF5IGZyb20gMCB0byBOLiBBZnRlciB0aGUgY291bnQgcm9sbHMgYXJlIG1hcmtlZCBhcyBkcm9wcGVkIHRoZSBtZXRob2QgcmV0dXJuc1xuXHQgKlxuXHQgKiBAcGFyYW0gcm9sbHMgc29ydGVkIGFycmF5IG9mIHJvbGxzXG5cdCAqIEBwYXJhbSBjb3VudCBudW1iZXIgb2Ygcm9sbHMgdG8gZHJvcFxuXHQgKi9cblx0dmFyIGRyb3BSb2xscyA9IGZ1bmN0aW9uKHJvbGxzLCBjb3VudCkge1xuXHRcdHZhciBkcm9wcGVkID0gMDtcblx0XHRmb3IgKHZhciBpID0gMDsgaSA8IHJvbGxzLmxlbmd0aCAmJiBkcm9wcGVkIDwgY291bnQ7IGkrKykge1xuXHRcdFx0aWYgKCFyb2xsc1tpXS5kKSB7XG5cdFx0XHRcdHJvbGxzW2ldLmQgPSB0cnVlO1xuXHRcdFx0XHRkcm9wcGVkKys7XG5cdFx0XHR9XG5cdFx0fVxuXHR9O1xuXG5cdC8qKlxuXHQgKiBSZXR1cm4gYSBvZiB0aGUgcm9sbHMgYXJyYXkgc29ydGVkIGluIHRoZSBzcGVjaWZpZWQgb3JkZXJcblx0ICovXG5cdHZhciBzb3J0Um9sbHMgPSBmdW5jdGlvbihyb2xscywgb3JkZXIpIHtcblx0XHR2YXIgb3JkZXJNb2QgPSAob3JkZXIgPT0gXCJkXCIgPyAtMSA6IDEpO1xuXHRcdHJldHVybiByb2xscy5zbGljZSgwKS5zb3J0KGZ1bmN0aW9uKGEsIGIpIHtcblx0XHRcdHJldHVybiAoYS52IC0gYi52KSAqIG9yZGVyTW9kO1xuXHRcdH0pO1xuXHR9O1xuXG5cdC8qKlxuXHQgKiBBIHNpbXBsZSByYW5kb20gbnVtYmVyIGdlbmVyYXRvciwgYnV0IHdlIGZvcmNlIGl0IHRvIGJlIGFzeW5jaHJvbm91cyBzbyB3ZVxuXHQgKiBjYW4gbWFrZSBzdXJlIHRoYXQgb3VyIGRpY2UgZW5naW5lIGNhbiBzdXBwb3J0IGFuIGFzeW5jaCBnZW5lcmF0b3IuIFRoaXNcblx0ICogd2F5IHdlIGNhbiBzdWJzdGl0dXRlIGluIHNvbWV0aGluZyBsaWtlIDNEIERpY2Ugcm9sbGluZyBvciBzZXJ2ZXItc2lkZVxuXHQgKiBcInJlYWxcIiByYW5kb20gbnVtYmVycyBsYXRlciBvbi5cblx0ICpcblx0ICogQHBhcmFtIHNpZGVzXG5cdCAqICAgICAgICAgIG1heGltdW0gaW50ZWdlciB0byByb2xsLCByZXR1cm5lZCB2YWx1ZSB3aWxsIGJlIGJldHdlZW4gMSBhbmRcblx0ICogICAgICAgICAgbWF4Um9sbCBpbmNsdXNpdmVcblx0ICogQHBhcmFtIHJhbmRDYWxsYmFja1xuXHQgKiAgICAgICAgICBmdW5jdGlvbiBjYWxsZWQgd2hlbiB0aGUgcmFuZG9tIG51bWJlciBpcyBnZW5lcmF0ZWQsIHRoZSByYW5kb21cblx0ICogICAgICAgICAgbnVtYmVyIGlzIHByb3ZpZGVkIGFzIHRoZSBvbmx5IGFyZ3VtZW50XG5cdCAqL1xuXHR2YXIgYXN5bmNSYW5kID0gZnVuY3Rpb24oc2lkZXMsIHJhbmRDYWxsYmFjaywgbm8zZCwgcm9sbGlkKSB7XG5cdFx0aWYgKHNpZGVzID09PSAwKSB7XG5cdFx0XHRzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRyYW5kQ2FsbGJhY2soMCk7XG5cdFx0XHR9LCAwKTtcblx0XHR9XG5cblx0XHQvL1dlIG5vIGxvbmdlciBkbyBsb2NhbCAzRCByb2xscy5cblxuXHRcdGVsc2UgaWYgKHNpZGVzID09PSA2ICYmIGQyMC50ZXh0Y2hhdCAmJiBkMjAudGV4dGNoYXQuZWdnX2NsaWNraG9sZSAmJiAhJChcIiNsaWdodGx5LW92ZXJsYXlcIikuaXMoXCI6dmlzaWJsZVwiKSkge1xuXHRcdFx0dmFyIHBvc3NpYmlsaXRpZXMgPSBbXG5cdFx0XHRcdFtcIjI5OTBcIiwgMSwgNF0sXG5cdFx0XHRcdFtcIjI5OTFcIiwgMSwgN10sXG5cdFx0XHRcdFtcIjI5OTJcIiwgMSwgMTJdLFxuXHRcdFx0XHRbXCIyOTkzXCIsIDIsIDddLFxuXHRcdFx0XHRbXCIyOTk0XCIsIDIsIDVdLFxuXHRcdFx0XHRbXCIyOTk1XCIsIDIsIDM4XSxcblx0XHRcdFx0W1wiMjk5NlwiLCAyLCAxMV0sXG5cdFx0XHRcdFtcIjI5OTdcIiwgMywgMTNdLFxuXHRcdFx0XHRbXCIyOTk4XCIsIDMsIDE2XSxcblx0XHRcdFx0W1wiMjk5OVwiLCAzLCA2XSxcblx0XHRcdFx0W1wiMzAwMFwiLCAzLCAxNl0sXG5cdFx0XHRcdFtcIjMwMDFcIiwgNCwgMTddLFxuXHRcdFx0XHRbXCIzMDAyXCIsIDQsIDE4XSxcblx0XHRcdFx0W1wiMzAwM1wiLCA0LCAxNl0sXG5cdFx0XHRcdFtcIjMwMDRcIiwgNSwgN10sXG5cdFx0XHRcdFtcIjMwMDZcIiwgNSwgMjRdLFxuXHRcdFx0XHRbXCIzMDA1XCIsIDUsIDE0XSxcblx0XHRcdFx0W1wiMzAwN1wiLCA1LCAyN10sXG5cdFx0XHRcdFtcIjMwMDhcIiwgNiwgN10sXG5cdFx0XHRcdFtcIjMwMDlcIiwgNiwgNl0sXG5cdFx0XHRcdFtcIjMwMTBcIiwgNiwgNV0sXG5cdFx0XHRcdFtcIjMwMTJcIiwgNiwgMTBdXG5cdFx0XHRdO1xuXG5cdFx0XHR2YXIgY2hvc2VuID0gcG9zc2liaWxpdGllc1tvdGhpcy5yYW5kb20ocG9zc2liaWxpdGllcy5sZW5ndGgpXTtcblxuXHRcdFx0ZDIwLnRleHRjaGF0LnNlbmRTaG91dCh7XG5cdFx0XHRcdHR5cGU6IFwicGxheWNsaWNraG9sZVwiLFxuXHRcdFx0XHRwbGF5ZXJpZDogd2luZG93LmN1cnJlbnRQbGF5ZXIuaWQsXG5cdFx0XHRcdGNvbnRlbnQ6IGNob3Nlbixcblx0XHRcdFx0dGltZTogbmV3IERhdGUoKS5nZXRUaW1lKClcblx0XHRcdH0pO1xuXG5cdFx0XHRpZiAod2luZG93LmZha2VMaWdodGx5KSB7XG5cdFx0XHRcdHdpbmRvdy5mYWtlTGlnaHRseShcImh0dHA6Ly92LnRoZW9uaW9uLmNvbS9vbmlvbnN0dWRpb3MvdmlkZW8vXCIgKyBjaG9zZW5bMF0gKyBcIi82NDAubXA0XCIpO1xuXHRcdFx0fVxuXG5cdFx0XHRzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRyYW5kQ2FsbGJhY2soY2hvc2VuWzFdKTtcblx0XHRcdFx0JChcIiNsaWdodGx5LW92ZXJsYXlcIikuaGlkZSgpO1xuXHRcdFx0fSwgKGNob3NlblsyXSAqIDEwMDApICsgMjAwMCk7XG5cblx0XHR9XG5cdFx0ZWxzZSB7XG5cdFx0XHRzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRyYW5kQ2FsbGJhY2sob3RoaXMucmFuZG9tKHNpZGVzKSArIDEpO1xuXHRcdFx0fSwgMCk7XG5cdFx0fVxuXHR9O1xuXG5cdC8qKlxuXHQgKiBDb21wYXJlIGEgdmFsdWUgdG8gYSBDb21wYXJlUG9pbnQsIGlmIGRlZmF1bHRQb2ludCBpcyBzcGVjaWZpZWQgYW5kIG5vXG5cdCAqIENvbXBhcmVQb2ludCBvcGVyYXRvciBleGlzdHMgdGhlIGNvbXBhcmlzb24gd2lsbCBiZSBkb25lIGFzXG5cdCAqIFwidmFsdWUgPT0gZGVmYXVsdFBvaW50XCJcblx0ICovXG5cdHZhciBjb21wYXJlVG9Qb2ludCA9IGZ1bmN0aW9uKHZhbHVlLCBjcCwgZGVmYXVsdFBvaW50KSB7XG5cdFx0aWYgKGNwLmNvbXAgIT0gdW5kZWZpbmVkKSB7XG5cdFx0XHR2YXIgY3BGb3JtdWxhID0gdmFsdWUgKyBjcC5jb21wICsgY3AucG9pbnQ7XG5cdFx0XHR2YXIgY3BSZXN1bHQgPSBldmFsKGNwRm9ybXVsYSk7XG5cdFx0XHRyZXR1cm4gY3BSZXN1bHQ7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHZhbHVlID09IGRlZmF1bHRQb2ludDtcblx0fTtcblxuXHQvKipcblx0ICogQ3JlYXRlcyBhIG5ldyBSb2xsUmVzdWx0LCBwdXNoZXMgaXQgb250byB0aGUgcmVzdWx0cyBhcnJheSBmb3IgdGhlIGRpY2VSb2xsXG5cdCAqIGFuZCB0cmlnZ2VycyBhc3luY1JhbmQgd2l0aCBhIGNhbGxiYWNrIHRvIGluZGl2aWR1YWxSb2xsQ2FsbGJhY2tcblx0ICpcblx0ICogQHBhcmFtIGRpY2VSb2xsIFRoZSByb2xsIGV4cHJlc3Npb24gYmVpbmcgZXhlY3V0ZWRcblx0ICogQHBhcmFtIHJvbGxDb21wbGV0ZUNhbGxiYWNrIFRoZSBjYWxsYmFjayB0byBleGVjdXRlIHdoZW4gdGhlIHJhbmRvbSBudW1iZXIgaXMgZ2VuZXJhdGVkXG5cdCAqIEBwYXJhbSByb2xsTW9kaWZpZXJGdW5jdGlvbiBBbiBvcHRpb25hbCBtb2RpZmllciBmdW5jdGlvbiB0aGF0IGNhbiBjaGFuZ2UgdGhlIHJhbmRvbSBudW1iZXIgYmVmb3JlIGl0IGlzIHBhc3NlZCB0byByb2xsQ29tcGxldGVDYWxsYmFja1xuXHQgKi9cblx0dmFyIHJvbGxEaWUgPSBmdW5jdGlvbihyb2xsSW5kZXgsIGRpY2VSb2xsLCByb2xsQ29tcGxldGVDYWxsYmFjaywgZXh0cmFSb2xsQ291bnRlcikge1xuXHRcdC8vUm9sbCBhbiBhZGRpdGlvbmFsIGRpZVxuXHRcdHZhciByb2xsUmVzdWx0ID0gbmV3IFJvbGxSZXN1bHQocm9sbEluZGV4KTtcblx0XHRkaWNlUm9sbC5yZXN1bHRzLnB1c2gocm9sbFJlc3VsdCk7XG5cblx0XHQvL0hhdmUgdG8gZG8gYW5vbiBmdW5jdGlvbiBjYWxsIHRvIHNvIHRoZSBjb3JyZWN0IHJvbGxSZXN1bHQgcmVmZXJlbmNlIGlzIHBhc3NlZCB0byB0aGUgaW5kaXZpZHVhbFJvbGxDYWxsYmFja1xuXHRcdChmdW5jdGlvbihycikge1xuXHRcdFx0YXN5bmNSYW5kKGRpY2VSb2xsLnNpZGVzLCBmdW5jdGlvbihyYW5kKSB7XG5cdFx0XHRcdGluZGl2aWR1YWxSb2xsQ2FsbGJhY2soZGljZVJvbGwsIHJyLCByYW5kLCByb2xsQ29tcGxldGVDYWxsYmFjaywgZXh0cmFSb2xsQ291bnRlcik7XG5cdFx0XHR9LCAoZGljZVJvbGwudGFibGUgIT09IHVuZGVmaW5lZCksIGRpY2VSb2xsLnJvbGxpZCk7XG5cdFx0fShyb2xsUmVzdWx0KSk7XG5cdH07XG5cblx0LyoqXG5cdCAqIENhbGxlZCBieSBhc3luY1JhbmQgZm9yIGVhY2ggbmV3IHJhbmRvbSByb2xsLCBoYW5kbGVzIGxvZ2ljIGFyb3VuZCBpbW1lZGlhdGVseSBuZWVkZWQgYWRkaXRpb25hbCByb2xsc1xuXHQgKiBmb3IgZXhwbG9kaW5nLCBjb21wb3VuZGluZywgcGVuZXRyYXRpbmcsIGFuZCByZXJvbGwgbW9kaWZpZXJzXG5cdCAqL1xuXHR2YXIgaW5kaXZpZHVhbFJvbGxDYWxsYmFjayA9IGZ1bmN0aW9uKGRpY2VSb2xsLCByb2xsUmVzdWx0LCByYW5kLCByb2xsQ29tcGxldGVDYWxsYmFjaywgZXh0cmFSb2xsQ291bnRlcikge1xuXHRcdGV4dHJhUm9sbENvdW50ZXIgPSAoZXh0cmFSb2xsQ291bnRlciB8fCAwKTtcblx0XHRsb2coZnVuY3Rpb24oKSB7IHJldHVybiBkaWNlUm9sbFRvU3RyaW5nKGRpY2VSb2xsKSArIFwiXFx0IC0gRSBpbmRpdmlkdWFsUm9sbENhbGxiYWNrKFwiICsgZXh0cmFSb2xsQ291bnRlciArIFwiKSBcIiArIHJhbmQ7IH0pO1xuXG5cdFx0Ly9TYXZlIHRoZSByb2xsIHZhbHVlLCBhZGRpdGlvbiBpcyB1c2VkIHRvIGhhbmRsZSBtb2RpZmllcnMgbGlrZSBjb21wb3VuZGluZyB0aGF0IHVzZSB0aGUgc2FtZVxuXHRcdC8vcm9sbFJlc3VsdCBmb3IgbXVsdGlwbGUgcm9sbHNcblx0XHQvL2lmKGRpY2VSb2xsLm1vZHMgPT09IHVuZGVmaW5lZCkgZGljZVJvbGwubW9kcyA9IHt9O1xuXG5cdFx0Ly9JZiB0aGlzIGlzIGEgcm9sbGFibGUgdGFibGUgcm9sbCwgZ2V0IHRoZSB2YWx1ZSBmb3IgdGhhdCB0YWJsZSBpbmRleC5cblx0XHRpZiAoZGljZVJvbGwudGFibGUgIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0cm9sbFJlc3VsdC50YWJsZWlkeCA9IHJhbmQgLSAxO1xuXHRcdFx0cm9sbFJlc3VsdC52ICs9IGQyMC5nZXRUYWJsZUVsZW1lbnRWYWx1ZShkaWNlUm9sbC50YWJsZSwgcm9sbFJlc3VsdC50YWJsZWlkeCk7XG5cdFx0fVxuXHRcdGVsc2Uge1xuXHRcdFx0cm9sbFJlc3VsdC52ICs9IHJhbmQ7XG5cdFx0fVxuXG5cdFx0Ly9PZmZzZXQgRkFURSByb2xsc1xuXHRcdGlmIChkaWNlUm9sbC5mYXRlKSB7XG5cdFx0XHRyb2xsUmVzdWx0LnYgLT0gMjtcblx0XHR9XG5cblx0XHQvL1JlZHVjZSByb2xsIGJ5IDEgZm9yIGV2ZXJ5IGV4dHJhIHBlbmV0cmF0aW5nIHJvbGxcblx0XHRpZiAoZGljZVJvbGwubW9kcyAmJiBkaWNlUm9sbC5tb2RzLnBlbmV0cmF0aW5nICE9IHVuZGVmaW5lZCAmJiBleHRyYVJvbGxDb3VudGVyID4gMCkge1xuXHRcdFx0cm9sbFJlc3VsdC52IC09IDE7XG5cdFx0fVxuXG5cdFx0Ly9NYWtlIHN1cmUgd2UgaGF2ZW4ndCBleHBsb2RlZC9jb21wb3VuZGVkL3BlbmV0cmF0ZWQvcmVyb2xsZWQgdG9vIG1hbnkgdGltZXNcblx0XHRpZiAoZXh0cmFSb2xsQ291bnRlciA+IE1BWF9OVU1fUk9MTFMpIHtcblx0XHRcdHJvbGxDb21wbGV0ZUNhbGxiYWNrKCk7XG5cdFx0fVxuXHRcdGVsc2UgaWYgKGRpY2VSb2xsLm1vZHMgJiYgZGljZVJvbGwubW9kcy5leHBsb2RpbmcgIT0gdW5kZWZpbmVkICYmIGNvbXBhcmVUb1BvaW50KHJhbmQsIGRpY2VSb2xsLm1vZHMuZXhwbG9kaW5nLCBkaWNlUm9sbC5zaWRlcykpIHtcblx0XHRcdC8vRXhwbG9kZWQgLSBSb2xsIGFuIGFkZGl0aW9uYWwgZGllXG5cdFx0XHRyb2xsRGllKHJvbGxSZXN1bHQuaSwgZGljZVJvbGwsIHJvbGxDb21wbGV0ZUNhbGxiYWNrLCBleHRyYVJvbGxDb3VudGVyICsgMSk7XG5cdFx0fVxuXHRcdGVsc2UgaWYgKGRpY2VSb2xsLm1vZHMgJiYgZGljZVJvbGwubW9kcy5jb21wb3VuZGluZyAhPSB1bmRlZmluZWQgJiYgY29tcGFyZVRvUG9pbnQocmFuZCwgZGljZVJvbGwubW9kcy5jb21wb3VuZGluZywgZGljZVJvbGwuc2lkZXMpKSB7XG5cdFx0XHQvL0NvbXBvdW5kaW5nIC0gUm9sbCBhbm90aGVyIGRpZSBidXQgdXNlIHRoZSBzYW1lIHJvbGxSZXN1bHRcblx0XHRcdGFzeW5jUmFuZChkaWNlUm9sbC5zaWRlcywgZnVuY3Rpb24ocmFuZCkge1xuXHRcdFx0XHRpbmRpdmlkdWFsUm9sbENhbGxiYWNrKGRpY2VSb2xsLCByb2xsUmVzdWx0LCByYW5kLCByb2xsQ29tcGxldGVDYWxsYmFjaywgZXh0cmFSb2xsQ291bnRlciArIDEpO1xuXHRcdFx0fSwgKGRpY2VSb2xsLnRhYmxlICE9PSB1bmRlZmluZWQpLCBkaWNlUm9sbC5yb2xsaWQpO1xuXHRcdH1cblx0XHRlbHNlIGlmIChkaWNlUm9sbC5tb2RzICYmIGRpY2VSb2xsLm1vZHMucGVuZXRyYXRpbmcgIT0gdW5kZWZpbmVkICYmIGNvbXBhcmVUb1BvaW50KHJhbmQsIGRpY2VSb2xsLm1vZHMucGVuZXRyYXRpbmcsIGRpY2VSb2xsLnNpZGVzKSkge1xuXHRcdFx0Ly9FeHBsb2RlZCAtIFJvbGwgYW4gYWRkaXRpb25hbCBkaWVcblx0XHRcdHJvbGxEaWUocm9sbFJlc3VsdC5pLCBkaWNlUm9sbCwgcm9sbENvbXBsZXRlQ2FsbGJhY2ssIGV4dHJhUm9sbENvdW50ZXIgKyAxKTtcblx0XHR9XG5cdFx0ZWxzZSBpZiAoZGljZVJvbGwubW9kcyAmJiBkaWNlUm9sbC5tb2RzLnJlcm9sbCAhPSB1bmRlZmluZWQpIHtcblx0XHRcdHZhciByZXJvbGxlZCA9IGRpY2VSb2xsLm1vZHMucmVyb2xsLnNvbWUoZnVuY3Rpb24ocmVyb2xsKSB7XG5cblx0XHRcdFx0aWYgKHJlcm9sbC5tYXhyZXJvbGxzKSB7XG5cdFx0XHRcdFx0dmFyIG51bXJvbGxzZm9yaW5kZXggPSAwO1xuXHRcdFx0XHRcdGZvciAodmFyIGpqID0gMDsgamogPCBkaWNlUm9sbC5yZXN1bHRzLmxlbmd0aDsgamorKykge1xuXHRcdFx0XHRcdFx0aWYgKGRpY2VSb2xsLnJlc3VsdHNbampdLmkgPT09IHJvbGxSZXN1bHQuaSAmJiBkaWNlUm9sbC5yZXN1bHRzW2pqXS5kID09PSB0cnVlKSBudW1yb2xsc2ZvcmluZGV4Kys7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cblx0XHRcdFx0aWYgKGNvbXBhcmVUb1BvaW50KHJhbmQsIHJlcm9sbCwgMSkpIHtcblxuXHRcdFx0XHRcdGlmIChyZXJvbGwubWF4cmVyb2xscyAmJiBudW1yb2xsc2ZvcmluZGV4ID49IHJlcm9sbC5tYXhyZXJvbGxzKSB7XG5cdFx0XHRcdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0Ly9Ob3RlIHRoYXQgd2Vcblx0XHRcdFx0XHQvL3Jlcm9sbGVkID0gdHJ1ZTtcblx0XHRcdFx0XHRyb2xsUmVzdWx0LmQgPSB0cnVlO1xuXG5cdFx0XHRcdFx0Ly9SZVJvbGxlZCAtIFJvbGwgYW4gYWRkaXRpb25hbCBkaWUgdG8gcmVwbGFjZSB0aGUgb25lIHRoYXQgd2FzIGRyb3BwZWRcblx0XHRcdFx0XHRyb2xsRGllKHJvbGxSZXN1bHQuaSwgZGljZVJvbGwsIHJvbGxDb21wbGV0ZUNhbGxiYWNrLCBleHRyYVJvbGxDb3VudGVyICsgMSk7XG5cblx0XHRcdFx0XHQvL0EgdHJ1ZSByZXR1cm4gc3RvcHMgaXRlcmF0aW9uXG5cdFx0XHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0XHR9KTtcblxuXHRcdFx0Ly9JZiBub3RoaW5nIHdhcyByZXJvbGxlZCB0aGlzIGRpZSByb2xsIGlzIGNvbXBsZXRlXG5cdFx0XHRpZiAoIXJlcm9sbGVkKSB7XG5cdFx0XHRcdHJvbGxDb21wbGV0ZUNhbGxiYWNrKCk7XG5cdFx0XHR9XG5cdFx0fVxuXHRcdGVsc2Uge1xuXHRcdFx0Ly9ObyBhZGRpdGlvbmFsIHJvbGwgbW9kaWZpZXIsIHNpZ25hbCB0aGUgZGllIHJvbGwgaXMgY29tcGxldGVcblx0XHRcdHJvbGxDb21wbGV0ZUNhbGxiYWNrKCk7XG5cdFx0fVxuXG5cdFx0bG9nKGZ1bmN0aW9uKCkgeyByZXR1cm4gZGljZVJvbGxUb1N0cmluZyhkaWNlUm9sbCkgKyBcIlxcdCAtIEwgaW5kaXZpZHVhbFJvbGxDYWxsYmFjayhcIiArIGV4dHJhUm9sbENvdW50ZXIgKyBcIikgXCIgKyByYW5kOyB9KTtcblx0fTtcblxuXHQvKipcblx0ICogQXBwbHkgYWxsIG9mIHRoZSBwb3N0LXJvbGwgbW9kaWZpZXJzIGFuZCBwZXJmb3JtIHRvdGFsc1xuXHQgKi9cblx0dmFyIHBvc3RQcm9jZXNzQ29tcGxldGVSb2xscyA9IGZ1bmN0aW9uKHJvbGxzLCByZXN1bHRUeXBlLCByZXByb2Nlc3MpIHtcblx0XHRsb2coZnVuY3Rpb24oKSB7IHJldHVybiBcIkUgcG9zdFByb2Nlc3NDb21wbGV0ZVJvbGxzXCI7IH0pO1xuXG5cdFx0aWYgKHJvbGxzLnR5cGUgPT0gZDIwLmRpY2UuVFlQRV9WQUxJREFURURfUk9MTFMpIHtcblx0XHRcdC8vIFNwZWNpYWwgaGFuZGxpbmcgZm9yIHRoZSBvdXRlciB2YWxpZGF0ZWQgcm9sbHMgZGF0YVxuXHRcdFx0dmFyIHRvdGFsID0gcG9zdFByb2Nlc3NDb21wbGV0ZVJvbGxzKHJvbGxzLnJvbGxzLCByb2xscy5yZXN1bHRUeXBlKTtcblx0XHRcdHJvbGxzLnRvdGFsID0gdG90YWw7XG5cdFx0XHRyZXR1cm4gdG90YWw7XG5cdFx0fVxuXG5cdFx0dmFyIHJlc3VsdCA9IHRvdGFsUmVzdWx0cyhyb2xscywgcmVzdWx0VHlwZSwgcmVwcm9jZXNzKTtcblxuXHRcdGxvZyhmdW5jdGlvbigpIHsgcmV0dXJuIFwiTCBwb3N0UHJvY2Vzc0NvbXBsZXRlUm9sbHMgLSBcIiArIHJlc3VsdDsgfSk7XG5cdFx0cmV0dXJuIHJlc3VsdDtcblx0fTtcblxuXHR2YXIgdG90YWxSZXN1bHRzID0gZnVuY3Rpb24ocm9sbHMsIHJlc3VsdFR5cGUsIHJlcHJvY2VzcywgZXhwcmVzc2lvbikge1xuXHRcdHZhciBleHByZXNzaW9uID0gZXhwcmVzc2lvbiB8fCBuZXcgRXhwcmVzc2lvbkJ1aWxkZXIoKTtcblx0XHR2YXIgZXhwcmVzc2lvbiA9IG5ldyBFeHByZXNzaW9uQnVpbGRlcigpO1xuXHRcdGZvciAodmFyIHIgPSAwOyByIDwgcm9sbHMubGVuZ3RoOyByKyspIHtcblx0XHRcdHRvdGFsUmVzdWx0KHJvbGxzW3JdLCByZXN1bHRUeXBlLCByZXByb2Nlc3MsIGV4cHJlc3Npb24pO1xuXHRcdH1cblx0XHRyZXR1cm4gZXhwcmVzc2lvbi5ldmFsKCk7XG5cdH07XG5cblx0dmFyIHRvdGFsUmVzdWx0ID0gZnVuY3Rpb24ocm9sbCwgcmVzdWx0VHlwZSwgcmVwcm9jZXNzLCBleHByZXNzaW9uKSB7XG5cdFx0dmFyIGV4cHJlc3Npb24gPSBleHByZXNzaW9uIHx8IG5ldyBFeHByZXNzaW9uQnVpbGRlcigpO1xuXHRcdGlmIChyb2xsLnR5cGUgPT0gZDIwLmRpY2UuVFlQRV9ST0xMX0VYUFIpIHtcblx0XHRcdGV4cHJlc3Npb24uc3RhcnRHcm91cCgpO1xuXHRcdFx0Zm9yICh2YXIgZCA9IDA7IGQgPCByb2xsLnJlc3VsdHMubGVuZ3RoOyBkKyspIHtcblx0XHRcdFx0aWYgKCFyb2xsLnJlc3VsdHNbZF0uZCkge1xuXHRcdFx0XHRcdGFkZFJlc3VsdFZhbHVlKGV4cHJlc3Npb24sIHJlc3VsdFR5cGUsIHJvbGwucmVzdWx0c1tkXS52LCByb2xsKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdFx0ZXhwcmVzc2lvbi5lbmRHcm91cCgpO1xuXHRcdFx0Ly8gSWYgd2UndmUgZ290IGEgbWF0Y2ggbW9kIGNyZWF0ZSBhIFwibWF0Y2hlc1wiIHByb3BlcnR5IHdpdGggYSByYW5kb20gY29sb3IgYXNzaWduZWQgdG8gdGhlIHZhbHVlIGlmIHRoZSBudW1iZXIgb2YgbWF0Y2hlcyBtZWV0cyB0aHJlc2hvbGQgYW5kIGNvbXBhcmlzb24vcG9pbnRcblx0XHRcdGlmKHJvbGwubW9kcy5tYXRjaCkge1xuXHRcdFx0XHR2YXIgdmFsX2FycmF5ID0gW107XG5cdFx0XHRcdHZhciBtYXRjaF9vYmogPSB7fTtcblx0XHRcdFx0Xy5lYWNoKHJvbGwucmVzdWx0cywgZnVuY3Rpb24ocikge1xuXHRcdFx0XHRcdHZhbF9hcnJheS5wdXNoKHJbXCJ2XCJdKTtcblx0XHRcdFx0fSk7XG5cdFx0XHRcdHZhciBjb3VudF9vYmogPSB2YWxfYXJyYXkucmVkdWNlKGZ1bmN0aW9uKGNvdW50TWFwLCB2YWx1ZSkge2NvdW50TWFwW3ZhbHVlXSA9ICsrY291bnRNYXBbdmFsdWVdIHx8IDE7cmV0dXJuIGNvdW50TWFwfSwge30pO1xuXHRcdFx0XHR2YXIgY3VyX2NvdW50ID0gMDtcblx0XHRcdFx0Zm9yKHZhciBrIGluIGNvdW50X29iaikge1xuXHRcdFx0XHRcdGlmKGNvdW50X29ialtrXSA+PSByb2xsLm1vZHMubWF0Y2gudGhyZXNob2xkKSB7XG5cdFx0XHRcdFx0XHRpZighcm9sbC5tb2RzLm1hdGNoLmNvbXAgfHwgIXJvbGwubW9kcy5tYXRjaC5wb2ludCB8fCAocm9sbC5tb2RzLm1hdGNoLmNvbXAgPT09IFwiPj1cIiAmJiBrID49IHJvbGwubW9kcy5tYXRjaC5wb2ludCkgfHwgKHJvbGwubW9kcy5tYXRjaC5jb21wID09PSBcIjw9XCIgJiYgayA8PSByb2xsLm1vZHMubWF0Y2gucG9pbnQpIHx8IChyb2xsLm1vZHMubWF0Y2guY29tcCA9PT0gXCI9PVwiICYmIGsgPT0gcm9sbC5tb2RzLm1hdGNoLnBvaW50KSkge1xuXHRcdFx0XHRcdFx0XHRpZihjdXJfY291bnQgPT0gOCkge2N1cl9jb3VudCA9IDB9O1xuXHRcdFx0XHRcdFx0XHRtYXRjaF9vYmpba10gPSBkMjAuZGljZS5NQVRDSF9DT0xPUlNbY3VyX2NvdW50XTtcblx0XHRcdFx0XHRcdFx0Y3VyX2NvdW50Kys7XG5cdFx0XHRcdFx0XHR9O1xuXHRcdFx0XHRcdH07XG5cdFx0XHRcdH1cblx0XHRcdFx0cm9sbC5tb2RzLm1hdGNoW1wibWF0Y2hlc1wiXSA9IG1hdGNoX29iajtcblx0XHRcdH1cblx0XHR9XG5cdFx0ZWxzZSBpZiAocm9sbC50eXBlID09IGQyMC5kaWNlLlRZUEVfTUFUSF9FWFBSKSB7XG5cdFx0XHRleHByZXNzaW9uLmFkZE1hdGhFeHByKHJvbGwuZXhwcik7XG5cdFx0fVxuXHRcdGVsc2UgaWYgKHJvbGwudHlwZSA9PSBkMjAuZGljZS5UWVBFX0dST1VQX0VYUFIpIHtcblx0XHRcdGV4cHJlc3Npb24uc3RhcnRHcm91cCgpO1xuXHRcdFx0aWYgKCFyb2xsLmQpIHtcblx0XHRcdFx0aWYgKHJvbGwucmVzdWx0cyA9PSB1bmRlZmluZWQgfHwgcmVwcm9jZXNzKSB7XG5cdFx0XHRcdFx0cm9sbC5yZXN1bHRzID0gW107XG5cblx0XHRcdFx0XHQvL0ZvciBncm91cHMgd2l0aCAxIHN1Yi1yb2xsIHRoYXQgYXJlIGhhdmUgYSBzdWNjZXNzIHJvbGxUeXBlIHVzZSBzcGVjaWFsIHRvIHRvdGFsIGVhY2ggcm9sbFxuXHRcdFx0XHRcdGlmIChyb2xsLnJvbGxzLmxlbmd0aCA9PSAxICYmIHJlc3VsdFR5cGUgPT0gZDIwLmRpY2UuUk9MTF9UWVBFX1NVQ0NFU1MpIHtcblxuXHRcdFx0XHRcdFx0Ly9GaXJzdCBzdGVwIGlzIHRvIGJ1aWxkIHVwIHRoZSBtYXRoIGV4cHJlc3Npb25zIHRvIHVzZSBiZWZvcmUgYW5kIGFmdGVyIGVhY2ggcm9sbCByZXN1bHRcblx0XHRcdFx0XHRcdHZhciBtYXRoUHJlZml4ID0gXCJcIjtcblx0XHRcdFx0XHRcdHZhciByb2xsRXhwcmVzc2lvbiA9IHVuZGVmaW5lZDtcblx0XHRcdFx0XHRcdHZhciBtYXRoU3VmZml4ID0gXCJcIjtcblx0XHRcdFx0XHRcdGZvciAodmFyIHIgPSAwOyByIDwgcm9sbC5yb2xsc1swXS5sZW5ndGg7IHIrKykge1xuXHRcdFx0XHRcdFx0XHRpZiAocm9sbC5yb2xsc1swXVtyXS50eXBlID09IGQyMC5kaWNlLlRZUEVfUk9MTF9FWFBSKSB7XG5cdFx0XHRcdFx0XHRcdFx0aWYgKHJvbGxFeHByZXNzaW9uICE9IHVuZGVmaW5lZCkge1xuXHRcdFx0XHRcdFx0XHRcdFx0dGhyb3cgXCJPbmx5IG9uZSByb2xsIGV4cHJlc3Npb24gaXMgYWxsb3dlZCBpbiBhIHNpbmdsZSBzdWItcm9sbCBleHByZXNzaW9uIHN1Y2Nlc3MgY2hlY2tcIjtcblx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdFx0cm9sbEV4cHJlc3Npb24gPSByb2xsLnJvbGxzWzBdW3JdO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdGVsc2UgaWYgKHJvbGwucm9sbHNbMF1bcl0udHlwZSA9PSBkMjAuZGljZS5UWVBFX01BVEhfRVhQUikge1xuXHRcdFx0XHRcdFx0XHRcdGlmIChyb2xsRXhwcmVzc2lvbiA9PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0XHRcdFx0XHRcdG1hdGhQcmVmaXggKz0gcm9sbC5yb2xsc1swXVtyXS5leHByO1xuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHRlbHNlIHtcblx0XHRcdFx0XHRcdFx0XHRcdG1hdGhTdWZmaXggKz0gcm9sbC5yb2xsc1swXVtyXS5leHByO1xuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRlbHNlIGlmIChyb2xsLnJvbGxzWzBdW3JdLnR5cGUgPT0gZDIwLmRpY2UuVFlQRV9HUk9VUF9FWFBSKSB7XG5cdFx0XHRcdFx0XHRcdFx0dGhyb3cgcm9sbC5yb2xsc1swXVtyXS50eXBlICsgXCIgZXhwcmVzc2lvbiBpcyBub3Qgc3VwcG9ydGVkIGluIGEgc2luZ2xlIHN1Yi1yb2xsIGV4cHJlc3Npb24gc3VjY2VzcyBjaGVja1wiO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdC8vU2Vjb25kIHN0ZXAgaXMgdG8gZXZhbHVhdGUgZWFjaCByb2xsIHdpdGggdGhlIG1hdGggZXhwcmVzc2lvbnMgYW5kIHN0b3JlIHRoZSByZXN1bHQgaW4gdGhlIGdyb3VwJ3MgcmVzdWx0c1xuXHRcdFx0XHRcdFx0Zm9yICh2YXIgciA9IDA7IHIgPCByb2xsRXhwcmVzc2lvbi5yZXN1bHRzLmxlbmd0aDsgcisrKSB7XG5cdFx0XHRcdFx0XHRcdGlmICghcm9sbEV4cHJlc3Npb24ucmVzdWx0c1tyXS5kKSB7XG5cdFx0XHRcdFx0XHRcdFx0dmFyIHJFeHAgPSBuZXcgRXhwcmVzc2lvbkJ1aWxkZXIoKTtcblx0XHRcdFx0XHRcdFx0XHRyRXhwLnN0YXJ0R3JvdXAoKTtcblx0XHRcdFx0XHRcdFx0XHRyRXhwLmFkZE1hdGhFeHByKG1hdGhQcmVmaXgpO1xuXHRcdFx0XHRcdFx0XHRcdHJFeHAuYWRkR3JvdXBWYWx1ZShyb2xsRXhwcmVzc2lvbi5yZXN1bHRzW3JdLnYpO1xuXHRcdFx0XHRcdFx0XHRcdHJFeHAuYWRkTWF0aEV4cHIobWF0aFN1ZmZpeCk7XG5cdFx0XHRcdFx0XHRcdFx0ckV4cC5lbmRHcm91cCgpO1xuXG5cdFx0XHRcdFx0XHRcdFx0cm9sbC5yZXN1bHRzLnB1c2gobmV3IEdyb3VwUmVzdWx0KHJFeHAuZXZhbCgpKSk7XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZSB7XG5cdFx0XHRcdFx0XHRmb3IgKHZhciBnID0gMDsgZyA8IHJvbGwucm9sbHMubGVuZ3RoOyBnKyspIHtcblx0XHRcdFx0XHRcdFx0dmFyIGdyb3VwVG90YWwgPSB0b3RhbFJlc3VsdHMocm9sbC5yb2xsc1tnXSwgcm9sbC5yZXN1bHRUeXBlLCByZXByb2Nlc3MpO1xuXHRcdFx0XHRcdFx0XHRyb2xsLnJlc3VsdHMucHVzaChuZXcgR3JvdXBSZXN1bHQoZ3JvdXBUb3RhbCkpO1xuXG5cdFx0XHRcdFx0XHRcdGFkZFJlc3VsdFZhbHVlKGV4cHJlc3Npb24sIHJlc3VsdFR5cGUsIGdyb3VwVG90YWwsIHJvbGwpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0XHRlbHNlIHtcblx0XHRcdFx0XHRyb2xsLnJlc3VsdHMuZm9yRWFjaChmdW5jdGlvbihyKSB7XG5cdFx0XHRcdFx0XHRpZiAoIXIuZCkge1xuXHRcdFx0XHRcdFx0XHRhZGRSZXN1bHRWYWx1ZShleHByZXNzaW9uLCByZXN1bHRUeXBlLCByLnYsIHJvbGwpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0XHRleHByZXNzaW9uLmVuZEdyb3VwKCk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGV4cHJlc3Npb247XG5cdH07XG5cblx0dmFyIGFkZFJlc3VsdFZhbHVlID0gZnVuY3Rpb24oZXhwcmVzc2lvbiwgcmVzdWx0VHlwZSwgdmFsdWUsIHJvbGwpIHtcblx0XHRpZiAocmVzdWx0VHlwZSA9PSBkMjAuZGljZS5ST0xMX1RZUEVfU1VNKSB7XG5cdFx0XHRleHByZXNzaW9uLmFkZEdyb3VwVmFsdWUodmFsdWUpO1xuXHRcdH1cblx0XHRlbHNlIGlmIChyZXN1bHRUeXBlID09IGQyMC5kaWNlLlJPTExfVFlQRV9TVUNDRVNTKSB7XG5cdFx0XHRleHByZXNzaW9uLmFkZEdyb3VwU3VjY2Vzcyh2YWx1ZSwgcm9sbC5tb2RzLnN1Y2Nlc3MpO1xuXHRcdFx0aWYgKHJvbGwubW9kcyAmJiByb2xsLm1vZHMuZmFpbHVyZSAhPSB1bmRlZmluZWQpIHtcblx0XHRcdFx0ZXhwcmVzc2lvbi5hZGRHcm91cEZhaWx1cmUodmFsdWUsIHJvbGwubW9kcy5mYWlsdXJlKTtcblx0XHRcdH1cblx0XHR9XG5cdFx0ZWxzZSBpZiAocmVzdWx0VHlwZSA9PSBkMjAuZGljZS5ST0xMX1RZUEVfTUFUQ0gpIHtcblx0XHRcdGV4cHJlc3Npb24uYWRkR3JvdXBNYXRjaCh2YWx1ZSwgcm9sbC5tb2RzLm1hdGNoKTtcblx0XHR9XG5cdFx0ZWxzZSB7XG5cdFx0XHR0aHJvdyBcIlVuc3VwcG9ydGVkIHJlc3VsdFR5cGU6IFwiICsgcmVzdWx0VHlwZTtcblx0XHR9XG5cdH07XG5cblx0LyoqXG5cdCAqIHJlcHJvY2VzcyBhbiBhbHJlYWR5IHByb2Nlc3NlZCByb2xsIHJlc3VsdC4gVXNlZnVsIGlmIHN0cnVjdHVyYWwgY2hhbmdlcyBzdWNoIGFzIHJlb3JkZXJpbmcsXG5cdCAqIG9yIGtlZXAvZHJvcCB0b2dnbGluZyBoYXMgYmVlbiBkb25lIGFuZCBhIHJlY2FsY3VsYXRpb24gb2YgdG90YWxzIGlzIG5lZWRlZFxuXHQgKlxuXHQgKiBAcGFyYW0gcm9sbFJlc3VsdCBUaGUganNvbiBvYmplY3QgbW9kZWwgcmV0dXJuZWQgdG8gdGhlIGZpbmFsQ2FsbGJhY2sgd2hlbiB0aGUgcm9sbCBleHByZXNzaW9uIHdhcyBvcmlnaW5hbGx5IHByb2Nlc3NlZFxuXHQgKi9cblx0dGhpcy5yZXByb2Nlc3MgPSBmdW5jdGlvbihyb2xsUmVzdWx0LCBmaW5hbENhbGxiYWNrLCBlcnJvckNhbGxiYWNrKSB7XG5cdFx0ZXJyb3JDYWxsYmFjayA9IGVycm9yQ2FsbGJhY2sgfHwgZmFsbGJhY2tFcnJvckhhbmRsZXI7XG5cblx0XHR0cnkge1xuXHRcdFx0cG9zdFByb2Nlc3NDb21wbGV0ZVJvbGxzKHJvbGxSZXN1bHQsIHVuZGVmaW5lZCwgdHJ1ZSk7XG5cdFx0XHRmaW5hbENhbGxiYWNrKHJvbGxSZXN1bHQpO1xuXHRcdH1cblx0XHRjYXRjaCAoZSkge1xuXHRcdFx0ZXJyb3JDYWxsYmFjayhlKTtcblx0XHR9XG5cdH07XG5cblx0dmFyIHJlbW90ZVJvbGxRdWV1ZSA9IFtdO1xuXHR2YXIgcmVtb3RlUm9sbENhbGxiYWNrcyA9IHt9O1xuXG5cdHZhciBwZXJmb3JtUmVtb3RlUm9sbCA9IGZ1bmN0aW9uKHZyZSwgcm9sbGlkLCByb2xsdHlwZSwgZmluYWxDYWxsYmFjaywgZXJyb3JDYWxsYmFjaykge1xuXHRcdHJlbW90ZVJvbGxRdWV1ZS5wdXNoKHtcblx0XHRcdHZyZTogdnJlLFxuXHRcdFx0cm9sbGlkOiByb2xsaWQsXG5cdFx0XHRyb2xsdHlwZTogcm9sbHR5cGVcblx0XHR9KTtcblxuXHRcdHJlbW90ZVJvbGxDYWxsYmFja3Nbcm9sbGlkXSA9IHtcblx0XHRcdHN1Y2Nlc3M6IGZpbmFsQ2FsbGJhY2ssXG5cdFx0XHRlcnJvcjogZXJyb3JDYWxsYmFja1xuXHRcdH1cblxuXHRcdGRlYm91bmNlZF9kb1JlbW90ZVJvbGxSZXF1ZXN0KCk7XG5cdH07XG5cblx0dmFyIF9kb1JlbW90ZVJvbGxSZXF1ZXN0ID0gZnVuY3Rpb24oKSB7XG5cblx0XHRpZiAocmVtb3RlUm9sbFF1ZXVlLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuXG5cdFx0aWYgKCF3aW5kb3cuaXNfcGxheWVyYXBwICYmIHdpbmRvdy5jdXJyZW50UGxheWVyLmdldChcInRkZGljZWVuYWJsZWRcIikgJiYgd2luZG93LmN1cnJlbnRQbGF5ZXIuZ2V0KFwiZGlzYWJsZWFnZW5jeVwiKSA9PT0gZmFsc2UpIHtcblxuXHRcdFx0aWYgKCQoXCIjdGRhZ2VuY3lvdmVybGF5XCIpLmlzKFwiOnZpc2libGVcIikpIHtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXHRcdFx0JChcIiN0ZGFnZW5jeW92ZXJsYXlcIikuc2hvdygpO1xuXHRcdFx0Ly9ESUNFQ1VQIFNGWFxuXHRcdFx0dmFyIG51bWJlcm9mZGljZSA9IHJlbW90ZVJvbGxRdWV1ZVswXS52cmUucm9sbHNbMF0uZGljZSA/IHJlbW90ZVJvbGxRdWV1ZVswXS52cmUucm9sbHNbMF0uZGljZSA6IDE7XG5cdFx0XHRkMjAudGRkaWNlLnBsYXlzb3VuZChcImRpY2VjdXBcIiwgbnVtYmVyb2ZkaWNlKTtcblx0XHRcdC8vIGQyMC50ZGRpY2Uuc291bmRmeFtcImRpY2VjdXAud2F2XCJdLnBsYXkoKTtcblx0XHRcdHZhciBwb3NpbmZvID0ge307XG5cdFx0XHR2YXIgJHNob3dsaW5lID0gJChcIiN0ZGFnZW5jeW92ZXJsYXkgc3ZnIGxpbmVcIik7XG5cdFx0XHR2YXIgc3RhcnRlZF9kcmFnZ2luZyA9IGZhbHNlO1xuXHRcdFx0JChcIiN0ZGFnZW5jeW92ZXJsYXlcIikub24oXCJtb3VzZWRvd25cIiwgZnVuY3Rpb24oZSkge1xuXHRcdFx0XHRwb3NpbmZvLnN0YXJ0eCA9IGUuY2xpZW50WCAvICQod2luZG93KS53aWR0aCgpO1xuXHRcdFx0XHRwb3NpbmZvLnN0YXJ0eSA9IGUuY2xpZW50WSAvICQod2luZG93KS5oZWlnaHQoKTtcblx0XHRcdFx0JHNob3dsaW5lLmF0dHIoXCJ4MVwiLCBlLmNsaWVudFgpLmF0dHIoXCJ5MVwiLCBlLmNsaWVudFkpLmF0dHIoXCJ4MlwiLCBlLmNsaWVudFgpLmF0dHIoXCJ5MlwiLCBlLmNsaWVudFkpO1xuXHRcdFx0XHRzdGFydGVkX2RyYWdnaW5nID0gdHJ1ZTtcblx0XHRcdH0pO1xuXHRcdFx0JChcIiN0ZGFnZW5jeW92ZXJsYXlcIikub24oXCJtb3VzZW1vdmVcIiwgZnVuY3Rpb24oZSkge1xuXHRcdFx0XHRpZiAoc3RhcnRlZF9kcmFnZ2luZykge1xuXHRcdFx0XHRcdHZhciB4ZGlzdCA9IE1hdGguYWJzKHBvc2luZm8uc3RhcnR4IC0gKGUuY2xpZW50WCAvICQod2luZG93KS53aWR0aCgpKSk7XG5cdFx0XHRcdFx0dmFyIHlkaXN0ID0gTWF0aC5hYnMocG9zaW5mby5zdGFydHkgLSAoZS5jbGllbnRZIC8gJCh3aW5kb3cpLmhlaWdodCgpKSk7XG5cdFx0XHRcdFx0dmFyIGN1cmRpc3QgPSBNYXRoLnNxcnQoKHhkaXN0ICogeGRpc3QpICsgKHlkaXN0ICogeWRpc3QpKTtcblx0XHRcdFx0XHRpZiAoY3VyZGlzdCA8IDAuMikge1xuXHRcdFx0XHRcdFx0JHNob3dsaW5lLmNzcyhcInN0cm9rZVwiLCBcInJnYigyNTUsMjU1LDI1NSlcIik7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGVsc2UgaWYgKGN1cmRpc3QgPCAwLjUpIHtcblx0XHRcdFx0XHRcdCRzaG93bGluZS5jc3MoXCJzdHJva2VcIiwgXCJyZ2IoMjQ1LDIzOCw0NClcIik7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGVsc2Uge1xuXHRcdFx0XHRcdFx0JHNob3dsaW5lLmNzcyhcInN0cm9rZVwiLCBcInJnYigyNDUsNDQsNDQpXCIpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHQkc2hvd2xpbmUuYXR0cihcIngyXCIsIGUuY2xpZW50WCkuYXR0cihcInkyXCIsIGUuY2xpZW50WSk7XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXHRcdFx0JChcIiN0ZGFnZW5jeW92ZXJsYXlcIikub24oXCJtb3VzZXVwXCIsIGZ1bmN0aW9uKGUpIHtcblx0XHRcdFx0JChcIiN0ZGFnZW5jeW92ZXJsYXlcIikub2ZmKCkuaGlkZSgpO1xuXHRcdFx0XHQkc2hvd2xpbmUuYXR0cihcIngxXCIsIDApLmF0dHIoXCJ5MVwiLCAwKS5hdHRyKFwieDJcIiwgMCkuYXR0cihcInkyXCIsIDApO1xuXHRcdFx0XHRmaXJlYmFzZS5hdXRoKCkuY3VycmVudFVzZXIuZ2V0SWRUb2tlbihmYWxzZSkudGhlbigodG9rZW4pID0+IHtcblx0XHRcdFx0XHRpZiAoIXBvc2luZm8uc3RhcnR4KSB7XG5cdFx0XHRcdFx0XHRfcG9zdGhvb2tyb2xscmVxdWVzdChudWxsLCB0b2tlbik7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGVsc2Uge1xuXHRcdFx0XHRcdFx0cG9zaW5mby5zdG9weCA9IGUuY2xpZW50WCAvICQod2luZG93KS53aWR0aCgpO1xuXHRcdFx0XHRcdFx0cG9zaW5mby5zdG9weSA9IGUuY2xpZW50WSAvICQod2luZG93KS5oZWlnaHQoKTtcblx0XHRcdFx0XHRcdF9wb3N0aG9va3JvbGxyZXF1ZXN0KHBvc2luZm8sIHRva2VuKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXHRcdFx0fSlcblx0XHR9XG5cdFx0ZWxzZSB7XG5cdFx0XHRzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRpZih3aW5kb3cuR05US04gPT09IFwidHV0b3JpYWxcIikge1xuXHRcdFx0XHRcdF9wb3N0aG9va3JvbGxyZXF1ZXN0KCk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0ZmlyZWJhc2UuYXV0aCgpLmN1cnJlbnRVc2VyLmdldElkVG9rZW4oZmFsc2UpLnRoZW4oKHRva2VuKSA9PiB7XG5cdFx0XHRcdFx0XHRfcG9zdGhvb2tyb2xscmVxdWVzdChudWxsLCB0b2tlbik7XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH1cblx0XHRcdH0sIDUwKTtcblx0XHR9XG5cdH07XG5cblx0dmFyIF9wb3N0aG9va3JvbGxyZXF1ZXN0ID0gZnVuY3Rpb24ocG9zaW5mbyA9IHt9LCBpZFRva2VuKSB7XG5cdFx0aWYgKHJlbW90ZVJvbGxRdWV1ZS5sZW5ndGggPT09IDApIHJldHVybjtcblxuXHRcdHZhciByb2xsZGF0YSA9IHtcblx0XHRcdGNpZDogd2luZG93LmNhbXBhaWduX3N0b3JhZ2VfcGF0aCxcblx0XHRcdGZibnVtOiB3aW5kb3cuRklSRUJBU0VfUk9PVCxcblx0XHRcdGF1dGhrZXk6IGlkVG9rZW4sXG5cdFx0XHRwaWQ6IHdpbmRvdy5jdXJyZW50UGxheWVyLmlkLFxuXHRcdFx0cm9sbHM6IHJlbW90ZVJvbGxRdWV1ZSxcblx0XHRcdHVzZTNkOiAod2luZG93LmlzX3BsYXllcmFwcCA/IHdpbmRvdy5jdXJyZW50UGxheWVyLmdldChcImFwcHRkZGljZWVuYWJsZWRcIikgOiB3aW5kb3cuY3VycmVudFBsYXllci5nZXQoXCJ0ZGRpY2VlbmFibGVkXCIpKSxcblx0XHR9O1xuXG5cdFx0aWYgKHBvc2luZm8pIHtcblxuXHRcdFx0dmFyIGRlbHRhcyA9IHtcblx0XHRcdFx0eDogcG9zaW5mby5zdGFydHggLSBwb3NpbmZvLnN0b3B4LFxuXHRcdFx0XHR5OiBwb3NpbmZvLnN0YXJ0eSAtIHBvc2luZm8uc3RvcHlcblx0XHRcdH07XG5cblx0XHRcdHZhciBtaW5kaXN0YW5jZSA9IDAuMDE7XG5cdFx0XHR2YXIgbWF4ZGlzdGFuY2UgPSAwLjM7XG5cblx0XHRcdGlmIChNYXRoLmFicyhkZWx0YXNbXCJ4XCJdKSA8IG1pbmRpc3RhbmNlKSB7XG5cdFx0XHRcdGRlbHRhc1tcInhcIl0gPSBkZWx0YXNbXCJ4XCJdIDwgMCA/IC1taW5kaXN0YW5jZSA6IG1pbmRpc3RhbmNlXG5cdFx0XHR9XG5cdFx0XHRpZiAoTWF0aC5hYnMoZGVsdGFzW1wieVwiXSkgPCBtaW5kaXN0YW5jZSkge1xuXHRcdFx0XHRkZWx0YXNbXCJ5XCJdID0gZGVsdGFzW1wieVwiXSA8IDAgPyAtbWluZGlzdGFuY2UgOiBtaW5kaXN0YW5jZVxuXHRcdFx0fVxuXHRcdFx0aWYgKE1hdGguYWJzKGRlbHRhc1tcInhcIl0pID4gbWF4ZGlzdGFuY2UpIHtcblx0XHRcdFx0ZGVsdGFzW1wieFwiXSA9IGRlbHRhc1tcInhcIl0gPCAwID8gLW1heGRpc3RhbmNlIDogbWF4ZGlzdGFuY2Vcblx0XHRcdH1cblx0XHRcdGlmIChNYXRoLmFicyhkZWx0YXNbXCJ5XCJdKSA+IG1heGRpc3RhbmNlKSB7XG5cdFx0XHRcdGRlbHRhc1tcInlcIl0gPSBkZWx0YXNbXCJ5XCJdIDwgMCA/IC1tYXhkaXN0YW5jZSA6IG1heGRpc3RhbmNlXG5cdFx0XHR9XG5cblx0XHRcdHJvbGxkYXRhLmRlbHRhcyA9IHtcblx0XHRcdFx0eDogZGVsdGFzLnggKiA4MCAqIC0xLFxuXHRcdFx0XHR5OiBkZWx0YXMueSAqIDgwICogMVxuXHRcdFx0fTtcblx0XHR9XG5cdFx0ZWxzZSBpZiAocm9sbGRhdGEudXNlM2QgPT09IHRydWUpIHtcblx0XHRcdHJvbGxkYXRhLmRlbHRhcyA9IHtcblx0XHRcdFx0eDogTWF0aC5yYW5kb20oKSAqIDEwIC0gNSxcblx0XHRcdFx0eTogMjBcblx0XHRcdH07XG5cdFx0fVxuXG5cdFx0Y29uc3Qgcm9sbFVSTCA9IHdpbmRvdy5ST0xMX1VSTCB8fCAnaHR0cHM6Ly9kaWNlLnJvbGwyMC5uZXQnO1xuXG5cdFx0JC5hamF4KHtcblx0XHRcdHVybDogcm9sbFVSTCArIFwiL2Rvcm9sbFwiLFxuXHRcdFx0dHlwZTogXCJQT1NUXCIsXG5cdFx0XHRkYXRhOiBKU09OLnN0cmluZ2lmeShyb2xsZGF0YSksXG5cdFx0XHRjb250ZW50VHlwZTogXCJhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04XCIsXG5cdFx0XHRkYXRhVHlwZTogXCJqc29uXCIsXG5cdFx0XHRzdWNjZXNzOiBmdW5jdGlvbihxdWV1ZXJlc3VsdHMpIHtcblx0XHRcdFx0Zm9yICh2YXIgcmVzdWx0cmlkIGluIHF1ZXVlcmVzdWx0cykge1xuXHRcdFx0XHRcdGlmICghcmVtb3RlUm9sbENhbGxiYWNrc1tyZXN1bHRyaWRdKXtcblx0XHRcdFx0XHRcdHJlbW90ZVJvbGxDYWxsYmFja3NbcmVzdWx0cmlkXSA9IHtcblx0XHRcdFx0XHRcdFx0c3VjY2VzczogZDIwLnRleHRjaGF0LnJvbGxfZGVmYXVsdF9jYWxsYmFjayxcblx0XHRcdFx0XHRcdFx0ZXJyb3I6IGQyMC50ZXh0Y2hhdC5yb2xsX2Vycm9yX2NhbGxiYWNrXG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0ZDIwLmRpY2VfZW5naW5lLm5ld1JvbGwocmVzdWx0cmlkKTtcblx0XHRcdFx0XHRpZiAocXVldWVyZXN1bHRzW3Jlc3VsdHJpZF0uZXJyb3IgIT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdFx0XHRyZW1vdGVSb2xsQ2FsbGJhY2tzW3Jlc3VsdHJpZF0uZXJyb3IoXCJUaGVyZSB3YXMgYW4gZXJyb3IgZmV0Y2hpbmcgeW91ciByb2xsLiBcIiArIHF1ZXVlcmVzdWx0c1tyZXN1bHRyaWRdLmVycm9yKTtcblx0XHRcdFx0XHRcdGNvbnRpbnVlO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHR2YXIgdGhpc3ZyZSA9IEpTT04ucGFyc2UocXVldWVyZXN1bHRzW3Jlc3VsdHJpZF0uanNvbik7XG5cdFx0XHRcdFx0cG9zdFByb2Nlc3NDb21wbGV0ZVJvbGxzKHRoaXN2cmUpO1xuXHRcdFx0XHRcdHJlbW90ZVJvbGxDYWxsYmFja3NbcmVzdWx0cmlkXS5zdWNjZXNzKHRoaXN2cmUsIHJlc3VsdHJpZCwgcXVldWVyZXN1bHRzW3Jlc3VsdHJpZF0uc2lnbmF0dXJlLCBxdWV1ZXJlc3VsdHNbcmVzdWx0cmlkXS50ZHNlZWQpO1xuXG5cdFx0XHRcdFx0aWYgKGQyMC50dXRvcmlhbCAmJiBxdWV1ZXJlc3VsdHNbcmVzdWx0cmlkXS5zaG91dGpzb24gIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHRcdFx0ZDIwLnRkZGljZS5yZW1vdGVSb2xsKEpTT04ucGFyc2UocXVldWVyZXN1bHRzW3Jlc3VsdHJpZF0uc2hvdXRqc29uKSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9LFxuXHRcdFx0ZXJyb3I6IGZ1bmN0aW9uKGUpIHtcblx0XHRcdFx0Ly9GYWxsYmFjayB0byBsb2NhbCByb2xsaW5nLlxuXHRcdFx0XHRfLmVhY2gocm9sbGRhdGEucm9sbHMsIGZ1bmN0aW9uKHRoaXNyb2xsKSB7XG5cblx0XHRcdFx0XHR2YXIgdnJlID0gdGhpc3JvbGwudnJlO1xuXG5cdFx0XHRcdFx0dmFyIHdob2xlUm9sbENvbXBsZXRlQ2FsbGJhY2sgPSBuZXcgVGFza0NvbXBsZXRpb25DYWxsYmFjayh2cmUucm9sbHMubGVuZ3RoLCBmdW5jdGlvbigpIHtcblx0XHRcdFx0XHRcdHBvc3RQcm9jZXNzQ29tcGxldGVSb2xscyh2cmUpO1xuXHRcdFx0XHRcdFx0c2V0VGltZW91dChmdW5jdGlvbigpIHtcblx0XHRcdFx0XHRcdFx0cmVtb3RlUm9sbENhbGxiYWNrc1t0aGlzcm9sbC5yb2xsaWRdLnN1Y2Nlc3ModnJlLCBudWxsLCBmYWxzZSk7XG5cdFx0XHRcdFx0XHR9LCAwKTtcblx0XHRcdFx0XHR9LCBcIndob2xlUm9sbENvbXBsZXRlQ2FsbGJhY2tcIik7XG5cblx0XHRcdFx0XHRpbml0aWF0ZVJvbGxzKHZyZS5yb2xscywgdnJlLnJlc3VsdFR5cGUsIGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRcdFx0d2hvbGVSb2xsQ29tcGxldGVDYWxsYmFjay50YXNrQ29tcGxldGUoKTtcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fSk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cblx0XHRyZW1vdGVSb2xsUXVldWUgPSBbXTtcblx0fTtcblxuXHR2YXIgbnVtQm91bmNlID0gMDtcblx0ZnVuY3Rpb24gc2hvd1dhcm5pbmcgKG9iaiwgYm91bmNlcykge1xuXHRcdHZhciBwbGF5ZXIgPSB3aW5kb3cuQ2FtcGFpZ24ucGxheWVycy5nZXQob2JqLnBpZCk7XG5cdFx0ZDIwLnRleHRjaGF0LmluY29taW5nKGZhbHNlLCB7XG5cdFx0XHR3aG86IFwic3lzdGVtXCIsXG5cdFx0XHR0eXBlOiBcInN5c3RlbVwiLFxuXHRcdFx0Y29udGVudDogaTE4bihcIndhcm5pbmdfcm9sbF9yZXN1bHRzX21pc3NpbmdfbmFtZV9udW1iZXJcIikudHJhblN1YihwbGF5ZXIuZ2V0KFwiZGlzcGxheW5hbWVcIiksIGJvdW5jZXMpXG5cdFx0fSk7XG5cdFx0bnVtQm91bmNlID0gMDtcblx0fVxuXHR2YXIgc2hvd1dhcm5pbmdUSCA9IF8udGhyb3R0bGUoc2hvd1dhcm5pbmcsIDcwMDAsIHsgbGVhZGluZzogZmFsc2UgfSk7IC8vIFRoZSB3YXJuaW5nIHdpbGwgb25seSBzaG93IHVwIGV2ZXJ5IDUgc2Vjb25kcy5cblx0ZDIwLmRpY2VfZW5naW5lLmhhbmRsZVJvbGxSZWNlaXZlZCA9IGZ1bmN0aW9uKG9iaikge1xuXHRcdC8vIElmIHRoZSByb2xsIGNvbWVzIGluIGJlZm9yZSB0aGUgc2hvdXQsIHdlIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgaXQgYXQgYWxsXG5cdFx0aWYgKHJlY2VudFJvbGxzLmluZGV4T2Yob2JqLnJpZCkgPT09IC0xKSB7XG5cdFx0XHRzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRpZiAocmVjZW50Um9sbHMuaW5kZXhPZihvYmoucmlkKSA9PT0gLTEpIHtcblx0XHRcdFx0XHRzaG93V2FybmluZ1RIKG9iaiwgKytudW1Cb3VuY2UpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGVsc2Uge1xuXHRcdFx0XHRcdHJlY2VudFJvbGxzLnNwbGljZShyZWNlbnRSb2xscy5pbmRleE9mKG9iai5yaWQpLCAxKTtcblx0XHRcdFx0fVxuXHRcdFx0fSwgMzAwMClcblx0XHR9XG5cdFx0ZWxzZSB7XG5cdFx0XHRyZWNlbnRSb2xscy5zcGxpY2UocmVjZW50Um9sbHMuaW5kZXhPZihvYmoucmlkKSwgMSk7XG5cdFx0fVxuXHR9O1xuXHRkMjAuZGljZV9lbmdpbmUubmV3Um9sbCA9IGZ1bmN0aW9uKHJvbGxJZCkge1xuXHRcdGlmIChyZWNlbnRSb2xscy5pbmRleE9mKHJvbGxJZCkgPT09IC0xKSB7XG5cdFx0XHRyZWNlbnRSb2xscy5wdXNoKHJvbGxJZCk7XG5cdFx0fVxuXHR9O1xuXG5cdHRoaXMuZmx1c2hSZW1vdGVRdWV1ZSA9IGZ1bmN0aW9uKCkge1xuXHRcdF9kb1JlbW90ZVJvbGxSZXF1ZXN0KCk7XG5cdH1cblxuXHR2YXIgZGVib3VuY2VkX2RvUmVtb3RlUm9sbFJlcXVlc3QgPSBfLmRlYm91bmNlKF9kb1JlbW90ZVJvbGxSZXF1ZXN0LCAxMDApO1xuXG5cdC8qKlxuXHQgKiBQcm9jZXNzIGEgcm9sbCBleHByZXNzaW9uIGFuZCBjYWxsIGZpbmFsQ2FsbGJhY2sgd2hlbiBjb21wbGV0ZSB3aXRoIGFuXG5cdCAqIG9iamVjdCB0aGF0IGNvbnRhaW5zIHRoZSB0b3RhbCwgZm9ybXVsYSwgYW5kIG9yaWdpbmFsRm9ybXVsYVxuXHQgKi9cblx0dGhpcy5wcm9jZXNzID0gZnVuY3Rpb24ocm9sbFN0cmluZywgZmluYWxDYWxsYmFjaywgZXJyb3JDYWxsYmFjaykge1xuXHRcdGVycm9yQ2FsbGJhY2sgPSBlcnJvckNhbGxiYWNrIHx8IGZhbGxiYWNrRXJyb3JIYW5kbGVyO1xuXG5cdFx0dHJ5IHtcblx0XHRcdHZhciB2cmUgPSBwYXJzZVJvbGxTdHJpbmcocm9sbFN0cmluZyk7XG5cblx0XHRcdGlmICh2cmUucm9sbHMgPT0gMCkge1xuXHRcdFx0XHR0aHJvdyBcIlRoZXJlIHdlcmUgbm8gZGljZSB0byByb2xsIVwiO1xuXHRcdFx0fVxuXG5cdFx0XHR2YXIgZGlkSGF2ZVRhYmxlcyA9IGZhbHNlO1xuXHRcdFx0dmFyIGRpZEhhdmVSb2xscyA9IGZhbHNlO1xuXHRcdFx0dmFyIGhhc1RhYmxlc0RlcHRoID0gMDtcblxuXHRcdFx0dmFyIGhhc1RhYmxlcyA9IGZ1bmN0aW9uKHN1YnJvbGxzKSB7XG5cdFx0XHRcdGhhc1RhYmxlc0RlcHRoKys7XG5cdFx0XHRcdGlmIChzdWJyb2xscyAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdFx0Zm9yICh2YXIgaSA9IDA7IGkgPCBzdWJyb2xscy5sZW5ndGg7IGkrKykge1xuXHRcdFx0XHRcdFx0aWYgKHN1YnJvbGxzW2ldLnRhYmxlICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0XHRcdFx0ZGlkSGF2ZVRhYmxlcyA9IHRydWU7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRpZiAoc3Vicm9sbHNbaV0udHlwZSA9PT0gXCJSXCIpIHtcblx0XHRcdFx0XHRcdFx0ZGlkSGF2ZVJvbGxzID0gdHJ1ZTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdGlmICgoIWRpZEhhdmVUYWJsZXMgfHwgIWRpZEhhdmVSb2xscykgJiYgaGFzVGFibGVzRGVwdGggPCA5OSAmJiBzdWJyb2xsc1tpXS5yb2xscyAhPT0gdW5kZWZpbmVkICYmIHN1YnJvbGxzW2ldLnJvbGxzLmxlbmd0aCA+IDApIHtcblx0XHRcdFx0XHRcdFx0Zm9yICh2YXIgaiA9IDA7IGogPCBzdWJyb2xsc1tpXS5yb2xscy5sZW5ndGg7IGorKykge1xuXHRcdFx0XHRcdFx0XHRcdGhhc1RhYmxlcyhzdWJyb2xsc1tpXS5yb2xsc1tqXSk7XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH07XG5cblx0XHRcdHRyeSB7XG5cdFx0XHRcdGhhc1RhYmxlcyh2cmUucm9sbHMpO1xuXHRcdFx0fVxuXHRcdFx0Y2F0Y2ggKGUpIHtcblx0XHRcdH1cblxuXHRcdFx0aGFzVGFibGVzID0gbnVsbDtcblxuXHRcdFx0aWYgKGQyMC50ZXh0Y2hhdCAmJiBkMjAudGV4dGNoYXQuZWdnX2NsaWNraG9sZSkge1xuXHRcdFx0XHRkaWRIYXZlVGFibGVzID0gdHJ1ZTsgLy9mb3JjZSB1c2luZyBsb2NhbCByb2xscy5cblx0XHRcdH1cblxuXHRcdFx0aWYgKGRpZEhhdmVUYWJsZXMgPT09IHRydWUgfHwgZGlkSGF2ZVJvbGxzID09PSBmYWxzZSkge1xuXHRcdFx0XHR2YXIgd2hvbGVSb2xsQ29tcGxldGVDYWxsYmFjayA9IG5ldyBUYXNrQ29tcGxldGlvbkNhbGxiYWNrKHZyZS5yb2xscy5sZW5ndGgsIGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRcdHBvc3RQcm9jZXNzQ29tcGxldGVSb2xscyh2cmUpO1xuXHRcdFx0XHRcdHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG5cdFx0XHRcdFx0XHRmaW5hbENhbGxiYWNrKHZyZSwgbnVsbCwgZmFsc2UpO1xuXHRcdFx0XHRcdH0sIDApO1xuXHRcdFx0XHR9LCBcIndob2xlUm9sbENvbXBsZXRlQ2FsbGJhY2tcIik7XG5cblx0XHRcdFx0aW5pdGlhdGVSb2xscyh2cmUucm9sbHMsIHZyZS5yZXN1bHRUeXBlLCBmdW5jdGlvbigpIHtcblx0XHRcdFx0XHR3aG9sZVJvbGxDb21wbGV0ZUNhbGxiYWNrLnRhc2tDb21wbGV0ZSgpO1xuXHRcdFx0XHR9KTtcblx0XHRcdH1cblxuXHRcdFx0ZWxzZSBpZiAodHlwZW9mICQgPT09IFwidW5kZWZpbmVkXCIpIHtcblx0XHRcdFx0Ly9XZSdyZSBvbiB0aGUgQVBJIHNlcnZlcj9cblxuXHRcdFx0XHR2YXIgcm9sbGlkID0gZ2VuZXJhdGVVVUlEKCk7XG5cblx0XHRcdFx0dmFyIHJvbGxkYXRhID0ge1xuXHRcdFx0XHRcdHZyZTogdnJlLFxuXHRcdFx0XHRcdGNpZDogQ0FNUEFJR05JRCxcblx0XHRcdFx0XHRmYm51bTogJ2h0dHBzOi8vJyArIEZJUkVCQVNFTlVNICsgJy5maXJlYmFzZWlvLmNvbS8nLFxuXHRcdFx0XHRcdHBpZDogXCJhcGlcIixcblx0XHRcdFx0XHRyaWQ6IHJvbGxpZCxcblx0XHRcdFx0XHR1c2UzZDogZmFsc2UsXG5cdFx0XHRcdFx0YXV0aGtleTogRklSRUJBU0VUT0tFTixcblx0XHRcdFx0XHRyb2xsdHlwZTogZDIwLnRleHRjaGF0LmN1cnJlbnRSb2xsVHlwZVxuXHRcdFx0XHR9O1xuXG5cdFx0XHRcdC8vIFRoaXMgaXMgb25seSBuZWVkZWQgdW50aWwgd2UgYXJlIDEwMCUgb24gR0tFXG5cdFx0XHRcdGNvbnN0IHJvbGxVUkwgPSB3aW5kb3cuUk9MTF9VUkwgfHwgXCJodHRwczovL2FwcC5yb2xsMjAubmV0XCI7XG5cdFx0XHRcdHJlcXVlc3QucG9zdCh7XG5cdFx0XHRcdFx0dXJsOiByb2xsVVJMICsgXCIvZG9yb2xsXCIsXG5cdFx0XHRcdFx0Ym9keTogcm9sbGRhdGEsXG5cdFx0XHRcdFx0anNvbjogdHJ1ZSxcblx0XHRcdFx0XHR0aW1lb3V0OiA1MDAwXG5cdFx0XHRcdH0sIGZ1bmN0aW9uKGVycm9yLCByZXNwb25zZSwgYm9keSkge1xuXG5cdFx0XHRcdFx0aWYgKCFlcnJvciAmJiByZXNwb25zZS5zdGF0dXNDb2RlID09IDIwMCAmJiBib2R5ICE9PSBcIlwiKSB7XG5cdFx0XHRcdFx0XHR2YXIgc25hcCA9IGJvZHk7XG5cdFx0XHRcdFx0XHRpZiAoc25hcC5lcnJvciAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdFx0XHRcdGVycm9yQ2FsbGJhY2soXCJUaGVyZSB3YXMgYW4gZXJyb3IgZmV0Y2hpbmcgeW91ciByb2xsLiBcIiArIHNuYXAuZXJyb3IpO1xuXHRcdFx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR2YXIgZmluYWx2cmUgPSBKU09OLnBhcnNlKHNuYXAuanNvbik7XG5cdFx0XHRcdFx0XHRwb3N0UHJvY2Vzc0NvbXBsZXRlUm9sbHMoZmluYWx2cmUpO1xuXHRcdFx0XHRcdFx0ZmluYWxDYWxsYmFjayhmaW5hbHZyZSwgcm9sbGlkLCBzbmFwLnNpZ25hdHVyZSk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0ZWxzZSB7XG5cdFx0XHRcdFx0XHRlcnJvckNhbGxiYWNrKFwiVGhlcmUgd2FzIGFuIGVycm9yIGNvbW11bmljYXRpbmcgd2l0aCB0aGUgUXVhbnR1bVJvbGwgc2VydmVyLlwiKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXG5cdFx0XHRlbHNlIHtcblxuXHRcdFx0XHR2YXIgcm9sbGlkID0gZ2VuZXJhdGVVVUlEKCk7XG5cblx0XHRcdFx0cGVyZm9ybVJlbW90ZVJvbGwodnJlLCByb2xsaWQsIGQyMC50ZXh0Y2hhdC5jdXJyZW50Um9sbFR5cGUsIGZpbmFsQ2FsbGJhY2ssIGVycm9yQ2FsbGJhY2spO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRjYXRjaCAoZSkge1xuXHRcdFx0ZXJyb3JDYWxsYmFjayhlKTtcblx0XHR9XG5cdH07XG5cblx0dGhpcy5oYW5kbGVSb2xsUmVxID0gZnVuY3Rpb24odnJlLCBmaW5hbENhbGxiYWNrKSB7XG5cdFx0dmFyIHdob2xlUm9sbENvbXBsZXRlQ2FsbGJhY2sgPSBuZXcgVGFza0NvbXBsZXRpb25DYWxsYmFjayh2cmUucm9sbHMubGVuZ3RoLCBmdW5jdGlvbigpIHtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdHBvc3RQcm9jZXNzQ29tcGxldGVSb2xscyh2cmUpO1xuXHRcdFx0fVxuXHRcdFx0Y2F0Y2ggKGUpIHtcblx0XHRcdFx0ZmluYWxDYWxsYmFjayh7XG5cdFx0XHRcdFx0ZXJyb3I6IFwiVGhlcmUgd2FzIGFuIGVycm9yIHByb2Nlc3NpbmcgdGhpcyByb2xsLlwiXG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cdFx0XHRzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRmaW5hbENhbGxiYWNrKHZyZSk7XG5cdFx0XHR9LCAwKTtcblx0XHR9LCBcIndob2xlUm9sbENvbXBsZXRlQ2FsbGJhY2tcIik7XG5cblx0XHR0cnkge1xuXHRcdFx0aW5pdGlhdGVSb2xscyh2cmUucm9sbHMsIHZyZS5yZXN1bHRUeXBlLCBmdW5jdGlvbigpIHtcblx0XHRcdFx0d2hvbGVSb2xsQ29tcGxldGVDYWxsYmFjay50YXNrQ29tcGxldGUoKTtcblx0XHRcdH0pO1xuXHRcdH1cblx0XHRjYXRjaCAoZSkge1xuXHRcdFx0ZmluYWxDYWxsYmFjayh7XG5cdFx0XHRcdGVycm9yOiBcIlRoZXJlIHdhcyBhbiBlcnJvciBwcm9jZXNzaW5nIHRoaXMgcm9sbC5cIlxuXHRcdFx0fSk7XG5cdFx0fVxuXHR9O1xuXG5cdHRoaXMuaGFuZGxlUm9sbFN0cmluZyA9IGZ1bmN0aW9uKHJvbGxTdHJpbmcpIHtcblx0XHR2YXIgdnJlID0gcGFyc2VSb2xsU3RyaW5nKHJvbGxTdHJpbmcpO1xuXG5cdFx0aWYgKHZyZS5yb2xscyA9PSAwKSB7XG5cdFx0XHR0aHJvdyBcIlRoZXJlIHdlcmUgbm8gZGljZSB0byByb2xsIVwiO1xuXHRcdH1cblxuXHRcdHJldHVybiB2cmU7XG5cdH1cblxuXHRyZXR1cm4gdGhpcztcbn07XG5pbXBvcnQge1xuXHRwYXJzZVJvbGxEYXRhLFxuXHRjcmVhdGVSb2xsUHJvbWlzZSxcblx0YWRkQ29tcHV0ZWRSZXN1bHRzLFxufSBmcm9tICcuL3V0aWwvdGV4dGNoYXRVdGlscyc7XG5pbXBvcnQgeyBjcmVhdGVEYXJrTW9kZUNTUyB9IGZyb20gJy4vc2V0dXBEYXJrTW9kZSc7XG5cbmNvbnN0IGNoYXJhY3RlcnNNZW50aW9uZWQgPSAoY29udGVudCwgcmVnZXgpID0+IHtcblx0Y29uc3QgbWF0Y2hlcyA9IGNvbnRlbnQubWF0Y2gocmVnZXgpO1xuXG5cdGlmIChtYXRjaGVzID09IG51bGwpIHJldHVybiB7fTtcblxuXHRyZXR1cm4gbWF0Y2hlcy5yZWR1Y2UoKGFjYywgbWF0Y2gpID0+IHtcblx0XHRjb25zdCBpbnB1dCA9IG1hdGNoLnN1YnN0cmluZygyLCBtYXRjaC5sZW5ndGggLSAxKTtcblx0XHRjb25zdCBmaWVsZHMgPSBpbnB1dC5zcGxpdCgnfCcpO1xuXG5cdFx0bGV0IGNoYXJhY3RlcjtcblxuXHRcdGlmIChmaWVsZHMubGVuZ3RoID09PSA0KSB7XG5cdFx0XHRjb25zdCBjaGFyYWN0ZXJJZCA9IGZpZWxkc1swXTtcblx0XHRcdGNoYXJhY3RlciA9IGQyMC5DYW1wYWlnbi5jaGFyYWN0ZXJzLmdldChjaGFyYWN0ZXJJZCk7XG5cdFx0XHRpZiAoY2hhcmFjdGVyICE9IG51bGwpIHtcblx0XHRcdFx0YWNjW2NoYXJhY3Rlci5pZF0gPSBjaGFyYWN0ZXI7XG5cdFx0XHRcdHJldHVybiBhY2M7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0Y29uc3QgY2hhck5hbWUgPSBmaWVsZHNbMF07XG5cblx0XHRpZiAoWydzZWxlY3RlZCcsICd0YXJnZXQnLCAndHJhY2tlciddLmluY2x1ZGVzKGNoYXJOYW1lKSkge1xuXHRcdFx0aWYgKGNoYXJOYW1lID09PSAnc2VsZWN0ZWQnKSB7XG5cdFx0XHRcdGNvbnN0IHNlbGVjdGVkID0gZDIwLmVuZ2luZS5zZWxlY3RlZCgpO1xuXHRcdFx0XHRpZiAoc2VsZWN0ZWQubGVuZ3RoID4gMCAmJiBzZWxlY3RlZFswXS5tb2RlbD8uZ2V0KCdyZXByZXNlbnRzJykpIHtcblx0XHRcdFx0XHRjaGFyYWN0ZXIgPSBkMjAuQ2FtcGFpZ24uY2hhcmFjdGVycy5nZXQoc2VsZWN0ZWRbMF0ubW9kZWwuZ2V0KCdyZXByZXNlbnRzJykpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGlmIChjaGFyYWN0ZXIgIT0gbnVsbCkge1xuXHRcdFx0XHRcdGFjY1tjaGFyYWN0ZXIuaWRdID0gY2hhcmFjdGVyO1xuXHRcdFx0XHRcdHJldHVybiBhY2M7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHRcdHJldHVybiBhY2M7XG5cdFx0fVxuXG5cdFx0ZDIwLkNhbXBhaWduLmNoYXJhY3RlcnMuZWFjaCgoc29tZUNoYXJhY3RlcikgPT4ge1xuXHRcdFx0aWYgKFxuXHRcdFx0XHRzb21lQ2hhcmFjdGVyLmdldCgnbmFtZScpLnRvTG93ZXJDYXNlKCkgPT09IGNoYXJOYW1lLnRvTG93ZXJDYXNlKClcblx0XHRcdCkge1xuXHRcdFx0XHRjaGFyYWN0ZXIgPSBzb21lQ2hhcmFjdGVyO1xuXHRcdFx0XHRhY2NbY2hhcmFjdGVyLmlkXSA9IGNoYXJhY3Rlcjtcblx0XHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdFx0fVxuXHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0fSk7XG5cblx0XHRyZXR1cm4gYWNjO1xuXHR9LCB7fSk7XG59O1xuXG5mdW5jdGlvbiBSb2xsQ29tbWFuZEVycm9yKG1lc3NhZ2UpIHtcblx0dGhpcy5uYW1lID0gJ1JvbGxDb21tYW5kRXJyb3InO1xuXHR0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlO1xuXHR0aGlzLnN0YWNrID0gKG5ldyBFcnJvcigpKS5zdGFjaztcbn1cblJvbGxDb21tYW5kRXJyb3IucHJvdG90eXBlID0gbmV3IEVycm9yKCk7XG5cbmQyMC50ZXh0Y2hhdCA9IHtcblx0Y29tbWFuZGhpc3Rvcnk6IFtdLFxuXHRjb21tYW5kSW5kZXg6IDAsXG5cdGN1cnJlbnRSb2xsVHlwZTogJ3JvbGxyZXN1bHQnLFxuXHRjb21tYW5kSW5Qcm9ncmVzczogZmFsc2UsXG5cdGxhc3RDaGF0QmVlcDogMCxcblx0dGFsa3RvbXlzZWxmOiBmYWxzZSxcblx0YWxsb3dlZDNkcm9sbHM6IFtdLFxuXHRnbG9iYWxyb2xsZWQ6IDAsXG5cdGVnZ19jbGlja2hvbGU6IGZhbHNlLFxuXHRyb2xsX2Vycm9yX2NhbGxiYWNrKGUpIHtcblx0XHRjb25zb2xlLmxvZyhlKTtcblx0XHRjb25zdCBlb3AgPSB7XG5cdFx0XHR3aG86ICdlcnJvcicsXG5cdFx0XHR0eXBlOiAnZXJyb3InLFxuXHRcdFx0Y29udGVudDogdHlwZW9mIGUgPT09ICdzdHJpbmcnID8gZSA6ICdUaGVyZSB3YXMgYW4gZXJyb3Igd2l0aCB5b3VyIGZvcm11bGEuIFBsZWFzZSB0cnkgYWdhaW4uJyxcblx0XHR9O1xuXHRcdGQyMC50ZXh0Y2hhdC5pbmNvbWluZyhmYWxzZSwgZW9wKTtcblx0XHRkMjAudXRpbHMudGV4dGNoYXROb3RpZnkoZmFsc2UpO1xuXHR9LFxuXHRzdWJUYWJsZXMocm9sbHMsIHBhc3NOdW0pIHtcblx0XHRsZXQgX3J1bm5pbmdUb3RhbCA9IDA7XG5cdFx0bGV0IF9oYXNUYWJsZSA9IGZhbHNlO1xuXG5cdFx0aWYgKHBhc3NOdW0gPiA5OSkge1xuXHRcdFx0Y29uc29sZS5sb2coJ1RvbyBtYW55IHN1Ymdyb3VwcywgYWJvcnQuJyk7XG5cdFx0XHRyZXR1cm4gdW5kZWZpbmVkO1xuXHRcdH1cblxuXHRcdF8uZWFjaChyb2xscywgKHJvbGwpID0+IHtcblx0XHRcdGlmIChyb2xsLnR5cGUgPT09ICdHJykge1xuXHRcdFx0XHRfLmVhY2gocm9sbC5yb2xscywgKHN1YnJvbGxzKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgX3N1YnJlc3VsdCA9IGQyMC50ZXh0Y2hhdC5zdWJUYWJsZXMoc3Vicm9sbHMsIHBhc3NOdW0gKyAxKTtcblx0XHRcdFx0XHRpZiAoX3N1YnJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdFx0XHRfcnVubmluZ1RvdGFsICs9IF9zdWJyZXN1bHQ7XG5cdFx0XHRcdFx0XHRfaGFzVGFibGUgPSB0cnVlO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSk7XG5cdFx0XHR9IGVsc2UgaWYgKHJvbGwudGFibGUpIHtcblx0XHRcdFx0Y29uc3QgdGFibGUgPSBkMjAuQ2FtcGFpZ24ucm9sbGFibGV0YWJsZXMuZmluZFRhYmxlQnlOYW1lKHJvbGwudGFibGUpO1xuXHRcdFx0XHRjb25zdCB3ZWlnaHRlZCA9IHRhYmxlLmdldFdlaWdodGVkQXJyYXkoKTtcblx0XHRcdFx0aWYgKHRhYmxlKSB7XG5cdFx0XHRcdFx0Xy5lYWNoKHJvbGwucmVzdWx0cywgKHJlc3VsdCkgPT4ge1xuXHRcdFx0XHRcdFx0X2hhc1RhYmxlID0gdHJ1ZTtcblx0XHRcdFx0XHRcdHJlc3VsdC50YWJsZUl0ZW0gPSB0YWJsZS50YWJsZWl0ZW1zXG5cdFx0XHRcdFx0XHRcdC5nZXQod2VpZ2h0ZWRbcmVzdWx0LnRhYmxlaWR4XSlcblx0XHRcdFx0XHRcdFx0LnRvSlNPTigpO1xuXHRcdFx0XHRcdFx0aWYgKHJlc3VsdC5kID09PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0XHRcdFx0X3J1bm5pbmdUb3RhbCArPSByZXN1bHQudjtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fVxuXHRcdFx0fSBlbHNlIGlmIChyb2xsLnJlc3VsdHMpIHtcblx0XHRcdFx0Xy5lYWNoKHJvbGwucmVzdWx0cywgKHJlc3VsdCkgPT4ge1xuXHRcdFx0XHRcdGlmIChyZXN1bHQuZCkgcmV0dXJuIHRydWU7XG5cdFx0XHRcdFx0X3J1bm5pbmdUb3RhbCArPSByZXN1bHQudjtcblx0XHRcdFx0fSk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cblx0XHRpZiAoX2hhc1RhYmxlKSByZXR1cm4gX3J1bm5pbmdUb3RhbDtcblx0XHRyZXR1cm4gdW5kZWZpbmVkO1xuXHR9LFxuXHRyb2xsX2RlZmF1bHRfY2FsbGJhY2socmVzdWx0cywgcm9sbGlkLCBzaWduYXR1cmUsIHRkc2VlZCkge1xuXHRcdGNvbnN0IHBhcmVudFJlZiA9IGZpcmViYXNlLmRhdGFiYXNlKCkucmVmKFxuXHRcdFx0YCR7d2luZG93LmNhbXBhaWduX3N0b3JhZ2VfcGF0aH1gLFxuXHRcdCk7XG5cdFx0Y29uc3QgZmJyZWYgPSBwYXJlbnRSZWYuY2hpbGQoJ2NoYXQnKTtcblx0XHRjb25zdCByb2xsX3R5cGUgPSAncm9sbHJlc3VsdCc7XG5cblx0XHRkMjAudGV4dGNoYXQuZ2xvYmFscm9sbGVkKys7XG5cblx0XHRkMjAudXRpbHMudGV4dGNoYXROb3RpZnkoZmFsc2UpO1xuXG5cdFx0aWYgKHJlc3VsdHMuZXJyb3IpIHtcblx0XHRcdGNvbnN0IGVvcCA9IHtcblx0XHRcdFx0d2hvOiAnZXJyb3InLFxuXHRcdFx0XHR0eXBlOiAnZXJyb3InLFxuXHRcdFx0XHRjb250ZW50OiByZXN1bHRzLmVycm9yLFxuXHRcdFx0fTtcblx0XHRcdGQyMC50ZXh0Y2hhdC5pbmNvbWluZyhmYWxzZSwgZW9wKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0aWYgKHJlc3VsdHMucm9sbHMgJiYgcmVzdWx0cy5yb2xscy5sZW5ndGggPiAwKSB7XG5cdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0Y29uc3QgX3RhYmxlUmVzdWx0ID0gZDIwLnRleHRjaGF0LnN1YlRhYmxlcyhyZXN1bHRzLnJvbGxzLCAwKTtcblxuXHRcdFx0XHRcdGlmIChfdGFibGVSZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHRcdFx0c2lnbmF0dXJlID0gbnVsbDtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdFx0XHRjb25zb2xlLmxvZygnRVJST1IgbWF0Y2hpbmcgdGFibGUnKTtcblx0XHRcdFx0XHRjb25zb2xlLmxvZyhlKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCBuZXdvcCA9IHtcblx0XHRcdFx0d2hvOiBkMjAudGV4dGNoYXQuJHNwZWFraW5nYXMuZmluZCgnb3B0aW9uOnNlbGVjdGVkJykudGV4dCgpLFxuXHRcdFx0XHR0eXBlOiByb2xsX3R5cGUsXG5cdFx0XHRcdGNvbnRlbnQ6IEpTT04uc3RyaW5naWZ5KHJlc3VsdHMpLFxuXHRcdFx0XHRzaWduYXR1cmUsXG5cdFx0XHRcdG9yaWdSb2xsOiAnW2Vycm9yXScsXG5cdFx0XHRcdHBsYXllcmlkOiB3aW5kb3cuY3VycmVudFBsYXllci5pZCxcblx0XHRcdFx0YXZhdGFyOiAnJyxcblx0XHRcdFx0X2ZiaWQ6IHJvbGxpZCxcblx0XHRcdH07XG5cdFx0XHRmYnJlZlxuXHRcdFx0XHQuY2hpbGQocm9sbGlkKVxuXHRcdFx0XHQuc2V0V2l0aFByaW9yaXR5KG5ld29wLCBmaXJlYmFzZS5kYXRhYmFzZS5TZXJ2ZXJWYWx1ZS5USU1FU1RBTVApO1xuXHRcdH1cblx0fSxcbn07XG5cbiQoKCkgPT4ge1xuXHRsZXQgbGFzdE5hbWUgPSAnJztcblx0bGV0IGxpbmVzU2luY2VOYW1lID0gMDtcblx0bGV0IHdpbmRvd0lzRm9jdXNlZCA9IHRydWU7XG5cdGxldCBwb3BvdXRXaW5kb3dJc0ZvY3VzZWQgPSBmYWxzZTtcblx0bGV0IGF1dG9Db21wbGV0ZU9wZW4gPSBmYWxzZTtcblx0bGV0IGxhc3RXaGlzcGVyUmVjZWl2ZWQ7XG5cdGxldCBmYnJlZjtcblx0bGV0IHNob3V0cmVmO1xuXHRjb25zdCBpc3R5cGluZ3RpbWVycyA9IHt9O1xuXHRjb25zdCB3aG9pc3R5cGluZyA9IHt9O1xuXG5cdGQyMC50ZXh0Y2hhdC50YWJJc0ZvY3VzZWQgPSB0cnVlO1xuXG5cdGlmIChkMjAuZGljZV9lbmdpbmUpIHtcblx0XHRkMjAudGV4dGNoYXQuZGljZWVuZ2luZSA9IG5ldyBkMjAuZGljZV9lbmdpbmUoKTtcblx0fVxuXG5cdCQod2luZG93KS5iaW5kKCdmb2N1cycsICgpID0+IHtcblx0XHR3aW5kb3dJc0ZvY3VzZWQgPSB0cnVlO1xuXHR9KTtcblxuXHQkKHdpbmRvdykuYmluZCgnYmx1cicsICgpID0+IHtcblx0XHR3aW5kb3dJc0ZvY3VzZWQgPSBmYWxzZTtcblx0fSk7XG5cblx0ZDIwLnRleHRjaGF0LiR0ZXh0YXJlYSA9ICQoJyN0ZXh0Y2hhdC1pbnB1dCB0ZXh0YXJlYScpO1xuXHRkMjAudGV4dGNoYXQuJHNwZWFraW5nYXMgPSAkKCcjc3BlYWtpbmdhcycpO1xuXHRkMjAudGV4dGNoYXQuJHRleHRjaGF0ID0gJCgnI3RleHRjaGF0Jyk7XG5cblx0Y29uc3QgeDUwOSA9IG5ldyBYNTA5KCk7XG5cdHg1MDkucmVhZENlcnRQRU0oXG5cdFx0Jy0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLVxcXG5NSUlDdFRDQ0FsK2dBd0lCQWdJSkFKdHdsZS9xa0hKbk1BMEdDU3FHU0liM0RRRUJCUVVBTUhJeEN6QUpCZ05WXFxcbkJBWVRBbFZUTVFzd0NRWURWUVFJRXdKTFV6RVFNQTRHQTFVRUJ4TUhWMmxqYUdsMFlURVBNQTBHQTFVRUNoTUdcXFxuVW05c2JESXdNUk13RVFZRFZRUURFd3B5YjJ4c01qQXVibVYwTVI0d0hBWUpLb1pJaHZjTkFRa0JGZzkwWldGdFxcXG5RSEp2Ykd3eU1DNXVaWFF3SGhjTk1UUXdNekF6TVRnd01UUTRXaGNOTVRRd05EQXlNVGd3TVRRNFdqQnlNUXN3XFxcbkNRWURWUVFHRXdKVlV6RUxNQWtHQTFVRUNCTUNTMU14RURBT0JnTlZCQWNUQjFkcFkyaHBkR0V4RHpBTkJnTlZcXFxuQkFvVEJsSnZiR3d5TURFVE1CRUdBMVVFQXhNS2NtOXNiREl3TG01bGRERWVNQndHQ1NxR1NJYjNEUUVKQVJZUFxcXG5kR1ZoYlVCeWIyeHNNakF1Ym1WME1Gd3dEUVlKS29aSWh2Y05BUUVCQlFBRFN3QXdTQUpCQUxKcThtdUFGblpNXFxcbmtKeXNYZzlWSnNldm9ReHR4VjFOeXRZdkNLSFR0YUNqYS90eWVMVFJlaTBudStOeW1QZk5LS2lSaHY3UjhEMzNcXFxub1pMdklBL3VkdXNDQXdFQUFhT0IxekNCMURBZEJnTlZIUTRFRmdRVWFyR3hWdk9EWURwelM1T0t5S3NUeUNFbVxcXG5EU1V3Z2FRR0ExVWRJd1NCbkRDQm1ZQVVhckd4VnZPRFlEcHpTNU9LeUtzVHlDRW1EU1doZHFSME1ISXhDekFKXFxcbkJnTlZCQVlUQWxWVE1Rc3dDUVlEVlFRSUV3SkxVekVRTUE0R0ExVUVCeE1IVjJsamFHbDBZVEVQTUEwR0ExVUVcXFxuQ2hNR1VtOXNiREl3TVJNd0VRWURWUVFERXdweWIyeHNNakF1Ym1WME1SNHdIQVlKS29aSWh2Y05BUWtCRmc5MFxcXG5aV0Z0UUhKdmJHd3lNQzV1WlhTQ0NRQ2JjSlh2NnBCeVp6QU1CZ05WSFJNRUJUQURBUUgvTUEwR0NTcUdTSWIzXFxcbkRRRUJCUVVBQTBFQWpCSGF5bHRVM0s0RENzMmg0bkMycXVHR0t6R0UyaDFuTUNCemhRMWVkK3ZpcitsTG5XUXZcXFxuQU9ycXQ1ME54N2xNaysyM3VGR2hHTXlzSzJVeXJxcHRNdz09XFxcbi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0nLFxuXHQpO1xuXG5cdGNvbnN0IHJvbGxyZSA9IC9cXC8oKHJvbGwpfChyKXwoZ21yb2xsKXwoZ3IpKVsgXSsvaTtcblx0Y29uc3QgaW52aXRlTGlua01lc3NhZ2UgPSAoKSA9PiB7XG5cdFx0aWYgKHdpbmRvdy5pc19nbSkge1xuXHRcdFx0JC5nZXQoYC9jYW1wYWlnbnMvc2hhcmVsaW5rLyR7d2luZG93LmNhbXBhaWduX2lkfWAsIChiaXRseSkgPT4ge1xuXHRcdFx0XHRkMjAudGV4dGNoYXQuaW5jb21pbmcoZmFsc2UsIHtcblx0XHRcdFx0XHR3aG86ICdzeXN0ZW0nLFxuXHRcdFx0XHRcdHR5cGU6ICdzeXN0ZW0nLFxuXHRcdFx0XHRcdGNvbnRlbnQ6IGA8aDEgc3R5bGU9XCJmb250LXNpemU6IDEuMmVtO1wiPkludml0ZSBQbGF5ZXJzPC9oMT4ke2kxOG4oXG5cdFx0XHRcdFx0XHQnY2hhdF9jYW1wYWlnbl9saW5rJyxcblx0XHRcdFx0XHQpfTxkaXYgY2xhc3M9J3NoYXJlbGluayc+PGEgaHJlZj0nJHtiaXRseX0nPiR7Yml0bHl9PC9hPjwvZGl2PjxkaXYgc3R5bGU9J2ZvbnQtc2l6ZTogMC45ZW07Jz48L2Rpdj5gLFxuXHRcdFx0XHR9KTtcblx0XHRcdH0pO1xuXHRcdH1cblx0fTtcblxuXHRjb25zdCBwb3N0UHJvY2Vzc09wID0gZnVuY3Rpb24gKG9wLCBjYWxsYmFjaykge1xuXHRcdGNvbnN0IGxpc3RlbmVyaWQgPSBvcC5saXN0ZW5lcmlkID8gb3AubGlzdGVuZXJpZCA6IHVuZGVmaW5lZDtcblx0XHRvcC5jb250ZW50ICs9ICcnO1xuXHRcdGlmIChvcC5jb250ZW50Lm1hdGNoKHJvbGxyZSkgIT09IG51bGwpIHtcblx0XHRcdGxldCBjdXJyZW50Um9sbFR5cGUgPSAncm9sbHJlc3VsdCc7XG5cdFx0XHRpZiAob3AuY29udGVudC5tYXRjaCgvXFwvKChnbXJvbGwpfChncikpWyBdKy9pKSAhPT0gbnVsbCkge1xuXHRcdFx0XHRjdXJyZW50Um9sbFR5cGUgPSAnZ21yb2xscmVzdWx0Jztcblx0XHRcdH1cblxuXHRcdFx0ZDIwLnRleHRjaGF0LmN1cnJlbnRSb2xsVHlwZSA9IGN1cnJlbnRSb2xsVHlwZTtcblxuXHRcdFx0dHJ5IHtcblx0XHRcdFx0bGV0IHJvbGxleHByZXNzaW9uID0gb3AuY29udGVudC5yZXBsYWNlKHJvbGxyZSwgJycpO1xuXHRcdFx0XHQvLyBTdWJzdGl0dXRlIGluIHRoZSBmaW5hbCB2YWx1ZSBvZiBhbnkgaW5saW5lIHJvbGxzIGJlZm9yZSB3ZSBwcm9jZXNzIG91ciByb2xsIGV4cHJlc3Npb25zLlxuXHRcdFx0XHRyb2xsZXhwcmVzc2lvbiA9IHJvbGxleHByZXNzaW9uLnJlcGxhY2UoXG5cdFx0XHRcdFx0L1xcJFxcW1xcW1swLTldK1xcXVxcXS9nLFxuXHRcdFx0XHRcdChpbmxpbmVtYXRjaCkgPT4ge1xuXHRcdFx0XHRcdFx0Y29uc3QgaW5saW5lcm9sbGluZGV4ID0gaW5saW5lbWF0Y2guc3Vic3RyaW5nKFxuXHRcdFx0XHRcdFx0XHQzLFxuXHRcdFx0XHRcdFx0XHRpbmxpbmVtYXRjaC5sZW5ndGggLSAxLFxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdGNvbnN0IGlubGluZXJvbGwgPSBvcC5pbmxpbmVyb2xsc1twYXJzZUludChpbmxpbmVyb2xsaW5kZXgsIDEwKV07XG5cdFx0XHRcdFx0XHRpZiAoaW5saW5lcm9sbCkge1xuXHRcdFx0XHRcdFx0XHRyZXR1cm4gaW5saW5lcm9sbC5yZXN1bHRzLnRvdGFsO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0cmV0dXJuICdJTlZBTElEIElOTElORSBST0xMJztcblx0XHRcdFx0XHR9LFxuXHRcdFx0XHQpO1xuXG5cdFx0XHRcdGQyMC51dGlscy50ZXh0Y2hhdE5vdGlmeSgnUm9sbGluZyB0aGUgZGljZS4uLicpO1xuXG5cdFx0XHRcdGQyMC50ZXh0Y2hhdC5kaWNlZW5naW5lLnByb2Nlc3MoXG5cdFx0XHRcdFx0cm9sbGV4cHJlc3Npb24sXG5cdFx0XHRcdFx0KHJlc3VsdHMsIHJvbGxpZCwgc2lnbmF0dXJlLCB0ZHNlZWQpID0+IHtcblx0XHRcdFx0XHRcdGQyMC50ZXh0Y2hhdC5nbG9iYWxyb2xsZWQrKztcblxuXHRcdFx0XHRcdFx0ZDIwLnV0aWxzLnRleHRjaGF0Tm90aWZ5KGZhbHNlKTtcblxuXHRcdFx0XHRcdFx0aWYgKHJlc3VsdHMuZXJyb3IpIHtcblx0XHRcdFx0XHRcdFx0Y29uc3QgZW9wID0ge1xuXHRcdFx0XHRcdFx0XHRcdHdobzogJ2Vycm9yJyxcblx0XHRcdFx0XHRcdFx0XHR0eXBlOiAnZXJyb3InLFxuXHRcdFx0XHRcdFx0XHRcdGNvbnRlbnQ6IHJlc3VsdHMuZXJyb3IsXG5cdFx0XHRcdFx0XHRcdH07XG5cdFx0XHRcdFx0XHRcdGQyMC50ZXh0Y2hhdC5pbmNvbWluZyhmYWxzZSwgZW9wKTtcblx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdGlmIChyZXN1bHRzLnJvbGxzICYmIHJlc3VsdHMucm9sbHMubGVuZ3RoID4gMCkge1xuXHRcdFx0XHRcdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRjb25zdCBfdGFibGVSZXN1bHQgPSBkMjAudGV4dGNoYXQuc3ViVGFibGVzKHJlc3VsdHMucm9sbHMsIDApO1xuXG5cdFx0XHRcdFx0XHRcdFx0XHRpZiAoX3RhYmxlUmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0c2lnbmF0dXJlID0gbnVsbDtcblx0XHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRjb25zb2xlLmxvZygnRVJST1IgbWF0Y2hpbmcgdGFibGUnKTtcblx0XHRcdFx0XHRcdFx0XHRcdGNvbnNvbGUubG9nKGUpO1xuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdGNvbnN0IG5ld29wID0ge1xuXHRcdFx0XHRcdFx0XHRcdHdobzogZDIwLnRleHRjaGF0LiRzcGVha2luZ2FzLmZpbmQoJ29wdGlvbjpzZWxlY3RlZCcpLnRleHQoKSxcblx0XHRcdFx0XHRcdFx0XHR0eXBlOiBjdXJyZW50Um9sbFR5cGUsXG5cdFx0XHRcdFx0XHRcdFx0Y29udGVudDogSlNPTi5zdHJpbmdpZnkocmVzdWx0cyksXG5cdFx0XHRcdFx0XHRcdFx0c2lnbmF0dXJlLFxuXHRcdFx0XHRcdFx0XHRcdG9yaWdSb2xsOiBvcC5jb250ZW50LnJlcGxhY2Uocm9sbHJlLCAnJyksXG5cdFx0XHRcdFx0XHRcdFx0cGxheWVyaWQ6IHdpbmRvdy5jdXJyZW50UGxheWVyLmlkLFxuXHRcdFx0XHRcdFx0XHRcdGF2YXRhcjogb3AuYXZhdGFyLFxuXHRcdFx0XHRcdFx0XHRcdF9mYmlkOiByb2xsaWQsXG5cdFx0XHRcdFx0XHRcdH07XG5cblx0XHRcdFx0XHRcdFx0aWYgKGxpc3RlbmVyaWQpIHtcblx0XHRcdFx0XHRcdFx0XHRuZXdvcC5saXN0ZW5lcmlkID0gbGlzdGVuZXJpZDtcblx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdGlmICh0ZHNlZWQpIHtcblx0XHRcdFx0XHRcdFx0XHRuZXdvcC50ZHNlZWQgPSB0ZHNlZWQ7XG5cdFx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0XHRpZiAob3AgJiYgb3Aub3B0cyAmJiBvcC5vcHRzLnRyYWNrZXIpIHtcblx0XHRcdFx0XHRcdFx0XHQvLyBTZW5kIHRoZSByZXN1bHQgdG8gdGhlIHRyYWNrZXIuXG5cdFx0XHRcdFx0XHRcdFx0c2VuZFJlc3VsdFRvVHJhY2tlcihcblx0XHRcdFx0XHRcdFx0XHRcdG9wLmN1cnJlbnRTZWxlY3RlZCxcblx0XHRcdFx0XHRcdFx0XHRcdHJlc3VsdHMsXG5cdFx0XHRcdFx0XHRcdFx0XHRvcC5vcHRzLnRyYWNrZXIsXG5cdFx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdGNhbGxiYWNrKG5ld29wKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdGQyMC50ZXh0Y2hhdC5yb2xsX2Vycm9yX2NhbGxiYWNrLFxuXHRcdFx0XHQpO1xuXHRcdFx0fSBjYXRjaCAoZSkge1xuXHRcdFx0XHRjb25zb2xlLmxvZyhlKTtcblx0XHRcdFx0dmFyIGVvcCA9IHtcblx0XHRcdFx0XHR3aG86ICdlcnJvcicsXG5cdFx0XHRcdFx0dHlwZTogJ2Vycm9yJyxcblx0XHRcdFx0XHRjb250ZW50OiB0eXBlb2YgZSA9PT0gJ3N0cmluZycgPyBlIDogJ1RoZXJlIHdhcyBhbiBlcnJvciB3aXRoIHlvdXIgZm9ybXVsYS4gUGxlYXNlIHRyeSBhZ2Fpbi4nLFxuXHRcdFx0XHR9O1xuXHRcdFx0XHRkMjAudGV4dGNoYXQuaW5jb21pbmcoZmFsc2UsIGVvcCk7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIGlmIChcblx0XHRcdG9wLmNvbnRlbnQuc3Vic3RyaW5nKDAsIDQpID09PSAnL2VtICcgfHwgb3AuY29udGVudC5zdWJzdHJpbmcoMCwgMykgPT0gJy9lICcgfHwgb3AuY29udGVudC5zdWJzdHJpbmcoMCwgNCkgPT0gJy9tZSAnXG5cdFx0KSB7XG5cdFx0XHRjb25zdCBlbW90ZSA9IG9wLmNvbnRlbnRcblx0XHRcdFx0LnJlcGxhY2UoJy9lbSAnLCAnJylcblx0XHRcdFx0LnJlcGxhY2UoJy9lICcsICcnKVxuXHRcdFx0XHQucmVwbGFjZSgnL21lICcsICcnKTtcblxuXHRcdFx0dmFyIG5ld29wID0ge1xuXHRcdFx0XHR3aG86IGQyMC50ZXh0Y2hhdC4kc3BlYWtpbmdhcy5maW5kKCdvcHRpb246c2VsZWN0ZWQnKS50ZXh0KCksXG5cdFx0XHRcdHR5cGU6ICdlbW90ZScsXG5cdFx0XHRcdGNvbnRlbnQ6IGVtb3RlLFxuXHRcdFx0XHRwbGF5ZXJpZDogd2luZG93LmN1cnJlbnRQbGF5ZXIuaWQsXG5cdFx0XHRcdGF2YXRhcjogb3AuYXZhdGFyLFxuXHRcdFx0fTtcblxuXHRcdFx0aWYgKGxpc3RlbmVyaWQpIHtcblx0XHRcdFx0bmV3b3AubGlzdGVuZXJpZCA9IGxpc3RlbmVyaWQ7XG5cdFx0XHR9XG5cblx0XHRcdGNhbGxiYWNrKG5ld29wKTtcblx0XHR9IGVsc2UgaWYgKFxuXHRcdFx0b3AuY29udGVudC5zdWJzdHJpbmcoMCwgNSkgPT09ICcvb29jICcgfHwgb3AuY29udGVudC5zdWJzdHJpbmcoMCwgMykgPT09ICcvbyAnXG5cdFx0KSB7XG5cdFx0XHR2YXIgY29udGVudCA9IG9wLmNvbnRlbnQucmVwbGFjZSgnL29vYyAnLCAnJykucmVwbGFjZSgnL28gJywgJycpO1xuXG5cdFx0XHR2YXIgbmV3b3AgPSB7XG5cdFx0XHRcdHdobzogZDIwLnRleHRjaGF0LiRzcGVha2luZ2FzLmZpbmQoJ29wdGlvbjpmaXJzdC1jaGlsZCcpLnRleHQoKSxcblx0XHRcdFx0dHlwZTogJ2dlbmVyYWwnLFxuXHRcdFx0XHRwbGF5ZXJpZDogd2luZG93LmN1cnJlbnRQbGF5ZXIuaWQsXG5cdFx0XHRcdGNvbnRlbnQsXG5cdFx0XHRcdGF2YXRhcjogYC91c2Vycy9hdmF0YXIvJHt3aW5kb3cuY3VycmVudFBsYXllci5nZXQoJ2QyMHVzZXJpZCcpfS8zMGAsXG5cdFx0XHR9O1xuXG5cdFx0XHRpZiAobGlzdGVuZXJpZCkge1xuXHRcdFx0XHRuZXdvcC5saXN0ZW5lcmlkID0gbGlzdGVuZXJpZDtcblx0XHRcdH1cblxuXHRcdFx0Y2FsbGJhY2sobmV3b3ApO1xuXHRcdH0gZWxzZSBpZiAod2luZG93LmlzX2dtICYmIG9wLmNvbnRlbnQuc3Vic3RyaW5nKDAsIDQpID09PSAnL2FzICcpIHtcblx0XHRcdHZhciBjb250ZW50ID0gb3AuY29udGVudC5zdWJzdHJpbmcoNCwgb3AuY29udGVudC5sZW5ndGgpO1xuXHRcdFx0dmFyIG1hdGNoID0gY29udGVudC5tYXRjaCgvXFx3K3xcIlteXCJdK1wiLyk7XG5cdFx0XHRpZiAobWF0Y2ggIT0gbnVsbCAmJiBtYXRjaC5sZW5ndGgpIHtcblx0XHRcdFx0Y29udGVudCA9IGNvbnRlbnQuc3Vic3RyaW5nKG1hdGNoWzBdLmxlbmd0aCwgY29udGVudC5sZW5ndGgpO1xuXHRcdFx0XHR2YXIgbmV3b3AgPSB7XG5cdFx0XHRcdFx0d2hvOiBtYXRjaFswXVswXSA9PT0gJ1wiJyA/IG1hdGNoWzBdLnN1YnN0cmluZygxLCBtYXRjaFswXS5sZW5ndGggLSAxKSA6IG1hdGNoWzBdLFxuXHRcdFx0XHRcdHR5cGU6ICdnZW5lcmFsJyxcblx0XHRcdFx0XHRwbGF5ZXJpZDogd2luZG93LmN1cnJlbnRQbGF5ZXIuaWQsXG5cdFx0XHRcdFx0Y29udGVudCxcblx0XHRcdFx0fTtcblxuXHRcdFx0XHRpZiAobGlzdGVuZXJpZCkge1xuXHRcdFx0XHRcdG5ld29wLmxpc3RlbmVyaWQgPSBsaXN0ZW5lcmlkO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0Y2FsbGJhY2sobmV3b3ApO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhyb3cgJ0ludmFsaWQuIFRyeSAvYXMgXCJOYW1lIG9mIENoYXJhY3RlclwiIDxtZXNzYWdlPic7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIGlmICh3aW5kb3cuaXNfZ20gJiYgb3AuY29udGVudC5zdWJzdHJpbmcoMCwgNikgPT09ICcvZW1hcyAnKSB7XG5cdFx0XHR2YXIgY29udGVudCA9IG9wLmNvbnRlbnQuc3Vic3RyaW5nKDYsIG9wLmNvbnRlbnQubGVuZ3RoKTtcblx0XHRcdHZhciBtYXRjaCA9IGNvbnRlbnQubWF0Y2goL1xcdyt8XCJbXlwiXStcIi8pO1xuXHRcdFx0aWYgKG1hdGNoICE9IG51bGwgJiYgbWF0Y2gubGVuZ3RoKSB7XG5cdFx0XHRcdGNvbnRlbnQgPSBjb250ZW50LnN1YnN0cmluZyhtYXRjaFswXS5sZW5ndGgsIGNvbnRlbnQubGVuZ3RoKTtcblx0XHRcdFx0dmFyIG5ld29wID0ge1xuXHRcdFx0XHRcdHdobzogbWF0Y2hbMF1bMF0gPT09ICdcIicgPyBtYXRjaFswXS5zdWJzdHJpbmcoMSwgbWF0Y2hbMF0ubGVuZ3RoIC0gMSkgOiBtYXRjaFswXSxcblx0XHRcdFx0XHR0eXBlOiAnZW1vdGUnLFxuXHRcdFx0XHRcdHBsYXllcmlkOiB3aW5kb3cuY3VycmVudFBsYXllci5pZCxcblx0XHRcdFx0XHRjb250ZW50LFxuXHRcdFx0XHR9O1xuXG5cdFx0XHRcdGlmIChsaXN0ZW5lcmlkKSB7XG5cdFx0XHRcdFx0bmV3b3AubGlzdGVuZXJpZCA9IGxpc3RlbmVyaWQ7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRjYWxsYmFjayhuZXdvcCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0aHJvdyAnSW52YWxpZC4gVHJ5IC9hcyBcIk5hbWUgb2YgQ2hhcmFjdGVyXCIgPG1lc3NhZ2U+Jztcblx0XHRcdH1cblx0XHR9IGVsc2UgaWYgKHdpbmRvdy5pc19nbSAmJiBvcC5jb250ZW50LnN1YnN0cmluZygwLCA2KSA9PT0gJy9kZXNjICcpIHtcblx0XHRcdHZhciBjb250ZW50ID0gb3AuY29udGVudC5zdWJzdHJpbmcoNiwgb3AuY29udGVudC5sZW5ndGgpO1xuXHRcdFx0dmFyIG5ld29wID0ge1xuXHRcdFx0XHR3aG86ICcnLFxuXHRcdFx0XHR0eXBlOiAnZGVzYycsXG5cdFx0XHRcdHBsYXllcmlkOiB3aW5kb3cuY3VycmVudFBsYXllci5pZCxcblx0XHRcdFx0Y29udGVudCxcblx0XHRcdH07XG5cblx0XHRcdGlmIChsaXN0ZW5lcmlkKSB7XG5cdFx0XHRcdG5ld29wLmxpc3RlbmVyaWQgPSBsaXN0ZW5lcmlkO1xuXHRcdFx0fVxuXG5cdFx0XHRjYWxsYmFjayhuZXdvcCk7XG5cdFx0fSBlbHNlIGlmIChvcC5jb250ZW50LnN1YnN0cmluZygwLCAzKSA9PT0gJy93ICcpIHtcblx0XHRcdGNvbnN0IHMgPSBvcC5jb250ZW50LnNwbGl0KCcgJyk7XG5cdFx0XHRsZXQgbXMgPSBzLnNsaWNlKDIsIHMubGVuZ3RoKTtcblx0XHRcdGNvbnN0IHdoaXNwZXJyZWcgPSAvXFxcIihbXlwiXSspXFxcIi9pO1xuXHRcdFx0dmFyIHRhcmdldCA9IHNbMV07XG5cdFx0XHRsZXQgbWF0Y2hmdW5jID0gZnVuY3Rpb24gKGlucHV0LCB0b21hdGNoKSB7XG5cdFx0XHRcdHJldHVybiBpbnB1dC5zcGxpdCgnICcpWzBdLnRvTG93ZXJDYXNlKCkgPT09IHRvbWF0Y2gudG9Mb3dlckNhc2UoKTtcblx0XHRcdH07XG5cblx0XHRcdGlmIChzWzFdLnN1YnN0cmluZygwLCAxKSA9PT0gJ1wiJykge1xuXHRcdFx0XHRjb25zdCByZWdzZWFyY2ggPSB3aGlzcGVycmVnLmV4ZWMob3AuY29udGVudCk7XG5cdFx0XHRcdGlmIChyZWdzZWFyY2gpIHtcblx0XHRcdFx0XHR0YXJnZXQgPSByZWdzZWFyY2hbMV07XG5cdFx0XHRcdFx0bXMgPSBvcC5jb250ZW50XG5cdFx0XHRcdFx0XHQucmVwbGFjZSh3aGlzcGVycmVnLCAoX21hdGNoKSA9PiAnJylcblx0XHRcdFx0XHRcdC5zcGxpdCgnICcpXG5cdFx0XHRcdFx0XHQuc2xpY2UoMSwgcy5sZW5ndGgpO1xuXHRcdFx0XHRcdG1hdGNoZnVuYyA9IGZ1bmN0aW9uIChpbnB1dCwgdG9tYXRjaCkge1xuXHRcdFx0XHRcdFx0cmV0dXJuIGlucHV0LnRvTG93ZXJDYXNlKCkgPT09IHRvbWF0Y2gudG9Mb3dlckNhc2UoKTtcblx0XHRcdFx0XHR9O1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdC8vIFRyeSB0byBmaW5kIHRoZSB0YXJnZXQncyBpZC5cblx0XHRcdHZhciB0YXJnZXRpZCA9IDA7XG5cdFx0XHRsZXQgdGFyZ2V0bmFtZTtcblx0XHRcdGlmICh0YXJnZXQudG9Mb3dlckNhc2UoKSA9PSAnZ20nKSB7XG5cdFx0XHRcdHRhcmdldGlkID0gJ2dtJztcblx0XHRcdFx0dGFyZ2V0bmFtZSA9ICdHTSc7XG5cdFx0XHR9XG5cdFx0XHRpZiAodGFyZ2V0aWQgPT0gMCkge1xuXHRcdFx0XHQvLyBDaGVjayBwbGF5ZXJzLlxuXHRcdFx0XHRkMjAuQ2FtcGFpZ24ucGxheWVycy5lYWNoKChwbGF5ZXIpID0+IHtcblx0XHRcdFx0XHRpZiAobWF0Y2hmdW5jKHBsYXllci5nZXQoJ2Rpc3BsYXluYW1lJyksIHRhcmdldCkpIHtcblx0XHRcdFx0XHRcdHRhcmdldGlkID0gcGxheWVyLmlkO1xuXHRcdFx0XHRcdFx0dGFyZ2V0bmFtZSA9IHBsYXllci5nZXQoJ2Rpc3BsYXluYW1lJyk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblx0XHRcdH1cblx0XHRcdGlmICh0YXJnZXRpZCA9PSAwKSB7XG5cdFx0XHRcdC8vIENoZWNrIGNoYXJhY3RlcnMuXG5cdFx0XHRcdGQyMC5DYW1wYWlnbi5jaGFyYWN0ZXJzLmVhY2goKGNoYXJhY3RlcikgPT4ge1xuXHRcdFx0XHRcdGlmIChtYXRjaGZ1bmMoY2hhcmFjdGVyLmdldCgnbmFtZScpLCB0YXJnZXQpKSB7XG5cdFx0XHRcdFx0XHQvLyBXaG8gY29ucm9scyB0aGlzIGNoYXJhY3Rlcj9cblx0XHRcdFx0XHRcdGlmIChcblx0XHRcdFx0XHRcdFx0IWNoYXJhY3Rlci5nZXQoJ2NvbnRyb2xsZWRieScpIHx8IGNoYXJhY3Rlci5nZXQoJ2NvbnRyb2xsZWRieScpID09ICcnXG5cdFx0XHRcdFx0XHQpIHtcblx0XHRcdFx0XHRcdFx0dGFyZ2V0aWQgPSAnZ20nO1xuXHRcdFx0XHRcdFx0XHR0YXJnZXRuYW1lID0gJ0dNJztcblx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdHRhcmdldGlkID0gY2hhcmFjdGVyLmdldCgnY29udHJvbGxlZGJ5Jyk7XG5cdFx0XHRcdFx0XHRcdHRhcmdldG5hbWUgPSBjaGFyYWN0ZXIuZ2V0KCduYW1lJyk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKHRhcmdldGlkID09IDApIHtcblx0XHRcdFx0dmFyIGVvcCA9IHtcblx0XHRcdFx0XHR3aG86ICdlcnJvcicsXG5cdFx0XHRcdFx0dHlwZTogJ2Vycm9yJyxcblx0XHRcdFx0XHRjb250ZW50OiBgVW5hYmxlIHRvIGZpbmQgYSBwbGF5ZXIgb3IgY2hhcmFjdGVyIHdpdGggbmFtZTogJHt0YXJnZXR9YCxcblx0XHRcdFx0fTtcblx0XHRcdFx0ZDIwLnRleHRjaGF0LmluY29taW5nKGZhbHNlLCBlb3ApO1xuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cdFx0XHRjb25zdCBtZXNzYWdlID0gbXMuam9pbignICcpO1xuXHRcdFx0dmFyIG5ld29wID0ge1xuXHRcdFx0XHR3aG86IGQyMC50ZXh0Y2hhdC4kc3BlYWtpbmdhcy5maW5kKCdvcHRpb246c2VsZWN0ZWQnKS50ZXh0KCksXG5cdFx0XHRcdHR5cGU6ICd3aGlzcGVyJyxcblx0XHRcdFx0dGFyZ2V0OiB0YXJnZXRpZCxcblx0XHRcdFx0dGFyZ2V0X25hbWU6IHRhcmdldG5hbWUsXG5cdFx0XHRcdHBsYXllcmlkOiB3aW5kb3cuY3VycmVudFBsYXllci5pZCxcblx0XHRcdFx0Y29udGVudDogbWVzc2FnZSxcblx0XHRcdFx0YXZhdGFyOiBvcC5hdmF0YXIsXG5cdFx0XHR9O1xuXG5cdFx0XHRpZiAobGlzdGVuZXJpZCkge1xuXHRcdFx0XHRuZXdvcC5saXN0ZW5lcmlkID0gbGlzdGVuZXJpZDtcblx0XHRcdH1cblx0XHRcdGNhbGxiYWNrKG5ld29wKTtcblx0XHR9IGVsc2UgaWYgKG9wLmNvbnRlbnQuc3Vic3RyaW5nKDAsIDUpID09ICcvc2F5ICcpIHtcblx0XHRcdGNvbnN0IHNwZWFrdGV4dCA9IG9wLmNvbnRlbnQucmVwbGFjZSgnL3NheSAnLCAnJyk7XG5cdFx0XHRjb25zdCBzcGVha2FzID0gZDIwLnRleHRjaGF0LiRzcGVha2luZ2FzLnZhbCgpO1xuXG5cdFx0XHRvcC5jb250ZW50ID0gc3BlYWt0ZXh0O1xuXG5cdFx0XHRjYWxsYmFjayhuZXdvcCk7XG5cblx0XHRcdGlmIChzcGVha2FzLmluZGV4T2YoJ2NoYXJhY3RlcnwnKSA9PT0gLTEpIHtcblx0XHRcdFx0Ly8gb25seSBkbyBidWJibGVzIGlmIHdlIGFyZSBzcGVha2luZyBhcyBhIGNoYXJhY3Rlci5cblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXHRcdFx0Y29uc3QgY2hhcmlkID0gc3BlYWthcy5zcGxpdCgnfCcpWzFdO1xuXG5cdFx0XHRjb25zdCBzaG91dCA9IHtcblx0XHRcdFx0dHlwZTogJ3NheScsXG5cdFx0XHRcdGNoYXJhY3RlcmlkOiBjaGFyaWQsXG5cdFx0XHRcdGNvbnRlbnQ6IHNwZWFrdGV4dCxcblx0XHRcdH07XG5cblx0XHRcdGlmIChsaXN0ZW5lcmlkKSB7XG5cdFx0XHRcdHNob3V0Lmxpc3RlbmVyaWQgPSBsaXN0ZW5lcmlkO1xuXHRcdFx0fVxuXHRcdH0gZWxzZSBpZiAob3AuY29udGVudC5zdWJzdHJpbmcoMCwgNCkgPT0gJy9meCAnKSB7XG5cdFx0XHRjb25zdCBmeG9wdHMgPSBvcC5jb250ZW50LnNwbGl0KCcgJyk7XG5cdFx0XHRsZXQgYWltZWQgPSBmYWxzZTtcblx0XHRcdHZhciB0YXJnZXQgPSBvcC5jdXJyZW50U2VsZWN0ZWQ7XG5cdFx0XHRsZXQgZGVzdGluYXRpb24gPSBmYWxzZTtcblx0XHRcdGxldCBmeE5hbWUgPSBmeG9wdHNbMV07XG5cdFx0XHRjb25zdCB0eXBlYmFzZSA9IGZ4TmFtZS5pbmRleE9mKCctJykgPiAtMSA/IGZ4TmFtZS5zcGxpdCgnLScpWzBdIDogZnhOYW1lO1xuXHRcdFx0Ly8gQUlNRUQgRUZGRUNUP1xuXHRcdFx0aWYgKGQyMC5meC5wcmVzZXRFZmZlY3RzW3R5cGViYXNlXSkge1xuXHRcdFx0XHRpZiAoZDIwLmZ4LnByZXNldEVmZmVjdHNbdHlwZWJhc2VdLmFuZ2xlID09PSAtMSkge1xuXHRcdFx0XHRcdGFpbWVkID0gdHJ1ZTtcblx0XHRcdFx0fVxuXHRcdFx0fSBlbHNlIGlmICh3aW5kb3cuQ2FtcGFpZ24uY3VzdEZ4KSB7XG5cdFx0XHRcdGNvbnN0IGN1c3RvbUZ4ID0gd2luZG93LkNhbXBhaWduLmN1c3RGeC5maWx0ZXIoXG5cdFx0XHRcdFx0KGZ4KSA9PiBmeC5nZXQoJ25hbWUnKS50b0xvd2VyQ2FzZSgpID09PSB0eXBlYmFzZS50b0xvd2VyQ2FzZSgpLFxuXHRcdFx0XHQpWzBdO1xuXHRcdFx0XHRpZiAoY3VzdG9tRngpIHtcblx0XHRcdFx0XHRmeE5hbWUgPSBjdXN0b21GeC5pZDtcblx0XHRcdFx0XHRjb25zdCBkZWZpbml0aW9uID0gd2luZG93LkNhbXBhaWduLmN1c3RGeFxuXHRcdFx0XHRcdFx0LmdldChmeE5hbWUpXG5cdFx0XHRcdFx0XHQuZ2V0KCdkZWZpbml0aW9uJyk7XG5cdFx0XHRcdFx0aWYgKGRlZmluaXRpb24uYW5nbGUgPT09IC0xKSB7XG5cdFx0XHRcdFx0XHRhaW1lZCA9IHRydWU7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0XHQvLyBBRERJTkcgREVGQVVMVCBEVVJBVElPTiBJRiBOT1QgU0VUXG5cdFx0XHRpZiAoZnhOYW1lLmluZGV4T2YoJ3wnKSA9PT0gLTEpIHtcblx0XHRcdFx0ZnhOYW1lICs9ICd8ZHVyYXRpb246MjUnO1xuXHRcdFx0fSBlbHNlIGlmIChmeE5hbWUuaW5kZXhPZignZHVyYXRpb24nKSA9PT0gLTEpIHtcblx0XHRcdFx0ZnhOYW1lICs9ICcsZHVyYXRpb246MjUnO1xuXHRcdFx0fVxuXHRcdFx0Ly8gQ1VTVE9NIFRBUkdFVD9cblx0XHRcdGlmIChmeG9wdHMubGVuZ3RoID4gMikge1xuXHRcdFx0XHR2YXIgdGFyZ2V0aWQgPSBmeG9wdHNbMl07XG5cdFx0XHRcdHRhcmdldCA9IGQyMC5DYW1wYWlnbi5hY3RpdmVQYWdlKCkudGhlZ3JhcGhpY3MuZ2V0KHRhcmdldGlkKS52aWV3XG5cdFx0XHRcdFx0LmdyYXBoaWM7XG5cdFx0XHR9XG5cdFx0XHQvLyBDVVNUT00gREVTVElOQVRJT04/XG5cdFx0XHRpZiAoZnhvcHRzLmxlbmd0aCA+IDMpIHtcblx0XHRcdFx0Y29uc3QgZGVzdGluYXRpb25pZCA9IGZ4b3B0c1szXTtcblx0XHRcdFx0ZGVzdGluYXRpb24gPSBkMjAuQ2FtcGFpZ24uYWN0aXZlUGFnZSgpLnRoZWdyYXBoaWNzLmdldChkZXN0aW5hdGlvbmlkKVxuXHRcdFx0XHRcdC52aWV3LmdyYXBoaWM7XG5cdFx0XHR9XG5cdFx0XHRpZiAoIXRhcmdldCkge1xuXHRcdFx0XHR2YXIgZW9wID0ge1xuXHRcdFx0XHRcdHdobzogJ2Vycm9yJyxcblx0XHRcdFx0XHR0eXBlOiAnZXJyb3InLFxuXHRcdFx0XHRcdGNvbnRlbnQ6ICdUaGUgL2Z4IGNvbW1hbmQgcmVxdWlyZXMgYSBzZWxlY3RlZCB0b2tlbiBvciB0b2tlbiBJRCwgYnV0IG5vbmUgd2FzIHByb3ZpZGVkLiBTZWxlY3QgYSB0b2tlbiBhbmQgdHJ5IGFnYWluLicsXG5cdFx0XHRcdH07XG5cdFx0XHRcdGQyMC50ZXh0Y2hhdC5pbmNvbWluZyhmYWxzZSwgZW9wKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGNvbnN0IHggPSB0YXJnZXQubGVmdDtcblx0XHRcdFx0Y29uc3QgeSA9IHRhcmdldC50b3A7XG5cdFx0XHRcdGlmIChhaW1lZCkge1xuXHRcdFx0XHRcdGlmIChkZXN0aW5hdGlvbikge1xuXHRcdFx0XHRcdFx0Y29uc3QgdmVsb2NpdHlJbmZvID0ge307XG5cdFx0XHRcdFx0XHR2ZWxvY2l0eUluZm8uZGlzdGFuY2UgPSBnZXREaXN0KFxuXHRcdFx0XHRcdFx0XHRkZXN0aW5hdGlvbi5sZWZ0IC0gdGFyZ2V0LmxlZnQsXG5cdFx0XHRcdFx0XHRcdGRlc3RpbmF0aW9uLnRvcCAtIHRhcmdldC50b3AsXG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0dmVsb2NpdHlJbmZvLmFuZ2xlID0gZ2V0QW5nbGUoXG5cdFx0XHRcdFx0XHRcdGRlc3RpbmF0aW9uLmxlZnQgLSB0YXJnZXQubGVmdCxcblx0XHRcdFx0XHRcdFx0ZGVzdGluYXRpb24udG9wIC0gdGFyZ2V0LnRvcCxcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRkMjAuZnguc3Bhd25GeCh4LCB5LCBmeE5hbWUsIHZlbG9jaXR5SW5mbyk7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdGQyMC5meC5hZ2VuY3lGeChcblx0XHRcdFx0XHRcdFx0KHZlbG9jaXR5SW5mbykgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdGQyMC5meC5zcGF3bkZ4KHgsIHksIGZ4TmFtZSwgdmVsb2NpdHlJbmZvKTtcblx0XHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdFx0eCxcblx0XHRcdFx0XHRcdFx0eSxcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdGQyMC5meC5zcGF3bkZ4KHgsIHksIGZ4TmFtZSk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0Y2FsbGJhY2soJ25vb3AnKTtcblx0XHR9IGVsc2UgaWYgKFxuXHRcdFx0b3AuY29udGVudC5zdWJzdHJpbmcoMCwgMTYpID09PSAnL3RhbGt0b215c2VsZiBvbicgfHwgb3AuY29udGVudCA9PT0gJy90YWxrdG9teXNlbGYnIHx8IG9wLmNvbnRlbnQuc3Vic3RyaW5nKDAsIDE3KSA9PT0gJy90YWxrdG9teXNlbGYgb2ZmJ1xuXHRcdCkge1xuXHRcdFx0aWYgKFxuXHRcdFx0XHRvcC5jb250ZW50LnN1YnN0cmluZygwLCAxNikgPT09ICcvdGFsa3RvbXlzZWxmIG9uJyB8fCAob3AuY29udGVudCA9PT0gJy90YWxrdG9teXNlbGYnICYmIGQyMC50ZXh0Y2hhdC50YWxrdG9teXNlbGYgPT09IGZhbHNlKVxuXHRcdFx0KSB7XG5cdFx0XHRcdGQyMC50ZXh0Y2hhdC50YWxrdG9teXNlbGYgPSB0cnVlO1xuXG5cdFx0XHRcdHZhciBlb3AgPSB7XG5cdFx0XHRcdFx0d2hvOiAnc3lzdGVtJyxcblx0XHRcdFx0XHR0eXBlOiAnc3lzdGVtJyxcblx0XHRcdFx0XHRjb250ZW50OiAnPHN0cm9uZz5Zb3UgYXJlIG5vdyB0YWxraW5nIHRvIHlvdXJzZWxmLjwvc3Ryb25nPiBDaGF0IG1lc3NhZ2VzIGFuZCBkaWNlIHJvbGxzIHdpbGwgPHN0cm9uZz5OT1QgQkUgQlJPQURDQVNUPC9zdHJvbmc+IHRvIG90aGVycyB1bnRpbCB5b3UgdHVybiB0aGlzIG9mZi4gVXNlIDxjb2RlPi90YWxrdG9teXNlbGYgb2ZmPC9jb2RlPiB0byBkaXNhYmxlLicsXG5cdFx0XHRcdH07XG5cblx0XHRcdFx0ZDIwLnRleHRjaGF0LmluY29taW5nKGZhbHNlLCBlb3ApO1xuXG5cdFx0XHRcdGQyMC51dGlscy50ZXh0Y2hhdE5vdGlmeSgnVGFsa2luZyB0byBZb3Vyc2VsZicsIHRydWUpO1xuXHRcdFx0fSBlbHNlIGlmIChcblx0XHRcdFx0b3AuY29udGVudC5zdWJzdHJpbmcoMCwgMTcpID09PSAnL3RhbGt0b215c2VsZiBvZmYnIHx8IChvcC5jb250ZW50ID09PSAnL3RhbGt0b215c2VsZicgJiYgZDIwLnRleHRjaGF0LnRhbGt0b215c2VsZiA9PT0gdHJ1ZSlcblx0XHRcdCkge1xuXHRcdFx0XHRkMjAudGV4dGNoYXQudGFsa3RvbXlzZWxmID0gZmFsc2U7XG5cblx0XHRcdFx0dmFyIGVvcCA9IHtcblx0XHRcdFx0XHR3aG86ICdzeXN0ZW0nLFxuXHRcdFx0XHRcdHR5cGU6ICdzeXN0ZW0nLFxuXHRcdFx0XHRcdGNvbnRlbnQ6ICc8c3Ryb25nPllvdSBhcmUgbm8gbG9uZ2VyIHRhbGtpbmcgdG8geW91cnNlbGYuPC9zdHJvbmc+IEhvb3JheSEnLFxuXHRcdFx0XHR9O1xuXG5cdFx0XHRcdGQyMC50ZXh0Y2hhdC5pbmNvbWluZyhmYWxzZSwgZW9wKTtcblxuXHRcdFx0XHRkMjAudXRpbHMudGV4dGNoYXROb3RpZnkoZmFsc2UsIHRydWUpO1xuXHRcdFx0fVxuXHRcdH0gZWxzZSBpZiAob3AuY29udGVudC5zcGxpdCgnICcpWzBdID09PSAnL2ludml0ZScpIHtcblx0XHRcdGludml0ZUxpbmtNZXNzYWdlKCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHZhciBlb3AgPSB7XG5cdFx0XHRcdHdobzogJ2Vycm9yJyxcblx0XHRcdFx0dHlwZTogJ2Vycm9yJyxcblx0XHRcdFx0Y29udGVudDogYFVucmVjb2duaXplZCBjb21tYW5kOiAke29wLmNvbnRlbnR9YCxcblx0XHRcdH07XG5cdFx0XHRkMjAudGV4dGNoYXQuaW5jb21pbmcoZmFsc2UsIGVvcCk7XG5cdFx0fVxuXHR9O1xuXG5cdHZhciBnZXRBbmdsZSA9IGZ1bmN0aW9uIChkZWx0YVgsIGRlbHRhWSkge1xuXHRcdGxldCBhbmdsZSA9IChNYXRoLmF0YW4yKGRlbHRhWSwgZGVsdGFYKSAqIDE4MCkgLyBNYXRoLlBJO1xuXHRcdGlmIChhbmdsZSA8IDApIHtcblx0XHRcdGFuZ2xlID0gMzYwICsgYW5nbGU7XG5cdFx0fVxuXG5cdFx0aWYgKGFuZ2xlICUgMTgwID4gOTApIHtcblx0XHRcdGlmIChhbmdsZSAlIDkwID4gNDUpIHtcblx0XHRcdFx0YW5nbGUgKz0gMTAgLSAoYW5nbGUgJSA0NSkgLyA0LjU7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRhbmdsZSArPSAoYW5nbGUgJSA0NSkgLyA0LjU7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIGlmIChhbmdsZSAlIDkwID4gNDUpIHtcblx0XHRcdGFuZ2xlIC09IDEwIC0gKGFuZ2xlICUgNDUpIC8gNC41O1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRhbmdsZSAtPSAoYW5nbGUgJSA0NSkgLyA0LjU7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGFuZ2xlO1xuXHR9O1xuXG5cdHZhciBnZXREaXN0ID0gZnVuY3Rpb24gKGRlbHRhWCwgZGVsdGFZKSB7XG5cdFx0cmV0dXJuIE1hdGguc3FydChNYXRoLnBvdyhkZWx0YVgsIDIpICsgTWF0aC5wb3coZGVsdGFZLCAyKSk7XG5cdH07XG5cblx0dmFyIHNlbmRSZXN1bHRUb1RyYWNrZXIgPSBmdW5jdGlvbiAoY3VycmVudFNlbGVjdGVkLCByZXN1bHRzLCBtb2RpZnl0eXBlKSB7XG5cdFx0aWYgKCFjdXJyZW50U2VsZWN0ZWQgfHwgY3VycmVudFNlbGVjdGVkLnR5cGUgIT09ICdpbWFnZScpIHtcblx0XHRcdGNvbnN0IGVvcCA9IHtcblx0XHRcdFx0d2hvOiAnZXJyb3InLFxuXHRcdFx0XHR0eXBlOiAnZXJyb3InLFxuXHRcdFx0XHRjb250ZW50OiAnWW91IHdhbnRlZCB0byBzZW5kIHRoZSByZXN1bHQgb2YgdGhpcyByb2xsIHRvIHRoZSB0dXJuIHRyYWNrZXIsIGJ1dCBubyB2YWxpZCB0b2tlbiB3YXMgc2VsZWN0ZWQhJyxcblx0XHRcdH07XG5cdFx0XHRkMjAudGV4dGNoYXQuaW5jb21pbmcoZmFsc2UsIGVvcCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdC8vIFNlZSBpZiB0aGlzIHRva2VuIGFscmVhZHkgaGFzIGEgdHVybi5cblxuXHRcdFx0ZDIwLkNhbXBhaWduLnBhcmVudFJlZlxuXHRcdFx0XHQuY2hpbGQoJ2NhbXBhaWduJylcblx0XHRcdFx0LmNoaWxkKCd0dXJub3JkZXInKVxuXHRcdFx0XHQudHJhbnNhY3Rpb24oKGN1cnJlbnRMaXN0KSA9PiB7XG5cdFx0XHRcdFx0Ly8gTWFrZSBzdXJlIG91ciBCYWNrYm9uZSBNb2RlbCBpcyB1cCB0byBkYXRlIHdpdGggdGhlIGxhdGVzdCBkYXRhLlxuXHRcdFx0XHRcdGQyMC5DYW1wYWlnbi5zZXQoJ3R1cm5vcmRlcicsIGN1cnJlbnRMaXN0KTtcblxuXHRcdFx0XHRcdGNvbnN0IGluaXRsaXN0ID0gZDIwLkNhbXBhaWduLmluaXRpYXRpdmV3aW5kb3cuY2xlYW5MaXN0KCk7XG5cdFx0XHRcdFx0bGV0IGZvdW5kZXhpc3RpbmcgPSBmYWxzZTtcblxuXHRcdFx0XHRcdGlmIChyZXN1bHRzLnRvdGFsICYmIHJlc3VsdHMudG90YWwgJSAxICE9IDApIHtcblx0XHRcdFx0XHRcdHJlc3VsdHMudG90YWwgPSBwYXJzZUZsb2F0KHJlc3VsdHMudG90YWwudG9QcmVjaXNpb24oMTIpKTsgLy8gUk9VTkRJTkcgRVJST1IgQlVHRklYXG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdF8uZWFjaChpbml0bGlzdCwgKGxpc3RpdGVtKSA9PiB7XG5cdFx0XHRcdFx0XHRpZiAobGlzdGl0ZW0uaWQgPT09IGN1cnJlbnRTZWxlY3RlZC5tb2RlbC5pZCkge1xuXHRcdFx0XHRcdFx0XHRmb3VuZGV4aXN0aW5nID0gdHJ1ZTtcblx0XHRcdFx0XHRcdFx0c3dpdGNoIChtb2RpZnl0eXBlKSB7XG5cdFx0XHRcdFx0XHRcdFx0Y2FzZSAnKyc6XG5cdFx0XHRcdFx0XHRcdFx0XHRsaXN0aXRlbS5wciA9IHBhcnNlRmxvYXQobGlzdGl0ZW0ucHIpICsgcmVzdWx0cy50b3RhbDtcblx0XHRcdFx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdFx0XHRcdGNhc2UgJy0nOlxuXHRcdFx0XHRcdFx0XHRcdFx0bGlzdGl0ZW0ucHIgPSBwYXJzZUZsb2F0KGxpc3RpdGVtLnByKSAtIHJlc3VsdHMudG90YWw7XG5cdFx0XHRcdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRcdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHRcdFx0XHRcdFx0bGlzdGl0ZW0ucHIgPSByZXN1bHRzLnRvdGFsO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0aWYgKCFmb3VuZGV4aXN0aW5nKSB7XG5cdFx0XHRcdFx0XHRpbml0bGlzdC5wdXNoKHtcblx0XHRcdFx0XHRcdFx0aWQ6IGN1cnJlbnRTZWxlY3RlZC5tb2RlbC5pZCxcblx0XHRcdFx0XHRcdFx0cHI6IHJlc3VsdHMudG90YWwsXG5cdFx0XHRcdFx0XHRcdGN1c3RvbTogJycsXG5cdFx0XHRcdFx0XHRcdF9wYWdlaWQ6IGQyMC5DYW1wYWlnbi5hY3RpdmVQYWdlKCkuaWQsXG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRyZXR1cm4gSlNPTi5zdHJpbmdpZnkoaW5pdGxpc3QpOyAvLyB3ZSByZXR1cm4gdGhlIG5ldyBkYXRhXG5cdFx0XHRcdH0pO1xuXHRcdH1cblx0fTtcblxuXHRpZiAod2luZG93LmxvY2FsU3RvcmFnZS5nZXRJdGVtKCdjb2xvclRoZW1lJykgPT09ICdkYXJrJykge1xuXHRcdCQoJyN0ZXh0Y2hhdCcpLmFkZENsYXNzKCdzaGVldC1kYXJrbW9kZScpO1xuXHR9XG5cdGQyMC50ZXh0Y2hhdC5yYXdDaGF0SW5wdXQgPSBmdW5jdGlvbiAob3ApIHtcblx0XHRjb25zdCBmaW5hbG9wID0gXy5leHRlbmQoXG5cdFx0XHR7XG5cdFx0XHRcdHdobzogZDIwLnRleHRjaGF0LiRzcGVha2luZ2FzLmZpbmQoJ29wdGlvbjpzZWxlY3RlZCcpLnRleHQoKSxcblx0XHRcdFx0dHlwZTogJ2dlbmVyYWwnLFxuXHRcdFx0XHRwbGF5ZXJpZDogd2luZG93LmN1cnJlbnRQbGF5ZXIuaWQsXG5cdFx0XHRcdGNvbnRlbnQ6ICcnLFxuXHRcdFx0fSxcblx0XHRcdG9wLFxuXHRcdCk7XG5cdFx0aWYgKGQyMC50ZXh0Y2hhdC50YWxrdG9teXNlbGYpIHtcblx0XHRcdGQyMC50ZXh0Y2hhdC5pbmNvbWluZyh0cnVlLCBmaW5hbG9wKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc3QgbmV3aWQgPSBmYnJlZi5wdXNoKCkua2V5O1xuXHRcdFx0ZmJyZWZcblx0XHRcdFx0LmNoaWxkKG5ld2lkKVxuXHRcdFx0XHQuc2V0V2l0aFByaW9yaXR5KGZpbmFsb3AsIGZpcmViYXNlLmRhdGFiYXNlLlNlcnZlclZhbHVlLlRJTUVTVEFNUCk7XG5cdFx0fVxuXHR9O1xuXG5cdGNvbnN0IHRyYW5zbGF0ZVZhcmlhYmxlVG9Ub2tlbk9yQ2hhcmFjdGVyID0gZnVuY3Rpb24gKFxuXHRcdGF0dHJuYW1lLFxuXHRcdG1vZGVsLFxuXHRcdHZhbHR5cGUsXG5cdCkge1xuXHRcdGlmIChhdHRybmFtZS50b0xvd2VyQ2FzZSgpID09ICdiYXIxJykge1xuXHRcdFx0cmV0dXJuIHZhbHR5cGUgPT0gJ21heCcgPyBtb2RlbC5nZXQoJ2JhcjFfbWF4JykgOiBtb2RlbC5nZXQoJ2JhcjFfdmFsdWUnKTtcblx0XHR9XG5cdFx0aWYgKGF0dHJuYW1lLnRvTG93ZXJDYXNlKCkgPT0gJ2JhcjInKSB7XG5cdFx0XHRyZXR1cm4gdmFsdHlwZSA9PSAnbWF4JyA/IG1vZGVsLmdldCgnYmFyMl9tYXgnKSA6IG1vZGVsLmdldCgnYmFyMl92YWx1ZScpO1xuXHRcdH1cblx0XHRpZiAoYXR0cm5hbWUudG9Mb3dlckNhc2UoKSA9PSAnYmFyMycpIHtcblx0XHRcdHJldHVybiB2YWx0eXBlID09ICdtYXgnID8gbW9kZWwuZ2V0KCdiYXIzX21heCcpIDogbW9kZWwuZ2V0KCdiYXIzX3ZhbHVlJyk7XG5cdFx0fVxuXHRcdGlmIChhdHRybmFtZS50b0xvd2VyQ2FzZSgpID09ICd0b2tlbl9uYW1lJykge1xuXHRcdFx0cmV0dXJuIG1vZGVsLmdldCgnbmFtZScpO1xuXHRcdH1cblx0XHRpZiAoYXR0cm5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ3Rva2VuX2lkJykge1xuXHRcdFx0cmV0dXJuIG1vZGVsLmlkO1xuXHRcdH1cblxuXHRcdHJldHVybiB1bmRlZmluZWQ7XG5cblx0XHQvLyBpZihtb2RlbC5nZXQoXCJyZXByZXNlbnRzXCIpICE9PSBcIlwiKSB7XG5cdFx0Ly8gY2hhcmFjdGVyID0gZDIwLkNhbXBhaWduLmNoYXJhY3RlcnMuZ2V0KG1vZGVsLmdldChcInJlcHJlc2VudHNcIikpO1xuXHRcdC8vIGlmKGF0dHJuYW1lLnRvTG93ZXJDYXNlKCkgPT0gXCJjaGFyYWN0ZXJfbmFtZVwiKSB7XG5cdFx0Ly8gXHRyZXR1cm4gY2hhcmFjdGVyLmdldChcIm5hbWVcIik7XG5cdFx0Ly8gfVxuXHRcdC8vIH1cblx0fTtcblxuXHRjb25zdCBoYW5kbGVEb0NoYXRJbnB1dCA9IGFzeW5jIChcblx0XHRpbnB1dCxcblx0XHR0cmlnZ2VyZWRfYnkgPSAnY2hhdGJveCcsXG5cdFx0bGlzdGVuZXJpZCA9IHVuZGVmaW5lZCxcblx0XHRvcmlnaW5hbFJvbGxQcm9taXNlID0gdW5kZWZpbmVkLFxuXHQpID0+IHtcblx0XHRpZiAoIWZicmVmKSB7XG5cdFx0XHRjb25zb2xlLmxvZygnTm8gZG9jdW1lbnQhJyk7XG5cdFx0XHRyZXR1cm47IC8vIEVSUk9SIVxuXHRcdH1cblxuXHRcdGlucHV0ID0gZDIwLnV0aWxzLnN0cmlwX3RhZ3MoaW5wdXQpO1xuXG5cdFx0aWYgKGlucHV0ICE9ICcnKSB7XG5cdFx0XHRkMjAudGV4dGNoYXQuY29tbWFuZGhpc3RvcnkucHVzaChpbnB1dCk7XG5cdFx0XHRkMjAudGV4dGNoYXQuY29tbWFuZGhpc3RvcnkgPSBfLmxhc3QoZDIwLnRleHRjaGF0LmNvbW1hbmRoaXN0b3J5LCAyMCk7XG5cdFx0XHRkMjAudGV4dGNoYXQuY29tbWFuZEluZGV4ID0gMDtcblxuXHRcdFx0Y29uc3Qgc3BlYWtpbmdhcyA9IGQyMC50ZXh0Y2hhdC4kc3BlYWtpbmdhcy5maW5kKCdvcHRpb246c2VsZWN0ZWQnKS52YWwoKTtcblx0XHRcdGxldCBhdmF0YXIgPSBmYWxzZTtcblx0XHRcdGlmIChzcGVha2luZ2FzLmluZGV4T2YoJ3BsYXllcicpICE9PSAtMSkge1xuXHRcdFx0XHRhdmF0YXIgPSBgL3VzZXJzL2F2YXRhci8ke3dpbmRvdy5jdXJyZW50UGxheWVyLmdldCgnZDIwdXNlcmlkJyl9LzMwYDtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGNvbnN0IGNoYXJhY3RlciA9IGQyMC5DYW1wYWlnbi5jaGFyYWN0ZXJzLmdldChzcGVha2luZ2FzLnNwbGl0KCd8JylbMV0pO1xuXHRcdFx0XHRpZiAoY2hhcmFjdGVyKSB7XG5cdFx0XHRcdFx0YXZhdGFyID0gY2hhcmFjdGVyLmdldCgnYXZhdGFyJyk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0bGV0IG9wID0ge1xuXHRcdFx0XHR3aG86IGQyMC50ZXh0Y2hhdC4kc3BlYWtpbmdhcy5maW5kKCdvcHRpb246c2VsZWN0ZWQnKS50ZXh0KCksXG5cdFx0XHRcdHR5cGU6ICdnZW5lcmFsJyxcblx0XHRcdFx0Y29udGVudDogJC50cmltKGlucHV0KSxcblx0XHRcdFx0cGxheWVyaWQ6IHdpbmRvdy5jdXJyZW50UGxheWVyLmlkLFxuXHRcdFx0XHRhdmF0YXIsXG5cdFx0XHR9O1xuXG5cdFx0XHRpZiAobGlzdGVuZXJpZCkge1xuXHRcdFx0XHRvcC5saXN0ZW5lcmlkID0gbGlzdGVuZXJpZDtcblx0XHRcdH1cblxuXHRcdFx0bGV0IG5vUGFyc2VDb21tYW5kcyA9IGZhbHNlO1xuXG5cdFx0XHRpZiAob3AuY29udGVudC5zdWJzdHJpbmcoMCwgMSkgPT09ICdgJykge1xuXHRcdFx0XHRub1BhcnNlQ29tbWFuZHMgPSB0cnVlO1xuXHRcdFx0XHRvcC5jb250ZW50ID0gb3AuY29udGVudC5zdWJzdHJpbmcoMSwgb3AuY29udGVudC5sZW5ndGgpO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCBzZWxlY3RlZCA9IGQyMC5lbmdpbmUuc2VsZWN0ZWQoKTtcblx0XHRcdGlmIChzZWxlY3RlZC5sZW5ndGggPiAwICYmIHNlbGVjdGVkWzBdLm1vZGVsKSB7XG5cdFx0XHRcdG9wLmN1cnJlbnRTZWxlY3RlZCA9IHNlbGVjdGVkWzBdO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCBtYWNyb3MgPSB7fTtcblx0XHRcdGQyMC5DYW1wYWlnbi5wbGF5ZXJzLmVhY2goKHBsYXllcikgPT4ge1xuXHRcdFx0XHRwbGF5ZXIubWFjcm9zLmVhY2goKHNob3J0Y3V0KSA9PiB7XG5cdFx0XHRcdFx0aWYgKFxuXHRcdFx0XHRcdFx0cGxheWVyLmlkID09IHdpbmRvdy5jdXJyZW50UGxheWVyLmlkIHx8IHNob3J0Y3V0LnZpc2libGVUb0N1cnJlbnRQbGF5ZXIoKVxuXHRcdFx0XHRcdCkge1xuXHRcdFx0XHRcdFx0bWFjcm9zW2AjJHtzaG9ydGN1dC5nZXQoJ25hbWUnKX1gXSA9IHNob3J0Y3V0LmdldCgnYWN0aW9uJyk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblx0XHRcdH0pO1xuXG5cdFx0XHRsZXQgcXVlcnlDYWNoZSA9IHt9O1xuXHRcdFx0bGV0IHRhcmdldENhY2hlID0ge307XG5cdFx0XHRsZXQgcHJldk1vZGUgPSBgJHtkMjAuZW5naW5lLm1vZGV9YDtcblxuXHRcdFx0Ly8gUmVzb2x2ZSBhbGwgYWJpbGl0aWVzLCB2YXJpYWJsZXMsIGFuZCBtYWNyb3MsIGxvb3BpbmcgdGhyb3VnaCBib3RoIGluIGNhc2Ugb2YgbmVzdGluZy5cblx0XHRcdGNvbnN0IHJlZyA9IC8oI1teIFxcbl0rKS9nbTtcblx0XHRcdGNvbnN0IGFiaWxyZWcgPSAvKCV7W159XSt9KS9nbTtcblx0XHRcdGNvbnN0IG9wdHJlZyA9IC8me1tefV0rfS87XG5cdFx0XHRjb25zdCB2YXJyZWcgPSAvKEB7W159XSt9KS9nbTtcblx0XHRcdGxldCBwcmV2X3Jlc29sdmVkID0gJyc7XG5cblx0XHRcdGxldCBzdWJwYXNzZXMgPSAwO1xuXG5cdFx0XHRsZXQgbWFrZVN1YnN0aXR1dGlvbnMgPSBhc3luYyAoKSA9PiB7XG5cdFx0XHRcdGNvbnN0IGNoYXJBdHRyaWJzID0gY2hhcmFjdGVyc01lbnRpb25lZChvcC5jb250ZW50LCB2YXJyZWcpO1xuXHRcdFx0XHRjb25zdCBwZW5kaW5nQXR0cmlicyA9IE9iamVjdC52YWx1ZXMoY2hhckF0dHJpYnMpLnJlZHVjZSgocHJvbWlzZXMsIGNoYXJhY3RlcikgPT4ge1xuXHRcdFx0XHRcdGlmICghY2hhcmFjdGVyLmF0dHJpYnMuYmFja2JvbmVGaXJlYmFzZSkge1xuXHRcdFx0XHRcdFx0Y2hhcmFjdGVyLmF0dHJpYnMuYmFja2JvbmVGaXJlYmFzZSA9IG5ldyBCYWNrYm9uZUZpcmViYXNlKGNoYXJhY3Rlci5hdHRyaWJzKTtcblx0XHRcdFx0XHRcdHByb21pc2VzW2NoYXJhY3Rlci5pZF0gPSBjaGFyYWN0ZXIuYXR0cmlicy5iYWNrYm9uZUZpcmViYXNlLnJlZmVyZW5jZS5vbmNlKCd2YWx1ZScpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRyZXR1cm4gcHJvbWlzZXM7XG5cdFx0XHRcdH0sIHt9KTtcblxuXHRcdFx0XHRjb25zdCBjaGFyQWJpbGl0aWVzID0gY2hhcmFjdGVyc01lbnRpb25lZChvcC5jb250ZW50LCBhYmlscmVnKTtcblx0XHRcdFx0Y29uc3QgcGVuZGluZ0FiaWxpdGllcyA9IE9iamVjdC52YWx1ZXMoY2hhckFiaWxpdGllcykucmVkdWNlKChwcm9taXNlcywgY2hhcmFjdGVyKSA9PiB7XG5cdFx0XHRcdFx0aWYgKCFjaGFyYWN0ZXIuYWJpbGl0aWVzLmJhY2tib25lRmlyZWJhc2UpIHtcblx0XHRcdFx0XHRcdGNoYXJhY3Rlci5hYmlsaXRpZXMuYmFja2JvbmVGaXJlYmFzZSA9IG5ldyBCYWNrYm9uZUZpcmViYXNlKGNoYXJhY3Rlci5hYmlsaXRpZXMpO1xuXHRcdFx0XHRcdFx0cHJvbWlzZXNbY2hhcmFjdGVyLmlkXSA9IGNoYXJhY3Rlci5hYmlsaXRpZXMuYmFja2JvbmVGaXJlYmFzZS5yZWZlcmVuY2Uub25jZSgndmFsdWUnKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0cmV0dXJuIHByb21pc2VzO1xuXHRcdFx0XHR9LCB7fSk7XG5cblx0XHRcdFx0YXdhaXQgUHJvbWlzZS5hbGwoW1xuXHRcdFx0XHRcdC4uLk9iamVjdC52YWx1ZXMocGVuZGluZ0F0dHJpYnMpLFxuXHRcdFx0XHRcdC4uLk9iamVjdC52YWx1ZXMocGVuZGluZ0FiaWxpdGllcyksXG5cdFx0XHRcdF0pO1xuXG5cdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0bGV0IG9yaWd0b2tlbjtcblx0XHRcdFx0XHRsZXQgd2FpdE9uVGFyZ2V0ID0gZmFsc2U7XG5cdFx0XHRcdFx0bGV0IF9zcXVlbGNoX2Vycm9ycyA9IGZhbHNlO1xuXHRcdFx0XHRcdGxldCBhY3Rpb25IYW5kbGVkID0gZmFsc2U7XG5cblx0XHRcdFx0XHQvLy8gU3BlY2lhbCBjYXNlOiBUaGlzIG9wdGlvbiBoYXMgdG8gYmUgcHJvY2Vzc2VkIGJlb2ZyZSB3ZSBkbyBzdWJzdGl0dXRpb25zLlxuXHRcdFx0XHRcdG9wLmNvbnRlbnQgPSBvcC5jb250ZW50LnJlcGxhY2UoLyZ7bm9lcnJvcn0vZywgKG1hdGNoKSA9PiB7XG5cdFx0XHRcdFx0XHRfc3F1ZWxjaF9lcnJvcnMgPSB0cnVlO1xuXHRcdFx0XHRcdFx0cmV0dXJuICcnOyAvLyB0YWtlIGl0IG91dFxuXHRcdFx0XHRcdH0pO1xuXG5cdFx0XHRcdFx0b3AuY29udGVudCA9IG9wLmNvbnRlbnQucmVwbGFjZShhYmlscmVnLCAobWF0Y2gpID0+IHtcblx0XHRcdFx0XHRcdGxldCBhYmlsaWQ7XG5cdFx0XHRcdFx0XHRsZXQgY2hhcmlkO1xuXHRcdFx0XHRcdFx0bGV0IGNoYXJhY3Rlcjtcblx0XHRcdFx0XHRcdGxldCBhYmlsaXR5O1xuXHRcdFx0XHRcdFx0bGV0IGNoYXJuYW1lO1xuXHRcdFx0XHRcdFx0bGV0IGFiaWxuYW1lO1xuXHRcdFx0XHRcdFx0bGV0IGFiaWxhY3Rpb247XG5cdFx0XHRcdFx0XHRsZXQgcmVwc2VjdGlvbjtcblxuXHRcdFx0XHRcdFx0bWF0Y2ggPSBtYXRjaC5zdWJzdHJpbmcoMiwgbWF0Y2gubGVuZ3RoIC0gMSk7XG5cdFx0XHRcdFx0XHQvLyBTcGxpdCBvZmYgdGhlIHBvdGVudGlhbCByb2xsIGlkXG5cdFx0XHRcdFx0XHRjb25zdCBmaXJzdFNwbGl0ID0gbWF0Y2guc3BsaXQoJ3x8Jyk7XG5cdFx0XHRcdFx0XHRtYXRjaCA9IGZpcnN0U3BsaXRbMF07XG5cdFx0XHRcdFx0XHRjb25zdCBvcmlnaW5hbFJvbGxJZCA9IGZpcnN0U3BsaXRbMV07XG5cdFx0XHRcdFx0XHRjb25zdCBzID0gbWF0Y2guc3BsaXQoJ3wnKTtcblxuXHRcdFx0XHRcdFx0aWYgKHMubGVuZ3RoID09IDQpIHtcblx0XHRcdFx0XHRcdFx0YWJpbGlkID0gc1sxXTtcblx0XHRcdFx0XHRcdFx0Y2hhcmlkID0gc1swXTtcblx0XHRcdFx0XHRcdFx0Y2hhcm5hbWUgPSBzWzJdO1xuXHRcdFx0XHRcdFx0XHRhYmlsbmFtZSA9IHNbM107XG5cdFx0XHRcdFx0XHRcdGNoYXJhY3RlciA9IGQyMC5DYW1wYWlnbi5jaGFyYWN0ZXJzLmdldChjaGFyaWQpO1xuXHRcdFx0XHRcdFx0XHRpZiAoY2hhcmFjdGVyKSB7XG5cdFx0XHRcdFx0XHRcdFx0YWJpbGl0eSA9IGNoYXJhY3Rlci5hYmlsaXRpZXMuZ2V0KGFiaWxpZCk7XG5cdFx0XHRcdFx0XHRcdFx0YWJpbGFjdGlvbiA9IGFiaWxpdHkuZ2V0KCdhY3Rpb24nKTtcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRpZiAocy5sZW5ndGggPT0gMikge1xuXHRcdFx0XHRcdFx0XHRjaGFybmFtZSA9IHNbMF07XG5cdFx0XHRcdFx0XHRcdGFiaWxuYW1lID0gc1sxXTtcblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0Ly8gMy1hcmd1bWVudCB0YXJnZXQgdmFyaWFudFxuXHRcdFx0XHRcdFx0aWYgKHMubGVuZ3RoID09IDMpIHtcblx0XHRcdFx0XHRcdFx0Y2hhcm5hbWUgPSBzWzBdO1xuXHRcdFx0XHRcdFx0XHRhYmlsbmFtZSA9IHNbMl07XG5cdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdGlmIChcblx0XHRcdFx0XHRcdFx0YWJpbG5hbWUuc3Vic3RyaW5nKDAsIDEwKSA9PT0gJ3JlcGVhdGluZ18nICYmICEoZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzICYmIGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5hdmFpbGFibGVSb2xsc1thYmlsbmFtZS50b0xvd2VyQ2FzZSgpXSAhPT0gdW5kZWZpbmVkKVxuXHRcdFx0XHRcdFx0KSB7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IF9yZXBzID0gYWJpbG5hbWUuc3BsaXQoJ18nKTtcblx0XHRcdFx0XHRcdFx0YWJpbG5hbWUgPSBgcmVwZWF0aW5nXyR7X3JlcHNbMV19XyR7X3JlcHMuc2xpY2UoMykuam9pbignXycpfWA7XG5cdFx0XHRcdFx0XHRcdHJlcHNlY3Rpb24gPSBgcmVwZWF0aW5nXyR7X3JlcHNbMV19XyR7X3JlcHNbMl19X2A7XG5cdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdGlmIChjaGFybmFtZS50b0xvd2VyQ2FzZSgpID09ICdzZWxlY3RlZCcpIHtcblx0XHRcdFx0XHRcdFx0aWYgKCFvcC5jdXJyZW50U2VsZWN0ZWQpIHtcblx0XHRcdFx0XHRcdFx0XHR0aHJvdyAnWW91IGF0dGVtcHRlZCB0byB1c2UgYSByb2xsIGNvbW1hbmQgbG9va2luZyBmb3IgdGhlIHZhbHVlIG9mIGEgc2VsZWN0ZWQgdG9rZW4sIGJ1dCBubyB0b2tlbnMgYXJlIHNlbGVjdGVkLic7XG5cdFx0XHRcdFx0XHRcdFx0cmV0dXJuIG1hdGNoO1xuXHRcdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdFx0aWYgKG9wLmN1cnJlbnRTZWxlY3RlZC5tb2RlbC5nZXQoJ3JlcHJlc2VudHMnKSAhPT0gJycpIHtcblx0XHRcdFx0XHRcdFx0XHRjaGFyYWN0ZXIgPSBkMjAuQ2FtcGFpZ24uY2hhcmFjdGVycy5nZXQoXG5cdFx0XHRcdFx0XHRcdFx0XHRvcC5jdXJyZW50U2VsZWN0ZWQubW9kZWwuZ2V0KCdyZXByZXNlbnRzJyksXG5cdFx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdFx0XHR0aHJvdyAnWW91IGF0dGVtcHRlZCB0byB1c2UgYSByb2xsIGNvbW1hbmQgbG9va2luZyBmb3IgYSBzZWxlY3RlZCB0b2tlbiBhYmlsaXR5LCBidXQgdGhlIHNlbGVjdGVkIHRva2VuIGRvZXMgbm90IHJlcHJlc2VudCBhIENoYXJhY3RlciwgYW5kIHRoZXJlZm9yZSBoYXMgbm8gYWJpbGl0aWVzLic7XG5cdFx0XHRcdFx0XHRcdFx0cmV0dXJuIG1hdGNoO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9IGVsc2UgaWYgKGNoYXJuYW1lLnRvTG93ZXJDYXNlKCkgPT09ICd0YXJnZXQnKSB7XG5cdFx0XHRcdFx0XHRcdGlmICh3YWl0T25UYXJnZXQgfHwgZDIwLmVuZ2luZS5uZXh0VGFyZ2V0Q2FsbGJhY2spIHtcblx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gYCV7JHttYXRjaH19YDtcblx0XHRcdFx0XHRcdFx0fSAvLyBkb24ndCBoYW5kbGUgdGhpcyBvbmUgeWV0LlxuXG5cdFx0XHRcdFx0XHRcdGxldCB0YXJnZXRuYW1lID0gJ3RhcmdldCc7XG5cdFx0XHRcdFx0XHRcdGlmIChzLmxlbmd0aCA+IDIpIHtcblx0XHRcdFx0XHRcdFx0XHR0YXJnZXRuYW1lID0gc1sxXTtcblx0XHRcdFx0XHRcdFx0XHRhYmlsbmFtZSA9IHNbMl07XG5cdFx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0XHRpZiAoIWFiaWxuYW1lKSB7XG5cdFx0XHRcdFx0XHRcdFx0dGhyb3cgJ1N5bnRheCBFcnJvcjogWW91IG11c3Qgc3BlY2lmeSBhIHZhbGlkIGFiaWxpdHkgdG8gZmV0Y2ggZnJvbSB0aGUgdGFyZ2V0Lic7XG5cdFx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0XHRkMjAuZW5naW5lLm5leHRUYXJnZXRDYWxsYmFjayA9IGZ1bmN0aW9uIChmb3VuZHRhcmdldCkge1xuXHRcdFx0XHRcdFx0XHRcdGlmIChmb3VuZHRhcmdldCA9PT0gZmFsc2UpIHtcblx0XHRcdFx0XHRcdFx0XHRcdGNsZWFudXBSb2xsKCk7XG5cdFx0XHRcdFx0XHRcdFx0XHRkMjAuZW5naW5lLm5leHRUYXJnZXRDYWxsYmFjayA9IGZhbHNlO1xuXHRcdFx0XHRcdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHRvcC5jb250ZW50ID0gb3AuY29udGVudC5yZXBsYWNlKFxuXHRcdFx0XHRcdFx0XHRcdFx0LyVcXCR7Y3VycmVudFRhcmdldFxcfFtefV0rfS8sXG5cdFx0XHRcdFx0XHRcdFx0XHQodGFyZ2V0bWF0Y2gpID0+IHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0Y29uc3QgdGFyZ2V0YWJpbCA9IHRhcmdldG1hdGNoXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0LnNwbGl0KCd8JylbMV1cblx0XHRcdFx0XHRcdFx0XHRcdFx0XHQucmVwbGFjZSgnfScsICcnKTtcblx0XHRcdFx0XHRcdFx0XHRcdFx0aWYgKGZvdW5kdGFyZ2V0Lm1vZGVsLmdldCgncmVwcmVzZW50cycpICE9PSAnJykge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdGNvbnN0IHRhcmdldGNoYXIgPSBkMjAuQ2FtcGFpZ24uY2hhcmFjdGVycy5nZXQoXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRmb3VuZHRhcmdldC5tb2RlbC5nZXQoJ3JlcHJlc2VudHMnKSxcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdGlmICh0YXJnZXRjaGFyKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRsZXQgZm91bmR2YWw7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHR0YXJnZXRjaGFyLmFiaWxpdGllcy5lYWNoKCh0aGlzYWJpbCkgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0dGhpc2FiaWwuZ2V0KCduYW1lJykudG9Mb3dlckNhc2UoKSA9PSB0YXJnZXRhYmlsLnRvTG93ZXJDYXNlKClcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0KSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0Ly8gcGFzcyBpdCBiYWNrIHRocm91Z2ggd2l0aCBhIGhhcmQtY29kZWQgY2hhcmFjdGVyIGFuZCBhYmlsaXR5IGlkLCBzaW5jZSBmdXJ0aGUgcHJvY2Vzc2luZyBpcyBuZWVkZWQuXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0Zm91bmR2YWwgPSBgJXske3RhcmdldGNoYXIuaWR9fCR7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHR0aGlzYWJpbC5pZFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdH18JHt0YXJnZXRjaGFyLmdldCgnbmFtZScpfXwke3RoaXNhYmlsLmdldChcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdCduYW1lJyxcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHQpfX1gO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdGlmIChmb3VuZHZhbCAhPT0gdW5kZWZpbmVkKSByZXR1cm4gZm91bmR2YWw7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHQvLyBUcnkgZm9yIHNvbWUgZnVydGhlciBwcm9jZXNzaW5nIGFueXdheS5cblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdHJldHVybiBgJXske3RhcmdldGNoYXIuZ2V0KCduYW1lJyl9fCR7dGFyZ2V0YWJpbH19YDtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0Y29uc29sZS5sb2coXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcIkNvdWxkbid0IGZpbmQgY2hhcmFjdGVyIHRoYXQgcmVwcmVzZW50cyB0aGlzIHRva2VuLlwiLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHRcdFx0aWYgKCFfc3F1ZWxjaF9lcnJvcnMpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRjb25zdCBlb3AgPSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHR3aG86ICdlcnJvcicsXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHR0eXBlOiAnZXJyb3InLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0Y29udGVudDogYE5vIGFiaWxpdHkgd2FzIGZvdW5kIGZvciB0YXJnZXRlZCB0b2tlbiBieSB0aGUgbmFtZSBvZiAke3RhcmdldGFiaWx9YCxcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHR9O1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdGQyMC50ZXh0Y2hhdC5pbmNvbWluZyhmYWxzZSwgZW9wKTtcblx0XHRcdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gbWF0Y2g7XG5cdFx0XHRcdFx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRcdFx0ZDIwLmVuZ2luZS5uZXh0VGFyZ2V0Q2FsbGJhY2sgPSBmYWxzZTtcblx0XHRcdFx0XHRcdFx0XHR0YXJnZXRDYWNoZVt0YXJnZXRuYW1lXSA9IGZvdW5kdGFyZ2V0O1xuXHRcdFx0XHRcdFx0XHRcdG1ha2VTdWJzdGl0dXRpb25zKCk7XG5cdFx0XHRcdFx0XHRcdH07XG5cdFx0XHRcdFx0XHRcdGlmICh0YXJnZXRDYWNoZVt0YXJnZXRuYW1lXSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdFx0XHRcdFx0Xy5kZWZlcigoKSA9PiB7XG5cdFx0XHRcdFx0XHRcdFx0XHRkMjAuZW5naW5lLm5leHRUYXJnZXRDYWxsYmFjayh0YXJnZXRDYWNoZVt0YXJnZXRuYW1lXSk7XG5cdFx0XHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdFx0c2V0TW9kZSgndGFyZ2V0aW5nJyk7XG5cdFx0XHRcdFx0XHRcdFx0JCgnI3RhcmdldGluZ2luc3RydWN0aW9ucyAudGFyZ2V0bmFtZScpLnRleHQoXG5cdFx0XHRcdFx0XHRcdFx0XHR1Y2ZpcnN0KHRhcmdldG5hbWUpLFxuXHRcdFx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0d2FpdE9uVGFyZ2V0ID0gdHJ1ZTtcblx0XHRcdFx0XHRcdFx0cmV0dXJuIGAlXFwke2N1cnJlbnRUYXJnZXR8JHthYmlsbmFtZX19YDtcblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0aWYgKCFjaGFyYWN0ZXIgfHwgIWFiaWxpdHkpIHtcblx0XHRcdFx0XHRcdFx0Ly8gRmluZCBjaGFyL2F0dHJpYnV0ZSBtYW51YWxseS5cblx0XHRcdFx0XHRcdFx0aWYgKCFjaGFyYWN0ZXIpIHtcblx0XHRcdFx0XHRcdFx0XHRkMjAuQ2FtcGFpZ24uY2hhcmFjdGVycy5lYWNoKCh0aGlzY2hhcikgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdFx0aWYgKFxuXHRcdFx0XHRcdFx0XHRcdFx0XHR0aGlzY2hhci5nZXQoJ25hbWUnKS50b0xvd2VyQ2FzZSgpID09IGNoYXJuYW1lLnRvTG93ZXJDYXNlKCkgfHwgdGhpc2NoYXIuaWQgPT09IGNoYXJuYW1lXG5cdFx0XHRcdFx0XHRcdFx0XHQpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0Y2hhcmFjdGVyID0gdGhpc2NoYXI7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdGlmICghYWJpbGl0eSAmJiBjaGFyYWN0ZXIpIHtcblx0XHRcdFx0XHRcdFx0XHRjaGFyYWN0ZXIuYWJpbGl0aWVzLmVhY2goKHRoaXNhYmlsKSA9PiB7XG5cdFx0XHRcdFx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRcdFx0XHRcdHRoaXNhYmlsLmdldCgnbmFtZScpLnRvTG93ZXJDYXNlKCkgPT0gYWJpbG5hbWUudG9Mb3dlckNhc2UoKSB8fCB0aGlzYWJpbC5pZCA9PT0gYWJpbG5hbWVcblx0XHRcdFx0XHRcdFx0XHRcdCkge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRhYmlsaXR5ID0gdGhpc2FiaWw7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdGFiaWxhY3Rpb24gPSBhYmlsaXR5LmdldCgnYWN0aW9uJyk7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdC8vIENoZWNrIGZvciBzaGVldCByb2xscyBvciBhY3Rpb24gYnV0dG9uc1xuXHRcdFx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRcdFx0IWFiaWxpdHkgJiYgY2hhcmFjdGVyICYmIGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0c1xuXHRcdFx0XHRcdFx0XHRcdCYmIGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5hdmFpbGFibGVSb2xscyAmJiBkMjAuam91cm5hbC5jdXN0b21TaGVldHMuYXZhaWxhYmxlQWN0aW9uc1xuXHRcdFx0XHRcdFx0XHQpIHtcblx0XHRcdFx0XHRcdFx0XHRjb25zdCBhdmFpbGFibGVSb2xsID0gZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzLmF2YWlsYWJsZVJvbGxzW2FiaWxuYW1lLnRvTG93ZXJDYXNlKCldO1xuXHRcdFx0XHRcdFx0XHRcdGNvbnN0IGF2YWlsYWJsZUFjdGlvbiA9IGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5hdmFpbGFibGVBY3Rpb25zW2FiaWxuYW1lLnRvTG93ZXJDYXNlKCldO1xuXHRcdFx0XHRcdFx0XHRcdGlmIChhdmFpbGFibGVSb2xsICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0XHRcdFx0XHRcdGFiaWxpdHkgPSBhdmFpbGFibGVSb2xsO1xuXHRcdFx0XHRcdFx0XHRcdFx0YWJpbGFjdGlvbiA9IGFiaWxpdHk7XG5cdFx0XHRcdFx0XHRcdFx0fSBlbHNlIGlmIChhdmFpbGFibGVBY3Rpb24gIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHRcdFx0XHRcdFx0Ly8gTmVlZCB0byBwcmVwZW5kIHJlcGVhdGluZyBzZWN0aW9uIGluZm8sIGlmIHByZXNlbnRcblx0XHRcdFx0XHRcdFx0XHRcdGNvbnN0IGZpbmFsQWN0aW9uID0gcmVwc2VjdGlvbiA/IHJlcHNlY3Rpb24gKyBhdmFpbGFibGVBY3Rpb24gOiBhdmFpbGFibGVBY3Rpb247XG5cdFx0XHRcdFx0XHRcdFx0XHRkMjAuam91cm5hbC5ub3RpZnlXb3JrZXJzT2ZCdXR0b25DbGljayhjaGFyYWN0ZXIuaWQsIGZpbmFsQWN0aW9uLCB7fSwgb3JpZ2luYWxSb2xsSWQpO1xuXHRcdFx0XHRcdFx0XHRcdFx0Ly8gdGhpcyBmbGFnIHdpbGwgcHJldmVudCBhY3R1YWxseSBwb3N0aW5nIHRoaW5ncyBpbiB0aGUgY2hhdCxcblx0XHRcdFx0XHRcdFx0XHRcdC8vIHNpbmNlIHRoZSBhY3Rpb24gaXMganVzdCB0cmlnZ2VyaW5nIGEgc2hlZXR3b3JrZXJcblx0XHRcdFx0XHRcdFx0XHRcdC8vICh3aGljaCB3ZSd2ZSBhbHJlYWR5IGRvbmUpXG5cdFx0XHRcdFx0XHRcdFx0XHRhY3Rpb25IYW5kbGVkID0gdHJ1ZTtcblx0XHRcdFx0XHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0aWYgKGNoYXJhY3RlciAmJiBhYmlsaXR5ICYmIGNoYXJhY3Rlci5jdXJyZW50UGxheWVyQ29udHJvbHMoKSkge1xuXHRcdFx0XHRcdFx0XHRtYXRjaCA9IGFiaWxhY3Rpb247XG5cdFx0XHRcdFx0XHRcdC8vIFN1YnN0aXR1dGUgYW55IGF0dHJpYnV0ZXMgZm9yIHRoZSBmdWxsLWZvcm0uXG5cblx0XHRcdFx0XHRcdFx0Y29uc3QgX2luU2VjdGlvbkF0dHJzID0ge307XG5cdFx0XHRcdFx0XHRcdGlmIChyZXBzZWN0aW9uKSB7XG5cdFx0XHRcdFx0XHRcdFx0Y2hhcmFjdGVyLmF0dHJpYnMuZWFjaCgoYXR0cmliKSA9PiB7XG5cdFx0XHRcdFx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRcdFx0XHRcdGF0dHJpYi5nZXQoJ25hbWUnKS5zdWJzdHJpbmcoMCwgcmVwc2VjdGlvbi5sZW5ndGgpID09PSByZXBzZWN0aW9uXG5cdFx0XHRcdFx0XHRcdFx0XHQpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0X2luU2VjdGlvbkF0dHJzW1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdGF0dHJpYlxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0LmdldCgnbmFtZScpXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHQuc3Vic3RyaW5nKHJlcHNlY3Rpb24ubGVuZ3RoLCBhdHRyaWIuZ2V0KCduYW1lJykubGVuZ3RoKVxuXHRcdFx0XHRcdFx0XHRcdFx0XHRdID0gdHJ1ZTtcblx0XHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdGNvbnN0IHN1YnZhcnJlZyA9IC8oQHtbXn1dK30pL2dtO1xuXHRcdFx0XHRcdFx0XHRtYXRjaCA9IG1hdGNoLnJlcGxhY2Uoc3VidmFycmVnLCAoc3VibWF0Y2gpID0+IHtcblx0XHRcdFx0XHRcdFx0XHRjb25zdCBzdWJ2YXJuYW1lID0gc3VibWF0Y2guc3Vic3RyaW5nKDIsIHN1Ym1hdGNoLmxlbmd0aCAtIDEpO1xuXHRcdFx0XHRcdFx0XHRcdGNvbnN0IHNtcyA9IHN1YnZhcm5hbWUuc3BsaXQoJ3wnKTtcblxuXHRcdFx0XHRcdFx0XHRcdGlmIChzbXMubGVuZ3RoID4gMSAmJiBzbXNbMV0gIT09ICdtYXgnKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gc3VibWF0Y2g7IC8vIGl0J3MgYWxyZWFkeSBhIGZ1bGwgZm9ybSwgbm90IHJlbGF0aXZlLCBqdXN0IHJldHVybiBpdC5cblx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdFx0Y29uc3QgcmVwc2VjdGlvbm5hbWUgPSByZXBzZWN0aW9uICE9PSB1bmRlZmluZWQgPyByZXBzZWN0aW9uLnNwbGl0KCdfJylbMV0gOiAnJztcblxuXHRcdFx0XHRcdFx0XHRcdC8vIExvb2sgZm9yIE50aCByZXBlYXRpbmcgc2VjdGlvbiB2YXJpYWJsZXNcblx0XHRcdFx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRcdFx0XHRzbXNbMF0uc3Vic3RyaW5nKDAsIDEwKSA9PT0gJ3JlcGVhdGluZ18nICYmIHNtc1swXS5pbmRleE9mKCckJykgIT09IC0xXG5cdFx0XHRcdFx0XHRcdFx0KSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRjb25zdCBzbXNzcGxpdCA9IHNtc1swXS5zcGxpdCgnXycpO1xuXHRcdFx0XHRcdFx0XHRcdFx0aWYgKFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRzbXNzcGxpdC5sZW5ndGggPiAzICYmIHNtc3NwbGl0WzJdICE9PSB1bmRlZmluZWQgJiYgc21zc3BsaXRbMl0uc3Vic3RyaW5nKDAsIDEpID09PSAnJCdcblx0XHRcdFx0XHRcdFx0XHRcdCkge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRjb25zdCBmaW5kSW5kZXggPSBwYXJzZUludChcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRzbXNzcGxpdFsyXS5yZXBsYWNlKCckJywgJycpLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdDEwLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRsZXQgcG9zc2libGVhdHRyaWJzID0gW107XG5cdFx0XHRcdFx0XHRcdFx0XHRcdGNvbnN0IHNlYXJjaGtleSA9IGAke3Ntc3NwbGl0WzBdfV8ke3Ntc3NwbGl0WzFdfWA7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdGNoYXJhY3Rlci5hdHRyaWJzLmVhY2goKGF0dHJpYikgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdGlmIChcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdGF0dHJpYlxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHQuZ2V0KCduYW1lJylcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0LnRvTG93ZXJDYXNlKClcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0LnN1YnN0cmluZygwLCBzZWFyY2hrZXkubGVuZ3RoKSA9PT0gc2VhcmNoa2V5LnRvTG93ZXJDYXNlKClcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHQpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdGNvbnN0IF9zcGxpdGF0dHJpYm5hbWUgPSBhdHRyaWIuZ2V0KCduYW1lJykuc3BsaXQoJ18nKTtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdGlmIChcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0X3NwbGl0YXR0cmlibmFtZS5sZW5ndGggPiAyICYmIF9zcGxpdGF0dHJpYm5hbWVbMl0gIT09IHVuZGVmaW5lZFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0KSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdHBvc3NpYmxlYXR0cmlicy5wdXNoKF9zcGxpdGF0dHJpYm5hbWVbMl0pO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdHBvc3NpYmxlYXR0cmlicyA9IF8udW5pcShwb3NzaWJsZWF0dHJpYnMpO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRwb3NzaWJsZWF0dHJpYnMgPSBjaGFyYWN0ZXIucmVwZWF0aW5nS2V5T3JkZXIoXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0cG9zc2libGVhdHRyaWJzLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdHNlYXJjaGtleSxcblx0XHRcdFx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdFx0XHRcdFx0aWYgKHBvc3NpYmxlYXR0cmlic1tmaW5kSW5kZXhdICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRzbXNzcGxpdFsyXSA9IHBvc3NpYmxlYXR0cmlic1tmaW5kSW5kZXhdO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdHNtc1swXSA9IHNtc3NwbGl0LmpvaW4oJ18nKTtcblx0XHRcdFx0XHRcdFx0XHRcdFx0fSBlbHNlIGlmICghX3NxdWVsY2hfZXJyb3JzKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0Y29uc3QgZW9wID0ge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0d2hvOiAnZXJyb3InLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0dHlwZTogJ2Vycm9yJyxcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdGNvbnRlbnQ6IGBZb3UgdHJpZWQgdG8gdXNlIHRoZSByZXBlYXRpbmcgc2VjdGlvbiByb3cgYXQgaW5kZXggJHtmaW5kSW5kZXh9IGZvciAke3NlYXJjaGtleX0sIGJ1dCB0aGVyZSBkb2Vzbid0IHNlZW0gdG8gYmUgYSByb3cgYXQgdGhhdCBpbmRleC5gLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdH07XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0ZDIwLnRleHRjaGF0LmluY29taW5nKGZhbHNlLCBlb3ApO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdFx0Ly8gQ2hlY2sgZm9yIHZhcmlhYmxlcyBpbiByZXBlYXRpbmcgc2VjdGlvbnNcblx0XHRcdFx0XHRcdFx0XHRpZiAocmVwc2VjdGlvbiAmJiBfaW5TZWN0aW9uQXR0cnNbc21zWzBdXSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gYEB7JHtjaGFyYWN0ZXIuZ2V0KCduYW1lJyl9fCR7cmVwc2VjdGlvbn0ke3Ntc1swXX0ke1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRzbXMubGVuZ3RoID09IDIgPyBgfCR7c21zWzFdfWAgOiAnJ1xuXHRcdFx0XHRcdFx0XHRcdFx0fX1gO1xuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHQvLyBJdCdzIGEgcmVwZWF0aW5nIHNlY3Rpb24gYXR0cmlidXRlIHdlIGhhdmVuJ3QgZGVmaW5lZCB5ZXQgYnV0IHdlIGhhdmUgYSBkZWZhdWx0IHZhbHVlIGZvcj9cblx0XHRcdFx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRcdFx0XHRyZXBzZWN0aW9uICYmIGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cyAmJiBkMjAuam91cm5hbC5jdXN0b21TaGVldHMuYXZhaWxhYmxlQXR0cmlidXRlc1tgcmVwZWF0aW5nXyR7cmVwc2VjdGlvbm5hbWV9XyR7c21zWzBdfWAudG9Mb3dlckNhc2UoKV0gIT09IHVuZGVmaW5lZCAmJiBkMjAuam91cm5hbC5jdXN0b21TaGVldHMuYXZhaWxhYmxlQXR0cmlidXRlc1tzbXNbMF0udG9Mb3dlckNhc2UoKV0gPT09IHVuZGVmaW5lZFxuXHRcdFx0XHRcdFx0XHRcdCkge1xuXHRcdFx0XHRcdFx0XHRcdFx0cmV0dXJuIGBAeyR7Y2hhcmFjdGVyLmdldCgnbmFtZScpfXwke3JlcHNlY3Rpb259JHtzbXNbMF19JHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0c21zLmxlbmd0aCA9PSAyID8gYHwke3Ntc1sxXX1gIDogJydcblx0XHRcdFx0XHRcdFx0XHRcdH19YDtcblx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdFx0cmV0dXJuIGBAeyR7Y2hhcmFjdGVyLmdldCgnbmFtZScpfXwke3Ntc1swXX0ke1xuXHRcdFx0XHRcdFx0XHRcdFx0c21zLmxlbmd0aCA9PSAyID8gYHwke3Ntc1sxXX1gIDogJydcblx0XHRcdFx0XHRcdFx0XHR9fWA7XG5cdFx0XHRcdFx0XHRcdH0pO1xuXG5cdFx0XHRcdFx0XHRcdC8vIExvb2sgZm9yIH4tc3R5bGUgYnV0dG9ucyB0aGF0IGRvbid0IGhhdmUgY2hhcmFjdGVyIGlkJ3MgYXR0YWNoZWQuXG5cdFx0XHRcdFx0XHRcdG1hdGNoID0gbWF0Y2gucmVwbGFjZSgvXFwoflteXFwpXStcXCkvZywgKG1hdGNoKSA9PiB7XG5cdFx0XHRcdFx0XHRcdFx0Y29uc3QgcyA9IG1hdGNoLnNwbGl0KCd8Jyk7XG5cdFx0XHRcdFx0XHRcdFx0aWYgKHMubGVuZ3RoIDwgMikge1xuXHRcdFx0XHRcdFx0XHRcdFx0bGV0IGFiaWxuYW1lID0gbWF0Y2guc3Vic3RyaW5nKDIsIG1hdGNoLmxlbmd0aCk7XG5cdFx0XHRcdFx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRcdFx0XHRcdHJlcHNlY3Rpb24gJiYgYWJpbG5hbWUuc3Vic3RyaW5nKDAsIDEwKSA9PT0gJ3JlcGVhdGluZ18nXG5cdFx0XHRcdFx0XHRcdFx0XHQpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0Y29uc3QgX3NwbGl0YWJpbCA9IGFiaWxuYW1lLnNwbGl0KCdfJyk7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdGFiaWxuYW1lID0gcmVwc2VjdGlvbiArIF9zcGxpdGFiaWwuc3BsaWNlKDIpLmpvaW4oJ18nKTtcblx0XHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHRcdHJldHVybiBgKH4ke2NoYXJhY3Rlci5pZH18JHthYmlsbmFtZX1gO1xuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gbWF0Y2g7XG5cdFx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdFx0aWYgKCFfc3F1ZWxjaF9lcnJvcnMpIHtcblx0XHRcdFx0XHRcdFx0XHRjb25zdCBlb3AgPSB7XG5cdFx0XHRcdFx0XHRcdFx0XHR3aG86ICdlcnJvcicsXG5cdFx0XHRcdFx0XHRcdFx0XHR0eXBlOiAnZXJyb3InLFxuXHRcdFx0XHRcdFx0XHRcdFx0Y29udGVudDogYE5vIGFiaWxpdHkgd2FzIGZvdW5kIGZvciAleyR7Y2hhcm5hbWV9fCR7YWJpbG5hbWV9fWAsXG5cdFx0XHRcdFx0XHRcdFx0fTtcblx0XHRcdFx0XHRcdFx0XHRkMjAudGV4dGNoYXQuaW5jb21pbmcoZmFsc2UsIGVvcCk7XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0cmV0dXJuIG1hdGNoO1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRyZXR1cm4gbWF0Y2g7XG5cdFx0XHRcdFx0fSk7XG5cblx0XHRcdFx0XHRvcC5jb250ZW50ID0gb3AuY29udGVudC5yZXBsYWNlKHJlZywgKG1hdGNoKSA9PiB7XG5cdFx0XHRcdFx0XHRpZiAobWFjcm9zW21hdGNoXSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdFx0XHRcdHJldHVybiBtYWNyb3NbbWF0Y2hdO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0cmV0dXJuIG1hdGNoO1xuXHRcdFx0XHRcdH0pO1xuXG5cdFx0XHRcdFx0Ly8gVEVNUDogUmVkbyBsYXp5IGxvYWRpbmcgYWZ0ZXIgcmVzb2x2aW5nIG1hY3JvXG5cdFx0XHRcdFx0Y29uc3QgY2hhckF0dHJpYnMgPSBjaGFyYWN0ZXJzTWVudGlvbmVkKG9wLmNvbnRlbnQsIHZhcnJlZyk7XG5cdFx0XHRcdFx0Y29uc3QgcGVuZGluZ0F0dHJpYnMgPSBPYmplY3QudmFsdWVzKGNoYXJBdHRyaWJzKS5yZWR1Y2UoKHByb21pc2VzLCBjaGFyYWN0ZXIpID0+IHtcblx0XHRcdFx0XHRcdGlmICghY2hhcmFjdGVyLmF0dHJpYnMuYmFja2JvbmVGaXJlYmFzZSkge1xuXHRcdFx0XHRcdFx0XHRjaGFyYWN0ZXIuYXR0cmlicy5iYWNrYm9uZUZpcmViYXNlID0gbmV3IEJhY2tib25lRmlyZWJhc2UoY2hhcmFjdGVyLmF0dHJpYnMpO1xuXHRcdFx0XHRcdFx0XHRwcm9taXNlc1tjaGFyYWN0ZXIuaWRdID0gY2hhcmFjdGVyLmF0dHJpYnMuYmFja2JvbmVGaXJlYmFzZS5yZWZlcmVuY2Uub25jZSgndmFsdWUnKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdHJldHVybiBwcm9taXNlcztcblx0XHRcdFx0XHR9LCB7fSk7XG5cblx0XHRcdFx0XHRjb25zdCBjaGFyQWJpbGl0aWVzID0gY2hhcmFjdGVyc01lbnRpb25lZChvcC5jb250ZW50LCBhYmlscmVnKTtcblx0XHRcdFx0XHRjb25zdCBwZW5kaW5nQWJpbGl0aWVzID0gT2JqZWN0LnZhbHVlcyhjaGFyQWJpbGl0aWVzKS5yZWR1Y2UoKHByb21pc2VzLCBjaGFyYWN0ZXIpID0+IHtcblx0XHRcdFx0XHRcdGlmICghY2hhcmFjdGVyLmFiaWxpdGllcy5iYWNrYm9uZUZpcmViYXNlKSB7XG5cdFx0XHRcdFx0XHRcdGNoYXJhY3Rlci5hYmlsaXRpZXMuYmFja2JvbmVGaXJlYmFzZSA9IG5ldyBCYWNrYm9uZUZpcmViYXNlKGNoYXJhY3Rlci5hYmlsaXRpZXMpO1xuXHRcdFx0XHRcdFx0XHRwcm9taXNlc1tjaGFyYWN0ZXIuaWRdID0gY2hhcmFjdGVyLmFiaWxpdGllcy5iYWNrYm9uZUZpcmViYXNlLnJlZmVyZW5jZS5vbmNlKCd2YWx1ZScpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0cmV0dXJuIHByb21pc2VzO1xuXHRcdFx0XHRcdH0sIHt9KTtcblxuXHRcdFx0XHRcdGF3YWl0IFByb21pc2UuYWxsKFtcblx0XHRcdFx0XHRcdC4uLk9iamVjdC52YWx1ZXMocGVuZGluZ0F0dHJpYnMpLFxuXHRcdFx0XHRcdFx0Li4uT2JqZWN0LnZhbHVlcyhwZW5kaW5nQWJpbGl0aWVzKSxcblx0XHRcdFx0XHRdKTtcblx0XHRcdFx0XHQvLyBFTkQgVEVNUCAocGFpbilcblxuXHRcdFx0XHRcdG9wLmNvbnRlbnQgPSBvcC5jb250ZW50LnJlcGxhY2UodmFycmVnLCAobWF0Y2gpID0+IHtcblx0XHRcdFx0XHRcdGxldCBhdHRyaWQ7XG5cdFx0XHRcdFx0XHRsZXQgY2hhcmlkO1xuXHRcdFx0XHRcdFx0bGV0IGNoYXJhY3Rlcjtcblx0XHRcdFx0XHRcdGxldCBhdHRyaWJ1dGU7XG5cdFx0XHRcdFx0XHRsZXQgY2hhcm5hbWU7XG5cdFx0XHRcdFx0XHRsZXQgYXR0cm5hbWU7XG5cdFx0XHRcdFx0XHRsZXQgcmVwc2VjdGlvbjtcblxuXHRcdFx0XHRcdFx0bWF0Y2ggPSBtYXRjaC5zdWJzdHJpbmcoMiwgbWF0Y2gubGVuZ3RoIC0gMSk7XG5cdFx0XHRcdFx0XHRjb25zdCBzID0gbWF0Y2guc3BsaXQoJ3wnKTtcblx0XHRcdFx0XHRcdGxldCB2YWx0eXBlID0gJ2N1cnJlbnQnO1xuXHRcdFx0XHRcdFx0bGV0IF9vdmVycmlkZVBlcm1pc3Npb25zID0gZmFsc2U7XG5cblx0XHRcdFx0XHRcdGlmIChzLmxlbmd0aCA9PSA0KSB7XG5cdFx0XHRcdFx0XHRcdGF0dHJpZCA9IHNbMV07XG5cdFx0XHRcdFx0XHRcdGNoYXJpZCA9IHNbMF07XG5cdFx0XHRcdFx0XHRcdGNoYXJuYW1lID0gc1syXTtcblx0XHRcdFx0XHRcdFx0YXR0cm5hbWUgPSBzWzNdO1xuXHRcdFx0XHRcdFx0XHRjaGFyYWN0ZXIgPSBkMjAuQ2FtcGFpZ24uY2hhcmFjdGVycy5nZXQoY2hhcmlkKTtcblx0XHRcdFx0XHRcdFx0aWYgKGNoYXJhY3Rlcikge1xuXHRcdFx0XHRcdFx0XHRcdGF0dHJpYnV0ZSA9IGNoYXJhY3Rlci5hdHRyaWJzLmdldChhdHRyaWQpO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdGlmICghY2hhcmFjdGVyKSB7XG5cdFx0XHRcdFx0XHRcdGNoYXJuYW1lID0gc1swXTtcblx0XHRcdFx0XHRcdFx0YXR0cm5hbWUgPSBzWzFdO1xuXHRcdFx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRcdFx0cy5sZW5ndGggPiAyICYmIChgJHtzWzJdfWAudG9Mb3dlckNhc2UoKSA9PSAnbWF4JyB8fCBgJHtzWzNdfWAudG9Mb3dlckNhc2UoKSA9PSAnbWF4Jylcblx0XHRcdFx0XHRcdFx0KSB7XG5cdFx0XHRcdFx0XHRcdFx0dmFsdHlwZSA9ICdtYXgnO1xuXHRcdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdFx0aWYgKGNoYXJuYW1lLnRvTG93ZXJDYXNlKCkgPT0gJ3NlbGVjdGVkJykge1xuXHRcdFx0XHRcdFx0XHRcdGlmICghb3AuY3VycmVudFNlbGVjdGVkKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHR0aHJvdyAnWW91IGF0dGVtcHRlZCB0byB1c2UgYSByb2xsIGNvbW1hbmQgbG9va2luZyBmb3IgdGhlIHZhbHVlIG9mIGEgc2VsZWN0ZWQgdG9rZW4sIGJ1dCBubyB0b2tlbnMgYXJlIHNlbGVjdGVkLic7XG5cdFx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gbWF0Y2g7XG5cdFx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdFx0Y29uc3QgdG9rZW52YXJpYWJsZSA9IHRyYW5zbGF0ZVZhcmlhYmxlVG9Ub2tlbk9yQ2hhcmFjdGVyKFxuXHRcdFx0XHRcdFx0XHRcdFx0YXR0cm5hbWUsXG5cdFx0XHRcdFx0XHRcdFx0XHRvcC5jdXJyZW50U2VsZWN0ZWQubW9kZWwsXG5cdFx0XHRcdFx0XHRcdFx0XHR2YWx0eXBlLFxuXHRcdFx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRcdFx0aWYgKHRva2VudmFyaWFibGUgIT09IHVuZGVmaW5lZCkgcmV0dXJuIHRva2VudmFyaWFibGU7XG5cblx0XHRcdFx0XHRcdFx0XHRpZiAob3AuY3VycmVudFNlbGVjdGVkLm1vZGVsLmdldCgncmVwcmVzZW50cycpICE9PSAnJykge1xuXHRcdFx0XHRcdFx0XHRcdFx0Y2hhcmFjdGVyID0gZDIwLkNhbXBhaWduLmNoYXJhY3RlcnMuZ2V0KFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRvcC5jdXJyZW50U2VsZWN0ZWQubW9kZWwuZ2V0KCdyZXByZXNlbnRzJyksXG5cdFx0XHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHRcdFx0aWYgKGF0dHJuYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdjaGFyYWN0ZXJfbmFtZScpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0cmV0dXJuIGNoYXJhY3Rlci5nZXQoJ25hbWUnKTtcblx0XHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHRcdGlmIChhdHRybmFtZS50b0xvd2VyQ2FzZSgpID09PSAnY2hhcmFjdGVyX2lkJykgcmV0dXJuIGNoYXJhY3Rlci5pZDtcblx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdH0gZWxzZSBpZiAoY2hhcm5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ3RhcmdldCcpIHtcblx0XHRcdFx0XHRcdFx0XHRpZiAod2FpdE9uVGFyZ2V0IHx8IGQyMC5lbmdpbmUubmV4dFRhcmdldENhbGxiYWNrKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gYEB7JHttYXRjaH19YDtcblx0XHRcdFx0XHRcdFx0XHR9IC8vIGRvbid0IGhhbmRsZSB0aGlzIG9uZSB5ZXQuXG5cblx0XHRcdFx0XHRcdFx0XHRjb25zdCBwcmV2TW9kZSA9IGAke2QyMC5lbmdpbmUubW9kZX1gO1xuXHRcdFx0XHRcdFx0XHRcdGxldCB0YXJnZXRuYW1lID0gJ3RhcmdldCc7XG5cdFx0XHRcdFx0XHRcdFx0aWYgKHMubGVuZ3RoID4gMikge1xuXHRcdFx0XHRcdFx0XHRcdFx0dGFyZ2V0bmFtZSA9IHNbMV07XG5cdFx0XHRcdFx0XHRcdFx0XHRhdHRybmFtZSA9IHNbMl07XG5cdFx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdFx0aWYgKCFhdHRybmFtZSkge1xuXHRcdFx0XHRcdFx0XHRcdFx0dGhyb3cgJ1N5bnRheCBFcnJvcjogWW91IG11c3Qgc3BlY2lmeSBhIHZhbGlkIGF0dHJpYnV0ZSB0byBmZXRjaCBmcm9tIHRoZSB0YXJnZXQuJztcblx0XHRcdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdFx0XHRkMjAuZW5naW5lLm5leHRUYXJnZXRDYWxsYmFjayA9IGFzeW5jIGZ1bmN0aW9uIChmb3VuZHRhcmdldCkge1xuXHRcdFx0XHRcdFx0XHRcdFx0aWYgKGZvdW5kdGFyZ2V0ID09PSBmYWxzZSkge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRkMjAuZW5naW5lLm5leHRUYXJnZXRDYWxsYmFjayA9IGZhbHNlO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRjbGVhbnVwUm9sbCgpO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHQvLyBSZXNlbGVjdCBPcmlnaW5hbCBUb2tlbnNcblx0XHRcdFx0XHRcdFx0XHRcdFx0c2V0VGltZW91dCgoKSA9PiB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0aWYgKGQyMC5lbmdpbmUubW9kZSAhPSAndGFyZ2V0aW5nJykge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBvcmlndG9rZW4ubGVuZ3RoOyBpKyspIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0ZDIwLmVuZ2luZS5zZWxlY3Qob3JpZ3Rva2VuW2ldKTtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdFx0XHRcdH0sIDUwMCk7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0XHRcdFx0Ly8gTGF6eSBsb2FkIGlmIG5lY2Vzc2FyeS5cblx0XHRcdFx0XHRcdFx0XHRcdGNvbnN0IHRhcmdldEF0dHJpYnMgPSBkMjAuQ2FtcGFpZ24uY2hhcmFjdGVycy5nZXQoXG5cdFx0XHRcdFx0XHRcdFx0XHRcdGZvdW5kdGFyZ2V0Py5tb2RlbD8uZ2V0KCdyZXByZXNlbnRzJylcblx0XHRcdFx0XHRcdFx0XHRcdCk/LmF0dHJpYnM7XG5cdFx0XHRcdFx0XHRcdFx0XHRpZiAodGFyZ2V0QXR0cmlicykge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRpZiAoIXRhcmdldEF0dHJpYnMuYmFja2JvbmVGaXJlYmFzZSkge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdHRhcmdldEF0dHJpYnMuYmFja2JvbmVGaXJlYmFzZSA9IG5ldyBCYWNrYm9uZUZpcmViYXNlKHRhcmdldEF0dHJpYnMpO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdGF3YWl0IHRhcmdldEF0dHJpYnMuYmFja2JvbmVGaXJlYmFzZS5yZWZlcmVuY2Uub25jZSgndmFsdWUnKTtcblx0XHRcdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdFx0b3AuY29udGVudCA9IG9wLmNvbnRlbnQucmVwbGFjZShcblx0XHRcdFx0XHRcdFx0XHRcdFx0L0BcXCR7Y3VycmVudFRhcmdldFxcfFtefV0rfS8sXG5cdFx0XHRcdFx0XHRcdFx0XHRcdCh0YXJnZXRtYXRjaCkgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdGNvbnN0IHRhcmdldHZhciA9IHRhcmdldG1hdGNoXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHQuc3BsaXQoJ3wnKVsxXVxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0LnJlcGxhY2UoJ30nLCAnJyk7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0Y29uc3QgdG9rZW52YXJpYWJsZSA9IHRyYW5zbGF0ZVZhcmlhYmxlVG9Ub2tlbk9yQ2hhcmFjdGVyKFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0dGFyZ2V0dmFyLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0Zm91bmR0YXJnZXQubW9kZWwsXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHR2YWx0eXBlLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0aWYgKHRva2VudmFyaWFibGUgIT09IHVuZGVmaW5lZCkgcmV0dXJuIHRva2VudmFyaWFibGU7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0aWYgKGZvdW5kdGFyZ2V0Lm1vZGVsLmdldCgncmVwcmVzZW50cycpICE9PSAnJykge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0Y29uc3QgdGFyZ2V0Y2hhciA9IGQyMC5DYW1wYWlnbi5jaGFyYWN0ZXJzLmdldChcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0Zm91bmR0YXJnZXQubW9kZWwuZ2V0KCdyZXByZXNlbnRzJyksXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0aWYgKHRhcmdldGNoYXIpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0aWYgKGF0dHJuYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdjaGFyYWN0ZXJfbmFtZScpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gdGFyZ2V0Y2hhci5nZXQoJ25hbWUnKTtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRpZiAoYXR0cm5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2NoYXJhY3Rlcl9pZCcpIHJldHVybiB0YXJnZXRjaGFyLmlkO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gYEB7VEFSR0VUOiR7dGFyZ2V0bmFtZX18JHt0YXJnZXR2YXJ9JHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHR2YWx0eXBlID09PSAnbWF4JyA/ICd8bWF4JyA6ICcnXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdH19YDtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdGNvbnNvbGUubG9nKFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcIkNvdWxkbid0IGZpbmQgY2hhcmFjdGVyIHRoYXQgcmVwcmVzZW50cyB0aGlzIHRva2VuLlwiLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0aWYgKCFfc3F1ZWxjaF9lcnJvcnMpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdGNvbnN0IGVvcCA9IHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0d2hvOiAnZXJyb3InLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHR0eXBlOiAnZXJyb3InLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRjb250ZW50OiBgTm8gYXR0cmlidXRlIHdhcyBmb3VuZCBmb3IgdGFyZ2V0ZWQgdG9rZW4gYnkgdGhlIG5hbWUgb2YgJHt0YXJnZXR2YXJ9YCxcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdH07XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRkMjAudGV4dGNoYXQuaW5jb21pbmcoZmFsc2UsIGVvcCk7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdHJldHVybiAnJztcblx0XHRcdFx0XHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRcdFx0XHRkMjAuZW5naW5lLm5leHRUYXJnZXRDYWxsYmFjayA9IGZhbHNlO1xuXHRcdFx0XHRcdFx0XHRcdFx0dGFyZ2V0Q2FjaGVbdGFyZ2V0bmFtZV0gPSBmb3VuZHRhcmdldDtcblx0XHRcdFx0XHRcdFx0XHRcdG1ha2VTdWJzdGl0dXRpb25zKCk7XG5cdFx0XHRcdFx0XHRcdFx0XHQvLyBSZXNlbGVjdCBPcmlnaW5hbCBUb2tlbnNcblx0XHRcdFx0XHRcdFx0XHRcdHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRpZiAoZDIwLmVuZ2luZS5tb2RlICE9ICd0YXJnZXRpbmcnKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBvcmlndG9rZW4ubGVuZ3RoOyBpKyspIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdGQyMC5lbmdpbmUuc2VsZWN0KG9yaWd0b2tlbltpXSk7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdFx0XHR9LCA1MDApO1xuXHRcdFx0XHRcdFx0XHRcdH07XG5cdFx0XHRcdFx0XHRcdFx0aWYgKHRhcmdldENhY2hlW3RhcmdldG5hbWVdICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0XHRcdFx0XHRcdF8uZGVmZXIoKCkgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRkMjAuZW5naW5lLm5leHRUYXJnZXRDYWxsYmFjayh0YXJnZXRDYWNoZVt0YXJnZXRuYW1lXSk7XG5cdFx0XHRcdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRcdFx0Ly8gUmVtZW1iZXIgb3JpZ2luYWwgdG9rZW5zXG5cdFx0XHRcdFx0XHRcdFx0XHRpZiAoZDIwLmVuZ2luZS5tb2RlICE9ICd0YXJnZXRpbmcnKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdG9yaWd0b2tlbiA9IGQyMC5lbmdpbmUuc2VsZWN0ZWQoKTtcblx0XHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHRcdHNldE1vZGUoJ3RhcmdldGluZycpO1xuXHRcdFx0XHRcdFx0XHRcdFx0JCgnI3RhcmdldGluZ2luc3RydWN0aW9ucyAudGFyZ2V0bmFtZScpLnRleHQoXG5cdFx0XHRcdFx0XHRcdFx0XHRcdHVjZmlyc3QodGFyZ2V0bmFtZSksXG5cdFx0XHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHR3YWl0T25UYXJnZXQgPSB0cnVlO1xuXHRcdFx0XHRcdFx0XHRcdHJldHVybiBgQFxcJHtjdXJyZW50VGFyZ2V0fCR7YXR0cm5hbWV9fWA7XG5cdFx0XHRcdFx0XHRcdH0gZWxzZSBpZiAoY2hhcm5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ3RyYWNrZXInKSB7XG5cdFx0XHRcdFx0XHRcdFx0Y29uc3QgY3VycmVudG9yZGVyID0gZDIwLkNhbXBhaWduLmluaXRpYXRpdmV3aW5kb3cuY2xlYW5MaXN0KCk7XG5cdFx0XHRcdFx0XHRcdFx0bGV0IGZvdW5kdmFsdWU7XG5cdFx0XHRcdFx0XHRcdFx0Xy5lYWNoKGN1cnJlbnRvcmRlciwgKG9yZGVyaXRlbSkgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdFx0aWYgKFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRvcmRlcml0ZW0uY3VzdG9tLnRvTG93ZXJDYXNlKCkgPT09IGF0dHJuYW1lLnRvTG93ZXJDYXNlKClcblx0XHRcdFx0XHRcdFx0XHRcdCkge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRmb3VuZHZhbHVlID0gb3JkZXJpdGVtLnByO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdFx0XHRpZiAob3JkZXJpdGVtLmlkKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdGNvbnN0IHRva2Vub2JqID0gZDIwLkNhbXBhaWduLmFjdGl2ZVBhZ2UoKS50aGVncmFwaGljcy5nZXQoXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0b3JkZXJpdGVtLmlkLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0dG9rZW5vYmogJiYgdG9rZW5vYmouZ2V0KCduYW1lJykudG9Mb3dlckNhc2UoKSA9PT0gYXR0cm5hbWUudG9Mb3dlckNhc2UoKVxuXHRcdFx0XHRcdFx0XHRcdFx0XHQpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRmb3VuZHZhbHVlID0gb3JkZXJpdGVtLnByO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdH0pO1xuXG5cdFx0XHRcdFx0XHRcdFx0aWYgKGZvdW5kdmFsdWUgIT09IHVuZGVmaW5lZCkgcmV0dXJuIGZvdW5kdmFsdWU7XG5cblx0XHRcdFx0XHRcdFx0XHRpZiAoIV9zcXVlbGNoX2Vycm9ycykge1xuXHRcdFx0XHRcdFx0XHRcdFx0dmFyIGVvcCA9IHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0d2hvOiAnZXJyb3InLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHR0eXBlOiAnZXJyb3InLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRjb250ZW50OiBgTm8gdHVybiBvcmRlciBpdGVtIHdhcyBmb3VuZCBieSB0aGUgbmFtZSAke2F0dHJuYW1lfWAsXG5cdFx0XHRcdFx0XHRcdFx0XHR9O1xuXHRcdFx0XHRcdFx0XHRcdFx0ZDIwLnRleHRjaGF0LmluY29taW5nKGZhbHNlLCBlb3ApO1xuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gJyc7XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0aWYgKGF0dHJuYW1lLnN1YnN0cmluZygwLCAxMCkgPT09ICdyZXBlYXRpbmdfJykge1xuXHRcdFx0XHRcdFx0XHRjb25zdCBfcmVwcyA9IGF0dHJuYW1lLnNwbGl0KCdfJyk7XG5cdFx0XHRcdFx0XHRcdHJlcHNlY3Rpb24gPSBgcmVwZWF0aW5nXyR7X3JlcHNbMV19XyR7X3JlcHNbMl19X2A7XG5cdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdGlmICghY2hhcmFjdGVyIHx8ICFhdHRyaWJ1dGUpIHtcblx0XHRcdFx0XHRcdFx0Ly8gRmluZCBjaGFyL2F0dHJpYnV0ZSBtYW51YWxseS5cblxuXHRcdFx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRcdFx0IWNoYXJhY3RlciAmJiBjaGFybmFtZS5zdWJzdHJpbmcoMCwgNykgPT09ICdUQVJHRVQ6JyAmJiB0YXJnZXRDYWNoZVtjaGFybmFtZS5zdWJzdHJpbmcoNywgY2hhcm5hbWUubGVuZ3RoKV1cblx0XHRcdFx0XHRcdFx0KSB7XG5cdFx0XHRcdFx0XHRcdFx0Y2hhcmFjdGVyID0gZDIwLkNhbXBhaWduLmNoYXJhY3RlcnMuZ2V0KFxuXHRcdFx0XHRcdFx0XHRcdFx0dGFyZ2V0Q2FjaGVbY2hhcm5hbWUuc3Vic3RyaW5nKDcsIGNoYXJuYW1lLmxlbmd0aCldLm1vZGVsLmdldChcblx0XHRcdFx0XHRcdFx0XHRcdFx0J3JlcHJlc2VudHMnLFxuXHRcdFx0XHRcdFx0XHRcdFx0KSxcblx0XHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHRcdF9vdmVycmlkZVBlcm1pc3Npb25zID0gdHJ1ZTtcblx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdGlmICghY2hhcmFjdGVyKSB7XG5cdFx0XHRcdFx0XHRcdFx0ZDIwLkNhbXBhaWduLmNoYXJhY3RlcnMuZWFjaCgodGhpc2NoYXIpID0+IHtcblx0XHRcdFx0XHRcdFx0XHRcdGlmIChcblx0XHRcdFx0XHRcdFx0XHRcdFx0dGhpc2NoYXIuZ2V0KCduYW1lJykudG9Mb3dlckNhc2UoKSA9PSBjaGFybmFtZS50b0xvd2VyQ2FzZSgpXG5cdFx0XHRcdFx0XHRcdFx0XHQpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0Y2hhcmFjdGVyID0gdGhpc2NoYXI7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdGlmICghYXR0cmlidXRlICYmIGNoYXJhY3Rlcikge1xuXHRcdFx0XHRcdFx0XHRcdC8vIExvb2sgZm9yIE50aCByZXBlYXRpbmcgc2VjdGlvbiB2YXJpYWJsZXNcblx0XHRcdFx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRcdFx0XHRhdHRybmFtZS5zdWJzdHJpbmcoMCwgMTApID09PSAncmVwZWF0aW5nXycgJiYgYXR0cm5hbWUuaW5kZXhPZignJCcpICE9PSAtMVxuXHRcdFx0XHRcdFx0XHRcdCkge1xuXHRcdFx0XHRcdFx0XHRcdFx0Y29uc3Qgc21zc3BsaXQgPSBhdHRybmFtZS5zcGxpdCgnXycpO1xuXHRcdFx0XHRcdFx0XHRcdFx0aWYgKFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRzbXNzcGxpdC5sZW5ndGggPiAzICYmIHNtc3NwbGl0WzJdICE9PSB1bmRlZmluZWQgJiYgc21zc3BsaXRbMl0uc3Vic3RyaW5nKDAsIDEpID09PSAnJCdcblx0XHRcdFx0XHRcdFx0XHRcdCkge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRjb25zdCBmaW5kSW5kZXggPSBwYXJzZUludChcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRzbXNzcGxpdFsyXS5yZXBsYWNlKCckJywgJycpLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdDEwLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRsZXQgcG9zc2libGVhdHRyaWJzID0gW107XG5cdFx0XHRcdFx0XHRcdFx0XHRcdGNvbnN0IHNlYXJjaGtleSA9IGAke3Ntc3NwbGl0WzBdfV8ke3Ntc3NwbGl0WzFdfWA7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdGNoYXJhY3Rlci5hdHRyaWJzLmVhY2goKGF0dHJpYikgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdGlmIChcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdGF0dHJpYlxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHQuZ2V0KCduYW1lJylcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0LnRvTG93ZXJDYXNlKClcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0LnN1YnN0cmluZygwLCBzZWFyY2hrZXkubGVuZ3RoKSA9PT0gc2VhcmNoa2V5LnRvTG93ZXJDYXNlKClcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHQpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdGNvbnN0IF9zcGxpdGF0dHJpYm5hbWUgPSBhdHRyaWIuZ2V0KCduYW1lJykuc3BsaXQoJ18nKTtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdGlmIChcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0X3NwbGl0YXR0cmlibmFtZS5sZW5ndGggPiAyICYmIF9zcGxpdGF0dHJpYm5hbWVbMl0gIT09IHVuZGVmaW5lZFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0KSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdHBvc3NpYmxlYXR0cmlicy5wdXNoKF9zcGxpdGF0dHJpYm5hbWVbMl0pO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdHBvc3NpYmxlYXR0cmlicyA9IF8udW5pcShwb3NzaWJsZWF0dHJpYnMpO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRwb3NzaWJsZWF0dHJpYnMgPSBjaGFyYWN0ZXIucmVwZWF0aW5nS2V5T3JkZXIoXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0cG9zc2libGVhdHRyaWJzLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdHNlYXJjaGtleSxcblx0XHRcdFx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdFx0XHRcdFx0aWYgKHBvc3NpYmxlYXR0cmlic1tmaW5kSW5kZXhdICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRzbXNzcGxpdFsyXSA9IHBvc3NpYmxlYXR0cmlic1tmaW5kSW5kZXhdO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdGF0dHJuYW1lID0gc21zc3BsaXQuam9pbignXycpO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHR9IGVsc2UgaWYgKCFfc3F1ZWxjaF9lcnJvcnMpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHR2YXIgZW9wID0ge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0d2hvOiAnZXJyb3InLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0dHlwZTogJ2Vycm9yJyxcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdGNvbnRlbnQ6IGBZb3UgdHJpZWQgdG8gdXNlIHRoZSByZXBlYXRpbmcgc2VjdGlvbiByb3cgYXQgaW5kZXggJHtmaW5kSW5kZXh9IGZvciAke3NlYXJjaGtleX0sIGJ1dCB0aGVyZSBkb2Vzbid0IHNlZW0gdG8gYmUgYSByb3cgYXQgdGhhdCBpbmRleC5gLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdH07XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0ZDIwLnRleHRjaGF0LmluY29taW5nKGZhbHNlLCBlb3ApO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdFx0YXR0cmlidXRlID0gY2hhcmFjdGVyLmF0dHJpYnMuZmluZChcblx0XHRcdFx0XHRcdFx0XHRcdCh0aGlzYXR0cmliKSA9PiB0aGlzYXR0cmliLmdldCgnbmFtZScpLnRvTG93ZXJDYXNlKCkgPT09IGF0dHJuYW1lLnRvTG93ZXJDYXNlKCksXG5cdFx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRpZiAoIWNoYXJhY3Rlcikge1xuXHRcdFx0XHRcdFx0XHR2YXIgZW9wID0ge1xuXHRcdFx0XHRcdFx0XHRcdHdobzogJ2Vycm9yJyxcblx0XHRcdFx0XHRcdFx0XHR0eXBlOiAnZXJyb3InLFxuXHRcdFx0XHRcdFx0XHRcdGNvbnRlbnQ6IGBObyBjaGFyYWN0ZXIgd2FzIGZvdW5kIGZvciAnJHtjaGFybmFtZX0nYCxcblx0XHRcdFx0XHRcdFx0fTtcblx0XHRcdFx0XHRcdFx0ZDIwLnRleHRjaGF0LmluY29taW5nKGZhbHNlLCBlb3ApO1xuXG5cdFx0XHRcdFx0XHRcdHJldHVybiBtYXRjaDtcblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0Y29uc3QgX2luU2VjdGlvbkF0dHJzID0ge307XG5cdFx0XHRcdFx0XHRpZiAocmVwc2VjdGlvbikge1xuXHRcdFx0XHRcdFx0XHRjaGFyYWN0ZXIuYXR0cmlicy5lYWNoKChhdHRyaWIpID0+IHtcblx0XHRcdFx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRcdFx0XHRhdHRyaWIuZ2V0KCduYW1lJykuc3Vic3RyaW5nKDAsIHJlcHNlY3Rpb24ubGVuZ3RoKSA9PT0gcmVwc2VjdGlvblxuXHRcdFx0XHRcdFx0XHRcdCkge1xuXHRcdFx0XHRcdFx0XHRcdFx0X2luU2VjdGlvbkF0dHJzW1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRhdHRyaWJcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHQuZ2V0KCduYW1lJylcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHQuc3Vic3RyaW5nKHJlcHNlY3Rpb24ubGVuZ3RoLCBhdHRyaWIuZ2V0KCduYW1lJykubGVuZ3RoKVxuXHRcdFx0XHRcdFx0XHRcdFx0XSA9IHRydWU7XG5cdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0Y29uc3QgX3N1YnN0aXR1dGVTaG9ydEZvcm1zID0gZnVuY3Rpb24gKHRoaXNjb21tYW5kKSB7XG5cdFx0XHRcdFx0XHRcdC8vIFN1YnN0aXR1dGUgYW55IGF0dHJpYnV0ZXMgZm9yIHRoZSBmdWxsLWZvcm0uXG5cdFx0XHRcdFx0XHRcdGNvbnN0IHN1YnZhcnJlZyA9IC8oQHtbXn1dK30pL2dtO1xuXHRcdFx0XHRcdFx0XHR0aGlzY29tbWFuZCA9IGAke3RoaXNjb21tYW5kfWAucmVwbGFjZShzdWJ2YXJyZWcsIChzdWJtYXRjaCkgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdGNvbnN0IHN1YnZhcm5hbWUgPSBzdWJtYXRjaC5zdWJzdHJpbmcoMiwgc3VibWF0Y2gubGVuZ3RoIC0gMSk7XG5cdFx0XHRcdFx0XHRcdFx0Y29uc3Qgc21zID0gc3VidmFybmFtZS5zcGxpdCgnfCcpO1xuXG5cdFx0XHRcdFx0XHRcdFx0aWYgKHNtcy5sZW5ndGggPiAxICYmIHNtc1sxXSAhPT0gJ21heCcpIHtcblx0XHRcdFx0XHRcdFx0XHRcdHJldHVybiBzdWJtYXRjaDsgLy8gaXQncyBhbHJlYWR5IGEgZnVsbCBmb3JtLCBub3QgcmVsYXRpdmUsIGp1c3QgcmV0dXJuIGl0LlxuXHRcdFx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0XHRcdGNvbnN0IHJlcHNlY3Rpb25uYW1lID0gcmVwc2VjdGlvbiAhPT0gdW5kZWZpbmVkID8gcmVwc2VjdGlvbi5zcGxpdCgnXycpWzFdIDogJyc7XG5cblx0XHRcdFx0XHRcdFx0XHQvLyBDaGVjayBmb3IgdmFyaWFibGVzIGluIHJlcGVhdGluZyBzZWN0aW9uc1xuXHRcdFx0XHRcdFx0XHRcdGlmIChyZXBzZWN0aW9uICYmIF9pblNlY3Rpb25BdHRyc1tzbXNbMF1dICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0XHRcdFx0XHRcdHJldHVybiBgQHske1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRfb3ZlcnJpZGVQZXJtaXNzaW9ucyA/IGNoYXJuYW1lIDogY2hhcmFjdGVyLmdldCgnbmFtZScpXG5cdFx0XHRcdFx0XHRcdFx0XHR9fCR7cmVwc2VjdGlvbn0ke3Ntc1swXX0ke1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRzbXMubGVuZ3RoID09IDIgPyBgfCR7c21zWzFdfWAgOiAnJ1xuXHRcdFx0XHRcdFx0XHRcdFx0fX1gO1xuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHQvLyBJdCdzIGEgcmVwZWF0aW5nIHNlY3Rpb24gYXR0cmlidXRlIHdlIGhhdmVuJ3QgZGVmaW5lZCB5ZXQgYnV0IHdlIGhhdmUgYSBkZWZhdWx0IHZhbHVlIGZvcj9cblx0XHRcdFx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRcdFx0XHRyZXBzZWN0aW9uICYmIGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cyAmJiBkMjAuam91cm5hbC5jdXN0b21TaGVldHMuYXZhaWxhYmxlQXR0cmlidXRlc1tgcmVwZWF0aW5nXyR7cmVwc2VjdGlvbm5hbWV9XyR7c21zWzBdfWAudG9Mb3dlckNhc2UoKV0gIT09IHVuZGVmaW5lZCAmJiBkMjAuam91cm5hbC5jdXN0b21TaGVldHMuYXZhaWxhYmxlQXR0cmlidXRlc1tzbXNbMF0udG9Mb3dlckNhc2UoKV0gPT09IHVuZGVmaW5lZFxuXHRcdFx0XHRcdFx0XHRcdCkge1xuXHRcdFx0XHRcdFx0XHRcdFx0cmV0dXJuIGBAeyR7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdF9vdmVycmlkZVBlcm1pc3Npb25zID8gY2hhcm5hbWUgOiBjaGFyYWN0ZXIuZ2V0KCduYW1lJylcblx0XHRcdFx0XHRcdFx0XHRcdH18JHtyZXBzZWN0aW9ufSR7c21zWzBdfSR7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdHNtcy5sZW5ndGggPT0gMiA/IGB8JHtzbXNbMV19YCA6ICcnXG5cdFx0XHRcdFx0XHRcdFx0XHR9fWA7XG5cdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdHJldHVybiBgQHske1xuXHRcdFx0XHRcdFx0XHRcdFx0X292ZXJyaWRlUGVybWlzc2lvbnMgPyBjaGFybmFtZSA6IGNoYXJhY3Rlci5nZXQoJ25hbWUnKVxuXHRcdFx0XHRcdFx0XHRcdH18JHtzbXNbMF19JHtzbXMubGVuZ3RoID09IDIgPyBgfCR7c21zWzFdfWAgOiAnJ319YDtcblx0XHRcdFx0XHRcdFx0fSk7XG5cblx0XHRcdFx0XHRcdFx0Ly8gTG9vayBmb3Igfi1zdHlsZSBidXR0b25zIHRoYXQgZG9uJ3QgaGF2ZSBjaGFyYWN0ZXIgaWQncyBhdHRhY2hlZC5cblx0XHRcdFx0XHRcdFx0dGhpc2NvbW1hbmQgPSB0aGlzY29tbWFuZC5yZXBsYWNlKC9cXCh+W15cXCldK1xcKS9nLCAobWF0Y2gpID0+IHtcblx0XHRcdFx0XHRcdFx0XHRjb25zdCBzID0gbWF0Y2guc3BsaXQoJ3wnKTtcblx0XHRcdFx0XHRcdFx0XHRpZiAocy5sZW5ndGggPCAyKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRsZXQgYWJpbG5hbWUgPSBtYXRjaC5zdWJzdHJpbmcoMiwgbWF0Y2gubGVuZ3RoKTtcblx0XHRcdFx0XHRcdFx0XHRcdGlmIChcblx0XHRcdFx0XHRcdFx0XHRcdFx0cmVwc2VjdGlvbiAmJiBhYmlsbmFtZS5zdWJzdHJpbmcoMCwgMTApID09PSAncmVwZWF0aW5nXydcblx0XHRcdFx0XHRcdFx0XHRcdCkge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRjb25zdCBfc3BsaXRhYmlsID0gYWJpbG5hbWUuc3BsaXQoJ18nKTtcblx0XHRcdFx0XHRcdFx0XHRcdFx0YWJpbG5hbWUgPSByZXBzZWN0aW9uICsgX3NwbGl0YWJpbC5zcGxpY2UoMikuam9pbignXycpO1xuXHRcdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdFx0cmV0dXJuIGAofiR7Y2hhcmFjdGVyLmlkfXwke2FiaWxuYW1lfWA7XG5cdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRcdHJldHVybiBtYXRjaDtcblx0XHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRcdHJldHVybiB0aGlzY29tbWFuZDtcblx0XHRcdFx0XHRcdH07XG5cblx0XHRcdFx0XHRcdGlmIChhdHRybmFtZSA9PT0gJ2NoYXJhY3Rlcl9uYW1lJykge1xuXHRcdFx0XHRcdFx0XHRyZXR1cm4gY2hhcmFjdGVyLmdldCgnbmFtZScpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0aWYgKGF0dHJuYW1lID09PSAnY2hhcmFjdGVyX2lkJykge1xuXHRcdFx0XHRcdFx0XHRyZXR1cm4gY2hhcmFjdGVyLmlkO1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRsZXQgX3Bvc3NpYmxlQW5zd2VyO1xuXG5cdFx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRcdGF0dHJpYnV0ZSAmJiAoY2hhcmFjdGVyLmN1cnJlbnRQbGF5ZXJDb250cm9scygpIHx8IF9vdmVycmlkZVBlcm1pc3Npb25zID09PSB0cnVlKVxuXHRcdFx0XHRcdFx0KSB7XG5cdFx0XHRcdFx0XHRcdGlmICh2YWx0eXBlID09ICdtYXgnKSB7XG5cdFx0XHRcdFx0XHRcdFx0X3Bvc3NpYmxlQW5zd2VyID0gYXR0cmlidXRlLmdldCgnbWF4Jyk7XG5cdFx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdFx0X3Bvc3NpYmxlQW5zd2VyID0gYXR0cmlidXRlLmdldCgnY3VycmVudCcpO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdGlmIChfcG9zc2libGVBbnN3ZXIgIT09IHVuZGVmaW5lZCAmJiBfcG9zc2libGVBbnN3ZXIgIT09ICcnKSB7XG5cdFx0XHRcdFx0XHRcdC8vIERlZmluaXRlbHkgcmV0dXJuIHRoaXMuXG5cdFx0XHRcdFx0XHRcdHJldHVybiBfc3Vic3RpdHV0ZVNob3J0Rm9ybXMoX3Bvc3NpYmxlQW5zd2VyKTtcblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0Ly8gT25seSBib3RoZXIgd2l0aCB0aGUgYmVsb3cgaWYgd2UgcmVhbGx5IG5lZWQgaXQuXG5cblx0XHRcdFx0XHRcdGxldCBfZGVmYXVsdEFuc3dlcjtcblx0XHRcdFx0XHRcdGxldCBfZGVmYXVsdEtleSA9IChcblx0XHRcdFx0XHRcdFx0YXR0cm5hbWUgKyAodmFsdHlwZSA9PT0gJ21heCcgPyAnX21heCcgOiAnJylcblx0XHRcdFx0XHRcdCkudG9Mb3dlckNhc2UoKTtcblxuXHRcdFx0XHRcdFx0Ly8gSWYgd2UgYXJlIHRyeWluZyB0byBmZXRjaCBhbiBhdHRyaWJ1dGUgaW4gYSByZXBlYXRpbmcgc2VjdGlvbiwgd2UgaGF2ZSB0byBjaGVjayBmb3IgdGhlIGRlZmF1bHQgdmFsdWUgd2l0aG91dCB0aGUgUk9XIElELlxuXHRcdFx0XHRcdFx0Ly8gZS5nLiBpZiBpdCdzIEB7cmVwZWF0aW5nX3NwZWxsc18tQUJDMTJfU3BlbGxOYW1lfSB0aGUgZGVmYXVsdCB2YWx1ZSBpcyBhY3R1YWxseSBzdG9yZWQgYXMgXCJyZXBlYXRpbmdfc3BlbGxzX1NwZWxsTmFtZVwiIHNpbmNlIGl0J3Mgc2hhcmVkIGFjcm9zcyBhbGwgcmVwZWF0aW5nIHNlY3Rpb24gcm93cy5cblx0XHRcdFx0XHRcdGlmIChcblx0XHRcdFx0XHRcdFx0X2RlZmF1bHRLZXkuc3Vic3RyaW5nKDAsIDEwKSA9PT0gJ3JlcGVhdGluZ18nICYmICghZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzIHx8IGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5hdmFpbGFibGVBdHRyaWJ1dGVzW19kZWZhdWx0S2V5XSA9PT0gdW5kZWZpbmVkKVxuXHRcdFx0XHRcdFx0KSB7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IF9ka3MgPSBfZGVmYXVsdEtleS5zcGxpdCgnXycpO1xuXHRcdFx0XHRcdFx0XHRpZiAoIWlzTmFOKF9ka3NbMl0pIHx8IF9ka3NbMl0uc3Vic3RyaW5nKDAsIDEpID09PSAnLScpIHtcblx0XHRcdFx0XHRcdFx0XHRfZGtzLnNwbGljZSgyLCAxKTtcblx0XHRcdFx0XHRcdFx0XHRfZGVmYXVsdEtleSA9IF9ka3Muam9pbignXycpO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdGlmIChcblx0XHRcdFx0XHRcdFx0KGNoYXJhY3Rlci5jdXJyZW50UGxheWVyQ29udHJvbHMoKSB8fCBfb3ZlcnJpZGVQZXJtaXNzaW9ucyA9PT0gdHJ1ZSkgJiYgZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzICYmIGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5hdmFpbGFibGVBdHRyaWJ1dGVzICYmIGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5hdmFpbGFibGVBdHRyaWJ1dGVzW19kZWZhdWx0S2V5XSAhPT0gdW5kZWZpbmVkXG5cdFx0XHRcdFx0XHQpIHtcblx0XHRcdFx0XHRcdFx0Y29uc3QgX2N1c3RvbVNoZWV0QXR0ciA9IGQyMC5qb3VybmFsLmN1c3RvbVNoZWV0cy5hdmFpbGFibGVBdHRyaWJ1dGVzW19kZWZhdWx0S2V5XTtcblx0XHRcdFx0XHRcdFx0X2RlZmF1bHRBbnN3ZXIgPSBfY3VzdG9tU2hlZXRBdHRyO1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHQvLyBJcyBpdCBibGFuaywgYnV0IHdlIGRvbid0IGhhdmUgYSBiZXR0ZXIgZGVmYXVsdD9cblx0XHRcdFx0XHRcdGlmIChfcG9zc2libGVBbnN3ZXIgIT09IHVuZGVmaW5lZCAmJiBfZGVmYXVsdEFuc3dlciA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdFx0XHRcdHJldHVybiBfc3Vic3RpdHV0ZVNob3J0Rm9ybXMoX3Bvc3NpYmxlQW5zd2VyKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdGlmIChfZGVmYXVsdEFuc3dlciAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdFx0XHRcdHJldHVybiBfc3Vic3RpdHV0ZVNob3J0Rm9ybXMoX2RlZmF1bHRBbnN3ZXIpO1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHQvLyBXZSBmZWxsIHRocm91Z2ggYWxsIHRoZSB3YXkgYW5kIGZvdW5kIG5vdGhpbmchXG5cdFx0XHRcdFx0XHRpZiAoIV9zcXVlbGNoX2Vycm9ycykge1xuXHRcdFx0XHRcdFx0XHR2YXIgZW9wID0ge1xuXHRcdFx0XHRcdFx0XHRcdHdobzogJ2Vycm9yJyxcblx0XHRcdFx0XHRcdFx0XHR0eXBlOiAnZXJyb3InLFxuXHRcdFx0XHRcdFx0XHRcdGNvbnRlbnQ6IGBObyBhdHRyaWJ1dGUgd2FzIGZvdW5kIGZvciBAeyR7Y2hhcm5hbWV9fCR7YXR0cm5hbWV9fWAsXG5cdFx0XHRcdFx0XHRcdH07XG5cblx0XHRcdFx0XHRcdFx0ZDIwLnRleHRjaGF0LmluY29taW5nKGZhbHNlLCBlb3ApO1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRyZXR1cm4gbWF0Y2g7XG5cdFx0XHRcdFx0fSk7XG5cblx0XHRcdFx0XHRzdWJwYXNzZXMrKztcblxuXHRcdFx0XHRcdGlmICh3YWl0T25UYXJnZXQpIHJldHVybjtcblxuXHRcdFx0XHRcdC8vIFRoaXMgZmxhZyBpbmRpY2F0ZXMgd2UndmUgY29tcGxldGVseSBoYW5kbGVkIHRoaXMgYWN0aW9uXG5cdFx0XHRcdFx0Ly8gc28gd2UgZG9uJ3Qgd2FudCB0byBwdXQgYW55dGhpbmcgaW4gdGhlIGNoYXRcblx0XHRcdFx0XHRpZiAoYWN0aW9uSGFuZGxlZCkgcmV0dXJuO1xuXG5cdFx0XHRcdFx0aWYgKG9wLmNvbnRlbnQgPT0gcHJldl9yZXNvbHZlZCB8fCBzdWJwYXNzZXMgPiA5OSkge1xuXHRcdFx0XHRcdFx0cHJvY2Vzc1F1ZXJpZXMoKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0cHJldl9yZXNvbHZlZCA9IG9wLmNvbnRlbnQ7XG5cdFx0XHRcdFx0XHRtYWtlU3Vic3RpdHV0aW9ucygpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSBjYXRjaCAoZSkge1xuXHRcdFx0XHRcdGNvbnN0IGVvcCA9IHtcblx0XHRcdFx0XHRcdHdobzogJ2Vycm9yJyxcblx0XHRcdFx0XHRcdHR5cGU6ICdlcnJvcicsXG5cdFx0XHRcdFx0XHRjb250ZW50OiBgJHtlfWAsXG5cdFx0XHRcdFx0fTtcblx0XHRcdFx0XHRkMjAudGV4dGNoYXQuaW5jb21pbmcoZmFsc2UsIGVvcCk7XG5cdFx0XHRcdH1cblx0XHRcdH07XG5cblx0XHRcdGxldCBwcm9jZXNzTXVsdGlPcHMgPSBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdC8vIEFsbG93IGhhdmluZyBcXG4gaW5zaWRlIG9mIHJvbGwgdGVtcGxhdGVzLlxuXHRcdFx0XHRjb25zdCBicmFja2V0cmVnZXggPSAve3tbXFxzXFxTXSo/fX0vZztcblxuXHRcdFx0XHRvcC5jb250ZW50ID0gb3AuY29udGVudC5yZXBsYWNlKGJyYWNrZXRyZWdleCwgKG1hdGNoKSA9PiBtYXRjaC5yZXBsYWNlKC9cXG4vZywgJyVORVdMSU5FJScpKTtcblxuXHRcdFx0XHRjb25zdCBtdWx0aWNvbW1hbmRzID0gb3AuY29udGVudC5zcGxpdCgnXFxuJyk7XG5cblx0XHRcdFx0bGV0IG9yZGVyZWRvcHMgPSBbXTtcblx0XHRcdFx0bGV0IGZpbmlzaGVkb3BzID0gMDtcblxuXHRcdFx0XHRjb25zdCBjaGVja0ZpbmlzaGVkT3BzID0gZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRcdGlmICghb3JkZXJlZG9wcyB8fCBmaW5pc2hlZG9wcyA8IG9yZGVyZWRvcHMubGVuZ3RoKSB7XG5cdFx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0Y29uc3QgYWxsUHJvbWlzZXMgPSBbXTtcblxuXHRcdFx0XHRcdGZvciAobGV0IGogPSAwOyBqIDwgb3JkZXJlZG9wcy5sZW5ndGg7IGorKykge1xuXHRcdFx0XHRcdFx0aWYgKG9yZGVyZWRvcHNbal0gPT09ICdub29wJykge1xuXHRcdFx0XHRcdFx0XHRjb250aW51ZTtcblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0Ly8gVGhpcyBwcm9taXNlIHdpbGwgYWxsb3cgdXMgdG8gcGF1c2UgaGVyZSBhbmQgd2FpdCBmb3IgY29tcHV0ZWQgZGljZSByZXN1bHRzLCBpZiBuZWVkZWRcblx0XHRcdFx0XHRcdGNvbnN0IHJvbGxQcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcblx0XHRcdFx0XHRcdFx0Y29uc3QgY2hhdE9wID0gb3JkZXJlZG9wc1tqXTtcblx0XHRcdFx0XHRcdFx0aWYgKG9yaWdpbmFsUm9sbFByb21pc2UpIHtcblx0XHRcdFx0XHRcdFx0XHQvLyBJZiB0aGlzIHJvbGwgd2FzIGluaXRpYXRlZCB3aXRoIHRoZSAnc3RhcnRSb2xsJyBzaGVldHdvcmtlciBmdW5jdGlvblxuXHRcdFx0XHRcdFx0XHRcdC8vIFdlIG5lZWQgdG8gcGF1c2UgaGVyZSBhbmQgd2FpdCBmb3IgdGhlIG1vZGlmaWVkIHJlc3VsdHMgZnJvbSB0aGUgJ2ZpbmlzaFJvbGwnIGZ1bmN0aW9uXG5cblx0XHRcdFx0XHRcdFx0XHQvLyBSZWZvcm1hdCByZXN1bHRzIGZyb20gZGljZSBzZXJ2ZXJcblx0XHRcdFx0XHRcdFx0XHRjb25zdCBwcm9jZXNzZWRSZXN1bHRzID0gcGFyc2VSb2xsRGF0YShjaGF0T3ApO1xuXHRcdFx0XHRcdFx0XHRcdC8vIENyZWF0ZSBhIG5ldyBwcm9taXNlIHRoYXQgd2lsbCBiZSByZXNvbHZlZCB3aXRoIHRoZSAnZmluaXNoUm9sbCcgc2hlZXR3b3JrZXIgZnVuY3Rpb25cblx0XHRcdFx0XHRcdFx0XHRjb25zdCBmaW5hbFJvbGxQcm9taXNlID0gY3JlYXRlUm9sbFByb21pc2UoZDIwLmpvdXJuYWwucGVuZGluZ1JvbGxQcm9taXNlcywgb3JpZ2luYWxSb2xsUHJvbWlzZS5wcm9taXNlSWQpO1xuXHRcdFx0XHRcdFx0XHRcdC8vIFRoaXMgd2lsbCByZXNvbHZlIHRoZSBpbml0aWFsIHJvbGwgcHJvbWlzZSBhbmQgc2VuZCB0aGUgcmVzdWx0cyBmcm9tIHRoZSBkaWNlIHNlcnZlclxuXHRcdFx0XHRcdFx0XHRcdC8vIHRvIHRoZSBzaGVldHdvcmtlclxuXHRcdFx0XHRcdFx0XHRcdG9yaWdpbmFsUm9sbFByb21pc2UucmVzb2x2ZSh7XG5cdFx0XHRcdFx0XHRcdFx0XHRyb2xsSWQ6IGZpbmFsUm9sbFByb21pc2UucHJvbWlzZUlkLFxuXHRcdFx0XHRcdFx0XHRcdFx0cmVzdWx0czogcHJvY2Vzc2VkUmVzdWx0cyxcblx0XHRcdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdFx0XHQvLyBUaGlzIHByb21pc2Ugd2lsbCBiZSByZXNvbHZlZCB3aGVuIHRoZSBzaGVldCBjYWxscyB0aGUgZmluaXNoUm9sbCBmdW5jdGlvbixcblx0XHRcdFx0XHRcdFx0XHQvLyBBbmQgd2lsbCBpbmNsdWRlIHRoZSBmaW5hbCByb2xsIHN0cmluZywgYWxvbmcgd2l0aCB0aGUgY3VzdG9tIGNvbXB1dGVkIHJvbGwgcmVzdWx0c1xuXHRcdFx0XHRcdFx0XHRcdGZpbmFsUm9sbFByb21pc2UucHJvbWlzZS50aGVuKChyZXN1bHRzKSA9PiB7XG5cdFx0XHRcdFx0XHRcdFx0XHQvLyBNYXJrIHRoZSBwcm9taXNlIGFzIHJlc29sdmVkLCBzbyB0aGF0IGl0IGRvZXNuJ3QgZ2V0IHRpbWVkIG91dFxuXHRcdFx0XHRcdFx0XHRcdFx0ZmluYWxSb2xsUHJvbWlzZS5yZXNvbHZlZCA9IHRydWU7XG5cdFx0XHRcdFx0XHRcdFx0XHQvLyBBZGQgdGhlIGNvbXB1dGVkIHJlc3VsdCB0byBlYWNoIHJvbGwsIGlmIHByb3ZpZGVkXG5cdFx0XHRcdFx0XHRcdFx0XHRhZGRDb21wdXRlZFJlc3VsdHMoY2hhdE9wLCByZXN1bHRzLnJvbGxSZXN1bHRzLCBkMjAudXRpbHMuc3RyaXBfdGFncyk7XG5cdFx0XHRcdFx0XHRcdFx0XHQvLyBBZnRlciB3ZSd2ZSBtb2RpZmllZCB0aGUgcm9sbCB3aXRoIG91ciBuZXcgaW5mb3JtYXRpb25cblx0XHRcdFx0XHRcdFx0XHRcdC8vIHJlc29sdmUgdG8gc2VuZCBpdCB0byBmaXJlYmFzZVxuXHRcdFx0XHRcdFx0XHRcdFx0cmVzb2x2ZShjaGF0T3ApO1xuXHRcdFx0XHRcdFx0XHRcdH0pLmNhdGNoKCgpID0+IHtcblx0XHRcdFx0XHRcdFx0XHRcdC8vIElmIHdlJ3JlIHJlamVjdGVkLCBpdCBtZWFucyB3ZSd2ZSB0aW1lZCBvdXQuIFBvc3QgdGhlIHJvbGwgYW5kIGEgbWVzc2FnZSB0aGF0XG5cdFx0XHRcdFx0XHRcdFx0XHQvLyBXZSBuZXZlciBnb3QgdGhlIHJlc3VsdHMgYmFjay4gVGhpcyBoZWxwcyBwcmV2ZW50ICdzd2FsbG93aW5nJyB1bmRlc2lyYWJsZSByb2xsIHJlc3VsdHNcblx0XHRcdFx0XHRcdFx0XHRcdGNoYXRPcC5jb250ZW50ID0gYCR7aTE4bignc2hlZXR3b3JrZXJfcm9sbF9ub3RfZmluaXNoZWQnKX0gJHtjaGF0T3AuY29udGVudH1gO1xuXHRcdFx0XHRcdFx0XHRcdFx0cmVzb2x2ZShjaGF0T3ApO1xuXHRcdFx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRcdC8vIElmIHRoaXMgcm9sbCB3YXNuJ3QgaW5pdGlhdGVkIHdpdGggdGhlICdzdGFydFJvbGwnIHNoZWV0d29ya2VyIGZ1bmN0aW9uXG5cdFx0XHRcdFx0XHRcdFx0Ly8gUmVzb2x2ZSBpbW1lZGlhdGVseSB0byBzZW5kIHRvIGZpcmViYXNlIGFzIHVzdWFsXG5cdFx0XHRcdFx0XHRcdFx0cmVzb2x2ZShjaGF0T3ApO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9KS50aGVuKChjaGF0T3ApID0+IHtcblx0XHRcdFx0XHRcdFx0aWYgKGNoYXRPcC5fZmJpZCkge1xuXHRcdFx0XHRcdFx0XHRcdGNvbnN0IF9vcGlkID0gY2hhdE9wLl9mYmlkO1xuXHRcdFx0XHRcdFx0XHRcdGRlbGV0ZSBjaGF0T3AuX2ZiaWQ7XG5cdFx0XHRcdFx0XHRcdFx0aWYgKGQyMC50ZXh0Y2hhdC50YWxrdG9teXNlbGYpIHtcblx0XHRcdFx0XHRcdFx0XHRcdGNoYXRPcC5pZCA9IF9vcGlkO1xuXHRcdFx0XHRcdFx0XHRcdFx0Y2hhdE9wLnRpbWVzdGFtcCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuXHRcdFx0XHRcdFx0XHRcdFx0ZDIwLnRleHRjaGF0LmluY29taW5nKHRydWUsIGNoYXRPcCk7XG5cdFx0XHRcdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdFx0XHRcdHNlbmRHQUNoYXRFdmVudChjaGF0T3ApO1xuXHRcdFx0XHRcdFx0XHRcdFx0ZmJyZWZcblx0XHRcdFx0XHRcdFx0XHRcdFx0LmNoaWxkKF9vcGlkKVxuXHRcdFx0XHRcdFx0XHRcdFx0XHQuc2V0V2l0aFByaW9yaXR5KFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdGNoYXRPcCxcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRmaXJlYmFzZS5kYXRhYmFzZS5TZXJ2ZXJWYWx1ZS5USU1FU1RBTVAsXG5cdFx0XHRcdFx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHR9IGVsc2UgaWYgKGQyMC50ZXh0Y2hhdC50YWxrdG9teXNlbGYpIHtcblx0XHRcdFx0XHRcdFx0XHRjaGF0T3AuaWQgPSBmYnJlZi5wdXNoKCkua2V5O1xuXHRcdFx0XHRcdFx0XHRcdGNoYXRPcC50aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcblx0XHRcdFx0XHRcdFx0XHRzZW5kR0FDaGF0RXZlbnQoY2hhdE9wKTtcblx0XHRcdFx0XHRcdFx0XHRkMjAudGV4dGNoYXQuaW5jb21pbmcodHJ1ZSwgY2hhdE9wKTtcblx0XHRcdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdFx0XHRjb25zdCBuZXdpZCA9IGZicmVmLnB1c2goKS5rZXk7XG5cdFx0XHRcdFx0XHRcdFx0c2VuZEdBQ2hhdEV2ZW50KGNoYXRPcCk7XG5cdFx0XHRcdFx0XHRcdFx0ZmJyZWZcblx0XHRcdFx0XHRcdFx0XHRcdC5jaGlsZChuZXdpZClcblx0XHRcdFx0XHRcdFx0XHRcdC5zZXRXaXRoUHJpb3JpdHkoY2hhdE9wLCBmaXJlYmFzZS5kYXRhYmFzZS5TZXJ2ZXJWYWx1ZS5USU1FU1RBTVApO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9KTtcblxuXHRcdFx0XHRcdFx0YWxsUHJvbWlzZXMucHVzaChyb2xsUHJvbWlzZSk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0Ly8gV2FpdCBmb3IgY2xlYW51cCB1bnRpbCBhbGwgcm9sbHMgaGF2ZSBmaW5pc2hlZFxuXHRcdFx0XHRcdFByb21pc2UuYWxsKGFsbFByb21pc2VzKS50aGVuKCgpID0+IHtcblx0XHRcdFx0XHRcdGNsZWFudXBSb2xsKCk7XG5cdFx0XHRcdFx0XHRvcmRlcmVkb3BzID0gbnVsbDtcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fTtcblxuXHRcdFx0XHRsZXQgaSA9IDA7XG5cblx0XHRcdFx0Xy5lYWNoKG11bHRpY29tbWFuZHMsIChzcGxpdGNvbnRlbnQpID0+IHtcblx0XHRcdFx0XHRvcmRlcmVkb3BzLnB1c2goZmFsc2UpO1xuXHRcdFx0XHRcdGNvbnN0IHRlbXBvcCA9IF8uY2xvbmUob3ApO1xuXHRcdFx0XHRcdHRlbXBvcC5jb250ZW50ID0gc3BsaXRjb250ZW50O1xuXG5cdFx0XHRcdFx0dGVtcG9wLmNvbnRlbnQgPSB0ZW1wb3AuY29udGVudC5yZXBsYWNlKC8lTkVXTElORSUvZywgJzxici8+XFxuJyk7XG5cblx0XHRcdFx0XHRjb25zdCBpZHggPSBpICsgMDtcblx0XHRcdFx0XHRsZXQgX3VzZXJvbGx0ZW1wbGF0ZTtcblxuXHRcdFx0XHRcdGNvbnN0IGNhbGxiYWNrID0gZnVuY3Rpb24gKHRoaXNvcCkge1xuXHRcdFx0XHRcdFx0aWYgKHR5cGVvZiB0aGlzb3AgPT09ICdvYmplY3QnKSB7XG5cdFx0XHRcdFx0XHRcdC8vIE1ha2Ugc3VyZSBvdXIgaW5saW5lIHJvbGxzIHN1cnZpdmVkLlxuXHRcdFx0XHRcdFx0XHRpZiAodGVtcG9wLmlubGluZXJvbGxzKSB7XG5cdFx0XHRcdFx0XHRcdFx0dGhpc29wLmlubGluZXJvbGxzID0gdGVtcG9wLmlubGluZXJvbGxzO1xuXHRcdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdFx0aWYgKF91c2Vyb2xsdGVtcGxhdGUpIHtcblx0XHRcdFx0XHRcdFx0XHR0aGlzb3Aucm9sbHRlbXBsYXRlID0gX3VzZXJvbGx0ZW1wbGF0ZTtcblx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdC8vIERlbGV0ZSB1bm5lZWRlZCBpbmZvXG5cdFx0XHRcdFx0XHRcdGRlbGV0ZSB0aGlzb3AuY3VycmVudFNlbGVjdGVkO1xuXHRcdFx0XHRcdFx0XHRkZWxldGUgdGhpc29wLm9wdHM7XG5cblx0XHRcdFx0XHRcdFx0aWYgKHRoaXNvcC50eXBlID09ICdhcGknKSB7XG5cdFx0XHRcdFx0XHRcdFx0Ly8gQWRkIFwiU2VsZWN0ZWRcIiBpbmZvLlxuXHRcdFx0XHRcdFx0XHRcdGNvbnN0IHNlbGVjdGVkID0gZDIwLmVuZ2luZS5zZWxlY3RlZCgpO1xuXHRcdFx0XHRcdFx0XHRcdGlmIChzZWxlY3RlZCAmJiBzZWxlY3RlZC5sZW5ndGggPiAwKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHR0aGlzb3Auc2VsZWN0ZWQgPSBbXTtcblx0XHRcdFx0XHRcdFx0XHRcdF8uZWFjaChzZWxlY3RlZCwgKGFub2JqKSA9PiB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdGlmIChhbm9iai5tb2RlbCA9PSB1bmRlZmluZWQpIHJldHVybiB0cnVlOyAvLyBuZXh0XG5cdFx0XHRcdFx0XHRcdFx0XHRcdHRoaXNvcC5zZWxlY3RlZC5wdXNoKHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRfdHlwZTogYW5vYmoubW9kZWwuZ2V0KCd0eXBlJykgPT0gJ2ltYWdlJyA/ICdncmFwaGljJyA6IGFub2JqLm1vZGVsLmdldCgndHlwZScpLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdF9pZDogYW5vYmoubW9kZWwuaWQsXG5cdFx0XHRcdFx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRvcmRlcmVkb3BzW2lkeF0gPSB0aGlzb3A7XG5cdFx0XHRcdFx0XHRmaW5pc2hlZG9wcysrO1xuXHRcdFx0XHRcdFx0Xy5kZWZlcigoKSA9PiB7XG5cdFx0XHRcdFx0XHRcdGNoZWNrRmluaXNoZWRPcHMoKTtcblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdH07XG5cblx0XHRcdFx0XHRjb25zdCBpbmxpbmVSb2xsc0NvbXBsZXRlQ2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdFx0XHQvLyBDaGVjayBmb3Igb3B0aW9ucy5cblx0XHRcdFx0XHRcdGlmICghbm9QYXJzZUNvbW1hbmRzKSB7XG5cdFx0XHRcdFx0XHRcdHRlbXBvcC5jb250ZW50ID0gdGVtcG9wLmNvbnRlbnQucmVwbGFjZShvcHRyZWcsIChtYXRjaCkgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdG1hdGNoID0gbWF0Y2guc3Vic3RyaW5nKDIsIG1hdGNoLmxlbmd0aCAtIDEpO1xuXHRcdFx0XHRcdFx0XHRcdGlmICghdGVtcG9wLm9wdHMpIHRlbXBvcC5vcHRzID0ge307XG5cdFx0XHRcdFx0XHRcdFx0Y29uc3QgZWFjaG9wdCA9IG1hdGNoLnNwbGl0KCcsJyk7XG5cdFx0XHRcdFx0XHRcdFx0Zm9yIChsZXQgb2kgPSAwOyBvaSA8IGVhY2hvcHQubGVuZ3RoOyBvaSsrKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRjb25zdCBvcHRzcGxpdCA9IGVhY2hvcHRbb2ldLnNwbGl0KCc6Jyk7XG5cdFx0XHRcdFx0XHRcdFx0XHR0ZW1wb3Aub3B0c1tvcHRzcGxpdFswXV0gPSBvcHRzcGxpdC5sZW5ndGggPiAxID8gb3B0c3BsaXRbMV0gOiB0cnVlO1xuXHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gJyc7XG5cdFx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRpZiAodGVtcG9wLm9wdHMgJiYgdGVtcG9wLm9wdHMudGVtcGxhdGUgIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHRcdFx0XHRfdXNlcm9sbHRlbXBsYXRlID0gdGVtcG9wLm9wdHMudGVtcGxhdGU7XG5cdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdGlmICh0ZW1wb3AuY29udGVudC5zdWJzdHJpbmcoMCwgMikgPT09ICcvLycpIHtcblx0XHRcdFx0XHRcdFx0Y2FsbGJhY2soJ25vb3AnKTtcblx0XHRcdFx0XHRcdH0gZWxzZSBpZiAoXG5cdFx0XHRcdFx0XHRcdCFub1BhcnNlQ29tbWFuZHMgJiYgdGVtcG9wLmNvbnRlbnQuc3Vic3RyaW5nKDAsIDEpID09ICcvJ1xuXHRcdFx0XHRcdFx0KSB7XG5cdFx0XHRcdFx0XHRcdHBvc3RQcm9jZXNzT3AodGVtcG9wLCBjYWxsYmFjayk7XG5cdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRpZiAoIW5vUGFyc2VDb21tYW5kcyAmJiB0ZW1wb3AuY29udGVudC5zdWJzdHJpbmcoMCwgMSkgPT0gJyEnKSB7XG5cdFx0XHRcdFx0XHRcdFx0dGVtcG9wLnR5cGUgPSAnYXBpJztcblx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdGNhbGxiYWNrKHRlbXBvcCk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fTtcblxuXHRcdFx0XHRcdGlmICghbm9QYXJzZUNvbW1hbmRzKSB7XG5cdFx0XHRcdFx0XHRwcm9jZXNzSW5saW5lUm9sbHModGVtcG9wLCBpbmxpbmVSb2xsc0NvbXBsZXRlQ2FsbGJhY2spO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRpbmxpbmVSb2xsc0NvbXBsZXRlQ2FsbGJhY2soKTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRkMjAudGV4dGNoYXQuZGljZWVuZ2luZS5mbHVzaFJlbW90ZVF1ZXVlKCk7XG5cblx0XHRcdFx0XHRpKys7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fTtcblxuXHRcdFx0dmFyIHByb2Nlc3NJbmxpbmVSb2xscyA9IGZ1bmN0aW9uICh0aGlzb3AsIHRoaXNvcGNhbGxiYWNrKSB7XG5cdFx0XHRcdC8vIFJlc29sdmUgYWxsIGlubGluZSByb2xsIHJlc3VsdHMuXG5cblx0XHRcdFx0Y29uc3QgaW5saW5lcm9sbHJlZyA9IC8oXFxbXFxbLitcXF1cXF0oPyFcXF0pKS9nbTtcblx0XHRcdFx0Y29uc3QgaW5saW5lcm9sbHMgPSBbXTtcblx0XHRcdFx0bGV0IGlubGluZXJvbGxjb3VudCA9IDA7XG5cdFx0XHRcdGxldCBpbmxpbmVyb2xsc2NvbXBsZXRlZCA9IDA7XG5cblx0XHRcdFx0Y29uc3QgY2hlY2tGaW5pc2hlZElubGluZVJvbGxzID0gZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRcdGlmIChpbmxpbmVyb2xsc2NvbXBsZXRlZCA8IGlubGluZXJvbGxjb3VudCkgcmV0dXJuO1xuXHRcdFx0XHRcdHRoaXNvcC5pbmxpbmVyb2xscyA9IGlubGluZXJvbGxzO1xuXHRcdFx0XHRcdHRoaXNvcGNhbGxiYWNrKCk7XG5cdFx0XHRcdH07XG5cblx0XHRcdFx0Y29uc3QgX2ZpbmRJbmxpbmVSb2xscyA9IGZ1bmN0aW9uIChzdWJjb250ZW50LCBpbmxpbmVjYWxsYmFjaykge1xuXHRcdFx0XHRcdGNvbnN0IHN0cmluZ1N0YXJ0cyA9IFtdO1xuXHRcdFx0XHRcdGNvbnN0IGlnbm9yZUJyYWNrZXRzQXQgPSBbXTtcblx0XHRcdFx0XHRsZXQgaWdub3JlbmV4dCA9IGZhbHNlO1xuXHRcdFx0XHRcdGxldCBpbmNvbW1lbnQgPSBmYWxzZTtcblx0XHRcdFx0XHRsZXQgbGV2ZWxzZGVlcCA9IDA7XG5cdFx0XHRcdFx0bGV0IHN0b3BwYXJzaW5nID0gZmFsc2U7XG5cblx0XHRcdFx0XHR3aGlsZSAoIXN0b3BwYXJzaW5nKSB7XG5cdFx0XHRcdFx0XHRmb3IgKHZhciBpID0gMDsgaSA8IHN1YmNvbnRlbnQubGVuZ3RoOyBpKyspIHtcblx0XHRcdFx0XHRcdFx0aWYgKHN1YmNvbnRlbnRbaV0gPT09ICdbJykge1xuXHRcdFx0XHRcdFx0XHRcdGlmIChzdWJjb250ZW50W2kgLSAxXSA9PT0gJ1snKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHQvLyBTdGFydGVkIG9uZSFcblxuXHRcdFx0XHRcdFx0XHRcdFx0bGV2ZWxzZGVlcCsrO1xuXG5cdFx0XHRcdFx0XHRcdFx0XHRpZiAoc3ViY29udGVudFtpIC0gMl0gPT09ICckJykge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHQvLyBUaGlzIGlzIGEgcmVzdWx0LCBub3QgYW4gYWN0dWFsIHJvbGwuXG5cdFx0XHRcdFx0XHRcdFx0XHRcdGlnbm9yZW5leHQgPSB0cnVlO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRjb250aW51ZTtcblx0XHRcdFx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdHN0cmluZ1N0YXJ0cy5wdXNoKGkgLSAxKTtcblx0XHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHR9IGVsc2UgaWYgKHN1YmNvbnRlbnRbaSArIDFdID09PSAnWycpIHtcblx0XHRcdFx0XHRcdFx0XHRcdC8vIERvIG5vdGhpbmcsIHdlJ2xsIGdldCBpdCBuZXh0IGxvb3Bcblx0XHRcdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRcdFx0Ly8gQ29tbWVudFxuXHRcdFx0XHRcdFx0XHRcdFx0aW5jb21tZW50ID0gdHJ1ZTtcblx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdH0gZWxzZSBpZiAoc3ViY29udGVudFtpXSA9PT0gJ10nKSB7XG5cdFx0XHRcdFx0XHRcdFx0aWYgKGluY29tbWVudCkge1xuXHRcdFx0XHRcdFx0XHRcdFx0aW5jb21tZW50ID0gZmFsc2U7XG5cdFx0XHRcdFx0XHRcdFx0XHRpZ25vcmVCcmFja2V0c0F0LnB1c2goaSk7XG5cdFx0XHRcdFx0XHRcdFx0XHRjb250aW51ZTtcblx0XHRcdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRcdFx0XHRzdWJjb250ZW50W2kgLSAxXSA9PT0gJ10nICYmIGlnbm9yZUJyYWNrZXRzQXQuaW5kZXhPZihpIC0gMSkgPT09IC0xXG5cdFx0XHRcdFx0XHRcdFx0KSB7XG5cdFx0XHRcdFx0XHRcdFx0XHQvLyBTdG9wcGVkIG9uZSFcblxuXHRcdFx0XHRcdFx0XHRcdFx0bGV2ZWxzZGVlcC0tO1xuXG5cdFx0XHRcdFx0XHRcdFx0XHRpZiAoaWdub3JlbmV4dCkge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRpZ25vcmVuZXh0ID0gZmFsc2U7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdGNvbnRpbnVlO1xuXHRcdFx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdFx0XHR2YXIgc3RhcnRlZEF0ID0gc3RyaW5nU3RhcnRzLnNsaWNlKC0xKVswXTtcblx0XHRcdFx0XHRcdFx0XHRcdHZhciByb2xsc3RyaW5nID0gc3ViY29udGVudC5zdWJzdHJpbmcoc3RhcnRlZEF0LCBpICsgMSk7XG5cblx0XHRcdFx0XHRcdFx0XHRcdGlmIChyb2xsc3RyaW5nLmluZGV4T2YoJyRbWycpICE9PSAtMSkge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRjb250aW51ZTtcblx0XHRcdFx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0XHRcdFx0KGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0Y29uc3QgbXlpbmxpbmVyb2xsaW5kZXggPSBpbmxpbmVyb2xsY291bnQgKyAwO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRjb25zdCBteWxldmVsc2RlZXAgPSBsZXZlbHNkZWVwICsgMDtcblx0XHRcdFx0XHRcdFx0XHRcdFx0aW5saW5lcm9sbGNvdW50Kys7IC8vIGdsb2JhbCBjb3VudGVyXG5cblx0XHRcdFx0XHRcdFx0XHRcdFx0c3ViY29udGVudCA9IGAke3N1YmNvbnRlbnQuc3Vic3RyaW5nKFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdDAsXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0c3RhcnRlZEF0LFxuXHRcdFx0XHRcdFx0XHRcdFx0XHQpfSRbWyR7bXlpbmxpbmVyb2xsaW5kZXh9XV0ke3N1YmNvbnRlbnQuc3Vic3RyaW5nKFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdGkgKyAxLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdHN1YmNvbnRlbnQubGVuZ3RoLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHQpfWA7XG5cblx0XHRcdFx0XHRcdFx0XHRcdFx0dGhpc29wLmNvbnRlbnQgPSBzdWJjb250ZW50O1xuXG5cdFx0XHRcdFx0XHRcdFx0XHRcdF9wcm9jZXNzUm9sbChyb2xsc3RyaW5nLCBteWlubGluZXJvbGxpbmRleCwgKCkgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdGlmIChteWxldmVsc2RlZXAgPiAwKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHQvLyBXZSdyZSBhIG5lc3RlZCByb2xsLCBzbyBzdWJzdGl0dXRlIGluIHRoZSByZXN1bHQgdmFsdWUgKmltbWVkaWF0ZWx5Ki5cblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdHRoaXNvcC5jb250ZW50ID0gdGhpc29wLmNvbnRlbnQucmVwbGFjZShcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0YCRbWyR7bXlpbmxpbmVyb2xsaW5kZXh9XV1gLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRpbmxpbmVyb2xsc1tteWlubGluZXJvbGxpbmRleF0ucmVzdWx0cy50b3RhbCxcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0aW5saW5lY2FsbGJhY2soKTtcblx0XHRcdFx0XHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRcdFx0XHR9KCkpO1xuXG5cdFx0XHRcdFx0XHRcdFx0XHRpZiAobGV2ZWxzZGVlcCA+IDApIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0ZDIwLnRleHRjaGF0LmRpY2VlbmdpbmUuZmx1c2hSZW1vdGVRdWV1ZSgpO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdFx0XHRicmVhazsgLy8gdGhpcyB3aWxsIGFsbG93IHVzIHRvIHJlLXN0YXJ0IG91ciBsb29wIHRvIGdldCBhbiBhY2N1cmF0ZSBsZW5ndGggY291bnQgc2luY2UgYSBzdWJzdGl0dXRpb24gaGFzIGJlZW4gbWFkZS5cblx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0c3RvcHBhcnNpbmcgPSB0cnVlOyAvLyBpZiB3ZSBkaWRuJ3QgYnJlYWssIHdlIGRpZG4ndCBkbyBhbnkgc3Vic2l0dXRpb25zLCBzbyBmYWxsIHRocm91Z2ggY29tcGxldGVseSBhbmQgZmluaXNoLlxuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdC8vIE1hZGUgaXQgYWxsIHRoZSB3YXkgdGhyb3VnaD8gTm90aGluZyBsZWZ0IHRvIGRvIVxuXHRcdFx0XHRcdGlubGluZWNhbGxiYWNrKHN1YmNvbnRlbnQpO1xuXHRcdFx0XHR9O1xuXG5cdFx0XHRcdHZhciBfcHJvY2Vzc1JvbGwgPSBmdW5jdGlvbiAobWF0Y2gsIG15aW5saW5lcm9sbGluZGV4LCByb2xsY2FsbGJhY2spIHtcblx0XHRcdFx0XHRtYXRjaCA9ICQudHJpbShtYXRjaC5zdWJzdHJpbmcoMiwgbWF0Y2gubGVuZ3RoIC0gMikpO1xuXG5cdFx0XHRcdFx0Y29uc3QgaW5saW5lb3B0cyA9IHt9O1xuXG5cdFx0XHRcdFx0Ly8gQ2hlY2sgZm9yIG9wdGlvbnMuXG5cdFx0XHRcdFx0bWF0Y2ggPSBtYXRjaC5yZXBsYWNlKG9wdHJlZywgKG9wdG1hdGNoKSA9PiB7XG5cdFx0XHRcdFx0XHRvcHRtYXRjaCA9IG9wdG1hdGNoLnN1YnN0cmluZygyLCBvcHRtYXRjaC5sZW5ndGggLSAxKTtcblx0XHRcdFx0XHRcdGNvbnN0IGVhY2hvcHQgPSBvcHRtYXRjaC5zcGxpdCgnLCcpO1xuXHRcdFx0XHRcdFx0Zm9yIChsZXQgb2kgPSAwOyBvaSA8IGVhY2hvcHQubGVuZ3RoOyBvaSsrKSB7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IG9wdHNwbGl0ID0gZWFjaG9wdFtvaV0uc3BsaXQoJzonKTtcblx0XHRcdFx0XHRcdFx0aW5saW5lb3B0c1tvcHRzcGxpdFswXV0gPSBvcHRzcGxpdC5sZW5ndGggPiAxID8gb3B0c3BsaXRbMV0gOiB0cnVlO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0cmV0dXJuICcnO1xuXHRcdFx0XHRcdH0pO1xuXG5cdFx0XHRcdFx0ZDIwLnRleHRjaGF0LmRpY2VlbmdpbmUucHJvY2Vzcyhcblx0XHRcdFx0XHRcdG1hdGNoLFxuXHRcdFx0XHRcdFx0KHJlc3VsdHMsIHJvbGxpZCwgc2lnbmF0dXJlLCB0ZHNlZWQpID0+IHtcblx0XHRcdFx0XHRcdFx0ZDIwLnRleHRjaGF0Lmdsb2JhbHJvbGxlZCsrO1xuXG5cdFx0XHRcdFx0XHRcdGlmIChyZXN1bHRzLnJvbGxzICYmIHJlc3VsdHMucm9sbHMubGVuZ3RoID4gMCkge1xuXHRcdFx0XHRcdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRfLmVhY2gocmVzdWx0cy5yb2xscywgKHJvbGwpID0+IHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0aWYgKHJvbGwudGFibGUpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRpZiAoIWQyMC51dGlscy5zdGF0dHJhY2tlci5yb2xsdGFibGVzKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRkMjAudXRpbHMuc3RhdHRyYWNrZXIucm9sbHRhYmxlcyA9IHRydWU7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0Y29uc3QgdGFibGUgPSBkMjAuQ2FtcGFpZ24ucm9sbGFibGV0YWJsZXMuZmluZFRhYmxlQnlOYW1lKFxuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0cm9sbC50YWJsZSxcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdGNvbnN0IHdlaWdodGVkID0gdGFibGUuZ2V0V2VpZ2h0ZWRBcnJheSgpO1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdGlmICh0YWJsZSkge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0Xy5lYWNoKHJvbGwucmVzdWx0cywgKHJlc3VsdCkgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRyZXN1bHQudGFibGVJdGVtID0gdGFibGUudGFibGVpdGVtc1xuXHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdC5nZXQod2VpZ2h0ZWRbcmVzdWx0LnRhYmxlaWR4XSlcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHQudG9KU09OKCk7XG5cdFx0XHRcdFx0XHRcdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0XHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdFx0XHRcdFx0XHRcdGNvbnNvbGUubG9nKCdFUlJPUiBtYXRjaGluZyB0YWJsZScpO1xuXHRcdFx0XHRcdFx0XHRcdFx0Y29uc29sZS5sb2coZSk7XG5cdFx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdFx0aW5saW5lcm9sbHNbbXlpbmxpbmVyb2xsaW5kZXhdID0ge1xuXHRcdFx0XHRcdFx0XHRcdGV4cHJlc3Npb246IG1hdGNoLFxuXHRcdFx0XHRcdFx0XHRcdHJlc3VsdHMsXG5cdFx0XHRcdFx0XHRcdFx0c2lnbmF0dXJlLFxuXHRcdFx0XHRcdFx0XHRcdHJvbGxpZCxcblx0XHRcdFx0XHRcdFx0fTtcblxuXHRcdFx0XHRcdFx0XHRpZiAodGRzZWVkKSB7XG5cdFx0XHRcdFx0XHRcdFx0aW5saW5lcm9sbHNbbXlpbmxpbmVyb2xsaW5kZXhdLnRkc2VlZCA9IHRkc2VlZDtcblx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdGlmIChpbmxpbmVvcHRzLnRyYWNrZXIpIHtcblx0XHRcdFx0XHRcdFx0XHRzZW5kUmVzdWx0VG9UcmFja2VyKFxuXHRcdFx0XHRcdFx0XHRcdFx0dGhpc29wLmN1cnJlbnRTZWxlY3RlZCxcblx0XHRcdFx0XHRcdFx0XHRcdHJlc3VsdHMsXG5cdFx0XHRcdFx0XHRcdFx0XHRpbmxpbmVvcHRzLnRyYWNrZXIsXG5cdFx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdGlubGluZXJvbGxzY29tcGxldGVkKys7XG5cblx0XHRcdFx0XHRcdFx0cm9sbGNhbGxiYWNrKCk7XG5cdFx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdH07XG5cblx0XHRcdFx0bGV0IHByZXZzdHJpbmcgPSAnJztcblxuXHRcdFx0XHR2YXIgaW5saW5lZmluYWxjYWxsYmFjayA9IGZ1bmN0aW9uIChuZXdjb250ZW50KSB7XG5cdFx0XHRcdFx0aWYgKHByZXZzdHJpbmcgIT09IHRoaXNvcC5jb250ZW50KSB7XG5cdFx0XHRcdFx0XHRwcmV2c3RyaW5nID0gdGhpc29wLmNvbnRlbnQ7XG5cdFx0XHRcdFx0XHRfZmluZElubGluZVJvbGxzKGAke3RoaXNvcC5jb250ZW50fWAsIGlubGluZWZpbmFsY2FsbGJhY2spO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRjaGVja0ZpbmlzaGVkSW5saW5lUm9sbHMoKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH07XG5cblx0XHRcdFx0X2ZpbmRJbmxpbmVSb2xscyhgJHt0aGlzb3AuY29udGVudH1gLCBpbmxpbmVmaW5hbGNhbGxiYWNrKTtcblx0XHRcdH07XG5cblx0XHRcdGNvbnN0IHNlbmRHQUNoYXRFdmVudCA9IChtZXNzYWdlKSA9PiB7XG5cdFx0XHRcdGxldCBwbGF5ZXJfZGlzcGxheV9uYW1lID0gd2luZG93LmN1cnJlbnRQbGF5ZXIuYXR0cmlidXRlcy5kaXNwbGF5bmFtZTtcblx0XHRcdFx0aWYgKHdpbmRvdy5pc19nbSkge1xuXHRcdFx0XHRcdHBsYXllcl9kaXNwbGF5X25hbWUgKz0gJyAoR00pJztcblx0XHRcdFx0fVxuXHRcdFx0XHRjb25zdCBwbGF5ZXJfc2VsZWN0ZWQgPSB3aW5kb3cuY3VycmVudFBsYXllci5hdHRyaWJ1dGVzLnNwZWFraW5nYXMgPT09ICcnIHx8IHdpbmRvdy5jdXJyZW50UGxheWVyLmF0dHJpYnV0ZXMuc3BlYWtpbmdhcy5zcGxpdCgnfCcpWzBdID09PSAncGxheWVyJztcblx0XHRcdFx0Y29uc3Qgb29jID0gIXBsYXllcl9zZWxlY3RlZCAmJiBwbGF5ZXJfZGlzcGxheV9uYW1lID09PSBtZXNzYWdlLndobztcblx0XHRcdFx0Y29uc3Qgc3BlYWtpbmdhcyA9IHBsYXllcl9kaXNwbGF5X25hbWUgPT09IG1lc3NhZ2Uud2hvID8gJ3BsYXllcicgOiAnY2hhcmFjdGVyJztcblx0XHRcdFx0Y29uc3Qgc2VsZWN0ZWRfZGlzcGxheV9uYW1lID0gcGxheWVyX3NlbGVjdGVkXG5cdFx0XHRcdFx0PyBwbGF5ZXJfZGlzcGxheV9uYW1lXG5cdFx0XHRcdFx0OiBkMjAuQ2FtcGFpZ24uY2hhcmFjdGVycy5nZXQoXG5cdFx0XHRcdFx0XHR3aW5kb3cuY3VycmVudFBsYXllci5hdHRyaWJ1dGVzLnNwZWFraW5nYXMuc3BsaXQoJ3wnKVsxXSxcblx0XHRcdFx0XHQpLmF0dHJpYnV0ZXMubmFtZTtcblx0XHRcdFx0Y29uc3QgY3VzdG9tX3NwZWFraW5nYXMgPSBtZXNzYWdlLndobyAhPT0gc2VsZWN0ZWRfZGlzcGxheV9uYW1lICYmICFvb2M7XG5cblx0XHRcdFx0bGV0IGV2ZW50X2FjdGlvbiA9IG1lc3NhZ2UudHlwZSA9PT0gJ3doaXNwZXInICYmIG1lc3NhZ2UudGFyZ2V0ID09PSAnZ20nID8gJ2dtX3doaXNwZXInIDogbWVzc2FnZS50eXBlO1xuXHRcdFx0XHRpZiAoZDIwLnRleHRjaGF0LnRhbGt0b215c2VsZikge1xuXHRcdFx0XHRcdGV2ZW50X2FjdGlvbiA9ICd0YWxrdG9teXNlbGYnO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGlmIChvb2MpIHtcblx0XHRcdFx0XHRldmVudF9hY3Rpb24gPSAnb29jJztcblx0XHRcdFx0fSBlbHNlIGlmIChjdXN0b21fc3BlYWtpbmdhcykge1xuXHRcdFx0XHRcdGV2ZW50X2FjdGlvbiA9ICdjdXN0b21fYXMnO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0Z2EoJ3NlbmQnLCB7XG5cdFx0XHRcdFx0aGl0VHlwZTogJ2V2ZW50Jyxcblx0XHRcdFx0XHRldmVudENhdGVnb3J5OiB3aW5kb3cuaXNfZ20gPyAnR21DaGF0SW5wdXQnIDogJ0NoYXRJbnB1dCcsXG5cdFx0XHRcdFx0ZXZlbnRBY3Rpb246IGV2ZW50X2FjdGlvbixcblx0XHRcdFx0XHRldmVudExhYmVsOiB0cmlnZ2VyZWRfYnksXG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRpZiAoIWQyMC50ZXh0Y2hhdC50YWxrdG9teXNlbGYpIHtcblx0XHRcdFx0XHRnYSgnc2VuZCcsIHtcblx0XHRcdFx0XHRcdGhpdFR5cGU6ICdldmVudCcsXG5cdFx0XHRcdFx0XHRldmVudENhdGVnb3J5OiAnU3BlYWtpbmdBcycsXG5cdFx0XHRcdFx0XHRldmVudEFjdGlvbjogZXZlbnRfYWN0aW9uLFxuXHRcdFx0XHRcdFx0ZXZlbnRMYWJlbDogc3BlYWtpbmdhcyxcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fVxuXHRcdFx0fTtcblxuXHRcdFx0Ly8gUmVzb2x2ZSBhbGwgcXVlcnkgdmFyaWFibGVzLlxuXG5cdFx0XHRjb25zdCBxdWVyeXJlZyA9IC8oXFw/e1tefV0rfSkvbTtcblx0XHRcdGxldCBudW1xdWVyaWVzID0gMDtcblxuXHRcdFx0dmFyIHByb2Nlc3NRdWVyaWVzID0gZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRsZXQgZm91bmRxdWVyeSA9IGZhbHNlO1xuXHRcdFx0XHRvcC5jb250ZW50ID0gb3AuY29udGVudC5yZXBsYWNlKHF1ZXJ5cmVnLCAobWF0Y2gpID0+IHtcblx0XHRcdFx0XHRpZiAobnVtcXVlcmllcyA+IDk5KSByZXR1cm4gbWF0Y2g7XG5cblx0XHRcdFx0XHRmb3VuZHF1ZXJ5ID0gdHJ1ZTtcblx0XHRcdFx0XHRudW1xdWVyaWVzKys7XG5cblx0XHRcdFx0XHRtYXRjaCA9ICQudHJpbShtYXRjaC5zdWJzdHJpbmcoMiwgbWF0Y2gubGVuZ3RoIC0gMSkpO1xuXHRcdFx0XHRcdGNvbnN0IG1zID0gbWF0Y2guc3BsaXQoJ3wnKTtcblx0XHRcdFx0XHRtYXRjaCA9IG1zWzBdO1xuXG5cdFx0XHRcdFx0aWYgKHF1ZXJ5Q2FjaGVbbWF0Y2hdICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0XHRcdF8uZGVmZXIoKCkgPT4ge1xuXHRcdFx0XHRcdFx0XHRwcm9jZXNzUXVlcmllcygpO1xuXHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRyZXR1cm4gcXVlcnlDYWNoZVttYXRjaF07XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0aWYgKG1zLmxlbmd0aCA8PSAyKSB7XG5cdFx0XHRcdFx0XHR2YXIgJHF1ZXJ5ZGlhbG9nID0gJChcblx0XHRcdFx0XHRcdFx0YDxkaXY+PHAgc3R5bGU9J2ZvbnQtc2l6ZTogMS4xNWVtOyc+PHN0cm9uZz4ke2QyMC51dGlscy5zdHJpcF90YWdzKFxuXHRcdFx0XHRcdFx0XHRcdG1hdGNoLFxuXHRcdFx0XHRcdFx0XHQpfTo8L3N0cm9uZz4gPGlucHV0IHR5cGU9J3RleHQnIHN0eWxlPSd3aWR0aDogNzVweDsgbWFyZ2luLWxlZnQ6IDVweDsnPjwvcD48L2Rpdj5gLFxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0Y29uc3Qgb3B0aW9ucyA9IFtdO1xuXHRcdFx0XHRcdFx0bXMuZWFjaCgoZWFjaG9wdCkgPT4ge1xuXHRcdFx0XHRcdFx0XHRjb25zdCBvcHQgPSBlYWNob3B0LnNwbGl0KCcsJyk7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IG9wdGxhYmVsID0gb3B0WzBdO1xuXHRcdFx0XHRcdFx0XHRsZXQgb3B0dmFsdWUgPSBvcHRbMV0gPyBvcHRbMV0gOiBvcHRbMF07XG5cdFx0XHRcdFx0XHRcdG9wdHZhbHVlID0gb3B0dmFsdWUucmVwbGFjZSgvJy9nLCAnJiMzOScpO1xuXG5cdFx0XHRcdFx0XHRcdGlmIChvcHQgIT0gbWF0Y2gpIHtcblx0XHRcdFx0XHRcdFx0XHRvcHRpb25zLnB1c2goXG5cdFx0XHRcdFx0XHRcdFx0XHRgPG9wdGlvbiB2YWx1ZT0nJHtkMjAudXRpbHMuc3RyaXBfdGFncyhcblx0XHRcdFx0XHRcdFx0XHRcdFx0b3B0dmFsdWUsXG5cdFx0XHRcdFx0XHRcdFx0XHQpfSc+JHtkMjAudXRpbHMuc3RyaXBfdGFncyhvcHRsYWJlbCl9PC9vcHRpb24+YCxcblx0XHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdHZhciAkcXVlcnlkaWFsb2cgPSAkKFxuXHRcdFx0XHRcdFx0XHRgPGRpdj48cCBzdHlsZT0nZm9udC1zaXplOiAxLjE1ZW07Jz48c3Ryb25nPiR7ZDIwLnV0aWxzLnN0cmlwX3RhZ3MoXG5cdFx0XHRcdFx0XHRcdFx0bWF0Y2gsXG5cdFx0XHRcdFx0XHRcdCl9Ojwvc3Ryb25nPiA8c2VsZWN0IHN0eWxlPSd3aWR0aDogMTUwcHg7IG1hcmdpbi1sZWZ0OiA1cHg7Jz4ke29wdGlvbnMuam9pbihcblx0XHRcdFx0XHRcdFx0XHQnJyxcblx0XHRcdFx0XHRcdFx0KX08L3NlbGVjdD48L3A+PC9kaXY+YCxcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0JHF1ZXJ5ZGlhbG9nLmRpYWxvZyh7XG5cdFx0XHRcdFx0XHR0aXRsZTogJ0lucHV0IFZhbHVlJyxcblx0XHRcdFx0XHRcdGJlZm9yZUNsb3NlKCkge1xuXHRcdFx0XHRcdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdFx0YnV0dG9uczoge1xuXHRcdFx0XHRcdFx0XHRTdWJtaXQoKSB7XG5cdFx0XHRcdFx0XHRcdFx0aWYgKG1zLmxlbmd0aCA8IDMpIHtcblx0XHRcdFx0XHRcdFx0XHRcdHF1ZXJ5Q2FjaGVbbWF0Y2hdID0gJHF1ZXJ5ZGlhbG9nLmZpbmQoJ2lucHV0JykudmFsKCk7XG5cdFx0XHRcdFx0XHRcdFx0XHRvcC5jb250ZW50ID0gb3AuY29udGVudC5yZXBsYWNlKFxuXHRcdFx0XHRcdFx0XHRcdFx0XHQnPyR7MX0nLFxuXHRcdFx0XHRcdFx0XHRcdFx0XHQkcXVlcnlkaWFsb2cuZmluZCgnaW5wdXQnKS52YWwoKSxcblx0XHRcdFx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdFx0XHRcdHF1ZXJ5Q2FjaGVbbWF0Y2hdID0gJHF1ZXJ5ZGlhbG9nLmZpbmQoJ3NlbGVjdCcpLnZhbCgpO1xuXHRcdFx0XHRcdFx0XHRcdFx0b3AuY29udGVudCA9IG9wLmNvbnRlbnQucmVwbGFjZShcblx0XHRcdFx0XHRcdFx0XHRcdFx0Jz8kezF9Jyxcblx0XHRcdFx0XHRcdFx0XHRcdFx0JHF1ZXJ5ZGlhbG9nLmZpbmQoJ3NlbGVjdCcpLnZhbCgpLFxuXHRcdFx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdFx0JHF1ZXJ5ZGlhbG9nLm9mZigpO1xuXHRcdFx0XHRcdFx0XHRcdCRxdWVyeWRpYWxvZy5kaWFsb2coJ2Rlc3Ryb3knKS5yZW1vdmUoKTtcblx0XHRcdFx0XHRcdFx0XHRwcm9jZXNzUXVlcmllcygpO1xuXHRcdFx0XHRcdFx0XHRcdGQyMC50ZXh0Y2hhdC4kdGV4dGFyZWEuZm9jdXMoKTtcblx0XHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdFx0Q2FuY2VsKCkge1xuXHRcdFx0XHRcdFx0XHRcdCRxdWVyeWRpYWxvZy5vZmYoKTtcblx0XHRcdFx0XHRcdFx0XHQkcXVlcnlkaWFsb2cuZGlhbG9nKCdkZXN0cm95JykucmVtb3ZlKCk7XG5cdFx0XHRcdFx0XHRcdFx0Y2xlYW51cFJvbGwoKTtcblx0XHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdH0sXG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0JHF1ZXJ5ZGlhbG9nLm9uKCdrZXlkb3duJywgJ2lucHV0LCBzZWxlY3QnLCAoZSkgPT4ge1xuXHRcdFx0XHRcdFx0aWYgKGUud2hpY2ggPT0gMTMpIHtcblx0XHRcdFx0XHRcdFx0aWYgKG1zLmxlbmd0aCA8IDMpIHtcblx0XHRcdFx0XHRcdFx0XHRxdWVyeUNhY2hlW21hdGNoXSA9ICRxdWVyeWRpYWxvZy5maW5kKCdpbnB1dCcpLnZhbCgpO1xuXHRcdFx0XHRcdFx0XHRcdG9wLmNvbnRlbnQgPSBvcC5jb250ZW50LnJlcGxhY2UoXG5cdFx0XHRcdFx0XHRcdFx0XHQnPyR7MX0nLFxuXHRcdFx0XHRcdFx0XHRcdFx0JHF1ZXJ5ZGlhbG9nLmZpbmQoJ2lucHV0JykudmFsKCksXG5cdFx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdFx0XHRxdWVyeUNhY2hlW21hdGNoXSA9ICRxdWVyeWRpYWxvZy5maW5kKCdzZWxlY3QnKS52YWwoKTtcblx0XHRcdFx0XHRcdFx0XHRvcC5jb250ZW50ID0gb3AuY29udGVudC5yZXBsYWNlKFxuXHRcdFx0XHRcdFx0XHRcdFx0Jz8kezF9Jyxcblx0XHRcdFx0XHRcdFx0XHRcdCRxdWVyeWRpYWxvZy5maW5kKCdzZWxlY3QnKS52YWwoKSxcblx0XHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdCRxdWVyeWRpYWxvZy5vZmYoKTtcblx0XHRcdFx0XHRcdFx0JHF1ZXJ5ZGlhbG9nLmRpYWxvZygnZGVzdHJveScpLnJlbW92ZSgpO1xuXHRcdFx0XHRcdFx0XHRwcm9jZXNzUXVlcmllcygpO1xuXHRcdFx0XHRcdFx0XHRlLnN0b3BQcm9wYWdhdGlvbigpO1xuXHRcdFx0XHRcdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRcdFx0XHRcdGQyMC50ZXh0Y2hhdC4kdGV4dGFyZWEuZm9jdXMoKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRfLmRlZmVyKCgpID0+IHtcblx0XHRcdFx0XHRcdGlmIChtcy5sZW5ndGggPD0gMikge1xuXHRcdFx0XHRcdFx0XHRpZiAobXMubGVuZ3RoID09PSAyKSB7XG5cdFx0XHRcdFx0XHRcdFx0JHF1ZXJ5ZGlhbG9nXG5cdFx0XHRcdFx0XHRcdFx0XHQuZmluZCgnaW5wdXQnKVxuXHRcdFx0XHRcdFx0XHRcdFx0LnZhbChtc1sxXSlcblx0XHRcdFx0XHRcdFx0XHRcdC5zZWxlY3QoKTtcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHQkcXVlcnlkaWFsb2cuZmluZCgnaW5wdXQnKS5mb2N1cygpO1xuXHRcdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdFx0Ly8gQWx0ZXJuYXRlIHdheSBvZiBkb2luZyBpdDogSGlnaGxpaGd0IHRoZSBTdWJtaXQgYnV0dG9uIHNvIEVudGVyIHdpbGwgcHJlc3MgaXQuXG5cdFx0XHRcdFx0XHRcdC8vICRxdWVyeWRpYWxvZy5wYXJlbnQoKS5maW5kKFwiLnVpLWRpYWxvZy1idXR0b25wYW5lIGJ1dHRvbjpmaXJzdC1jaGlsZFwiKS5mb2N1cygpO1xuXHRcdFx0XHRcdFx0XHQvLyBDVXJlbnQgd2F5IG9mIGRvaW5nIGl0OiBGb2N1cyB0aGUgc2VsZWN0IGVsZW1lbnQuXG5cdFx0XHRcdFx0XHRcdCRxdWVyeWRpYWxvZy5maW5kKCdzZWxlY3QnKS5mb2N1cygpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdHJldHVybiAnPyR7MX0nO1xuXHRcdFx0XHR9KTtcblxuXHRcdFx0XHRpZiAoIWZvdW5kcXVlcnkpIHtcblx0XHRcdFx0XHRwcm9jZXNzTXVsdGlPcHMoKTtcblx0XHRcdFx0fVxuXHRcdFx0fTtcblxuXHRcdFx0dmFyIGNsZWFudXBSb2xsID0gZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRtYWtlU3Vic3RpdHV0aW9ucyA9IG51bGw7XG5cdFx0XHRcdHByb2Nlc3NJbmxpbmVSb2xscyA9IG51bGw7XG5cdFx0XHRcdHByb2Nlc3NNdWx0aU9wcyA9IG51bGw7XG5cdFx0XHRcdHByb2Nlc3NRdWVyaWVzID0gbnVsbDtcblx0XHRcdFx0Y29uc3QgaW5saW5lcm9sbHMgPSBudWxsO1xuXHRcdFx0XHRvcCA9IG51bGw7XG5cdFx0XHRcdHByZXZfcmVzb2x2ZWQgPSBudWxsO1xuXHRcdFx0XHRxdWVyeUNhY2hlID0gbnVsbDtcblx0XHRcdFx0dGFyZ2V0Q2FjaGUgPSBudWxsO1xuXHRcdFx0XHRpZiAoZDIwLmVuZ2luZS5tb2RlICE9PSBwcmV2TW9kZSkge1xuXHRcdFx0XHRcdHNldE1vZGUocHJldk1vZGUpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdHByZXZNb2RlID0gbnVsbDtcblx0XHRcdH07XG5cblx0XHRcdGlmIChub1BhcnNlQ29tbWFuZHMpIHtcblx0XHRcdFx0cHJvY2Vzc011bHRpT3BzKCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRtYWtlU3Vic3RpdHV0aW9ucygpO1xuXHRcdFx0fVxuXHRcdH1cblx0fTtcblxuXHRkMjAudGV4dGNoYXQuZG9DaGF0SW5wdXQgPSBoYW5kbGVEb0NoYXRJbnB1dDtcblxuXHQkKCcjdGV4dGNoYXQtaW5wdXQnKS5vbignY2xpY2snLCAnYnV0dG9uJywgKCkgPT4ge1xuXHRcdGNvbnN0IGlucHV0ID0gJC50cmltKGQyMC50ZXh0Y2hhdC4kdGV4dGFyZWEudmFsKCkpO1xuXG5cdFx0ZDIwLnRleHRjaGF0LmRvQ2hhdElucHV0KGlucHV0KTtcblxuXHRcdGQyMC50ZXh0Y2hhdC4kdGV4dGFyZWEudmFsKCcnKS5mb2N1cygpO1xuXHR9KTtcblxuXHRsZXQgbGFzdEJyb2FkY2FzdFR5cGluZyA9IGZhbHNlO1xuXG5cdGNvbnN0IGJyb2FkY2FzdFR5cGluZyA9IGZ1bmN0aW9uIChzaG93YXMpIHtcblx0XHRjb25zdCBjdGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuXG5cdFx0aWYgKGxhc3RCcm9hZGNhc3RUeXBpbmcgJiYgY3RpbWUgLSBsYXN0QnJvYWRjYXN0VHlwaW5nIDwgMzAwMCkge1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGlmIChkMjAudGV4dGNoYXQudGFsa3RvbXlzZWxmKSB7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0bGFzdEJyb2FkY2FzdFR5cGluZyA9IGN0aW1lO1xuXHRcdGQyMC50ZXh0Y2hhdC5zZW5kU2hvdXQoe1xuXHRcdFx0dHlwZTogJ2lzdHlwaW5nJyxcblx0XHRcdHBsYXllcmlkOiB3aW5kb3cuY3VycmVudFBsYXllci5pZCxcblx0XHRcdGNvbnRlbnQ6IHNob3dhcyxcblx0XHRcdHRpbWU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLFxuXHRcdH0pO1xuXHR9O1xuXG5cdGQyMC50ZXh0Y2hhdC4kdGV4dGFyZWEuYmluZCgna2V5dXAnLCBmdW5jdGlvbiAoKSB7XG5cdFx0bGV0IGN1cnZhbCA9ICQodGhpcykudmFsKCk7XG5cdFx0aWYgKGN1cnZhbC5sZW5ndGggPiAxICYmIGN1cnZhbC5zdWJzdHJpbmcoMCwgMSkgIT0gJyMnKSB7XG5cdFx0XHRsZXQgc2hvd2FzID0gZmFsc2U7XG5cdFx0XHRpZiAoXG5cdFx0XHRcdGN1cnZhbC5zdWJzdHJpbmcoMCwgNCkgPT09ICcvYXMgJyB8fCBjdXJ2YWwuc3Vic3RyaW5nKDAsIDYpID09PSAnL2VtYXMgJ1xuXHRcdFx0KSB7XG5cdFx0XHRcdGN1cnZhbCA9IGN1cnZhbC5yZXBsYWNlKCcvYXMgJywgJycpLnJlcGxhY2UoJy9lbWFzICcsICcnKTtcblxuXHRcdFx0XHRjb25zdCBudW1zcGFjZXMgPSBjdXJ2YWwubWF0Y2goLyAvZyk7XG5cdFx0XHRcdGlmIChudW1zcGFjZXMgPT0gbnVsbCB8fCBudW1zcGFjZXMubGVuZ3RoIDwgMikgcmV0dXJuO1xuXG5cdFx0XHRcdGNvbnN0IG51bXF1b3RlcyA9IGN1cnZhbC5tYXRjaCgvXCIvZyk7XG5cdFx0XHRcdGlmIChjdXJ2YWxbMF0gPT09ICdcIicgJiYgbnVtcXVvdGVzICE9PSBudWxsICYmIG51bXF1b3Rlcy5sZW5ndGggPCAyKSByZXR1cm47XG5cblx0XHRcdFx0Y29uc3QgbWF0Y2ggPSBjdXJ2YWwubWF0Y2goL1xcdyt8XCJbXlwiXStcIi8pO1xuXG5cdFx0XHRcdGlmIChtYXRjaCAhPSBudWxsICYmIG1hdGNoLmxlbmd0aCAmJiBtYXRjaC5sZW5ndGggPiAwKSB7XG5cdFx0XHRcdFx0c2hvd2FzID0gbWF0Y2hbMF1bMF0gPT09ICdcIicgPyBtYXRjaFswXS5zdWJzdHJpbmcoMSwgbWF0Y2hbMF0ubGVuZ3RoIC0gMSkgOiBtYXRjaFswXTtcblx0XHRcdFx0fVxuXHRcdFx0fSBlbHNlIGlmIChcblx0XHRcdFx0Y3VydmFsLnN1YnN0cmluZygwLCA1KSA9PT0gJy9vb2MgJyB8fCBjdXJ2YWwuc3Vic3RyaW5nKDAsIDMpID09PSAnL28gJyB8fCBjdXJ2YWwuc3Vic3RyaW5nKDAsIDYpID09PSAnL2Rlc2MgJyB8fCBjdXJ2YWwuc3Vic3RyaW5nKDAsIDQpID09PSAnL2VtICcgfHwgY3VydmFsLnN1YnN0cmluZygwLCA0KSA9PT0gJy9tZSAnIHx8IGN1cnZhbC5zdWJzdHJpbmcoMCwgMykgPT09ICcvZSAnXG5cdFx0XHQpIHtcblx0XHRcdFx0c2hvd2FzID0gZDIwLnRleHRjaGF0LiRzcGVha2luZ2FzLmZpbmQoJ29wdGlvbjpmaXJzdC1jaGlsZCcpLnRleHQoKTtcblx0XHRcdH0gZWxzZSBpZiAoY3VydmFsLnN1YnN0cmluZygwLCAxKSAhPT0gJy8nKSB7XG5cdFx0XHRcdHNob3dhcyA9IGQyMC50ZXh0Y2hhdC4kc3BlYWtpbmdhcy5maW5kKCdvcHRpb246c2VsZWN0ZWQnKS50ZXh0KCk7XG5cdFx0XHR9XG5cblx0XHRcdGlmIChzaG93YXMpIHtcblx0XHRcdFx0YnJvYWRjYXN0VHlwaW5nKHNob3dhcyk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9KTtcblxuXHRkMjAudGV4dGNoYXQuJHRleHRhcmVhLmJpbmQoJ2tleWRvd24nLCBmdW5jdGlvbiAoZSkge1xuXHRcdGlmIChlLndoaWNoID09PSAxMykge1xuXHRcdFx0aWYgKGF1dG9Db21wbGV0ZU9wZW4pIHtcblx0XHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdFx0fVxuXHRcdFx0aWYgKGUuc2hpZnRLZXkgPT09IHRydWUpIHtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXHRcdFx0JCh0aGlzKVxuXHRcdFx0XHQucGFyZW50KClcblx0XHRcdFx0LmZpbmQoJ2J1dHRvbicpXG5cdFx0XHRcdC50cmlnZ2VyKCdjbGljaycpO1xuXHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdH1cblx0fSk7XG5cblx0ZDIwLnRleHRjaGF0LiR0ZXh0YXJlYS5iaW5kKCdrZXl1cCcsICd1cCcsIGZ1bmN0aW9uICgpIHtcblx0XHRjb25zdCBjdXJyZW50Y29tbWFuZCA9IGQyMC50ZXh0Y2hhdC5jb21tYW5kaGlzdG9yeVtkMjAudGV4dGNoYXQuY29tbWFuZGhpc3RvcnkubGVuZ3RoICsgZDIwLnRleHRjaGF0LmNvbW1hbmRJbmRleFxuXHRcdF07XG5cdFx0aWYgKCQodGhpcykudmFsKCkgPT0gJycgfHwgJCh0aGlzKS52YWwoKSA9PSBjdXJyZW50Y29tbWFuZCkge1xuXHRcdFx0aWYgKFxuXHRcdFx0XHRNYXRoLmFicyhkMjAudGV4dGNoYXQuY29tbWFuZEluZGV4KSA8IGQyMC50ZXh0Y2hhdC5jb21tYW5kaGlzdG9yeS5sZW5ndGggKyAxXG5cdFx0XHQpIHtcblx0XHRcdFx0ZDIwLnRleHRjaGF0LmNvbW1hbmRJbmRleCA9IGQyMC50ZXh0Y2hhdC5jb21tYW5kSW5kZXggLSAxO1xuXHRcdFx0fVxuXHRcdFx0JCh0aGlzKS52YWwoXG5cdFx0XHRcdGQyMC50ZXh0Y2hhdC5jb21tYW5kaGlzdG9yeVtcblx0XHRcdFx0XHRkMjAudGV4dGNoYXQuY29tbWFuZGhpc3RvcnkubGVuZ3RoICsgZDIwLnRleHRjaGF0LmNvbW1hbmRJbmRleFxuXHRcdFx0XHRdLFxuXHRcdFx0KTtcblx0XHR9XG5cdH0pO1xuXG5cdGQyMC50ZXh0Y2hhdC4kdGV4dGFyZWEuYmluZCgna2V5dXAnLCAnZG93bicsIGZ1bmN0aW9uICgpIHtcblx0XHRjb25zdCBjdXJyZW50Y29tbWFuZCA9IGQyMC50ZXh0Y2hhdC5jb21tYW5kaGlzdG9yeVtkMjAudGV4dGNoYXQuY29tbWFuZGhpc3RvcnkubGVuZ3RoICsgZDIwLnRleHRjaGF0LmNvbW1hbmRJbmRleFxuXHRcdF07XG5cdFx0aWYgKCQodGhpcykudmFsKCkgPT0gJycgfHwgJCh0aGlzKS52YWwoKSA9PSBjdXJyZW50Y29tbWFuZCkge1xuXHRcdFx0aWYgKGQyMC50ZXh0Y2hhdC5jb21tYW5kSW5kZXggPCAwKSB7XG5cdFx0XHRcdGQyMC50ZXh0Y2hhdC5jb21tYW5kSW5kZXggPSBkMjAudGV4dGNoYXQuY29tbWFuZEluZGV4ICsgMTtcblx0XHRcdH1cblx0XHRcdCQodGhpcykudmFsKFxuXHRcdFx0XHRkMjAudGV4dGNoYXQuY29tbWFuZGhpc3RvcnlbXG5cdFx0XHRcdFx0ZDIwLnRleHRjaGF0LmNvbW1hbmRoaXN0b3J5Lmxlbmd0aCArIGQyMC50ZXh0Y2hhdC5jb21tYW5kSW5kZXhcblx0XHRcdFx0XSxcblx0XHRcdCk7XG5cdFx0fVxuXHR9KTtcblxuXHQvLyBEZWZpbmVzIGZvciB0aGUgZXhhbXBsZSB0aGUgbWF0Y2ggdG8gdGFrZSB3aGljaCBpcyBhbnkgd29yZCAod2l0aCBVbWxhdXRzISEpLlxuXHRjb25zdCBfbGVmdE1hdGNoID0gZnVuY3Rpb24gKHN0cmluZywgYXJlYSkge1xuXHRcdHJldHVybiBzdHJpbmcuc3Vic3RyaW5nKDAsIGFyZWEuc2VsZWN0aW9uU3RhcnQpLm1hdGNoKC9bXFx3w6TDtsO8w4TDlsOcw58jJXtdKyQvKTtcblx0fTtcblxuXHRjb25zdCBfc2V0Q3Vyc29yUG9zaXRpb24gPSBmdW5jdGlvbiAoYXJlYSwgcG9zKSB7XG5cdFx0aWYgKGFyZWEuc2V0U2VsZWN0aW9uUmFuZ2UpIHtcblx0XHRcdGFyZWEuc2V0U2VsZWN0aW9uUmFuZ2UocG9zLCBwb3MpO1xuXHRcdH0gZWxzZSBpZiAoYXJlYS5jcmVhdGVUZXh0UmFuZ2UpIHtcblx0XHRcdGNvbnN0IHJhbmdlID0gYXJlYS5jcmVhdGVUZXh0UmFuZ2UoKTtcblx0XHRcdHJhbmdlLmNvbGxhcHNlKHRydWUpO1xuXHRcdFx0cmFuZ2UubW92ZUVuZCgnY2hhcmFjdGVyJywgcG9zKTtcblx0XHRcdHJhbmdlLm1vdmVTdGFydCgnY2hhcmFjdGVyJywgcG9zKTtcblx0XHRcdHJhbmdlLnNlbGVjdCgpO1xuXHRcdH1cblx0fTtcblxuXHRkMjAudGV4dGNoYXQuJHRleHRhcmVhLmF1dG9jb21wbGV0ZSh7XG5cdFx0ZGVsYXk6IDEwMCxcblx0XHRhdXRvRm9jdXM6IHRydWUsXG5cdFx0cG9zaXRpb246IHtcblx0XHRcdG15OiAnbGVmdCB0b3AnLFxuXHRcdFx0YXQ6ICdsZWZ0IGJvdHRvbScsXG5cdFx0fSxcblx0XHRzb3VyY2UocmVxdWVzdCwgcmVzcG9uc2UpIHtcblx0XHRcdGxldCBzdHIgPSBfbGVmdE1hdGNoKHJlcXVlc3QudGVybSwgZDIwLnRleHRjaGF0LiR0ZXh0YXJlYVswXSk7XG5cdFx0XHRzdHIgPSBzdHIgIT0gbnVsbCA/IHN0clswXSA6ICcnO1xuXG5cdFx0XHRpZiAoc3RyWzBdID09PSAnJScgJiYgc3RyWzFdICE9PSAneycpIHtcblx0XHRcdFx0c3RyID0gYCV7JHtzdHIuc3Vic3RyaW5nKDEsIHN0ci5sZW5ndGgpfWA7XG5cdFx0XHR9XG5cblx0XHRcdGlmIChzdHIuc3Vic3RyaW5nKDAsIDEpID09ICcjJykge1xuXHRcdFx0XHR2YXIgc2hvcnRjdXRzID0gW107XG5cdFx0XHRcdGQyMC5DYW1wYWlnbi5wbGF5ZXJzLmVhY2goKHBsYXllcikgPT4ge1xuXHRcdFx0XHRcdHBsYXllci5tYWNyb3MuZWFjaCgoc2hvcnRjdXQpID0+IHtcblx0XHRcdFx0XHRcdGlmIChzaG9ydGN1dC5nZXQoJ25hbWUnKSA9PSAnJykge1xuXHRcdFx0XHRcdFx0XHRyZXR1cm4gdHJ1ZTsgLy8gbmV4dFxuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0aWYgKFxuXHRcdFx0XHRcdFx0XHRwbGF5ZXIuaWQgPT0gd2luZG93LmN1cnJlbnRQbGF5ZXIuaWQgfHwgc2hvcnRjdXQudmlzaWJsZVRvQ3VycmVudFBsYXllcigpXG5cdFx0XHRcdFx0XHQpIHtcblx0XHRcdFx0XHRcdFx0c2hvcnRjdXRzLnB1c2goYCMke3Nob3J0Y3V0LmdldCgnbmFtZScpfWApO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9KTtcblx0XHRcdFx0dmFyIHJlc3VsdHMgPSAkLnVpLmF1dG9jb21wbGV0ZS5maWx0ZXIoc2hvcnRjdXRzLCBzdHIpO1xuXHRcdFx0XHRyZXNwb25zZShyZXN1bHRzKTtcblx0XHRcdH0gZWxzZSBpZiAoXG5cdFx0XHRcdHJlcXVlc3QudGVybS5zdWJzdHJpbmcoMCwgMykgPT0gJy93ICcgJiYgcmVxdWVzdC50ZXJtLnNwbGl0KCcgJykubGVuZ3RoIDwgM1xuXHRcdFx0KSB7XG5cdFx0XHRcdHZhciByZXN1bHRzID0gJC51aS5hdXRvY29tcGxldGUuZmlsdGVyKFxuXHRcdFx0XHRcdF8udW5pb24oXG5cdFx0XHRcdFx0XHRbJ2dtJ10sXG5cdFx0XHRcdFx0XHRkMjAuQ2FtcGFpZ24ucGxheWVycy5tYXAoKHApID0+IHAuZ2V0KCdkaXNwbGF5bmFtZScpLnNwbGl0KCcgJylbMF0pLFxuXHRcdFx0XHRcdFx0ZDIwLkNhbXBhaWduLmNoYXJhY3RlcnMubWFwKChwKSA9PiB7XG5cdFx0XHRcdFx0XHRcdGNvbnN0IGluam91cm5hbHMgPSBwLmdldCgnaW5wbGF5ZXJqb3VybmFscycpLnNwbGl0KCcsJyk7XG5cdFx0XHRcdFx0XHRcdGlmIChcblx0XHRcdFx0XHRcdFx0XHR3aW5kb3cuaXNfZ20gfHwgXy5pbmRleE9mKGluam91cm5hbHMsICdhbGwnKSAhPT0gLTEgfHwgKHdpbmRvdy5jdXJyZW50UGxheWVyICYmIF8uaW5kZXhPZihpbmpvdXJuYWxzLCB3aW5kb3cuY3VycmVudFBsYXllci5pZCkgIT09IC0xKVxuXHRcdFx0XHRcdFx0XHQpIHtcblx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gcC5nZXQoJ25hbWUnKS5zcGxpdCgnICcpWzBdO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcdFx0XHRcdH0pLFxuXHRcdFx0XHRcdCksXG5cdFx0XHRcdFx0c3RyLFxuXHRcdFx0XHQpO1xuXHRcdFx0XHRyZXNwb25zZShyZXN1bHRzKTtcblx0XHRcdH0gZWxzZSBpZiAoc3RyLnN1YnN0cmluZygwLCAyKSA9PT0gJyV7Jykge1xuXHRcdFx0XHR2YXIgc2hvcnRjdXRzID0gW107XG5cdFx0XHRcdGQyMC5DYW1wYWlnbi5jaGFyYWN0ZXJzLmVhY2goKGNoYXJhY3RlcikgPT4ge1xuXHRcdFx0XHRcdGlmICghY2hhcmFjdGVyLmN1cnJlbnRQbGF5ZXJDb250cm9scygpKSByZXR1cm47XG5cdFx0XHRcdFx0Y2hhcmFjdGVyLmFiaWxpdGllcy5lYWNoKChhYmlsKSA9PiB7XG5cdFx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHRcdGFiaWxcblx0XHRcdFx0XHRcdFx0XHQuZ2V0KCduYW1lJylcblx0XHRcdFx0XHRcdFx0XHQudG9Mb3dlckNhc2UoKVxuXHRcdFx0XHRcdFx0XHRcdC5pbmRleE9mKHN0ci5zdWJzdHJpbmcoMiwgc3RyLmxlbmdodCkudG9Mb3dlckNhc2UoKSkgIT09IC0xXG5cdFx0XHRcdFx0XHQpIHtcblx0XHRcdFx0XHRcdFx0c2hvcnRjdXRzLnB1c2goYCV7JHtjaGFyYWN0ZXIuZ2V0KCduYW1lJyl9fCR7YWJpbC5nZXQoJ25hbWUnKX19YCk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH0pO1xuXG5cdFx0XHRcdHJlc3BvbnNlKHNob3J0Y3V0cyk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRyZXNwb25zZShbXSk7XG5cdFx0XHR9XG5cdFx0fSxcblx0XHQvLyBtaW5MZW5ndGg6IDIsIC8vIGRvZXMgaGF2ZSBubyBlZmZlY3QsIHJlZ2V4cHJlc3Npb24gaXMgdXNlZCBpbnN0ZWFkXG5cdFx0Zm9jdXMoKSB7XG5cdFx0XHQvLyBwcmV2ZW50IHZhbHVlIGluc2VydGVkIG9uIGZvY3VzXG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0fSxcblx0XHQvLyBJbnNlcnQgdGhlIG1hdGNoIGluc2lkZSB0aGUgdWkgZWxlbWVudCBhdCB0aGUgY3VycmVudCBwb3NpdGlvbiBieSByZXBsYWNpbmcgdGhlIG1hdGNoaW5nIHN1YnN0cmluZ1xuXHRcdHNlbGVjdChldmVudCwgdWkpIHtcblx0XHRcdHVpLml0ZW0udmFsdWUgKz0gJyAnO1xuXHRcdFx0Y29uc3QgbSA9IF9sZWZ0TWF0Y2godGhpcy52YWx1ZSwgdGhpcylbMF07XG5cdFx0XHRjb25zdCBiZWcgPSB0aGlzLnZhbHVlLnN1YnN0cmluZygwLCB0aGlzLnNlbGVjdGlvblN0YXJ0IC0gbS5sZW5ndGgpO1xuXHRcdFx0dGhpcy52YWx1ZSA9IGJlZyArIHVpLml0ZW0udmFsdWUgKyB0aGlzLnZhbHVlLnN1YnN0cmluZyh0aGlzLnNlbGVjdGlvblN0YXJ0LCB0aGlzLnZhbHVlLmxlbmd0aCk7XG5cdFx0XHRjb25zdCBwb3MgPSBiZWcubGVuZ3RoICsgdWkuaXRlbS52YWx1ZS5sZW5ndGg7XG5cdFx0XHRfc2V0Q3Vyc29yUG9zaXRpb24odGhpcywgcG9zKTtcblx0XHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0fSxcblx0XHRzZWFyY2goZXZlbnQsIHVpKSB7XG5cdFx0XHRjb25zdCBtID0gX2xlZnRNYXRjaCh0aGlzLnZhbHVlLCB0aGlzKTtcblx0XHRcdHJldHVybiBtICE9IG51bGw7XG5cdFx0fSxcblxuXHRcdG9wZW4oKSB7XG5cdFx0XHRhdXRvQ29tcGxldGVPcGVuID0gdHJ1ZTtcblx0XHR9LFxuXG5cdFx0Y2xvc2UoKSB7XG5cdFx0XHRzZXRUaW1lb3V0KCgpID0+IHtcblx0XHRcdFx0YXV0b0NvbXBsZXRlT3BlbiA9IGZhbHNlO1xuXHRcdFx0fSwgMjUwKTtcblx0XHR9LFxuXHR9KTtcblxuXHRjb25zdCAkY29udGVudCA9ICQoJyN0ZXh0Y2hhdCAuY29udGVudCcpO1xuXG5cdGQyMC50ZXh0Y2hhdC5pbmNvbWluZyA9IGZ1bmN0aW9uIChwb3MsIG9wLCBub3JlbW92ZSwgY2hlY2tGb3JFeGlzdGluZykge1xuXHRcdGxldCB0ZW1wbGF0ZV9uYW1lID0gb3AudHlwZTtcblxuXHRcdGlmIChvcC50eXBlID09PSAnYXBpJykge1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdC8vIFByZXZlbnQgdGVtcGxhdGVzIHdoaWNoIGV4cGVjdCB0aWVtc3RhbXBzIGZyb20gYnJlYWtpbmcuXG5cdFx0aWYgKG9wLnRpbWVzdGFtcCA9PT0gbnVsbCkge1xuXHRcdFx0b3AudGltZXN0YW1wID0gJyc7XG5cdFx0fSBlbHNlIHtcblx0XHRcdG9wLnJlYWx0aW1lc3RhbXAgPSBvcC50aW1lc3RhbXA7XG5cdFx0XHRjb25zdCB0aW1lID0gb3AudGltZXN0YW1wO1xuXHRcdFx0Y29uc3QgZCA9IERhdGUuY3JlYXRlKHRpbWUpO1xuXHRcdFx0Y29uc3Qgbm93ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG5cdFx0XHRpZiAobm93IC0gdGltZSA8IDYwICogNjAgKiAyNCAqIDEwMDApIHtcblx0XHRcdFx0b3AudGltZXN0YW1wID0gZC5mb3JtYXQoJ3tofTp7bW19e1RUfScpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0b3AudGltZXN0YW1wID0gZC5mb3JtYXQoJ3t7TW9udGh9fSB7e2RkfX0sIHt7eXl5eX19IHtofTp7bW19e1RUfScpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGlmIChkMjAuQ2FtcGFpZ24gJiYgb3AucGxheWVyaWQgIT0gd2luZG93LmN1cnJlbnRQbGF5ZXIuaWQpIHtcblx0XHRcdGRlbGV0ZSB3aG9pc3R5cGluZ1tvcC5wbGF5ZXJpZF07XG5cdFx0XHRkMjAudGV4dGNoYXQudXBkYXRlV2hvSXNUeXBpbmcoKTtcblx0XHR9XG5cblx0XHRpZiAob3AudHlwZSA9PSAnZ21yb2xscmVzdWx0Jykge1xuXHRcdFx0aWYgKCF3aW5kb3cuaXNfZ20gJiYgb3AucGxheWVyaWQgIT0gd2luZG93LmN1cnJlbnRQbGF5ZXIuaWQpIHtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXHRcdFx0dGVtcGxhdGVfbmFtZSA9ICdyb2xscmVzdWx0Jztcblx0XHR9XG5cblx0XHRpZiAob3AudHlwZSA9PSAnd2hpc3BlcicpIHtcblx0XHRcdGlmIChvcC5wbGF5ZXJpZCA9PSB3aW5kb3cuY3VycmVudFBsYXllci5pZCkge1xuXHRcdFx0XHR0ZW1wbGF0ZV9uYW1lID0gJ3doaXNwZXJzZW50Jztcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHRlbXBsYXRlX25hbWUgPSAnd2hpc3BlcnJlY2VpdmVkJztcblx0XHRcdFx0aWYgKG9wLnRhcmdldCA9PSAnZ20nKSB7XG5cdFx0XHRcdFx0aWYgKCF3aW5kb3cuaXNfZ20pIHtcblx0XHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0gZWxzZSBpZiAob3AudGFyZ2V0LmluZGV4T2Yod2luZG93LmN1cnJlbnRQbGF5ZXIuaWQpID09PSAtMSkge1xuXHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGxhc3RXaGlzcGVyUmVjZWl2ZWQgPSBvcDtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRpZiAoZDIwLkNhbXBhaWduKSB7XG5cdFx0XHRjb25zdCBkb2NoZWlnaHQgPSAkY29udGVudC5oZWlnaHQoKTtcblx0XHRcdGNvbnN0IHdpbmRvd2hlaWdodCA9ICQod2luZG93KS5oZWlnaHQoKTtcblx0XHRcdGNvbnN0IHNjcm9sbHRvcCA9IGQyMC50ZXh0Y2hhdC4kdGV4dGNoYXQuc2Nyb2xsVG9wKCk7XG5cdFx0XHR2YXIgYXRib3R0b20gPSBmYWxzZTtcblxuXHRcdFx0aWYgKGRvY2hlaWdodCAtIHNjcm9sbHRvcCAtIDIwMCA8IHdpbmRvd2hlaWdodCkge1xuXHRcdFx0XHRhdGJvdHRvbSA9IHRydWU7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0aWYgKG9wLmlubGluZXJvbGxzICE9PSB1bmRlZmluZWQgJiYgb3AuaW5saW5lcm9sbHMubGVuZ3RoID4gMCkge1xuXHRcdFx0Xy5lYWNoKG9wLmlubGluZXJvbGxzLCAoYW5pbmxpbmVyb2xsKSA9PiB7XG5cdFx0XHRcdGlmIChcblx0XHRcdFx0XHRhbmlubGluZXJvbGwucmVzdWx0cyAhPT0gdW5kZWZpbmVkICYmIGFuaW5saW5lcm9sbC5yZXN1bHRzLnRvdGFsICE9PSB1bmRlZmluZWQgJiYgYW5pbmxpbmVyb2xsLnJlc3VsdHMudG90YWwgJSAxICE9IDBcblx0XHRcdFx0KSB7XG5cdFx0XHRcdFx0YW5pbmxpbmVyb2xsLnJlc3VsdHMudG90YWwgPSBwYXJzZUZsb2F0KFxuXHRcdFx0XHRcdFx0YW5pbmxpbmVyb2xsLnJlc3VsdHMudG90YWwudG9QcmVjaXNpb24oMTIpLFxuXHRcdFx0XHRcdCk7IC8vIFJPVU5ESU5HIEVSUk9SIEJVR0ZJWFxuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblx0XHR9XG5cblx0XHRpZiAodGVtcGxhdGVfbmFtZSA9PSAncm9sbHJlc3VsdCcgJiYgb3Aub3JpZ1JvbGwpIHtcblx0XHRcdHRlbXBsYXRlX25hbWUgPSAnbmV3cm9sbCc7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRjb25zdCBqc29ub2JqID0gSlNPTi5wYXJzZShvcC5jb250ZW50KTtcblx0XHRcdFx0aWYgKG9wLnNpZ25hdHVyZSkge1xuXHRcdFx0XHRcdGlmIChkMjAudGV4dGNoYXQudmVyaWZ5Um9sbChvcC5pZCwganNvbm9iaiwgb3Auc2lnbmF0dXJlKSkge1xuXHRcdFx0XHRcdFx0Ly8gT25seSBhZGQgdGhlIHJvbGwgaWYgaXQgaGFwcGVuZWQgaW4gdGhlIGxhc3QgMTAgc2VjLiBUaGlzIGtlZXBzIGl0IGZyb20gYWRkaW5nIGFsbCBvZiB0aGUgZ2FtZXMgYXJjaGl2ZWQgcm9sbHMgdG8gdGhlIGxpc3Qgd2hlbiB0aGUgZ2FtZSBsb2Fkcy5cblx0XHRcdFx0XHRcdGlmIChvcC5yZWFsdGltZXN0YW1wICYmIG5ldyBEYXRlKCkgLSBvcC5yZWFsdGltZXN0YW1wIDwgMTAwMDApIHtcblx0XHRcdFx0XHRcdFx0ZDIwLmRpY2VfZW5naW5lLm5ld1JvbGwob3AuaWQpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0b3AucGFzc2VkU2lnbmF0dXJlID0gdHJ1ZTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0b3AuZmFpbGVkU2lnbmF0dXJlID0gdHJ1ZTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdFx0aWYgKGpzb25vYmoudG90YWwgJiYganNvbm9iai50b3RhbCAlIDEgIT0gMCkge1xuXHRcdFx0XHRcdGpzb25vYmoudG90YWwgPSBwYXJzZUZsb2F0KGpzb25vYmoudG90YWwudG9QcmVjaXNpb24oMTIpKTsgLy8gUk9VTkRJTkcgRVJST1IgQlVHRklYXG5cdFx0XHRcdH1cblx0XHRcdFx0b3AuaHRtbGNvbnRlbnQgPSBkMjAuZGljZV9mb3JtYXR0ZXIuZ2V0SHRtbEZvclJlc3VsdChqc29ub2JqKTtcblx0XHRcdFx0b3Auc2FuaXRpemVkT3JpZ1JvbGwgPSBkMjAuZGljZV9mb3JtYXR0ZXIucmVwbGFjZUlubGluZVJvbGxzKFxuXHRcdFx0XHRcdG9wLm9yaWdSb2xsLnJlcGxhY2UoJzwnLCAnJmx0OycpLFxuXHRcdFx0XHRcdG9wLFxuXHRcdFx0XHRcdCcnLFxuXHRcdFx0XHQpO1xuXHRcdFx0fSBjYXRjaCAoZSkge1xuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cdFx0fSBlbHNlIGlmIChcblx0XHRcdHRlbXBsYXRlX25hbWUgPT0gJ3JvbGxyZXN1bHQnICYmIHR5cGVvZiBvcC5jb250ZW50ID09PSAnb2JqZWN0J1xuXHRcdCkge1xuXHRcdFx0Ly8gVGhlcmUgd2FzIGFib3V0IGEgMy13ZWVrIHBlcmlvZCBvbiBkZXYgd2hlcmUgdGhpcyB3YXMgYWN0aXZlLiB3aG9vcHMuXG5cdFx0XHRvcC5jb250ZW50ID0gYCR7b3AuY29udGVudC5vcmlnZm9ybXVsYX18JHtvcC5jb250ZW50LmZvcm11bGF9fCR7b3AuY29udGVudC50b3RhbH1gO1xuXHRcdH1cblxuXHRcdGNvbnN0IHRlbXBsYXRlID0gJChgI3RtcGxfY2hhdG1lc3NhZ2VfJHt0ZW1wbGF0ZV9uYW1lfWApO1xuXG5cdFx0aWYgKGNoZWNrRm9yRXhpc3RpbmcpIHtcblx0XHRcdHZhciAkZXhpc3RpbmdNc2cgPSAkY29udGVudC5maW5kKGAubWVzc2FnZVtkYXRhLW1lc3NhZ2VpZD0ke29wLmlkfV1gKTtcblx0XHRcdGlmICgkZXhpc3RpbmdNc2cuZmluZCgnLmF2YXRhcicpLmxlbmd0aCA+IDApIHtcblx0XHRcdFx0b3Auc2hvd25hbWUgPSB0cnVlO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0b3Auc2hvd25hbWUgPSBmYWxzZTtcblx0XHRcdH1cblx0XHR9IGVsc2UgaWYgKG9wLndobyAhPT0gbGFzdE5hbWUgfHwgbGluZXNTaW5jZU5hbWUgPiA1KSB7XG5cdFx0XHRvcC5zaG93bmFtZSA9IHRydWU7XG5cdFx0XHRsaW5lc1NpbmNlTmFtZSA9IDA7XG5cdFx0fVxuXG5cdFx0aWYgKFxuXHRcdFx0IW9wLnJvbGx0ZW1wbGF0ZSAmJiB0ZW1wbGF0ZV9uYW1lICE9ICdyb2xscmVzdWx0JyAmJiB0ZW1wbGF0ZV9uYW1lICE9ICduZXdyb2xsJyAmJiB0ZW1wbGF0ZV9uYW1lICE9ICd0b2tlbnJvbGwnICYmIHRlbXBsYXRlX25hbWUgIT0gJ2RpcmVjdCdcblx0XHQpIHtcblx0XHRcdG9wLmNvbnRlbnQgPSBNYXJrZG93bi5wYXJzZShgJHtvcC5jb250ZW50fWApLmF1dG9MaW5rKCk7XG5cdFx0fVxuXG5cdFx0aWYgKG9wLnJvbGx0ZW1wbGF0ZSkge1xuXHRcdFx0bGV0IHRlbXBsYXRldmlldyA9IHt9O1xuXG5cdFx0XHR0ZW1wbGF0ZXZpZXcgPSBkMjAudGV4dGNoYXQuYnVpbGRSb2xsVGVtcGxhdGVWaWV3T2JqKHRlbXBsYXRldmlldywgb3ApO1xuXHRcdFx0dGVtcGxhdGV2aWV3ID0gZDIwLnRleHRjaGF0LmhhbmRsZVRlbXBsYXRlVmlld1RyYW5zbGF0aW9ucyh0ZW1wbGF0ZXZpZXcpO1xuXHRcdFx0dGVtcGxhdGV2aWV3ID0gZDIwLnRleHRjaGF0LmJ1aWxkUm9sbFRlbXBsYXRlVmlld0Z1bmN0aW9ucyhcblx0XHRcdFx0dGVtcGxhdGV2aWV3LFxuXHRcdFx0XHRvcCxcblx0XHRcdCk7XG5cblx0XHRcdG9wLmNvbnRlbnQgPSBNdXN0YWNoZS5yZW5kZXIoXG5cdFx0XHRcdGQyMC50ZXh0Y2hhdC5idWlsZFJvbGxUZW1wbGF0ZUh0bWwob3ApLFxuXHRcdFx0XHR0ZW1wbGF0ZXZpZXcsXG5cdFx0XHQpO1xuXHRcdFx0b3AuY29udGVudCA9IE1hcmtkb3duLnBhcnNlKG9wLmNvbnRlbnQpO1xuXHRcdFx0b3AuY29udGVudCA9IGQyMC51dGlscy5odG1sVHJhbnNsYXRvcihvcC5jb250ZW50LCB0cnVlKTtcblx0XHR9XG5cblx0XHRsZXQgdHJhbnNsYXRlZCA9IHRlbXBsYXRlLmpxb3RlKG9wKTtcblxuXHRcdC8vIFJlcGxhY2UgaW1nIGVsZW1lbnQgd2l0aCB2aWRlbyBpZiBuZWVkZWRcblx0XHRpZiAodGVtcGxhdGVfbmFtZSA9PT0gJ3Rva2Vucm9sbCcpIHtcblx0XHRcdGNvbnN0IHJlZ2V4ID0gLzxpbWdcXHMuKnNyYz1cXFwiKC4qW1xcd1xcLV0rXFwud2VibSg/OlxcP1xcZCopPylcXFwiW14+XSo+L2k7XG5cdFx0XHR0cmFuc2xhdGVkID0gdHJhbnNsYXRlZC5yZXBsYWNlKFxuXHRcdFx0XHRyZWdleCxcblx0XHRcdFx0KG1hdGNoLCBzcmMpID0+IGA8dmlkZW8gc3JjPVwiJHtzcmMucmVwbGFjZShcblx0XHRcdFx0XHQnL21lZC53ZWJtJyxcblx0XHRcdFx0XHQnL3RodW1iLndlYm0nLFxuXHRcdFx0XHQpfVwiIGRyYWdnYWJsZT1cImZhbHNlXCIgbXV0ZWQgYXV0b3BsYXkgbG9vcCAvPmAsXG5cdFx0XHQpO1xuXHRcdH1cblxuXHRcdGxldCBtZXNzYWdlU2VsZWN0b3IgPSAnOmxhc3QtY2hpbGQnO1xuXG5cdFx0aWYgKGNoZWNrRm9yRXhpc3RpbmcpIHtcblx0XHRcdCRleGlzdGluZ01zZy5yZXBsYWNlV2l0aCh0cmFuc2xhdGVkKTtcblx0XHRcdG1lc3NhZ2VTZWxlY3RvciA9IGBbZGF0YS1tZXNzYWdlaWQ9JHtvcC5pZH1dYDtcblx0XHR9IGVsc2Uge1xuXHRcdFx0JGNvbnRlbnQuYXBwZW5kKHRyYW5zbGF0ZWQpO1xuXHRcdH1cblxuXHRcdGlmIChcblx0XHRcdChvcC50eXBlID09ICdyb2xscmVzdWx0JyB8fCBvcC50eXBlID09ICdnbXJvbGxyZXN1bHQnKSAmJiBkMjAuQ2FtcGFpZ24gJiYgd2luZG93LmN1cnJlbnRQbGF5ZXIgJiYgd2luZG93LmN1cnJlbnRQbGF5ZXIuZ2V0KCdkaWNlaWNvbnNlbmFibGVkJylcblx0XHQpIHtcblx0XHRcdCRjb250ZW50XG5cdFx0XHRcdC5maW5kKGAubWVzc2FnZSR7bWVzc2FnZVNlbGVjdG9yfSAucm9sbGVkYClcblx0XHRcdFx0LmRyYWdnYWJsZSh7XG5cdFx0XHRcdFx0cmV2ZXJ0OiB0cnVlLFxuXHRcdFx0XHRcdGRpc3RhbmNlOiAxMCxcblx0XHRcdFx0XHRyZXZlcnREdXJhdGlvbjogMCxcblx0XHRcdFx0XHRoZWxwZXI6ICdjbG9uZScsXG5cdFx0XHRcdFx0YXBwZW5kVG86ICdib2R5Jyxcblx0XHRcdFx0XHRzY3JvbGw6IGZhbHNlLFxuXHRcdFx0XHR9KVxuXHRcdFx0XHQuYWRkVG91Y2goKTtcblx0XHRcdGxldCAkc29ydHMgPSAkY29udGVudC5maW5kKFxuXHRcdFx0XHRgLm1lc3NhZ2Uke21lc3NhZ2VTZWxlY3Rvcn0gLmZvcm1hdHRlZGZvcm11bGEgPiAuZGljZWdyb3VwaW5nYCxcblx0XHRcdCk7XG5cdFx0XHRpZiAoJHNvcnRzLmZpbmQoJy5kaWNlcm9sbCcpLmxlbmd0aCA8IDIwKSB7XG5cdFx0XHRcdCRzb3J0c1xuXHRcdFx0XHRcdC5zb3J0YWJsZSh7XG5cdFx0XHRcdFx0XHRhcHBlbmRUbzogZG9jdW1lbnQuYm9keSxcblx0XHRcdFx0XHRcdGhlbHBlcjogJ2Nsb25lJyxcblx0XHRcdFx0XHRcdGRpc3RhbmNlOiAxMCxcblx0XHRcdFx0XHRcdGl0ZW1zOiAnPiAuZGljZXJvbGwnLFxuXHRcdFx0XHRcdFx0dXBkYXRlKGUpIHtcblx0XHRcdFx0XHRcdFx0ZDIwLnRleHRjaGF0LnVwZGF0ZURpY2VPcmRlcmluZyhvcCwgZSk7XG5cdFx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0LmFkZFRvdWNoKCk7XG5cdFx0XHR9XG5cdFx0XHQkc29ydHMgPSBudWxsO1xuXHRcdH1cblxuXHRcdGlmIChcblx0XHRcdGQyMC5DYW1wYWlnbiAmJiB3aW5kb3cuY3VycmVudFBsYXllciAmJiB0ZW1wbGF0ZV9uYW1lID09ICduZXdyb2xsJyAmJiBvcC5wbGF5ZXJpZCA9PSB3aW5kb3cuY3VycmVudFBsYXllci5pZFxuXHRcdCkge1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0Y29uc3QgbGFzdHJvbGwgPSAkKCcjbXlsYXN0cm9sbHMgdGJvZHkgdHInKS5lcSgwKTtcblx0XHRcdFx0aWYgKFxuXHRcdFx0XHRcdGxhc3Ryb2xsLmxlbmd0aCA9PSAwIHx8ICQudHJpbShsYXN0cm9sbC5maW5kKCd0ZC5mb3JtdWxhJykudGV4dCgpKSAhPSBvcC5vcmlnUm9sbFxuXHRcdFx0XHQpIHtcblx0XHRcdFx0XHQkKCcjbXlsYXN0cm9sbHMgdGJvZHknKS5wcmVwZW5kKCQoJyN0bXBsX3JlY2VudHJvbGwnKS5qcW90ZShvcCkpO1xuXHRcdFx0XHRcdCQoJyNteWxhc3Ryb2xscyB0Ym9keSB0cicpXG5cdFx0XHRcdFx0XHQuZXEoMTApXG5cdFx0XHRcdFx0XHQucmVtb3ZlKCk7XG5cdFx0XHRcdH1cblx0XHRcdH0gY2F0Y2ggKGUpIHt9XG5cdFx0fVxuXG5cdFx0aWYgKCFub3JlbW92ZSAmJiAkY29udGVudC5maW5kKCcubWVzc2FnZScpLmxlbmd0aCA+IDEwMCkge1xuXHRcdFx0JGNvbnRlbnRcblx0XHRcdFx0LmZpbmQoJy5tZXNzYWdlJylcblx0XHRcdFx0LmVxKDApXG5cdFx0XHRcdC5yZW1vdmUoKTtcblx0XHR9XG5cblx0XHRpZiAoIWNoZWNrRm9yRXhpc3RpbmcpIHtcblx0XHRcdGlmIChcblx0XHRcdFx0b3AudHlwZSA9PSAnZW1vdGUnIHx8IG9wLnR5cGUgPT0gJ2dtcm9sbHJlc3VsdCcgfHwgb3AudHlwZSA9PSAnd2hpc3Blcidcblx0XHRcdCkge1xuXHRcdFx0XHRsYXN0TmFtZSA9ICcnO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0bGFzdE5hbWUgPSBvcC53aG87XG5cdFx0XHR9XG5cdFx0XHRsaW5lc1NpbmNlTmFtZSsrO1xuXHRcdH1cblxuXHRcdGlmIChkMjAuQ2FtcGFpZ24gJiYgKGF0Ym90dG9tIHx8IHBvcyA9PT0gZmFsc2UpKSB7XG5cdFx0XHRjb25zdCBuZXdoZWlnaHQgPSAkY29udGVudC5oZWlnaHQoKTtcblx0XHRcdGQyMC50ZXh0Y2hhdC4kdGV4dGNoYXQuc2Nyb2xsVG9wKG5ld2hlaWdodCk7XG5cdFx0fVxuXG5cdFx0aWYgKFxuXHRcdFx0ZDIwLkNhbXBhaWduICYmIHdpbmRvdy5jdXJyZW50UGxheWVyLmdldCgnY2hhdGJlZXBlbmFibGVkJykgJiYgKCghd2luZG93SXNGb2N1c2VkICYmICFwb3BvdXRXaW5kb3dJc0ZvY3VzZWQpIHx8ICghZDIwLnRleHRjaGF0LnRhYklzRm9jdXNlZCAmJiAhZDIwLnRleHRjaGF0LmNoaWxkV2luZG93KSkgJiYgcG9zICE9IGZhbHNlICYmICFkMjAudGV4dGNoYXQuY2hhdHN0YXJ0aW5ndXBcblx0XHQpIHtcblx0XHRcdGlmIChuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIGQyMC50ZXh0Y2hhdC5sYXN0Q2hhdEJlZXAgPiAxMDAwKSB7XG5cdFx0XHRcdGNvbnN0IHNuZCA9IG5ldyBBdWRpbygpO1xuXHRcdFx0XHRzbmQuc3JjID0gYC9pbWFnZXMvc291bmRzL2JlZXAuJHtcblx0XHRcdFx0XHRzbmQuY2FuUGxheVR5cGUoJ2F1ZGlvL29nZycpID8gJ29nZycgOiAnbXAzJ1xuXHRcdFx0XHR9YDtcblx0XHRcdFx0c25kLnBsYXkoKTtcblxuXHRcdFx0XHRkMjAudGV4dGNoYXQubGFzdENoYXRCZWVwID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG5cdFx0XHR9XG5cblx0XHRcdGlmICghZDIwLnRleHRjaGF0LnRhYklzRm9jdXNlZCkge1xuXHRcdFx0XHQkKCcjdGV4dGNoYXR0YWInKS5hZGRDbGFzcygnYWxlcnRpZnknKTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRpZiAoZG9jdW1lbnQuYm9keS5jbGFzc05hbWUuaW5kZXhPZignc2lkZWJhcmhpZGRlbicpICE9PSAtMSkge1xuXHRcdFx0JCgnI3NpZGViYXJjb250cm9sJykuYWRkQ2xhc3MoJ2FsZXJ0aWZ5Jyk7XG5cdFx0fVxuXG5cdFx0aWYgKCFkMjAudGV4dGNoYXQuY2hhdHN0YXJ0aW5ndXApIHtcblx0XHRcdGxldCBiYXNlZG9uM2Ryb2xsaWQ7XG5cdFx0XHRpZiAob3AubGlzdGVuZXJpZCkge1xuXHRcdFx0XHQkKGRvY3VtZW50KS50cmlnZ2VyKGBtYW5jZXJyb2xsOiR7b3AubGlzdGVuZXJpZH1gLCBvcCk7XG5cdFx0XHR9XG5cblx0XHRcdGlmIChvcC50ZHNlZWQgIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHRiYXNlZG9uM2Ryb2xsaWQgPSBvcC5pZDtcblx0XHRcdH0gZWxzZSBpZiAob3AuaW5saW5lcm9sbHMgIT09IHVuZGVmaW5lZCAmJiBvcC5pbmxpbmVyb2xscy5sZW5ndGggPiAwKSB7XG5cdFx0XHRcdF8uZWFjaChvcC5pbmxpbmVyb2xscywgKGFuaW5saW5lcm9sbCkgPT4ge1xuXHRcdFx0XHRcdGlmIChhbmlubGluZXJvbGwudGRzZWVkICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0XHRcdGJhc2Vkb24zZHJvbGxpZCA9IGFuaW5saW5lcm9sbC5yb2xsaWQ7XG5cdFx0XHRcdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKGJhc2Vkb24zZHJvbGxpZCkge1xuXHRcdFx0XHQkY29udGVudC5maW5kKGAubWVzc2FnZVtkYXRhLW1lc3NhZ2VpZD0ke29wLmlkfV1gKS5hZGRDbGFzcygnaGlkZGVuM2QnKTsgLy8gdGVtcG9yYXJpbHkgaGlkZS5cblx0XHRcdFx0ZDIwLnRkZGljZS5oYW5kbGVJbmNvbWluZ0NoYXRXaXRoM0RSb2xsKGJhc2Vkb24zZHJvbGxpZCwgMSk7XG5cdFx0XHRcdHNldFRpbWVvdXQoXG5cdFx0XHRcdFx0KCkgPT4ge1xuXHRcdFx0XHRcdFx0ZDIwLnRleHRjaGF0LnNob3dIaWRkZW4zRFJvbGxzKCk7XG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRkMjAudGRkaWNlLmNhblJvbGwzRCgpID8gMzAwMCA6IDIwMDAsXG5cdFx0XHRcdCk7XG5cdFx0XHRcdGQyMC50ZXh0Y2hhdC5hbGxvd2VkM2Ryb2xscy5wdXNoKGJhc2Vkb24zZHJvbGxpZCk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9O1xuXG5cdGQyMC50ZXh0Y2hhdC5zaG93SGlkZGVuM0RSb2xscyA9IGZ1bmN0aW9uICgpIHtcblx0XHRsZXQgYXRib3R0b20gPSBmYWxzZTtcblxuXHRcdGlmIChkMjAuQ2FtcGFpZ24pIHtcblx0XHRcdGNvbnN0IGRvY2hlaWdodCA9ICRjb250ZW50LmhlaWdodCgpO1xuXHRcdFx0Y29uc3Qgd2luZG93aGVpZ2h0ID0gJCh3aW5kb3cpLmhlaWdodCgpO1xuXHRcdFx0Y29uc3Qgc2Nyb2xsdG9wID0gZDIwLnRleHRjaGF0LiR0ZXh0Y2hhdC5zY3JvbGxUb3AoKTtcblxuXHRcdFx0aWYgKGRvY2hlaWdodCAtIHNjcm9sbHRvcCAtIDIwMCA8IHdpbmRvd2hlaWdodCkge1xuXHRcdFx0XHRhdGJvdHRvbSA9IHRydWU7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0JGNvbnRlbnQuZmluZCgnLm1lc3NhZ2UuaGlkZGVuM2QnKS5yZW1vdmVDbGFzcygnaGlkZGVuM2QnKTtcblxuXHRcdGlmIChhdGJvdHRvbSkge1xuXHRcdFx0Y29uc3QgbmV3aGVpZ2h0ID0gJGNvbnRlbnQuaGVpZ2h0KCk7XG5cdFx0XHRkMjAudGV4dGNoYXQuJHRleHRjaGF0LnNjcm9sbFRvcChuZXdoZWlnaHQpO1xuXHRcdH1cblx0fTtcblxuXHRkMjAudGV4dGNoYXQudmVyaWZ5Um9sbCA9IGZ1bmN0aW9uIChyb2xsaWQsIG9iaiwgc2lnKSB7XG5cdFx0Y29uc3Qgc2lnYmFzZSA9IGAke3dpbmRvdy5jYW1wYWlnbl9zdG9yYWdlX3BhdGh9Ly8ke3JvbGxpZH0vLyR7b2JqLnRvdGFsfWA7XG5cdFx0Y29uc3QgaXNWYWxpZCA9IHg1MDkuc3ViamVjdFB1YmxpY0tleVJTQS52ZXJpZnlTdHJpbmcoc2lnYmFzZSwgc2lnKTtcblx0XHRyZXR1cm4gaXNWYWxpZDtcblx0fTtcblxuXHRkMjAudGV4dGNoYXQudXBkYXRlRGljZU9yZGVyaW5nID0gZnVuY3Rpb24gKG9wLCBlKSB7XG5cdFx0Y29uc3QgJHRhcmdldCA9ICQoZS50YXJnZXQpO1xuXHRcdGNvbnN0IGdyb3VwaW5kZXggPSBwYXJzZUludCgkdGFyZ2V0LmF0dHIoJ2RhdGEtZ3JvdXBpbmRleCcpLCAxMCk7XG5cdFx0Y29uc3Qgb3JpZ29iaiA9IEpTT04ucGFyc2Uob3AuY29udGVudCk7XG5cdFx0Y29uc3QgbmV3b3JkZXIgPSBbXTtcblx0XHQkdGFyZ2V0LmZpbmQoJy5kaWNlcm9sbCcpLmVhY2goZnVuY3Rpb24gKCkge1xuXHRcdFx0Y29uc3QgaW5keCA9IHBhcnNlSW50KCQodGhpcykuYXR0cignZGF0YS1vcmlnaW5kZXgnKSwgMTApO1xuXHRcdFx0aWYgKFxuXHRcdFx0XHQhb3JpZ29iai5yb2xsc1tncm91cGluZGV4XSB8fCAhb3JpZ29iai5yb2xsc1tncm91cGluZGV4XS5yZXN1bHRzW2luZHhdXG5cdFx0XHQpIHtcblx0XHRcdFx0Y29uc29sZS5lcnJvcihcblx0XHRcdFx0XHRgRVJST1I6IFVuYWJsZSB0byBmaW5kIGdyb3VwICR7Z3JvdXBpbmRleH0gb3IgcmVzdWx0ICR7aW5keH1gLFxuXHRcdFx0XHQpO1xuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cdFx0XHRuZXdvcmRlci5wdXNoKG9yaWdvYmoucm9sbHNbZ3JvdXBpbmRleF0ucmVzdWx0c1tpbmR4XSk7XG5cdFx0fSk7XG5cblx0XHRvcmlnb2JqLnJvbGxzW2dyb3VwaW5kZXhdLnJlc3VsdHMgPSBuZXdvcmRlcjtcblxuXHRcdGZicmVmXG5cdFx0XHQuY2hpbGQob3AuaWQpXG5cdFx0XHQuY2hpbGQoJ2NvbnRlbnQnKVxuXHRcdFx0LnNldChKU09OLnN0cmluZ2lmeShvcmlnb2JqKSk7XG5cdH07XG5cblx0ZDIwLnRleHRjaGF0LnVwZGF0ZVdob0lzVHlwaW5nID0gZnVuY3Rpb24gKCkge1xuXHRcdGNvbnN0IGRvY2hlaWdodCA9ICRjb250ZW50LmhlaWdodCgpO1xuXHRcdGNvbnN0IHdpbmRvd2hlaWdodCA9ICQod2luZG93KS5oZWlnaHQoKTtcblx0XHRjb25zdCBzY3JvbGx0b3AgPSBkMjAudGV4dGNoYXQuJHRleHRjaGF0LnNjcm9sbFRvcCgpO1xuXHRcdGxldCBhdGJvdHRvbSA9IGZhbHNlO1xuXG5cdFx0aWYgKGRvY2hlaWdodCAtIHNjcm9sbHRvcCA8IHdpbmRvd2hlaWdodCAtIDE1MCkge1xuXHRcdFx0YXRib3R0b20gPSB0cnVlO1xuXHRcdH1cblxuXHRcdGNvbnN0IHdobyA9IF8udmFsdWVzKHdob2lzdHlwaW5nKTtcblx0XHRpZiAod2hvLmxlbmd0aCA9PSAwKSB7XG5cdFx0XHQkKCcjd2hvaXN0eXBpbmcnKS5oaWRlKCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGxldCB2ZXJiID0gJ2FyZSc7XG5cdFx0XHRpZiAod2hvLmxlbmd0aCA9PSAxKSB7XG5cdFx0XHRcdHZlcmIgPSAnaXMnO1xuXHRcdFx0fVxuXHRcdFx0JCgnI3dob2lzdHlwaW5nIC5uYW1lcycpLnRleHQoXG5cdFx0XHRcdGAke3doby5qb2luKCcsICcpLnJlcGxhY2UoLywkLywgJyBhbmQnKX0gJHt2ZXJifSB0eXBpbmcuLi5gLFxuXHRcdFx0KTtcblx0XHRcdCQoJyN3aG9pc3R5cGluZycpLnNob3coKTtcblx0XHR9XG5cblx0XHRpZiAoYXRib3R0b20pIHtcblx0XHRcdGNvbnN0IG5ld2hlaWdodCA9ICRjb250ZW50LmhlaWdodCgpO1xuXHRcdFx0ZDIwLnRleHRjaGF0LiR0ZXh0Y2hhdC5zY3JvbGxUb3AobmV3aGVpZ2h0KTtcblx0XHR9XG5cdH07XG5cblx0Y29uc3QgaGFuZGxlU2hvdXQgPSBmdW5jdGlvbiAob2JqKSB7XG5cdFx0aWYgKG9iai50eXBlID09ICdpc3R5cGluZycpIHtcblx0XHRcdGlmIChvYmoucGxheWVyaWQgPT0gd2luZG93LmN1cnJlbnRQbGF5ZXIuaWQpIHtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoaXN0eXBpbmd0aW1lcnNbb2JqLnBsYXllcmlkXSkge1xuXHRcdFx0XHRjbGVhclRpbWVvdXQoaXN0eXBpbmd0aW1lcnNbb2JqLnBsYXllcmlkXSk7XG5cdFx0XHR9XG5cblx0XHRcdHdob2lzdHlwaW5nW29iai5wbGF5ZXJpZF0gPSBvYmouY29udGVudDtcblxuXHRcdFx0aXN0eXBpbmd0aW1lcnNbb2JqLnBsYXllcmlkXSA9IHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdFx0XHRpc3R5cGluZ3RpbWVyc1tvYmoucGxheWVyaWRdID0gZmFsc2U7XG5cdFx0XHRcdGRlbGV0ZSB3aG9pc3R5cGluZ1tvYmoucGxheWVyaWRdO1xuXHRcdFx0XHRkMjAudGV4dGNoYXQudXBkYXRlV2hvSXNUeXBpbmcoKTtcblx0XHRcdH0sIDUwMDApO1xuXG5cdFx0XHRkMjAudGV4dGNoYXQudXBkYXRlV2hvSXNUeXBpbmcoKTtcblx0XHR9IGVsc2UgaWYgKG9iai50eXBlID09ICdzaGR3X3VwZGF0ZScgfHwgb2JqLnR5cGUgPT0gJ3NoZHdfa2lsbCcpIHtcblx0XHRcdGQyMC5lbmdpbmUuaGFuZGxlU2hhZG93cyhvYmopO1xuXHRcdH0gZWxzZSBpZiAob2JqLnR5cGUgPT0gJ3N0ZWFsX3JlcXVlc3QnKSB7XG5cdFx0XHRkMjAuZGVja3Muc3RlYWxfcmVxdWVzdChvYmopO1xuXHRcdH0gZWxzZSBpZiAob2JqLnR5cGUgPT0gJ3N0ZWFsX3Jlc3BvbnNlJykge1xuXHRcdFx0ZDIwLmRlY2tzLnN0ZWFsX3Jlc3BvbnNlKG9iaik7XG5cdFx0fSBlbHNlIGlmIChvYmoudHlwZSA9PSAnbWVhc3VyaW5nJykge1xuXHRcdFx0ZDIwLmVuZ2luZS5yZWNlaXZlTWVhc3VyZVVwZGF0ZShvYmopO1xuXHRcdH0gZWxzZSBpZiAob2JqLnR5cGUgPT0gJ2VuZG1lYXN1cmVtZW50Jykge1xuXHRcdFx0ZDIwLmVuZ2luZS5yZWNlaXZlRW5kTWVhc3VyZShvYmopO1xuXHRcdH0gZWxzZSBpZiAob2JqLnR5cGUgPT0gJ21hcHBpbmcnKSB7XG5cdFx0XHRvYmouY3VycmVudExheWVyID0gb2JqLmN1cnJlbnRMYXllciB8fCAnb2JqZWN0cyc7XG5cdFx0XHRvYmouYXBpID0gdHJ1ZTtcblx0XHRcdGQyMC5lbmdpbmUucmVjZWl2ZU1hcHBpbmcob2JqKTtcblx0XHR9XG5cdFx0Ly8gSGlkZSBhbGwgY2VsbHMgb24gYSBnaXZlbiBwYWdlIGZvciB0aGUgZ2l2ZW4gcGxheWVycy5cblx0XHRlbHNlIGlmIChvYmoudHlwZSA9PSAnYXBpX3Jlc2V0X2ZvZycpIHtcblx0XHRcdF8uZWFjaChvYmoucGxheWVycywgKGlkKSA9PiB7XG5cdFx0XHRcdGNvbnN0IHBsYXllciA9IGQyMC5DYW1wYWlnbi5wbGF5ZXJzLmdldChpZCk7XG5cdFx0XHRcdGNvbnN0IHJldmVhbGVkID0gSlNPTi5wYXJzZShwbGF5ZXIuZ2V0KCdhZHZfZm93X3JldmVhbGVkJykpO1xuXHRcdFx0XHRkZWxldGUgcmV2ZWFsZWRbb2JqLnBhZ2VpZF07XG5cdFx0XHRcdHBsYXllci5zYXZlKHtcblx0XHRcdFx0XHRhZHZfZm93X3JldmVhbGVkOiBKU09OLnN0cmluZ2lmeShyZXZlYWxlZCksXG5cdFx0XHRcdH0pO1xuXHRcdFx0fSk7XG5cdFx0XHRkMjAuZW5naW5lLnJlZHJhd1NjcmVlbk5leHRUaWNrKCk7XG5cdFx0fVxuXHRcdC8vIEhpZGUgYWxsIGNlbGxzIG9uIHRoaXMgcGFnZSBmb3IgbWUuXG5cdFx0ZWxzZSBpZiAob2JqLnR5cGUgPT0gJ2NsZWFyX3BhZ2VfYWZvdycpIHtcblx0XHRcdGQyMC5lbmdpbmUuYWR2YW5jZWRfZm9nLmNsZWFyUGFnZShvYmoucGFnZWlkKTtcblx0XHR9XG5cdFx0Ly8gQ29tcGxldGVseSBjbGVhciBsb2NhbCByZXZlYWxlZCBjZWxscyBhbmQgcmVzZXQgdGhlbSB0byBjdXJyZW50IGRhdGEgZnJvbSBGaXJlYmFzZS5cblx0XHQvLyBOb3RlOiBJZiB5b3UgaGF2ZSBsb2NhbCBBRm9XIGRhdGEgdGhhdCBoYXNuJ3QgYmVlbiBzZW50IHRvIEZpcmViYXNlIHlldCwgdGhpcyB3aWxsIGVyYXNlIGl0LlxuXHRcdGVsc2UgaWYgKG9iai50eXBlID09ICdyZXNldF9sb2NhbF9hZm93Jykge1xuXHRcdFx0Zm9yIChjb25zdCBwbGF5ZXIgaW4gZDIwLmVuZ2luZS5hZHZhbmNlZF9mb2cucmV2ZWFsZWRfY2VsbHMpIHtcblx0XHRcdFx0Y29uc3QgcGFnZXMgPSBkMjAuZW5naW5lLmFkdmFuY2VkX2ZvZy5yZXZlYWxlZF9jZWxsc1twbGF5ZXJdO1xuXHRcdFx0XHRmb3IgKGNvbnN0IHBhZ2UgaW4gcGFnZXMpIHtcblx0XHRcdFx0XHRwYWdlc1twYWdlXSA9IG5ldyBTZXQoKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdFx0ZDIwLmVuZ2luZS5hZHZhbmNlZF9mb2cudmlzaWJsZV9jZWxscyA9IHt9O1xuXHRcdFx0Zm9yIChjb25zdCBwbGF5ZXIgb2YgZDIwLkNhbXBhaWduLnBsYXllcnMubW9kZWxzKSB7XG5cdFx0XHRcdHBsYXllci50cmlnZ2VyKFxuXHRcdFx0XHRcdCdjaGFuZ2U6YWR2X2Zvd19yZXZlYWxlZCcsXG5cdFx0XHRcdFx0cGxheWVyLFxuXHRcdFx0XHRcdHBsYXllci5nZXQoJ2Fkdl9mb3dfcmV2ZWFsZWQnKSxcblx0XHRcdFx0KTtcblx0XHRcdH1cblx0XHRcdGQyMC5lbmdpbmUuYWR2YW5jZWRfZm9nLnVwZGF0ZUFsbFZpc2lvbigpO1xuXHRcdFx0ZDIwLmVuZ2luZS5yZWRyYXdTY3JlZW5OZXh0VGljaygpO1xuXHRcdH1cblx0XHQvLyBDbGVhciBBRm9XIGNlbGxzIGxvY2FsbHkgdG8gc3luYyB3aXRoIEZpcmViYXNlIGRhdGEgYWZ0ZXIgc29tZW9uZSB1c2VkIHRoZSBmb2ctaGlkZSB0b29sLlxuXHRcdC8vIFRoaXMgc2hvdXQgaXMgc2FmZSBmb3IgbG9jYWwgZGF0YS5cblx0XHRlbHNlIGlmIChvYmoudHlwZSA9PT0gJ2Fmb3dfaGlkZV9sb2NhbCcpIHtcblx0XHRcdGNvbnN0IGlkcyA9IF8uaW52b2tlKGQyMC5DYW1wYWlnbi5wbGF5ZXJzLm1vZGVscywgJ2dldCcsICdpZCcpO1xuXHRcdFx0aWYgKHdpbmRvdy5pc19nbSkge1xuXHRcdFx0XHRpZHMucHVzaCgnZ20nKTtcblx0XHRcdH1cblx0XHRcdGxldCBzZXQ7XG5cdFx0XHRmb3IgKGNvbnN0IHBsYXllcl9pZCBvZiBpZHMpIHtcblx0XHRcdFx0aWYgKFxuXHRcdFx0XHRcdChzZXQgPSBkMjAuZW5naW5lLmFkdmFuY2VkX2ZvZy5yZXZlYWxlZF9jZWxsc1twbGF5ZXJfaWRdKSAmJiAoc2V0ID0gc2V0W29iai5wYWdlX2lkXSlcblx0XHRcdFx0KSB7XG5cdFx0XHRcdFx0Y29uc3QgbGVuID0gb2JqLmNlbGxzLmxlbmd0aDtcblx0XHRcdFx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgKytpKSB7XG5cdFx0XHRcdFx0XHRzZXQuZGVsZXRlKG9iai5jZWxsc1tpXSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0XHRkMjAuZW5naW5lLmFkdmFuY2VkX2ZvZy51cGRhdGVBbGxWaXNpb24oKTtcblx0XHR9IGVsc2UgaWYgKG9iai50eXBlID09ICdzaG93aGFuZG91dCcpIHtcblx0XHRcdGQyMC5qb3VybmFsLnNob3dIYW5kb3V0RnJvbVNob3V0KG9iaik7XG5cdFx0fSBlbHNlIGlmIChvYmoudHlwZSA9PSAnc2hvd2NoYXJhY3RlcicpIHtcblx0XHRcdGQyMC5qb3VybmFsLnNob3dDaGFyYWN0ZXJGcm9tU2hvdXQob2JqKTtcblx0XHR9IGVsc2UgaWYgKG9iai50eXBlID09ICdzaG93b2JqZWN0Jykge1xuXHRcdFx0aWYgKCFvYmouaWQpIHJldHVybjtcblx0XHRcdGQyMC5lbmdpbmUuem9vbU9iamVjdChvYmouaWQpO1xuXHRcdH0gZWxzZSBpZiAob2JqLnR5cGUgPT0gJzNkcm9sbCcpIHtcblx0XHRcdGlmIChkMjAudGRkaWNlICYmIG9iai5wbGF5ZXJpZCAhPT0gd2luZG93LmN1cnJlbnRQbGF5ZXIuaWQpIHtcblx0XHRcdFx0ZDIwLnRkZGljZS5yZW1vdGVSb2xsKG9iaik7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIGlmIChcblx0XHRcdG9iai50eXBlID09ICdmeF9zdGFydCcgfHwgb2JqLnR5cGUgPT0gJ2Z4X3VwZGF0ZScgfHwgb2JqLnR5cGUgPT0gJ2Z4X2tpbGwnXG5cdFx0KSB7XG5cdFx0XHRpZiAob2JqLnBsYXllcmlkID09PSB3aW5kb3cuY3VycmVudFBsYXllci5pZCkgcmV0dXJuO1xuXHRcdFx0ZDIwLmZ4LmhhbmRsZVNob3V0KG9iaik7XG5cdFx0fSBlbHNlIGlmIChvYmoudHlwZSA9PSAnc2V0dGluZ3NjaGFuZ2VkJykge1xuXHRcdFx0aWYgKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gb2JqLnRpbWUgPCA1MDAwKSB7XG5cdFx0XHRcdHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTtcblx0XHRcdH1cblx0XHR9IGVsc2UgaWYgKG9iai50eXBlID09ICdwbGF5Y2xpY2tob2xlJyAmJiBvYmouY29udGVudC5sZW5ndGggPiAyKSB7XG5cdFx0XHRpZiAod2luZG93LmZha2VMaWdodGx5KSB7XG5cdFx0XHRcdHdpbmRvdy5mYWtlTGlnaHRseShcblx0XHRcdFx0XHRgaHR0cDovL3YudGhlb25pb24uY29tL29uaW9uc3R1ZGlvcy92aWRlby8ke29iai5jb250ZW50WzBdfS82NDAubXA0YCxcblx0XHRcdFx0KTtcblx0XHRcdH1cblxuXHRcdFx0c2V0VGltZW91dCgoKSA9PiB7XG5cdFx0XHRcdCQoJyNsaWdodGx5LW92ZXJsYXknKS5oaWRlKCk7XG5cdFx0XHR9LCBvYmouY29udGVudFsyXSAqIDEwMDAgKyAyMDAwKTtcblx0XHR9IGVsc2UgaWYgKG9iai50eXBlID09PSAncm9sbF9yZWNlaXZlZCcpIHtcblx0XHRcdGQyMC5kaWNlX2VuZ2luZS5oYW5kbGVSb2xsUmVjZWl2ZWQob2JqKTtcblx0XHR9IGVsc2UgaWYgKG9iai50eXBlID09PSAncGxheV9hbmltX29uY2UnKSB7XG5cdFx0XHRsZXQgZ3JhcGhpYyA9IGQyMC5DYW1wYWlnbi5hY3RpdmVQYWdlKCkudGhlZ3JhcGhpY3MuZ2V0KG9iai5pZCk7XG5cdFx0XHRpZiAoZ3JhcGhpYyAmJiAoZ3JhcGhpYyA9IGdyYXBoaWMudmlldy5ncmFwaGljKSAmJiBncmFwaGljLmlzQW5pbWF0ZWQpIHtcblx0XHRcdFx0Z3JhcGhpYy5yZXN0YXJ0QW5pbWF0aW9uKHRydWUpO1xuXHRcdFx0fVxuXHRcdH0gZWxzZSBpZiAob2JqLnR5cGUgPT09ICdleHBsb3Jlcl9tb2RlX3JldmVhbCcpIHtcblx0XHRcdGlmIChvYmoucGFnZV9pZCAhPT0gZDIwLkNhbXBhaWduLmFjdGl2ZVBhZ2UoKS5pZCkgcmV0dXJuO1xuXHRcdFx0Y29uc3QgdmlldyA9IG9iai5kYXRhLm1vZGUgPT09ICdwZXJtYW5lbnQnID8gZDIwLmR5bl9mb2cubWFza19wYWdlX21hbmFnZXIucGVybWFuZW50RGFya25lc3NWaWV3IDogZDIwLmR5bl9mb2cubWFza19wYWdlX21hbmFnZXIuZ2V0Q3VycmVudFBsYXllclZpZXcoKTtcblxuXHRcdFx0dmlldy5kMjAgPSBkMjA7XG5cdFx0XHQvLyBDYWxsIFBhZ2VtYW5hZ2VyIGFuZCBwYXNzIHRoZSB2aWV3IGFuZCB0aGUgdG9vbCBkYXRhXG5cdFx0XHRjb25zdCBwYWdlID0gZDIwLkNhbXBhaWduLmFjdGl2ZVBhZ2UoKTtcblx0XHRcdGNvbnN0IHBhZ2VXaWR0aCA9IHBhZ2UuZ2V0KCd3aWR0aCcpICogNzA7XG5cdFx0XHRjb25zdCBwYWdlSGVpZ2h0ID0gcGFnZS5nZXQoJ2hlaWdodCcpICogNzA7XG5cdFx0XHRkMjAuZHluX2ZvZy51bnJldmVhbGVkTWFzay5QYWdlTWFuYWdlci5tb2RpZnlEYXJrbmVzcyhcblx0XHRcdFx0dmlldyxcblx0XHRcdFx0b2JqLmRhdGEsXG5cdFx0XHRcdHBhZ2VXaWR0aCxcblx0XHRcdFx0cGFnZUhlaWdodCxcblx0XHRcdCk7XG5cdFx0fVxuXHR9O1xuXG5cdGxldCB0ZXh0Y2hhdHBvcHBlZDtcblxuXHRkMjAudGV4dGNoYXQuc3RhcnR1cCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcblx0XHRhd2FpdCBkMjAuam91cm5hbC5jaGFyc2hlZXRGZXRjaFByb21pc2U7XG5cblx0XHRsZXQgcGFyZW50UmVmO1xuXG5cdFx0aWYgKHdpbmRvdy5HTlRLTiA9PT0gJ3R1dG9yaWFsJykge1xuXHRcdFx0cGFyZW50UmVmID0gbmV3IE1vY2tGaXJlYmFzZVJlZmVyZW5jZShgJHt3aW5kb3cuRklSRUJBU0VfUk9PVCArIHdpbmRvdy5jYW1wYWlnbl9zdG9yYWdlX3BhdGh9L2ApO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRwYXJlbnRSZWYgPSBmaXJlYmFzZS5kYXRhYmFzZSgpLnJlZihcblx0XHRcdFx0YCR7d2luZG93LmNhbXBhaWduX3N0b3JhZ2VfcGF0aH1gLFxuXHRcdFx0KTtcblx0XHR9XG5cdFx0c2hvdXRyZWYgPSBwYXJlbnRSZWYuY2hpbGQoJ3Nob3V0Jyk7XG5cdFx0ZmJyZWYgPSBwYXJlbnRSZWYuY2hpbGQoJ2NoYXQnKTtcblx0XHR0ZXh0Y2hhdHBvcHBlZCA9IGZhbHNlO1xuXHRcdGxldCBzb2NranM7XG5cdFx0bGV0IHNvY2tqc2FjdGl2ZSA9IGZhbHNlO1xuXHRcdHZhciBzdGFydHVwU29jayA9IGZ1bmN0aW9uICgpIHtcblx0XHRcdHNvY2tqcyA9IG5ldyBTb2NrSlMoJ2h0dHBzOi8vYXBwLnJvbGwyMC5uZXQvc29jaycpO1xuXHRcdFx0c29ja2pzLm9ub3BlbiA9IGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0Y29uc29sZS5sb2coJ1sqXSBzb2NrZXQgb3BlbicsIHNvY2tqcy5wcm90b2NvbCk7XG5cdFx0XHRcdHNvY2tqcy5zZW5kKFxuXHRcdFx0XHRcdEpTT04uc3RyaW5naWZ5KHtcblx0XHRcdFx0XHRcdHQ6ICdqb2luJyxcblx0XHRcdFx0XHRcdGM6IGBjYW1wLSR7d2luZG93LmNhbXBhaWduX2lkfWAsXG5cdFx0XHRcdFx0fSksXG5cdFx0XHRcdCk7XG5cdFx0XHRcdHNvY2tqc2FjdGl2ZSA9IHRydWU7XG5cdFx0XHR9O1xuXHRcdFx0c29ja2pzLm9ubWVzc2FnZSA9IGZ1bmN0aW9uIChlKSB7XG5cdFx0XHRcdGhhbmRsZVNob3V0KEpTT04ucGFyc2UoZS5kYXRhKSk7XG5cdFx0XHR9O1xuXHRcdFx0c29ja2pzLm9uY2xvc2UgPSBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdHNvY2tqc2FjdGl2ZSA9IGZhbHNlO1xuXHRcdFx0XHRjb25zb2xlLmxvZygnTG9zdCBzb2NrZXQsIGF0dGVtcHRpbmcgdG8gcmVjb25uZWN0IGluIDUgc2Vjb25kcy4nKTtcblx0XHRcdFx0c2V0VGltZW91dCgoKSA9PiB7XG5cdFx0XHRcdFx0c3RhcnR1cFNvY2soKTtcblx0XHRcdFx0fSwgNTAwMCk7XG5cdFx0XHR9O1xuXHRcdH07XG5cdFx0ZDIwLnRleHRjaGF0LnNlbmRTaG91dCA9IGZ1bmN0aW9uIChtc2cpIHtcblx0XHRcdGlmIChcblx0XHRcdFx0c29ja2pzYWN0aXZlICYmIChtc2cudHlwZSA9PT0gJ2lzdHlwaW5nJyB8fCBtc2cudHlwZSA9PT0gJ21lYXN1cmluZycgfHwgbXNnLnR5cGUgPT09ICdlbmRtZWFzdXJlbWVudCcgfHwgbXNnLnR5cGUgPT09ICdmeF9zdGFydCcgfHwgbXNnLnR5cGUgPT09ICdmeF91cGRhdGUnIHx8IG1zZy50eXBlID09PSAnZnhfa2lsbCcgfHwgbXNnLnR5cGUgPT09ICdwbGF5X2FuaW1fb25jZScgfHwgbXNnLnR5cGUgPT09ICdhZm93X2hpZGVfbG9jYWwnKVxuXHRcdFx0KSB7XG5cdFx0XHRcdHNvY2tqcy5zZW5kKFxuXHRcdFx0XHRcdEpTT04uc3RyaW5naWZ5KHtcblx0XHRcdFx0XHRcdHQ6ICdtc2cnLFxuXHRcdFx0XHRcdFx0Y29udGVudDogbXNnLFxuXHRcdFx0XHRcdH0pLFxuXHRcdFx0XHQpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0ZDIwLnRleHRjaGF0LnNob3V0cmVmLnNldChKU09OLnN0cmluZ2lmeShtc2cpKTtcblx0XHRcdH1cblx0XHR9O1xuXHRcdGQyMC50ZXh0Y2hhdC5zaG91dHJlZiA9IHNob3V0cmVmO1xuXHRcdGQyMC50ZXh0Y2hhdC5jaGF0c3RhcnRpbmd1cCA9IHRydWU7XG5cblx0XHRzaG91dHJlZi5vbigndmFsdWUnLCAoc2hvdXRvcCkgPT4ge1xuXHRcdFx0aWYgKGQyMC50ZXh0Y2hhdC5jaGF0c3RhcnRpbmd1cCkge1xuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IG9iaiA9IHNob3V0b3AudmFsKCk7XG5cdFx0XHRpZiAoIW9iaikgcmV0dXJuO1xuXG5cdFx0XHRoYW5kbGVTaG91dChKU09OLnBhcnNlKG9iaikpO1xuXHRcdH0pO1xuXG5cdFx0bGV0IGNoYXRTdGFydHVwQ2FjaGUgPSBbXTtcblxuXHRcdGNvbnN0IGNoYXRmaW5hbCA9IGZ1bmN0aW9uICgpIHtcblx0XHRcdGZ1bmN0aW9uIHdlbGNvbWVNZXNzYWdlKCkge1xuXHRcdFx0XHRkMjAudGV4dGNoYXQuaW5jb21pbmcoZmFsc2UsIHtcblx0XHRcdFx0XHR3aG86ICdzeXN0ZW0nLFxuXHRcdFx0XHRcdHR5cGU6ICdzeXN0ZW0nLFxuXHRcdFx0XHRcdGNvbnRlbnQ6ICQoJyN0bXBsX3dlbGNvbWVfbWVzc2FnZScpLmpxb3RlKCksXG5cdFx0XHRcdH0pO1xuXG5cdFx0XHRcdGlmIChkMjBleHQudmlkZW90eXBlID09PSAnY2hyb21lNjMnKSB7XG5cdFx0XHRcdFx0ZDIwLnRleHRjaGF0LmluY29taW5nKGZhbHNlLCB7XG5cdFx0XHRcdFx0XHR3aG86ICdzeXN0ZW0nLFxuXHRcdFx0XHRcdFx0dHlwZTogJ3N5c3RlbScsXG5cdFx0XHRcdFx0XHRjb250ZW50OiBgKioke2kxOG4oJ2NoYXRfY2hyb21lNjNfd2FybmluZycpfSoqYCxcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fVxuXHRcdFx0XHRpZiAoZDIwZXh0LnZpZGVvdHlwZSA9PT0gJ2Nocm9tZTYzJyB8fCBkMjBleHQudmlkZW90eXBlID09PSAncm9sbDIwJykge1xuXHRcdFx0XHRcdGQyMC50ZXh0Y2hhdC5pbmNvbWluZyhmYWxzZSwge1xuXHRcdFx0XHRcdFx0d2hvOiAnc3lzdGVtJyxcblx0XHRcdFx0XHRcdHR5cGU6ICdzeXN0ZW0nLFxuXHRcdFx0XHRcdFx0Y29udGVudDogYCoqJHtpMThuKCdjaGF0X3dlYnJ0Y19kZXByZWNhdGVkJyl9KipgLFxuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdGZvciAobGV0IGkgPSAwOyBpIDwgY2hhdFN0YXJ0dXBDYWNoZS5sZW5ndGg7IGkrKykge1xuXHRcdFx0XHRkMjAudGV4dGNoYXQuaW5jb21pbmcoXG5cdFx0XHRcdFx0IWQyMC50ZXh0Y2hhdC5jaGF0c3RhcnRpbmd1cCxcblx0XHRcdFx0XHRjaGF0U3RhcnR1cENhY2hlW2ldLFxuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXG5cdFx0XHRjaGF0U3RhcnR1cENhY2hlID0gbnVsbDtcblxuXHRcdFx0d2VsY29tZU1lc3NhZ2UoKTtcblx0XHRcdGludml0ZUxpbmtNZXNzYWdlKCk7XG5cblx0XHRcdGQyMC50ZXh0Y2hhdC5jaGF0c3RhcnRpbmd1cCA9IGZhbHNlO1xuXHRcdH07XG5cblx0XHRjb25zdCBkZWJvdW5jZWRfY2hhdGZpbmFsID0gXy5kZWJvdW5jZShjaGF0ZmluYWwsIDEwMDApO1xuXG5cdFx0Y29uc3QgZmJyZWZxID0gZmJyZWYubGltaXRUb0xhc3QoMTAwKTtcblx0XHRjb25zdCBhbGxpZHMgPSBbXTtcblxuXHRcdGxldCBsYXN0SGVhcmRJZCA9IGZhbHNlO1xuXHRcdGxldCBsYXN0SGVhcmRUaW1lID0gMDtcblxuXHRcdGNvbnN0IHVwZGF0ZWNoYXRvcCA9IGZ1bmN0aW9uIChwdXNoZWRfb2JqKSB7XG5cdFx0XHRjb25zdCBvcCA9IHB1c2hlZF9vYmoudmFsKCk7XG5cdFx0XHRvcC50aW1lc3RhbXAgPSBwdXNoZWRfb2JqLmdldFByaW9yaXR5KCk7XG5cdFx0XHRvcC5pZCA9IHB1c2hlZF9vYmoua2V5O1xuXG5cdFx0XHRpZiAoYWxsaWRzLmluZGV4T2Yob3AuaWQpID09PSAtMSkge1xuXHRcdFx0XHRhbGxpZHMucHVzaChvcC5pZCk7XG5cdFx0XHRcdGxhc3RIZWFyZElkID0gb3AuaWQ7XG5cdFx0XHRcdGxhc3RIZWFyZFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcblxuXHRcdFx0XHRpZiAoZDIwLnRleHRjaGF0LmNoYXRzdGFydGluZ3VwKSB7XG5cdFx0XHRcdFx0Y2hhdFN0YXJ0dXBDYWNoZS5wdXNoKG9wKTtcblx0XHRcdFx0XHRkZWJvdW5jZWRfY2hhdGZpbmFsKCk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0ZDIwLnRleHRjaGF0LmluY29taW5nKCFkMjAudGV4dGNoYXQuY2hhdHN0YXJ0aW5ndXAsIG9wKTtcblx0XHRcdFx0fVxuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0Ly8gV2UgZ2V0IGEgY2hpbGRfY2hhbmdlZCByaWdodCBhZnRlciBhIGNoaWxkX2FkZGVkIGZvciBsb2NhbCBjaGF0IGV2ZW50cywgc28gZ2lub3JlIHRoYXQuXG5cdFx0XHRcdGlmIChcblx0XHRcdFx0XHQhZDIwLnRleHRjaGF0LmNoYXRzdGFydGluZ3VwICYmIChsYXN0SGVhcmRJZCAhPT0gb3AuaWQgfHwgbmV3IERhdGUoKS5nZXRUaW1lKCkgLSBsYXN0SGVhcmRUaW1lID4gNTAwKVxuXHRcdFx0XHQpIHtcblx0XHRcdFx0XHRkMjAudGV4dGNoYXQuaW5jb21pbmcodHJ1ZSwgb3AsIHRydWUsIHRydWUpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fTtcblxuXHRcdGZicmVmcS5vbignY2hpbGRfYWRkZWQnLCAocHVzaGVkX29iaikgPT4ge1xuXHRcdFx0dXBkYXRlY2hhdG9wKHB1c2hlZF9vYmopO1xuXHRcdH0pO1xuXG5cdFx0ZmJyZWZxLm9uKCdjaGlsZF9jaGFuZ2VkJywgKGNoYW5nZWRfb2JqKSA9PiB7XG5cdFx0XHR1cGRhdGVjaGF0b3AoY2hhbmdlZF9vYmopO1xuXHRcdH0pO1xuXG5cdFx0ZmJyZWZxLm9uY2UoJ3ZhbHVlJywgKCkgPT4ge1xuXHRcdFx0ZGVib3VuY2VkX2NoYXRmaW5hbCgpOyAvLyBldmVuIGlmIGl0J3MgZW1wdHkgbWFrZSBzdXJlIHdlIGdldCBnb2luZyBoZXJlIVxuXHRcdH0pO1xuXHR9O1xuXG5cdGxldCBvaGVpZ2h0O1xuXG5cdGQyMC50ZXh0Y2hhdC5vcGVuZGlhbG9nID0gZnVuY3Rpb24gKCkge1xuXHRcdG9oZWlnaHQgPSAkKCcjdGV4dGNoYXQnKS5jc3MoJ2hlaWdodCcpO1xuXHRcdCQoJyN0ZXh0Y2hhdCcpLmRpYWxvZyh7XG5cdFx0XHR0aXRsZTogJ1RleHQgQ2hhdCcsXG5cdFx0XHRiZWZvcmVDbG9zZSgpIHtcblx0XHRcdFx0JCh0aGlzKS5kaWFsb2coJ2Rlc3Ryb3knKTtcblx0XHRcdFx0JCh0aGlzKS5hcHBlbmRUbygnI3JpZ2h0c2lkZWJhcicpO1xuXHRcdFx0XHQkKHRoaXMpXG5cdFx0XHRcdFx0LmNzcygnaGVpZ2h0Jywgb2hlaWdodClcblx0XHRcdFx0XHQuY3NzKCd3aWR0aCcsICdhdXRvJyk7XG5cdFx0XHRcdCQodGhpcykuc2hvdygpO1xuXHRcdFx0fSxcblx0XHR9KTtcblx0fTtcblxuXHRkMjAudGV4dGNoYXQuc2hvd1BvcG91dCA9IGZ1bmN0aW9uICgpIHtcblx0XHRpZiAodGV4dGNoYXRwb3BwZWQgPT09IHRydWUpIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cdFx0Y29uc3QgJHRhcmdldGVsID0gJCgnI3RleHRjaGF0Jyk7XG5cdFx0Y29uc3QgJGlucHV0ZWwgPSAkKCcjdGV4dGNoYXQtaW5wdXQnKTtcblx0XHRjb25zdCAkcHJldmRpYWxvZyA9ICR0YXJnZXRlbC5wYXJlbnQoKTtcblx0XHRkMjAudGV4dGNoYXQuY2hpbGRXaW5kb3cgPSB3aW5kb3cub3Blbihcblx0XHRcdCcvZWRpdG9yL3BvcG91dGNoYXQnLFxuXHRcdFx0J0NoYXRQb3BvdXQnLFxuXHRcdFx0J21lbnViYXI9MCxsb2NhdGlvbj0wLHRvb2xiYXI9MCxzdGF0dXM9MCxzY3JvbGxiYXJzPTEsd2lkdGg9MzAwLGhlaWdodD04MDAnLFxuXHRcdCk7XG5cdFx0d2luZG93LmFsbENoaWxkV2luZG93cy5wdXNoKGQyMC50ZXh0Y2hhdC5jaGlsZFdpbmRvdyk7XG5cdFx0Ly8gb3RoaXMuJGVsLmRldGFjaCgpO1xuXG5cdFx0ZDIwLnRleHRjaGF0LmNoaWxkV2luZG93Lm9ubG9hZCA9IGZ1bmN0aW9uICgpIHtcblx0XHRcdHRleHRjaGF0cG9wcGVkID0gdHJ1ZTtcblx0XHRcdGlmIChkMjAuam91cm5hbC5jdXN0b21TaGVldHMgJiYgZDIwLmpvdXJuYWwuY3VzdG9tU2hlZXRzLnN0eWxlZWwpIHtcblx0XHRcdFx0JChkMjAuam91cm5hbC5jdXN0b21TaGVldHMuc3R5bGVlbClcblx0XHRcdFx0XHQuY2xvbmUoKVxuXHRcdFx0XHRcdC5hcHBlbmRUbyhkMjAudGV4dGNoYXQuY2hpbGRXaW5kb3cuZG9jdW1lbnQuaGVhZCk7XG5cdFx0XHR9XG5cdFx0XHQkdGFyZ2V0ZWwuYXBwZW5kVG8oXG5cdFx0XHRcdGQyMC50ZXh0Y2hhdC5jaGlsZFdpbmRvdy5kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29udGFpbmVyZGl2JyksXG5cdFx0XHQpO1xuXHRcdFx0JGlucHV0ZWwuYXBwZW5kVG8oZDIwLnRleHRjaGF0LmNoaWxkV2luZG93LmRvY3VtZW50LmJvZHkpO1xuXHRcdFx0ZDIwLnRleHRjaGF0LiR0ZXh0YXJlYVxuXHRcdFx0XHQuYXV0b2NvbXBsZXRlKCd3aWRnZXQnKVxuXHRcdFx0XHQuYXBwZW5kVG8oZDIwLnRleHRjaGF0LmNoaWxkV2luZG93LmRvY3VtZW50LmJvZHkpO1xuXHRcdFx0ZDIwLnRleHRjaGF0LmNoaWxkV2luZG93LmRvY3VtZW50LnRpdGxlID0gJ1JvbGwyMCBDaGF0Jztcblx0XHRcdCR0YXJnZXRlbC5zY3JvbGxUb3AoJHRhcmdldGVsWzBdLnNjcm9sbEhlaWdodCk7XG5cdFx0XHQkKCcjdGV4dGNoYXR0YWIgYScpLnRyaWdnZXIoJ2NsaWNrJyk7XG5cblx0XHRcdGNvbnN0IGF1dG9HcmF2ID0gZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRpZiAoJCh0aGlzKS5oYXNDbGFzcygndGlwc3ktdycpKSByZXR1cm4gJ3cnO1xuXHRcdFx0XHRpZiAoJCh0aGlzKS5oYXNDbGFzcygndGlwc3ktZScpKSByZXR1cm4gJ2UnO1xuXHRcdFx0XHRpZiAoJCh0aGlzKS5oYXNDbGFzcygndGlwc3ktbicpKSByZXR1cm4gJ24nO1xuXHRcdFx0XHRpZiAoJCh0aGlzKS5oYXNDbGFzcygndGlwc3ktcycpKSByZXR1cm4gJ3MnO1xuXHRcdFx0XHRpZiAoJCh0aGlzKS5oYXNDbGFzcygndGlwc3ktc2lkZScpKSB7XG5cdFx0XHRcdFx0cmV0dXJuICQodGhpcykub2Zmc2V0KCkubGVmdCA+ICQoZG9jdW1lbnQpLnNjcm9sbExlZnQoKSArICQod2luZG93KS53aWR0aCgpIC8gMlxuXHRcdFx0XHRcdFx0PyAnZSdcblx0XHRcdFx0XHRcdDogJ3cnO1xuXHRcdFx0XHR9XG5cdFx0XHRcdHJldHVybiAkKHRoaXMpLm9mZnNldCgpLnRvcCA8ICQoZG9jdW1lbnQpLnNjcm9sbFRvcCgpICsgJCh3aW5kb3cpLmhlaWdodCgpIC8gMlxuXHRcdFx0XHRcdD8gJ24nXG5cdFx0XHRcdFx0OiAncyc7XG5cdFx0XHR9O1xuXG5cdFx0XHQkKGQyMC50ZXh0Y2hhdC5jaGlsZFdpbmRvdy5kb2N1bWVudC5ib2R5KVxuXHRcdFx0XHQuZmluZCgnLnNob3d0aXAnKVxuXHRcdFx0XHQudGlwc3koe1xuXHRcdFx0XHRcdGxpdmU6IHRydWUsXG5cdFx0XHRcdFx0Z3Jhdml0eTogYXV0b0dyYXYsXG5cdFx0XHRcdFx0b3BhY2l0eTogMC41LFxuXHRcdFx0XHRcdGh0bWw6IHRydWUsXG5cdFx0XHRcdFx0Y29udGFpbmVyZWw6ICQoZDIwLnRleHRjaGF0LmNoaWxkV2luZG93LmRvY3VtZW50LmJvZHkpLFxuXHRcdFx0XHR9KTtcblx0XHRcdCQoZDIwLnRleHRjaGF0LmNoaWxkV2luZG93LmRvY3VtZW50LmJvZHkpXG5cdFx0XHRcdC5maW5kKCcudXNlcnNjcmlwdC1zaG93dGlwJylcblx0XHRcdFx0LnRpcHN5KHtcblx0XHRcdFx0XHRsaXZlOiB0cnVlLFxuXHRcdFx0XHRcdGdyYXZpdHk6IGF1dG9HcmF2LFxuXHRcdFx0XHRcdG9wYWNpdHk6IDEuMCxcblx0XHRcdFx0XHRodG1sOiB0cnVlLFxuXHRcdFx0XHRcdGZpbHRlcmh0bWw6IHRydWUsXG5cdFx0XHRcdFx0dXNlcnNjcmlwdDogdHJ1ZSxcblx0XHRcdFx0XHRjb250YWluZXJlbDogJChkMjAudGV4dGNoYXQuY2hpbGRXaW5kb3cuZG9jdW1lbnQuYm9keSksXG5cdFx0XHRcdH0pO1xuXHRcdFx0cG9wb3V0V2luZG93SXNGb2N1c2VkID0gdHJ1ZTtcblxuXHRcdFx0JChkMjAudGV4dGNoYXQuY2hpbGRXaW5kb3cuZG9jdW1lbnQpLm9uKFxuXHRcdFx0XHQnY2xpY2snLFxuXHRcdFx0XHQnYScsXG5cdFx0XHRcdGQyMC51dGlscy5oYW5kbGVVUkwsXG5cdFx0XHQpO1xuXG5cdFx0XHRpZiAod2luZG93LmxvY2FsU3RvcmFnZS5nZXRJdGVtKCdjb2xvclRoZW1lJykgPT09ICdkYXJrJykge1xuXHRcdFx0XHQkKGQyMC50ZXh0Y2hhdC5jaGlsZFdpbmRvdy5kb2N1bWVudC5ib2R5KS5hcHBlbmQoY3JlYXRlRGFya01vZGVDU1MoKSk7XG5cdFx0XHR9XG5cdFx0fTtcblxuXHRcdGQyMC50ZXh0Y2hhdC5jaGlsZFdpbmRvdy5vbmJlZm9yZXVubG9hZCA9IGZ1bmN0aW9uICgpIHtcblx0XHRcdHRleHRjaGF0cG9wcGVkID0gZmFsc2U7XG5cdFx0XHRzZXRUaW1lb3V0KCgpID0+IHtcblx0XHRcdFx0JCgnI3JpZ2h0c2lkZWJhcicpXG5cdFx0XHRcdFx0LmZpbmQoJ2FbaHJlZj0jdGV4dGNoYXRdJylcblx0XHRcdFx0XHQudHJpZ2dlcignY2xpY2snKTtcblx0XHRcdH0sIDEwMCk7XG5cdFx0XHQkdGFyZ2V0ZWwuYXBwZW5kVG8oJHByZXZkaWFsb2cpO1xuXHRcdFx0JGlucHV0ZWwuYXBwZW5kVG8oJCgnYm9keScpKTtcblx0XHRcdGQyMC50ZXh0Y2hhdC4kdGV4dGFyZWEuYXV0b2NvbXBsZXRlKCd3aWRnZXQnKS5hcHBlbmRUbygkKCdib2R5JykpO1xuXHRcdFx0JHRhcmdldGVsLnNjcm9sbFRvcCgkdGFyZ2V0ZWxbMF0uc2Nyb2xsSGVpZ2h0KTtcblx0XHRcdHdpbmRvdy5hbGxDaGlsZFdpbmRvd3MgPSBfLndpdGhvdXQoXG5cdFx0XHRcdHdpbmRvdy5hbGxDaGlsZFdpbmRvd3MsXG5cdFx0XHRcdGQyMC50ZXh0Y2hhdC5jaGlsZFdpbmRvdyxcblx0XHRcdCk7XG5cdFx0XHRwb3BvdXRXaW5kb3dJc0ZvY3VzZWQgPSBmYWxzZTtcblx0XHRcdGQyMC50ZXh0Y2hhdC5jaGlsZFdpbmRvdyA9IG51bGw7XG5cdFx0fTtcblxuXHRcdCQoZDIwLnRleHRjaGF0LmNoaWxkV2luZG93KS5iaW5kKCdmb2N1cycsICgpID0+IHtcblx0XHRcdHBvcG91dFdpbmRvd0lzRm9jdXNlZCA9IHRydWU7XG5cdFx0fSk7XG5cblx0XHQkKGQyMC50ZXh0Y2hhdC5jaGlsZFdpbmRvdykuYmluZCgnYmx1cicsICgpID0+IHtcblx0XHRcdHBvcG91dFdpbmRvd0lzRm9jdXNlZCA9IGZhbHNlO1xuXHRcdH0pO1xuXHR9O1xuXG5cdCQoJyN0ZXh0Y2hhdHRhYicpLm9uKCdkYmxjbGljaycsICgpID0+IHtcblx0XHRkMjAudGV4dGNoYXQuc2hvd1BvcG91dCgpO1xuXHR9KTtcblxuXHQkKCcjcmlnaHRzaWRlYmFyJykucmVzaXphYmxlKHtcblx0XHRoYW5kbGVzOiAndycsXG5cdFx0YWxzb1Jlc2l6ZTogJyN0ZXh0Y2hhdC1pbnB1dCwgI3JpZ2h0c2lkZWJhciAudGFibWVudScsXG5cdFx0bWluV2lkdGg6IDMwMCxcblx0XHRzdGFydCgpIHtcblx0XHRcdCQoJyNlZGl0b3Itd3JhcHBlciwgI2NhbnZhcy1vdmVybGF5JykuYWRkQ2xhc3MoJ25vc2hvdycpO1xuXHRcdH0sXG5cdFx0cmVzaXplKCkge30sXG5cdFx0c3RvcCgpIHtcblx0XHRcdCQoJyNlZGl0b3Itd3JhcHBlciwgI2NhbnZhcy1vdmVybGF5JykucmVtb3ZlQ2xhc3MoJ25vc2hvdycpO1xuXHRcdFx0JCh3aW5kb3cpLnRyaWdnZXIoJ3Jlc2l6ZScpO1xuXHRcdFx0JCgnI3JpZ2h0c2lkZWJhcicpXG5cdFx0XHRcdC5jc3MoJ2xlZnQnLCAnJylcblx0XHRcdFx0LmNzcygnaGVpZ2h0JywgJzEwMCUnKTtcblx0XHR9LFxuXHR9KTtcbn0pO1xuXG4vLyBCdWlsZHMgdGhlIGZ1bmN0aW9ucyB0aGF0IGdvIGludG8gdGhlIHRlbXBsYXRldmlldyBvYmplY3QsIHN1Y2ggYXMgcm9sbFRvdGFsIG9yIHJvbGxHcmVhdGVyXG5kMjAudGV4dGNoYXQuYnVpbGRSb2xsVGVtcGxhdGVWaWV3T2JqID0gKHRlbXBsYXRldmlldywgb3ApID0+IHtcblx0Y29uc3QgdGVtcGxhdGVwcm9wc3JlZyA9IC97eyhbXFxzXFxTXSo/fT8pfX0vZ2k7XG5cdGxldCB0bWF0Y2g7XG5cblx0d2hpbGUgKCh0bWF0Y2ggPSB0ZW1wbGF0ZXByb3BzcmVnLmV4ZWMob3AuY29udGVudCkpICE9IG51bGwpIHtcblx0XHRjb25zdCB2YWx1ZWRlZiA9IGAke3RtYXRjaFsxXX1gO1xuXHRcdGNvbnN0IHZkc3BsaXQgPSB2YWx1ZWRlZi5zcGxpdCgnPScpO1xuXHRcdGNvbnN0IHZhbHVlID0gdmFsdWVkZWYuc3Vic3RyaW5nKHZkc3BsaXRbMF0ubGVuZ3RoICsgMSwgdmFsdWVkZWYubGVuZ3RoKTtcblxuXHRcdGlmICh0bWF0Y2guaW5kZXggPT09IHRlbXBsYXRlcHJvcHNyZWcubGFzdEluZGV4KSB7XG5cdFx0XHR0ZW1wbGF0ZXByb3BzcmVnLmxhc3RJbmRleCsrO1xuXHRcdH1cblxuXHRcdHRlbXBsYXRldmlld1t2ZHNwbGl0WzBdXSA9IHZhbHVlO1xuXHRcdC8vIElmIHRoaXMgdmFyaWFibGUgaXMgYSByb2xsLCB3ZSBuZWVkIHRvIGFkZCBhIHNlcGFyYXRlIGVudHJ5IGZvciB0aGUgcG90ZW50aWFsIGNvbXB1dGVkIHZhbHVlXG5cdFx0aWYgKHZhbHVlLm1hdGNoKC9cXCRcXFtcXFtcXGQrXFxdXFxdLykpIHtcblx0XHRcdHRlbXBsYXRldmlld1tgY29tcHV0ZWQ6OiR7dmRzcGxpdFswXX1gXSA9IHZhbHVlLnJlcGxhY2UoJ11dJywgJy5jb21wdXRlZF1dJyk7XG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIHRlbXBsYXRldmlldztcbn07XG5cbi8vIEhhbmRsZXMgdGhlIHRyYW5zbGF0aW9uIHN0cmluZ3MgaW4gYSByb2xsdGVtcGxhdGVcbmQyMC50ZXh0Y2hhdC5oYW5kbGVUZW1wbGF0ZVZpZXdUcmFuc2xhdGlvbnMgPSAodGVtcGxhdGV2aWV3KSA9PiB7XG5cdCQuZWFjaCh0ZW1wbGF0ZXZpZXcsIChrZXksIHZhbHVlKSA9PiB7XG5cdFx0aWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ3N0cmluZycpIHJldHVybjtcblxuXHRcdHRlbXBsYXRldmlld1trZXldID0gdmFsdWUucmVwbGFjZSgvXFxeeyhbXn1dKyl9L2csIChtYXRjaCwgaTE4bktleSkgPT4ge1xuXHRcdFx0aTE4bktleSA9ICQudHJpbShpMThuS2V5KTtcblx0XHRcdHJldHVybiBpMThuKGkxOG5LZXksIGA8c3BhbiBzdHlsZT1cImNvbG9yOiByZWQ7XCI+WyR7aTE4bktleX1dPC9zcGFuPmApO1xuXHRcdH0pO1xuXG5cdFx0Y29uc3QgbmV3S2V5ID0ga2V5LnJlcGxhY2UoL1xcXnsoW159XSspfS9nLCAobWF0Y2gsIGkxOG5LZXkpID0+IHtcblx0XHRcdGkxOG5LZXkgPSAkLnRyaW0oaTE4bktleSk7XG5cdFx0XHRyZXR1cm4gaTE4bihpMThuS2V5LCBgWyR7aTE4bktleX1dYCk7XG5cdFx0fSk7XG5cblx0XHRpZiAobmV3S2V5ICE9PSBrZXkpIHtcblx0XHRcdHRlbXBsYXRldmlld1tuZXdLZXldID0gdGVtcGxhdGV2aWV3W2tleV07XG5cdFx0XHRkZWxldGUgdGVtcGxhdGV2aWV3W2tleV07XG5cdFx0fVxuXHR9KTtcblxuXHRyZXR1cm4gdGVtcGxhdGV2aWV3O1xufTtcblxuZDIwLnRleHRjaGF0LmJ1aWxkUm9sbFRlbXBsYXRlVmlld0Z1bmN0aW9ucyA9ICh0ZW1wbGF0ZXZpZXcsIG9wKSA9PiB7XG5cdGNvbnN0IHZhbGlkYXRlUm9sbE5hbWUgPSAocm9sbG5hbWUpID0+IHtcblx0XHRpZiAoXG5cdFx0XHR0ZW1wbGF0ZXZpZXdbcm9sbG5hbWVdICE9PSB1bmRlZmluZWRcblx0XHRcdCYmIHR5cGVvZiB0ZW1wbGF0ZXZpZXdbcm9sbG5hbWVdID09PSAnc3RyaW5nJ1xuXHRcdCkge1xuXHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0fVxuXHRcdHJldHVybiBmYWxzZTtcblx0fTtcblxuXHQvLyBQYXJzZXMgc3RyaW5nIHRvIGZpbmQgaW5kZXggb2Ygd2hpY2ggcm9sbCB0byB1c2UgaW4gcm9sbCBvYmplY3Rcblx0Y29uc3QgZmluZFJvbGxOdW0gPSAocm9sbG5hbWUpID0+IHtcblx0XHRjb25zdCBhZGp1c3RlZFJvbGxOYW1lID0gcm9sbG5hbWUucmVwbGFjZSgnY29tcHV0ZWQ6OicsICcnKTtcblx0XHRpZiAodmFsaWRhdGVSb2xsTmFtZShhZGp1c3RlZFJvbGxOYW1lKSkge1xuXHRcdFx0aWYgKHRlbXBsYXRldmlld1thZGp1c3RlZFJvbGxOYW1lXS5pbmNsdWRlcygnJFtbJykgPT09IHRydWUpIHtcblx0XHRcdFx0cmV0dXJuIHRlbXBsYXRldmlld1thZGp1c3RlZFJvbGxOYW1lXS5zcGxpdCgnJFtbJylbMV0uc3BsaXQoJ11dJylbMF07XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gdGVtcGxhdGV2aWV3W2FkanVzdGVkUm9sbE5hbWVdO1xuXHRcdH1cblx0XHRyZXR1cm4gbnVsbDtcblx0fTtcblxuXHQvLyBGaW5kcyB0aGUgdG90YWwgcmVzdWx0IG9mIGEgcm9sbCB5b3UgYXJlIGxvb2tpbmcgZm9yXG5cdGNvbnN0IGZpbmRMb29raW5nRm9yVG90YWwgPSAoYXJnKSA9PiB7XG5cdFx0bGV0IGxvb2tpbmdGb3IgPSBhcmc7XG5cblx0XHRpZiAoXG5cdFx0XHRsb29raW5nRm9yICE9PSB1bmRlZmluZWRcblx0XHRcdCYmIGlzTmFOKGxvb2tpbmdGb3IpXG5cdFx0KSB7XG5cdFx0XHQvLyBQYXJzZXMgc3RyaW5nIHRvIGZpbmQgaW5kZXggaW4gaW5saW5lIHJvbGxzIG9iamVjdCBhbmQgZmluZCBhc3NvY2lhdGVkIHJvbGxcblx0XHRcdC8vIElmIGl0J3MgYSBjb21wdXRlZCBhcmcsIHdlIHVzZSB0aGUgY29tcHV0ZWQgcHJvcGVydHlcblx0XHRcdGlmIChhcmcuc3Vic3RyaW5nKDAsIDEwKSA9PT0gJ2NvbXB1dGVkOjonKSB7XG5cdFx0XHRcdGNvbnN0IHJvbGwgPSBvcC5pbmxpbmVyb2xsc1tmaW5kUm9sbE51bShhcmcpXTtcblxuXHRcdFx0XHRsb29raW5nRm9yID0gcm9sbD8uY29tcHV0ZWQ7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRjb25zdCByb2xsID0gb3AuaW5saW5lcm9sbHNbdGVtcGxhdGV2aWV3W2xvb2tpbmdGb3JdLnNwbGl0KCckW1snKVsxXS5zcGxpdCgnXV0nKVswXV07XG5cblx0XHRcdFx0bG9va2luZ0ZvciA9IHJvbGwucmVzdWx0cy50b3RhbDtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gbG9va2luZ0Zvcjtcblx0fTtcblxuXHRjb25zdCBmaW5kQ29tcGFyZVZhbHVlID0gKHJvbGxuYW1lLCBpbmxpbmVyb2xsKSA9PiB7XG5cdFx0aWYgKHJvbGxuYW1lLnN1YnN0cmluZygwLCAxMCkgPT09ICdjb21wdXRlZDo6JyAmJiBpbmxpbmVyb2xsLmNvbXB1dGVkICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdHJldHVybiBwYXJzZUludChpbmxpbmVyb2xsLmNvbXB1dGVkLCAxMCk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHBhcnNlSW50KGlubGluZXJvbGwucmVzdWx0cy50b3RhbCwgMTApO1xuXHR9O1xuXG5cdGNvbnN0IGNoZWNrQ3JpdE9yRnVtYmxlID0gKHJvbGxuYW1lLCB0eXBlID0gJ2NyaXQnKSA9PiB7XG5cdFx0Y29uc3Qgcm9sbG51bSA9IGZpbmRSb2xsTnVtKHJvbGxuYW1lKTtcblx0XHRpZiAob3AuaW5saW5lcm9sbHNbcm9sbG51bV0pIHtcblx0XHRcdHJldHVybiBkMjAuZGljZV9mb3JtYXR0ZXIuY2hlY2tGb3JDcml0cyhvcC5pbmxpbmVyb2xsc1tyb2xsbnVtXS5yZXN1bHRzLnJvbGxzLCB0eXBlKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gZmFsc2U7XG5cdH07XG5cblx0Y29uc3QgY2hlY2tFcXVhbGl0eSA9IChyb2xsbmFtZSwgbG9va2luZ0ZvclRvdGFsKSA9PiB7XG5cdFx0Y29uc3Qgcm9sbG51bSA9IGZpbmRSb2xsTnVtKHJvbGxuYW1lKTtcblx0XHRjb25zdCBpbmxpbmVyb2xsbnVtID0gb3AuaW5saW5lcm9sbHNbcm9sbG51bV07XG5cdFx0Y29uc3QgcGFyc2VMb29raW5nRm9yVG90YWwgPSBwYXJzZUludChsb29raW5nRm9yVG90YWwsIDEwKTtcblx0XHRjb25zdCBjb21wYXJlVmFsdWUgPSBmaW5kQ29tcGFyZVZhbHVlKHJvbGxuYW1lLCBpbmxpbmVyb2xsbnVtKTtcblxuXHRcdGlmIChpbmxpbmVyb2xsbnVtKSB7XG5cdFx0XHRyZXR1cm4gY29tcGFyZVZhbHVlID09PSBwYXJzZUxvb2tpbmdGb3JUb3RhbDtcblx0XHR9XG5cblx0XHRyZXR1cm4gZmFsc2U7XG5cdH07XG5cblx0Y29uc3QgY2hlY2tSb2xsR3JlYXRlciA9IChyb2xsbmFtZSwgbG9va2luZ0ZvclRvdGFsKSA9PiB7XG5cdFx0Y29uc3Qgcm9sbG51bSA9IGZpbmRSb2xsTnVtKHJvbGxuYW1lKTtcblx0XHRjb25zdCBpbmxpbmVyb2xsbnVtID0gb3AuaW5saW5lcm9sbHNbcm9sbG51bV07XG5cdFx0Y29uc3QgcGFyc2VMb29raW5nRm9yVG90YWwgPSBwYXJzZUludChsb29raW5nRm9yVG90YWwsIDEwKTtcblx0XHRjb25zdCBjb21wYXJlVmFsdWUgPSBmaW5kQ29tcGFyZVZhbHVlKHJvbGxuYW1lLCBpbmxpbmVyb2xsbnVtKTtcblxuXHRcdGlmIChpbmxpbmVyb2xsbnVtKSB7XG5cdFx0XHRyZXR1cm4gY29tcGFyZVZhbHVlID4gcGFyc2VMb29raW5nRm9yVG90YWw7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGZhbHNlO1xuXHR9O1xuXG5cdGNvbnN0IGNoZWNrUm9sbExlc3MgPSAocm9sbG5hbWUsIGxvb2tpbmdGb3JUb3RhbCkgPT4ge1xuXHRcdGNvbnN0IHJvbGxudW0gPSBmaW5kUm9sbE51bShyb2xsbmFtZSk7XG5cdFx0Y29uc3QgaW5saW5lcm9sbG51bSA9IG9wLmlubGluZXJvbGxzW3JvbGxudW1dO1xuXHRcdGNvbnN0IHBhcnNlTG9va2luZ0ZvclRvdGFsID0gcGFyc2VJbnQobG9va2luZ0ZvclRvdGFsLCAxMCk7XG5cdFx0Y29uc3QgY29tcGFyZVZhbHVlID0gZmluZENvbXBhcmVWYWx1ZShyb2xsbmFtZSwgaW5saW5lcm9sbG51bSk7XG5cblx0XHRpZiAoaW5saW5lcm9sbG51bSkge1xuXHRcdFx0cmV0dXJuIGNvbXBhcmVWYWx1ZSA8IHBhcnNlTG9va2luZ0ZvclRvdGFsO1xuXHRcdH1cblxuXHRcdHJldHVybiBmYWxzZTtcblx0fTtcblxuXHRjb25zdCBjaGVja0JldHdlZW4gPSAocm9sbG5hbWUsIGxvb2tpbmdGb3JUb3RhbCwgbG9va2luZ0ZvclRvdGFsMikgPT4ge1xuXHRcdGNvbnN0IHJvbGxudW0gPSBmaW5kUm9sbE51bShyb2xsbmFtZSk7XG5cdFx0Y29uc3QgaW5saW5lcm9sbG51bSA9IG9wLmlubGluZXJvbGxzW3JvbGxudW1dO1xuXHRcdGNvbnN0IHBhcnNlTG9va2luZ0ZvclRvdGFsID0gcGFyc2VJbnQobG9va2luZ0ZvclRvdGFsLCAxMCk7XG5cdFx0Y29uc3QgcGFyc2VMb29raW5nRm9yVG90YWwyID0gcGFyc2VJbnQobG9va2luZ0ZvclRvdGFsMiwgMTApO1xuXHRcdGNvbnN0IGNvbXBhcmVWYWx1ZSA9IGZpbmRDb21wYXJlVmFsdWUocm9sbG5hbWUsIGlubGluZXJvbGxudW0pO1xuXG5cdFx0aWYgKGlubGluZXJvbGxudW0pIHtcblx0XHRcdGlmIChcblx0XHRcdFx0Y29tcGFyZVZhbHVlID49IHBhcnNlTG9va2luZ0ZvclRvdGFsXG5cdFx0XHRcdCYmIGNvbXBhcmVWYWx1ZSA8PSBwYXJzZUxvb2tpbmdGb3JUb3RhbDJcblx0XHRcdCkge1xuXHRcdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHRcdH1cblx0XHRcdHJldHVybiBmYWxzZTtcblx0XHR9XG5cblx0XHRyZXR1cm4gZmFsc2U7XG5cdH07XG5cblx0dGVtcGxhdGV2aWV3Wydyb2xsV2FzQ3JpdCgpJ10gPSBmdW5jdGlvbiAoKSB7XG5cdFx0cmV0dXJuIGZ1bmN0aW9uICh0bXBsdGV4dCwgcmVuZGVyZnVuYywgYXJncykge1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0Y29uc3Qgcm9sbG5hbWUgPSBhcmdzLmpvaW4oJyAnKTtcblx0XHRcdFx0cmV0dXJuIGNoZWNrQ3JpdE9yRnVtYmxlKHJvbGxuYW1lLCAnY3JpdCcpID8gcmVuZGVyZnVuYyh0bXBsdGV4dCkgOiBudWxsO1xuXHRcdFx0fSBjYXRjaCAoZSkge1xuXHRcdFx0XHRyZXR1cm4gbnVsbDtcblx0XHRcdH1cblx0XHR9O1xuXHR9O1xuXG5cdHRlbXBsYXRldmlld1snXnJvbGxXYXNDcml0KCknXSA9IGZ1bmN0aW9uICgpIHtcblx0XHRyZXR1cm4gZnVuY3Rpb24gKHRtcGx0ZXh0LCByZW5kZXJmdW5jLCBhcmdzKSB7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRjb25zdCByb2xsbmFtZSA9IGFyZ3Muam9pbignICcpO1xuXHRcdFx0XHRyZXR1cm4gY2hlY2tDcml0T3JGdW1ibGUocm9sbG5hbWUsICdjcml0JykgPyBudWxsIDogcmVuZGVyZnVuYyh0bXBsdGV4dCk7XG5cdFx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRcdHJldHVybiBudWxsO1xuXHRcdFx0fVxuXHRcdH07XG5cdH07XG5cblx0dGVtcGxhdGV2aWV3Wydyb2xsV2FzRnVtYmxlKCknXSA9IGZ1bmN0aW9uICgpIHtcblx0XHRyZXR1cm4gZnVuY3Rpb24gKHRtcGx0ZXh0LCByZW5kZXJmdW5jLCBhcmdzKSB7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRjb25zdCByb2xsbmFtZSA9IGFyZ3Muam9pbignICcpO1xuXHRcdFx0XHRyZXR1cm4gY2hlY2tDcml0T3JGdW1ibGUocm9sbG5hbWUsICdmdW1ibGUnKSA/IHJlbmRlcmZ1bmModG1wbHRleHQpIDogbnVsbDtcblx0XHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0XHR9XG5cdFx0fTtcblx0fTtcblxuXHR0ZW1wbGF0ZXZpZXdbJ15yb2xsV2FzRnVtYmxlKCknXSA9IGZ1bmN0aW9uICgpIHtcblx0XHRyZXR1cm4gZnVuY3Rpb24gKHRtcGx0ZXh0LCByZW5kZXJmdW5jLCBhcmdzKSB7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRjb25zdCByb2xsbmFtZSA9IGFyZ3Muam9pbignICcpO1xuXHRcdFx0XHRyZXR1cm4gY2hlY2tDcml0T3JGdW1ibGUocm9sbG5hbWUsICdmdW1ibGUnKSA/IG51bGwgOiByZW5kZXJmdW5jKHRtcGx0ZXh0KTtcblx0XHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0XHR9XG5cdFx0fTtcblx0fTtcblxuXHR0ZW1wbGF0ZXZpZXdbJ3JvbGxUb3RhbCgpJ10gPSBmdW5jdGlvbiAoKSB7XG5cdFx0Ly8gTm90ZTogYXNzdW1lcyByb2xsIG5hbWUgZG9lc24ndCBjb250YWluIHNwYWNlcy5cblx0XHRyZXR1cm4gZnVuY3Rpb24gKHRtcGx0ZXh0LCByZW5kZXJmdW5jLCBhcmdzKSB7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRjb25zdCByb2xsbmFtZSA9IGFyZ3NbMF07XG5cdFx0XHRcdGNvbnN0IGxvb2tpbmdGb3JUb3RhbCA9IGZpbmRMb29raW5nRm9yVG90YWwoYXJnc1sxXSk7XG5cdFx0XHRcdHJldHVybiBjaGVja0VxdWFsaXR5KHJvbGxuYW1lLCBsb29raW5nRm9yVG90YWwpID8gcmVuZGVyZnVuYyh0bXBsdGV4dCkgOiBudWxsO1xuXHRcdFx0fSBjYXRjaCAoZSkge1xuXHRcdFx0XHRyZXR1cm4gbnVsbDtcblx0XHRcdH1cblx0XHR9O1xuXHR9O1xuXG5cdHRlbXBsYXRldmlld1snXnJvbGxUb3RhbCgpJ10gPSBmdW5jdGlvbiAoKSB7XG5cdFx0cmV0dXJuIGZ1bmN0aW9uICh0bXBsdGV4dCwgcmVuZGVyZnVuYywgYXJncykge1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0Y29uc3Qgcm9sbG5hbWUgPSBhcmdzWzBdO1xuXHRcdFx0XHRjb25zdCBsb29raW5nRm9yVG90YWwgPSBmaW5kTG9va2luZ0ZvclRvdGFsKGFyZ3NbMV0pO1xuXHRcdFx0XHRyZXR1cm4gY2hlY2tFcXVhbGl0eShyb2xsbmFtZSwgbG9va2luZ0ZvclRvdGFsKSA/IG51bGwgOiByZW5kZXJmdW5jKHRtcGx0ZXh0KTtcblx0XHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0XHR9XG5cdFx0fTtcblx0fTtcblxuXHR0ZW1wbGF0ZXZpZXdbJ3JvbGxHcmVhdGVyKCknXSA9IGZ1bmN0aW9uICgpIHtcblx0XHRyZXR1cm4gZnVuY3Rpb24gKHRtcGx0ZXh0LCByZW5kZXJmdW5jLCBhcmdzKSB7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRjb25zdCByb2xsbmFtZSA9IGFyZ3NbMF07XG5cdFx0XHRcdGNvbnN0IGxvb2tpbmdGb3JUb3RhbCA9IGZpbmRMb29raW5nRm9yVG90YWwoYXJnc1sxXSk7XG5cdFx0XHRcdHJldHVybiBjaGVja1JvbGxHcmVhdGVyKHJvbGxuYW1lLCBsb29raW5nRm9yVG90YWwpID8gcmVuZGVyZnVuYyh0bXBsdGV4dCkgOiBudWxsO1xuXHRcdFx0fSBjYXRjaCAoZSkge1xuXHRcdFx0XHRyZXR1cm4gbnVsbDtcblx0XHRcdH1cblx0XHR9O1xuXHR9O1xuXG5cdHRlbXBsYXRldmlld1snXnJvbGxHcmVhdGVyKCknXSA9IGZ1bmN0aW9uICgpIHtcblx0XHRyZXR1cm4gZnVuY3Rpb24gKHRtcGx0ZXh0LCByZW5kZXJmdW5jLCBhcmdzKSB7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRjb25zdCByb2xsbmFtZSA9IGFyZ3NbMF07XG5cdFx0XHRcdGNvbnN0IGxvb2tpbmdGb3JUb3RhbCA9IGZpbmRMb29raW5nRm9yVG90YWwoYXJnc1sxXSk7XG5cdFx0XHRcdHJldHVybiBjaGVja1JvbGxHcmVhdGVyKHJvbGxuYW1lLCBsb29raW5nRm9yVG90YWwpID8gbnVsbCA6IHJlbmRlcmZ1bmModG1wbHRleHQpO1xuXHRcdFx0fSBjYXRjaCAoZSkge1xuXHRcdFx0XHRyZXR1cm4gbnVsbDtcblx0XHRcdH1cblx0XHR9O1xuXHR9O1xuXG5cdHRlbXBsYXRldmlld1sncm9sbExlc3MoKSddID0gZnVuY3Rpb24gKCkge1xuXHRcdHJldHVybiBmdW5jdGlvbiAodG1wbHRleHQsIHJlbmRlcmZ1bmMsIGFyZ3MpIHtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdGNvbnN0IHJvbGxuYW1lID0gYXJnc1swXTtcblx0XHRcdFx0Y29uc3QgbG9va2luZ0ZvclRvdGFsID0gZmluZExvb2tpbmdGb3JUb3RhbChhcmdzWzFdKTtcblx0XHRcdFx0cmV0dXJuIGNoZWNrUm9sbExlc3Mocm9sbG5hbWUsIGxvb2tpbmdGb3JUb3RhbCkgPyByZW5kZXJmdW5jKHRtcGx0ZXh0KSA6IG51bGw7XG5cdFx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRcdHJldHVybiBudWxsO1xuXHRcdFx0fVxuXHRcdH07XG5cdH07XG5cblx0dGVtcGxhdGV2aWV3Wydecm9sbExlc3MoKSddID0gZnVuY3Rpb24gKCkge1xuXHRcdHJldHVybiBmdW5jdGlvbiAodG1wbHRleHQsIHJlbmRlcmZ1bmMsIGFyZ3MpIHtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdGNvbnN0IHJvbGxuYW1lID0gYXJnc1swXTtcblx0XHRcdFx0Y29uc3QgbG9va2luZ0ZvclRvdGFsID0gZmluZExvb2tpbmdGb3JUb3RhbChhcmdzWzFdKTtcblx0XHRcdFx0cmV0dXJuIGNoZWNrUm9sbExlc3Mocm9sbG5hbWUsIGxvb2tpbmdGb3JUb3RhbCkgPyBudWxsIDogcmVuZGVyZnVuYyh0bXBsdGV4dCk7XG5cdFx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRcdHJldHVybiBudWxsO1xuXHRcdFx0fVxuXHRcdH07XG5cdH07XG5cblx0dGVtcGxhdGV2aWV3Wydyb2xsQmV0d2VlbigpJ10gPSBmdW5jdGlvbiAoKSB7XG5cdFx0cmV0dXJuIGZ1bmN0aW9uICh0bXBsdGV4dCwgcmVuZGVyZnVuYywgYXJncykge1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0Y29uc3Qgcm9sbG5hbWUgPSBhcmdzWzBdO1xuXHRcdFx0XHRjb25zdCBsb29raW5nRm9yVG90YWwgPSBmaW5kTG9va2luZ0ZvclRvdGFsKGFyZ3NbMV0pO1xuXHRcdFx0XHRjb25zdCBsb29raW5nRm9yVG90YWwyID0gZmluZExvb2tpbmdGb3JUb3RhbChhcmdzWzJdKTtcblx0XHRcdFx0cmV0dXJuIGNoZWNrQmV0d2Vlbihyb2xsbmFtZSwgbG9va2luZ0ZvclRvdGFsLCBsb29raW5nRm9yVG90YWwyKSA/IHJlbmRlcmZ1bmModG1wbHRleHQpIDogbnVsbDtcblx0XHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0XHR9XG5cdFx0fTtcblx0fTtcblxuXHR0ZW1wbGF0ZXZpZXdbJ15yb2xsQmV0d2VlbigpJ10gPSBmdW5jdGlvbiAoKSB7XG5cdFx0cmV0dXJuIGZ1bmN0aW9uICh0bXBsdGV4dCwgcmVuZGVyZnVuYywgYXJncykge1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0Y29uc3Qgcm9sbG5hbWUgPSBhcmdzWzBdO1xuXHRcdFx0XHRjb25zdCBsb29raW5nRm9yVG90YWwgPSBmaW5kTG9va2luZ0ZvclRvdGFsKGFyZ3NbMV0pO1xuXHRcdFx0XHRjb25zdCBsb29raW5nRm9yVG90YWwyID0gZmluZExvb2tpbmdGb3JUb3RhbChhcmdzWzJdKTtcblx0XHRcdFx0cmV0dXJuIGNoZWNrQmV0d2Vlbihyb2xsbmFtZSwgbG9va2luZ0ZvclRvdGFsLCBsb29raW5nRm9yVG90YWwyKSA/IG51bGwgOiByZW5kZXJmdW5jKHRtcGx0ZXh0KTtcblx0XHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0XHR9XG5cdFx0fTtcblx0fTtcblxuXHR0ZW1wbGF0ZXZpZXdbJ2FsbHByb3BzKCknXSA9IGZ1bmN0aW9uICgpIHtcblx0XHRyZXR1cm4gZnVuY3Rpb24gKHRtcGx0ZXh0LCByZW5kZXJmdW5jLCBhcmdzKSB7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRsZXQgZnVsbHN0cmluZyA9ICcnO1xuXG5cdFx0XHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBndWFyZC1mb3ItaW5cblx0XHRcdFx0Zm9yIChjb25zdCB0a2V5IGluIHRlbXBsYXRldmlldykge1xuXHRcdFx0XHRcdGlmICh0a2V5ID09PSAnbmFtZScgfHwgYXJncy5pbmRleE9mKHRrZXkpICE9PSAtMSB8fCB0a2V5Lm1hdGNoKC9eY29tcHV0ZWQ6Oi4rLykpIGNvbnRpbnVlO1xuXHRcdFx0XHRcdGlmICh0eXBlb2YgdGVtcGxhdGV2aWV3W3RrZXldID09PSAnZnVuY3Rpb24nKSBjb250aW51ZTtcblxuXHRcdFx0XHRcdGZ1bGxzdHJpbmcgKz0gcmVuZGVyZnVuYyh0bXBsdGV4dC5yZXBsYWNlKCd7e2tleX19JywgdWNmaXJzdCh0a2V5KSkucmVwbGFjZSgne3t2YWx1ZX19JywgdGVtcGxhdGV2aWV3W3RrZXldKSk7XG5cdFx0XHRcdH1cblx0XHRcdFx0cmV0dXJuIGZ1bGxzdHJpbmc7XG5cdFx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRcdGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGVudW1lcmF0aW5nIGFsbCBwcm9wZXJ0aWVzJyk7XG5cdFx0XHRcdGNvbnNvbGUubG9nKGUpO1xuXHRcdFx0fVxuXHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0fTtcblx0fTtcblxuXHRyZXR1cm4gdGVtcGxhdGV2aWV3O1xufTtcblxuZDIwLnRleHRjaGF0LmJ1aWxkUm9sbFRlbXBsYXRlSHRtbCA9IChvcCkgPT4ge1xuXHRjb25zdCB7IGpvdXJuYWwgfSA9IGQyMDtcblx0Y29uc3QgJG15cm9sbHRlbXBsYXRlID0gJChgI3NoZWV0LXJvbGx0ZW1wbGF0ZS0ke29wLnJvbGx0ZW1wbGF0ZX1gKTtcblxuXHRpZiAoam91cm5hbCAmJiBqb3VybmFsLmN1c3RvbVNoZWV0cyAmJiBqb3VybmFsLmN1c3RvbVNoZWV0cy5yb2xsVGVtcGxhdGVzW29wLnJvbGx0ZW1wbGF0ZV0pIHtcblx0XHRpZiAod2luZG93LmxvY2FsU3RvcmFnZS5nZXRJdGVtKCdjb2xvclRoZW1lJykgPT09ICdkYXJrJykge1xuXHRcdFx0cmV0dXJuIGA8ZGl2IGNsYXNzPSdzaGVldC1yb2xsdGVtcGxhdGUtJHtvcC5yb2xsdGVtcGxhdGV9IHNoZWV0LXJvbGx0ZW1wbGF0ZS1kYXJrbW9kZSc+JHtqb3VybmFsLmN1c3RvbVNoZWV0cy5yb2xsVGVtcGxhdGVzW29wLnJvbGx0ZW1wbGF0ZV19PC9kaXY+YDtcblx0XHR9XG5cdFx0ZWxzZXtcblx0XHRcdHJldHVybiBgPGRpdiBjbGFzcz0nc2hlZXQtcm9sbHRlbXBsYXRlLSR7b3Aucm9sbHRlbXBsYXRlfSc+JHtqb3VybmFsLmN1c3RvbVNoZWV0cy5yb2xsVGVtcGxhdGVzW29wLnJvbGx0ZW1wbGF0ZV19PC9kaXY+YDtcblx0XHR9XG5cdFxuXHR9XG5cblx0aWYgKCRteXJvbGx0ZW1wbGF0ZS5sZW5ndGggPT09IDApIHtcblx0XHRjb25zb2xlLmVycm9yKGBEaWRuJ3QgZmluZCBhIHJvbGwgdGVtcGxhdGUgY2FsbGVkICcke29wLnJvbGx0ZW1wbGF0ZX0nYCk7XG5cdFx0cmV0dXJuICcnO1xuXHR9XG5cblx0cmV0dXJuIGA8ZGl2IGNsYXNzPSckeyRteXJvbGx0ZW1wbGF0ZS5hdHRyKCdpZCcpfSc+JHskbXlyb2xsdGVtcGxhdGUuaHRtbCgpfTwvZGl2PmA7XG59O1xuXG4iXSwibmFtZXMiOltdLCJzb3VyY2VSb290IjoiIn0=