<?!= getContent('html/tamer-profile-template') ?>

<script>

  function show_human(id){
    $("#Human-dropdown-"+ id).tab('show');
  }

  //Overview (front page card) Set Up --------------------------------------------------------------------------------------------------------------------------------------------------------------
  function human_set_up(i){
    var column = document.createElement('div')
    column.setAttribute("class", "col-sm-2")
    column.setAttribute("id", "human-card-" + i.id)

    var card = document.createElement('div')
    card.setAttribute("class", "card shadow-sm tamer_card-"+i.id)

    var card_header = document.createElement('div')
    card_header.setAttribute("class", "title")
    card_header.textContent = i.Name
    card.appendChild(card_header)

    var img_div = document.createElement('div')
    card.appendChild(img_div)

    var img = document.createElement('img')
    img.setAttribute("src", i.Image)
    img.setAttribute("style",
    `height: 100px;
    width: 100px;
    margin: auto;
    border-radius: 100%`)
    img.setAttribute("class", "card-img-top")
    img.setAttribute("onclick", "show_human("+i.id+")")
    img_div.appendChild(img)


    var card_list_group = document.createElement('ul')
    card_list_group.setAttribute("class", "list-group list-group-flush")

    var title_li = document.createElement('li')
    title_li.setAttribute("class", "list-group-item blockquote-footer")
    title_li.innerHTML = `<small>${i.Title}</small>`

    card_list_group.appendChild(title_li)
    card.appendChild(card_list_group)


    column.appendChild(card)

    document.querySelector("#Home-Container").appendChild(column)

  }


  //Profile Page ------------------------------------------------------------------------------------------------------------------------------------------------------------
  function add_tamer(tamer, id){

    //navbar
    var menu_item = document.querySelector("#Human-Menu-item")

    var tamer_dropdown_item = document.createElement('a')
    tamer_dropdown_item.setAttribute("class", "dropdown-item")
    tamer_dropdown_item.setAttribute("href", "#Human-"+tamer.id)
    tamer_dropdown_item.setAttribute("id", "Human-dropdown-"+tamer.id)
    tamer_dropdown_item.setAttribute("data-bs-toggle", "tab")
    tamer_dropdown_item.setAttribute("role", "tab")
    tamer_dropdown_item.innerHTML = tamer.Name

    menu_item.appendChild(tamer_dropdown_item)

    //Page
    var clone = document.querySelector("#tamer-profile-template").cloneNode(true)
    var page = clone.content.querySelectorAll("div")[0]
    //fix ids for tabs

    function fix_tabs(tab_selector, tab_page_selector){
      var tab = page.querySelector("#"+tab_selector)
      var tab_page = page.querySelector("#"+tab_page_selector)

      tab.setAttribute("id", tab_selector+"-"+tamer.id)
      tab_page.setAttribute("id", tab_page_selector+"-"+tamer.id)

      tab.setAttribute("href", "#"+tab_page_selector+"-"+tamer.id)
    }

    fix_tabs('tamer-character-tab', 'Character')
    fix_tabs('tamer-action-tab', 'Actions')
    fix_tabs('tamer-themesong-tab', 'ThemeSongs')
    // fix_tabs('tamer-inventory-tab', 'Inventory')

    //Profile Page Card------------------------------------------------------------------------------------------------------------------------------------------------------------
    var card = page.querySelector('#human-card')
    page.querySelector('.name').textContent = tamer.Name
    page.querySelector('.epitaph').textContent = tamer.Title
    page.querySelector('.experience').textContent = `Campaign Type: ${tamer["Campaign Level"]}`
    page.querySelector('.card-image').src = tamer.Image
    page.querySelector('.card-image').setAttribute("onclick", "show_human("+tamer.id+")")


    //page header
    var info = page.querySelector('.character_info')
    info.innerHTML = `${tamer.Gender} | Age: ${tamer.Age} | Height: ${tamer.Height} | ${tamer["Rewarded XP"]} XP`

    var partner_div = page.querySelector('.partner')
    partner_div.innerHTML = `<a onclick="show_digimon(${tamer["Partner id"]})" >Partner: ${tamer.Partner}</a>`



    // //navbar + content
    // var human_pages = ['Character', 'Actions', 'Inventory', 'Themes', 'Advancement', '123']
    // var human_nav = page.querySelector('#human_nav')
    // var human_nav_pages = page.querySelector('#human_nav_pages')
    // var i = 0
    //
    // human_pages.forEach(x => {
    //   var li_item = document.createElement('li')
    //   li_item.setAttribute('class',  `nav-item`)
    //
    //
    //   var a = document.createElement('a')
    //   a.setAttribute('id',  `tamer-${x}-tab`)
    //   a.setAttribute('class', `nav-link ${i=0 ? "active" : ""}`)
    //   a.setAttribute('href', `#${x}`)
    //   a.setAttribute('data-bs-toggle', 'tab')
    //   a.setAttribute('role', 'tab')
    //   a.innerHTML = x
    //   console.log(human_nav)
    //
    //   li_item.appendChild(a)
    //   human_nav.appendChild(li_item)
    // })




    //character_stats
    character_stats = page.querySelector('.character_stats')
    page.querySelector('#wb_value').innerHTML = `${tamer["Wound Boxes"]}/${tamer["Wound Boxes"]}`
    page.querySelector('#ins_value').innerHTML = `${tamer["Inspiration"]}/${tamer["Willpower"]}`


    var stats = ['Accuracy', "Damage", "Dodge", "Armor"]

    stats.forEach ( x =>
    {
      var stat_div = document.createElement('div')
      stat_div.id = "stat_div"

      var stat_element = document.createElement('div')
      stat_element.setAttribute('class', "row d-flex justify-content-between mx-auto")
      stat_element.innerHTML = `<div>${(x === 'Accuracy'||x === 'Dodge') ? x + " Pool": x}</div><div class="stat_value">${(x =='Dodge' ? 'Dodge_Stat' : x) }</div>`

      var container_div = document.createElement('div')


      var progress_container = document.createElement('div')
      progress_container.setAttribute('class', "progress")
      progress_container.setAttribute('style', "height:5px")

      var progress_bar = document.createElement('div')
      progress_bar.textContent = (x =='Dodge' ? 'Dodge_Stat' : x)
      progress_bar.setAttribute('class', `progress-bar ${x.toLowerCase()}`)
      progress_bar.setAttribute('role', "progressbar")

      var combat_div = page.querySelector('.combat_stats')

      combat_div.appendChild(stat_div)

      stat_div.appendChild(container_div)

      container_div.appendChild(stat_element)
      container_div.appendChild(progress_container)
      progress_container.appendChild(progress_bar)


    })

    //Updates All Progress Bars to match stats

    page.querySelectorAll('.stat_value').forEach( x =>
    {
      x.innerHTML = `<div>${tamer[x.innerHTML]}</div>`
    }
    )

    page.querySelectorAll('.progress-bar').forEach( x => update_stats(x, tamer))


    page.querySelector('.movement_m').innerHTML = `Land (${tamer.Movement}m) | Swimming (${Math.ceil(tamer.Movement/2)}m)`

    //Update experince
    var a = document.createElement('a')
    var sheet_icon = document.createElement('img')
    sheet_icon.src = "https://i.imgur.com/BY3sMYA.png"
    sheet_icon.setAttribute('style', "height:30px;width:30px")
    a.setAttribute('href', tamer.Sheet)
    a.appendChild(sheet_icon)



    var image = document.createElement('img')
    image.setAttribute('src', global_data["Digimon"][tamer["Partner id"]]["Image"])
    image.setAttribute('onClick', `show_digimon(${tamer["Partner id"]})`)
    image.setAttribute('style', `height: 50px;width: 50px;border-radius: 100%;`)




    // page.querySelector('.links').appendChild(a)
    page.querySelector("#partner_div").appendChild(image)



    //Second Column --------------------------------------------------------------------------------------------------------------------------------------------------------
    var column_2 = page.querySelector('#column-2')
    var stats_attributes = column_2.querySelector('#SA-id')


    attribute_array = ["Agility", "Body", "Charisma", "Intelligence", "Willpower"]
    stats = [
    ["Dodge", "Fight", "Stealth"],
    ["Athletics", "Endurance", "Feats of Strength"],
    ["Manipulate", "Perform", "Persuade"],
    ["Computer", "Survival", "Knowledge"],
    ["Perception", "Decipher Intent", "Bravery"]
    ]

    result = ''

    var i = 0
    attribute_array.forEach(x => {
      result += `<div class="row d-flex justify-content-between mx-auto"> <div>${x}<small class="text-muted"> (3d6 + ${tamer[x]})</small> </div> <div>${tamer[x]} </div></div>
      <div class="progress" style='height: 10px'>
        <div class="progress-bar ${x.toLowerCase()} role="progressbar" style="width:${tamer[x]/7*100}%"></div></div>`

        stats[i].forEach(k => {
          result += `<div class="row d-flex justify-content-between mx-auto" style = "font-size: 12px">
            <div>${k} <small class="text-muted">(3d6 + ${(tamer[k]===0 ? -1 : tamer[k]) + tamer[x]})</small></div><div> ${tamer[k]} </div></div>
            <div class='progress' style='height: 5px'>
              <div class="progress-bar" role="progressbar" style=width:${tamer[k]/7*100}%>
              </div></div>`
            })

            result+="<p> </p>"
            i++
          })

          result+=`<hr/><p>Other Rolls -
            Initiative
            Recovery Check
            Evolution
            Torments</p>`

            stats_attributes.innerHTML = result

            //Character Tab  -------------------------------------------------------------------------------------------------------------------------------------------------------
            column_2.querySelector('#character_text').innerHTML = tamer["Character Synopsis"]

            //Aspects  -------------------------------------------------------------------------------------------------------------------------------------------------------

            var aspect_div = column_2.querySelector('#aspect_text')
            var major_div = document.createElement('div')
            var major_description = document.createElement('p')
            var minor_div = document.createElement('div')
            var minor_description = document.createElement('p')

            aspect_div.classList.add('row')
            aspect_div.appendChild(major_div)
            aspect_div.appendChild(minor_div)


            major_div.classList.add('col-6')
            major_div.innerHTML = `<em>${tamer["Major Aspect"]}</em><small class="text-muted"> (Major Aspect)</small>`

            major_description.textContent = tamer["Major Description"]

            minor_div.classList.add('col-6')
            minor_div.innerHTML = `<em>${tamer["Minor Aspect"]}</em><small class="text-muted"> (Minor Aspect)</small>`

            minor_description.textContent = tamer["Minor Description"]

            major_div.appendChild(major_description)
            minor_div.appendChild(minor_description)


            //Torments  -------------------------------------------------------------------------------------------------------------------------------------------------------

            torment_container = column_2.querySelector('#torment_text')
            torment_container.innerHTML = ''
            tamer.torments.forEach(x => {
              var torment_p = document.createElement('p')
              var torment_level = document.createElement('div')
              var torment_title = document.createElement('div')
              var torment_description = document.createElement('div')

              torment_title.innerHTML = `${x["Torment Name"]} <small class="text-muted"> (${x["Torment Level"]} Torment | ${x["Boxes Marked"]} Boxes Marked)</small>`
              torment_description.innerHTML = x["Description"]

              torment_p.appendChild(torment_level)
              torment_p.appendChild(torment_title)
              torment_p.appendChild(torment_description)

              torment_container.appendChild(torment_p)

            })

            function update_stats(element, tamer){
              value = tamer[element.textContent.trim()]

              if(typeof(value) !== 'undefined') {
                element.innerHTML = ""
                element.setAttribute("Style", `width:${(value/10)*100}%`)
              } else
              console.log("Element not found (Human)")
            }



            ///Actions --------------------------------------------------------------------------------------------------------------------------------------------------------------
            actions = column_2.querySelector('#Actions-'+tamer.id);
            var standard_div = document.createElement('div')
            standard_div.setAttribute("class", "container pt-2")
            standard_div.innerHTML = "<h6>Standard Actions</h6><hr/>"

            var special_div = document.createElement('div');
            special_div.setAttribute("class", "container pt-2")
            special_div.innerHTML = "<h6>Special Actions</h6><hr/>"

            actions.appendChild(standard_div)
            actions.appendChild(special_div)

            var human_actions = global_data["Actions"].filter( x => {
              if(x["Human"] === true){return x}
            });

            human_actions.forEach(x => {
              var action_div = document.createElement('div')
              action_div.setAttribute('type', 'button')
              // action_div.setAttribute('class', 'btn btn-primary')
              action_div.setAttribute('data-bs-toggle', 'collapse')
              action_div.setAttribute('data-bs-target', `#human_action_${tamer.id}_${x.Name.replaceAll(" ", "")}`)
              action_div.innerHTML = `${x.Name}<small class="text-muted">(${x.Type})</small>`

              var action_description = document.createElement('p')
              console.log(x)
              action_description.id = `human_action_${tamer.id}_${x.Name.replaceAll(" ", "")}`
              action_description.classList.add('collapse')
              action_description.setAttribute("style", "white-space: pre-line;")
              action_description.innerHTML = `<hr/><small>${x.Description}</small><hr/>`
              action_div.appendChild(action_description)

              if(x.Category === "Standard"){
              standard_div.appendChild(action_div)
              }

              if(x.Category === "Special"){
              special_div.appendChild(action_div)
              }
            })


            ///Themes --------------------------------------------------------------------------------------------------------------------------------------------------------------
            themes = column_2.querySelector('#ThemeSongs-'+tamer.id);

            var clone = document.querySelector("#playlist-template").cloneNode(true)
            var playlist_tab = clone.content.querySelectorAll("div")[0]
            var search_bar = playlist_tab.querySelector('#theme_search')
            search_bar.id = 'theme_search_human_'+tamer.id
            search_bar.setAttribute("onkeyup", `search_filter('theme_search_human_${tamer.id}', 'playlist-list-human-${tamer.id}')`)

            themes.appendChild(playlist_tab)
            playlist_tab.querySelectorAll("div")[0].setAttribute('class', 'col-12')
            var playlist_list = playlist_tab.querySelector("#playlist-list")
            playlist_list.id = `playlist-list-human-${tamer.id}`

            function update_embed(id){
                var song = playlist.find(x => x.id === id)
                song_embed.innerHTML = ''
                song_embed.appendChild(create_song_embed(song))
            }

            playlist.forEach(x => {
                if (x.Character == tamer.Name) {
                  var song = document.createElement('a')
                  song.setAttribute('id', 'list-settings-list')
                  song.setAttribute('class', 'list-group-item list-group-item-action overflow-auto')
                  song.setAttribute('onclick', `update_embed(${x.id})`)

                  var footer = document.createElement('footer')
                  footer.setAttribute('class', "blockquote-footer")
                  song.textContent = x.Name
                  footer.textContent = `${x.Character} - ${x.Tags}`
                  song.appendChild(footer)


                  playlist_list.appendChild(song)
                }


            })











            // //tab container ---------------------------------------------------------------------------------------------------------------------------------------------------
            var tabpanel = document.createElement('div')
            tabpanel.id = "Human-"+tamer.id
            tabpanel.setAttribute("class", "tab-pane fade")
            tabpanel.setAttribute("role", "tabpanel")

            var tabcontainer = document.createElement('div')
            tabcontainer.setAttribute("class", "row tab-pane fade")
            tabcontainer.id="Human-" + tamer.id
            tabpanel.appendChild(tabcontainer)
            tabcontainer.appendChild(page)

            var TabContainer = document.querySelector("#myTabContent")
            TabContainer.appendChild(tabcontainer)

          }



        </script>
